<!doctype html>
<html lang="en"> 
 <head> 
  <meta charset="UTF-8"> 
  <title>Execution Trace Diff</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <style>
* {
  box-sizing: border-box;
}

/* Create two equal columns that floats next to each other */
.column {
  float: left;
  width: 50%;
  padding: 10px;
  height: 300px; /* Should be removed. Only for demonstration */
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

.test {
    border: 1px solid darkblue;
    padding-left: 10px;
}
</style> 
 </head> 
 <body> 
  <div class="row test"> 
   <h2>Differencing Test:</h2> <code> <pre>@Test <br>
public void test_main(){ <br>
    String ret = NumberAnalyzer.analyze(1); <br>
    assertThat(ret, containsString("greater")); <br>
}
        </pre> </code> 
  </div> 
  <div class="row"> 
   <div class="column"> 
    <h2>Original Code:</h2> <code> <pre id="original-trace">           1:  <span style="background-color: white">      /*</span><br>           2:  <span style="background-color: white">       * Copyright (c) 2018 Uber Technologies, Inc.</span><br>           3:  <span style="background-color: white">       *</span><br>           4:  <span style="background-color: white">       * Licensed under the Apache License, Version 2.0 (the "License");</span><br>           5:  <span style="background-color: white">       * you may not use this file except in compliance with the License.</span><br>           6:  <span style="background-color: white">       * You may obtain a copy of the License at</span><br>           7:  <span style="background-color: white">       *</span><br>           8:  <span style="background-color: white">       *     http://www.apache.org/licenses/LICENSE-2.0</span><br>           9:  <span style="background-color: white">       *</span><br>          10:  <span style="background-color: white">       * Unless required by applicable law or agreed to in writing, software</span><br>          11:  <span style="background-color: white">       * distributed under the License is distributed on an "AS IS" BASIS,</span><br>          12:  <span style="background-color: white">       * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br>          13:  <span style="background-color: white">       * See the License for the specific language governing permissions and</span><br>          14:  <span style="background-color: white">       * limitations under the License.</span><br>          15:  <span style="background-color: white">       */</span><br>          16:  <span style="background-color: white">      </span><br>          17:  <span style="background-color: white">      package com.uber.profiling;</span><br>          18:  <span style="background-color: white">      </span><br>          19:  <span style="background-color: white">      import com.uber.profiling.profilers.CpuAndMemoryProfiler;</span><br>          20:  <span style="background-color: white">      import com.uber.profiling.profilers.IOProfiler;</span><br>          21:  <span style="background-color: white">      import com.uber.profiling.profilers.MethodArgumentCollector;</span><br>          22:  <span style="background-color: white">      import com.uber.profiling.profilers.MethodArgumentProfiler;</span><br>          23:  <span style="background-color: white">      import com.uber.profiling.profilers.MethodDurationCollector;</span><br>          24:  <span style="background-color: white">      import com.uber.profiling.profilers.MethodDurationProfiler;</span><br>          25:  <span style="background-color: white">      import com.uber.profiling.profilers.ProcessInfoProfiler;</span><br>          26:  <span style="background-color: white">      import com.uber.profiling.profilers.ThreadInfoProfiler;</span><br>          27:  <span style="background-color: white">      import com.uber.profiling.profilers.StacktraceCollectorProfiler;</span><br>          28:  <span style="background-color: white">      import com.uber.profiling.profilers.StacktraceReporterProfiler;</span><br>          29:  <span style="background-color: white">      import com.uber.profiling.transformers.JavaAgentFileTransformer;</span><br>          30:  <span style="background-color: white">      import com.uber.profiling.transformers.MethodProfilerStaticProxy;</span><br>          31:  <span style="background-color: white">      import com.uber.profiling.util.AgentLogger;</span><br>          32:  <span style="background-color: white">      import com.uber.profiling.util.ClassAndMethodLongMetricBuffer;</span><br>          33:  <span style="background-color: white">      import com.uber.profiling.util.ClassMethodArgumentMetricBuffer;</span><br>          34:  <span style="background-color: white">      import com.uber.profiling.util.SparkUtils;</span><br>          35:  <span style="background-color: white">      import com.uber.profiling.util.StacktraceMetricBuffer;</span><br>          36:  <span style="background-color: white">      </span><br>          37:  <span style="background-color: white">      import java.lang.instrument.Instrumentation;</span><br>          38:  <span style="background-color: white">      import java.util.ArrayList;</span><br>          39:  <span style="background-color: white">      import java.util.Arrays;</span><br>          40:  <span style="background-color: white">      import java.util.Collection;</span><br>          41:  <span style="background-color: white">      import java.util.List;</span><br>          42:  <span style="background-color: white">      import java.util.UUID;</span><br>          43:  <span style="background-color: white">      import java.util.concurrent.Executors;</span><br>          44:  <span style="background-color: white">      import java.util.concurrent.ScheduledExecutorService;</span><br>          45:  <span style="background-color: white">      import java.util.concurrent.TimeUnit;</span><br>          46:  <span style="background-color: white">      </span><br>          47:  <span style="background-color: white">      public class AgentImpl {</span><br>          48:  <span style="background-color: white">          public static final String VERSION = "1.0.0";</span><br>          49:  <span style="background-color: white">          </span><br>          50:  <span style="background-color: white">          private static final AgentLogger logger = AgentLogger.getLogger(AgentImpl.class.getName());</span><br>          51:  <span style="background-color: white">      </span><br>          52:  <span style="background-color: white">          private static final int MAX_THREAD_POOL_SIZE = 2;</span><br>          53:  <span style="background-color: white">      </span><br>          54:  <span style="background-color: white">          private boolean started = false;</span><br>          55:  <span style="background-color: white">      </span><br>          56:  <span style="background-color: white">   0      public void run(Arguments arguments, Instrumentation instrumentation, Collection
       <autocloseable>
         objectsToCloseOnShutdown) {
       </autocloseable></span><br>          57:  <span style="background-color: white">   0          if (arguments.isNoop()) {</span><br>          58:  <span style="background-color: white">   0              logger.info("Agent noop is true, do not run anything");</span><br>          59:  <span style="background-color: white">   0              return;</span><br>          60:  <span style="background-color: white">              }</span><br>          61:  <span style="background-color: white">              </span><br>          62:  <span style="background-color: white">   0          Reporter reporter = arguments.getReporter();</span><br>          63:  <span style="background-color: white">      </span><br>          64:  <span style="background-color: white">   0          String processUuid = UUID.randomUUID().toString();</span><br>          65:  <span style="background-color: white">      </span><br>          66:  <span style="background-color: white">   0          String appId = null;</span><br>          67:  <span style="background-color: white">              </span><br>          68:  <span style="background-color: white">   0          String appIdVariable = arguments.getAppIdVariable();</span><br>          69:  <span style="background-color: white">   0          if (appIdVariable != null &amp;&amp; !appIdVariable.isEmpty()) {</span><br>          70:  <span style="background-color: white">   0              appId = System.getenv(appIdVariable);</span><br>          71:  <span style="background-color: white">              }</span><br>          72:  <span style="background-color: white">              </span><br>          73:  <span style="background-color: white">   0          if (appId == null || appId.isEmpty()) {</span><br>          74:  <span style="background-color: white">   0              appId = SparkUtils.probeAppId(arguments.getAppIdRegex());</span><br>          75:  <span style="background-color: white">              }</span><br>          76:  <span style="background-color: white">      </span><br>          77:  <span style="background-color: white">   0          if (!arguments.getDurationProfiling().isEmpty()</span><br>          78:  <span style="background-color: white">                      || !arguments.getArgumentProfiling().isEmpty()) {</span><br>          79:  <span style="background-color: white">   0              instrumentation.addTransformer(new JavaAgentFileTransformer(arguments.getDurationProfiling(), arguments.getArgumentProfiling()));</span><br>          80:  <span style="background-color: white">              }</span><br>          81:  <span style="background-color: white">      </span><br>          82:  <span style="background-color: white">   0          List
       <profiler>
         profilers = createProfilers(reporter, arguments, processUuid, appId);
       </profiler></span><br>          83:  <span style="background-color: white">              </span><br>          84:  <span style="background-color: white">   0          ProfilerGroup profilerGroup = startProfilers(profilers);</span><br>          85:  <span style="background-color: white">      </span><br>          86:  <span style="background-color: white">   0          Thread shutdownHook = new Thread(new ShutdownHookRunner(profilerGroup.getPeriodicProfilers(), Arrays.asList(reporter), objectsToCloseOnShutdown));</span><br>          87:  <span style="background-color: white">   0          Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br>          88:  <span style="background-color: white">          }</span><br>          89:  <span style="background-color: white">      </span><br>          90:  <span style="background-color: white">   0      public ProfilerGroup startProfilers(Collection
       <profiler>
         profilers) {
       </profiler></span><br>          91:  <span style="background-color: white">   0          if (started) {</span><br>          92:  <span style="background-color: white">   0              logger.warn("Profilers already started, do not start it again");</span><br>          93:  <span style="background-color: white">   0              return new ProfilerGroup(new ArrayList&lt;&gt;(), new ArrayList&lt;&gt;());</span><br>          94:  <span style="background-color: white">              }</span><br>          95:  <span style="background-color: white">      </span><br>          96:  <span style="background-color: white">   0          List
       <profiler>
         oneTimeProfilers = new ArrayList&lt;&gt;();
       </profiler></span><br>          97:  <span style="background-color: white">   0          List
       <profiler>
         periodicProfilers = new ArrayList&lt;&gt;();
       </profiler></span><br>          98:  <span style="background-color: white">      </span><br>          99:  <span style="background-color: white">   0          for (Profiler profiler : profilers) {</span><br>         100:  <span style="background-color: white">   0              if (profiler.getIntervalMillis() == 0) {</span><br>         101:  <span style="background-color: white">   0                  oneTimeProfilers.add(profiler);</span><br>         102:  <span style="background-color: white">   0              } else if (profiler.getIntervalMillis() &gt; 0) {</span><br>         103:  <span style="background-color: white">   0                  periodicProfilers.add(profiler);</span><br>         104:  <span style="background-color: white">                  } else {</span><br>         105:  <span style="background-color: white">   0                  logger.log(String.format("Ignored profiler %s due to its invalid interval %s", profiler, profiler.getIntervalMillis()));</span><br>         106:  <span style="background-color: white">                  }</span><br>         107:  <span style="background-color: white">              }</span><br>         108:  <span style="background-color: white">      </span><br>         109:  <span style="background-color: white">   0          for (Profiler profiler : oneTimeProfilers) {</span><br>         110:  <span style="background-color: white">   0              try {</span><br>         111:  <span style="background-color: white">   0                  profiler.profile();</span><br>         112:  <span style="background-color: white">   0                  logger.info("Finished one time profiler: " + profiler);</span><br>         113:  <span style="background-color: white">                  } catch (Throwable ex) {</span><br>         114:  <span style="background-color: white">   0                  logger.warn("Failed to run one time profiler: " + profiler, ex);</span><br>         115:  <span style="background-color: white">                  }</span><br>         116:  <span style="background-color: white">              }</span><br>         117:  <span style="background-color: white">      </span><br>         118:  <span style="background-color: white">   0          for (Profiler profiler : periodicProfilers) {</span><br>         119:  <span style="background-color: white">   0              try {</span><br>         120:  <span style="background-color: white">   0                  profiler.profile();</span><br>         121:  <span style="background-color: white">   0                  logger.info("Ran periodic profiler (first run): " + profiler);</span><br>         122:  <span style="background-color: white">                  } catch (Throwable ex) {</span><br>         123:  <span style="background-color: white">   0                  logger.warn("Failed to run periodic profiler (first run): " + profiler, ex);</span><br>         124:  <span style="background-color: white">                  }</span><br>         125:  <span style="background-color: white">              }</span><br>         126:  <span style="background-color: white">              </span><br>         127:  <span style="background-color: white">   0          scheduleProfilers(periodicProfilers);</span><br>         128:  <span style="background-color: white">   0          started = true;</span><br>         129:  <span style="background-color: white">      </span><br>         130:  <span style="background-color: white">   0          return new ProfilerGroup(oneTimeProfilers, periodicProfilers);</span><br>         131:  <span style="background-color: white">          }</span><br>         132:  <span style="background-color: white">      </span><br>         133:  <span style="background-color: white">   0      private List
       <profiler>
         createProfilers(Reporter reporter, Arguments arguments, String processUuid, String appId) {
       </profiler></span><br>         134:  <span style="background-color: white">   0          String tag = arguments.getTag();</span><br>         135:  <span style="background-color: white">   0          String cluster = arguments.getCluster();</span><br>         136:  <span style="background-color: white">   0          long metricInterval = arguments.getMetricInterval();</span><br>         137:  <span style="background-color: white">      </span><br>         138:  <span style="background-color: white">   0          List
       <profiler>
         profilers = new ArrayList&lt;&gt;();
       </profiler></span><br>         139:  <span style="background-color: white">      </span><br>         140:  <span style="background-color: white">   0          CpuAndMemoryProfiler cpuAndMemoryProfiler = new CpuAndMemoryProfiler(reporter);</span><br>         141:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setTag(tag);</span><br>         142:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setCluster(cluster);</span><br>         143:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setIntervalMillis(metricInterval);</span><br>         144:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setProcessUuid(processUuid);</span><br>         145:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setAppId(appId);</span><br>         146:  <span style="background-color: white">      </span><br>         147:  <span style="background-color: white">   0          profilers.add(cpuAndMemoryProfiler);</span><br>         148:  <span style="background-color: white">      </span><br>         149:  <span style="background-color: white">   0          ProcessInfoProfiler processInfoProfiler = new ProcessInfoProfiler(reporter);</span><br>         150:  <span style="background-color: white">   0          processInfoProfiler.setTag(tag);</span><br>         151:  <span style="background-color: white">   0          processInfoProfiler.setCluster(cluster);</span><br>         152:  <span style="background-color: white">   0          processInfoProfiler.setProcessUuid(processUuid);</span><br>         153:  <span style="background-color: white">   0          processInfoProfiler.setAppId(appId);</span><br>         154:  <span style="background-color: white">      </span><br>         155:  <span style="background-color: white">   0          profilers.add(processInfoProfiler);</span><br>         156:  <span style="background-color: white">      </span><br>         157:  <span style="background-color: white">   0          if (arguments.isThreadProfiling()) {</span><br>         158:  <span style="background-color: white">   0              ThreadInfoProfiler threadInfoProfiler = new ThreadInfoProfiler(reporter);</span><br>         159:  <span style="background-color: white">   0              threadInfoProfiler.setTag(tag);</span><br>         160:  <span style="background-color: white">   0              threadInfoProfiler.setCluster(cluster);</span><br>         161:  <span style="background-color: white">   0              threadInfoProfiler.setIntervalMillis(metricInterval);</span><br>         162:  <span style="background-color: white">   0              threadInfoProfiler.setProcessUuid(processUuid);</span><br>         163:  <span style="background-color: white">   0              threadInfoProfiler.setAppId(appId);</span><br>         164:  <span style="background-color: white">      </span><br>         165:  <span style="background-color: white">   0              profilers.add(threadInfoProfiler);</span><br>         166:  <span style="background-color: white">              }</span><br>         167:  <span style="background-color: white">      </span><br>         168:  <span style="background-color: white">   0          if (!arguments.getDurationProfiling().isEmpty()) {</span><br>         169:  <span style="background-color: white">   0              ClassAndMethodLongMetricBuffer classAndMethodMetricBuffer = new ClassAndMethodLongMetricBuffer();</span><br>         170:  <span style="background-color: white">      </span><br>         171:  <span style="background-color: white">   0              MethodDurationProfiler methodDurationProfiler = new MethodDurationProfiler(classAndMethodMetricBuffer, reporter);</span><br>         172:  <span style="background-color: white">   0              methodDurationProfiler.setTag(tag);</span><br>         173:  <span style="background-color: white">   0              methodDurationProfiler.setCluster(cluster);</span><br>         174:  <span style="background-color: white">   0              methodDurationProfiler.setIntervalMillis(metricInterval);</span><br>         175:  <span style="background-color: white">   0              methodDurationProfiler.setProcessUuid(processUuid);</span><br>         176:  <span style="background-color: white">   0              methodDurationProfiler.setAppId(appId);</span><br>         177:  <span style="background-color: white">      </span><br>         178:  <span style="background-color: white">   0              MethodDurationCollector methodDurationCollector = new MethodDurationCollector(classAndMethodMetricBuffer);</span><br>         179:  <span style="background-color: white">   0              MethodProfilerStaticProxy.setCollector(methodDurationCollector);</span><br>         180:  <span style="background-color: white">      </span><br>         181:  <span style="background-color: white">   0              profilers.add(methodDurationProfiler);</span><br>         182:  <span style="background-color: white">              }</span><br>         183:  <span style="background-color: white">      </span><br>         184:  <span style="background-color: white">   0          if (!arguments.getArgumentProfiling().isEmpty()) {</span><br>         185:  <span style="background-color: white">   0              ClassMethodArgumentMetricBuffer classAndMethodArgumentBuffer = new ClassMethodArgumentMetricBuffer();</span><br>         186:  <span style="background-color: white">      </span><br>         187:  <span style="background-color: white">   0              MethodArgumentProfiler methodArgumentProfiler = new MethodArgumentProfiler(classAndMethodArgumentBuffer, reporter);</span><br>         188:  <span style="background-color: white">   0              methodArgumentProfiler.setTag(tag);</span><br>         189:  <span style="background-color: white">   0              methodArgumentProfiler.setCluster(cluster);</span><br>         190:  <span style="background-color: white">   0              methodArgumentProfiler.setIntervalMillis(metricInterval);</span><br>         191:  <span style="background-color: white">   0              methodArgumentProfiler.setProcessUuid(processUuid);</span><br>         192:  <span style="background-color: white">   0              methodArgumentProfiler.setAppId(appId);</span><br>         193:  <span style="background-color: white">      </span><br>         194:  <span style="background-color: white">   0              MethodArgumentCollector methodArgumentCollector = new MethodArgumentCollector(classAndMethodArgumentBuffer);</span><br>         195:  <span style="background-color: white">   0              MethodProfilerStaticProxy.setArgumentCollector(methodArgumentCollector);</span><br>         196:  <span style="background-color: white">      </span><br>         197:  <span style="background-color: white">   0              profilers.add(methodArgumentProfiler);</span><br>         198:  <span style="background-color: white">              }</span><br>         199:  <span style="background-color: white">              </span><br>         200:  <span style="background-color: white">   0          if (arguments.getSampleInterval() &gt; 0) {</span><br>         201:  <span style="background-color: white">   0              StacktraceMetricBuffer stacktraceMetricBuffer = new StacktraceMetricBuffer();</span><br>         202:  <span style="background-color: white">      </span><br>         203:  <span style="background-color: white">   0              StacktraceCollectorProfiler stacktraceCollectorProfiler = new StacktraceCollectorProfiler(stacktraceMetricBuffer, AgentThreadFactory.NAME_PREFIX);</span><br>         204:  <span style="background-color: white">   0              stacktraceCollectorProfiler.setIntervalMillis(arguments.getSampleInterval());</span><br>         205:  <span style="background-color: white">                          </span><br>         206:  <span style="background-color: white">   0              StacktraceReporterProfiler stacktraceReporterProfiler = new StacktraceReporterProfiler(stacktraceMetricBuffer, reporter);</span><br>         207:  <span style="background-color: white">   0              stacktraceReporterProfiler.setTag(tag);</span><br>         208:  <span style="background-color: white">   0              stacktraceReporterProfiler.setCluster(cluster);</span><br>         209:  <span style="background-color: white">   0              stacktraceReporterProfiler.setIntervalMillis(metricInterval);</span><br>         210:  <span style="background-color: white">   0              stacktraceReporterProfiler.setProcessUuid(processUuid);</span><br>         211:  <span style="background-color: white">   0              stacktraceReporterProfiler.setAppId(appId);</span><br>         212:  <span style="background-color: white">      </span><br>         213:  <span style="background-color: white">   0              profilers.add(stacktraceCollectorProfiler);</span><br>         214:  <span style="background-color: white">   0              profilers.add(stacktraceReporterProfiler);</span><br>         215:  <span style="background-color: white">              }</span><br>         216:  <span style="background-color: white">      </span><br>         217:  <span style="background-color: white">   0          if (arguments.isIoProfiling()) {</span><br>         218:  <span style="background-color: white">   0              IOProfiler ioProfiler = new IOProfiler(reporter);</span><br>         219:  <span style="background-color: white">   0              ioProfiler.setTag(tag);</span><br>         220:  <span style="background-color: white">   0              ioProfiler.setCluster(cluster);</span><br>         221:  <span style="background-color: white">   0              ioProfiler.setIntervalMillis(metricInterval);</span><br>         222:  <span style="background-color: white">   0              ioProfiler.setProcessUuid(processUuid);</span><br>         223:  <span style="background-color: white">   0              ioProfiler.setAppId(appId);</span><br>         224:  <span style="background-color: white">      </span><br>         225:  <span style="background-color: white">   0              profilers.add(ioProfiler);</span><br>         226:  <span style="background-color: white">              }</span><br>         227:  <span style="background-color: white">              </span><br>         228:  <span style="background-color: white">   0          return profilers;</span><br>         229:  <span style="background-color: white">          }</span><br>         230:  <span style="background-color: white">      </span><br>         231:  <span style="background-color: white">   0      private void scheduleProfilers(Collection
       <profiler>
         profilers) {
       </profiler></span><br>         232:  <span style="background-color: white">   0          int threadPoolSize = Math.min(profilers.size(), MAX_THREAD_POOL_SIZE);</span><br>         233:  <span style="background-color: white">   0          ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(threadPoolSize, new AgentThreadFactory());</span><br>         234:  <span style="background-color: white">      </span><br>         235:  <span style="background-color: white">   0          for (Profiler profiler : profilers) {</span><br>         236:  <span style="background-color: white">   0              if (profiler.getIntervalMillis() &lt; Arguments.MIN_INTERVAL_MILLIS) {</span><br>         237:  <span style="background-color: white">   0                  throw new RuntimeException("Interval too short for profiler: " + profiler + ", must be at least " + Arguments.MIN_INTERVAL_MILLIS);</span><br>         238:  <span style="background-color: white">                  }</span><br>         239:  <span style="background-color: white">                  </span><br>         240:  <span style="background-color: white">   0              ProfilerRunner worker = new ProfilerRunner(profiler);</span><br>         241:  <span style="background-color: white">   0              scheduledExecutorService.scheduleAtFixedRate(worker, 0, profiler.getIntervalMillis(), TimeUnit.MILLISECONDS);</span><br>         242:  <span style="background-color: white">   0              logger.info(String.format("Scheduled profiler %s with interval %s millis", profiler, profiler.getIntervalMillis()));</span><br>         243:  <span style="background-color: white">              }</span><br>         244:  <span style="background-color: white">          }</span><br>         245:  <span style="background-color: white">      }</span><br></pre> </code> 
   </div> 
   <div class="column"> 
    <h2>Patched Code:</h2> <code> <pre id="patched-trace">        1-&gt;N:  <span style="background-color: white">      /*</span><br>        2-&gt;N:  <span style="background-color: white">       * Copyright (c) 2018 Uber Technologies, Inc.</span><br>        3-&gt;N:  <span style="background-color: white">       *</span><br>        4-&gt;N:  <span style="background-color: white">       * Licensed under the Apache License, Version 2.0 (the "License");</span><br>        5-&gt;N:  <span style="background-color: white">       * you may not use this file except in compliance with the License.</span><br>        6-&gt;N:  <span style="background-color: white">       * You may obtain a copy of the License at</span><br>        7-&gt;N:  <span style="background-color: white">       *</span><br>        8-&gt;N:  <span style="background-color: white">       *     http://www.apache.org/licenses/LICENSE-2.0</span><br>        9-&gt;N:  <span style="background-color: white">       *</span><br>       10-&gt;N:  <span style="background-color: white">       * Unless required by applicable law or agreed to in writing, software</span><br>       11-&gt;N:  <span style="background-color: white">       * distributed under the License is distributed on an "AS IS" BASIS,</span><br>       12-&gt;N:  <span style="background-color: white">       * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br>       13-&gt;N:  <span style="background-color: white">       * See the License for the specific language governing permissions and</span><br>       14-&gt;N:  <span style="background-color: white">       * limitations under the License.</span><br>       15-&gt;N:  <span style="background-color: white">       */</span><br>       16-&gt;N:  <span style="background-color: white">      </span><br>       17-&gt;N:  <span style="background-color: white">      package com.uber.profiling;</span><br>       18-&gt;N:  <span style="background-color: white">      </span><br>       19-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.CpuAndMemoryProfiler;</span><br>       20-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.IOProfiler;</span><br>       21-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.MethodArgumentCollector;</span><br>       22-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.MethodArgumentProfiler;</span><br>       23-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.MethodDurationCollector;</span><br>       24-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.MethodDurationProfiler;</span><br>       25-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.ProcessInfoProfiler;</span><br>       26-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.StacktraceCollectorProfiler;</span><br>       27-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.StacktraceReporterProfiler;</span><br>       28-&gt;N:  <span style="background-color: white">      import com.uber.profiling.profilers.ThreadInfoProfiler;</span><br>       29-&gt;N:  <span style="background-color: white">      import com.uber.profiling.transformers.JavaAgentFileTransformer;</span><br>       30-&gt;N:  <span style="background-color: white">      import com.uber.profiling.transformers.MethodProfilerStaticProxy;</span><br>       31-&gt;N:  <span style="background-color: white">      import com.uber.profiling.util.AgentLogger;</span><br>       32-&gt;N:  <span style="background-color: white">      import com.uber.profiling.util.ClassAndMethod;</span><br>       33-&gt;N:  <span style="background-color: white">      import com.uber.profiling.util.ClassAndMethodLongMetricBuffer;</span><br>       34-&gt;N:  <span style="background-color: white">      import com.uber.profiling.util.ClassMethodArgument;</span><br>       35-&gt;N:  <span style="background-color: white">      import com.uber.profiling.util.ClassMethodArgumentMetricBuffer;</span><br>       36-&gt;N:  <span style="background-color: white">      import com.uber.profiling.util.SparkUtils;</span><br>       37-&gt;N:  <span style="background-color: white">      import com.uber.profiling.util.StacktraceMetricBuffer;</span><br>       38-&gt;N:  <span style="background-color: white">      </span><br>       39-&gt;N:  <span style="background-color: white">      import java.lang.instrument.Instrumentation;</span><br>       40-&gt;N:  <span style="background-color: white">      import java.util.ArrayList;</span><br>       41-&gt;N:  <span style="background-color: white">      import java.util.Arrays;</span><br>       42-&gt;N:  <span style="background-color: white">      import java.util.Collection;</span><br>       43-&gt;N:  <span style="background-color: white">      import java.util.List;</span><br>       44-&gt;N:  <span style="background-color: white">      import java.util.Set;</span><br>       45-&gt;N:  <span style="background-color: white">      import java.util.UUID;</span><br>       46-&gt;N:  <span style="background-color: white">      import java.util.concurrent.Executors;</span><br>       47-&gt;N:  <span style="background-color: white">      import java.util.concurrent.ScheduledExecutorService;</span><br>       48-&gt;N:  <span style="background-color: white">      import java.util.concurrent.TimeUnit;</span><br>       49-&gt;N:  <span style="background-color: white">      import java.util.stream.Collectors;</span><br>       50-&gt;N:  <span style="background-color: white">      </span><br>       51-&gt;N:  <span style="background-color: white">      public class AgentImpl {</span><br>      52-&gt;48:  <span style="background-color: white">          public static final String VERSION = "1.0.0";</span><br>       53-&gt;N:  <span style="background-color: white">          </span><br>      54-&gt;50:  <span style="background-color: white">          private static final AgentLogger logger = AgentLogger.getLogger(AgentImpl.class.getName());</span><br>       55-&gt;N:  <span style="background-color: white">      </span><br>      56-&gt;52:  <span style="background-color: white">          private static final int MAX_THREAD_POOL_SIZE = 2;</span><br>       57-&gt;N:  <span style="background-color: white">      </span><br>      58-&gt;54:  <span style="background-color: white">          private boolean started = false;</span><br>       59-&gt;N:  <span style="background-color: white">      </span><br>      60-&gt;56:  <span style="background-color: white">   0      public void run(Arguments arguments, Instrumentation instrumentation, Collection
       <autocloseable>
         objectsToCloseOnShutdown) {
       </autocloseable></span><br>      61-&gt;57:  <span style="background-color: white">   0          if (arguments.isNoop()) {</span><br>      62-&gt;58:  <span style="background-color: white">   0              logger.info("Agent noop is true, do not run anything");</span><br>      63-&gt;59:  <span style="background-color: white">   0              return;</span><br>       64-&gt;N:  <span style="background-color: white">              }</span><br>       65-&gt;N:  <span style="background-color: white">              </span><br>      66-&gt;62:  <span style="background-color: white">   0          Reporter reporter = arguments.getReporter();</span><br>       67-&gt;N:  <span style="background-color: white">      </span><br>      68-&gt;64:  <span style="background-color: white">   0          String processUuid = UUID.randomUUID().toString();</span><br>       69-&gt;N:  <span style="background-color: white">      </span><br>      70-&gt;66:  <span style="background-color: white">   0          String appId = null;</span><br>       71-&gt;N:  <span style="background-color: white">              </span><br>      72-&gt;68:  <span style="background-color: white">   0          String appIdVariable = arguments.getAppIdVariable();</span><br>      73-&gt;69:  <span style="background-color: white">   0          if (appIdVariable != null &amp;&amp; !appIdVariable.isEmpty()) {</span><br>      74-&gt;70:  <span style="background-color: white">   0              appId = System.getenv(appIdVariable);</span><br>       75-&gt;N:  <span style="background-color: white">              }</span><br>       76-&gt;N:  <span style="background-color: white">              </span><br>      77-&gt;73:  <span style="background-color: white">   0          if (appId == null || appId.isEmpty()) {</span><br>      78-&gt;74:  <span style="background-color: white">   0              appId = SparkUtils.probeAppId(arguments.getAppIdRegex());</span><br>       79-&gt;N:  <span style="background-color: white">              }</span><br>       80-&gt;N:  <span style="background-color: white">      </span><br>      81-&gt;77:  <span style="background-color: white">   0          if (!arguments.getDurationProfiling().isEmpty()</span><br>      82-&gt;78:  <span style="background-color: white">                      || !arguments.getArgumentProfiling().isEmpty()) {</span><br>      83-&gt;79:  <span style="background-color: white">   0              instrumentation.addTransformer(new JavaAgentFileTransformer(arguments.getDurationProfiling(),</span><br>       84-&gt;U:  <span style="background-color: yellow">                          arguments.getArgumentProfiling()), true);</span><br>       85-&gt;N:  <span style="background-color: white">      </span><br>       86-&gt;U:  <span style="background-color: yellow">   0              Set
       <string>
         loadedClasses = Arrays.stream(instrumentation.getAllLoadedClasses())
       </string></span><br>       87-&gt;U:  <span style="background-color: yellow">                          .map(Class::getName).collect(Collectors.toSet());</span><br>       88-&gt;N:  <span style="background-color: white">      </span><br>       89-&gt;U:  <span style="background-color: yellow">   0              Set
       <string>
         tobeReloadClasses = arguments.getDurationProfiling().stream()
       </string></span><br>       90-&gt;U:  <span style="background-color: yellow">                          .map(ClassAndMethod::getClassName).collect(Collectors.toSet());</span><br>       91-&gt;N:  <span style="background-color: white">      </span><br>       92-&gt;U:  <span style="background-color: yellow">   0              tobeReloadClasses.addAll(arguments.getArgumentProfiling().stream()</span><br>       93-&gt;U:  <span style="background-color: yellow">                          .map(ClassMethodArgument::getClassName).collect(Collectors.toSet()));</span><br>       94-&gt;N:  <span style="background-color: white">      </span><br>       95-&gt;U:  <span style="background-color: yellow">   0              tobeReloadClasses.retainAll(loadedClasses);</span><br>       96-&gt;N:  <span style="background-color: white">      </span><br>       97-&gt;U:  <span style="background-color: yellow">   0              tobeReloadClasses.forEach(clazz -&gt; {</span><br>       98-&gt;U:  <span style="background-color: yellow">   0                  try {</span><br>       99-&gt;U:  <span style="background-color: yellow">   0                      instrumentation.retransformClasses(Class.forName(clazz));</span><br>      100-&gt;U:  <span style="background-color: yellow">   0                      logger.info("Reload class [" + clazz + "] success.");</span><br>      101-&gt;U:  <span style="background-color: yellow">                      } catch (Exception e) {</span><br>      102-&gt;U:  <span style="background-color: yellow">   0                      logger.warn("Reload class [" + clazz + "] failed.", e);</span><br>      103-&gt;U:  <span style="background-color: yellow">                      }</span><br>      104-&gt;U:  <span style="background-color: yellow">                  });</span><br>      105-&gt;N:  <span style="background-color: white">              }</span><br>      106-&gt;N:  <span style="background-color: white">      </span><br>     107-&gt;82:  <span style="background-color: white">   0          List
       <profiler>
         profilers = createProfilers(reporter, arguments, processUuid, appId);
       </profiler></span><br>      108-&gt;N:  <span style="background-color: white">              </span><br>     109-&gt;84:  <span style="background-color: white">   0          ProfilerGroup profilerGroup = startProfilers(profilers);</span><br>      110-&gt;N:  <span style="background-color: white">      </span><br>     111-&gt;86:  <span style="background-color: white">   0          Thread shutdownHook = new Thread(new ShutdownHookRunner(profilerGroup.getPeriodicProfilers(), Arrays.asList(reporter), objectsToCloseOnShutdown));</span><br>     112-&gt;87:  <span style="background-color: white">   0          Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br>      113-&gt;N:  <span style="background-color: white">          }</span><br>      114-&gt;N:  <span style="background-color: white">      </span><br>     115-&gt;90:  <span style="background-color: white">   0      public ProfilerGroup startProfilers(Collection
       <profiler>
         profilers) {
       </profiler></span><br>      116-&gt;N:  <span style="background-color: white">   0          if (started) {</span><br>     117-&gt;92:  <span style="background-color: white">   0              logger.warn("Profilers already started, do not start it again");</span><br>     118-&gt;93:  <span style="background-color: white">   0              return new ProfilerGroup(new ArrayList&lt;&gt;(), new ArrayList&lt;&gt;());</span><br>      119-&gt;N:  <span style="background-color: white">              }</span><br>      120-&gt;N:  <span style="background-color: white">      </span><br>     121-&gt;96:  <span style="background-color: white">   0          List
       <profiler>
         oneTimeProfilers = new ArrayList&lt;&gt;();
       </profiler></span><br>     122-&gt;97:  <span style="background-color: white">   0          List
       <profiler>
         periodicProfilers = new ArrayList&lt;&gt;();
       </profiler></span><br>      123-&gt;N:  <span style="background-color: white">      </span><br>     124-&gt;99:  <span style="background-color: white">   0          for (Profiler profiler : profilers) {</span><br>    125-&gt;100:  <span style="background-color: white">   0              if (profiler.getIntervalMillis() == 0) {</span><br>    126-&gt;101:  <span style="background-color: white">   0                  oneTimeProfilers.add(profiler);</span><br>    127-&gt;102:  <span style="background-color: white">   0              } else if (profiler.getIntervalMillis() &gt; 0) {</span><br>    128-&gt;103:  <span style="background-color: white">   0                  periodicProfilers.add(profiler);</span><br>      129-&gt;N:  <span style="background-color: white">                  } else {</span><br>    130-&gt;105:  <span style="background-color: white">   0                  logger.log(String.format("Ignored profiler %s due to its invalid interval %s", profiler, profiler.getIntervalMillis()));</span><br>      131-&gt;N:  <span style="background-color: white">                  }</span><br>      132-&gt;N:  <span style="background-color: white">              }</span><br>      133-&gt;N:  <span style="background-color: white">      </span><br>    134-&gt;109:  <span style="background-color: white">   0          for (Profiler profiler : oneTimeProfilers) {</span><br>      135-&gt;N:  <span style="background-color: white">   0              try {</span><br>    136-&gt;111:  <span style="background-color: white">   0                  profiler.profile();</span><br>    137-&gt;112:  <span style="background-color: white">   0                  logger.info("Finished one time profiler: " + profiler);</span><br>    138-&gt;113:  <span style="background-color: white">                  } catch (Throwable ex) {</span><br>    139-&gt;114:  <span style="background-color: white">   0                  logger.warn("Failed to run one time profiler: " + profiler, ex);</span><br>      140-&gt;N:  <span style="background-color: white">                  }</span><br>      141-&gt;N:  <span style="background-color: white">              }</span><br>      142-&gt;N:  <span style="background-color: white">      </span><br>    143-&gt;118:  <span style="background-color: white">   0          for (Profiler profiler : periodicProfilers) {</span><br>      144-&gt;N:  <span style="background-color: white">   0              try {</span><br>    145-&gt;120:  <span style="background-color: white">   0                  profiler.profile();</span><br>    146-&gt;121:  <span style="background-color: white">   0                  logger.info("Ran periodic profiler (first run): " + profiler);</span><br>    147-&gt;122:  <span style="background-color: white">                  } catch (Throwable ex) {</span><br>    148-&gt;123:  <span style="background-color: white">   0                  logger.warn("Failed to run periodic profiler (first run): " + profiler, ex);</span><br>      149-&gt;N:  <span style="background-color: white">                  }</span><br>      150-&gt;N:  <span style="background-color: white">              }</span><br>      151-&gt;N:  <span style="background-color: white">              </span><br>    152-&gt;127:  <span style="background-color: white">   0          scheduleProfilers(periodicProfilers);</span><br>    153-&gt;128:  <span style="background-color: white">   0          started = true;</span><br>      154-&gt;N:  <span style="background-color: white">      </span><br>    155-&gt;130:  <span style="background-color: white">   0          return new ProfilerGroup(oneTimeProfilers, periodicProfilers);</span><br>      156-&gt;N:  <span style="background-color: white">          }</span><br>      157-&gt;N:  <span style="background-color: white">      </span><br>    158-&gt;133:  <span style="background-color: white">   0      private List
       <profiler>
         createProfilers(Reporter reporter, Arguments arguments, String processUuid, String appId) {
       </profiler></span><br>    159-&gt;134:  <span style="background-color: white">   0          String tag = arguments.getTag();</span><br>    160-&gt;135:  <span style="background-color: white">   0          String cluster = arguments.getCluster();</span><br>    161-&gt;136:  <span style="background-color: white">   0          long metricInterval = arguments.getMetricInterval();</span><br>      162-&gt;N:  <span style="background-color: white">      </span><br>    163-&gt;138:  <span style="background-color: white">   0          List
       <profiler>
         profilers = new ArrayList&lt;&gt;();
       </profiler></span><br>      164-&gt;N:  <span style="background-color: white">      </span><br>    165-&gt;140:  <span style="background-color: white">   0          CpuAndMemoryProfiler cpuAndMemoryProfiler = new CpuAndMemoryProfiler(reporter);</span><br>    166-&gt;141:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setTag(tag);</span><br>    167-&gt;142:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setCluster(cluster);</span><br>    168-&gt;143:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setIntervalMillis(metricInterval);</span><br>    169-&gt;144:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setProcessUuid(processUuid);</span><br>    170-&gt;145:  <span style="background-color: white">   0          cpuAndMemoryProfiler.setAppId(appId);</span><br>      171-&gt;N:  <span style="background-color: white">      </span><br>    172-&gt;147:  <span style="background-color: white">   0          profilers.add(cpuAndMemoryProfiler);</span><br>      173-&gt;N:  <span style="background-color: white">      </span><br>    174-&gt;149:  <span style="background-color: white">   0          ProcessInfoProfiler processInfoProfiler = new ProcessInfoProfiler(reporter);</span><br>    175-&gt;150:  <span style="background-color: white">   0          processInfoProfiler.setTag(tag);</span><br>    176-&gt;151:  <span style="background-color: white">   0          processInfoProfiler.setCluster(cluster);</span><br>    177-&gt;152:  <span style="background-color: white">   0          processInfoProfiler.setProcessUuid(processUuid);</span><br>    178-&gt;153:  <span style="background-color: white">   0          processInfoProfiler.setAppId(appId);</span><br>      179-&gt;N:  <span style="background-color: white">      </span><br>    180-&gt;155:  <span style="background-color: white">   0          profilers.add(processInfoProfiler);</span><br>      181-&gt;N:  <span style="background-color: white">      </span><br>    182-&gt;157:  <span style="background-color: white">   0          if (arguments.isThreadProfiling()) {</span><br>    183-&gt;158:  <span style="background-color: white">   0              ThreadInfoProfiler threadInfoProfiler = new ThreadInfoProfiler(reporter);</span><br>    184-&gt;159:  <span style="background-color: white">   0              threadInfoProfiler.setTag(tag);</span><br>    185-&gt;160:  <span style="background-color: white">   0              threadInfoProfiler.setCluster(cluster);</span><br>    186-&gt;161:  <span style="background-color: white">   0              threadInfoProfiler.setIntervalMillis(metricInterval);</span><br>    187-&gt;162:  <span style="background-color: white">   0              threadInfoProfiler.setProcessUuid(processUuid);</span><br>    188-&gt;163:  <span style="background-color: white">   0              threadInfoProfiler.setAppId(appId);</span><br>      189-&gt;N:  <span style="background-color: white">      </span><br>    190-&gt;165:  <span style="background-color: white">   0              profilers.add(threadInfoProfiler);</span><br>      191-&gt;N:  <span style="background-color: white">              }</span><br>      192-&gt;N:  <span style="background-color: white">      </span><br>    193-&gt;168:  <span style="background-color: white">   0          if (!arguments.getDurationProfiling().isEmpty()) {</span><br>    194-&gt;169:  <span style="background-color: white">   0              ClassAndMethodLongMetricBuffer classAndMethodMetricBuffer = new ClassAndMethodLongMetricBuffer();</span><br>      195-&gt;N:  <span style="background-color: white">      </span><br>    196-&gt;171:  <span style="background-color: white">   0              MethodDurationProfiler methodDurationProfiler = new MethodDurationProfiler(classAndMethodMetricBuffer, reporter);</span><br>    197-&gt;172:  <span style="background-color: white">   0              methodDurationProfiler.setTag(tag);</span><br>    198-&gt;173:  <span style="background-color: white">   0              methodDurationProfiler.setCluster(cluster);</span><br>    199-&gt;174:  <span style="background-color: white">   0              methodDurationProfiler.setIntervalMillis(metricInterval);</span><br>    200-&gt;175:  <span style="background-color: white">   0              methodDurationProfiler.setProcessUuid(processUuid);</span><br>    201-&gt;176:  <span style="background-color: white">   0              methodDurationProfiler.setAppId(appId);</span><br>      202-&gt;N:  <span style="background-color: white">      </span><br>    203-&gt;178:  <span style="background-color: white">   0              MethodDurationCollector methodDurationCollector = new MethodDurationCollector(classAndMethodMetricBuffer);</span><br>    204-&gt;179:  <span style="background-color: white">   0              MethodProfilerStaticProxy.setCollector(methodDurationCollector);</span><br>      205-&gt;N:  <span style="background-color: white">      </span><br>    206-&gt;181:  <span style="background-color: white">   0              profilers.add(methodDurationProfiler);</span><br>      207-&gt;N:  <span style="background-color: white">              }</span><br>      208-&gt;N:  <span style="background-color: white">      </span><br>    209-&gt;184:  <span style="background-color: white">   0          if (!arguments.getArgumentProfiling().isEmpty()) {</span><br>    210-&gt;185:  <span style="background-color: white">   0              ClassMethodArgumentMetricBuffer classAndMethodArgumentBuffer = new ClassMethodArgumentMetricBuffer();</span><br>      211-&gt;N:  <span style="background-color: white">      </span><br>    212-&gt;187:  <span style="background-color: white">   0              MethodArgumentProfiler methodArgumentProfiler = new MethodArgumentProfiler(classAndMethodArgumentBuffer, reporter);</span><br>    213-&gt;188:  <span style="background-color: white">   0              methodArgumentProfiler.setTag(tag);</span><br>    214-&gt;189:  <span style="background-color: white">   0              methodArgumentProfiler.setCluster(cluster);</span><br>    215-&gt;190:  <span style="background-color: white">   0              methodArgumentProfiler.setIntervalMillis(metricInterval);</span><br>    216-&gt;191:  <span style="background-color: white">   0              methodArgumentProfiler.setProcessUuid(processUuid);</span><br>    217-&gt;192:  <span style="background-color: white">   0              methodArgumentProfiler.setAppId(appId);</span><br>      218-&gt;N:  <span style="background-color: white">      </span><br>    219-&gt;194:  <span style="background-color: white">   0              MethodArgumentCollector methodArgumentCollector = new MethodArgumentCollector(classAndMethodArgumentBuffer);</span><br>    220-&gt;195:  <span style="background-color: white">   0              MethodProfilerStaticProxy.setArgumentCollector(methodArgumentCollector);</span><br>      221-&gt;N:  <span style="background-color: white">      </span><br>    222-&gt;197:  <span style="background-color: white">   0              profilers.add(methodArgumentProfiler);</span><br>      223-&gt;N:  <span style="background-color: white">              }</span><br>      224-&gt;N:  <span style="background-color: white">              </span><br>    225-&gt;200:  <span style="background-color: white">   0          if (arguments.getSampleInterval() &gt; 0) {</span><br>    226-&gt;201:  <span style="background-color: white">   0              StacktraceMetricBuffer stacktraceMetricBuffer = new StacktraceMetricBuffer();</span><br>      227-&gt;N:  <span style="background-color: white">      </span><br>    228-&gt;203:  <span style="background-color: white">   0              StacktraceCollectorProfiler stacktraceCollectorProfiler = new StacktraceCollectorProfiler(stacktraceMetricBuffer, AgentThreadFactory.NAME_PREFIX);</span><br>    229-&gt;204:  <span style="background-color: white">   0              stacktraceCollectorProfiler.setIntervalMillis(arguments.getSampleInterval());</span><br>      230-&gt;N:  <span style="background-color: white">                          </span><br>    231-&gt;206:  <span style="background-color: white">   0              StacktraceReporterProfiler stacktraceReporterProfiler = new StacktraceReporterProfiler(stacktraceMetricBuffer, reporter);</span><br>    232-&gt;207:  <span style="background-color: white">   0              stacktraceReporterProfiler.setTag(tag);</span><br>    233-&gt;208:  <span style="background-color: white">   0              stacktraceReporterProfiler.setCluster(cluster);</span><br>    234-&gt;209:  <span style="background-color: white">   0              stacktraceReporterProfiler.setIntervalMillis(metricInterval);</span><br>    235-&gt;210:  <span style="background-color: white">   0              stacktraceReporterProfiler.setProcessUuid(processUuid);</span><br>    236-&gt;211:  <span style="background-color: white">   0              stacktraceReporterProfiler.setAppId(appId);</span><br>      237-&gt;N:  <span style="background-color: white">      </span><br>    238-&gt;213:  <span style="background-color: white">   0              profilers.add(stacktraceCollectorProfiler);</span><br>    239-&gt;214:  <span style="background-color: white">   0              profilers.add(stacktraceReporterProfiler);</span><br>      240-&gt;N:  <span style="background-color: white">              }</span><br>      241-&gt;N:  <span style="background-color: white">      </span><br>    242-&gt;217:  <span style="background-color: white">   0          if (arguments.isIoProfiling()) {</span><br>    243-&gt;218:  <span style="background-color: white">   0              IOProfiler ioProfiler = new IOProfiler(reporter);</span><br>    244-&gt;219:  <span style="background-color: white">   0              ioProfiler.setTag(tag);</span><br>    245-&gt;220:  <span style="background-color: white">   0              ioProfiler.setCluster(cluster);</span><br>    246-&gt;221:  <span style="background-color: white">   0              ioProfiler.setIntervalMillis(metricInterval);</span><br>    247-&gt;222:  <span style="background-color: white">   0              ioProfiler.setProcessUuid(processUuid);</span><br>    248-&gt;223:  <span style="background-color: white">   0              ioProfiler.setAppId(appId);</span><br>      249-&gt;N:  <span style="background-color: white">      </span><br>    250-&gt;225:  <span style="background-color: white">   0              profilers.add(ioProfiler);</span><br>      251-&gt;N:  <span style="background-color: white">              }</span><br>      252-&gt;N:  <span style="background-color: white">              </span><br>    253-&gt;228:  <span style="background-color: white">   0          return profilers;</span><br>      254-&gt;N:  <span style="background-color: white">          }</span><br>      255-&gt;N:  <span style="background-color: white">      </span><br>    256-&gt;231:  <span style="background-color: white">   0      private void scheduleProfilers(Collection
       <profiler>
         profilers) {
       </profiler></span><br>    257-&gt;232:  <span style="background-color: white">   0          int threadPoolSize = Math.min(profilers.size(), MAX_THREAD_POOL_SIZE);</span><br>    258-&gt;233:  <span style="background-color: white">   0          ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(threadPoolSize, new AgentThreadFactory());</span><br>      259-&gt;N:  <span style="background-color: white">      </span><br>    260-&gt;235:  <span style="background-color: white">   0          for (Profiler profiler : profilers) {</span><br>    261-&gt;236:  <span style="background-color: white">   0              if (profiler.getIntervalMillis() &lt; Arguments.MIN_INTERVAL_MILLIS) {</span><br>    262-&gt;237:  <span style="background-color: white">   0                  throw new RuntimeException("Interval too short for profiler: " + profiler + ", must be at least " + Arguments.MIN_INTERVAL_MILLIS);</span><br>      263-&gt;N:  <span style="background-color: white">                  }</span><br>      264-&gt;N:  <span style="background-color: white">                  </span><br>    265-&gt;240:  <span style="background-color: white">   0              ProfilerRunner worker = new ProfilerRunner(profiler);</span><br>    266-&gt;241:  <span style="background-color: white">   0              scheduledExecutorService.scheduleAtFixedRate(worker, 0, profiler.getIntervalMillis(), TimeUnit.MILLISECONDS);</span><br>    267-&gt;242:  <span style="background-color: white">   0              logger.info(String.format("Scheduled profiler %s with interval %s millis", profiler, profiler.getIntervalMillis()));</span><br>      268-&gt;N:  <span style="background-color: white">              }</span><br>      269-&gt;N:  <span style="background-color: white">          }</span><br>      270-&gt;N:  <span style="background-color: white">      }</span><br></pre> </code> 
   </div> 
  </div>  
 </body>
</html>
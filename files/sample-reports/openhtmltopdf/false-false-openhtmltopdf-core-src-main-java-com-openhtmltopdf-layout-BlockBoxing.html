<!doctype html>
<html lang="en"> 
 <head> 
  <meta charset="UTF-8"> 
  <title>Execution Trace Diff</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <style>
* {
  box-sizing: border-box;
}

/* Create two equal columns that floats next to each other */
.column {
  float: left;
  width: 50%;
  padding: 10px;
  height: 300px; /* Should be removed. Only for demonstration */
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

.test {
    border: 1px solid darkblue;
    padding-left: 10px;
}
</style> 
 </head> 
 <body> 
  <div class="row test"> 
   <h2>Differencing Test:</h2> <code> <pre>@Test <br>
public void test_main(){ <br>
    String ret = NumberAnalyzer.analyze(1); <br>
    assertThat(ret, containsString("greater")); <br>
}
        </pre> </code> 
  </div> 
  <div class="row"> 
   <div class="column"> 
    <h2>Original Code:</h2> <code> <pre id="original-trace">           1:  <span style="background-color: white">      /*</span><br>           2:  <span style="background-color: white">       * {{{ header &amp; license</span><br>           3:  <span style="background-color: white">       * Copyright (c) 2004, 2005 Joshua Marinacci, Torbjoern Gannholm</span><br>           4:  <span style="background-color: white">       * Copyright (c) 2005 Wisconsin Court System</span><br>           5:  <span style="background-color: white">       *</span><br>           6:  <span style="background-color: white">       * This program is free software; you can redistribute it and/or</span><br>           7:  <span style="background-color: white">       * modify it under the terms of the GNU Lesser General Public License</span><br>           8:  <span style="background-color: white">       * as published by the Free Software Foundation; either version 2.1</span><br>           9:  <span style="background-color: white">       * of the License, or (at your option) any later version.</span><br>          10:  <span style="background-color: white">       *</span><br>          11:  <span style="background-color: white">       * This program is distributed in the hope that it will be useful,</span><br>          12:  <span style="background-color: white">       * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br>          13:  <span style="background-color: white">       * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the</span><br>          14:  <span style="background-color: white">       * GNU Lesser General Public License for more details.</span><br>          15:  <span style="background-color: white">       *</span><br>          16:  <span style="background-color: white">       * You should have received a copy of the GNU Lesser General Public License</span><br>          17:  <span style="background-color: white">       * along with this program; if not, write to the Free Software</span><br>          18:  <span style="background-color: white">       * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span><br>          19:  <span style="background-color: white">       * }}}</span><br>          20:  <span style="background-color: white">       */</span><br>          21:  <span style="background-color: white">      package com.openhtmltopdf.layout;</span><br>          22:  <span style="background-color: white">      </span><br>          23:  <span style="background-color: white">      import java.awt.Dimension;</span><br>          24:  <span style="background-color: white">      import java.util.ArrayList;</span><br>          25:  <span style="background-color: white">      import java.util.Iterator;</span><br>          26:  <span style="background-color: white">      import java.util.List;</span><br>          27:  <span style="background-color: white">      import java.util.RandomAccess;</span><br>          28:  <span style="background-color: white">      </span><br>          29:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.CSSName;</span><br>          30:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.IdentValue;</span><br>          31:  <span style="background-color: white">      import com.openhtmltopdf.render.BlockBox;</span><br>          32:  <span style="background-color: white">      import com.openhtmltopdf.render.Box;</span><br>          33:  <span style="background-color: white">      import com.openhtmltopdf.render.LineBox;</span><br>          34:  <span style="background-color: white">      import com.openhtmltopdf.render.PageBox;</span><br>          35:  <span style="background-color: white">      </span><br>          36:  <span style="background-color: white">      /**</span><br>          37:  <span style="background-color: white">       * Utility class for laying block content.  It is called when a block box</span><br>          38:  <span style="background-color: white">       * contains block level content.  {@link BoxBuilder} will have made sure that</span><br>          39:  <span style="background-color: white">       * the block we're working on will either contain only inline or block content.</span><br>          40:  <span style="background-color: white">       * If we're in a paged media environment, the various page break related</span><br>          41:  <span style="background-color: white">       * properties are also handled here.  If a rule is violated, the affected run</span><br>          42:  <span style="background-color: white">       * of boxes will be layed out again.  If the rule still cannot be satisfied,</span><br>          43:  <span style="background-color: white">       * the rule will be dropped.</span><br>          44:  <span style="background-color: white">       */</span><br>          45:  <span style="background-color: white">      public class BlockBoxing {</span><br>          46:  <span style="background-color: white">          private static final int NO_PAGE_TRIM = -1;</span><br>          47:  <span style="background-color: white">      </span><br>          48:  <span style="background-color: white">          private BlockBoxing() {</span><br>          49:  <span style="background-color: white">          }</span><br>          50:  <span style="background-color: white">      </span><br>          51:  <span style="background-color: white">          public static void layoutContent(LayoutContext c, BlockBox block, int contentStart) {</span><br>          52:  <span style="background-color: yellow">              int offset = -1;</span><br>          53:  <span style="background-color: white">      </span><br>          54:  <span style="background-color: white">              List
       <box>
         localChildren = block.getChildren();
       </box></span><br>          55:  <span style="background-color: yellow">              if (c.isPrint() &amp;&amp; ! (localChildren instanceof RandomAccess)) {</span><br>          56:  <span style="background-color: yellow">                  localChildren = new ArrayList&lt;&gt;(localChildren);</span><br>          57:  <span style="background-color: yellow">              }</span><br>          58:  <span style="background-color: white">      </span><br>          59:  <span style="background-color: white">              int childOffset = block.getHeight() + contentStart;</span><br>          60:  <span style="background-color: white">      </span><br>          61:  <span style="background-color: yellow">              RelayoutDataList relayoutDataList = null;</span><br>          62:  <span style="background-color: white">              if (c.isPrint()) {</span><br>          63:  <span style="background-color: yellow">                  relayoutDataList = new RelayoutDataList(localChildren.size());</span><br>          64:  <span style="background-color: white">              }</span><br>          65:  <span style="background-color: white">      </span><br>          66:  <span style="background-color: white">              int pageCount = NO_PAGE_TRIM;</span><br>          67:  <span style="background-color: white">              BlockBox previousChildBox = null;</span><br>          68:  <span style="background-color: yellow">              for (Iterator
       <box>
         i = localChildren.iterator(); i.hasNext();) {
       </box></span><br>          69:  <span style="background-color: yellow">                  BlockBox child = (BlockBox) i.next();</span><br>          70:  <span style="background-color: white">                  offset++;</span><br>          71:  <span style="background-color: white">      </span><br>          72:  <span style="background-color: yellow">                  RelayoutData relayoutData = null;</span><br>          73:  <span style="background-color: white">      </span><br>          74:  <span style="background-color: yellow">                  boolean mayCheckKeepTogether = false;</span><br>          75:  <span style="background-color: white">                  if (c.isPrint()) {</span><br>          76:  <span style="background-color: yellow">                      relayoutData = relayoutDataList.get(offset);</span><br>          77:  <span style="background-color: yellow">                      relayoutData.setLayoutState(c.copyStateForRelayout());</span><br>          78:  <span style="background-color: yellow">                      relayoutData.setChildOffset(childOffset);</span><br>          79:  <span style="background-color: white">                      pageCount = c.getRootLayer().getPages().size();</span><br>          80:  <span style="background-color: white">      </span><br>          81:  <span style="background-color: white">                      child.setNeedPageClear(false);</span><br>          82:  <span style="background-color: white">      </span><br>          83:  <span style="background-color: white">                      if ((child.getStyle().isAvoidPageBreakInside() || child.getStyle().isKeepWithInline())</span><br>          84:  <span style="background-color: yellow">                              &amp;&amp; c.isMayCheckKeepTogether()) {</span><br>          85:  <span style="background-color: yellow">                          mayCheckKeepTogether = true;</span><br>          86:  <span style="background-color: yellow">                          c.setMayCheckKeepTogether(false);</span><br>          87:  <span style="background-color: white">                      }</span><br>          88:  <span style="background-color: white">                  }</span><br>          89:  <span style="background-color: white">      </span><br>          90:  <span style="background-color: white">                  layoutBlockChild(</span><br>          91:  <span style="background-color: white">                          c, block, child, false, childOffset, NO_PAGE_TRIM,</span><br>          92:  <span style="background-color: yellow">                          relayoutData == null ? null : relayoutData.getLayoutState());</span><br>          93:  <span style="background-color: white">      </span><br>          94:  <span style="background-color: white">                  if (c.isPrint()) {</span><br>          95:  <span style="background-color: white">                      boolean needPageClear = child.isNeedPageClear();</span><br>          96:  <span style="background-color: yellow">                      if (needPageClear || mayCheckKeepTogether) {</span><br>          97:  <span style="background-color: yellow">                          c.setMayCheckKeepTogether(mayCheckKeepTogether);</span><br>          98:  <span style="background-color: yellow">                          boolean tryToAvoidPageBreak = child.getStyle().isAvoidPageBreakInside() &amp;&amp; child.crossesPageBreak(c);</span><br>          99:  <span style="background-color: white">                          boolean keepWithInline = child.isNeedsKeepWithInline(c);</span><br>         100:  <span style="background-color: white">                          if (tryToAvoidPageBreak || needPageClear || keepWithInline) {</span><br>         101:  <span style="background-color: yellow">                              c.restoreStateForRelayout(relayoutData.getLayoutState());</span><br>         102:  <span style="background-color: white">                              child.reset(c);</span><br>         103:  <span style="background-color: white">                              layoutBlockChild(</span><br>         104:  <span style="background-color: yellow">                                      c, block, child, true, childOffset, pageCount, relayoutData.getLayoutState());</span><br>         105:  <span style="background-color: white">      </span><br>         106:  <span style="background-color: yellow">                              if (tryToAvoidPageBreak &amp;&amp; child.crossesPageBreak(c) &amp;&amp; ! keepWithInline) {</span><br>         107:  <span style="background-color: yellow">                                  c.restoreStateForRelayout(relayoutData.getLayoutState());</span><br>         108:  <span style="background-color: white">                                  child.reset(c);</span><br>         109:  <span style="background-color: white">                                  layoutBlockChild(</span><br>         110:  <span style="background-color: yellow">                                          c, block, child, false, childOffset, pageCount, relayoutData.getLayoutState());</span><br>         111:  <span style="background-color: white">                              }</span><br>         112:  <span style="background-color: white">                          }</span><br>         113:  <span style="background-color: white">                      }</span><br>         114:  <span style="background-color: white">                      c.getRootLayer().ensureHasPage(c, child);</span><br>         115:  <span style="background-color: white">                  }</span><br>         116:  <span style="background-color: white">      </span><br>         117:  <span style="background-color: white">                  Dimension relativeOffset = child.getRelativeOffset();</span><br>         118:  <span style="background-color: white">                  if (relativeOffset == null) {</span><br>         119:  <span style="background-color: white">                      childOffset = child.getY() + child.getHeight();</span><br>         120:  <span style="background-color: white">                  } else {</span><br>         121:  <span style="background-color: white">                      // Box will have been positioned by this point so calculate</span><br>         122:  <span style="background-color: white">                      // relative to where it would have been if it hadn't been</span><br>         123:  <span style="background-color: white">                      // moved</span><br>         124:  <span style="background-color: white">                      childOffset = child.getY() - relativeOffset.height + child.getHeight();</span><br>         125:  <span style="background-color: white">                  }</span><br>         126:  <span style="background-color: white">      </span><br>         127:  <span style="background-color: white">                  if (childOffset &gt; block.getHeight()) {</span><br>         128:  <span style="background-color: white">                      block.setHeight(childOffset);</span><br>         129:  <span style="background-color: white">                  }</span><br>         130:  <span style="background-color: white">      </span><br>         131:  <span style="background-color: white">                  if (c.isPrint()) {</span><br>         132:  <span style="background-color: white">                      if (child.getStyle().isForcePageBreakAfter()) {</span><br>         133:  <span style="background-color: white">                          block.forcePageBreakAfter(c, child.getStyle().getIdent(CSSName.PAGE_BREAK_AFTER));</span><br>         134:  <span style="background-color: white">                          childOffset = block.getHeight();</span><br>         135:  <span style="background-color: white">                      }</span><br>         136:  <span style="background-color: white">      </span><br>         137:  <span style="background-color: white">                      if (previousChildBox != null) {</span><br>         138:  <span style="background-color: yellow">                          relayoutDataList.markRun(offset, previousChildBox, child);</span><br>         139:  <span style="background-color: white">                      }</span><br>         140:  <span style="background-color: white">      </span><br>         141:  <span style="background-color: yellow">                      RelayoutRunResult runResult =</span><br>         142:  <span style="background-color: yellow">                              processPageBreakAvoidRun(</span><br>         143:  <span style="background-color: yellow">                                      c, block, localChildren, offset, relayoutDataList, relayoutData, child);</span><br>         144:  <span style="background-color: yellow">                      if (runResult.isChanged()) {</span><br>         145:  <span style="background-color: yellow">                          childOffset = runResult.getChildOffset();</span><br>         146:  <span style="background-color: white">                          if (childOffset &gt; block.getHeight()) {</span><br>         147:  <span style="background-color: white">                              block.setHeight(childOffset);</span><br>         148:  <span style="background-color: white">                          }</span><br>         149:  <span style="background-color: white">                      }</span><br>         150:  <span style="background-color: white">                  }</span><br>         151:  <span style="background-color: white">      </span><br>         152:  <span style="background-color: white">                  previousChildBox = child;</span><br>         153:  <span style="background-color: white">              }</span><br>         154:  <span style="background-color: white">          }</span><br>         155:  <span style="background-color: white">      </span><br>         156:  <span style="background-color: yellow">          private static RelayoutRunResult processPageBreakAvoidRun(final LayoutContext c, final BlockBox block,</span><br>         157:  <span style="background-color: white">                                                                    List
       <box>
         localChildren, int offset,
       </box></span><br>         158:  <span style="background-color: yellow">                                                                    RelayoutDataList relayoutDataList, RelayoutData relayoutData,</span><br>         159:  <span style="background-color: white">                                                                    BlockBox childBox) {</span><br>         160:  <span style="background-color: yellow">              RelayoutRunResult result = new RelayoutRunResult();</span><br>         161:  <span style="background-color: white">              if (offset &gt; 0) {</span><br>         162:  <span style="background-color: white">                  boolean mightNeedRelayout = false;</span><br>         163:  <span style="background-color: white">                  int runEnd = -1;</span><br>         164:  <span style="background-color: yellow">                  if (offset == localChildren.size() - 1 &amp;&amp; relayoutData.isEndsRun()) {</span><br>         165:  <span style="background-color: white">                      mightNeedRelayout = true;</span><br>         166:  <span style="background-color: white">                      runEnd = offset;</span><br>         167:  <span style="background-color: white">                  } else if (offset &gt; 0) {</span><br>         168:  <span style="background-color: yellow">                      RelayoutData previousRelayoutData = relayoutDataList.get(offset - 1);</span><br>         169:  <span style="background-color: yellow">                      if (previousRelayoutData.isEndsRun()) {</span><br>         170:  <span style="background-color: white">                          mightNeedRelayout = true;</span><br>         171:  <span style="background-color: white">                          runEnd = offset - 1;</span><br>         172:  <span style="background-color: white">                      }</span><br>         173:  <span style="background-color: white">                  }</span><br>         174:  <span style="background-color: white">                  if (mightNeedRelayout) {</span><br>         175:  <span style="background-color: white">                      int runStart = relayoutDataList.getRunStart(runEnd);</span><br>         176:  <span style="background-color: white">                      if ( isPageBreakBetweenChildBoxes(relayoutDataList, runStart, runEnd, c, block) ) {</span><br>         177:  <span style="background-color: yellow">                          result.setChanged(true);</span><br>         178:  <span style="background-color: white">                          block.resetChildren(c, runStart, offset);</span><br>         179:  <span style="background-color: yellow">                          result.setChildOffset(relayoutRun(c, localChildren, block,</span><br>         180:  <span style="background-color: yellow">                                  relayoutDataList, runStart, offset, true));</span><br>         181:  <span style="background-color: white">                          if ( isPageBreakBetweenChildBoxes(relayoutDataList, runStart, runEnd, c, block) ) {</span><br>         182:  <span style="background-color: white">                              block.resetChildren(c, runStart, offset);</span><br>         183:  <span style="background-color: yellow">                              result.setChildOffset(relayoutRun(c, localChildren, block,</span><br>         184:  <span style="background-color: yellow">                                      relayoutDataList, runStart, offset, false));</span><br>         185:  <span style="background-color: white">                          }</span><br>         186:  <span style="background-color: white">                      }</span><br>         187:  <span style="background-color: white">                  }</span><br>         188:  <span style="background-color: white">              }</span><br>         189:  <span style="background-color: yellow">              return result;</span><br>         190:  <span style="background-color: white">          }</span><br>         191:  <span style="background-color: white">      </span><br>         192:  <span style="background-color: yellow">          private static boolean isPageBreakBetweenChildBoxes(RelayoutDataList relayoutDataList,</span><br>         193:  <span style="background-color: white">                  int runStart, int runEnd, LayoutContext c, BlockBox block) {</span><br>         194:  <span style="background-color: white">              for ( int i = runStart; i &lt; runEnd; i++ ) {</span><br>         195:  <span style="background-color: white">                  Box prevChild = block.getChild(i);</span><br>         196:  <span style="background-color: white">                  Box nextChild = block.getChild(i+1);</span><br>         197:  <span style="background-color: white">                  // if nextChild is made of several lines, then only the first line</span><br>         198:  <span style="background-color: white">                  // is relevant for "page-break-before: avoid".</span><br>         199:  <span style="background-color: white">                  Box nextLine = getFirstLine(nextChild) == null ? nextChild : getFirstLine(nextChild);</span><br>         200:  <span style="background-color: white">                  int prevChildEnd = prevChild.getAbsY() + prevChild.getHeight();</span><br>         201:  <span style="background-color: white">                  int nextLineEnd = nextLine.getAbsY() + nextLine.getHeight();</span><br>         202:  <span style="background-color: white">                  if ( c.getRootLayer().crossesPageBreak(c, prevChildEnd, nextLineEnd) ) {</span><br>         203:  <span style="background-color: white">                      return true;</span><br>         204:  <span style="background-color: white">                  }</span><br>         205:  <span style="background-color: white">              }</span><br>         206:  <span style="background-color: white">              return false;</span><br>         207:  <span style="background-color: white">          }</span><br>         208:  <span style="background-color: white">      </span><br>         209:  <span style="background-color: white">          private static LineBox getFirstLine(Box box) {</span><br>         210:  <span style="background-color: white">              for ( Box child = box; child.getChildCount()&gt;0; child = child.getChild(0) ) {</span><br>         211:  <span style="background-color: white">                  if ( child instanceof LineBox ) {</span><br>         212:  <span style="background-color: white">                      return (LineBox) child;</span><br>         213:  <span style="background-color: white">                  }</span><br>         214:  <span style="background-color: white">              }</span><br>         215:  <span style="background-color: white">              return null;</span><br>         216:  <span style="background-color: white">          }</span><br>         217:  <span style="background-color: white">      </span><br>         218:  <span style="background-color: white">          private static int relayoutRun(</span><br>         219:  <span style="background-color: white">                  LayoutContext c, List
       <box>
         localChildren, BlockBox block,
       </box></span><br>         220:  <span style="background-color: yellow">                  RelayoutDataList relayoutDataList, int start, int end, boolean onNewPage) {</span><br>         221:  <span style="background-color: yellow">              int childOffset = relayoutDataList.get(start).getChildOffset();</span><br>         222:  <span style="background-color: white">      </span><br>         223:  <span style="background-color: white">              if (onNewPage) {</span><br>         224:  <span style="background-color: white">                  Box startBox = localChildren.get(start);</span><br>         225:  <span style="background-color: white">                  PageBox startPageBox = c.getRootLayer().getFirstPage(c, startBox);</span><br>         226:  <span style="background-color: white">                  childOffset += startPageBox.getBottom() - startBox.getAbsY();</span><br>         227:  <span style="background-color: white">              }</span><br>         228:  <span style="background-color: white">      </span><br>         229:  <span style="background-color: white">              // reset height of parent as it is used for Y-setting of children</span><br>         230:  <span style="background-color: white">              block.setHeight(childOffset);</span><br>         231:  <span style="background-color: white">      </span><br>         232:  <span style="background-color: white">      </span><br>         233:  <span style="background-color: white">              for (int i = start; i &lt;= end; i++) {</span><br>         234:  <span style="background-color: white">                  BlockBox child = (BlockBox) localChildren.get(i);</span><br>         235:  <span style="background-color: white">      </span><br>         236:  <span style="background-color: yellow">                  RelayoutData relayoutData = relayoutDataList.get(i);</span><br>         237:  <span style="background-color: white">      </span><br>         238:  <span style="background-color: white">                  int pageCount = c.getRootLayer().getPages().size();</span><br>         239:  <span style="background-color: white">      </span><br>         240:  <span style="background-color: white">                  //TODO:handle run-ins. For now, treat them as blocks</span><br>         241:  <span style="background-color: white">      </span><br>         242:  <span style="background-color: yellow">                  c.restoreStateForRelayout(relayoutData.getLayoutState());</span><br>         243:  <span style="background-color: yellow">                  relayoutData.setChildOffset(childOffset);</span><br>         244:  <span style="background-color: white">                  boolean mayCheckKeepTogether = false;</span><br>         245:  <span style="background-color: white">                  if ((child.getStyle().isAvoidPageBreakInside() || child.getStyle().isKeepWithInline())</span><br>         246:  <span style="background-color: white">                          &amp;&amp; c.isMayCheckKeepTogether()) {</span><br>         247:  <span style="background-color: white">                      mayCheckKeepTogether = true;</span><br>         248:  <span style="background-color: white">                      c.setMayCheckKeepTogether(false);</span><br>         249:  <span style="background-color: white">                  }</span><br>         250:  <span style="background-color: white">                  layoutBlockChild(</span><br>         251:  <span style="background-color: yellow">                          c, block, child, false, childOffset, NO_PAGE_TRIM, relayoutData.getLayoutState());</span><br>         252:  <span style="background-color: white">      </span><br>         253:  <span style="background-color: white">                  if (mayCheckKeepTogether) {</span><br>         254:  <span style="background-color: white">                      c.setMayCheckKeepTogether(true);</span><br>         255:  <span style="background-color: white">                      boolean tryToAvoidPageBreak =</span><br>         256:  <span style="background-color: white">                          child.getStyle().isAvoidPageBreakInside() &amp;&amp; child.crossesPageBreak(c);</span><br>         257:  <span style="background-color: white">                      boolean needPageClear = child.isNeedPageClear();</span><br>         258:  <span style="background-color: white">                      boolean keepWithInline = child.isNeedsKeepWithInline(c);</span><br>         259:  <span style="background-color: white">                      if (tryToAvoidPageBreak || needPageClear || keepWithInline) {</span><br>         260:  <span style="background-color: yellow">                          c.restoreStateForRelayout(relayoutData.getLayoutState());</span><br>         261:  <span style="background-color: yellow">                          child.reset(c);</span><br>         262:  <span style="background-color: white">                          layoutBlockChild(</span><br>         263:  <span style="background-color: yellow">                                  c, block, child, true, childOffset, pageCount, relayoutData.getLayoutState());</span><br>         264:  <span style="background-color: white">      </span><br>         265:  <span style="background-color: white">                          if (tryToAvoidPageBreak &amp;&amp; child.crossesPageBreak(c) &amp;&amp; ! keepWithInline) {</span><br>         266:  <span style="background-color: yellow">                              c.restoreStateForRelayout(relayoutData.getLayoutState());</span><br>         267:  <span style="background-color: yellow">                              child.reset(c);</span><br>         268:  <span style="background-color: white">                              layoutBlockChild(</span><br>         269:  <span style="background-color: yellow">                                      c, block, child, false, childOffset, pageCount, relayoutData.getLayoutState());</span><br>         270:  <span style="background-color: white">                          }</span><br>         271:  <span style="background-color: white">                      }</span><br>         272:  <span style="background-color: white">                  }</span><br>         273:  <span style="background-color: white">      </span><br>         274:  <span style="background-color: white">                  c.getRootLayer().ensureHasPage(c, child);</span><br>         275:  <span style="background-color: white">      </span><br>         276:  <span style="background-color: white">                  Dimension relativeOffset = child.getRelativeOffset();</span><br>         277:  <span style="background-color: white">                  if (relativeOffset == null) {</span><br>         278:  <span style="background-color: white">                      childOffset = child.getY() + child.getHeight();</span><br>         279:  <span style="background-color: white">                  } else {</span><br>         280:  <span style="background-color: white">                      childOffset = child.getY() - relativeOffset.height + child.getHeight();</span><br>         281:  <span style="background-color: white">                  }</span><br>         282:  <span style="background-color: white">      </span><br>         283:  <span style="background-color: white">                  if (childOffset &gt; block.getHeight()) {</span><br>         284:  <span style="background-color: white">                      block.setHeight(childOffset);</span><br>         285:  <span style="background-color: white">                  }</span><br>         286:  <span style="background-color: white">      </span><br>         287:  <span style="background-color: white">                  if (child.getStyle().isForcePageBreakAfter()) {</span><br>         288:  <span style="background-color: white">                      block.forcePageBreakAfter(c, child.getStyle().getIdent(CSSName.PAGE_BREAK_AFTER));</span><br>         289:  <span style="background-color: white">                      childOffset = block.getHeight();</span><br>         290:  <span style="background-color: white">                  }</span><br>         291:  <span style="background-color: white">              }</span><br>         292:  <span style="background-color: white">      </span><br>         293:  <span style="background-color: white">              return childOffset;</span><br>         294:  <span style="background-color: white">          }</span><br>         295:  <span style="background-color: white">      </span><br>         296:  <span style="background-color: white">          private static void layoutBlockChild(</span><br>         297:  <span style="background-color: white">                  LayoutContext c, BlockBox parent, BlockBox child,</span><br>         298:  <span style="background-color: white">                  boolean needPageClear, int childOffset, int trimmedPageCount, LayoutState layoutState) {</span><br>         299:  <span style="background-color: white">              layoutBlockChild0(c, parent, child, needPageClear, childOffset, trimmedPageCount);</span><br>         300:  <span style="background-color: white">              BreakAtLineContext bContext = child.calcBreakAtLineContext(c);</span><br>         301:  <span style="background-color: white">              if (bContext != null) {</span><br>         302:  <span style="background-color: white">                  c.setBreakAtLineContext(bContext);</span><br>         303:  <span style="background-color: white">                  c.restoreStateForRelayout(layoutState);</span><br>         304:  <span style="background-color: white">                  child.reset(c);</span><br>         305:  <span style="background-color: white">                  layoutBlockChild0(c, parent, child, needPageClear, childOffset, trimmedPageCount);</span><br>         306:  <span style="background-color: white">                  c.setBreakAtLineContext(null);</span><br>         307:  <span style="background-color: white">              }</span><br>         308:  <span style="background-color: white">          }</span><br>         309:  <span style="background-color: white">      </span><br>         310:  <span style="background-color: white">          private static void layoutBlockChild0(LayoutContext c, BlockBox parent, BlockBox child,</span><br>         311:  <span style="background-color: white">                  boolean needPageClear, int childOffset, int trimmedPageCount) {</span><br>         312:  <span style="background-color: white">              child.setNeedPageClear(needPageClear);</span><br>         313:  <span style="background-color: white">      </span><br>         314:  <span style="background-color: white">              child.initStaticPos(c, parent, childOffset);</span><br>         315:  <span style="background-color: white">      </span><br>         316:  <span style="background-color: white">              child.initContainingLayer(c);</span><br>         317:  <span style="background-color: white">              child.calcCanvasLocation();</span><br>         318:  <span style="background-color: white">      </span><br>         319:  <span style="background-color: white">              c.translate(0, childOffset);</span><br>         320:  <span style="background-color: white">              repositionBox(c, child, trimmedPageCount);</span><br>         321:  <span style="background-color: white">              child.layout(c);</span><br>         322:  <span style="background-color: white">              c.translate(-child.getX(), -child.getY());</span><br>         323:  <span style="background-color: white">          }</span><br>         324:  <span style="background-color: white">      </span><br>         325:  <span style="background-color: white">          private static void repositionBox(LayoutContext c, BlockBox child, int trimmedPageCount) {</span><br>         326:  <span style="background-color: white">              boolean moved = false;</span><br>         327:  <span style="background-color: white">              if (child.getStyle().isRelative()) {</span><br>         328:  <span style="background-color: white">                  Dimension delta = child.positionRelative(c);</span><br>         329:  <span style="background-color: white">                  c.translate(delta.width, delta.height);</span><br>         330:  <span style="background-color: white">                  moved = true;</span><br>         331:  <span style="background-color: white">              }</span><br>         332:  <span style="background-color: white">              if (c.isPrint()) {</span><br>         333:  <span style="background-color: white">                  boolean pageClear = child.isNeedPageClear() ||</span><br>         334:  <span style="background-color: white">                                          child.getStyle().isForcePageBreakBefore() ||</span><br>         335:  <span style="background-color: white">                                          child.isPageBreakNeededBecauseOfMinHeight(c);</span><br>         336:  <span style="background-color: white">                  boolean needNewPageContext = child.checkPageContext(c);</span><br>         337:  <span style="background-color: white">      </span><br>         338:  <span style="background-color: white">                  if (needNewPageContext &amp;&amp; trimmedPageCount != NO_PAGE_TRIM) {</span><br>         339:  <span style="background-color: white">                      c.getRootLayer().trimPageCount(trimmedPageCount);</span><br>         340:  <span style="background-color: white">                  }</span><br>         341:  <span style="background-color: white">      </span><br>         342:  <span style="background-color: white">                  if (pageClear || needNewPageContext) {</span><br>         343:  <span style="background-color: white">                      int delta = child.forcePageBreakBefore(</span><br>         344:  <span style="background-color: white">                              c,</span><br>         345:  <span style="background-color: white">                              child.getStyle().getIdent(CSSName.PAGE_BREAK_BEFORE),</span><br>         346:  <span style="background-color: white">                              needNewPageContext);</span><br>         347:  <span style="background-color: white">                      c.translate(0, delta);</span><br>         348:  <span style="background-color: white">                      moved = true;</span><br>         349:  <span style="background-color: white">                      child.setNeedPageClear(false);</span><br>         350:  <span style="background-color: white">                  }</span><br>         351:  <span style="background-color: white">              }</span><br>         352:  <span style="background-color: white">              if (moved) {</span><br>         353:  <span style="background-color: white">                  child.calcCanvasLocation();</span><br>         354:  <span style="background-color: white">              }</span><br>         355:  <span style="background-color: white">          }</span><br>         356:  <span style="background-color: white">      </span><br>         357:  <span style="background-color: yellow">          private static class RelayoutDataList {</span><br>         358:  <span style="background-color: yellow">              private List
       <relayoutdata>
         _hints;
       </relayoutdata></span><br>         359:  <span style="background-color: yellow">      </span><br>         360:  <span style="background-color: yellow">              public RelayoutDataList(int size) {</span><br>         361:  <span style="background-color: yellow">                  _hints = new ArrayList&lt;&gt;(size);</span><br>         362:  <span style="background-color: yellow">                  for (int i = 0; i &lt; size; i++) {</span><br>         363:  <span style="background-color: yellow">                      _hints.add(new RelayoutData());</span><br>         364:  <span style="background-color: yellow">                  }</span><br>         365:  <span style="background-color: yellow">              }</span><br>         366:  <span style="background-color: yellow">      </span><br>         367:  <span style="background-color: yellow">              public RelayoutData get(int index) {</span><br>         368:  <span style="background-color: yellow">                  return _hints.get(index);</span><br>         369:  <span style="background-color: yellow">              }</span><br>         370:  <span style="background-color: yellow">      </span><br>         371:  <span style="background-color: yellow">              public void markRun(int offset, BlockBox previous, BlockBox current) {</span><br>         372:  <span style="background-color: yellow">                  RelayoutData previousData = get(offset - 1);</span><br>         373:  <span style="background-color: yellow">                  RelayoutData currentData = get(offset);</span><br>         374:  <span style="background-color: yellow">      </span><br>         375:  <span style="background-color: yellow">                  IdentValue previousAfter =</span><br>         376:  <span style="background-color: yellow">                          previous.getStyle().getIdent(CSSName.PAGE_BREAK_AFTER);</span><br>         377:  <span style="background-color: yellow">                  IdentValue currentBefore =</span><br>         378:  <span style="background-color: yellow">                          current.getStyle().getIdent(CSSName.PAGE_BREAK_BEFORE);</span><br>         379:  <span style="background-color: yellow">      </span><br>         380:  <span style="background-color: yellow">                  if ((previousAfter == IdentValue.AVOID &amp;&amp; currentBefore == IdentValue.AUTO) ||</span><br>         381:  <span style="background-color: yellow">                          (previousAfter == IdentValue.AUTO &amp;&amp; currentBefore == IdentValue.AVOID) ||</span><br>         382:  <span style="background-color: yellow">                          (previousAfter == IdentValue.AVOID &amp;&amp; currentBefore == IdentValue.AVOID)) {</span><br>         383:  <span style="background-color: yellow">                      if (! previousData.isInRun()) {</span><br>         384:  <span style="background-color: yellow">                          previousData.setStartsRun(true);</span><br>         385:  <span style="background-color: yellow">                      }</span><br>         386:  <span style="background-color: yellow">                      previousData.setInRun(true);</span><br>         387:  <span style="background-color: yellow">                      currentData.setInRun(true);</span><br>         388:  <span style="background-color: yellow">      </span><br>         389:  <span style="background-color: yellow">                      if (offset == _hints.size() - 1) {</span><br>         390:  <span style="background-color: yellow">                          currentData.setEndsRun(true);</span><br>         391:  <span style="background-color: yellow">                      }</span><br>         392:  <span style="background-color: yellow">                  } else {</span><br>         393:  <span style="background-color: yellow">                      if (previousData.isInRun()) {</span><br>         394:  <span style="background-color: yellow">                          previousData.setEndsRun(true);</span><br>         395:  <span style="background-color: yellow">                      }</span><br>         396:  <span style="background-color: yellow">                  }</span><br>         397:  <span style="background-color: yellow">              }</span><br>         398:  <span style="background-color: yellow">      </span><br>         399:  <span style="background-color: yellow">              public int getRunStart(int runEnd) {</span><br>         400:  <span style="background-color: yellow">                  int offset = runEnd;</span><br>         401:  <span style="background-color: yellow">                  RelayoutData current = get(offset);</span><br>         402:  <span style="background-color: yellow">                  if (! current.isEndsRun()) {</span><br>         403:  <span style="background-color: yellow">                      throw new RuntimeException("Not the end of a run");</span><br>         404:  <span style="background-color: yellow">                  }</span><br>         405:  <span style="background-color: yellow">                  while (! current.isStartsRun()) {</span><br>         406:  <span style="background-color: yellow">                      current = get(--offset);</span><br>         407:  <span style="background-color: yellow">                  }</span><br>         408:  <span style="background-color: yellow">                  return offset;</span><br>         409:  <span style="background-color: yellow">              }</span><br>         410:  <span style="background-color: yellow">          }</span><br>         411:  <span style="background-color: white">      </span><br>         412:  <span style="background-color: yellow">          private static class RelayoutRunResult {</span><br>         413:  <span style="background-color: yellow">              private boolean _changed;</span><br>         414:  <span style="background-color: yellow">              private int _childOffset;</span><br>         415:  <span style="background-color: yellow">      </span><br>         416:  <span style="background-color: yellow">              public boolean isChanged() {</span><br>         417:  <span style="background-color: yellow">                  return _changed;</span><br>         418:  <span style="background-color: yellow">              }</span><br>         419:  <span style="background-color: yellow">      </span><br>         420:  <span style="background-color: yellow">              public void setChanged(boolean changed) {</span><br>         421:  <span style="background-color: yellow">                  _changed = changed;</span><br>         422:  <span style="background-color: yellow">              }</span><br>         423:  <span style="background-color: yellow">      </span><br>         424:  <span style="background-color: yellow">              public int getChildOffset() {</span><br>         425:  <span style="background-color: yellow">                  return _childOffset;</span><br>         426:  <span style="background-color: yellow">              }</span><br>         427:  <span style="background-color: yellow">      </span><br>         428:  <span style="background-color: yellow">              public void setChildOffset(int childOffset) {</span><br>         429:  <span style="background-color: yellow">                  _childOffset = childOffset;</span><br>         430:  <span style="background-color: yellow">              }</span><br>         431:  <span style="background-color: yellow">          }</span><br>         432:  <span style="background-color: white">      </span><br>         433:  <span style="background-color: yellow">          private static class RelayoutData {</span><br>         434:  <span style="background-color: yellow">              private LayoutState _layoutState;</span><br>         435:  <span style="background-color: yellow">      </span><br>         436:  <span style="background-color: yellow">              private boolean _startsRun;</span><br>         437:  <span style="background-color: yellow">              private boolean _endsRun;</span><br>         438:  <span style="background-color: yellow">              private boolean _inRun;</span><br>         439:  <span style="background-color: yellow">      </span><br>         440:  <span style="background-color: yellow">              private int _childOffset;</span><br>         441:  <span style="background-color: yellow">      </span><br>         442:  <span style="background-color: yellow">              public RelayoutData() {</span><br>         443:  <span style="background-color: yellow">              }</span><br>         444:  <span style="background-color: yellow">      </span><br>         445:  <span style="background-color: yellow">              public boolean isEndsRun() {</span><br>         446:  <span style="background-color: yellow">                  return _endsRun;</span><br>         447:  <span style="background-color: yellow">              }</span><br>         448:  <span style="background-color: yellow">      </span><br>         449:  <span style="background-color: yellow">              public void setEndsRun(boolean endsRun) {</span><br>         450:  <span style="background-color: yellow">                  _endsRun = endsRun;</span><br>         451:  <span style="background-color: yellow">              }</span><br>         452:  <span style="background-color: yellow">      </span><br>         453:  <span style="background-color: yellow">              public boolean isInRun() {</span><br>         454:  <span style="background-color: yellow">                  return _inRun;</span><br>         455:  <span style="background-color: yellow">              }</span><br>         456:  <span style="background-color: yellow">      </span><br>         457:  <span style="background-color: yellow">              public void setInRun(boolean inRun) {</span><br>         458:  <span style="background-color: yellow">                  _inRun = inRun;</span><br>         459:  <span style="background-color: yellow">              }</span><br>         460:  <span style="background-color: yellow">      </span><br>         461:  <span style="background-color: yellow">              public LayoutState getLayoutState() {</span><br>         462:  <span style="background-color: yellow">                  return _layoutState;</span><br>         463:  <span style="background-color: yellow">              }</span><br>         464:  <span style="background-color: yellow">      </span><br>         465:  <span style="background-color: yellow">              public void setLayoutState(LayoutState layoutState) {</span><br>         466:  <span style="background-color: yellow">                  _layoutState = layoutState;</span><br>         467:  <span style="background-color: yellow">              }</span><br>         468:  <span style="background-color: yellow">      </span><br>         469:  <span style="background-color: yellow">              public boolean isStartsRun() {</span><br>         470:  <span style="background-color: yellow">                  return _startsRun;</span><br>         471:  <span style="background-color: yellow">              }</span><br>         472:  <span style="background-color: yellow">      </span><br>         473:  <span style="background-color: yellow">              public void setStartsRun(boolean startsRun) {</span><br>         474:  <span style="background-color: yellow">                  _startsRun = startsRun;</span><br>         475:  <span style="background-color: yellow">              }</span><br>         476:  <span style="background-color: yellow">      </span><br>         477:  <span style="background-color: yellow">              public int getChildOffset() {</span><br>         478:  <span style="background-color: yellow">                  return _childOffset;</span><br>         479:  <span style="background-color: yellow">              }</span><br>         480:  <span style="background-color: yellow">      </span><br>         481:  <span style="background-color: yellow">              public void setChildOffset(int childOffset) {</span><br>         482:  <span style="background-color: yellow">                  _childOffset = childOffset;</span><br>         483:  <span style="background-color: yellow">              }</span><br>         484:  <span style="background-color: yellow">          }</span><br>         485:  <span style="background-color: white">      }</span><br>         486:  <span style="background-color: white">      </span><br>         487:  <span style="background-color: white">      /*</span><br>         488:  <span style="background-color: white">       * $Id$</span><br>         489:  <span style="background-color: white">       *</span><br>         490:  <span style="background-color: white">       * $Log$</span><br>         491:  <span style="background-color: white">       * Revision 1.69  2009/05/12 17:38:30  peterbrant</span><br>         492:  <span style="background-color: white">       * Patch from Stefan Hoffmann</span><br>         493:  <span style="background-color: white">       *</span><br>         494:  <span style="background-color: white">       * Revision 1.68  2009/01/23 22:32:07  peterbrant</span><br>         495:  <span style="background-color: white">       * Fix NPE reported by Christophe M (thanks Patrick)</span><br>         496:  <span style="background-color: white">       *</span><br>         497:  <span style="background-color: white">       * Revision 1.67  2008/12/14 13:53:30  peterbrant</span><br>         498:  <span style="background-color: white">       * Implement -fs-keep-with-inline: keep property that instructs FS to try to avoid breaking a box so that only borders and padding appear on a page</span><br>         499:  <span style="background-color: white">       *</span><br>         500:  <span style="background-color: white">       * Revision 1.66  2008/04/12 01:04:13  peterbrant</span><br>         501:  <span style="background-color: white">       * Optimize implementation of page-break-inside: avoid</span><br>         502:  <span style="background-color: white">       *</span><br>         503:  <span style="background-color: white">       * Revision 1.65  2008/02/03 12:35:06  peterbrant</span><br>         504:  <span style="background-color: white">       * Need to update child offset when laying out a block again.  We'll need it later if two "keep together" runs adjoin.</span><br>         505:  <span style="background-color: white">       *</span><br>         506:  <span style="background-color: white">       * Revision 1.64  2007/08/19 22:22:52  peterbrant</span><br>         507:  <span style="background-color: white">       * Merge R8pbrant changes to HEAD</span><br>         508:  <span style="background-color: white">       *</span><br>         509:  <span style="background-color: white">       * Revision 1.63.2.3  2007/08/17 19:11:30  peterbrant</span><br>         510:  <span style="background-color: white">       * When paginating a table, move table past page break if header would overlap the page break</span><br>         511:  <span style="background-color: white">       *</span><br>         512:  <span style="background-color: white">       * Revision 1.63.2.2  2007/08/17 17:11:01  peterbrant</span><br>         513:  <span style="background-color: white">       * Try to avoid awkward row splits when paginating a table by making sure there is at least one line box on the same page as the start of the row</span><br>         514:  <span style="background-color: white">       *</span><br>         515:  <span style="background-color: white">       * Revision 1.63.2.1  2007/08/07 17:06:30  peterbrant</span><br>         516:  <span style="background-color: white">       * Implement named pages / Implement page-break-before/after: left/right / Experiment with efficient selection</span><br>         517:  <span style="background-color: white">       *</span><br>         518:  <span style="background-color: white">       * Revision 1.63  2007/06/16 22:51:24  tobega</span><br>         519:  <span style="background-color: white">       * We now support counters!</span><br>         520:  <span style="background-color: white">       *</span><br>         521:  <span style="background-color: white">       * Revision 1.62  2007/06/11 22:24:53  peterbrant</span><br>         522:  <span style="background-color: white">       * Fix bug when calculating new initial position of a run of blocks tied together by page-break-before/after</span><br>         523:  <span style="background-color: white">       *</span><br>         524:  <span style="background-color: white">       * Revision 1.61  2007/06/07 16:56:30  peterbrant</span><br>         525:  <span style="background-color: white">       * When vertically aligning table cell content, call layout again on cells as necessary to make sure pagination properties are respected at the cell's final position (and to make sure line boxes can't straddle page breaks).</span><br>         526:  <span style="background-color: white">       *</span><br>         527:  <span style="background-color: white">       * Revision 1.60  2007/05/22 15:55:15  peterbrant</span><br>         528:  <span style="background-color: white">       * Minor cleanup</span><br>         529:  <span style="background-color: white">       *</span><br>         530:  <span style="background-color: white">       * Revision 1.59  2007/05/21 21:58:48  peterbrant</span><br>         531:  <span style="background-color: white">       * More cleanup (remove experimental threading code)</span><br>         532:  <span style="background-color: white">       *</span><br>         533:  <span style="background-color: white">       * Revision 1.58  2007/04/25 18:09:41  peterbrant</span><br>         534:  <span style="background-color: white">       * Always reset block box margin if it is the first thing on a page</span><br>         535:  <span style="background-color: white">       *</span><br>         536:  <span style="background-color: white">       * Revision 1.57  2007/03/12 21:11:21  peterbrant</span><br>         537:  <span style="background-color: white">       * Documentation update</span><br>         538:  <span style="background-color: white">       *</span><br>         539:  <span style="background-color: white">       * Revision 1.56  2007/03/08 19:47:04  peterbrant</span><br>         540:  <span style="background-color: white">       * Comment change</span><br>         541:  <span style="background-color: white">       *</span><br>         542:  <span style="background-color: white">       * Revision 1.55  2007/03/08 18:02:51  peterbrant</span><br>         543:  <span style="background-color: white">       * Fix regression in page-break-before/after: always</span><br>         544:  <span style="background-color: white">       *</span><br>         545:  <span style="background-color: white">       * Revision 1.54  2007/02/21 23:49:41  peterbrant</span><br>         546:  <span style="background-color: white">       * Can't calculate clearance until margins have been collapsed / Clearance must be calculated relative to the box's border edge, not margin edge</span><br>         547:  <span style="background-color: white">       *</span><br>         548:  <span style="background-color: white">       * Revision 1.53  2007/02/21 17:16:49  peterbrant</span><br>         549:  <span style="background-color: white">       * Calculate position of next child and block height independently.  They may not</span><br>         550:  <span style="background-color: white">       * move in lockstep in the face of negative vertical margins.</span><br>         551:  <span style="background-color: white">       *</span><br>         552:  <span style="background-color: white">       * Revision 1.52  2007/02/07 16:33:35  peterbrant</span><br>         553:  <span style="background-color: white">       * Initial commit of rewritten table support and associated refactorings</span><br>         554:  <span style="background-color: white">       *</span><br>         555:  <span style="background-color: white">       * Revision 1.51  2006/09/01 23:49:35  peterbrant</span><br>         556:  <span style="background-color: white">       * Implement basic margin collapsing / Various refactorings in preparation for shrink-to-fit / Add hack to treat auto margins as zero</span><br>         557:  <span style="background-color: white">       *</span><br>         558:  <span style="background-color: white">       * Revision 1.50  2006/08/29 17:29:11  peterbrant</span><br>         559:  <span style="background-color: white">       * Make Style object a thing of the past</span><br>         560:  <span style="background-color: white">       *</span><br>         561:  <span style="background-color: white">       * Revision 1.49  2006/08/27 00:35:42  peterbrant</span><br>         562:  <span style="background-color: white">       * Initial commit of (initial) R7 work</span><br>         563:  <span style="background-color: white">       *</span><br>         564:  <span style="background-color: white">       * Revision 1.48  2006/03/01 00:45:03  peterbrant</span><br>         565:  <span style="background-color: white">       * Provide LayoutContext when calling detach() and friends</span><br>         566:  <span style="background-color: white">       *</span><br>         567:  <span style="background-color: white">       * Revision 1.47  2006/02/07 00:02:51  peterbrant</span><br>         568:  <span style="background-color: white">       * If "keep together" cannot be satisified, drop rule vs. pushing to next page / Fix bug with incorrect positioning of content following relative block layers</span><br>         569:  <span style="background-color: white">       *</span><br>         570:  <span style="background-color: white">       * Revision 1.46  2006/01/27 01:15:31  peterbrant</span><br>         571:  <span style="background-color: white">       * Start on better support for different output devices</span><br>         572:  <span style="background-color: white">       *</span><br>         573:  <span style="background-color: white">       * Revision 1.45  2006/01/11 22:08:53  peterbrant</span><br>         574:  <span style="background-color: white">       * Only increment list "counter" when display: list-item</span><br>         575:  <span style="background-color: white">       *</span><br>         576:  <span style="background-color: white">       * Revision 1.44  2006/01/10 20:11:31  peterbrant</span><br>         577:  <span style="background-color: white">       * Fix bug in page-break-before/avoid: avoid</span><br>         578:  <span style="background-color: white">       *</span><br>         579:  <span style="background-color: white">       * Revision 1.43  2006/01/10 19:55:59  peterbrant</span><br>         580:  <span style="background-color: white">       * Fix inappropriate box resizing when width: auto</span><br>         581:  <span style="background-color: white">       *</span><br>         582:  <span style="background-color: white">       * Revision 1.42  2006/01/04 19:50:15  peterbrant</span><br>         583:  <span style="background-color: white">       * More pagination bug fixes / Implement simple pagination for tables</span><br>         584:  <span style="background-color: white">       *</span><br>         585:  <span style="background-color: white">       * Revision 1.41  2006/01/03 23:55:54  peterbrant</span><br>         586:  <span style="background-color: white">       * Add support for proper page breaking of floats / More bug fixes to pagination support</span><br>         587:  <span style="background-color: white">       *</span><br>         588:  <span style="background-color: white">       * Revision 1.40  2006/01/03 17:04:46  peterbrant</span><br>         589:  <span style="background-color: white">       * Many pagination bug fixes / Add ability to position absolute boxes in margin area</span><br>         590:  <span style="background-color: white">       *</span><br>         591:  <span style="background-color: white">       * Revision 1.39  2006/01/02 20:59:07  peterbrant</span><br>         592:  <span style="background-color: white">       * Implement page-break-before/after: avoid</span><br>         593:  <span style="background-color: white">       *</span><br>         594:  <span style="background-color: white">       * Revision 1.38  2006/01/01 03:35:37  peterbrant</span><br>         595:  <span style="background-color: white">       * In print mode, make sure block has a page on which to be drawn</span><br>         596:  <span style="background-color: white">       *</span><br>         597:  <span style="background-color: white">       * Revision 1.37  2006/01/01 03:14:27  peterbrant</span><br>         598:  <span style="background-color: white">       * Implement page-break-inside: avoid</span><br>         599:  <span style="background-color: white">       *</span><br>         600:  <span style="background-color: white">       * Revision 1.36  2006/01/01 02:38:16  peterbrant</span><br>         601:  <span style="background-color: white">       * Merge more pagination work / Various minor cleanups</span><br>         602:  <span style="background-color: white">       *</span><br>         603:  <span style="background-color: white">       * Revision 1.35  2005/12/30 01:32:35  peterbrant</span><br>         604:  <span style="background-color: white">       * First merge of parts of pagination work</span><br>         605:  <span style="background-color: white">       *</span><br>         606:  <span style="background-color: white">       * Revision 1.34  2005/12/28 00:50:50  peterbrant</span><br>         607:  <span style="background-color: white">       * Continue ripping out first try at pagination / Minor method name refactoring</span><br>         608:  <span style="background-color: white">       *</span><br>         609:  <span style="background-color: white">       * Revision 1.33  2005/12/21 02:36:26  peterbrant</span><br>         610:  <span style="background-color: white">       * - Calculate absolute positions incrementally (prep work for pagination)</span><br>         611:  <span style="background-color: white">       * - Light cleanup</span><br>         612:  <span style="background-color: white">       * - Fix bug where floats nested in floats could cause the outer float to be positioned in the wrong place</span><br>         613:  <span style="background-color: white">       *</span><br>         614:  <span style="background-color: white">       * Revision 1.32  2005/12/17 02:24:07  peterbrant</span><br>         615:  <span style="background-color: white">       * Remove last pieces of old (now non-working) clip region checking / Push down handful of fields from Box to BlockBox</span><br>         616:  <span style="background-color: white">       *</span><br>         617:  <span style="background-color: white">       * Revision 1.31  2005/12/07 00:33:12  peterbrant</span><br>         618:  <span style="background-color: white">       * :first-letter and :first-line works again</span><br>         619:  <span style="background-color: white">       *</span><br>         620:  <span style="background-color: white">       * Revision 1.30  2005/12/05 00:13:54  peterbrant</span><br>         621:  <span style="background-color: white">       * Improve list-item support (marker positioning is now correct) / Start support for relative inline layers</span><br>         622:  <span style="background-color: white">       *</span><br>         623:  <span style="background-color: white">       * Revision 1.29  2005/11/29 02:37:25  peterbrant</span><br>         624:  <span style="background-color: white">       * Make clear work again / Rip out old pagination code</span><br>         625:  <span style="background-color: white">       *</span><br>         626:  <span style="background-color: white">       * Revision 1.28  2005/11/25 16:57:14  peterbrant</span><br>         627:  <span style="background-color: white">       * Initial commit of inline content refactoring</span><br>         628:  <span style="background-color: white">       *</span><br>         629:  <span style="background-color: white">       * Revision 1.27  2005/11/05 18:45:05  peterbrant</span><br>         630:  <span style="background-color: white">       * General cleanup / Remove obsolete code</span><br>         631:  <span style="background-color: white">       *</span><br>         632:  <span style="background-color: white">       * Revision 1.26  2005/11/05 03:29:30  peterbrant</span><br>         633:  <span style="background-color: white">       * Start work on painting order and improved positioning implementation</span><br>         634:  <span style="background-color: white">       *</span><br>         635:  <span style="background-color: white">       * Revision 1.25  2005/11/03 20:58:41  peterbrant</span><br>         636:  <span style="background-color: white">       * Bug fixes to rewritten float code.  Floated block positioning should be very solid now.</span><br>         637:  <span style="background-color: white">       *</span><br>         638:  <span style="background-color: white">       * Revision 1.24  2005/11/03 17:58:16  peterbrant</span><br>         639:  <span style="background-color: white">       * Float rewrite (still stomping bugs, but demos work)</span><br>         640:  <span style="background-color: white">       *</span><br>         641:  <span style="background-color: white">       * Revision 1.23  2005/11/02 18:15:25  peterbrant</span><br>         642:  <span style="background-color: white">       * First merge of Tobe's and my stacking context work / Rework float code (not done yet)</span><br>         643:  <span style="background-color: white">       *</span><br>         644:  <span style="background-color: white">       * Revision 1.22  2005/10/27 00:08:58  tobega</span><br>         645:  <span style="background-color: white">       * Sorted out Context into RenderingContext and LayoutContext</span><br>         646:  <span style="background-color: white">       *</span><br>         647:  <span style="background-color: white">       * Revision 1.21  2005/10/18 20:57:01  tobega</span><br>         648:  <span style="background-color: white">       * Patch from Peter Brant</span><br>         649:  <span style="background-color: white">       *</span><br>         650:  <span style="background-color: white">       * Revision 1.20  2005/10/16 23:57:14  tobega</span><br>         651:  <span style="background-color: white">       * Starting experiment with flat representation of render tree</span><br>         652:  <span style="background-color: white">       *</span><br>         653:  <span style="background-color: white">       * Revision 1.19  2005/10/12 21:17:12  tobega</span><br>         654:  <span style="background-color: white">       * patch from Peter Brant</span><br>         655:  <span style="background-color: white">       *</span><br>         656:  <span style="background-color: white">       * Revision 1.18  2005/10/08 17:40:20  tobega</span><br>         657:  <span style="background-color: white">       * Patch from Peter Brant</span><br>         658:  <span style="background-color: white">       *</span><br>         659:  <span style="background-color: white">       * Revision 1.17  2005/10/06 03:20:20  tobega</span><br>         660:  <span style="background-color: white">       * Prettier incremental rendering. Ran into more trouble than expected and some creepy crawlies and a few pages don't look right (forms.xhtml, splash.xhtml)</span><br>         661:  <span style="background-color: white">       *</span><br>         662:  <span style="background-color: white">       * Revision 1.16  2005/10/02 21:42:53  tobega</span><br>         663:  <span style="background-color: white">       * Only do incremental rendering if we are in an interactive context</span><br>         664:  <span style="background-color: white">       *</span><br>         665:  <span style="background-color: white">       * Revision 1.15  2005/10/02 21:29:58  tobega</span><br>         666:  <span style="background-color: white">       * Fixed a lot of concurrency (and other) issues from incremental rendering. Also some house-cleaning.</span><br>         667:  <span style="background-color: white">       *</span><br>         668:  <span style="background-color: white">       * Revision 1.14  2005/09/29 21:34:02  joshy</span><br>         669:  <span style="background-color: white">       * minor updates to a lot of files. pulling in more incremental rendering code.</span><br>         670:  <span style="background-color: white">       * fixed another resize bug</span><br>         671:  <span style="background-color: white">       * Issue number:</span><br>         672:  <span style="background-color: white">       * Obtained from:</span><br>         673:  <span style="background-color: white">       * Submitted by:</span><br>         674:  <span style="background-color: white">       * Reviewed by:</span><br>         675:  <span style="background-color: white">       *</span><br>         676:  <span style="background-color: white">       * Revision 1.13  2005/09/27 23:48:39  joshy</span><br>         677:  <span style="background-color: white">       * first merge of basicpanel reworking and incremental layout. more to come.</span><br>         678:  <span style="background-color: white">       * Issue number:</span><br>         679:  <span style="background-color: white">       * Obtained from:</span><br>         680:  <span style="background-color: white">       * Submitted by:</span><br>         681:  <span style="background-color: white">       * Reviewed by:</span><br>         682:  <span style="background-color: white">       *</span><br>         683:  <span style="background-color: white">       * Revision 1.12  2005/07/20 18:11:41  joshy</span><br>         684:  <span style="background-color: white">       * bug fixes to absolute pos layout and box finding within abs layout</span><br>         685:  <span style="background-color: white">       *</span><br>         686:  <span style="background-color: white">       * Revision 1.11  2005/06/19 23:31:32  joshy</span><br>         687:  <span style="background-color: white">       * stop layout support</span><br>         688:  <span style="background-color: white">       * clear bug fixes</span><br>         689:  <span style="background-color: white">       * mouse busy cursor support</span><br>         690:  <span style="background-color: white">       *</span><br>         691:  <span style="background-color: white">       * Issue number:</span><br>         692:  <span style="background-color: white">       * Obtained from:</span><br>         693:  <span style="background-color: white">       * Submitted by:</span><br>         694:  <span style="background-color: white">       * Reviewed by:</span><br>         695:  <span style="background-color: white">       *</span><br>         696:  <span style="background-color: white">       * Revision 1.10  2005/06/16 18:34:09  joshy</span><br>         697:  <span style="background-color: white">       * support for clear:right</span><br>         698:  <span style="background-color: white">       * Issue number:</span><br>         699:  <span style="background-color: white">       * Obtained from:</span><br>         700:  <span style="background-color: white">       * Submitted by:</span><br>         701:  <span style="background-color: white">       * Reviewed by:</span><br>         702:  <span style="background-color: white">       *</span><br>         703:  <span style="background-color: white">       * Revision 1.9  2005/06/16 04:38:15  joshy</span><br>         704:  <span style="background-color: white">       * finished support for clear</span><br>         705:  <span style="background-color: white">       * Issue number:</span><br>         706:  <span style="background-color: white">       * Obtained from:</span><br>         707:  <span style="background-color: white">       * Submitted by:</span><br>         708:  <span style="background-color: white">       * Reviewed by:</span><br>         709:  <span style="background-color: white">       *</span><br>         710:  <span style="background-color: white">       * Revision 1.8  2005/06/15 16:49:48  joshy</span><br>         711:  <span style="background-color: white">       * inital clear support</span><br>         712:  <span style="background-color: white">       * Issue number:</span><br>         713:  <span style="background-color: white">       * Obtained from:</span><br>         714:  <span style="background-color: white">       * Submitted by:</span><br>         715:  <span style="background-color: white">       * Reviewed by:</span><br>         716:  <span style="background-color: white">       *</span><br>         717:  <span style="background-color: white">       * Revision 1.7  2005/06/05 01:02:34  tobega</span><br>         718:  <span style="background-color: white">       * Very simple and not completely functional table layout</span><br>         719:  <span style="background-color: white">       *</span><br>         720:  <span style="background-color: white">       * Revision 1.6  2005/06/03 19:56:42  tobega</span><br>         721:  <span style="background-color: white">       * Now uses first-line styles from all block-level ancestors</span><br>         722:  <span style="background-color: white">       *</span><br>         723:  <span style="background-color: white">       * Revision 1.5  2005/05/13 11:49:57  tobega</span><br>         724:  <span style="background-color: white">       * Started to fix up borders on inlines. Got caught up in refactoring.</span><br>         725:  <span style="background-color: white">       * Boxes shouldn't cache borders and stuff unless necessary. Started to remove unnecessary references.</span><br>         726:  <span style="background-color: white">       * Hover is not working completely well now, might get better when I'm done.</span><br>         727:  <span style="background-color: white">       *</span><br>         728:  <span style="background-color: white">       * Revision 1.4  2005/01/31 22:50:17  pdoubleya</span><br>         729:  <span style="background-color: white">       * .</span><br>         730:  <span style="background-color: white">       *</span><br>         731:  <span style="background-color: white">       * Revision 1.3  2005/01/29 20:24:27  pdoubleya</span><br>         732:  <span style="background-color: white">       * Clean/reformat code. Removed commented blocks, checked copyright.</span><br>         733:  <span style="background-color: white">       *</span><br>         734:  <span style="background-color: white">       * Revision 1.2  2005/01/07 12:42:07  tobega</span><br>         735:  <span style="background-color: white">       * Hacked improved support for custom components (read forms). Creates trouble with the image demo. Anyway, components work and are usually in the right place.</span><br>         736:  <span style="background-color: white">       *</span><br>         737:  <span style="background-color: white">       * Revision 1.1  2005/01/02 12:22:16  tobega</span><br>         738:  <span style="background-color: white">       * Cleaned out old layout code</span><br>         739:  <span style="background-color: white">       *</span><br>         740:  <span style="background-color: white">       * Revision 1.62  2005/01/02 09:32:40  tobega</span><br>         741:  <span style="background-color: white">       * Now using mostly static methods for layout</span><br>         742:  <span style="background-color: white">       *</span><br>         743:  <span style="background-color: white">       * Revision 1.61  2005/01/02 01:00:08  tobega</span><br>         744:  <span style="background-color: white">       * Started sketching in code for handling replaced elements in the NamespaceHandler</span><br>         745:  <span style="background-color: white">       *</span><br>         746:  <span style="background-color: white">       * Revision 1.60  2005/01/01 23:38:37  tobega</span><br>         747:  <span style="background-color: white">       * Cleaned out old rendering code</span><br>         748:  <span style="background-color: white">       *</span><br>         749:  <span style="background-color: white">       * Revision 1.59  2005/01/01 22:37:43  tobega</span><br>         750:  <span style="background-color: white">       * Started adding in the table support.</span><br>         751:  <span style="background-color: white">       *</span><br>         752:  <span style="background-color: white">       * Revision 1.58  2004/12/29 10:39:32  tobega</span><br>         753:  <span style="background-color: white">       * Separated current state Context into LayoutContext and the rest into SharedContext.</span><br>         754:  <span style="background-color: white">       *</span><br>         755:  <span style="background-color: white">       * Revision 1.57  2004/12/28 01:48:23  tobega</span><br>         756:  <span style="background-color: white">       * More cleaning. Magically, the financial report demo is starting to look reasonable, without any effort being put on it.</span><br>         757:  <span style="background-color: white">       *</span><br>         758:  <span style="background-color: white">       * Revision 1.56  2004/12/27 09:40:47  tobega</span><br>         759:  <span style="background-color: white">       * Moved more styling to render stage. Now inlines have backgrounds and borders again.</span><br>         760:  <span style="background-color: white">       *</span><br>         761:  <span style="background-color: white">       * Revision 1.55  2004/12/27 07:43:30  tobega</span><br>         762:  <span style="background-color: white">       * Cleaned out border from box, it can be gotten from current style. Is it maybe needed for dynamic stuff?</span><br>         763:  <span style="background-color: white">       *</span><br>         764:  <span style="background-color: white">       * Revision 1.54  2004/12/24 08:46:49  tobega</span><br>         765:  <span style="background-color: white">       * Starting to get some semblance of order concerning floats. Still needs more work.</span><br>         766:  <span style="background-color: white">       *</span><br>         767:  <span style="background-color: white">       * Revision 1.53  2004/12/20 23:25:31  tobega</span><br>         768:  <span style="background-color: white">       * Cleaned up handling of absolute boxes and went back to correct use of anonymous boxes in ContentUtil</span><br>         769:  <span style="background-color: white">       *</span><br>         770:  <span style="background-color: white">       * Revision 1.52  2004/12/16 17:22:25  joshy</span><br>         771:  <span style="background-color: white">       * minor code cleanup</span><br>         772:  <span style="background-color: white">       * Issue number:</span><br>         773:  <span style="background-color: white">       * Obtained from:</span><br>         774:  <span style="background-color: white">       * Submitted by:</span><br>         775:  <span style="background-color: white">       * Reviewed by:</span><br>         776:  <span style="background-color: white">       *</span><br>         777:  <span style="background-color: white">       * Revision 1.51  2004/12/16 17:10:41  joshy</span><br>         778:  <span style="background-color: white">       * fixed box bug</span><br>         779:  <span style="background-color: white">       *</span><br>         780:  <span style="background-color: white">       * Issue number:</span><br>         781:  <span style="background-color: white">       * Obtained from:</span><br>         782:  <span style="background-color: white">       * Submitted by:</span><br>         783:  <span style="background-color: white">       * Reviewed by:</span><br>         784:  <span style="background-color: white">       *</span><br>         785:  <span style="background-color: white">       * Revision 1.50  2004/12/16 15:53:08  joshy</span><br>         786:  <span style="background-color: white">       * fixes for absolute layout</span><br>         787:  <span style="background-color: white">       *</span><br>         788:  <span style="background-color: white">       * Issue number:</span><br>         789:  <span style="background-color: white">       * Obtained from:</span><br>         790:  <span style="background-color: white">       * Submitted by:</span><br>         791:  <span style="background-color: white">       * Reviewed by:</span><br>         792:  <span style="background-color: white">       *</span><br>         793:  <span style="background-color: white">       * Revision 1.49  2004/12/14 02:28:47  joshy</span><br>         794:  <span style="background-color: white">       * removed some comments</span><br>         795:  <span style="background-color: white">       * some bugs with the backgrounds still</span><br>         796:  <span style="background-color: white">       *</span><br>         797:  <span style="background-color: white">       * Issue number:</span><br>         798:  <span style="background-color: white">       * Obtained from:</span><br>         799:  <span style="background-color: white">       * Submitted by:</span><br>         800:  <span style="background-color: white">       * Reviewed by:</span><br>         801:  <span style="background-color: white">       *</span><br>         802:  <span style="background-color: white">       * Revision 1.48  2004/12/14 01:56:22  joshy</span><br>         803:  <span style="background-color: white">       * fixed layout width bugs</span><br>         804:  <span style="background-color: white">       * fixed extra border on document bug</span><br>         805:  <span style="background-color: white">       *</span><br>         806:  <span style="background-color: white">       * Issue number:</span><br>         807:  <span style="background-color: white">       * Obtained from:</span><br>         808:  <span style="background-color: white">       * Submitted by:</span><br>         809:  <span style="background-color: white">       * Reviewed by:</span><br>         810:  <span style="background-color: white">       *</span><br>         811:  <span style="background-color: white">       * Revision 1.47  2004/12/13 15:15:56  joshy</span><br>         812:  <span style="background-color: white">       * fixed bug where inlines would pick up parent styles when they aren't supposed to</span><br>         813:  <span style="background-color: white">       * fixed extra Xx's in printed text</span><br>         814:  <span style="background-color: white">       * added conf boolean to turn on box outlines</span><br>         815:  <span style="background-color: white">       *</span><br>         816:  <span style="background-color: white">       * Issue number:</span><br>         817:  <span style="background-color: white">       * Obtained from:</span><br>         818:  <span style="background-color: white">       * Submitted by:</span><br>         819:  <span style="background-color: white">       * Reviewed by:</span><br>         820:  <span style="background-color: white">       *</span><br>         821:  <span style="background-color: white">       * Revision 1.46  2004/12/13 01:29:40  tobega</span><br>         822:  <span style="background-color: white">       * Got the scrollbars back (by accident), and now we should be able to display DocumentFragments as well as Documents, if someone finds that useful.</span><br>         823:  <span style="background-color: white">       *</span><br>         824:  <span style="background-color: white">       * Revision 1.45  2004/12/12 18:06:51  tobega</span><br>         825:  <span style="background-color: white">       * Made simple layout (inline and box) a bit easier to understand</span><br>         826:  <span style="background-color: white">       *</span><br>         827:  <span style="background-color: white">       * Revision 1.44  2004/12/12 05:51:48  tobega</span><br>         828:  <span style="background-color: white">       * Now things run. But there is a lot to do before it looks as nice as it did. At least we now have :before and :after content and handling of breaks by css.</span><br>         829:  <span style="background-color: white">       *</span><br>         830:  <span style="background-color: white">       * Revision 1.43  2004/12/12 04:18:56  tobega</span><br>         831:  <span style="background-color: white">       * Now the core compiles at least. Now we must make it work right. Table layout is one point that really needs to be looked over</span><br>         832:  <span style="background-color: white">       *</span><br>         833:  <span style="background-color: white">       * Revision 1.42  2004/12/12 03:32:58  tobega</span><br>         834:  <span style="background-color: white">       * Renamed x and u to avoid confusing IDE. But that got cvs in a twist. See if this does it</span><br>         835:  <span style="background-color: white">       *</span><br>         836:  <span style="background-color: white">       * Revision 1.41  2004/12/12 03:04:31  tobega</span><br>         837:  <span style="background-color: white">       * Making progress</span><br>         838:  <span style="background-color: white">       *</span><br>         839:  <span style="background-color: white">       * Revision 1.40  2004/12/11 23:36:48  tobega</span><br>         840:  <span style="background-color: white">       * Progressing on cleaning up layout and boxes. Still broken, won't even compile at the moment. Working hard to fix it, though.</span><br>         841:  <span style="background-color: white">       *</span><br>         842:  <span style="background-color: white">       * Revision 1.39  2004/12/11 21:14:48  tobega</span><br>         843:  <span style="background-color: white">       * Prepared for handling run-in content (OK, I know, a side-track). Still broken, won't even compile at the moment. Working hard to fix it, though.</span><br>         844:  <span style="background-color: white">       *</span><br>         845:  <span style="background-color: white">       * Revision 1.38  2004/12/11 18:18:10  tobega</span><br>         846:  <span style="background-color: white">       * Still broken, won't even compile at the moment. Working hard to fix it, though. Replace the StyleReference interface with our only concrete implementation, it was a bother changing in two places all the time.</span><br>         847:  <span style="background-color: white">       *</span><br>         848:  <span style="background-color: white">       * Revision 1.37  2004/12/10 06:51:02  tobega</span><br>         849:  <span style="background-color: white">       * Shamefully, I must now check in painfully broken code. Good news is that Layout is much nicer, and we also handle :before and :after, and do :first-line better than before. Table stuff must be brought into line, but most needed is to fix Render. IMO Render should work with Boxes and Content. If Render goes for a node, that is wrong.</span><br>         850:  <span style="background-color: white">       *</span><br>         851:  <span style="background-color: white">       * Revision 1.36  2004/12/09 21:18:52  tobega</span><br>         852:  <span style="background-color: white">       * precaution: code still works</span><br>         853:  <span style="background-color: white">       *</span><br>         854:  <span style="background-color: white">       * Revision 1.35  2004/12/09 00:11:51  tobega</span><br>         855:  <span style="background-color: white">       * Almost ready for Content-based inline generation.</span><br>         856:  <span style="background-color: white">       *</span><br>         857:  <span style="background-color: white">       * Revision 1.34  2004/12/08 00:42:34  tobega</span><br>         858:  <span style="background-color: white">       * More cleaning of use of Node, more preparation for Content-based inline generation. Also fixed 2 irritating bugs!</span><br>         859:  <span style="background-color: white">       *</span><br>         860:  <span style="background-color: white">       * Revision 1.33  2004/12/06 23:41:14  tobega</span><br>         861:  <span style="background-color: white">       * More cleaning of use of Node, more preparation for Content-based inline generation.</span><br>         862:  <span style="background-color: white">       *</span><br>         863:  <span style="background-color: white">       * Revision 1.32  2004/12/05 05:00:39  joshy</span><br>         864:  <span style="background-color: white">       * fixed bug that prevented explict box heights from working.</span><br>         865:  <span style="background-color: white">       *</span><br>         866:  <span style="background-color: white">       *</span><br>         867:  <span style="background-color: white">       * Issue number:</span><br>         868:  <span style="background-color: white">       * Obtained from:</span><br>         869:  <span style="background-color: white">       * Submitted by:</span><br>         870:  <span style="background-color: white">       * Reviewed by:</span><br>         871:  <span style="background-color: white">       *</span><br>         872:  <span style="background-color: white">       * Revision 1.31  2004/12/05 00:48:57  tobega</span><br>         873:  <span style="background-color: white">       * Cleaned up so that now all property-lookups use the CalculatedStyle. Also added support for relative values of top, left, width, etc.</span><br>         874:  <span style="background-color: white">       *</span><br>         875:  <span style="background-color: white">       * Revision 1.30  2004/12/01 01:57:00  joshy</span><br>         876:  <span style="background-color: white">       * more updates for float support.</span><br>         877:  <span style="background-color: white">       *</span><br>         878:  <span style="background-color: white">       * Issue number:</span><br>         879:  <span style="background-color: white">       * Obtained from:</span><br>         880:  <span style="background-color: white">       * Submitted by:</span><br>         881:  <span style="background-color: white">       * Reviewed by:</span><br>         882:  <span style="background-color: white">       *</span><br>         883:  <span style="background-color: white">       * Revision 1.29  2004/11/30 20:38:49  joshy</span><br>         884:  <span style="background-color: white">       * cleaned up the float and absolute interfaces a bit</span><br>         885:  <span style="background-color: white">       *</span><br>         886:  <span style="background-color: white">       * Issue number:</span><br>         887:  <span style="background-color: white">       * Obtained from:</span><br>         888:  <span style="background-color: white">       * Submitted by:</span><br>         889:  <span style="background-color: white">       * Reviewed by:</span><br>         890:  <span style="background-color: white">       *</span><br>         891:  <span style="background-color: white">       * Revision 1.28  2004/11/30 20:28:27  joshy</span><br>         892:  <span style="background-color: white">       * support for multiple floats on a single line.</span><br>         893:  <span style="background-color: white">       *</span><br>         894:  <span style="background-color: white">       *</span><br>         895:  <span style="background-color: white">       * Issue number:</span><br>         896:  <span style="background-color: white">       * Obtained from:</span><br>         897:  <span style="background-color: white">       * Submitted by:</span><br>         898:  <span style="background-color: white">       * Reviewed by:</span><br>         899:  <span style="background-color: white">       *</span><br>         900:  <span style="background-color: white">       * Revision 1.27  2004/11/27 15:46:38  joshy</span><br>         901:  <span style="background-color: white">       * lots of cleanup to make the code clearer</span><br>         902:  <span style="background-color: white">       *</span><br>         903:  <span style="background-color: white">       * Issue number:</span><br>         904:  <span style="background-color: white">       * Obtained from:</span><br>         905:  <span style="background-color: white">       * Submitted by:</span><br>         906:  <span style="background-color: white">       * Reviewed by:</span><br>         907:  <span style="background-color: white">       *</span><br>         908:  <span style="background-color: white">       * Revision 1.26  2004/11/18 19:10:04  joshy</span><br>         909:  <span style="background-color: white">       * added bottom support to absolute positioning</span><br>         910:  <span style="background-color: white">       *</span><br>         911:  <span style="background-color: white">       *</span><br>         912:  <span style="background-color: white">       * Issue number:</span><br>         913:  <span style="background-color: white">       * Obtained from:</span><br>         914:  <span style="background-color: white">       * Submitted by:</span><br>         915:  <span style="background-color: white">       * Reviewed by:</span><br>         916:  <span style="background-color: white">       *</span><br>         917:  <span style="background-color: white">       * Revision 1.25  2004/11/18 18:49:48  joshy</span><br>         918:  <span style="background-color: white">       * fixed the float issue.</span><br>         919:  <span style="background-color: white">       * commented out more dead code</span><br>         920:  <span style="background-color: white">       *</span><br>         921:  <span style="background-color: white">       * Issue number:</span><br>         922:  <span style="background-color: white">       * Obtained from:</span><br>         923:  <span style="background-color: white">       * Submitted by:</span><br>         924:  <span style="background-color: white">       * Reviewed by:</span><br>         925:  <span style="background-color: white">       *</span><br>         926:  <span style="background-color: white">       * Revision 1.24  2004/11/18 14:26:22  joshy</span><br>         927:  <span style="background-color: white">       * more code cleanup</span><br>         928:  <span style="background-color: white">       *</span><br>         929:  <span style="background-color: white">       *</span><br>         930:  <span style="background-color: white">       * Issue number:</span><br>         931:  <span style="background-color: white">       * Obtained from:</span><br>         932:  <span style="background-color: white">       * Submitted by:</span><br>         933:  <span style="background-color: white">       * Reviewed by:</span><br>         934:  <span style="background-color: white">       *</span><br>         935:  <span style="background-color: white">       * Revision 1.23  2004/11/18 02:51:14  joshy</span><br>         936:  <span style="background-color: white">       * moved more code out of the box into custom classes</span><br>         937:  <span style="background-color: white">       * added more preload logic to the default layout's preparebox method</span><br>         938:  <span style="background-color: white">       * Issue number:</span><br>         939:  <span style="background-color: white">       * Obtained from:</span><br>         940:  <span style="background-color: white">       * Submitted by:</span><br>         941:  <span style="background-color: white">       * Reviewed by:</span><br>         942:  <span style="background-color: white">       *</span><br>         943:  <span style="background-color: white">       * Revision 1.21  2004/11/16 07:25:09  tobega</span><br>         944:  <span style="background-color: white">       * Renamed HTMLPanel to BasicPanel</span><br>         945:  <span style="background-color: white">       *</span><br>         946:  <span style="background-color: white">       * Revision 1.20  2004/11/15 15:20:38  joshy</span><br>         947:  <span style="background-color: white">       * fixes for absolute layout</span><br>         948:  <span style="background-color: white">       *</span><br>         949:  <span style="background-color: white">       * Issue number:</span><br>         950:  <span style="background-color: white">       * Obtained from:</span><br>         951:  <span style="background-color: white">       * Submitted by:</span><br>         952:  <span style="background-color: white">       * Reviewed by:</span><br>         953:  <span style="background-color: white">       *</span><br>         954:  <span style="background-color: white">       * Revision 1.19  2004/11/14 16:40:58  joshy</span><br>         955:  <span style="background-color: white">       * refactored layout factory</span><br>         956:  <span style="background-color: white">       *</span><br>         957:  <span style="background-color: white">       * Issue number:</span><br>         958:  <span style="background-color: white">       * Obtained from:</span><br>         959:  <span style="background-color: white">       * Submitted by:</span><br>         960:  <span style="background-color: white">       * Reviewed by:</span><br>         961:  <span style="background-color: white">       *</span><br>         962:  <span style="background-color: white">       * Revision 1.18  2004/11/12 18:51:00  joshy</span><br>         963:  <span style="background-color: white">       * fixed repainting issue for background-attachment: fixed</span><br>         964:  <span style="background-color: white">       * added static util methods and get minimum size to graphics 2d renderer</span><br>         965:  <span style="background-color: white">       * added test for graphics 2d renderer</span><br>         966:  <span style="background-color: white">       *</span><br>         967:  <span style="background-color: white">       * Issue number:</span><br>         968:  <span style="background-color: white">       * Obtained from:</span><br>         969:  <span style="background-color: white">       * Submitted by:</span><br>         970:  <span style="background-color: white">       * Reviewed by:</span><br>         971:  <span style="background-color: white">       *</span><br>         972:  <span style="background-color: white">       * Revision 1.17  2004/11/12 17:05:24  joshy</span><br>         973:  <span style="background-color: white">       * support for fixed positioning</span><br>         974:  <span style="background-color: white">       * Issue number:</span><br>         975:  <span style="background-color: white">       * Obtained from:</span><br>         976:  <span style="background-color: white">       * Submitted by:</span><br>         977:  <span style="background-color: white">       * Reviewed by:</span><br>         978:  <span style="background-color: white">       *</span><br>         979:  <span style="background-color: white">       * Revision 1.16  2004/11/09 15:53:48  joshy</span><br>         980:  <span style="background-color: white">       * initial support for hover (currently disabled)</span><br>         981:  <span style="background-color: white">       * moved justification code into it's own class in a new subpackage for inline</span><br>         982:  <span style="background-color: white">       * layout (because it's so blooming complicated)</span><br>         983:  <span style="background-color: white">       *</span><br>         984:  <span style="background-color: white">       * Issue number:</span><br>         985:  <span style="background-color: white">       * Obtained from:</span><br>         986:  <span style="background-color: white">       * Submitted by:</span><br>         987:  <span style="background-color: white">       * Reviewed by:</span><br>         988:  <span style="background-color: white">       *</span><br>         989:  <span style="background-color: white">       * Revision 1.15  2004/11/08 20:50:58  joshy</span><br>         990:  <span style="background-color: white">       * improved float support</span><br>         991:  <span style="background-color: white">       *</span><br>         992:  <span style="background-color: white">       * Issue number:</span><br>         993:  <span style="background-color: white">       * Obtained from:</span><br>         994:  <span style="background-color: white">       * Submitted by:</span><br>         995:  <span style="background-color: white">       * Reviewed by:</span><br>         996:  <span style="background-color: white">       *</span><br>         997:  <span style="background-color: white">       * Revision 1.14  2004/11/08 15:10:10  joshy</span><br>         998:  <span style="background-color: white">       * added support for styling :first-letter inline boxes</span><br>         999:  <span style="background-color: white">       * updated the absolute positioning tests</span><br>        1000:  <span style="background-color: white">       *</span><br>        1001:  <span style="background-color: white">       * Issue number:</span><br>        1002:  <span style="background-color: white">       * Obtained from:</span><br>        1003:  <span style="background-color: white">       * Submitted by:</span><br>        1004:  <span style="background-color: white">       * Reviewed by:</span><br>        1005:  <span style="background-color: white">       *</span><br>        1006:  <span style="background-color: white">       * Revision 1.13  2004/11/07 13:39:17  joshy</span><br>        1007:  <span style="background-color: white">       * fixed missing borders on the table</span><br>        1008:  <span style="background-color: white">       * changed td and th to display:table-cell</span><br>        1009:  <span style="background-color: white">       * updated isBlockLayout() code to fix double border problem with tables</span><br>        1010:  <span style="background-color: white">       *</span><br>        1011:  <span style="background-color: white">       * -j</span><br>        1012:  <span style="background-color: white">       *</span><br>        1013:  <span style="background-color: white">       *</span><br>        1014:  <span style="background-color: white">       * Issue number:</span><br>        1015:  <span style="background-color: white">       * Obtained from:</span><br>        1016:  <span style="background-color: white">       * Submitted by:</span><br>        1017:  <span style="background-color: white">       * Reviewed by:</span><br>        1018:  <span style="background-color: white">       *</span><br>        1019:  <span style="background-color: white">       * Revision 1.12  2004/11/06 22:49:51  joshy</span><br>        1020:  <span style="background-color: white">       * cleaned up alice</span><br>        1021:  <span style="background-color: white">       * initial support for inline borders and backgrounds</span><br>        1022:  <span style="background-color: white">       * moved all of inlinepainter back into inlinerenderer, where it belongs.</span><br>        1023:  <span style="background-color: white">       *</span><br>        1024:  <span style="background-color: white">       *</span><br>        1025:  <span style="background-color: white">       *</span><br>        1026:  <span style="background-color: white">       * Issue number:</span><br>        1027:  <span style="background-color: white">       * Obtained from:</span><br>        1028:  <span style="background-color: white">       * Submitted by:</span><br>        1029:  <span style="background-color: white">       * Reviewed by:</span><br>        1030:  <span style="background-color: white">       *</span><br>        1031:  <span style="background-color: white">       * Revision 1.11  2004/11/05 18:45:14  joshy</span><br>        1032:  <span style="background-color: white">       * support for floated blocks (not just inline blocks)</span><br>        1033:  <span style="background-color: white">       *</span><br>        1034:  <span style="background-color: white">       * Issue number:</span><br>        1035:  <span style="background-color: white">       * Obtained from:</span><br>        1036:  <span style="background-color: white">       * Submitted by:</span><br>        1037:  <span style="background-color: white">       * Reviewed by:</span><br>        1038:  <span style="background-color: white">       *</span><br>        1039:  <span style="background-color: white">       * Revision 1.10  2004/11/04 15:35:44  joshy</span><br>        1040:  <span style="background-color: white">       * initial float support</span><br>        1041:  <span style="background-color: white">       * includes right and left float</span><br>        1042:  <span style="background-color: white">       * cannot have more than one float per line per side</span><br>        1043:  <span style="background-color: white">       * floats do not extend beyond enclosing block</span><br>        1044:  <span style="background-color: white">       *</span><br>        1045:  <span style="background-color: white">       * Issue number:</span><br>        1046:  <span style="background-color: white">       * Obtained from:</span><br>        1047:  <span style="background-color: white">       * Submitted by:</span><br>        1048:  <span style="background-color: white">       * Reviewed by:</span><br>        1049:  <span style="background-color: white">       *</span><br>        1050:  <span style="background-color: white">       * Revision 1.9  2004/11/03 23:54:33  joshy</span><br>        1051:  <span style="background-color: white">       * added hamlet and tables to the browser</span><br>        1052:  <span style="background-color: white">       * more support for absolute layout</span><br>        1053:  <span style="background-color: white">       * added absolute layout unit tests</span><br>        1054:  <span style="background-color: white">       * removed more dead code and moved code into layout factory</span><br>        1055:  <span style="background-color: white">       *</span><br>        1056:  <span style="background-color: white">       *</span><br>        1057:  <span style="background-color: white">       * Issue number:</span><br>        1058:  <span style="background-color: white">       * Obtained from:</span><br>        1059:  <span style="background-color: white">       * Submitted by:</span><br>        1060:  <span style="background-color: white">       * Reviewed by:</span><br>        1061:  <span style="background-color: white">       *</span><br>        1062:  <span style="background-color: white">       * Revision 1.8  2004/11/03 15:17:04  joshy</span><br>        1063:  <span style="background-color: white">       * added intial support for absolute positioning</span><br>        1064:  <span style="background-color: white">       *</span><br>        1065:  <span style="background-color: white">       * Issue number:</span><br>        1066:  <span style="background-color: white">       * Obtained from:</span><br>        1067:  <span style="background-color: white">       * Submitted by:</span><br>        1068:  <span style="background-color: white">       * Reviewed by:</span><br>        1069:  <span style="background-color: white">       *</span><br>        1070:  <span style="background-color: white">       * Revision 1.7  2004/10/28 02:13:40  joshy</span><br>        1071:  <span style="background-color: white">       * finished moving the painting code into the renderers</span><br>        1072:  <span style="background-color: white">       *</span><br>        1073:  <span style="background-color: white">       * Issue number:</span><br>        1074:  <span style="background-color: white">       * Obtained from:</span><br>        1075:  <span style="background-color: white">       * Submitted by:</span><br>        1076:  <span style="background-color: white">       * Reviewed by:</span><br>        1077:  <span style="background-color: white">       *</span><br>        1078:  <span style="background-color: white">       * Revision 1.6  2004/10/28 01:34:23  joshy</span><br>        1079:  <span style="background-color: white">       * moved more painting code into the renderers</span><br>        1080:  <span style="background-color: white">       *</span><br>        1081:  <span style="background-color: white">       * Issue number:</span><br>        1082:  <span style="background-color: white">       * Obtained from:</span><br>        1083:  <span style="background-color: white">       * Submitted by:</span><br>        1084:  <span style="background-color: white">       * Reviewed by:</span><br>        1085:  <span style="background-color: white">       *</span><br>        1086:  <span style="background-color: white">       * Revision 1.5  2004/10/26 00:13:14  joshy</span><br>        1087:  <span style="background-color: white">       * added threaded layout support to the BasicPanel</span><br>        1088:  <span style="background-color: white">       *</span><br>        1089:  <span style="background-color: white">       *</span><br>        1090:  <span style="background-color: white">       * Issue number:</span><br>        1091:  <span style="background-color: white">       * Obtained from:</span><br>        1092:  <span style="background-color: white">       * Submitted by:</span><br>        1093:  <span style="background-color: white">       * Reviewed by:</span><br>        1094:  <span style="background-color: white">       *</span><br>        1095:  <span style="background-color: white">       * Revision 1.4  2004/10/23 13:46:46  pdoubleya</span><br>        1096:  <span style="background-color: white">       * Re-formatted using JavaStyle tool.</span><br>        1097:  <span style="background-color: white">       * Cleaned imports to resolve wildcards except for common packages (java.io, java.util, etc).</span><br>        1098:  <span style="background-color: white">       * Added CVS log comments at bottom.</span><br>        1099:  <span style="background-color: white">       *</span><br>        1100:  <span style="background-color: white">       *</span><br>        1101:  <span style="background-color: white">       */</span><br>        1102:  <span style="background-color: white">      </span><br></pre> </code> 
   </div> 
   <div class="column"> 
    <h2>Patched Code:</h2> <code> <pre id="patched-trace">        1-&gt;N:  <span style="background-color: white">      /*</span><br>        2-&gt;N:  <span style="background-color: white">       * {{{ header &amp; license</span><br>        3-&gt;N:  <span style="background-color: white">       * Copyright (c) 2004, 2005 Joshua Marinacci, Torbjoern Gannholm</span><br>        4-&gt;N:  <span style="background-color: white">       * Copyright (c) 2005 Wisconsin Court System</span><br>        5-&gt;N:  <span style="background-color: white">       *</span><br>        6-&gt;N:  <span style="background-color: white">       * This program is free software; you can redistribute it and/or</span><br>        7-&gt;N:  <span style="background-color: white">       * modify it under the terms of the GNU Lesser General Public License</span><br>        8-&gt;N:  <span style="background-color: white">       * as published by the Free Software Foundation; either version 2.1</span><br>        9-&gt;N:  <span style="background-color: white">       * of the License, or (at your option) any later version.</span><br>       10-&gt;N:  <span style="background-color: white">       *</span><br>       11-&gt;N:  <span style="background-color: white">       * This program is distributed in the hope that it will be useful,</span><br>       12-&gt;N:  <span style="background-color: white">       * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br>       13-&gt;N:  <span style="background-color: white">       * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the</span><br>       14-&gt;N:  <span style="background-color: white">       * GNU Lesser General Public License for more details.</span><br>       15-&gt;N:  <span style="background-color: white">       *</span><br>       16-&gt;N:  <span style="background-color: white">       * You should have received a copy of the GNU Lesser General Public License</span><br>       17-&gt;N:  <span style="background-color: white">       * along with this program; if not, write to the Free Software</span><br>       18-&gt;N:  <span style="background-color: white">       * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span><br>       19-&gt;N:  <span style="background-color: white">       * }}}</span><br>       20-&gt;N:  <span style="background-color: white">       */</span><br>       21-&gt;N:  <span style="background-color: white">      package com.openhtmltopdf.layout;</span><br>       22-&gt;N:  <span style="background-color: white">      </span><br>       23-&gt;N:  <span style="background-color: white">      import java.awt.Dimension;</span><br>       24-&gt;N:  <span style="background-color: white">      import java.util.List;</span><br>       25-&gt;N:  <span style="background-color: white">      import java.util.TreeSet;</span><br>       26-&gt;N:  <span style="background-color: white">      </span><br>       27-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.CSSName;</span><br>       28-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.IdentValue;</span><br>       29-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.LayoutContext.BlockBoxingState;</span><br>       30-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.BlockBox;</span><br>       31-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.Box;</span><br>       32-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.LineBox;</span><br>       33-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.PageBox;</span><br>       34-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.BlockBox.ContentType;</span><br>       35-&gt;N:  <span style="background-color: white">      </span><br>       36-&gt;N:  <span style="background-color: white">      /**</span><br>       37-&gt;N:  <span style="background-color: white">       * Utility class for laying block content.  It is called when a block box</span><br>       38-&gt;N:  <span style="background-color: white">       * contains block level content.  {@link BoxBuilder} will have made sure that</span><br>       39-&gt;N:  <span style="background-color: white">       * the block we're working on will either contain only inline or block content.</span><br>       40-&gt;N:  <span style="background-color: white">       * If we're in a paged media environment, the various page break related</span><br>       41-&gt;N:  <span style="background-color: white">       * properties are also handled here.  If a rule is violated, the affected run</span><br>       42-&gt;N:  <span style="background-color: white">       * of boxes will be layed out again.  If the rule still cannot be satisfied,</span><br>       43-&gt;N:  <span style="background-color: white">       * the rule will be dropped.</span><br>       44-&gt;N:  <span style="background-color: white">       * <br><br></span><br>       45-&gt;N:  <span style="background-color: white">       * IMPORTANT: This is quite hard to get right without causing an explosion of layouts</span><br>       46-&gt;N:  <span style="background-color: white">       * caused by re-attempts to satisfy page-break-inside: avoid in deeply nested content.</span><br>       47-&gt;N:  <span style="background-color: white">       * Please be careful when editing these functions.</span><br>       48-&gt;N:  <span style="background-color: white">       */</span><br>       49-&gt;N:  <span style="background-color: white">      public class BlockBoxing {</span><br>      50-&gt;46:  <span style="background-color: white">          private static final int NO_PAGE_TRIM = -1;</span><br>       51-&gt;N:  <span style="background-color: white">      </span><br>       52-&gt;N:  <span style="background-color: white">          private BlockBoxing() {</span><br>       53-&gt;N:  <span style="background-color: white">          }</span><br>       54-&gt;N:  <span style="background-color: white">      </span><br>       55-&gt;N:  <span style="background-color: white">          /**</span><br>       56-&gt;N:  <span style="background-color: white">           * Lays out a {@link BlockBox} where {@link BlockBox#getChildrenContentType()} is</span><br>       57-&gt;N:  <span style="background-color: white">           * {@link ContentType#BLOCK}.</span><br>       58-&gt;N:  <span style="background-color: white">           */</span><br>      59-&gt;51:  <span style="background-color: cyan">          public static void layoutContent(LayoutContext c, BlockBox block, int contentStart) {</span><br>      60-&gt;54:  <span style="background-color: cyan">              List
       <box>
         localChildren = block.getChildren();
       </box></span><br>       61-&gt;U:  <span style="background-color: yellow">              int size = localChildren.size();</span><br>       62-&gt;N:  <span style="background-color: white">      </span><br>      63-&gt;59:  <span style="background-color: cyan">              int childOffset = block.getHeight() + contentStart;</span><br>       64-&gt;N:  <span style="background-color: white">      </span><br>       65-&gt;U:  <span style="background-color: yellow">              AbstractRelayoutDataList relayoutDataList = null;</span><br>       66-&gt;U:  <span style="background-color: yellow">              BlockBoxingState enterState = c.getBlockBoxingState();</span><br>       67-&gt;N:  <span style="background-color: white">      </span><br>      68-&gt;62:  <span style="background-color: cyan">              if (c.isPrint()) {</span><br>       69-&gt;U:  <span style="background-color: yellow">                  relayoutDataList = new LiteRelayoutDataList(size);</span><br>       70-&gt;N:  <span style="background-color: white">              }</span><br>       71-&gt;N:  <span style="background-color: white">      </span><br>      72-&gt;66:  <span style="background-color: cyan">              int pageCount = NO_PAGE_TRIM;</span><br>       73-&gt;N:  <span style="background-color: white">      </span><br>      74-&gt;67:  <span style="background-color: cyan">              BlockBox previousChildBox = null;</span><br>       75-&gt;U:  <span style="background-color: yellow">              boolean oneChildFailed = false;</span><br>       76-&gt;N:  <span style="background-color: white">      </span><br>       77-&gt;U:  <span style="background-color: yellow">              for (int offset = 0; offset &lt; size; offset++) {</span><br>       78-&gt;U:  <span style="background-color: yellow">                  BlockBox child = (BlockBox) localChildren.get(offset);</span><br>       79-&gt;U:  <span style="background-color: yellow">                  LayoutState savedChildLayoutState = null;</span><br>       80-&gt;U:  <span style="background-color: yellow">                  boolean rootPageBreakInsideAvoid = false;</span><br>       81-&gt;N:  <span style="background-color: white">      </span><br>      82-&gt;75:  <span style="background-color: cyan">                  if (c.isPrint()) {</span><br>       83-&gt;U:  <span style="background-color: yellow">                      savedChildLayoutState = c.copyStateForRelayout();</span><br>       84-&gt;N:  <span style="background-color: white">      </span><br>       85-&gt;U:  <span style="background-color: yellow">                      relayoutDataList.setLayoutState(offset, savedChildLayoutState);</span><br>       86-&gt;U:  <span style="background-color: yellow">                      relayoutDataList.setChildOffset(offset, childOffset);</span><br>       87-&gt;N:  <span style="background-color: white">      </span><br>      88-&gt;79:  <span style="background-color: cyan">                      pageCount = c.getRootLayer().getPages().size();</span><br>       89-&gt;N:  <span style="background-color: white">      </span><br>      90-&gt;81:  <span style="background-color: cyan">                      child.setNeedPageClear(false);</span><br>       91-&gt;N:  <span style="background-color: white">      </span><br>      92-&gt;83:  <span style="background-color: cyan">                      if ((child.getStyle().isAvoidPageBreakInside() ||</span><br>      93-&gt;83:  <span style="background-color: red">                           child.getStyle().isKeepWithInline()) &amp;&amp;</span><br>       94-&gt;U:  <span style="background-color: yellow">                          c.getBlockBoxingState() == BlockBoxingState.NOT_SET) {</span><br>       95-&gt;U:  <span style="background-color: yellow">                          rootPageBreakInsideAvoid = true;</span><br>       96-&gt;N:  <span style="background-color: white">                      }</span><br>       97-&gt;N:  <span style="background-color: white">                  }</span><br>       98-&gt;N:  <span style="background-color: white">      </span><br>       99-&gt;U:  <span style="background-color: yellow">                  if (rootPageBreakInsideAvoid) {</span><br>      100-&gt;U:  <span style="background-color: yellow">                      c.setBlockBoxingState(BlockBoxingState.ALLOW);</span><br>      101-&gt;U:  <span style="background-color: yellow">                  } else {</span><br>      102-&gt;U:  <span style="background-color: yellow">                      c.setBlockBoxingState(enterState);</span><br>      103-&gt;U:  <span style="background-color: yellow">                  }</span><br>      104-&gt;N:  <span style="background-color: white">      </span><br>      105-&gt;N:  <span style="background-color: white">                  // Our first try at layout with no page clear beforehand.</span><br>      106-&gt;N:  <span style="background-color: white">                  layoutBlockChild(</span><br>      107-&gt;U:  <span style="background-color: yellow">                          c, block, child, false, childOffset, NO_PAGE_TRIM, savedChildLayoutState);</span><br>      108-&gt;N:  <span style="background-color: white">      </span><br>     109-&gt;94:  <span style="background-color: cyan">                  if (c.isPrint()) {</span><br>     110-&gt;95:  <span style="background-color: cyan">                      boolean needPageClear = child.isNeedPageClear();</span><br>      111-&gt;N:  <span style="background-color: white">      </span><br>      112-&gt;U:  <span style="background-color: yellow">                      if (needPageClear || c.getBlockBoxingState() == BlockBoxingState.ALLOW) {</span><br>      113-&gt;U:  <span style="background-color: yellow">                          boolean pageBreak = child.crossesPageBreak(c);</span><br>      114-&gt;U:  <span style="background-color: yellow">                          boolean pageBreakAfterRetry = pageBreak;</span><br>      115-&gt;U:  <span style="background-color: yellow">                          boolean tryToAvoidPageBreak = pageBreak &amp;&amp; child.getStyle().isAvoidPageBreakInside();</span><br>     116-&gt;99:  <span style="background-color: cyan">                          boolean keepWithInline = child.isNeedsKeepWithInline(c);</span><br>      117-&gt;N:  <span style="background-color: white">      </span><br>    118-&gt;100:  <span style="background-color: cyan">                          if (tryToAvoidPageBreak || needPageClear || keepWithInline) {</span><br>      119-&gt;U:  <span style="background-color: yellow">                              c.restoreStateForRelayout(savedChildLayoutState);</span><br>    120-&gt;102:  <span style="background-color: cyan">                              child.reset(c);</span><br>      121-&gt;N:  <span style="background-color: white">      </span><br>      122-&gt;U:  <span style="background-color: yellow">                              c.setBlockBoxingState(BlockBoxingState.DENY);</span><br>      123-&gt;N:  <span style="background-color: white">                              // Our second attempt with page clear beforehand.</span><br>      124-&gt;N:  <span style="background-color: white">                              layoutBlockChild(</span><br>      125-&gt;U:  <span style="background-color: yellow">                                      c, block, child, true, childOffset, pageCount, savedChildLayoutState);</span><br>      126-&gt;U:  <span style="background-color: yellow">                              c.setBlockBoxingState(enterState);</span><br>      127-&gt;N:  <span style="background-color: white">      </span><br>      128-&gt;U:  <span style="background-color: yellow">                              pageBreakAfterRetry = child.crossesPageBreak(c);</span><br>      129-&gt;N:  <span style="background-color: white">      </span><br>      130-&gt;U:  <span style="background-color: yellow">                              if (tryToAvoidPageBreak &amp;&amp; pageBreakAfterRetry &amp;&amp; ! keepWithInline) {</span><br>      131-&gt;U:  <span style="background-color: yellow">                                  c.restoreStateForRelayout(savedChildLayoutState);</span><br>    132-&gt;108:  <span style="background-color: red">                                  child.reset(c);</span><br>      133-&gt;N:  <span style="background-color: white">      </span><br>      134-&gt;U:  <span style="background-color: yellow">                                  c.setBlockBoxingState(BlockBoxingState.ALLOW);</span><br>      135-&gt;N:  <span style="background-color: white">                                  // Our second attempt failed, so reset with no page break beforehand.</span><br>      136-&gt;N:  <span style="background-color: white">                                  layoutBlockChild(</span><br>      137-&gt;U:  <span style="background-color: yellow">                                          c, block, child, false, childOffset, pageCount, savedChildLayoutState);</span><br>      138-&gt;N:  <span style="background-color: white">                              }</span><br>      139-&gt;N:  <span style="background-color: white">      </span><br>      140-&gt;U:  <span style="background-color: yellow">                              if (pageBreakAfterRetry) {</span><br>      141-&gt;U:  <span style="background-color: yellow">                                  oneChildFailed = true;</span><br>      142-&gt;U:  <span style="background-color: yellow">                              }</span><br>      143-&gt;N:  <span style="background-color: white">      </span><br>      144-&gt;N:  <span style="background-color: white">                          }</span><br>      145-&gt;N:  <span style="background-color: white">                      }</span><br>      146-&gt;N:  <span style="background-color: white">      </span><br>    147-&gt;114:  <span style="background-color: cyan">                      c.getRootLayer().ensureHasPage(c, child);</span><br>      148-&gt;N:  <span style="background-color: white">                  }</span><br>      149-&gt;N:  <span style="background-color: white">      </span><br>    150-&gt;117:  <span style="background-color: cyan">                  Dimension relativeOffset = child.getRelativeOffset();</span><br>    151-&gt;118:  <span style="background-color: cyan">                  if (relativeOffset == null) {</span><br>    152-&gt;119:  <span style="background-color: cyan">                      childOffset = child.getY() + child.getHeight();</span><br>      153-&gt;N:  <span style="background-color: white">                  } else {</span><br>      154-&gt;N:  <span style="background-color: white">                      // Box will have been positioned by this point so calculate</span><br>      155-&gt;N:  <span style="background-color: white">                      // relative to where it would have been if it hadn't been</span><br>      156-&gt;N:  <span style="background-color: white">                      // moved</span><br>    157-&gt;124:  <span style="background-color: cyan">                      childOffset = child.getY() - relativeOffset.height + child.getHeight();</span><br>      158-&gt;N:  <span style="background-color: white">                  }</span><br>      159-&gt;N:  <span style="background-color: white">      </span><br>    160-&gt;127:  <span style="background-color: cyan">                  if (childOffset &gt; block.getHeight()) {</span><br>    161-&gt;128:  <span style="background-color: cyan">                      block.setHeight(childOffset);</span><br>      162-&gt;N:  <span style="background-color: white">                  }</span><br>      163-&gt;N:  <span style="background-color: white">      </span><br>    164-&gt;131:  <span style="background-color: cyan">                  if (c.isPrint()) {</span><br>    165-&gt;132:  <span style="background-color: cyan">                      if (child.getStyle().isForcePageBreakAfter()) {</span><br>    166-&gt;133:  <span style="background-color: white">                          block.forcePageBreakAfter(c, child.getStyle().getIdent(CSSName.PAGE_BREAK_AFTER));</span><br>    167-&gt;134:  <span style="background-color: white">                          childOffset = block.getHeight();</span><br>      168-&gt;N:  <span style="background-color: white">                      }</span><br>      169-&gt;N:  <span style="background-color: white">      </span><br>    170-&gt;137:  <span style="background-color: cyan">                      if (previousChildBox != null) {</span><br>      171-&gt;U:  <span style="background-color: yellow">                          relayoutDataList.configureRun(offset, previousChildBox, child);</span><br>      172-&gt;N:  <span style="background-color: white">                      }</span><br>      173-&gt;N:  <span style="background-color: white">      </span><br>      174-&gt;U:  <span style="background-color: yellow">                      Integer newChildOffset =</span><br>      175-&gt;U:  <span style="background-color: yellow">                           processPageBreakAvoidRun(</span><br>      176-&gt;U:  <span style="background-color: yellow">                              c, block, localChildren, offset, relayoutDataList, child);</span><br>      177-&gt;N:  <span style="background-color: white">      </span><br>      178-&gt;U:  <span style="background-color: yellow">                      if (newChildOffset != null) {</span><br>      179-&gt;U:  <span style="background-color: yellow">                          childOffset = newChildOffset;</span><br>    180-&gt;146:  <span style="background-color: white">                          if (childOffset &gt; block.getHeight()) {</span><br>    181-&gt;147:  <span style="background-color: white">                              block.setHeight(childOffset);</span><br>      182-&gt;N:  <span style="background-color: white">                          }</span><br>      183-&gt;N:  <span style="background-color: white">                      }</span><br>      184-&gt;N:  <span style="background-color: white">                  }</span><br>      185-&gt;N:  <span style="background-color: white">      </span><br>    186-&gt;152:  <span style="background-color: cyan">                  previousChildBox = child;</span><br>      187-&gt;N:  <span style="background-color: white">      </span><br>      188-&gt;U:  <span style="background-color: yellow">                  if (rootPageBreakInsideAvoid) {</span><br>      189-&gt;U:  <span style="background-color: yellow">                      c.setBlockBoxingState(enterState);</span><br>      190-&gt;U:  <span style="background-color: yellow">                  }</span><br>      191-&gt;N:  <span style="background-color: white">              }</span><br>      192-&gt;N:  <span style="background-color: white">      </span><br>      193-&gt;U:  <span style="background-color: yellow">              if (oneChildFailed) {</span><br>      194-&gt;U:  <span style="background-color: yellow">                  // IMPORTANT: If one child failed to satisfy the page-break-inside: avoid</span><br>      195-&gt;U:  <span style="background-color: yellow">                  // constraint we signal to ancestor boxes that they should not try to satisfy</span><br>      196-&gt;U:  <span style="background-color: yellow">                  // the constraint. Otherwise, we get an explosion of layout attempts, that will</span><br>      197-&gt;U:  <span style="background-color: yellow">                  // practically never end for deeply nested blocks. See danfickle#551.</span><br>      198-&gt;U:  <span style="background-color: yellow">                  c.setBlockBoxingState(BlockBoxingState.DENY);</span><br>      199-&gt;U:  <span style="background-color: yellow">              }</span><br>      200-&gt;N:  <span style="background-color: white">          }</span><br>      201-&gt;N:  <span style="background-color: white">      </span><br>      202-&gt;U:  <span style="background-color: yellow">          private static Integer processPageBreakAvoidRun(</span><br>    203-&gt;156:  <span style="background-color: red">                  LayoutContext c,</span><br>    204-&gt;156:  <span style="background-color: red">                  BlockBox block,</span><br>    205-&gt;157:  <span style="background-color: white">                  List
       <box>
         localChildren,
       </box></span><br>    206-&gt;157:  <span style="background-color: white">                  int offset,</span><br>      207-&gt;U:  <span style="background-color: yellow">                  AbstractRelayoutDataList relayoutDataList,</span><br>    208-&gt;159:  <span style="background-color: white">                  BlockBox childBox) {</span><br>      209-&gt;N:  <span style="background-color: white">      </span><br>    210-&gt;161:  <span style="background-color: cyan">              if (offset &gt; 0) {</span><br>    211-&gt;162:  <span style="background-color: cyan">                  boolean mightNeedRelayout = false;</span><br>    212-&gt;163:  <span style="background-color: cyan">                  int runEnd = -1;</span><br>      213-&gt;N:  <span style="background-color: white">      </span><br>      214-&gt;U:  <span style="background-color: yellow">                  if (offset == localChildren.size() - 1 &amp;&amp; relayoutDataList.isEndsRun(offset)) {</span><br>    215-&gt;165:  <span style="background-color: white">                      mightNeedRelayout = true;</span><br>    216-&gt;166:  <span style="background-color: white">                      runEnd = offset;</span><br>    217-&gt;167:  <span style="background-color: cyan">                  } else if (offset &gt; 0) {</span><br>      218-&gt;U:  <span style="background-color: yellow">                      if (relayoutDataList.isEndsRun(offset - 1)) {</span><br>    219-&gt;170:  <span style="background-color: white">                          mightNeedRelayout = true;</span><br>    220-&gt;171:  <span style="background-color: white">                          runEnd = offset - 1;</span><br>      221-&gt;N:  <span style="background-color: white">                      }</span><br>      222-&gt;N:  <span style="background-color: white">                  }</span><br>      223-&gt;N:  <span style="background-color: white">      </span><br>    224-&gt;174:  <span style="background-color: cyan">                  if (mightNeedRelayout) {</span><br>    225-&gt;175:  <span style="background-color: white">                      int runStart = relayoutDataList.getRunStart(runEnd);</span><br>      226-&gt;U:  <span style="background-color: yellow">                      int newChildOffset;</span><br>      227-&gt;N:  <span style="background-color: white">      </span><br>    228-&gt;176:  <span style="background-color: white">                      if ( isPageBreakBetweenChildBoxes(relayoutDataList, runStart, runEnd, c, block) ) {</span><br>    229-&gt;178:  <span style="background-color: white">                          block.resetChildren(c, runStart, offset);</span><br>      230-&gt;N:  <span style="background-color: white">      </span><br>      231-&gt;U:  <span style="background-color: yellow">                          newChildOffset = relayoutRun(</span><br>      232-&gt;U:  <span style="background-color: yellow">                                  c, localChildren, block,</span><br>      233-&gt;U:  <span style="background-color: yellow">                                  relayoutDataList, runStart, offset, true);</span><br>      234-&gt;N:  <span style="background-color: white">      </span><br>    235-&gt;181:  <span style="background-color: white">                          if ( isPageBreakBetweenChildBoxes(relayoutDataList, runStart, runEnd, c, block) ) {</span><br>    236-&gt;182:  <span style="background-color: white">                              block.resetChildren(c, runStart, offset);</span><br>      237-&gt;U:  <span style="background-color: yellow">                              newChildOffset = relayoutRun(</span><br>      238-&gt;U:  <span style="background-color: yellow">                                      c, localChildren, block,</span><br>      239-&gt;U:  <span style="background-color: yellow">                                      relayoutDataList, runStart, offset, false);</span><br>      240-&gt;N:  <span style="background-color: white">                          }</span><br>      241-&gt;N:  <span style="background-color: white">      </span><br>      242-&gt;U:  <span style="background-color: yellow">                          return Integer.valueOf(newChildOffset);</span><br>      243-&gt;N:  <span style="background-color: white">                      }</span><br>      244-&gt;N:  <span style="background-color: white">                  }</span><br>      245-&gt;N:  <span style="background-color: white">              }</span><br>      246-&gt;N:  <span style="background-color: white">      </span><br>      247-&gt;U:  <span style="background-color: yellow">              return null;</span><br>      248-&gt;N:  <span style="background-color: white">          }</span><br>      249-&gt;N:  <span style="background-color: white">      </span><br>    250-&gt;192:  <span style="background-color: white">          private static boolean isPageBreakBetweenChildBoxes(</span><br>      251-&gt;U:  <span style="background-color: yellow">                  AbstractRelayoutDataList relayoutDataList,</span><br>    252-&gt;193:  <span style="background-color: white">                  int runStart, int runEnd, LayoutContext c, BlockBox block) {</span><br>      253-&gt;N:  <span style="background-color: white">      </span><br>    254-&gt;194:  <span style="background-color: white">              for ( int i = runStart; i &lt; runEnd; i++ ) {</span><br>    255-&gt;195:  <span style="background-color: white">                  Box prevChild = block.getChild(i);</span><br>    256-&gt;196:  <span style="background-color: white">                  Box nextChild = block.getChild(i+1);</span><br>      257-&gt;N:  <span style="background-color: white">      </span><br>      258-&gt;N:  <span style="background-color: white">                  // if nextChild is made of several lines, then only the first line</span><br>      259-&gt;N:  <span style="background-color: white">                  // is relevant for "page-break-before: avoid".</span><br>    260-&gt;199:  <span style="background-color: white">                  Box nextLine = getFirstLine(nextChild) == null ? nextChild : getFirstLine(nextChild);</span><br>    261-&gt;200:  <span style="background-color: white">                  int prevChildEnd = prevChild.getAbsY() + prevChild.getHeight();</span><br>    262-&gt;201:  <span style="background-color: white">                  int nextLineEnd = nextLine.getAbsY() + nextLine.getHeight();</span><br>      263-&gt;N:  <span style="background-color: white">      </span><br>    264-&gt;202:  <span style="background-color: white">                  if ( c.getRootLayer().crossesPageBreak(c, prevChildEnd, nextLineEnd) ) {</span><br>    265-&gt;203:  <span style="background-color: white">                      return true;</span><br>      266-&gt;N:  <span style="background-color: white">                  }</span><br>      267-&gt;N:  <span style="background-color: white">              }</span><br>      268-&gt;N:  <span style="background-color: white">      </span><br>    269-&gt;206:  <span style="background-color: white">              return false;</span><br>      270-&gt;N:  <span style="background-color: white">          }</span><br>      271-&gt;N:  <span style="background-color: white">      </span><br>    272-&gt;209:  <span style="background-color: white">          private static LineBox getFirstLine(Box box) {</span><br>    273-&gt;210:  <span style="background-color: white">              for ( Box child = box; child.getChildCount()&gt;0; child = child.getChild(0) ) {</span><br>    274-&gt;211:  <span style="background-color: white">                  if ( child instanceof LineBox ) {</span><br>    275-&gt;212:  <span style="background-color: white">                      return (LineBox) child;</span><br>      276-&gt;N:  <span style="background-color: white">                  }</span><br>      277-&gt;N:  <span style="background-color: white">              }</span><br>    278-&gt;215:  <span style="background-color: white">              return null;</span><br>      279-&gt;N:  <span style="background-color: white">          }</span><br>      280-&gt;N:  <span style="background-color: white">      </span><br>    281-&gt;218:  <span style="background-color: white">          private static int relayoutRun(</span><br>    282-&gt;219:  <span style="background-color: white">                  LayoutContext c, List
       <box>
         localChildren, BlockBox block,
       </box></span><br>      283-&gt;U:  <span style="background-color: yellow">                  AbstractRelayoutDataList relayoutDataList, int start, int end, boolean onNewPage) {</span><br>      284-&gt;U:  <span style="background-color: yellow">              int childOffset = relayoutDataList.getChildOffset(start);</span><br>      285-&gt;N:  <span style="background-color: white">      </span><br>    286-&gt;223:  <span style="background-color: white">              if (onNewPage) {</span><br>    287-&gt;224:  <span style="background-color: white">                  Box startBox = localChildren.get(start);</span><br>    288-&gt;225:  <span style="background-color: white">                  PageBox startPageBox = c.getRootLayer().getFirstPage(c, startBox);</span><br>    289-&gt;226:  <span style="background-color: white">                  childOffset += startPageBox.getBottom() - startBox.getAbsY();</span><br>      290-&gt;N:  <span style="background-color: white">              }</span><br>      291-&gt;N:  <span style="background-color: white">      </span><br>      292-&gt;N:  <span style="background-color: white">              // reset height of parent as it is used for Y-setting of children</span><br>    293-&gt;230:  <span style="background-color: white">              block.setHeight(childOffset);</span><br>      294-&gt;N:  <span style="background-color: white">      </span><br>    295-&gt;233:  <span style="background-color: white">              for (int i = start; i &lt;= end; i++) {</span><br>    296-&gt;234:  <span style="background-color: white">                  BlockBox child = (BlockBox) localChildren.get(i);</span><br>    297-&gt;238:  <span style="background-color: white">                  int pageCount = c.getRootLayer().getPages().size();</span><br>      298-&gt;N:  <span style="background-color: white">      </span><br>      299-&gt;U:  <span style="background-color: yellow">                  LayoutState restoredChildLayoutState = relayoutDataList.getLayoutState(i);</span><br>      300-&gt;U:  <span style="background-color: yellow">                  c.restoreStateForRelayout(restoredChildLayoutState);</span><br>      301-&gt;N:  <span style="background-color: white">      </span><br>      302-&gt;U:  <span style="background-color: yellow">                  relayoutDataList.setChildOffset(i, childOffset);</span><br>    303-&gt;244:  <span style="background-color: white">                  boolean mayCheckKeepTogether = false;</span><br>      304-&gt;N:  <span style="background-color: white">      </span><br>    305-&gt;245:  <span style="background-color: white">                  if ((child.getStyle().isAvoidPageBreakInside() || child.getStyle().isKeepWithInline())</span><br>    306-&gt;246:  <span style="background-color: white">                          &amp;&amp; c.isMayCheckKeepTogether()) {</span><br>    307-&gt;247:  <span style="background-color: white">                      mayCheckKeepTogether = true;</span><br>    308-&gt;248:  <span style="background-color: white">                      c.setMayCheckKeepTogether(false);</span><br>      309-&gt;N:  <span style="background-color: white">                  }</span><br>      310-&gt;N:  <span style="background-color: white">      </span><br>      311-&gt;N:  <span style="background-color: white">                  layoutBlockChild(</span><br>      312-&gt;U:  <span style="background-color: yellow">                          c, block, child, false, childOffset, NO_PAGE_TRIM, restoredChildLayoutState);</span><br>      313-&gt;N:  <span style="background-color: white">      </span><br>    314-&gt;253:  <span style="background-color: white">                  if (mayCheckKeepTogether) {</span><br>    315-&gt;254:  <span style="background-color: white">                      c.setMayCheckKeepTogether(true);</span><br>      316-&gt;N:  <span style="background-color: white">      </span><br>    317-&gt;255:  <span style="background-color: white">                      boolean tryToAvoidPageBreak =</span><br>    318-&gt;256:  <span style="background-color: white">                          child.getStyle().isAvoidPageBreakInside() &amp;&amp; child.crossesPageBreak(c);</span><br>      319-&gt;N:  <span style="background-color: white">      </span><br>    320-&gt;257:  <span style="background-color: white">                      boolean needPageClear = child.isNeedPageClear();</span><br>    321-&gt;258:  <span style="background-color: white">                      boolean keepWithInline = child.isNeedsKeepWithInline(c);</span><br>      322-&gt;N:  <span style="background-color: white">      </span><br>    323-&gt;259:  <span style="background-color: white">                      if (tryToAvoidPageBreak || needPageClear || keepWithInline) {</span><br>      324-&gt;U:  <span style="background-color: yellow">                          c.restoreStateForRelayout(restoredChildLayoutState);</span><br>      325-&gt;U:  <span style="background-color: yellow">                          child.reset(c);</span><br>      326-&gt;N:  <span style="background-color: white">      </span><br>      327-&gt;N:  <span style="background-color: white">                          layoutBlockChild(</span><br>      328-&gt;U:  <span style="background-color: yellow">                                  c, block, child, true, childOffset, pageCount, restoredChildLayoutState);</span><br>      329-&gt;N:  <span style="background-color: white">      </span><br>    330-&gt;265:  <span style="background-color: white">                          if (tryToAvoidPageBreak &amp;&amp; child.crossesPageBreak(c) &amp;&amp; ! keepWithInline) {</span><br>      331-&gt;U:  <span style="background-color: yellow">                              c.restoreStateForRelayout(restoredChildLayoutState);</span><br>      332-&gt;U:  <span style="background-color: yellow">                              child.reset(c);</span><br>      333-&gt;N:  <span style="background-color: white">      </span><br>      334-&gt;N:  <span style="background-color: white">                              layoutBlockChild(</span><br>      335-&gt;U:  <span style="background-color: yellow">                                      c, block, child, false, childOffset, pageCount, restoredChildLayoutState);</span><br>      336-&gt;N:  <span style="background-color: white">                          }</span><br>      337-&gt;N:  <span style="background-color: white">                      }</span><br>      338-&gt;N:  <span style="background-color: white">                  }</span><br>      339-&gt;N:  <span style="background-color: white">      </span><br>    340-&gt;274:  <span style="background-color: white">                  c.getRootLayer().ensureHasPage(c, child);</span><br>      341-&gt;N:  <span style="background-color: white">      </span><br>    342-&gt;276:  <span style="background-color: white">                  Dimension relativeOffset = child.getRelativeOffset();</span><br>      343-&gt;N:  <span style="background-color: white">      </span><br>    344-&gt;277:  <span style="background-color: white">                  if (relativeOffset == null) {</span><br>    345-&gt;278:  <span style="background-color: white">                      childOffset = child.getY() + child.getHeight();</span><br>      346-&gt;N:  <span style="background-color: white">                  } else {</span><br>    347-&gt;280:  <span style="background-color: white">                      childOffset = child.getY() - relativeOffset.height + child.getHeight();</span><br>      348-&gt;N:  <span style="background-color: white">                  }</span><br>      349-&gt;N:  <span style="background-color: white">      </span><br>    350-&gt;283:  <span style="background-color: white">                  if (childOffset &gt; block.getHeight()) {</span><br>    351-&gt;284:  <span style="background-color: white">                      block.setHeight(childOffset);</span><br>      352-&gt;N:  <span style="background-color: white">                  }</span><br>      353-&gt;N:  <span style="background-color: white">      </span><br>    354-&gt;287:  <span style="background-color: white">                  if (child.getStyle().isForcePageBreakAfter()) {</span><br>    355-&gt;288:  <span style="background-color: white">                      block.forcePageBreakAfter(c, child.getStyle().getIdent(CSSName.PAGE_BREAK_AFTER));</span><br>    356-&gt;289:  <span style="background-color: white">                      childOffset = block.getHeight();</span><br>      357-&gt;N:  <span style="background-color: white">                  }</span><br>      358-&gt;N:  <span style="background-color: white">              }</span><br>      359-&gt;N:  <span style="background-color: white">      </span><br>    360-&gt;293:  <span style="background-color: white">              return childOffset;</span><br>      361-&gt;N:  <span style="background-color: white">          }</span><br>      362-&gt;N:  <span style="background-color: white">      </span><br>    363-&gt;296:  <span style="background-color: cyan">          private static void layoutBlockChild(</span><br>    364-&gt;297:  <span style="background-color: white">                  LayoutContext c, BlockBox parent, BlockBox child,</span><br>    365-&gt;298:  <span style="background-color: white">                  boolean needPageClear, int childOffset, int trimmedPageCount, LayoutState layoutState) {</span><br>    366-&gt;299:  <span style="background-color: cyan">              layoutBlockChild0(c, parent, child, needPageClear, childOffset, trimmedPageCount);</span><br>    367-&gt;300:  <span style="background-color: cyan">              BreakAtLineContext bContext = child.calcBreakAtLineContext(c);</span><br>    368-&gt;301:  <span style="background-color: cyan">              if (bContext != null) {</span><br>    369-&gt;302:  <span style="background-color: white">                  c.setBreakAtLineContext(bContext);</span><br>    370-&gt;303:  <span style="background-color: white">                  c.restoreStateForRelayout(layoutState);</span><br>    371-&gt;304:  <span style="background-color: white">                  child.reset(c);</span><br>    372-&gt;305:  <span style="background-color: white">                  layoutBlockChild0(c, parent, child, needPageClear, childOffset, trimmedPageCount);</span><br>    373-&gt;306:  <span style="background-color: white">                  c.setBreakAtLineContext(null);</span><br>      374-&gt;N:  <span style="background-color: white">              }</span><br>      375-&gt;N:  <span style="background-color: white">          }</span><br>      376-&gt;N:  <span style="background-color: white">      </span><br>    377-&gt;310:  <span style="background-color: cyan">          private static void layoutBlockChild0(LayoutContext c, BlockBox parent, BlockBox child,</span><br>    378-&gt;311:  <span style="background-color: white">                  boolean needPageClear, int childOffset, int trimmedPageCount) {</span><br>    379-&gt;312:  <span style="background-color: cyan">              child.setNeedPageClear(needPageClear);</span><br>      380-&gt;N:  <span style="background-color: white">      </span><br>    381-&gt;314:  <span style="background-color: cyan">              child.initStaticPos(c, parent, childOffset);</span><br>      382-&gt;N:  <span style="background-color: white">      </span><br>    383-&gt;316:  <span style="background-color: cyan">              child.initContainingLayer(c);</span><br>    384-&gt;317:  <span style="background-color: cyan">              child.calcCanvasLocation();</span><br>      385-&gt;N:  <span style="background-color: white">      </span><br>    386-&gt;319:  <span style="background-color: cyan">              c.translate(0, childOffset);</span><br>    387-&gt;320:  <span style="background-color: cyan">              repositionBox(c, child, trimmedPageCount);</span><br>    388-&gt;321:  <span style="background-color: cyan">              child.layout(c);</span><br>    389-&gt;322:  <span style="background-color: cyan">              c.translate(-child.getX(), -child.getY());</span><br>      390-&gt;N:  <span style="background-color: white">          }</span><br>      391-&gt;N:  <span style="background-color: white">      </span><br>    392-&gt;325:  <span style="background-color: cyan">          private static void repositionBox(LayoutContext c, BlockBox child, int trimmedPageCount) {</span><br>    393-&gt;326:  <span style="background-color: cyan">              boolean moved = false;</span><br>    394-&gt;327:  <span style="background-color: cyan">              if (child.getStyle().isRelative()) {</span><br>    395-&gt;328:  <span style="background-color: cyan">                  Dimension delta = child.positionRelative(c);</span><br>    396-&gt;329:  <span style="background-color: cyan">                  c.translate(delta.width, delta.height);</span><br>    397-&gt;330:  <span style="background-color: cyan">                  moved = true;</span><br>      398-&gt;N:  <span style="background-color: white">              }</span><br>    399-&gt;332:  <span style="background-color: cyan">              if (c.isPrint()) {</span><br>    400-&gt;333:  <span style="background-color: cyan">                  boolean pageClear = child.isNeedPageClear() ||</span><br>    401-&gt;334:  <span style="background-color: white">                                          child.getStyle().isForcePageBreakBefore() ||</span><br>    402-&gt;335:  <span style="background-color: white">                                          child.isPageBreakNeededBecauseOfMinHeight(c);</span><br>    403-&gt;336:  <span style="background-color: cyan">                  boolean needNewPageContext = child.checkPageContext(c);</span><br>      404-&gt;N:  <span style="background-color: white">      </span><br>    405-&gt;338:  <span style="background-color: cyan">                  if (needNewPageContext &amp;&amp; trimmedPageCount != NO_PAGE_TRIM) {</span><br>    406-&gt;339:  <span style="background-color: white">                      c.getRootLayer().trimPageCount(trimmedPageCount);</span><br>      407-&gt;N:  <span style="background-color: white">                  }</span><br>      408-&gt;N:  <span style="background-color: white">      </span><br>    409-&gt;342:  <span style="background-color: cyan">                  if (pageClear || needNewPageContext) {</span><br>    410-&gt;343:  <span style="background-color: cyan">                      int delta = child.forcePageBreakBefore(</span><br>    411-&gt;344:  <span style="background-color: white">                              c,</span><br>    412-&gt;345:  <span style="background-color: white">                              child.getStyle().getIdent(CSSName.PAGE_BREAK_BEFORE),</span><br>    413-&gt;346:  <span style="background-color: white">                              needNewPageContext);</span><br>    414-&gt;347:  <span style="background-color: cyan">                      c.translate(0, delta);</span><br>    415-&gt;348:  <span style="background-color: cyan">                      moved = true;</span><br>    416-&gt;349:  <span style="background-color: cyan">                      child.setNeedPageClear(false);</span><br>      417-&gt;N:  <span style="background-color: white">                  }</span><br>      418-&gt;N:  <span style="background-color: white">              }</span><br>    419-&gt;352:  <span style="background-color: cyan">              if (moved) {</span><br>    420-&gt;353:  <span style="background-color: cyan">                  child.calcCanvasLocation();</span><br>      421-&gt;N:  <span style="background-color: white">              }</span><br>      422-&gt;N:  <span style="background-color: white">          }</span><br>      423-&gt;N:  <span style="background-color: white">      </span><br>      424-&gt;N:  <span style="background-color: white">          /**</span><br>      425-&gt;N:  <span style="background-color: white">           * If we should try to avoid a page break between two block boxes.</span><br>      426-&gt;N:  <span style="background-color: white">           */</span><br>      427-&gt;U:  <span style="background-color: yellow">          public static boolean avoidPageBreakBetween(BlockBox previous, BlockBox current) {</span><br>      428-&gt;U:  <span style="background-color: yellow">              IdentValue previousAfter =</span><br>      429-&gt;U:  <span style="background-color: yellow">                      previous.getStyle().getIdent(CSSName.PAGE_BREAK_AFTER);</span><br>      430-&gt;U:  <span style="background-color: yellow">              IdentValue currentBefore =</span><br>      431-&gt;U:  <span style="background-color: yellow">                      current.getStyle().getIdent(CSSName.PAGE_BREAK_BEFORE);</span><br>      432-&gt;U:  <span style="background-color: yellow">      </span><br>      433-&gt;U:  <span style="background-color: yellow">              return (previousAfter == IdentValue.AVOID &amp;&amp; currentBefore == IdentValue.AUTO) ||</span><br>      434-&gt;U:  <span style="background-color: yellow">                      (previousAfter == IdentValue.AUTO &amp;&amp; currentBefore == IdentValue.AVOID) ||</span><br>      435-&gt;U:  <span style="background-color: yellow">                      (previousAfter == IdentValue.AVOID &amp;&amp; currentBefore == IdentValue.AVOID);</span><br>      436-&gt;U:  <span style="background-color: yellow">          }</span><br>      437-&gt;N:  <span style="background-color: white">      </span><br>      438-&gt;U:  <span style="background-color: yellow">          private abstract static class AbstractRelayoutDataList {</span><br>      439-&gt;U:  <span style="background-color: yellow">              abstract int getChildOffset(int boxIndex);</span><br>      440-&gt;U:  <span style="background-color: yellow">              abstract LayoutState getLayoutState(int boxIndex);</span><br>      441-&gt;U:  <span style="background-color: yellow">      </span><br>      442-&gt;U:  <span style="background-color: yellow">              abstract void setLayoutState(int boxIndex, LayoutState state);</span><br>      443-&gt;U:  <span style="background-color: yellow">              abstract void setChildOffset(int boxIndex, int childOffset);</span><br>      444-&gt;U:  <span style="background-color: yellow">      </span><br>      445-&gt;U:  <span style="background-color: yellow">              abstract int getRunStart(int endRunIndex);</span><br>      446-&gt;U:  <span style="background-color: yellow">      </span><br>      447-&gt;U:  <span style="background-color: yellow">              abstract boolean isEndsRun(int boxIndex);</span><br>      448-&gt;U:  <span style="background-color: yellow">      </span><br>      449-&gt;U:  <span style="background-color: yellow">              abstract void configureRun(int boxIndex, BlockBox previous, BlockBox current);</span><br>      450-&gt;U:  <span style="background-color: yellow">          }</span><br>      451-&gt;N:  <span style="background-color: white">      </span><br>      452-&gt;U:  <span style="background-color: yellow">          private static class LiteRelayoutDataList extends AbstractRelayoutDataList {</span><br>      453-&gt;U:  <span style="background-color: yellow">              final int[] childOffsets;</span><br>      454-&gt;U:  <span style="background-color: yellow">              final LayoutState[] layoutStates;</span><br>      455-&gt;U:  <span style="background-color: yellow">      </span><br>      456-&gt;U:  <span style="background-color: yellow">              TreeSet
       <integer>
         runStarts;
       </integer></span><br>      457-&gt;U:  <span style="background-color: yellow">              TreeSet
       <integer>
         runEnds;
       </integer></span><br>      458-&gt;U:  <span style="background-color: yellow">      </span><br>      459-&gt;U:  <span style="background-color: yellow">              LiteRelayoutDataList(int size) {</span><br>      460-&gt;U:  <span style="background-color: yellow">                  childOffsets = new int[size];</span><br>      461-&gt;U:  <span style="background-color: yellow">                  layoutStates = new LayoutState[size];</span><br>      462-&gt;U:  <span style="background-color: yellow">              }</span><br>      463-&gt;U:  <span style="background-color: yellow">      </span><br>      464-&gt;U:  <span style="background-color: yellow">              @Override</span><br>      465-&gt;U:  <span style="background-color: yellow">              int getChildOffset(int boxIndex) {</span><br>      466-&gt;U:  <span style="background-color: yellow">                  return childOffsets[boxIndex];</span><br>      467-&gt;U:  <span style="background-color: yellow">              }</span><br>      468-&gt;U:  <span style="background-color: yellow">      </span><br>      469-&gt;U:  <span style="background-color: yellow">              @Override</span><br>      470-&gt;U:  <span style="background-color: yellow">              LayoutState getLayoutState(int boxIndex) {</span><br>      471-&gt;U:  <span style="background-color: yellow">                  return layoutStates[boxIndex];</span><br>      472-&gt;U:  <span style="background-color: yellow">              }</span><br>      473-&gt;U:  <span style="background-color: yellow">      </span><br>      474-&gt;U:  <span style="background-color: yellow">              @Override</span><br>      475-&gt;U:  <span style="background-color: yellow">              void setLayoutState(int boxIndex, LayoutState state) {</span><br>      476-&gt;U:  <span style="background-color: yellow">                  layoutStates[boxIndex] = state;</span><br>      477-&gt;U:  <span style="background-color: yellow">              }</span><br>      478-&gt;U:  <span style="background-color: yellow">      </span><br>      479-&gt;U:  <span style="background-color: yellow">              @Override</span><br>      480-&gt;U:  <span style="background-color: yellow">              void setChildOffset(int boxIndex, int childOffset) {</span><br>      481-&gt;U:  <span style="background-color: yellow">                  childOffsets[boxIndex] = childOffset;</span><br>      482-&gt;U:  <span style="background-color: yellow">              }</span><br>      483-&gt;U:  <span style="background-color: yellow">      </span><br>      484-&gt;U:  <span style="background-color: yellow">              @Override</span><br>      485-&gt;U:  <span style="background-color: yellow">              boolean isEndsRun(int boxIndex) {</span><br>      486-&gt;U:  <span style="background-color: yellow">                  return runEnds != null &amp;&amp; runEnds.contains(boxIndex);</span><br>      487-&gt;U:  <span style="background-color: yellow">              }</span><br>      488-&gt;U:  <span style="background-color: yellow">      </span><br>      489-&gt;U:  <span style="background-color: yellow">              @Override</span><br>      490-&gt;U:  <span style="background-color: yellow">              int getRunStart(int endRunIndex) {</span><br>      491-&gt;U:  <span style="background-color: yellow">                  return runStarts.floor(endRunIndex);</span><br>      492-&gt;U:  <span style="background-color: yellow">              }</span><br>      493-&gt;U:  <span style="background-color: yellow">      </span><br>      494-&gt;U:  <span style="background-color: yellow">              boolean isInRun(int boxIndex) {</span><br>      495-&gt;U:  <span style="background-color: yellow">                  if (runStarts == null) {</span><br>      496-&gt;U:  <span style="background-color: yellow">                      return false;</span><br>      497-&gt;U:  <span style="background-color: yellow">                  }</span><br>      498-&gt;U:  <span style="background-color: yellow">      </span><br>      499-&gt;U:  <span style="background-color: yellow">                  Integer lastRunStart = runStarts.floor(boxIndex);</span><br>      500-&gt;U:  <span style="background-color: yellow">                  if (lastRunStart != null) {</span><br>      501-&gt;U:  <span style="background-color: yellow">                      Integer lastRunEnd = runEnds != null ? runEnds.ceiling(lastRunStart) : null;</span><br>      502-&gt;U:  <span style="background-color: yellow">                      return (lastRunEnd == null ||</span><br>      503-&gt;U:  <span style="background-color: yellow">                              lastRunEnd &gt;= boxIndex);</span><br>      504-&gt;U:  <span style="background-color: yellow">                  }</span><br>      505-&gt;U:  <span style="background-color: yellow">      </span><br>      506-&gt;U:  <span style="background-color: yellow">                  return false;</span><br>      507-&gt;U:  <span style="background-color: yellow">              }</span><br>      508-&gt;U:  <span style="background-color: yellow">      </span><br>      509-&gt;U:  <span style="background-color: yellow">              void addRunStart(int boxIndex) {</span><br>      510-&gt;U:  <span style="background-color: yellow">                  if (runStarts == null) {</span><br>      511-&gt;U:  <span style="background-color: yellow">                      runStarts = new TreeSet&lt;&gt;();</span><br>      512-&gt;U:  <span style="background-color: yellow">                  }</span><br>      513-&gt;U:  <span style="background-color: yellow">                  runStarts.add(boxIndex);</span><br>      514-&gt;U:  <span style="background-color: yellow">              }</span><br>      515-&gt;U:  <span style="background-color: yellow">      </span><br>      516-&gt;U:  <span style="background-color: yellow">              void addRunEnd(int boxIndex) {</span><br>      517-&gt;U:  <span style="background-color: yellow">                  if (runEnds == null) {</span><br>      518-&gt;U:  <span style="background-color: yellow">                      runEnds = new TreeSet&lt;&gt;();</span><br>      519-&gt;U:  <span style="background-color: yellow">                  }</span><br>      520-&gt;U:  <span style="background-color: yellow">                  runEnds.add(boxIndex);</span><br>      521-&gt;U:  <span style="background-color: yellow">              }</span><br>      522-&gt;U:  <span style="background-color: yellow">      </span><br>      523-&gt;U:  <span style="background-color: yellow">              /**</span><br>      524-&gt;U:  <span style="background-color: yellow">               * Marks two consecutive block boxes as being in a run of boxes where</span><br>      525-&gt;U:  <span style="background-color: yellow">               * a page break should not occur between them as set in the</span><br>      526-&gt;U:  <span style="background-color: yellow">               * <code>page-break-after</code> and <code>page-break-before</code></span><br>      527-&gt;U:  <span style="background-color: yellow">               * CSS properties.</span><br>      528-&gt;U:  <span style="background-color: yellow">               */</span><br>      529-&gt;U:  <span style="background-color: yellow">              @Override</span><br>      530-&gt;U:  <span style="background-color: yellow">              public void configureRun(int offset, BlockBox previous, BlockBox current) {</span><br>      531-&gt;U:  <span style="background-color: yellow">                  boolean previousInRun = isInRun(offset - 1);</span><br>      532-&gt;U:  <span style="background-color: yellow">      </span><br>      533-&gt;U:  <span style="background-color: yellow">                  if (avoidPageBreakBetween(previous, current)) {</span><br>      534-&gt;U:  <span style="background-color: yellow">                      if (!previousInRun) {</span><br>      535-&gt;U:  <span style="background-color: yellow">                          addRunStart(offset - 1);</span><br>      536-&gt;U:  <span style="background-color: yellow">                      }</span><br>      537-&gt;U:  <span style="background-color: yellow">      </span><br>      538-&gt;U:  <span style="background-color: yellow">                      if (offset == childOffsets.length - 1) {</span><br>      539-&gt;U:  <span style="background-color: yellow">                          addRunEnd(offset);</span><br>      540-&gt;U:  <span style="background-color: yellow">                      }</span><br>      541-&gt;U:  <span style="background-color: yellow">                  } else if (previousInRun) {</span><br>      542-&gt;U:  <span style="background-color: yellow">                      addRunEnd(offset - 1);</span><br>      543-&gt;U:  <span style="background-color: yellow">                  }</span><br>      544-&gt;U:  <span style="background-color: yellow">              }</span><br>      545-&gt;U:  <span style="background-color: yellow">          }</span><br>      546-&gt;N:  <span style="background-color: white">      </span><br>      547-&gt;N:  <span style="background-color: white">      }</span><br></pre> </code> 
   </div> 
  </div>  
 </body>
</html>
<!doctype html>
<html lang="en"> 
 <head> 
  <meta charset="UTF-8"> 
  <title>Execution Trace Diff</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <style>
* {
  box-sizing: border-box;
}

/* Create two equal columns that floats next to each other */
.column {
  float: left;
  width: 50%;
  padding: 10px;
  height: 300px; /* Should be removed. Only for demonstration */
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

.test {
    border: 1px solid darkblue;
    padding-left: 10px;
}
</style> 
 </head> 
 <body> 
  <div class="row test"> 
   <h2>Differencing Test:</h2> <code> <pre>@Test <br>
public void test_main(){ <br>
    String ret = NumberAnalyzer.analyze(1); <br>
    assertThat(ret, containsString("greater")); <br>
}
        </pre> </code> 
  </div> 
  <div class="row"> 
   <div class="column"> 
    <h2>Original Code:</h2> <code> <pre id="original-trace">           1:  <span style="background-color: white">      /*</span><br>           2:  <span style="background-color: white">       * StyleReference.java</span><br>           3:  <span style="background-color: white">       * Copyright (c) 2004, 2005 Torbjoern Gannholm</span><br>           4:  <span style="background-color: white">       *</span><br>           5:  <span style="background-color: white">       * This program is free software; you can redistribute it and/or</span><br>           6:  <span style="background-color: white">       * modify it under the terms of the GNU Lesser General Public License</span><br>           7:  <span style="background-color: white">       * as published by the Free Software Foundation; either version 2.1</span><br>           8:  <span style="background-color: white">       * of the License, or (at your option) any later version.</span><br>           9:  <span style="background-color: white">       *</span><br>          10:  <span style="background-color: white">       * This program is distributed in the hope that it will be useful,</span><br>          11:  <span style="background-color: white">       * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br>          12:  <span style="background-color: white">       * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the</span><br>          13:  <span style="background-color: white">       * GNU Lesser General Public License for more details.</span><br>          14:  <span style="background-color: white">       *</span><br>          15:  <span style="background-color: white">       * You should have received a copy of the GNU Lesser General Public License</span><br>          16:  <span style="background-color: white">       * along with this program; if not, write to the Free Software</span><br>          17:  <span style="background-color: white">       * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span><br>          18:  <span style="background-color: white">       *</span><br>          19:  <span style="background-color: white">       */</span><br>          20:  <span style="background-color: white">      package com.openhtmltopdf.context;</span><br>          21:  <span style="background-color: white">      </span><br>          22:  <span style="background-color: white">      import java.io.StringReader;</span><br>          23:  <span style="background-color: white">      import java.util.ArrayList;</span><br>          24:  <span style="background-color: white">      import java.util.Arrays;</span><br>          25:  <span style="background-color: white">      import java.util.List;</span><br>          26:  <span style="background-color: white">      import java.util.logging.Level;</span><br>          27:  <span style="background-color: white">      </span><br>          28:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.FontFaceRule;</span><br>          29:  <span style="background-color: white">      import com.openhtmltopdf.util.LogMessageId;</span><br>          30:  <span style="background-color: white">      import org.w3c.dom.Document;</span><br>          31:  <span style="background-color: white">      import org.w3c.dom.Element;</span><br>          32:  <span style="background-color: white">      import org.w3c.dom.Node;</span><br>          33:  <span style="background-color: white">      </span><br>          34:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.CSSName;</span><br>          35:  <span style="background-color: white">      import com.openhtmltopdf.css.extend.AttributeResolver;</span><br>          36:  <span style="background-color: white">      import com.openhtmltopdf.css.extend.lib.DOMTreeResolver;</span><br>          37:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.CascadedStyle;</span><br>          38:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.PageInfo;</span><br>          39:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.CSSPrimitiveValue;</span><br>          40:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.PropertyDeclaration;</span><br>          41:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.Stylesheet;</span><br>          42:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.StylesheetInfo;</span><br>          43:  <span style="background-color: white">      import com.openhtmltopdf.css.style.CalculatedStyle;</span><br>          44:  <span style="background-color: white">      import com.openhtmltopdf.extend.NamespaceHandler;</span><br>          45:  <span style="background-color: white">      import com.openhtmltopdf.extend.UserAgentCallback;</span><br>          46:  <span style="background-color: white">      import com.openhtmltopdf.extend.UserInterface;</span><br>          47:  <span style="background-color: white">      import com.openhtmltopdf.layout.SharedContext;</span><br>          48:  <span style="background-color: white">      import com.openhtmltopdf.util.XRLog;</span><br>          49:  <span style="background-color: white">      </span><br>          50:  <span style="background-color: white">      </span><br>          51:  <span style="background-color: white">      /**</span><br>          52:  <span style="background-color: white">       * @author Torbjoern Gannholm</span><br>          53:  <span style="background-color: white">       */</span><br>          54:  <span style="background-color: white">      public class StyleReference {</span><br>          55:  <span style="background-color: white">          /**</span><br>          56:  <span style="background-color: white">           * The Context this StyleReference operates in; used for property</span><br>          57:  <span style="background-color: white">           * resolution.</span><br>          58:  <span style="background-color: white">           */</span><br>          59:  <span style="background-color: white">          private SharedContext _context;</span><br>          60:  <span style="background-color: white">          private NamespaceHandler _nsh;</span><br>          61:  <span style="background-color: white">          private Document _doc;</span><br>          62:  <span style="background-color: white">          private final StylesheetFactoryImpl _stylesheetFactory;</span><br>          63:  <span style="background-color: white">      </span><br>          64:  <span style="background-color: white">          /**</span><br>          65:  <span style="background-color: white">           * Instance of our element-styles matching class. Will be null if new rules</span><br>          66:  <span style="background-color: white">           * have been added since last match.</span><br>          67:  <span style="background-color: white">           */</span><br>          68:  <span style="background-color: white">          private com.openhtmltopdf.css.newmatch.Matcher _matcher;</span><br>          69:  <span style="background-color: white">      </span><br>          70:  <span style="background-color: white">          private UserAgentCallback _uac;</span><br>          71:  <span style="background-color: white">          </span><br>          72:  <span style="background-color: white"> 99+      public StyleReference(UserAgentCallback userAgent) {</span><br>          73:  <span style="background-color: white"> 99+          _uac = userAgent;</span><br>          74:  <span style="background-color: white"> 99+          _stylesheetFactory = new StylesheetFactoryImpl(userAgent);</span><br>          75:  <span style="background-color: white">          }</span><br>          76:  <span style="background-color: white">      </span><br>          77:  <span style="background-color: white">          /**</span><br>          78:  <span style="background-color: white">           * Gets the style of the root element, should be html tag.</span><br>          79:  <span style="background-color: white">           */</span><br>          80:  <span style="background-color: white">  30      public CalculatedStyle getRootElementStyle() {</span><br>          81:  <span style="background-color: white">  30          if (_context != null &amp;&amp; _doc != null) {</span><br>          82:  <span style="background-color: white">  30              return _context.getStyle(_doc.getDocumentElement());</span><br>          83:  <span style="background-color: white">              } else {</span><br>          84:  <span style="background-color: white">   0              return null;</span><br>          85:  <span style="background-color: white">              }</span><br>          86:  <span style="background-color: white">          }</span><br>          87:  <span style="background-color: white">      </span><br>          88:  <span style="background-color: white">          /**</span><br>          89:  <span style="background-color: white">           * Sets the documentContext attribute of the StyleReference object</span><br>          90:  <span style="background-color: white">           *</span><br>          91:  <span style="background-color: white">           * @param context The new documentContext value</span><br>          92:  <span style="background-color: white">           * @param nsh     The new documentContext value</span><br>          93:  <span style="background-color: white">           * @param doc     The new documentContext value</span><br>          94:  <span style="background-color: white">           * @param ui</span><br>          95:  <span style="background-color: white">           */</span><br>          96:  <span style="background-color: white"> 99+      public void setDocumentContext(SharedContext context, NamespaceHandler nsh, Document doc, UserInterface ui) {</span><br>          97:  <span style="background-color: white"> 99+          _context = context;</span><br>          98:  <span style="background-color: white"> 99+          _nsh = nsh;</span><br>          99:  <span style="background-color: white"> 99+          _doc = doc;</span><br>         100:  <span style="background-color: white"> 99+          AttributeResolver attRes = new StandardAttributeResolver(_nsh, _uac, ui);</span><br>         101:  <span style="background-color: white">      </span><br>         102:  <span style="background-color: white"> 99+          List
       <stylesheetinfo>
         infos = getStylesheets();
       </stylesheetinfo></span><br>         103:  <span style="background-color: white">      </span><br>         104:  <span style="background-color: white"> 99+          XRLog.log(Level.INFO, LogMessageId.LogMessageId1Param.MATCH_MEDIA_IS, _context.getMedia());</span><br>         105:  <span style="background-color: white">              </span><br>         106:  <span style="background-color: white"> 99+          _matcher = new com.openhtmltopdf.css.newmatch.Matcher(</span><br>         107:  <span style="background-color: white">                      new DOMTreeResolver(), </span><br>         108:  <span style="background-color: white">                      attRes, </span><br>         109:  <span style="background-color: white">                      _stylesheetFactory, </span><br>         110:  <span style="background-color: white">                      readAndParseAll(infos, _context.getMedia()), </span><br>         111:  <span style="background-color: white">                      _context.getMedia());</span><br>         112:  <span style="background-color: white">          }</span><br>         113:  <span style="background-color: white">          </span><br>         114:  <span style="background-color: white"> 99+      private List
       <stylesheet>
         readAndParseAll(List
        <stylesheetinfo>
          infos, String medium) {
        </stylesheetinfo>
       </stylesheet></span><br>         115:  <span style="background-color: white"> 99+          List
       <stylesheet>
         result = new ArrayList&lt;&gt;(infos.size() + 15);
       </stylesheet></span><br>         116:  <span style="background-color: white">              </span><br>         117:  <span style="background-color: white"> 99+          for (StylesheetInfo info : infos) {</span><br>         118:  <span style="background-color: white"> 99+              if (info.appliesToMedia(medium)) {</span><br>         119:  <span style="background-color: white"> 99+                  Stylesheet sheet = info.getStylesheet();</span><br>         120:  <span style="background-color: white">                      </span><br>         121:  <span style="background-color: white"> 99+                  if (sheet == null) {</span><br>         122:  <span style="background-color: white">  23                      sheet = _stylesheetFactory.getStylesheet(info);</span><br>         123:  <span style="background-color: white">                      }</span><br>         124:  <span style="background-color: white">                      </span><br>         125:  <span style="background-color: white"> 99+                  if (sheet != null) {</span><br>         126:  <span style="background-color: white"> 99+                      if (sheet.getImportRules().size() &gt; 0) {</span><br>         127:  <span style="background-color: white">  21                          result.addAll(readAndParseAll(sheet.getImportRules(), medium));</span><br>         128:  <span style="background-color: white">                          }</span><br>         129:  <span style="background-color: white">                          </span><br>         130:  <span style="background-color: white"> 99+                      result.add(sheet);</span><br>         131:  <span style="background-color: white">                      } else {</span><br>         132:  <span style="background-color: white">   2                      XRLog.log(Level.WARNING, LogMessageId.LogMessageId1Param.LOAD_UNABLE_TO_LOAD_CSS_FROM_URI, info.getUri());</span><br>         133:  <span style="background-color: white">                      }</span><br>         134:  <span style="background-color: white">                  }</span><br>         135:  <span style="background-color: white">              }</span><br>         136:  <span style="background-color: white">              </span><br>         137:  <span style="background-color: white"> 99+          return result;</span><br>         138:  <span style="background-color: white">          }</span><br>         139:  <span style="background-color: white">      </span><br>         140:  <span style="background-color: white">   0      public boolean isHoverStyled(Element e) {</span><br>         141:  <span style="background-color: white">   0          return _matcher.isHoverStyled(e);</span><br>         142:  <span style="background-color: white">          }</span><br>         143:  <span style="background-color: white">      </span><br>         144:  <span style="background-color: white">          /**</span><br>         145:  <span style="background-color: white">           * Returns a Map keyed by CSS property names (e.g. 'border-width'), and the</span><br>         146:  <span style="background-color: white">           * assigned value as a SAC CSSValue instance. The properties should have</span><br>         147:  <span style="background-color: white">           * been matched to the element when the Context was established for this</span><br>         148:  <span style="background-color: white">           * StyleReference on the Document to which the Element belongs.</span><br>         149:  <span style="background-color: white">           * </span><br>         150:  <span style="background-color: white">           * Only used by broken DOM inspector.</span><br>         151:  <span style="background-color: white">           *</span><br>         152:  <span style="background-color: white">           * @param e The DOM Element for which to find properties</span><br>         153:  <span style="background-color: white">           * @return Map of CSS property names to CSSValue instance assigned to it.</span><br>         154:  <span style="background-color: white">           */</span><br>         155:  <span style="background-color: white">   0      @Deprecated</span><br>         156:  <span style="background-color: white">      	public java.util.Map
       <string, cssprimitivevalue>
         getCascadedPropertiesMap(Element e) {
       </string,></span><br>         157:  <span style="background-color: white">   0          CascadedStyle cs = _matcher.getCascadedStyle(e, false);</span><br>         158:  <span style="background-color: white">              </span><br>         159:  <span style="background-color: white">   0  		java.util.Map
       <string, cssprimitivevalue>
         props = new java.util.LinkedHashMap&lt;&gt;();
       </string,></span><br>         160:  <span style="background-color: white">      		</span><br>         161:  <span style="background-color: white">   0  		for (PropertyDeclaration pd : cs.getCascadedPropertyDeclarations()) {</span><br>         162:  <span style="background-color: white">   0              String propName = pd.getPropertyName();</span><br>         163:  <span style="background-color: white">   0              CSSName cssName = CSSName.getByPropertyName(propName);</span><br>         164:  <span style="background-color: white">   0              props.put(propName, cs.propertyByName(cssName).getValue());</span><br>         165:  <span style="background-color: white">              }</span><br>         166:  <span style="background-color: white">      		</span><br>         167:  <span style="background-color: white">   0          return props;</span><br>         168:  <span style="background-color: white">          }</span><br>         169:  <span style="background-color: white">      </span><br>         170:  <span style="background-color: white">          /**</span><br>         171:  <span style="background-color: white">           * Gets the pseudoElementStyle attribute of the StyleReference object</span><br>         172:  <span style="background-color: white">           *</span><br>         173:  <span style="background-color: white">           * @param node          PARAM</span><br>         174:  <span style="background-color: white">           * @param pseudoElement PARAM</span><br>         175:  <span style="background-color: white">           * @return The pseudoElementStyle value</span><br>         176:  <span style="background-color: white">           */</span><br>         177:  <span style="background-color: white"> 99+      public CascadedStyle getPseudoElementStyle(Node node, String pseudoElement) {</span><br>         178:  <span style="background-color: white"> 99+          Element e = null;</span><br>         179:  <span style="background-color: white"> 99+          if (node.getNodeType() == Node.ELEMENT_NODE) {</span><br>         180:  <span style="background-color: white"> 99+              e = (Element) node;</span><br>         181:  <span style="background-color: white">              } else {</span><br>         182:  <span style="background-color: white">   0              e = (Element) node.getParentNode();</span><br>         183:  <span style="background-color: white">              }</span><br>         184:  <span style="background-color: white"> 99+          return _matcher.getPECascadedStyle(e, pseudoElement);</span><br>         185:  <span style="background-color: white">          }</span><br>         186:  <span style="background-color: white">      </span><br>         187:  <span style="background-color: white">          /**</span><br>         188:  <span style="background-color: white">           * Gets the CascadedStyle for an element. This must then be converted in the</span><br>         189:  <span style="background-color: white">           * current context to a CalculatedStyle (use getDerivedStyle)</span><br>         190:  <span style="background-color: white">           *</span><br>         191:  <span style="background-color: white">           * @param e       The element</span><br>         192:  <span style="background-color: white">           * @param restyle</span><br>         193:  <span style="background-color: white">           * @return The style value</span><br>         194:  <span style="background-color: white">           */</span><br>         195:  <span style="background-color: white"> 99+      public CascadedStyle getCascadedStyle(Element e, boolean restyle) {</span><br>         196:  <span style="background-color: white"> 99+          if (e == null) return CascadedStyle.emptyCascadedStyle;</span><br>         197:  <span style="background-color: white"> 99+          return _matcher.getCascadedStyle(e, restyle);</span><br>         198:  <span style="background-color: white">          }</span><br>         199:  <span style="background-color: white">      </span><br>         200:  <span style="background-color: white">          /**</span><br>         201:  <span style="background-color: white">           * Given an element, returns all selectors and their rulesets</span><br>         202:  <span style="background-color: white">           * for its descendants. Useful for getting the styles that should be</span><br>         203:  <span style="background-color: white">           * applied to SVG, etc.</span><br>         204:  <span style="background-color: white">           */</span><br>         205:  <span style="background-color: white">  77      public String getCSSForAllDescendants(Element e) {</span><br>         206:  <span style="background-color: white">  77          return _matcher.getCSSForAllDescendants(e);</span><br>         207:  <span style="background-color: white">          }</span><br>         208:  <span style="background-color: white">      </span><br>         209:  <span style="background-color: white"> 99+      public PageInfo getPageStyle(String pageName, String pseudoPage) {</span><br>         210:  <span style="background-color: white"> 99+          return _matcher.getPageCascadedStyle(pageName, pseudoPage);</span><br>         211:  <span style="background-color: white">          }</span><br>         212:  <span style="background-color: white">      </span><br>         213:  <span style="background-color: white">          /**</span><br>         214:  <span style="background-color: white">           * Gets StylesheetInfos for all stylesheets and inline styles associated</span><br>         215:  <span style="background-color: white">           * with the current document. Default (user agent) stylesheet and the inline</span><br>         216:  <span style="background-color: white">           * style for the current media are loaded in the</span><br>         217:  <span style="background-color: white">           * StyleSheetFactory by URI.</span><br>         218:  <span style="background-color: white">           *</span><br>         219:  <span style="background-color: white">           * @return The stylesheets value</span><br>         220:  <span style="background-color: white">           */</span><br>         221:  <span style="background-color: white"> 99+      private List
       <stylesheetinfo>
         getStylesheets() {
       </stylesheetinfo></span><br>         222:  <span style="background-color: white"> 99+          List
       <stylesheetinfo>
         infos = new ArrayList&lt;&gt;();
       </stylesheetinfo></span><br>         223:  <span style="background-color: white"> 99+          long st = System.currentTimeMillis();</span><br>         224:  <span style="background-color: white">      </span><br>         225:  <span style="background-color: white"> 99+          StylesheetInfo defaultStylesheet = _nsh.getDefaultStylesheet(_stylesheetFactory);</span><br>         226:  <span style="background-color: white"> 99+          if (defaultStylesheet != null) {</span><br>         227:  <span style="background-color: white"> 99+              infos.add(defaultStylesheet);</span><br>         228:  <span style="background-color: white">              }</span><br>         229:  <span style="background-color: white">      </span><br>         230:  <span style="background-color: white"> 99+          StylesheetInfo[] refs = _nsh.getStylesheets(_doc);</span><br>         231:  <span style="background-color: white"> 99+          int inlineStyleCount = 0;</span><br>         232:  <span style="background-color: white"> 99+          if (refs != null) {</span><br>         233:  <span style="background-color: white"> 99+              for (StylesheetInfo ref : refs) {</span><br>         234:  <span style="background-color: white"> 99+                  String uri;</span><br>         235:  <span style="background-color: white">      </span><br>         236:  <span style="background-color: white"> 99+                  if (!ref.isInline()) {</span><br>         237:  <span style="background-color: white">   2                      uri = _uac.resolveURI(ref.getUri());</span><br>         238:  <span style="background-color: white">   2                      ref.setUri(uri);</span><br>         239:  <span style="background-color: white">                      } else {</span><br>         240:  <span style="background-color: white"> 99+                      ref.setUri(_uac.getBaseURL() + "#inline_style_" + (++inlineStyleCount));</span><br>         241:  <span style="background-color: white"> 99+                      Stylesheet sheet = _stylesheetFactory.parse(</span><br>         242:  <span style="background-color: white">                                  new StringReader(ref.getContent()), ref);</span><br>         243:  <span style="background-color: white"> 99+                      ref.setStylesheet(sheet);</span><br>         244:  <span style="background-color: white"> 99+                      ref.setUri(null);</span><br>         245:  <span style="background-color: white">                      }</span><br>         246:  <span style="background-color: white">                  }</span><br>         247:  <span style="background-color: white"> 99+              infos.addAll(Arrays.asList(refs));</span><br>         248:  <span style="background-color: white">              }</span><br>         249:  <span style="background-color: white">      </span><br>         250:  <span style="background-color: white">              // TODO: here we should also get user stylesheet from userAgent</span><br>         251:  <span style="background-color: white">      </span><br>         252:  <span style="background-color: white"> 99+          long el = System.currentTimeMillis() - st;</span><br>         253:  <span style="background-color: white"> 99+          XRLog.log(Level.INFO, LogMessageId.LogMessageId1Param.LOAD_PARSE_STYLESHEETS_TIME, el);</span><br>         254:  <span style="background-color: white">      </span><br>         255:  <span style="background-color: white"> 99+          return infos;</span><br>         256:  <span style="background-color: white">          }</span><br>         257:  <span style="background-color: white">      </span><br>         258:  <span style="background-color: white"> 99+      public List
       <fontfacerule>
         getFontFaceRules() {
       </fontfacerule></span><br>         259:  <span style="background-color: white"> 99+          return _matcher.getFontFaceRules();</span><br>         260:  <span style="background-color: white">          }</span><br>         261:  <span style="background-color: white">          </span><br>         262:  <span style="background-color: white">   0      public void setUserAgentCallback(UserAgentCallback userAgentCallback) {</span><br>         263:  <span style="background-color: white">   0          _uac = userAgentCallback;</span><br>         264:  <span style="background-color: white">   0          _stylesheetFactory.setUserAgentCallback(userAgentCallback);</span><br>         265:  <span style="background-color: white">          }</span><br>         266:  <span style="background-color: white">          </span><br>         267:  <span style="background-color: white"> 99+      public void setSupportCMYKColors(boolean b) {</span><br>         268:  <span style="background-color: white"> 99+          _stylesheetFactory.setSupportCMYKColors(b);</span><br>         269:  <span style="background-color: white">          }</span><br>         270:  <span style="background-color: white">      }</span><br>         271:  <span style="background-color: white">      </span><br>         272:  <span style="background-color: white">      /*</span><br>         273:  <span style="background-color: white">       * $Id$</span><br>         274:  <span style="background-color: white">       *</span><br>         275:  <span style="background-color: white">       * $Log$</span><br>         276:  <span style="background-color: white">       * Revision 1.22  2008/07/27 00:21:46  peterbrant</span><br>         277:  <span style="background-color: white">       * Implement CMYK color support for PDF output, starting with patch from Mykola Gurov / Banish java.awt.Color from FS core layout classes</span><br>         278:  <span style="background-color: white">       *</span><br>         279:  <span style="background-color: white">       * Revision 1.21  2008/04/04 13:32:38  peterbrant</span><br>         280:  <span style="background-color: white">       * Fix method name</span><br>         281:  <span style="background-color: white">       *</span><br>         282:  <span style="background-color: white">       * Revision 1.20  2008/04/04 13:28:38  peterbrant</span><br>         283:  <span style="background-color: white">       * Make sure user agent is provided to StyleReference when it's modified / Light cleanup</span><br>         284:  <span style="background-color: white">       *</span><br>         285:  <span style="background-color: white">       * Revision 1.19  2008/01/22 00:29:23  peterbrant</span><br>         286:  <span style="background-color: white">       * Need to propagate changes to user agent in SharedContext to containing StyleReference</span><br>         287:  <span style="background-color: white">       *</span><br>         288:  <span style="background-color: white">       * Revision 1.18  2007/10/31 23:14:42  peterbrant</span><br>         289:  <span style="background-color: white">       * Add rudimentary support for @font-face rules</span><br>         290:  <span style="background-color: white">       *</span><br>         291:  <span style="background-color: white">       * Revision 1.17  2007/08/19 22:22:52  peterbrant</span><br>         292:  <span style="background-color: white">       * Merge R8pbrant changes to HEAD</span><br>         293:  <span style="background-color: white">       *</span><br>         294:  <span style="background-color: white">       * Revision 1.16.2.1  2007/07/09 22:18:04  peterbrant</span><br>         295:  <span style="background-color: white">       * Begin work on running headers and footers and named pages</span><br>         296:  <span style="background-color: white">       *</span><br>         297:  <span style="background-color: white">       * Revision 1.16  2007/05/26 19:04:13  peterbrant</span><br>         298:  <span style="background-color: white">       * Implement support for removing all references to a particular Element (in order to support limited dynamic DOM changes)</span><br>         299:  <span style="background-color: white">       *</span><br>         300:  <span style="background-color: white">       * Revision 1.15  2007/05/20 23:25:34  peterbrant</span><br>         301:  <span style="background-color: white">       * Various code cleanups (e.g. remove unused imports)</span><br>         302:  <span style="background-color: white">       *</span><br>         303:  <span style="background-color: white">       * Patch from Sean Bright</span><br>         304:  <span style="background-color: white">       *</span><br>         305:  <span style="background-color: white">       * Revision 1.14  2007/05/16 22:27:14  peterbrant</span><br>         306:  <span style="background-color: white">       * Only load default stylesheet once</span><br>         307:  <span style="background-color: white">       *</span><br>         308:  <span style="background-color: white">       * Revision 1.13  2007/02/20 23:44:51  peterbrant</span><br>         309:  <span style="background-color: white">       * Minor formatting change</span><br>         310:  <span style="background-color: white">       *</span><br>         311:  <span style="background-color: white">       * Revision 1.12  2007/02/20 01:17:10  peterbrant</span><br>         312:  <span style="background-color: white">       * Start CSS parser cleanup</span><br>         313:  <span style="background-color: white">       *</span><br>         314:  <span style="background-color: white">       * Revision 1.11  2007/02/19 14:53:42  peterbrant</span><br>         315:  <span style="background-color: white">       * Integrate new CSS parser</span><br>         316:  <span style="background-color: white">       *</span><br>         317:  <span style="background-color: white">       * Revision 1.10  2006/09/11 19:23:29  peterbrant</span><br>         318:  <span style="background-color: white">       * Parse element styles all at once</span><br>         319:  <span style="background-color: white">       *</span><br>         320:  <span style="background-color: white">       * Revision 1.9  2006/08/27 00:36:14  peterbrant</span><br>         321:  <span style="background-color: white">       * Initial commit of (initial) R7 work</span><br>         322:  <span style="background-color: white">       *</span><br>         323:  <span style="background-color: white">       * Revision 1.8  2006/01/03 23:02:37  peterbrant</span><br>         324:  <span style="background-color: white">       * Remove unused variable</span><br>         325:  <span style="background-color: white">       *</span><br>         326:  <span style="background-color: white">       * Revision 1.7  2005/12/30 01:32:43  peterbrant</span><br>         327:  <span style="background-color: white">       * First merge of parts of pagination work</span><br>         328:  <span style="background-color: white">       *</span><br>         329:  <span style="background-color: white">       * Revision 1.6  2005/11/11 01:33:15  peterbrant</span><br>         330:  <span style="background-color: white">       * Add ability to clear all cached stylesheets</span><br>         331:  <span style="background-color: white">       *</span><br>         332:  <span style="background-color: white">       * Revision 1.5  2005/10/27 00:08:51  tobega</span><br>         333:  <span style="background-color: white">       * Sorted out Context into RenderingContext and LayoutContext</span><br>         334:  <span style="background-color: white">       *</span><br>         335:  <span style="background-color: white">       * Revision 1.4  2005/06/26 15:48:10  tobega</span><br>         336:  <span style="background-color: white">       * Converted to almost standard html4 default css, which shook out a bug: position should not inherit</span><br>         337:  <span style="background-color: white">       *</span><br>         338:  <span style="background-color: white">       * Revision 1.3  2005/06/25 19:27:46  tobega</span><br>         339:  <span style="background-color: white">       * UAC now supplies Resources</span><br>         340:  <span style="background-color: white">       *</span><br>         341:  <span style="background-color: white">       * Revision 1.2  2005/06/23 17:03:40  tobega</span><br>         342:  <span style="background-color: white">       * css now independent of DOM</span><br>         343:  <span style="background-color: white">       *</span><br>         344:  <span style="background-color: white">       * Revision 1.1  2005/06/22 23:48:40  tobega</span><br>         345:  <span style="background-color: white">       * Refactored the css package to allow a clean separation from the core.</span><br>         346:  <span style="background-color: white">       *</span><br>         347:  <span style="background-color: white">       * Revision 1.34  2005/06/16 12:59:23  pdoubleya</span><br>         348:  <span style="background-color: white">       * Cleaned up support for reloading documents.</span><br>         349:  <span style="background-color: white">       *</span><br>         350:  <span style="background-color: white">       * Revision 1.33  2005/06/16 11:29:12  pdoubleya</span><br>         351:  <span style="background-color: white">       * First cut support for reload page, flushes inline stylesheets.</span><br>         352:  <span style="background-color: white">       *</span><br>         353:  <span style="background-color: white">       * Revision 1.32  2005/06/16 07:24:48  tobega</span><br>         354:  <span style="background-color: white">       * Fixed background image bug.</span><br>         355:  <span style="background-color: white">       * Caching images in browser.</span><br>         356:  <span style="background-color: white">       * Enhanced LinkListener.</span><br>         357:  <span style="background-color: white">       * Some house-cleaning, playing with Idea's code inspection utility.</span><br>         358:  <span style="background-color: white">       *</span><br>         359:  <span style="background-color: white">       * Revision 1.31  2005/06/15 11:53:45  tobega</span><br>         360:  <span style="background-color: white">       * Changed UserAgentCallback to getInputStream instead of getReader. Fixed up some consequences of previous change.</span><br>         361:  <span style="background-color: white">       *</span><br>         362:  <span style="background-color: white">       * Revision 1.30  2005/06/01 21:36:37  tobega</span><br>         363:  <span style="background-color: white">       * Got image scaling working, and did some refactoring along the way</span><br>         364:  <span style="background-color: white">       *</span><br>         365:  <span style="background-color: white">       * Revision 1.29  2005/05/17 06:56:23  tobega</span><br>         366:  <span style="background-color: white">       * Inline backgrounds now work correctly, as does mixing of inlines and blocks for style inheritance</span><br>         367:  <span style="background-color: white">       *</span><br>         368:  <span style="background-color: white">       * Revision 1.28  2005/05/08 15:37:29  tobega</span><br>         369:  <span style="background-color: white">       * Fixed up style caching so it really works (internalize CascadedStyles and let each CalculatedStyle keep track of its derived children)</span><br>         370:  <span style="background-color: white">       *</span><br>         371:  <span style="background-color: white">       * Revision 1.27  2005/05/08 14:51:22  tobega</span><br>         372:  <span style="background-color: white">       * Removed the need for the Styler</span><br>         373:  <span style="background-color: white">       *</span><br>         374:  <span style="background-color: white">       * Revision 1.26  2005/05/08 14:36:54  tobega</span><br>         375:  <span style="background-color: white">       * Refactored away the need for having a context in a CalculatedStyle</span><br>         376:  <span style="background-color: white">       *</span><br>         377:  <span style="background-color: white">       * Revision 1.25  2005/03/24 23:18:38  pdoubleya</span><br>         378:  <span style="background-color: white">       * Added use of SharedContext (Kevin).</span><br>         379:  <span style="background-color: white">       *</span><br>         380:  <span style="background-color: white">       * Revision 1.24  2005/01/29 20:19:22  pdoubleya</span><br>         381:  <span style="background-color: white">       * Clean/reformat code. Removed commented blocks, checked copyright.</span><br>         382:  <span style="background-color: white">       *</span><br>         383:  <span style="background-color: white">       * Revision 1.23  2005/01/29 12:49:24  pdoubleya</span><br>         384:  <span style="background-color: white">       * Fixed cast on get...PropertiesMap().</span><br>         385:  <span style="background-color: white">       *</span><br>         386:  <span style="background-color: white">       * Revision 1.22  2005/01/24 19:01:09  pdoubleya</span><br>         387:  <span style="background-color: white">       * Mass checkin. Changed to use references to CSSName, which now has a Singleton instance for each property, everywhere property names were being used before. Removed commented code. Cascaded and Calculated style now store properties in arrays rather than maps, for optimization.</span><br>         388:  <span style="background-color: white">       *</span><br>         389:  <span style="background-color: white">       * Revision 1.21  2005/01/24 14:36:30  pdoubleya</span><br>         390:  <span style="background-color: white">       * Mass commit, includes: updated for changes to property declaration instantiation, and new use of DerivedValue. Removed any references to older XR... classes (e.g. XRProperty). Cleaned imports.</span><br>         391:  <span style="background-color: white">       *</span><br>         392:  <span style="background-color: white">       * Revision 1.20  2005/01/16 18:50:03  tobega</span><br>         393:  <span style="background-color: white">       * Re-introduced caching of styles, which make hamlet and alice scroll nicely again. Background painting still slow though.</span><br>         394:  <span style="background-color: white">       *</span><br>         395:  <span style="background-color: white">       * Revision 1.19  2005/01/08 15:56:54  tobega</span><br>         396:  <span style="background-color: white">       * Further work on extensibility interfaces. Documented it - see website.</span><br>         397:  <span style="background-color: white">       *</span><br>         398:  <span style="background-color: white">       * Revision 1.18  2005/01/08 11:55:16  tobega</span><br>         399:  <span style="background-color: white">       * Started massaging the extension interfaces</span><br>         400:  <span style="background-color: white">       *</span><br>         401:  <span style="background-color: white">       * Revision 1.17  2005/01/04 10:19:11  tobega</span><br>         402:  <span style="background-color: white">       * resolve selectors to styles direcly on match, should reduce memory footprint and not affect speed very much.</span><br>         403:  <span style="background-color: white">       *</span><br>         404:  <span style="background-color: white">       * Revision 1.16  2005/01/03 23:40:40  tobega</span><br>         405:  <span style="background-color: white">       * Cleaned out unnecessary styling/matching code. styling/matching is now called during boxing/rendering rather than as a separate stage.</span><br>         406:  <span style="background-color: white">       *</span><br>         407:  <span style="background-color: white">       * Revision 1.15  2004/12/29 10:39:27  tobega</span><br>         408:  <span style="background-color: white">       * Separated current state Context into LayoutContext and the rest into SharedContext.</span><br>         409:  <span style="background-color: white">       *</span><br>         410:  <span style="background-color: white">       * Revision 1.14  2004/12/28 01:48:22  tobega</span><br>         411:  <span style="background-color: white">       * More cleaning. Magically, the financial report demo is starting to look reasonable, without any effort being put on it.</span><br>         412:  <span style="background-color: white">       *</span><br>         413:  <span style="background-color: white">       * Revision 1.13  2004/12/11 18:18:08  tobega</span><br>         414:  <span style="background-color: white">       * Still broken, won't even compile at the moment. Working hard to fix it, though. Replace the StyleReference interface with our only concrete implementation, it was a bother changing in two places all the time.</span><br>         415:  <span style="background-color: white">       *</span><br>         416:  <span style="background-color: white">       * Revision 1.22  2004/12/05 18:11:36  tobega</span><br>         417:  <span style="background-color: white">       * Now uses style cache for pseudo-element styles. Also started preparing to replace inline node handling with inline content handling.</span><br>         418:  <span style="background-color: white">       *</span><br>         419:  <span style="background-color: white">       * Revision 1.21  2004/12/05 14:35:38  tobega</span><br>         420:  <span style="background-color: white">       * Cleaned up some usages of Node (and removed unused stuff) in layout code. The goal is to pass "better" objects than Node wherever possible in an attempt to shake out the bugs in tree-traversal (probably often unnecessary tree-traversal)</span><br>         421:  <span style="background-color: white">       *</span><br>         422:  <span style="background-color: white">       * Revision 1.20  2004/12/05 00:48:53  tobega</span><br>         423:  <span style="background-color: white">       * Cleaned up so that now all property-lookups use the CalculatedStyle. Also added support for relative values of top, left, width, etc.</span><br>         424:  <span style="background-color: white">       *</span><br>         425:  <span style="background-color: white">       * Revision 1.19  2004/12/02 19:46:35  tobega</span><br>         426:  <span style="background-color: white">       * Refactored handling of inline styles to fit with StylesheetInfo and media handling (is also now correct if there should be more than one style element)</span><br>         427:  <span style="background-color: white">       *</span><br>         428:  <span style="background-color: white">       * Revision 1.18  2004/12/01 14:02:51  joshy</span><br>         429:  <span style="background-color: white">       * modified media to use the value from the rendering context</span><br>         430:  <span style="background-color: white">       * added the inline-block box</span><br>         431:  <span style="background-color: white">       * - j</span><br>         432:  <span style="background-color: white">       *</span><br>         433:  <span style="background-color: white">       * Revision 1.17  2004/11/30 23:47:56  tobega</span><br>         434:  <span style="background-color: white">       * At-media rules should now work (not tested). Also fixed at-import rules, which got broken at previous modification.</span><br>         435:  <span style="background-color: white">       *</span><br>         436:  <span style="background-color: white">       * Revision 1.16  2004/11/29 23:25:37  tobega</span><br>         437:  <span style="background-color: white">       * Had to redo thinking about Stylesheets and StylesheetInfos. Now StylesheetInfos are passed around instead of Stylesheets because any Stylesheet should only be linked to its URI. Bonus: the external sheets get lazy-loaded only if needed for the medium.</span><br>         438:  <span style="background-color: white">       *</span><br>         439:  <span style="background-color: white">       * Revision 1.15  2004/11/28 23:29:00  tobega</span><br>         440:  <span style="background-color: white">       * Now handles media on Stylesheets, still need to handle at-media-rules. The media-type should be set in Context.media (set by default to "screen") before calling setContext on StyleReference.</span><br>         441:  <span style="background-color: white">       *</span><br>         442:  <span style="background-color: white">       * Revision 1.14  2004/11/15 22:22:08  tobega</span><br>         443:  <span style="background-color: white">       * Now handles @import stylesheets</span><br>         444:  <span style="background-color: white">       *</span><br>         445:  <span style="background-color: white">       * Revision 1.13  2004/11/15 19:46:13  tobega</span><br>         446:  <span style="background-color: white">       * Refactoring in preparation for handling @import stylesheets</span><br>         447:  <span style="background-color: white">       *</span><br>         448:  <span style="background-color: white">       * Revision 1.12  2004/11/15 12:42:22  pdoubleya</span><br>         449:  <span style="background-color: white">       * Across this checkin (all may not apply to this particular file)</span><br>         450:  <span style="background-color: white">       * Changed default/package-access members to private.</span><br>         451:  <span style="background-color: white">       * Changed to use XRRuntimeException where appropriate.</span><br>         452:  <span style="background-color: white">       * Began move from System.err.println to std logging.</span><br>         453:  <span style="background-color: white">       * Standard code reformat.</span><br>         454:  <span style="background-color: white">       * Removed some unnecessary SAC member variables that were only used in initialization.</span><br>         455:  <span style="background-color: white">       * CVS log section.</span><br>         456:  <span style="background-color: white">       *</span><br>         457:  <span style="background-color: white">       *</span><br>         458:  <span style="background-color: white">       */</span><br>         459:  <span style="background-color: white">      </span><br></pre> </code> 
   </div> 
   <div class="column"> 
    <h2>Patched Code:</h2> <code> <pre id="patched-trace">        1-&gt;N:  <span style="background-color: white">      /*</span><br>        2-&gt;N:  <span style="background-color: white">       * StyleReference.java</span><br>        3-&gt;N:  <span style="background-color: white">       * Copyright (c) 2004, 2005 Torbjoern Gannholm</span><br>        4-&gt;N:  <span style="background-color: white">       *</span><br>        5-&gt;N:  <span style="background-color: white">       * This program is free software; you can redistribute it and/or</span><br>        6-&gt;N:  <span style="background-color: white">       * modify it under the terms of the GNU Lesser General Public License</span><br>        7-&gt;N:  <span style="background-color: white">       * as published by the Free Software Foundation; either version 2.1</span><br>        8-&gt;N:  <span style="background-color: white">       * of the License, or (at your option) any later version.</span><br>        9-&gt;N:  <span style="background-color: white">       *</span><br>       10-&gt;N:  <span style="background-color: white">       * This program is distributed in the hope that it will be useful,</span><br>       11-&gt;N:  <span style="background-color: white">       * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br>       12-&gt;N:  <span style="background-color: white">       * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the</span><br>       13-&gt;N:  <span style="background-color: white">       * GNU Lesser General Public License for more details.</span><br>       14-&gt;N:  <span style="background-color: white">       *</span><br>       15-&gt;N:  <span style="background-color: white">       * You should have received a copy of the GNU Lesser General Public License</span><br>       16-&gt;N:  <span style="background-color: white">       * along with this program; if not, write to the Free Software</span><br>       17-&gt;N:  <span style="background-color: white">       * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span><br>       18-&gt;N:  <span style="background-color: white">       *</span><br>       19-&gt;N:  <span style="background-color: white">       */</span><br>       20-&gt;N:  <span style="background-color: white">      package com.openhtmltopdf.context;</span><br>       21-&gt;N:  <span style="background-color: white">      </span><br>       22-&gt;N:  <span style="background-color: white">      import java.io.StringReader;</span><br>       23-&gt;N:  <span style="background-color: white">      import java.util.ArrayList;</span><br>       24-&gt;N:  <span style="background-color: white">      import java.util.Arrays;</span><br>       25-&gt;N:  <span style="background-color: white">      import java.util.List;</span><br>       26-&gt;N:  <span style="background-color: white">      import java.util.logging.Level;</span><br>       27-&gt;N:  <span style="background-color: white">      </span><br>       28-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.FontFaceRule;</span><br>       29-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.LogMessageId;</span><br>       30-&gt;N:  <span style="background-color: white">      import org.w3c.dom.Document;</span><br>       31-&gt;N:  <span style="background-color: white">      import org.w3c.dom.Element;</span><br>       32-&gt;N:  <span style="background-color: white">      import org.w3c.dom.Node;</span><br>       33-&gt;N:  <span style="background-color: white">      </span><br>       34-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.CSSName;</span><br>       35-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.extend.AttributeResolver;</span><br>       36-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.extend.lib.DOMTreeResolver;</span><br>       37-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.CascadedStyle;</span><br>       38-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.PageInfo;</span><br>       39-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.CSSPrimitiveValue;</span><br>       40-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.PropertyDeclaration;</span><br>       41-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.Stylesheet;</span><br>       42-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.StylesheetInfo;</span><br>       43-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.CalculatedStyle;</span><br>       44-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.extend.NamespaceHandler;</span><br>       45-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.extend.UserAgentCallback;</span><br>       46-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.extend.UserInterface;</span><br>       47-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.SharedContext;</span><br>       48-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.XRLog;</span><br>       49-&gt;N:  <span style="background-color: white">      </span><br>       50-&gt;N:  <span style="background-color: white">      </span><br>       51-&gt;N:  <span style="background-color: white">      /**</span><br>       52-&gt;N:  <span style="background-color: white">       * @author Torbjoern Gannholm</span><br>       53-&gt;N:  <span style="background-color: white">       */</span><br>       54-&gt;N:  <span style="background-color: white">      public class StyleReference {</span><br>       55-&gt;N:  <span style="background-color: white">          /**</span><br>       56-&gt;N:  <span style="background-color: white">           * The Context this StyleReference operates in; used for property</span><br>       57-&gt;N:  <span style="background-color: white">           * resolution.</span><br>       58-&gt;N:  <span style="background-color: white">           */</span><br>      59-&gt;59:  <span style="background-color: white">          private SharedContext _context;</span><br>      60-&gt;60:  <span style="background-color: white">          private NamespaceHandler _nsh;</span><br>      61-&gt;61:  <span style="background-color: white">          private Document _doc;</span><br>      62-&gt;62:  <span style="background-color: white">          private final StylesheetFactoryImpl _stylesheetFactory;</span><br>       63-&gt;N:  <span style="background-color: white">      </span><br>       64-&gt;N:  <span style="background-color: white">          /**</span><br>       65-&gt;N:  <span style="background-color: white">           * Instance of our element-styles matching class. Will be null if new rules</span><br>       66-&gt;N:  <span style="background-color: white">           * have been added since last match.</span><br>       67-&gt;N:  <span style="background-color: white">           */</span><br>      68-&gt;68:  <span style="background-color: white">          private com.openhtmltopdf.css.newmatch.Matcher _matcher;</span><br>       69-&gt;N:  <span style="background-color: white">      </span><br>      70-&gt;70:  <span style="background-color: white">          private UserAgentCallback _uac;</span><br>       71-&gt;N:  <span style="background-color: white">          </span><br>      72-&gt;72:  <span style="background-color: cyan"> 99+      public StyleReference(UserAgentCallback userAgent) {</span><br>      73-&gt;73:  <span style="background-color: cyan"> 99+          _uac = userAgent;</span><br>      74-&gt;74:  <span style="background-color: cyan"> 99+          _stylesheetFactory = new StylesheetFactoryImpl(userAgent);</span><br>       75-&gt;N:  <span style="background-color: white">          }</span><br>       76-&gt;N:  <span style="background-color: white">      </span><br>       77-&gt;N:  <span style="background-color: white">          /**</span><br>       78-&gt;N:  <span style="background-color: white">           * Gets the style of the root element, should be html tag.</span><br>       79-&gt;N:  <span style="background-color: white">           */</span><br>      80-&gt;80:  <span style="background-color: white">  30      public CalculatedStyle getRootElementStyle() {</span><br>      81-&gt;81:  <span style="background-color: white">  30          if (_context != null &amp;&amp; _doc != null) {</span><br>       82-&gt;N:  <span style="background-color: white">  30              return _context.getStyle(_doc.getDocumentElement());</span><br>       83-&gt;N:  <span style="background-color: white">              } else {</span><br>      84-&gt;84:  <span style="background-color: white">   0              return null;</span><br>       85-&gt;N:  <span style="background-color: white">              }</span><br>       86-&gt;N:  <span style="background-color: white">          }</span><br>       87-&gt;N:  <span style="background-color: white">      </span><br>       88-&gt;N:  <span style="background-color: white">          /**</span><br>       89-&gt;N:  <span style="background-color: white">           * Sets the documentContext attribute of the StyleReference object</span><br>       90-&gt;N:  <span style="background-color: white">           *</span><br>       91-&gt;N:  <span style="background-color: white">           * @param context The new documentContext value</span><br>       92-&gt;N:  <span style="background-color: white">           * @param nsh     The new documentContext value</span><br>       93-&gt;N:  <span style="background-color: white">           * @param doc     The new documentContext value</span><br>       94-&gt;N:  <span style="background-color: white">           * @param ui</span><br>       95-&gt;N:  <span style="background-color: white">           */</span><br>      96-&gt;96:  <span style="background-color: cyan"> 99+      public void setDocumentContext(SharedContext context, NamespaceHandler nsh, Document doc, UserInterface ui) {</span><br>      97-&gt;97:  <span style="background-color: cyan"> 99+          _context = context;</span><br>      98-&gt;98:  <span style="background-color: cyan"> 99+          _nsh = nsh;</span><br>      99-&gt;99:  <span style="background-color: cyan"> 99+          _doc = doc;</span><br>    100-&gt;100:  <span style="background-color: cyan"> 99+          AttributeResolver attRes = new StandardAttributeResolver(_nsh, _uac, ui);</span><br>      101-&gt;N:  <span style="background-color: white">      </span><br>    102-&gt;102:  <span style="background-color: cyan"> 99+          List
       <stylesheetinfo>
         infos = getStylesheets();
       </stylesheetinfo></span><br>      103-&gt;N:  <span style="background-color: white">      </span><br>    104-&gt;104:  <span style="background-color: cyan"> 99+          XRLog.log(Level.INFO, LogMessageId.LogMessageId1Param.MATCH_MEDIA_IS, _context.getMedia());</span><br>      105-&gt;N:  <span style="background-color: white">              </span><br>      106-&gt;N:  <span style="background-color: white"> 99+          _matcher = new com.openhtmltopdf.css.newmatch.Matcher(</span><br>    107-&gt;107:  <span style="background-color: white">                      new DOMTreeResolver(), </span><br>    108-&gt;108:  <span style="background-color: white">                      attRes, </span><br>      109-&gt;N:  <span style="background-color: white">                      _stylesheetFactory, </span><br>    110-&gt;110:  <span style="background-color: white">                      readAndParseAll(infos, _context.getMedia()), </span><br>      111-&gt;N:  <span style="background-color: white">                      _context.getMedia());</span><br>      112-&gt;N:  <span style="background-color: white">          }</span><br>      113-&gt;N:  <span style="background-color: white">          </span><br>    114-&gt;114:  <span style="background-color: cyan"> 99+      private List
       <stylesheet>
         readAndParseAll(List
        <stylesheetinfo>
          infos, String medium) {
        </stylesheetinfo>
       </stylesheet></span><br>    115-&gt;115:  <span style="background-color: cyan"> 99+          List
       <stylesheet>
         result = new ArrayList&lt;&gt;(infos.size() + 15);
       </stylesheet></span><br>      116-&gt;N:  <span style="background-color: white">              </span><br>    117-&gt;117:  <span style="background-color: cyan"> 99+          for (StylesheetInfo info : infos) {</span><br>    118-&gt;118:  <span style="background-color: cyan"> 99+              if (info.appliesToMedia(medium)) {</span><br>    119-&gt;119:  <span style="background-color: cyan"> 99+                  Stylesheet sheet = info.getStylesheet();</span><br>      120-&gt;N:  <span style="background-color: white">                      </span><br>    121-&gt;121:  <span style="background-color: cyan"> 99+                  if (sheet == null) {</span><br>    122-&gt;122:  <span style="background-color: white">  23                      sheet = _stylesheetFactory.getStylesheet(info);</span><br>      123-&gt;N:  <span style="background-color: white">                      }</span><br>      124-&gt;N:  <span style="background-color: white">                      </span><br>    125-&gt;125:  <span style="background-color: cyan"> 99+                  if (sheet != null) {</span><br>    126-&gt;126:  <span style="background-color: cyan"> 99+                      if (sheet.getImportRules().size() &gt; 0) {</span><br>    127-&gt;127:  <span style="background-color: white">  21                          result.addAll(readAndParseAll(sheet.getImportRules(), medium));</span><br>      128-&gt;N:  <span style="background-color: white">                          }</span><br>      129-&gt;N:  <span style="background-color: white">                          </span><br>    130-&gt;130:  <span style="background-color: cyan"> 99+                      result.add(sheet);</span><br>      131-&gt;N:  <span style="background-color: white">                      } else {</span><br>    132-&gt;132:  <span style="background-color: white">   2                      XRLog.log(Level.WARNING, LogMessageId.LogMessageId1Param.LOAD_UNABLE_TO_LOAD_CSS_FROM_URI, info.getUri());</span><br>      133-&gt;N:  <span style="background-color: white">                      }</span><br>      134-&gt;N:  <span style="background-color: white">                  }</span><br>      135-&gt;N:  <span style="background-color: white">              }</span><br>      136-&gt;N:  <span style="background-color: white">              </span><br>    137-&gt;137:  <span style="background-color: cyan"> 99+          return result;</span><br>      138-&gt;N:  <span style="background-color: white">          }</span><br>      139-&gt;N:  <span style="background-color: white">      </span><br>    140-&gt;140:  <span style="background-color: white">   0      public boolean isHoverStyled(Element e) {</span><br>    141-&gt;141:  <span style="background-color: white">   0          return _matcher.isHoverStyled(e);</span><br>      142-&gt;N:  <span style="background-color: white">          }</span><br>      143-&gt;N:  <span style="background-color: white">      </span><br>      144-&gt;N:  <span style="background-color: white">          /**</span><br>      145-&gt;N:  <span style="background-color: white">           * Returns a Map keyed by CSS property names (e.g. 'border-width'), and the</span><br>      146-&gt;N:  <span style="background-color: white">           * assigned value as a SAC CSSValue instance. The properties should have</span><br>      147-&gt;N:  <span style="background-color: white">           * been matched to the element when the Context was established for this</span><br>      148-&gt;N:  <span style="background-color: white">           * StyleReference on the Document to which the Element belongs.</span><br>      149-&gt;N:  <span style="background-color: white">           * </span><br>      150-&gt;N:  <span style="background-color: white">           * Only used by broken DOM inspector.</span><br>      151-&gt;N:  <span style="background-color: white">           *</span><br>      152-&gt;N:  <span style="background-color: white">           * @param e The DOM Element for which to find properties</span><br>      153-&gt;N:  <span style="background-color: white">           * @return Map of CSS property names to CSSValue instance assigned to it.</span><br>      154-&gt;N:  <span style="background-color: white">           */</span><br>    155-&gt;155:  <span style="background-color: white">   0      @Deprecated</span><br>    156-&gt;156:  <span style="background-color: white">      	public java.util.Map
       <string, cssprimitivevalue>
         getCascadedPropertiesMap(Element e) {
       </string,></span><br>    157-&gt;157:  <span style="background-color: white">   0          CascadedStyle cs = _matcher.getCascadedStyle(e, false);</span><br>      158-&gt;N:  <span style="background-color: white">              </span><br>    159-&gt;159:  <span style="background-color: white">   0  		java.util.Map
       <string, cssprimitivevalue>
         props = new java.util.LinkedHashMap&lt;&gt;();
       </string,></span><br>      160-&gt;N:  <span style="background-color: white">      		</span><br>    161-&gt;161:  <span style="background-color: white">   0  		for (PropertyDeclaration pd : cs.getCascadedPropertyDeclarations()) {</span><br>    162-&gt;162:  <span style="background-color: white">   0              String propName = pd.getPropertyName();</span><br>    163-&gt;163:  <span style="background-color: white">   0              CSSName cssName = CSSName.getByPropertyName(propName);</span><br>    164-&gt;164:  <span style="background-color: white">   0              props.put(propName, cs.propertyByName(cssName).getValue());</span><br>      165-&gt;N:  <span style="background-color: white">              }</span><br>      166-&gt;N:  <span style="background-color: white">      		</span><br>    167-&gt;167:  <span style="background-color: white">   0          return props;</span><br>      168-&gt;N:  <span style="background-color: white">          }</span><br>      169-&gt;N:  <span style="background-color: white">      </span><br>      170-&gt;N:  <span style="background-color: white">          /**</span><br>      171-&gt;N:  <span style="background-color: white">           * Gets the pseudoElementStyle attribute of the StyleReference object</span><br>      172-&gt;N:  <span style="background-color: white">           *</span><br>      173-&gt;N:  <span style="background-color: white">           * @param node          PARAM</span><br>      174-&gt;N:  <span style="background-color: white">           * @param pseudoElement PARAM</span><br>      175-&gt;N:  <span style="background-color: white">           * @return The pseudoElementStyle value</span><br>      176-&gt;N:  <span style="background-color: white">           */</span><br>    177-&gt;177:  <span style="background-color: cyan"> 99+      public CascadedStyle getPseudoElementStyle(Node node, String pseudoElement) {</span><br>    178-&gt;178:  <span style="background-color: cyan"> 99+          Element e = null;</span><br>    179-&gt;179:  <span style="background-color: cyan"> 99+          if (node.getNodeType() == Node.ELEMENT_NODE) {</span><br>    180-&gt;180:  <span style="background-color: cyan"> 99+              e = (Element) node;</span><br>      181-&gt;N:  <span style="background-color: white">              } else {</span><br>    182-&gt;182:  <span style="background-color: white">   0              e = (Element) node.getParentNode();</span><br>      183-&gt;N:  <span style="background-color: white">              }</span><br>    184-&gt;184:  <span style="background-color: cyan"> 99+          return _matcher.getPECascadedStyle(e, pseudoElement);</span><br>      185-&gt;N:  <span style="background-color: white">          }</span><br>      186-&gt;N:  <span style="background-color: white">      </span><br>      187-&gt;N:  <span style="background-color: white">          /**</span><br>      188-&gt;N:  <span style="background-color: white">           * Gets the CascadedStyle for an element. This must then be converted in the</span><br>      189-&gt;N:  <span style="background-color: white">           * current context to a CalculatedStyle (use getDerivedStyle)</span><br>      190-&gt;N:  <span style="background-color: white">           *</span><br>      191-&gt;N:  <span style="background-color: white">           * @param e       The element</span><br>      192-&gt;N:  <span style="background-color: white">           * @param restyle</span><br>      193-&gt;N:  <span style="background-color: white">           * @return The style value</span><br>      194-&gt;N:  <span style="background-color: white">           */</span><br>    195-&gt;195:  <span style="background-color: cyan"> 99+      public CascadedStyle getCascadedStyle(Element e, boolean restyle) {</span><br>    196-&gt;196:  <span style="background-color: cyan"> 99+          if (e == null) return CascadedStyle.emptyCascadedStyle;</span><br>    197-&gt;197:  <span style="background-color: cyan"> 99+          return _matcher.getCascadedStyle(e, restyle);</span><br>      198-&gt;N:  <span style="background-color: white">          }</span><br>      199-&gt;N:  <span style="background-color: white">      </span><br>      200-&gt;N:  <span style="background-color: white">          /**</span><br>      201-&gt;N:  <span style="background-color: white">           * Given an element, returns all selectors and their rulesets</span><br>      202-&gt;N:  <span style="background-color: white">           * for its descendants. Useful for getting the styles that should be</span><br>      203-&gt;N:  <span style="background-color: white">           * applied to SVG, etc.</span><br>      204-&gt;N:  <span style="background-color: white">           */</span><br>    205-&gt;205:  <span style="background-color: white">  77      public String getCSSForAllDescendants(Element e) {</span><br>    206-&gt;206:  <span style="background-color: white">  77          return _matcher.getCSSForAllDescendants(e);</span><br>      207-&gt;N:  <span style="background-color: white">          }</span><br>      208-&gt;N:  <span style="background-color: white">      </span><br>    209-&gt;209:  <span style="background-color: cyan"> 99+      public PageInfo getPageStyle(String pageName, String pseudoPage) {</span><br>    210-&gt;210:  <span style="background-color: cyan"> 99+          return _matcher.getPageCascadedStyle(pageName, pseudoPage);</span><br>      211-&gt;N:  <span style="background-color: white">          }</span><br>      212-&gt;N:  <span style="background-color: white">      </span><br>      213-&gt;N:  <span style="background-color: white">          /**</span><br>      214-&gt;N:  <span style="background-color: white">           * Gets StylesheetInfos for all stylesheets and inline styles associated</span><br>      215-&gt;N:  <span style="background-color: white">           * with the current document. Default (user agent) stylesheet and the inline</span><br>      216-&gt;N:  <span style="background-color: white">           * style for the current media are loaded in the</span><br>      217-&gt;N:  <span style="background-color: white">           * StyleSheetFactory by URI.</span><br>      218-&gt;N:  <span style="background-color: white">           *</span><br>      219-&gt;N:  <span style="background-color: white">           * @return The stylesheets value</span><br>      220-&gt;N:  <span style="background-color: white">           */</span><br>    221-&gt;221:  <span style="background-color: cyan"> 99+      private List
       <stylesheetinfo>
         getStylesheets() {
       </stylesheetinfo></span><br>    222-&gt;222:  <span style="background-color: cyan"> 99+          List
       <stylesheetinfo>
         infos = new ArrayList&lt;&gt;();
       </stylesheetinfo></span><br>    223-&gt;223:  <span style="background-color: cyan"> 99+          long st = System.currentTimeMillis();</span><br>      224-&gt;N:  <span style="background-color: white">      </span><br>    225-&gt;225:  <span style="background-color: cyan"> 99+          StylesheetInfo defaultStylesheet = _nsh.getDefaultStylesheet(_stylesheetFactory);</span><br>    226-&gt;226:  <span style="background-color: cyan"> 99+          if (defaultStylesheet != null) {</span><br>    227-&gt;227:  <span style="background-color: cyan"> 99+              infos.add(defaultStylesheet);</span><br>      228-&gt;N:  <span style="background-color: white">              }</span><br>      229-&gt;N:  <span style="background-color: white">      </span><br>    230-&gt;230:  <span style="background-color: cyan"> 99+          StylesheetInfo[] refs = _nsh.getStylesheets(_doc);</span><br>    231-&gt;231:  <span style="background-color: cyan"> 99+          int inlineStyleCount = 0;</span><br>    232-&gt;232:  <span style="background-color: cyan"> 99+          if (refs != null) {</span><br>    233-&gt;233:  <span style="background-color: cyan"> 99+              for (StylesheetInfo ref : refs) {</span><br>    234-&gt;234:  <span style="background-color: cyan"> 99+                  String uri;</span><br>      235-&gt;N:  <span style="background-color: white">      </span><br>    236-&gt;236:  <span style="background-color: cyan"> 99+                  if (!ref.isInline()) {</span><br>    237-&gt;237:  <span style="background-color: white">   2                      uri = _uac.resolveURI(ref.getUri());</span><br>    238-&gt;238:  <span style="background-color: white">   2                      ref.setUri(uri);</span><br>      239-&gt;N:  <span style="background-color: white">                      } else {</span><br>    240-&gt;240:  <span style="background-color: cyan"> 99+                      ref.setUri(_uac.getBaseURL() + "#inline_style_" + (++inlineStyleCount));</span><br>    241-&gt;241:  <span style="background-color: cyan"> 99+                      Stylesheet sheet = _stylesheetFactory.parse(</span><br>    242-&gt;242:  <span style="background-color: white">                                  new StringReader(ref.getContent()), ref);</span><br>    243-&gt;243:  <span style="background-color: cyan"> 99+                      ref.setStylesheet(sheet);</span><br>    244-&gt;244:  <span style="background-color: cyan"> 99+                      ref.setUri(null);</span><br>      245-&gt;N:  <span style="background-color: white">                      }</span><br>      246-&gt;N:  <span style="background-color: white">                  }</span><br>    247-&gt;247:  <span style="background-color: cyan"> 99+              infos.addAll(Arrays.asList(refs));</span><br>      248-&gt;N:  <span style="background-color: white">              }</span><br>      249-&gt;N:  <span style="background-color: white">      </span><br>      250-&gt;N:  <span style="background-color: white">              // TODO: here we should also get user stylesheet from userAgent</span><br>      251-&gt;N:  <span style="background-color: white">      </span><br>    252-&gt;252:  <span style="background-color: cyan"> 99+          long el = System.currentTimeMillis() - st;</span><br>    253-&gt;253:  <span style="background-color: cyan"> 99+          XRLog.log(Level.INFO, LogMessageId.LogMessageId1Param.LOAD_PARSE_STYLESHEETS_TIME, el);</span><br>      254-&gt;N:  <span style="background-color: white">      </span><br>    255-&gt;255:  <span style="background-color: cyan"> 99+          return infos;</span><br>      256-&gt;N:  <span style="background-color: white">          }</span><br>      257-&gt;N:  <span style="background-color: white">      </span><br>    258-&gt;258:  <span style="background-color: cyan"> 99+      public List
       <fontfacerule>
         getFontFaceRules() {
       </fontfacerule></span><br>      259-&gt;N:  <span style="background-color: white"> 99+          return _matcher.getFontFaceRules();</span><br>      260-&gt;N:  <span style="background-color: white">          }</span><br>      261-&gt;N:  <span style="background-color: white">          </span><br>    262-&gt;262:  <span style="background-color: white">   0      public void setUserAgentCallback(UserAgentCallback userAgentCallback) {</span><br>    263-&gt;263:  <span style="background-color: white">   0          _uac = userAgentCallback;</span><br>    264-&gt;264:  <span style="background-color: white">   0          _stylesheetFactory.setUserAgentCallback(userAgentCallback);</span><br>      265-&gt;N:  <span style="background-color: white">          }</span><br>      266-&gt;N:  <span style="background-color: white">          </span><br>    267-&gt;267:  <span style="background-color: cyan"> 99+      public void setSupportCMYKColors(boolean b) {</span><br>    268-&gt;268:  <span style="background-color: cyan"> 99+          _stylesheetFactory.setSupportCMYKColors(b);</span><br>      269-&gt;N:  <span style="background-color: white">          }</span><br>      270-&gt;N:  <span style="background-color: white">      }</span><br></pre> </code> 
   </div> 
  </div>  
 </body>
</html>
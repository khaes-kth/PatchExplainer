<!doctype html>
<html lang="en"> 
 <head> 
  <meta charset="UTF-8"> 
  <title>Execution Trace Diff</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <style>
* {
  box-sizing: border-box;
}

/* Create two equal columns that floats next to each other */
.column {
  float: left;
  width: 50%;
  padding: 10px;
  height: 300px; /* Should be removed. Only for demonstration */
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

.test {
    border: 1px solid darkblue;
    padding-left: 10px;
}
</style> 
 </head> 
 <body> 
  <div class="row test"> 
   <h2>Differencing Test:</h2> <code> <pre>@Test <br>
public void test_main(){ <br>
    String ret = NumberAnalyzer.analyze(1); <br>
    assertThat(ret, containsString("greater")); <br>
}
        </pre> </code> 
  </div> 
  <div class="row"> 
   <div class="column"> 
    <h2>Original Code:</h2> <code> <pre id="original-trace">           1:  <span style="background-color: white">      package com.openhtmltopdf.visualtest;</span><br>           2:  <span style="background-color: white">      </span><br>           3:  <span style="background-color: white">      import java.awt.Color;</span><br>           4:  <span style="background-color: white">      import java.awt.Graphics2D;</span><br>           5:  <span style="background-color: white">      import java.awt.Polygon;</span><br>           6:  <span style="background-color: white">      import java.awt.Shape;</span><br>           7:  <span style="background-color: white">      import java.awt.geom.AffineTransform;</span><br>           8:  <span style="background-color: white">      import java.awt.geom.Rectangle2D;</span><br>           9:  <span style="background-color: white">      import java.io.File;</span><br>          10:  <span style="background-color: white">      import java.io.IOException;</span><br>          11:  <span style="background-color: white">      import java.io.InputStream;</span><br>          12:  <span style="background-color: white">      import java.io.PrintWriter;</span><br>          13:  <span style="background-color: white">      import java.io.StringWriter;</span><br>          14:  <span style="background-color: white">      import java.nio.file.Files;</span><br>          15:  <span style="background-color: white">      import java.util.HashMap;</span><br>          16:  <span style="background-color: white">      import java.util.List;</span><br>          17:  <span style="background-color: white">      import java.util.Locale;</span><br>          18:  <span style="background-color: white">      import java.util.Map;</span><br>          19:  <span style="background-color: white">      import java.util.logging.Level;</span><br>          20:  <span style="background-color: white">      import java.util.regex.Matcher;</span><br>          21:  <span style="background-color: white">      import java.util.regex.Pattern;</span><br>          22:  <span style="background-color: white">      import java.util.stream.Collectors;</span><br>          23:  <span style="background-color: white">      </span><br>          24:  <span style="background-color: white">      import javax.imageio.ImageIO;</span><br>          25:  <span style="background-color: white">      </span><br>          26:  <span style="background-color: white">      import com.openhtmltopdf.util.Diagnostic;</span><br>          27:  <span style="background-color: white">      import com.openhtmltopdf.util.XRLog;</span><br>          28:  <span style="background-color: white">      </span><br>          29:  <span style="background-color: white">      import org.apache.pdfbox.io.IOUtils;</span><br>          30:  <span style="background-color: white">      import org.w3c.dom.Element;</span><br>          31:  <span style="background-color: white">      </span><br>          32:  <span style="background-color: white">      import com.openhtmltopdf.bidi.support.ICUBidiReorderer;</span><br>          33:  <span style="background-color: white">      import com.openhtmltopdf.bidi.support.ICUBidiSplitter;</span><br>          34:  <span style="background-color: white">      import com.openhtmltopdf.bidi.support.ICUBreakers;</span><br>          35:  <span style="background-color: white">      import com.openhtmltopdf.extend.FSObjectDrawer;</span><br>          36:  <span style="background-color: white">      import com.openhtmltopdf.extend.FSObjectDrawerFactory;</span><br>          37:  <span style="background-color: white">      import com.openhtmltopdf.extend.FSTextBreaker;</span><br>          38:  <span style="background-color: white">      import com.openhtmltopdf.extend.OutputDevice;</span><br>          39:  <span style="background-color: white">      import com.openhtmltopdf.outputdevice.helper.BaseRendererBuilder.TextDirection;</span><br>          40:  <span style="background-color: white">      import com.openhtmltopdf.pdfboxout.visualtester.PdfVisualTester;</span><br>          41:  <span style="background-color: white">      import com.openhtmltopdf.pdfboxout.visualtester.PdfVisualTester.PdfCompareResult;</span><br>          42:  <span style="background-color: white">      import com.openhtmltopdf.render.RenderingContext;</span><br>          43:  <span style="background-color: white">      import com.openhtmltopdf.svgsupport.BatikSVGDrawer;</span><br>          44:  <span style="background-color: white">      import com.openhtmltopdf.testcases.TestcaseRunner;</span><br>          45:  <span style="background-color: white">      import com.openhtmltopdf.util.XRLogger;</span><br>          46:  <span style="background-color: white">      import com.openhtmltopdf.visualtest.Java2DVisualTester.Java2DBuilderConfig;</span><br>          47:  <span style="background-color: white">      import com.openhtmltopdf.visualtest.VisualTester.BuilderConfig;</span><br>          48:  <span style="background-color: white">      </span><br>          49:  <span style="background-color: white">      public class TestSupport {</span><br>          50:  <span style="background-color: white">          /**</span><br>          51:  <span style="background-color: white">           * Output the font file as a regular file so we don't have to use streams.</span><br>          52:  <span style="background-color: white">           * @throws IOException</span><br>          53:  <span style="background-color: white">           */</span><br>          54:  <span style="background-color: white">          public static void makeFontFile(String resource) throws IOException {</span><br>          55:  <span style="background-color: white">              File outputDirectory = new File("target/test/visual-tests/test-output/j2d/");</span><br>          56:  <span style="background-color: white">              outputDirectory.mkdirs();</span><br>          57:  <span style="background-color: white">      </span><br>          58:  <span style="background-color: white">              File fontFile = new File("target/test/visual-tests/" + resource);</span><br>          59:  <span style="background-color: white">      </span><br>          60:  <span style="background-color: white">              if (!fontFile.exists()) {</span><br>          61:  <span style="background-color: white">                  try (InputStream in = TestSupport.class.getResourceAsStream("/visualtest/html/fonts/" + resource)) {</span><br>          62:  <span style="background-color: white">                      Files.write(fontFile.toPath(), IOUtils.toByteArray(in));</span><br>          63:  <span style="background-color: white">                  }</span><br>          64:  <span style="background-color: white">              }</span><br>          65:  <span style="background-color: white">          }</span><br>          66:  <span style="background-color: white">      </span><br>          67:  <span style="background-color: white">          /**</span><br>          68:  <span style="background-color: white">           * Output the test fonts from classpath to files in target so we can use them </span><br>          69:  <span style="background-color: white">           * without streams.</span><br>          70:  <span style="background-color: white">           */</span><br>          71:  <span style="background-color: white">          public static void makeFontFiles() throws IOException {</span><br>          72:  <span style="background-color: white">              makeFontFile("Karla-Bold.ttf");</span><br>          73:  <span style="background-color: white">              makeFontFile("NotoNaskhArabic-Regular.ttf");</span><br>          74:  <span style="background-color: white">              makeFontFile("SourceSansPro-Regular.ttf");</span><br>          75:  <span style="background-color: white">          }</span><br>          76:  <span style="background-color: white">      </span><br>          77:  <span style="background-color: white">          public static class StringBuilderLogger implements XRLogger {</span><br>          78:  <span style="background-color: white">              private final StringBuilder sb;</span><br>          79:  <span style="background-color: white">              private final XRLogger delegate;</span><br>          80:  <span style="background-color: white">              </span><br>          81:  <span style="background-color: white">              public StringBuilderLogger(StringBuilder sb, XRLogger delegate) {</span><br>          82:  <span style="background-color: white">                  this.delegate = delegate;</span><br>          83:  <span style="background-color: white">                  this.sb = sb;</span><br>          84:  <span style="background-color: white">              }</span><br>          85:  <span style="background-color: white">      </span><br>          86:  <span style="background-color: white">              @Override</span><br>          87:  <span style="background-color: white">              public boolean isLogLevelEnabled(Diagnostic diagnostic) {</span><br>          88:  <span style="background-color: white">                  return true;</span><br>          89:  <span style="background-color: white">              }</span><br>          90:  <span style="background-color: white">      </span><br>          91:  <span style="background-color: white">              @Override</span><br>          92:  <span style="background-color: white">              public void setLevel(String logger, Level level) {</span><br>          93:  <span style="background-color: white">              }</span><br>          94:  <span style="background-color: white">      </span><br>          95:  <span style="background-color: white">              @Override</span><br>          96:  <span style="background-color: white">              public void log(String where, Level level, String msg, Throwable th) {</span><br>          97:  <span style="background-color: white">                  if (th == null) {</span><br>          98:  <span style="background-color: white">                      log(where, level, msg);</span><br>          99:  <span style="background-color: white">                      return;</span><br>         100:  <span style="background-color: white">                  }</span><br>         101:  <span style="background-color: white">                  StringWriter sw = new StringWriter();</span><br>         102:  <span style="background-color: white">                  th.printStackTrace(new PrintWriter(sw, true));</span><br>         103:  <span style="background-color: white">                  sb.append(where + ": " + level + ":\n" + msg + sw.toString() + "\n");</span><br>         104:  <span style="background-color: white">                  delegate.log(where, level, msg, th);</span><br>         105:  <span style="background-color: white">              }</span><br>         106:  <span style="background-color: white">      </span><br>         107:  <span style="background-color: white">              @Override</span><br>         108:  <span style="background-color: white">              public void log(String where, Level level, String msg) {</span><br>         109:  <span style="background-color: white">                  sb.append(where + ": " + level + ": " + msg + "\n");</span><br>         110:  <span style="background-color: white">      </span><br>         111:  <span style="background-color: white">                  if (!level.equals(Level.INFO)) {</span><br>         112:  <span style="background-color: white">                    delegate.log(where, level, msg);</span><br>         113:  <span style="background-color: white">                  }</span><br>         114:  <span style="background-color: white">              }</span><br>         115:  <span style="background-color: white">          }</span><br>         116:  <span style="background-color: white">          </span><br>         117:  <span style="background-color: white">          /**</span><br>         118:  <span style="background-color: white">           * A simple line breaker so that our tests are not reliant on the external Java API.</span><br>         119:  <span style="background-color: white">           */</span><br>         120:  <span style="background-color: white">          public static class SimpleTextBreaker implements FSTextBreaker {</span><br>         121:  <span style="background-color: white">              private String text;</span><br>         122:  <span style="background-color: white">              private int position;</span><br>         123:  <span style="background-color: white">              </span><br>         124:  <span style="background-color: white">              @Override</span><br>         125:  <span style="background-color: white">              public int next() {</span><br>         126:  <span style="background-color: white">                  int ret = text.indexOf(' ', this.position);</span><br>         127:  <span style="background-color: white">                  this.position = ret + 1;</span><br>         128:  <span style="background-color: white">                  return ret;</span><br>         129:  <span style="background-color: white">              }</span><br>         130:  <span style="background-color: white">      </span><br>         131:  <span style="background-color: white">              @Override</span><br>         132:  <span style="background-color: white">              public void setText(String newText) {</span><br>         133:  <span style="background-color: white">                  this.text = newText;</span><br>         134:  <span style="background-color: white">                  this.position = 0;</span><br>         135:  <span style="background-color: white">              }</span><br>         136:  <span style="background-color: white">          }</span><br>         137:  <span style="background-color: white">          </span><br>         138:  <span style="background-color: white">          /**</span><br>         139:  <span style="background-color: white">           * A simple line breaker that produces similar results to the JRE standard line breaker.</span><br>         140:  <span style="background-color: white">           * So we can test line breaking/justification with conditions more like real world.</span><br>         141:  <span style="background-color: white">           */</span><br>         142:  <span style="background-color: white">          public static class CollapsedSpaceTextBreaker implements FSTextBreaker {</span><br>         143:  <span style="background-color: white">              private final static Pattern SPACES = Pattern.compile("[\\s\u00AD]");</span><br>         144:  <span style="background-color: white">              private Matcher matcher;</span><br>         145:  <span style="background-color: white">              </span><br>         146:  <span style="background-color: white">              @Override</span><br>         147:  <span style="background-color: white">              public int next() {</span><br>         148:  <span style="background-color: white">                  if (!matcher.find()) {</span><br>         149:  <span style="background-color: white">                      return -1;</span><br>         150:  <span style="background-color: white">                  }</span><br>         151:  <span style="background-color: white">              </span><br>         152:  <span style="background-color: white">                  return matcher.end();</span><br>         153:  <span style="background-color: white">              }</span><br>         154:  <span style="background-color: white">      </span><br>         155:  <span style="background-color: white">              @Override</span><br>         156:  <span style="background-color: white">              public void setText(String newText) {</span><br>         157:  <span style="background-color: white">                  this.matcher = SPACES.matcher(newText);</span><br>         158:  <span style="background-color: white">              }</span><br>         159:  <span style="background-color: white">          }</span><br>         160:  <span style="background-color: white">          </span><br>         161:  <span style="background-color: white">          public static final BuilderConfig WITH_FONT = (builder) -&gt; {</span><br>         162:  <span style="background-color: white">              builder.useFont(new File("target/test/visual-tests/Karla-Bold.ttf"), "TestFont");</span><br>         163:  <span style="background-color: white">              builder.useUnicodeLineBreaker(new SimpleTextBreaker());</span><br>         164:  <span style="background-color: white">          };</span><br>         165:  <span style="background-color: white">          </span><br>         166:  <span style="background-color: white">          public static final Java2DBuilderConfig J2D_WITH_FONT = (builder) -&gt; {</span><br>         167:  <span style="background-color: white">              builder.useFont(new File("target/test/visual-tests/Karla-Bold.ttf"), "TestFont");</span><br>         168:  <span style="background-color: white">              builder.useUnicodeLineBreaker(new SimpleTextBreaker());</span><br>         169:  <span style="background-color: white">          };</span><br>         170:  <span style="background-color: white">          </span><br>         171:  <span style="background-color: white">          public static final BuilderConfig WITH_EXTRA_FONT = (builder) -&gt; {</span><br>         172:  <span style="background-color: white">              WITH_FONT.configure(builder);</span><br>         173:  <span style="background-color: white">              builder.useFont(new File("target/test/visual-tests/SourceSansPro-Regular.ttf"), "ExtraFont");</span><br>         174:  <span style="background-color: white">          };</span><br>         175:  <span style="background-color: white">          </span><br>         176:  <span style="background-color: white">          public static final BuilderConfig WITH_ARABIC = (builder) -&gt; {</span><br>         177:  <span style="background-color: white">              WITH_FONT.configure(builder);</span><br>         178:  <span style="background-color: white">              builder.useFont(new File("target/test/visual-tests/NotoNaskhArabic-Regular.ttf"), "arabic");</span><br>         179:  <span style="background-color: white">              builder.useUnicodeBidiSplitter(new ICUBidiSplitter.ICUBidiSplitterFactory());</span><br>         180:  <span style="background-color: white">              builder.useUnicodeBidiReorderer(new ICUBidiReorderer());</span><br>         181:  <span style="background-color: white">              builder.useUnicodeLineBreaker(new ICUBreakers.ICULineBreaker(Locale.US)); // Overrides WITH_FONT</span><br>         182:  <span style="background-color: white">              builder.defaultTextDirection(TextDirection.LTR);</span><br>         183:  <span style="background-color: white">          };</span><br>         184:  <span style="background-color: white">          </span><br>         185:  <span style="background-color: white">          public static final BuilderConfig WITH_COLLAPSED_LINE_BREAKER = (builder) -&gt; {</span><br>         186:  <span style="background-color: white">              WITH_FONT.configure(builder);</span><br>         187:  <span style="background-color: white">              builder.useUnicodeLineBreaker(new CollapsedSpaceTextBreaker());</span><br>         188:  <span style="background-color: white">          };</span><br>         189:  <span style="background-color: white">          </span><br>         190:  <span style="background-color: white">          /**</span><br>         191:  <span style="background-color: white">           * Configures the builder to use SVG drawer but not font.</span><br>         192:  <span style="background-color: white">           */</span><br>         193:  <span style="background-color: white">          public static final BuilderConfig WITH_SVG = (builder) -&gt; builder.useSVGDrawer(new BatikSVGDrawer());</span><br>         194:  <span style="background-color: white">      </span><br>         195:  <span style="background-color: white">          public static class ShapesObjectDrawer implements FSObjectDrawer {</span><br>         196:  <span style="background-color: white">              public Map
       <shape, string>
         drawObject(Element e, double x, double y, double width, double height,
       </shape,></span><br>         197:  <span style="background-color: white">                      OutputDevice outputDevice, RenderingContext ctx, int dotsPerPixel) {</span><br>         198:  <span style="background-color: white">      </span><br>         199:  <span style="background-color: white">                  Map
       <shape, string>
         shapes = new HashMap&lt;&gt;();
       </shape,></span><br>         200:  <span style="background-color: white">      </span><br>         201:  <span style="background-color: white">                  outputDevice.drawWithGraphics((float) x, (float) y, (float) width / dotsPerPixel,</span><br>         202:  <span style="background-color: white">                      (float) height / dotsPerPixel, (Graphics2D g2d) -&gt; {</span><br>         203:  <span style="background-color: white">      </span><br>         204:  <span style="background-color: white">                      double realWidth = width / dotsPerPixel;</span><br>         205:  <span style="background-color: white">                      double realHeight = height / dotsPerPixel;</span><br>         206:  <span style="background-color: white">      </span><br>         207:  <span style="background-color: white">                      Rectangle2D rectUpperLeft = new Rectangle2D.Double(0, 0, realWidth / 4d, realHeight / 4d);</span><br>         208:  <span style="background-color: white">                      Rectangle2D rectLowerRight = new Rectangle2D.Double(realWidth * (3d/4d), realHeight * (3d/4d), realWidth / 4d, realHeight / 4d);</span><br>         209:  <span style="background-color: white">      </span><br>         210:  <span style="background-color: white">                      int[] xpoints = new int[] { (int) (realWidth / 2d), (int) (realWidth * (1d/4d)), (int) (realWidth * (3d/4d)), (int) (realWidth / 2d) }; </span><br>         211:  <span style="background-color: white">                      int[] ypoints = new int[] { (int) (realHeight * (1d/4d)), (int) (realHeight * (3d/4d)), (int) (realHeight * (3d/4d)), (int) (realHeight * (1d/4d)) }; </span><br>         212:  <span style="background-color: white">                      Polygon centreTriangle = new Polygon(xpoints, ypoints, xpoints.length);</span><br>         213:  <span style="background-color: white">      </span><br>         214:  <span style="background-color: white">                      g2d.setColor(Color.CYAN);</span><br>         215:  <span style="background-color: white">      </span><br>         216:  <span style="background-color: white">                      g2d.draw(rectUpperLeft);</span><br>         217:  <span style="background-color: white">                      g2d.draw(rectLowerRight);</span><br>         218:  <span style="background-color: white">                      g2d.draw(centreTriangle);</span><br>         219:  <span style="background-color: white">      </span><br>         220:  <span style="background-color: white">                      AffineTransform scale = AffineTransform.getScaleInstance(dotsPerPixel, dotsPerPixel);</span><br>         221:  <span style="background-color: white">      </span><br>         222:  <span style="background-color: white">                      shapes.put(scale.createTransformedShape(rectUpperLeft), "http://example.com/1");</span><br>         223:  <span style="background-color: white">                      shapes.put(scale.createTransformedShape(rectLowerRight), "http://example.com/2");</span><br>         224:  <span style="background-color: white">                      shapes.put(scale.createTransformedShape(centreTriangle), "http://example.com/3");</span><br>         225:  <span style="background-color: white">                  });</span><br>         226:  <span style="background-color: white">      </span><br>         227:  <span style="background-color: white">                  return shapes;</span><br>         228:  <span style="background-color: white">              }</span><br>         229:  <span style="background-color: white">          }</span><br>         230:  <span style="background-color: white">      </span><br>         231:  <span style="background-color: white">          public static class ShapesObjectDrawerFactory implements FSObjectDrawerFactory {</span><br>         232:  <span style="background-color: white">              public FSObjectDrawer createDrawer(Element e) {</span><br>         233:  <span style="background-color: white">                  if (!isReplacedObject(e)) {</span><br>         234:  <span style="background-color: white">                      return null;</span><br>         235:  <span style="background-color: white">                  }</span><br>         236:  <span style="background-color: white">      </span><br>         237:  <span style="background-color: white">                  return new ShapesObjectDrawer();</span><br>         238:  <span style="background-color: white">              }</span><br>         239:  <span style="background-color: white">      </span><br>         240:  <span style="background-color: white">              public boolean isReplacedObject(Element e) {</span><br>         241:  <span style="background-color: white">                  return e.getAttribute("type").equals("shapes");</span><br>         242:  <span style="background-color: white">              }</span><br>         243:  <span style="background-color: white">          }</span><br>         244:  <span style="background-color: white">      </span><br>         245:  <span style="background-color: white">          public static final BuilderConfig WITH_SHAPES_DRAWER = (builder) -&gt; { builder.useObjectDrawerFactory(new ShapesObjectDrawerFactory()); };</span><br>         246:  <span style="background-color: white">      </span><br>         247:  <span style="background-color: white">          public static boolean comparePdfs(byte[] actualPdfBytes, String resource) throws IOException {</span><br>         248:  <span style="background-color: white">              File outputPath = new File("target/test/visual-tests/test-output/");</span><br>         249:  <span style="background-color: white">      </span><br>         250:  <span style="background-color: white">              byte[] expectedPdfBytes;</span><br>         251:  <span style="background-color: white">              try (InputStream expectedIs = TestcaseRunner.class.getResourceAsStream("/visualtest/expected/" + resource + ".pdf")) {</span><br>         252:  <span style="background-color: white">                  expectedPdfBytes = IOUtils.toByteArray(expectedIs);</span><br>         253:  <span style="background-color: white">              }</span><br>         254:  <span style="background-color: white">      </span><br>         255:  <span style="background-color: white">              List
       <pdfcompareresult>
         problems = PdfVisualTester.comparePdfDocuments(expectedPdfBytes, actualPdfBytes, resource, false);
       </pdfcompareresult></span><br>         256:  <span style="background-color: white">      </span><br>         257:  <span style="background-color: white">              if (!problems.isEmpty()) {</span><br>         258:  <span style="background-color: white">                  System.err.println("Found problems with test case (" + resource + "):");</span><br>         259:  <span style="background-color: white">                  System.err.println(problems.stream().map(p -&gt; p.logMessage).collect(Collectors.joining("\n    ", "[\n    ", "\n]")));</span><br>         260:  <span style="background-color: white">      </span><br>         261:  <span style="background-color: white">                  File outPdf = new File(outputPath, resource + "---actual.pdf");</span><br>         262:  <span style="background-color: white">                  Files.write(outPdf.toPath(), actualPdfBytes);</span><br>         263:  <span style="background-color: white">              }</span><br>         264:  <span style="background-color: white">      </span><br>         265:  <span style="background-color: white">              if (problems.stream().anyMatch(p -&gt; p.testImages != null)) {</span><br>         266:  <span style="background-color: white">                  System.err.println("For test case (" + resource + ") writing diff images to '" + outputPath + "'");</span><br>         267:  <span style="background-color: white">              }</span><br>         268:  <span style="background-color: white">      </span><br>         269:  <span style="background-color: white">              for (PdfCompareResult result : problems) {</span><br>         270:  <span style="background-color: white">                  if (result.testImages != null) {</span><br>         271:  <span style="background-color: white">                      File output = new File(outputPath, resource + "---" + result.pageNumber + "---diff.png");</span><br>         272:  <span style="background-color: white">                      ImageIO.write(result.testImages.createDiff(), "png", output);</span><br>         273:  <span style="background-color: white">      </span><br>         274:  <span style="background-color: white">                      output = new File(outputPath, resource + "---" + result.pageNumber + "---actual.png");</span><br>         275:  <span style="background-color: white">                      ImageIO.write(result.testImages.getActual(), "png", output);</span><br>         276:  <span style="background-color: white">      </span><br>         277:  <span style="background-color: white">                      output = new File(outputPath, resource + "---" + result.pageNumber + "---expected.png");</span><br>         278:  <span style="background-color: white">                      ImageIO.write(result.testImages.getExpected(), "png", output);</span><br>         279:  <span style="background-color: white">                  }</span><br>         280:  <span style="background-color: white">              }</span><br>         281:  <span style="background-color: white">      </span><br>         282:  <span style="background-color: white">              return problems.isEmpty();</span><br>         283:  <span style="background-color: white">          }</span><br>         284:  <span style="background-color: white">      </span><br>         285:  <span style="background-color: white">          public static void quietLogs() {</span><br>         286:  <span style="background-color: white">              XRLog.listRegisteredLoggers().forEach(log -&gt; XRLog.setLevel(log, Level.WARNING));</span><br>         287:  <span style="background-color: white">          }</span><br>         288:  <span style="background-color: white">      }</span><br></pre> </code> 
   </div> 
   <div class="column"> 
    <h2>Patched Code:</h2> <code> <pre id="patched-trace">        1-&gt;N:  <span style="background-color: white">      package com.openhtmltopdf.visualtest;</span><br>        2-&gt;N:  <span style="background-color: white">      </span><br>        3-&gt;N:  <span style="background-color: white">      import java.awt.Color;</span><br>        4-&gt;N:  <span style="background-color: white">      import java.awt.Graphics2D;</span><br>        5-&gt;N:  <span style="background-color: white">      import java.awt.Polygon;</span><br>        6-&gt;N:  <span style="background-color: white">      import java.awt.Shape;</span><br>        7-&gt;N:  <span style="background-color: white">      import java.awt.geom.AffineTransform;</span><br>        8-&gt;N:  <span style="background-color: white">      import java.awt.geom.Rectangle2D;</span><br>        9-&gt;N:  <span style="background-color: white">      import java.io.File;</span><br>       10-&gt;N:  <span style="background-color: white">      import java.io.IOException;</span><br>       11-&gt;N:  <span style="background-color: white">      import java.io.InputStream;</span><br>       12-&gt;N:  <span style="background-color: white">      import java.io.PrintWriter;</span><br>       13-&gt;N:  <span style="background-color: white">      import java.io.StringWriter;</span><br>       14-&gt;N:  <span style="background-color: white">      import java.nio.file.Files;</span><br>       15-&gt;N:  <span style="background-color: white">      import java.util.ArrayList;</span><br>       16-&gt;N:  <span style="background-color: white">      import java.util.HashMap;</span><br>       17-&gt;N:  <span style="background-color: white">      import java.util.List;</span><br>       18-&gt;N:  <span style="background-color: white">      import java.util.Locale;</span><br>       19-&gt;N:  <span style="background-color: white">      import java.util.Map;</span><br>       20-&gt;N:  <span style="background-color: white">      import java.util.function.Consumer;</span><br>       21-&gt;N:  <span style="background-color: white">      import java.util.logging.Level;</span><br>       22-&gt;N:  <span style="background-color: white">      import java.util.regex.Matcher;</span><br>       23-&gt;N:  <span style="background-color: white">      import java.util.regex.Pattern;</span><br>       24-&gt;N:  <span style="background-color: white">      import java.util.stream.Collectors;</span><br>       25-&gt;N:  <span style="background-color: white">      </span><br>       26-&gt;N:  <span style="background-color: white">      import javax.imageio.ImageIO;</span><br>       27-&gt;N:  <span style="background-color: white">      </span><br>       28-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.Diagnostic;</span><br>       29-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.LogMessageId;</span><br>       30-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.XRLog;</span><br>       31-&gt;N:  <span style="background-color: white">      </span><br>       32-&gt;N:  <span style="background-color: white">      import org.apache.pdfbox.io.IOUtils;</span><br>       33-&gt;N:  <span style="background-color: white">      import org.w3c.dom.Element;</span><br>       34-&gt;N:  <span style="background-color: white">      </span><br>       35-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.bidi.support.ICUBidiReorderer;</span><br>       36-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.bidi.support.ICUBidiSplitter;</span><br>       37-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.bidi.support.ICUBreakers;</span><br>       38-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.extend.FSObjectDrawer;</span><br>       39-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.extend.FSObjectDrawerFactory;</span><br>       40-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.extend.FSTextBreaker;</span><br>       41-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.extend.OutputDevice;</span><br>       42-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.outputdevice.helper.BaseRendererBuilder.TextDirection;</span><br>       43-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.pdfboxout.visualtester.PdfVisualTester;</span><br>       44-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.pdfboxout.visualtester.PdfVisualTester.PdfCompareResult;</span><br>       45-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.RenderingContext;</span><br>       46-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.svgsupport.BatikSVGDrawer;</span><br>       47-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.testcases.TestcaseRunner;</span><br>       48-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.XRLogger;</span><br>       49-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.visualtest.Java2DVisualTester.Java2DBuilderConfig;</span><br>       50-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.visualtest.VisualTester.BuilderConfig;</span><br>       51-&gt;N:  <span style="background-color: white">      </span><br>       52-&gt;N:  <span style="background-color: white">      public class TestSupport {</span><br>       53-&gt;N:  <span style="background-color: white">          /**</span><br>       54-&gt;N:  <span style="background-color: white">           * Output the font file as a regular file so we don't have to use streams.</span><br>       55-&gt;N:  <span style="background-color: white">           * @throws IOException</span><br>       56-&gt;N:  <span style="background-color: white">           */</span><br>      57-&gt;54:  <span style="background-color: cyan">          public static void makeFontFile(String resource) throws IOException {</span><br>      58-&gt;55:  <span style="background-color: cyan">              File outputDirectory = new File("target/test/visual-tests/test-output/j2d/");</span><br>      59-&gt;56:  <span style="background-color: cyan">              outputDirectory.mkdirs();</span><br>       60-&gt;N:  <span style="background-color: white">      </span><br>      61-&gt;58:  <span style="background-color: cyan">              File fontFile = new File("target/test/visual-tests/" + resource);</span><br>       62-&gt;N:  <span style="background-color: white">      </span><br>      63-&gt;60:  <span style="background-color: cyan">              if (!fontFile.exists()) {</span><br>      64-&gt;61:  <span style="background-color: white">                  try (InputStream in = TestSupport.class.getResourceAsStream("/visualtest/html/fonts/" + resource)) {</span><br>      65-&gt;62:  <span style="background-color: white">                      Files.write(fontFile.toPath(), IOUtils.toByteArray(in));</span><br>       66-&gt;N:  <span style="background-color: white">                  }</span><br>       67-&gt;N:  <span style="background-color: white">              }</span><br>       68-&gt;N:  <span style="background-color: white">          }</span><br>       69-&gt;N:  <span style="background-color: white">      </span><br>       70-&gt;N:  <span style="background-color: white">          /**</span><br>       71-&gt;N:  <span style="background-color: white">           * Output the test fonts from classpath to files in target so we can use them </span><br>       72-&gt;N:  <span style="background-color: white">           * without streams.</span><br>       73-&gt;N:  <span style="background-color: white">           */</span><br>      74-&gt;71:  <span style="background-color: cyan">          public static void makeFontFiles() throws IOException {</span><br>      75-&gt;72:  <span style="background-color: cyan">              makeFontFile("Karla-Bold.ttf");</span><br>      76-&gt;73:  <span style="background-color: cyan">              makeFontFile("NotoNaskhArabic-Regular.ttf");</span><br>      77-&gt;74:  <span style="background-color: cyan">              makeFontFile("SourceSansPro-Regular.ttf");</span><br>       78-&gt;N:  <span style="background-color: white">          }</span><br>       79-&gt;N:  <span style="background-color: white">      </span><br>       80-&gt;N:  <span style="background-color: white">          public static class StringBuilderLogger implements XRLogger {</span><br>      81-&gt;78:  <span style="background-color: white">              private final StringBuilder sb;</span><br>      82-&gt;79:  <span style="background-color: white">              private final XRLogger delegate;</span><br>       83-&gt;N:  <span style="background-color: white">              </span><br>      84-&gt;81:  <span style="background-color: cyan">              public StringBuilderLogger(StringBuilder sb, XRLogger delegate) {</span><br>      85-&gt;82:  <span style="background-color: cyan">                  this.delegate = delegate;</span><br>      86-&gt;83:  <span style="background-color: cyan">                  this.sb = sb;</span><br>       87-&gt;N:  <span style="background-color: white">              }</span><br>       88-&gt;N:  <span style="background-color: white">      </span><br>      89-&gt;86:  <span style="background-color: cyan">              @Override</span><br>      90-&gt;87:  <span style="background-color: white">              public boolean isLogLevelEnabled(Diagnostic diagnostic) {</span><br>      91-&gt;88:  <span style="background-color: cyan">                  return true;</span><br>       92-&gt;N:  <span style="background-color: white">              }</span><br>       93-&gt;N:  <span style="background-color: white">      </span><br>      94-&gt;91:  <span style="background-color: cyan">              @Override</span><br>      95-&gt;92:  <span style="background-color: white">              public void setLevel(String logger, Level level) {</span><br>       96-&gt;N:  <span style="background-color: white">              }</span><br>       97-&gt;N:  <span style="background-color: white">      </span><br>      98-&gt;95:  <span style="background-color: white">              @Override</span><br>      99-&gt;96:  <span style="background-color: white">              public void log(String where, Level level, String msg, Throwable th) {</span><br>     100-&gt;97:  <span style="background-color: white">                  if (th == null) {</span><br>     101-&gt;98:  <span style="background-color: white">                      log(where, level, msg);</span><br>     102-&gt;99:  <span style="background-color: white">                      return;</span><br>      103-&gt;N:  <span style="background-color: white">                  }</span><br>    104-&gt;101:  <span style="background-color: white">                  StringWriter sw = new StringWriter();</span><br>    105-&gt;102:  <span style="background-color: white">                  th.printStackTrace(new PrintWriter(sw, true));</span><br>    106-&gt;103:  <span style="background-color: white">                  sb.append(where + ": " + level + ":\n" + msg + sw.toString() + "\n");</span><br>    107-&gt;104:  <span style="background-color: white">                  delegate.log(where, level, msg, th);</span><br>      108-&gt;N:  <span style="background-color: white">              }</span><br>      109-&gt;N:  <span style="background-color: white">      </span><br>    110-&gt;107:  <span style="background-color: cyan">              @Override</span><br>    111-&gt;108:  <span style="background-color: white">              public void log(String where, Level level, String msg) {</span><br>    112-&gt;109:  <span style="background-color: cyan">                  sb.append(where + ": " + level + ": " + msg + "\n");</span><br>      113-&gt;N:  <span style="background-color: white">      </span><br>    114-&gt;111:  <span style="background-color: cyan">                  if (!level.equals(Level.INFO)) {</span><br>    115-&gt;112:  <span style="background-color: cyan">                    delegate.log(where, level, msg);</span><br>      116-&gt;N:  <span style="background-color: white">                  }</span><br>      117-&gt;N:  <span style="background-color: white">              }</span><br>      118-&gt;N:  <span style="background-color: white">          }</span><br>      119-&gt;N:  <span style="background-color: white">          </span><br>      120-&gt;N:  <span style="background-color: white">          /**</span><br>      121-&gt;N:  <span style="background-color: white">           * A simple line breaker so that our tests are not reliant on the external Java API.</span><br>      122-&gt;N:  <span style="background-color: white">           */</span><br>      123-&gt;N:  <span style="background-color: white">          public static class SimpleTextBreaker implements FSTextBreaker {</span><br>    124-&gt;121:  <span style="background-color: white">              private String text;</span><br>    125-&gt;122:  <span style="background-color: white">              private int position;</span><br>      126-&gt;N:  <span style="background-color: white">              </span><br>    127-&gt;124:  <span style="background-color: cyan">              @Override</span><br>    128-&gt;125:  <span style="background-color: white">              public int next() {</span><br>    129-&gt;126:  <span style="background-color: cyan">                  int ret = text.indexOf(' ', this.position);</span><br>    130-&gt;127:  <span style="background-color: cyan">                  this.position = ret + 1;</span><br>    131-&gt;128:  <span style="background-color: cyan">                  return ret;</span><br>      132-&gt;N:  <span style="background-color: white">              }</span><br>      133-&gt;N:  <span style="background-color: white">      </span><br>    134-&gt;131:  <span style="background-color: cyan">              @Override</span><br>    135-&gt;132:  <span style="background-color: white">              public void setText(String newText) {</span><br>    136-&gt;133:  <span style="background-color: cyan">                  this.text = newText;</span><br>    137-&gt;134:  <span style="background-color: cyan">                  this.position = 0;</span><br>      138-&gt;N:  <span style="background-color: white">              }</span><br>      139-&gt;N:  <span style="background-color: white">          }</span><br>      140-&gt;N:  <span style="background-color: white">          </span><br>      141-&gt;N:  <span style="background-color: white">          /**</span><br>      142-&gt;N:  <span style="background-color: white">           * A simple line breaker that produces similar results to the JRE standard line breaker.</span><br>      143-&gt;N:  <span style="background-color: white">           * So we can test line breaking/justification with conditions more like real world.</span><br>      144-&gt;N:  <span style="background-color: white">           */</span><br>      145-&gt;N:  <span style="background-color: white">          public static class CollapsedSpaceTextBreaker implements FSTextBreaker {</span><br>    146-&gt;143:  <span style="background-color: white">              private final static Pattern SPACES = Pattern.compile("[\\s\u00AD]");</span><br>    147-&gt;144:  <span style="background-color: white">              private Matcher matcher;</span><br>      148-&gt;N:  <span style="background-color: white">              </span><br>    149-&gt;146:  <span style="background-color: white">              @Override</span><br>    150-&gt;147:  <span style="background-color: white">              public int next() {</span><br>      151-&gt;N:  <span style="background-color: white">                  if (!matcher.find()) {</span><br>    152-&gt;149:  <span style="background-color: white">                      return -1;</span><br>      153-&gt;N:  <span style="background-color: white">                  }</span><br>      154-&gt;N:  <span style="background-color: white">              </span><br>      155-&gt;N:  <span style="background-color: white">                  return matcher.end();</span><br>      156-&gt;N:  <span style="background-color: white">              }</span><br>      157-&gt;N:  <span style="background-color: white">      </span><br>    158-&gt;155:  <span style="background-color: white">              @Override</span><br>    159-&gt;156:  <span style="background-color: white">              public void setText(String newText) {</span><br>    160-&gt;157:  <span style="background-color: white">                  this.matcher = SPACES.matcher(newText);</span><br>      161-&gt;N:  <span style="background-color: white">              }</span><br>      162-&gt;N:  <span style="background-color: white">          }</span><br>      163-&gt;N:  <span style="background-color: white">          </span><br>    164-&gt;161:  <span style="background-color: white">          public static final BuilderConfig WITH_FONT = (builder) -&gt; {</span><br>    165-&gt;162:  <span style="background-color: cyan">              builder.useFont(new File("target/test/visual-tests/Karla-Bold.ttf"), "TestFont");</span><br>    166-&gt;163:  <span style="background-color: cyan">              builder.useUnicodeLineBreaker(new SimpleTextBreaker());</span><br>      167-&gt;N:  <span style="background-color: white">          };</span><br>      168-&gt;N:  <span style="background-color: white">          </span><br>    169-&gt;166:  <span style="background-color: white">          public static final Java2DBuilderConfig J2D_WITH_FONT = (builder) -&gt; {</span><br>    170-&gt;167:  <span style="background-color: white">              builder.useFont(new File("target/test/visual-tests/Karla-Bold.ttf"), "TestFont");</span><br>    171-&gt;168:  <span style="background-color: white">              builder.useUnicodeLineBreaker(new SimpleTextBreaker());</span><br>      172-&gt;N:  <span style="background-color: white">          };</span><br>      173-&gt;N:  <span style="background-color: white">          </span><br>    174-&gt;171:  <span style="background-color: white">          public static final BuilderConfig WITH_EXTRA_FONT = (builder) -&gt; {</span><br>    175-&gt;172:  <span style="background-color: white">              WITH_FONT.configure(builder);</span><br>    176-&gt;173:  <span style="background-color: white">              builder.useFont(new File("target/test/visual-tests/SourceSansPro-Regular.ttf"), "ExtraFont");</span><br>      177-&gt;N:  <span style="background-color: white">          };</span><br>      178-&gt;N:  <span style="background-color: white">          </span><br>    179-&gt;176:  <span style="background-color: white">          public static final BuilderConfig WITH_ARABIC = (builder) -&gt; {</span><br>    180-&gt;177:  <span style="background-color: white">              WITH_FONT.configure(builder);</span><br>    181-&gt;178:  <span style="background-color: white">              builder.useFont(new File("target/test/visual-tests/NotoNaskhArabic-Regular.ttf"), "arabic");</span><br>    182-&gt;179:  <span style="background-color: white">              builder.useUnicodeBidiSplitter(new ICUBidiSplitter.ICUBidiSplitterFactory());</span><br>    183-&gt;180:  <span style="background-color: white">              builder.useUnicodeBidiReorderer(new ICUBidiReorderer());</span><br>    184-&gt;181:  <span style="background-color: white">              builder.useUnicodeLineBreaker(new ICUBreakers.ICULineBreaker(Locale.US)); // Overrides WITH_FONT</span><br>    185-&gt;182:  <span style="background-color: white">              builder.defaultTextDirection(TextDirection.LTR);</span><br>      186-&gt;N:  <span style="background-color: white">          };</span><br>      187-&gt;N:  <span style="background-color: white">          </span><br>    188-&gt;185:  <span style="background-color: white">          public static final BuilderConfig WITH_COLLAPSED_LINE_BREAKER = (builder) -&gt; {</span><br>    189-&gt;186:  <span style="background-color: white">              WITH_FONT.configure(builder);</span><br>    190-&gt;187:  <span style="background-color: white">              builder.useUnicodeLineBreaker(new CollapsedSpaceTextBreaker());</span><br>      191-&gt;N:  <span style="background-color: white">          };</span><br>      192-&gt;N:  <span style="background-color: white">          </span><br>      193-&gt;N:  <span style="background-color: white">          /**</span><br>      194-&gt;N:  <span style="background-color: white">           * Configures the builder to use SVG drawer but not font.</span><br>      195-&gt;N:  <span style="background-color: white">           */</span><br>    196-&gt;193:  <span style="background-color: white">          public static final BuilderConfig WITH_SVG = (builder) -&gt; builder.useSVGDrawer(new BatikSVGDrawer());</span><br>      197-&gt;N:  <span style="background-color: white">      </span><br>      198-&gt;N:  <span style="background-color: white">          public static class ShapesObjectDrawer implements FSObjectDrawer {</span><br>    199-&gt;196:  <span style="background-color: white">              public Map
       <shape, string>
         drawObject(Element e, double x, double y, double width, double height,
       </shape,></span><br>    200-&gt;197:  <span style="background-color: white">                      OutputDevice outputDevice, RenderingContext ctx, int dotsPerPixel) {</span><br>      201-&gt;N:  <span style="background-color: white">      </span><br>    202-&gt;199:  <span style="background-color: white">                  Map
       <shape, string>
         shapes = new HashMap&lt;&gt;();
       </shape,></span><br>      203-&gt;N:  <span style="background-color: white">      </span><br>    204-&gt;201:  <span style="background-color: white">                  outputDevice.drawWithGraphics((float) x, (float) y, (float) width / dotsPerPixel,</span><br>    205-&gt;202:  <span style="background-color: white">                      (float) height / dotsPerPixel, (Graphics2D g2d) -&gt; {</span><br>      206-&gt;N:  <span style="background-color: white">      </span><br>    207-&gt;204:  <span style="background-color: white">                      double realWidth = width / dotsPerPixel;</span><br>    208-&gt;205:  <span style="background-color: white">                      double realHeight = height / dotsPerPixel;</span><br>      209-&gt;N:  <span style="background-color: white">      </span><br>    210-&gt;207:  <span style="background-color: white">                      Rectangle2D rectUpperLeft = new Rectangle2D.Double(0, 0, realWidth / 4d, realHeight / 4d);</span><br>    211-&gt;208:  <span style="background-color: white">                      Rectangle2D rectLowerRight = new Rectangle2D.Double(realWidth * (3d/4d), realHeight * (3d/4d), realWidth / 4d, realHeight / 4d);</span><br>      212-&gt;N:  <span style="background-color: white">      </span><br>    213-&gt;210:  <span style="background-color: white">                      int[] xpoints = new int[] { (int) (realWidth / 2d), (int) (realWidth * (1d/4d)), (int) (realWidth * (3d/4d)), (int) (realWidth / 2d) }; </span><br>    214-&gt;211:  <span style="background-color: white">                      int[] ypoints = new int[] { (int) (realHeight * (1d/4d)), (int) (realHeight * (3d/4d)), (int) (realHeight * (3d/4d)), (int) (realHeight * (1d/4d)) }; </span><br>    215-&gt;212:  <span style="background-color: white">                      Polygon centreTriangle = new Polygon(xpoints, ypoints, xpoints.length);</span><br>      216-&gt;N:  <span style="background-color: white">      </span><br>    217-&gt;214:  <span style="background-color: white">                      g2d.setColor(Color.CYAN);</span><br>      218-&gt;N:  <span style="background-color: white">      </span><br>    219-&gt;216:  <span style="background-color: white">                      g2d.draw(rectUpperLeft);</span><br>    220-&gt;217:  <span style="background-color: white">                      g2d.draw(rectLowerRight);</span><br>    221-&gt;218:  <span style="background-color: white">                      g2d.draw(centreTriangle);</span><br>      222-&gt;N:  <span style="background-color: white">      </span><br>    223-&gt;220:  <span style="background-color: white">                      AffineTransform scale = AffineTransform.getScaleInstance(dotsPerPixel, dotsPerPixel);</span><br>      224-&gt;N:  <span style="background-color: white">      </span><br>    225-&gt;222:  <span style="background-color: white">                      shapes.put(scale.createTransformedShape(rectUpperLeft), "http://example.com/1");</span><br>    226-&gt;223:  <span style="background-color: white">                      shapes.put(scale.createTransformedShape(rectLowerRight), "http://example.com/2");</span><br>    227-&gt;224:  <span style="background-color: white">                      shapes.put(scale.createTransformedShape(centreTriangle), "http://example.com/3");</span><br>      228-&gt;N:  <span style="background-color: white">                  });</span><br>      229-&gt;N:  <span style="background-color: white">      </span><br>    230-&gt;227:  <span style="background-color: white">                  return shapes;</span><br>      231-&gt;N:  <span style="background-color: white">              }</span><br>      232-&gt;N:  <span style="background-color: white">          }</span><br>      233-&gt;N:  <span style="background-color: white">      </span><br>      234-&gt;N:  <span style="background-color: white">          public static class ShapesObjectDrawerFactory implements FSObjectDrawerFactory {</span><br>    235-&gt;232:  <span style="background-color: white">              public FSObjectDrawer createDrawer(Element e) {</span><br>    236-&gt;233:  <span style="background-color: white">                  if (!isReplacedObject(e)) {</span><br>    237-&gt;234:  <span style="background-color: white">                      return null;</span><br>      238-&gt;N:  <span style="background-color: white">                  }</span><br>      239-&gt;N:  <span style="background-color: white">      </span><br>    240-&gt;237:  <span style="background-color: white">                  return new ShapesObjectDrawer();</span><br>      241-&gt;N:  <span style="background-color: white">              }</span><br>      242-&gt;N:  <span style="background-color: white">      </span><br>    243-&gt;240:  <span style="background-color: white">              public boolean isReplacedObject(Element e) {</span><br>    244-&gt;241:  <span style="background-color: white">                  return e.getAttribute("type").equals("shapes");</span><br>      245-&gt;N:  <span style="background-color: white">              }</span><br>      246-&gt;N:  <span style="background-color: white">          }</span><br>      247-&gt;N:  <span style="background-color: white">      </span><br>    248-&gt;245:  <span style="background-color: white">          public static final BuilderConfig WITH_SHAPES_DRAWER = (builder) -&gt; { builder.useObjectDrawerFactory(new ShapesObjectDrawerFactory()); };</span><br>      249-&gt;N:  <span style="background-color: white">      </span><br>    250-&gt;247:  <span style="background-color: white">          public static boolean comparePdfs(byte[] actualPdfBytes, String resource) throws IOException {</span><br>    251-&gt;248:  <span style="background-color: white">              File outputPath = new File("target/test/visual-tests/test-output/");</span><br>      252-&gt;N:  <span style="background-color: white">      </span><br>    253-&gt;250:  <span style="background-color: white">              byte[] expectedPdfBytes;</span><br>    254-&gt;251:  <span style="background-color: white">              try (InputStream expectedIs = TestcaseRunner.class.getResourceAsStream("/visualtest/expected/" + resource + ".pdf")) {</span><br>    255-&gt;252:  <span style="background-color: white">                  expectedPdfBytes = IOUtils.toByteArray(expectedIs);</span><br>      256-&gt;N:  <span style="background-color: white">              }</span><br>      257-&gt;N:  <span style="background-color: white">      </span><br>    258-&gt;255:  <span style="background-color: white">              List
       <pdfcompareresult>
         problems = PdfVisualTester.comparePdfDocuments(expectedPdfBytes, actualPdfBytes, resource, false);
       </pdfcompareresult></span><br>      259-&gt;N:  <span style="background-color: white">      </span><br>    260-&gt;257:  <span style="background-color: white">              if (!problems.isEmpty()) {</span><br>    261-&gt;258:  <span style="background-color: white">                  System.err.println("Found problems with test case (" + resource + "):");</span><br>    262-&gt;259:  <span style="background-color: white">                  System.err.println(problems.stream().map(p -&gt; p.logMessage).collect(Collectors.joining("\n    ", "[\n    ", "\n]")));</span><br>      263-&gt;N:  <span style="background-color: white">      </span><br>    264-&gt;261:  <span style="background-color: white">                  File outPdf = new File(outputPath, resource + "---actual.pdf");</span><br>    265-&gt;262:  <span style="background-color: white">                  Files.write(outPdf.toPath(), actualPdfBytes);</span><br>      266-&gt;N:  <span style="background-color: white">              }</span><br>      267-&gt;N:  <span style="background-color: white">      </span><br>    268-&gt;265:  <span style="background-color: white">              if (problems.stream().anyMatch(p -&gt; p.testImages != null)) {</span><br>    269-&gt;266:  <span style="background-color: white">                  System.err.println("For test case (" + resource + ") writing diff images to '" + outputPath + "'");</span><br>      270-&gt;N:  <span style="background-color: white">              }</span><br>      271-&gt;N:  <span style="background-color: white">      </span><br>    272-&gt;269:  <span style="background-color: white">              for (PdfCompareResult result : problems) {</span><br>    273-&gt;270:  <span style="background-color: white">                  if (result.testImages != null) {</span><br>    274-&gt;271:  <span style="background-color: white">                      File output = new File(outputPath, resource + "---" + result.pageNumber + "---diff.png");</span><br>    275-&gt;272:  <span style="background-color: white">                      ImageIO.write(result.testImages.createDiff(), "png", output);</span><br>      276-&gt;N:  <span style="background-color: white">      </span><br>    277-&gt;274:  <span style="background-color: white">                      output = new File(outputPath, resource + "---" + result.pageNumber + "---actual.png");</span><br>    278-&gt;275:  <span style="background-color: white">                      ImageIO.write(result.testImages.getActual(), "png", output);</span><br>      279-&gt;N:  <span style="background-color: white">      </span><br>    280-&gt;277:  <span style="background-color: white">                      output = new File(outputPath, resource + "---" + result.pageNumber + "---expected.png");</span><br>    281-&gt;278:  <span style="background-color: white">                      ImageIO.write(result.testImages.getExpected(), "png", output);</span><br>      282-&gt;N:  <span style="background-color: white">                  }</span><br>      283-&gt;N:  <span style="background-color: white">              }</span><br>      284-&gt;N:  <span style="background-color: white">      </span><br>    285-&gt;282:  <span style="background-color: white">              return problems.isEmpty();</span><br>      286-&gt;N:  <span style="background-color: white">          }</span><br>      287-&gt;N:  <span style="background-color: white">      </span><br>    288-&gt;285:  <span style="background-color: cyan">          public static void quietLogs() {</span><br>    289-&gt;286:  <span style="background-color: cyan">              XRLog.listRegisteredLoggers().forEach(log -&gt; XRLog.setLevel(log, Level.WARNING));</span><br>      290-&gt;N:  <span style="background-color: white">          }</span><br>      291-&gt;N:  <span style="background-color: white">      </span><br>      292-&gt;N:  <span style="background-color: white">          @FunctionalInterface</span><br>      293-&gt;U:  <span style="background-color: yellow">          public interface WithLog {</span><br>      294-&gt;U:  <span style="background-color: yellow">              void accept(List
       <logmessageid>
         log, Consumer
        <diagnostic>
          con) throws IOException;
        </diagnostic>
       </logmessageid></span><br>      295-&gt;U:  <span style="background-color: yellow">          }</span><br>      296-&gt;N:  <span style="background-color: white">      </span><br>      297-&gt;N:  <span style="background-color: white">          @FunctionalInterface</span><br>      298-&gt;U:  <span style="background-color: yellow">          public interface WithLogBuilder {</span><br>      299-&gt;U:  <span style="background-color: yellow">              void accept(List
       <logmessageid>
         log, BuilderConfig config) throws IOException;
       </logmessageid></span><br>      300-&gt;U:  <span style="background-color: yellow">          }</span><br>      301-&gt;N:  <span style="background-color: white">      </span><br>      302-&gt;U:  <span style="background-color: yellow">          public static void withLogConsumer(WithLog consumer) throws IOException {</span><br>      303-&gt;U:  <span style="background-color: yellow">              List
       <logmessageid>
         log = new ArrayList&lt;&gt;();
       </logmessageid></span><br>      304-&gt;U:  <span style="background-color: yellow">              Consumer
       <diagnostic>
         diagCon = (d) -&gt; log.add(d.getLogMessageId());
       </diagnostic></span><br>      305-&gt;U:  <span style="background-color: yellow">      </span><br>      306-&gt;U:  <span style="background-color: yellow">              consumer.accept(log, diagCon);</span><br>      307-&gt;U:  <span style="background-color: yellow">          }</span><br>      308-&gt;N:  <span style="background-color: white">      </span><br>      309-&gt;U:  <span style="background-color: yellow">          public static void withLog(WithLogBuilder consumer) throws IOException {</span><br>      310-&gt;U:  <span style="background-color: yellow">              withLogConsumer((log, con) -&gt; consumer.accept(log, (builder) -&gt; builder.withDiagnosticConsumer(con)));</span><br>      311-&gt;U:  <span style="background-color: yellow">          }</span><br>      312-&gt;N:  <span style="background-color: white">      }</span><br></pre> </code> 
   </div> 
  </div>  
 </body>
</html>
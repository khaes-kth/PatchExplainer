<!doctype html>
<html lang="en"> 
 <head> 
  <meta charset="UTF-8"> 
  <title>Execution Trace Diff</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <style>
* {
  box-sizing: border-box;
}

/* Create two equal columns that floats next to each other */
.column {
  float: left;
  width: 50%;
  padding: 10px;
  height: 300px; /* Should be removed. Only for demonstration */
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

.test {
    border: 1px solid darkblue;
    padding-left: 10px;
}
</style> 
 </head> 
 <body> 
  <div class="row test"> 
   <h2>Differencing Test:</h2> <code> <pre>@Test <br>
public void test_main(){ <br>
    String ret = NumberAnalyzer.analyze(1); <br>
    assertThat(ret, containsString("greater")); <br>
}
        </pre> </code> 
  </div> 
  <div class="row"> 
   <div class="column"> 
    <h2>Original Code:</h2> <code> <pre id="original-trace">           1:  <span style="background-color: white">      /*</span><br>           2:  <span style="background-color: white">       * {{{ header &amp; license</span><br>           3:  <span style="background-color: white">       * Copyright (c) 2004, 2005 Joshua Marinacci</span><br>           4:  <span style="background-color: white">       * Copyright (c) 2006, 2007 Wisconsin Courts System</span><br>           5:  <span style="background-color: white">       *</span><br>           6:  <span style="background-color: white">       * This program is free software; you can redistribute it and/or</span><br>           7:  <span style="background-color: white">       * modify it under the terms of the GNU Lesser General Public License</span><br>           8:  <span style="background-color: white">       * as published by the Free Software Foundation; either version 2.1</span><br>           9:  <span style="background-color: white">       * of the License, or (at your option) any later version.</span><br>          10:  <span style="background-color: white">       *</span><br>          11:  <span style="background-color: white">       * This program is distributed in the hope that it will be useful,</span><br>          12:  <span style="background-color: white">       * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br>          13:  <span style="background-color: white">       * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span><br>          14:  <span style="background-color: white">       * GNU Lesser General Public License for more details.</span><br>          15:  <span style="background-color: white">       *</span><br>          16:  <span style="background-color: white">       * You should have received a copy of the GNU Lesser General Public License</span><br>          17:  <span style="background-color: white">       * along with this program; if not, write to the Free Software</span><br>          18:  <span style="background-color: white">       * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span><br>          19:  <span style="background-color: white">       * }}}</span><br>          20:  <span style="background-color: white">       */</span><br>          21:  <span style="background-color: white">      package com.openhtmltopdf.render;</span><br>          22:  <span style="background-color: white">      </span><br>          23:  <span style="background-color: white">      import java.awt.Point;</span><br>          24:  <span style="background-color: white">      import java.awt.Rectangle;</span><br>          25:  <span style="background-color: white">      import java.util.Iterator;</span><br>          26:  <span style="background-color: white">      import java.util.LinkedList;</span><br>          27:  <span style="background-color: white">      import java.util.List;</span><br>          28:  <span style="background-color: white">      </span><br>          29:  <span style="background-color: white">      import com.openhtmltopdf.bidi.BidiReorderer;</span><br>          30:  <span style="background-color: white">      import com.openhtmltopdf.bidi.BidiSplitter;</span><br>          31:  <span style="background-color: white">      import org.w3c.dom.Element;</span><br>          32:  <span style="background-color: white">      </span><br>          33:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.CSSName;</span><br>          34:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.IdentValue;</span><br>          35:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.CascadedStyle;</span><br>          36:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.FSRGBColor;</span><br>          37:  <span style="background-color: white">      import com.openhtmltopdf.css.style.CalculatedStyle;</span><br>          38:  <span style="background-color: white">      import com.openhtmltopdf.css.style.CssContext;</span><br>          39:  <span style="background-color: white">      import com.openhtmltopdf.css.style.FSDerivedValue;</span><br>          40:  <span style="background-color: white">      import com.openhtmltopdf.css.style.derived.BorderPropertySet;</span><br>          41:  <span style="background-color: white">      import com.openhtmltopdf.css.style.derived.LengthValue;</span><br>          42:  <span style="background-color: white">      import com.openhtmltopdf.css.style.derived.RectPropertySet;</span><br>          43:  <span style="background-color: white">      import com.openhtmltopdf.extend.FSImage;</span><br>          44:  <span style="background-color: white">      import com.openhtmltopdf.extend.ReplacedElement;</span><br>          45:  <span style="background-color: white">      import com.openhtmltopdf.layout.BlockBoxing;</span><br>          46:  <span style="background-color: white">      import com.openhtmltopdf.layout.BlockFormattingContext;</span><br>          47:  <span style="background-color: white">      import com.openhtmltopdf.layout.BoxBuilder;</span><br>          48:  <span style="background-color: white">      import com.openhtmltopdf.layout.BreakAtLineContext;</span><br>          49:  <span style="background-color: white">      import com.openhtmltopdf.layout.CounterFunction;</span><br>          50:  <span style="background-color: white">      import com.openhtmltopdf.layout.FloatManager;</span><br>          51:  <span style="background-color: white">      import com.openhtmltopdf.layout.InlineBoxing;</span><br>          52:  <span style="background-color: white">      import com.openhtmltopdf.layout.InlinePaintable;</span><br>          53:  <span style="background-color: white">      import com.openhtmltopdf.layout.LayoutContext;</span><br>          54:  <span style="background-color: white">      import com.openhtmltopdf.layout.PaintingInfo;</span><br>          55:  <span style="background-color: white">      import com.openhtmltopdf.layout.PersistentBFC;</span><br>          56:  <span style="background-color: white">      import com.openhtmltopdf.layout.Styleable;</span><br>          57:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableRowBox;</span><br>          58:  <span style="background-color: white">      import com.openhtmltopdf.util.ThreadCtx;</span><br>          59:  <span style="background-color: white">      </span><br>          60:  <span style="background-color: white">      /**</span><br>          61:  <span style="background-color: white">       * A block box as defined in the CSS spec.  It also provides a base class for</span><br>          62:  <span style="background-color: white">       * other kinds of block content (for example table rows or cells).</span><br>          63:  <span style="background-color: white">       */</span><br>          64:  <span style="background-color: white">      public class BlockBox extends Box implements InlinePaintable {</span><br>          65:  <span style="background-color: white">      </span><br>          66:  <span style="background-color: white">          public static final int POSITION_VERTICALLY = 1;</span><br>          67:  <span style="background-color: white">          public static final int POSITION_HORIZONTALLY = 2;</span><br>          68:  <span style="background-color: white">          public static final int POSITION_BOTH = POSITION_VERTICALLY | POSITION_HORIZONTALLY;</span><br>          69:  <span style="background-color: white">      </span><br>          70:  <span style="background-color: yellow">          public static final int CONTENT_UNKNOWN = 0;</span><br>          71:  <span style="background-color: yellow">          public static final int CONTENT_INLINE = 1;</span><br>          72:  <span style="background-color: yellow">          public static final int CONTENT_BLOCK = 2;</span><br>          73:  <span style="background-color: yellow">          public static final int CONTENT_EMPTY = 4;</span><br>          74:  <span style="background-color: white">      </span><br>          75:  <span style="background-color: white">          protected static final int NO_BASELINE = Integer.MIN_VALUE;</span><br>          76:  <span style="background-color: white">      </span><br>          77:  <span style="background-color: white">          private MarkerData _markerData;</span><br>          78:  <span style="background-color: white">      </span><br>          79:  <span style="background-color: white">          private int _listCounter;</span><br>          80:  <span style="background-color: white">      </span><br>          81:  <span style="background-color: white">          private PersistentBFC _persistentBFC;</span><br>          82:  <span style="background-color: white">      </span><br>          83:  <span style="background-color: white">          private Box _staticEquivalent;</span><br>          84:  <span style="background-color: white">      </span><br>          85:  <span style="background-color: white">          private boolean _needPageClear;</span><br>          86:  <span style="background-color: white">      </span><br>          87:  <span style="background-color: white">          private ReplacedElement _replacedElement;</span><br>          88:  <span style="background-color: white">      </span><br>          89:  <span style="background-color: yellow">          private int _childrenContentType;</span><br>          90:  <span style="background-color: white">      </span><br>          91:  <span style="background-color: white">          private List
       <styleable>
         _inlineContent;
       </styleable></span><br>          92:  <span style="background-color: white">      </span><br>          93:  <span style="background-color: white">          private boolean _topMarginCalculated;</span><br>          94:  <span style="background-color: white">          private boolean _bottomMarginCalculated;</span><br>          95:  <span style="background-color: white">          private MarginCollapseResult _pendingCollapseCalculation;</span><br>          96:  <span style="background-color: white">      </span><br>          97:  <span style="background-color: white">          private int _minWidth;</span><br>          98:  <span style="background-color: white">          private int _maxWidth;</span><br>          99:  <span style="background-color: white">          private boolean _minMaxCalculated;</span><br>         100:  <span style="background-color: white">      </span><br>         101:  <span style="background-color: white">          private boolean _dimensionsCalculated;</span><br>         102:  <span style="background-color: white">          private boolean _needShrinkToFitCalculatation;</span><br>         103:  <span style="background-color: white">      </span><br>         104:  <span style="background-color: white">          private CascadedStyle _firstLineStyle;</span><br>         105:  <span style="background-color: white">          private CascadedStyle _firstLetterStyle;</span><br>         106:  <span style="background-color: white">      </span><br>         107:  <span style="background-color: white">          private FloatedBoxData _floatedBoxData;</span><br>         108:  <span style="background-color: white">      </span><br>         109:  <span style="background-color: white">          private int _childrenHeight;</span><br>         110:  <span style="background-color: white">      </span><br>         111:  <span style="background-color: white">          private boolean _fromCaptionedTable;</span><br>         112:  <span style="background-color: white">          </span><br>         113:  <span style="background-color: white">          private boolean _isReplaced;</span><br>         114:  <span style="background-color: white">      </span><br>         115:  <span style="background-color: white"> 99+      public BlockBox() {</span><br>         116:  <span style="background-color: red"> 99+          super();</span><br>         117:  <span style="background-color: white">          }</span><br>         118:  <span style="background-color: white">          </span><br>         119:  <span style="background-color: red"> 99+      @Override</span><br>         120:  <span style="background-color: white">          public void setElement(Element element) {</span><br>         121:  <span style="background-color: red"> 99+      	super.setElement(element);</span><br>         122:  <span style="background-color: red"> 99+      	_isReplaced = ThreadCtx.get().sharedContext().getReplacedElementFactory().isReplacedElement(element);</span><br>         123:  <span style="background-color: white">          }</span><br>         124:  <span style="background-color: white">      </span><br>         125:  <span style="background-color: red"> 99+      public BlockBox copyOf() {</span><br>         126:  <span style="background-color: red"> 99+          BlockBox result = new BlockBox();</span><br>         127:  <span style="background-color: red"> 99+          result.setStyle(getStyle());</span><br>         128:  <span style="background-color: red"> 99+          result.setElement(getElement());</span><br>         129:  <span style="background-color: white">      </span><br>         130:  <span style="background-color: red"> 99+          return result;</span><br>         131:  <span style="background-color: white">          }</span><br>         132:  <span style="background-color: white">      </span><br>         133:  <span style="background-color: white">   0      protected String getExtraBoxDescription() {</span><br>         134:  <span style="background-color: white">   0          return "";</span><br>         135:  <span style="background-color: white">          }</span><br>         136:  <span style="background-color: white">          </span><br>         137:  <span style="background-color: cyan">   0      public String toString() {</span><br>         138:  <span style="background-color: white">   0          StringBuilder result = new StringBuilder();</span><br>         139:  <span style="background-color: white">   0          String className = getClass().getName();</span><br>         140:  <span style="background-color: white">   0          result.append(className.substring(className.lastIndexOf('.') + 1));</span><br>         141:  <span style="background-color: white">   0          result.append(": ");</span><br>         142:  <span style="background-color: white">   0          if (getElement() != null &amp;&amp; ! isAnonymous()) {</span><br>         143:  <span style="background-color: white">   0              result.append("&lt;");</span><br>         144:  <span style="background-color: white">   0              result.append(getElement().getNodeName());</span><br>         145:  <span style="background-color: white">   0              result.append("&gt; ");</span><br>         146:  <span style="background-color: white">              }</span><br>         147:  <span style="background-color: white">   0          if (isAnonymous()) {</span><br>         148:  <span style="background-color: white">   0              result.append("(anonymous) ");</span><br>         149:  <span style="background-color: white">              }</span><br>         150:  <span style="background-color: white">   0          if (getPseudoElementOrClass() != null) {</span><br>         151:  <span style="background-color: white">   0              result.append(':');</span><br>         152:  <span style="background-color: white">   0              result.append(getPseudoElementOrClass());</span><br>         153:  <span style="background-color: white">   0              result.append(' ');</span><br>         154:  <span style="background-color: white">              }</span><br>         155:  <span style="background-color: white">   0          result.append('(');</span><br>         156:  <span style="background-color: white">   0          result.append(getStyle().getIdent(CSSName.DISPLAY).toString());</span><br>         157:  <span style="background-color: white">   0          result.append(") ");</span><br>         158:  <span style="background-color: white">      </span><br>         159:  <span style="background-color: white">   0          if (getStyle().isRunning()) {</span><br>         160:  <span style="background-color: white">   0              result.append("(running) ");</span><br>         161:  <span style="background-color: white">              }</span><br>         162:  <span style="background-color: white">      </span><br>         163:  <span style="background-color: white">   0          result.append('(');</span><br>         164:  <span style="background-color: white">   0          switch (getChildrenContentType()) {</span><br>         165:  <span style="background-color: yellow">   0              case CONTENT_BLOCK:</span><br>         166:  <span style="background-color: white">   0                  result.append('B');</span><br>         167:  <span style="background-color: white">   0                  break;</span><br>         168:  <span style="background-color: yellow">   0              case CONTENT_INLINE:</span><br>         169:  <span style="background-color: white">   0                  result.append('I');</span><br>         170:  <span style="background-color: white">   0                  break;</span><br>         171:  <span style="background-color: yellow">   0              case CONTENT_EMPTY:</span><br>         172:  <span style="background-color: white">   0                  result.append('E');</span><br>         173:  <span style="background-color: white">   0                  break;</span><br>         174:  <span style="background-color: white">              }</span><br>         175:  <span style="background-color: white">   0          result.append(") ");</span><br>         176:  <span style="background-color: white">      </span><br>         177:  <span style="background-color: white">   0          result.append(getExtraBoxDescription());</span><br>         178:  <span style="background-color: white">      </span><br>         179:  <span style="background-color: white">   0          appendPositioningInfo(result);</span><br>         180:  <span style="background-color: white">   0          result.append("(" + getAbsX() + "," + getAbsY() + ")-&gt;(" + getWidth() + " x " + getHeight() + ")");</span><br>         181:  <span style="background-color: white">   0          return result.toString();</span><br>         182:  <span style="background-color: white">          }</span><br>         183:  <span style="background-color: white">      </span><br>         184:  <span style="background-color: white">   0      protected void appendPositioningInfo(StringBuilder result) {</span><br>         185:  <span style="background-color: white">   0          if (getStyle().isRelative()) {</span><br>         186:  <span style="background-color: white">   0              result.append("(relative) ");</span><br>         187:  <span style="background-color: white">              }</span><br>         188:  <span style="background-color: white">   0          if (getStyle().isFixed()) {</span><br>         189:  <span style="background-color: white">   0              result.append("(fixed) ");</span><br>         190:  <span style="background-color: white">              }</span><br>         191:  <span style="background-color: white">   0          if (getStyle().isAbsolute()) {</span><br>         192:  <span style="background-color: white">   0              result.append("(absolute) ");</span><br>         193:  <span style="background-color: white">              }</span><br>         194:  <span style="background-color: white">   0          if (getStyle().isFloated()) {</span><br>         195:  <span style="background-color: white">   0              result.append("(floated) ");</span><br>         196:  <span style="background-color: white">              }</span><br>         197:  <span style="background-color: white">          }</span><br>         198:  <span style="background-color: white">      </span><br>         199:  <span style="background-color: cyan">   0      public String dump(LayoutContext c, String indent, int which) {</span><br>         200:  <span style="background-color: white">   0          StringBuilder result = new StringBuilder(indent);</span><br>         201:  <span style="background-color: white">      </span><br>         202:  <span style="background-color: white">   0          ensureChildren(c);</span><br>         203:  <span style="background-color: white">      </span><br>         204:  <span style="background-color: white">   0          result.append(this);</span><br>         205:  <span style="background-color: white">      </span><br>         206:  <span style="background-color: yellow">   0          RectPropertySet margin = getMargin(c);</span><br>         207:  <span style="background-color: yellow">   0          result.append(" effMargin=[" + margin.top() + ", " + margin.right() + ", " +</span><br>         208:  <span style="background-color: yellow">                      margin.bottom() + ", " + margin.right() + "] ");</span><br>         209:  <span style="background-color: yellow">   0          RectPropertySet styleMargin = getStyleMargin(c);</span><br>         210:  <span style="background-color: yellow">   0          result.append(" styleMargin=[" + styleMargin.top() + ", " + styleMargin.right() + ", " +</span><br>         211:  <span style="background-color: yellow">                      styleMargin.bottom() + ", " + styleMargin.right() + "] ");</span><br>         212:  <span style="background-color: white">      </span><br>         213:  <span style="background-color: yellow">   0          if (getChildrenContentType() != CONTENT_EMPTY) {</span><br>         214:  <span style="background-color: white">   0              result.append('\n');</span><br>         215:  <span style="background-color: white">              }</span><br>         216:  <span style="background-color: white">      </span><br>         217:  <span style="background-color: white">   0          switch (getChildrenContentType()) {</span><br>         218:  <span style="background-color: yellow">   0              case CONTENT_BLOCK:</span><br>         219:  <span style="background-color: white">   0                  dumpBoxes(c, indent, getChildren(), which, result);</span><br>         220:  <span style="background-color: white">   0                  break;</span><br>         221:  <span style="background-color: yellow">   0              case CONTENT_INLINE:</span><br>         222:  <span style="background-color: white">   0                  if (which == Box.DUMP_RENDER) {</span><br>         223:  <span style="background-color: white">   0                      dumpBoxes(c, indent, getChildren(), which, result);</span><br>         224:  <span style="background-color: white">                      } else {</span><br>         225:  <span style="background-color: white">   0                      for (Iterator
       <styleable>
         i = getInlineContent().iterator(); i.hasNext();) {
       </styleable></span><br>         226:  <span style="background-color: white">   0                          Styleable styleable = i.next();</span><br>         227:  <span style="background-color: white">   0                          if (styleable instanceof BlockBox) {</span><br>         228:  <span style="background-color: white">   0                              BlockBox b = (BlockBox) styleable;</span><br>         229:  <span style="background-color: white">   0                              result.append(b.dump(c, indent + "  ", which));</span><br>         230:  <span style="background-color: white">   0                              if (result.charAt(result.length() - 1) == '\n') {</span><br>         231:  <span style="background-color: white">   0                                  result.deleteCharAt(result.length() - 1);</span><br>         232:  <span style="background-color: white">                                  }</span><br>         233:  <span style="background-color: white">                              } else {</span><br>         234:  <span style="background-color: white">   0                              result.append(indent + "  ");</span><br>         235:  <span style="background-color: white">   0                              result.append(styleable.toString());</span><br>         236:  <span style="background-color: white">                              }</span><br>         237:  <span style="background-color: white">   0                          if (i.hasNext()) {</span><br>         238:  <span style="background-color: white">   0                              result.append('\n');</span><br>         239:  <span style="background-color: white">                              }</span><br>         240:  <span style="background-color: white">                          }</span><br>         241:  <span style="background-color: white">                      }</span><br>         242:  <span style="background-color: white">   0                  break;</span><br>         243:  <span style="background-color: white">              }</span><br>         244:  <span style="background-color: white">      </span><br>         245:  <span style="background-color: white">   0          return result.toString();</span><br>         246:  <span style="background-color: white">          }</span><br>         247:  <span style="background-color: white">          </span><br>         248:  <span style="background-color: red"> 99+      public boolean isListItem() {</span><br>         249:  <span style="background-color: white"> 99+      	return getStyle().isListItem();</span><br>         250:  <span style="background-color: white">          }</span><br>         251:  <span style="background-color: white">      </span><br>         252:  <span style="background-color: cyan"> 99+      public void paintListMarker(RenderingContext c) {</span><br>         253:  <span style="background-color: cyan"> 99+          if (! getStyle().isVisible(c, this)) {</span><br>         254:  <span style="background-color: white">   0              return;</span><br>         255:  <span style="background-color: white">              }</span><br>         256:  <span style="background-color: white">      </span><br>         257:  <span style="background-color: white"> 99+          if (isListItem()) {</span><br>         258:  <span style="background-color: cyan"> 99+              ListItemPainter.paint(c, this);</span><br>         259:  <span style="background-color: white">              }</span><br>         260:  <span style="background-color: white">          }</span><br>         261:  <span style="background-color: white">      </span><br>         262:  <span style="background-color: cyan"> 99+      public Rectangle getPaintingClipEdge(CssContext cssCtx) {</span><br>         263:  <span style="background-color: red"> 99+          Rectangle result = super.getPaintingClipEdge(cssCtx);</span><br>         264:  <span style="background-color: white">      </span><br>         265:  <span style="background-color: white">              // HACK Don't know how wide the list marker is (or even where it is)</span><br>         266:  <span style="background-color: white">              // so extend the bounding box all the way over to the left edge of</span><br>         267:  <span style="background-color: white">              // the canvas</span><br>         268:  <span style="background-color: white"> 99+          if (getStyle().isListItem()) {</span><br>         269:  <span style="background-color: white"> 99+              int delta = result.x;</span><br>         270:  <span style="background-color: white"> 99+              result.x = 0;</span><br>         271:  <span style="background-color: white"> 99+              result.width += delta;</span><br>         272:  <span style="background-color: white">              }</span><br>         273:  <span style="background-color: white">      </span><br>         274:  <span style="background-color: red"> 99+          return result;</span><br>         275:  <span style="background-color: white">          }</span><br>         276:  <span style="background-color: white">          </span><br>         277:  <span style="background-color: white">   0      @Override</span><br>         278:  <span style="background-color: white">          public void paintInline(RenderingContext c) {</span><br>         279:  <span style="background-color: white">   0          if (! getStyle().isVisible(c, this)) {</span><br>         280:  <span style="background-color: white">   0              return;</span><br>         281:  <span style="background-color: white">              }</span><br>         282:  <span style="background-color: white">      </span><br>         283:  <span style="background-color: white">   0          getContainingLayer().paintAsLayer(c, this);</span><br>         284:  <span style="background-color: white">          }</span><br>         285:  <span style="background-color: white">      </span><br>         286:  <span style="background-color: red"> 99+      public boolean isInline() {</span><br>         287:  <span style="background-color: red"> 99+          Box parent = getParent();</span><br>         288:  <span style="background-color: red"> 99+          return parent instanceof LineBox || parent instanceof InlineLayoutBox;</span><br>         289:  <span style="background-color: white">          }</span><br>         290:  <span style="background-color: white">      </span><br>         291:  <span style="background-color: red"> 99+      public LineBox getLineBox() {</span><br>         292:  <span style="background-color: white"> 99+          if (! isInline()) {</span><br>         293:  <span style="background-color: red"> 99+              return null;</span><br>         294:  <span style="background-color: white">              } else {</span><br>         295:  <span style="background-color: red"> 99+              return (LineBox) findAncestor(bx -&gt; bx instanceof LineBox);</span><br>         296:  <span style="background-color: white">              }</span><br>         297:  <span style="background-color: white">          }</span><br>         298:  <span style="background-color: white">      </span><br>         299:  <span style="background-color: white">   0      public void paintDebugOutline(RenderingContext c) {</span><br>         300:  <span style="background-color: white">   0          c.getOutputDevice().drawDebugOutline(c, this, FSRGBColor.RED);</span><br>         301:  <span style="background-color: white">          }</span><br>         302:  <span style="background-color: white">      </span><br>         303:  <span style="background-color: red"> 99+      public MarkerData getMarkerData() {</span><br>         304:  <span style="background-color: white"> 99+          return _markerData;</span><br>         305:  <span style="background-color: white">          }</span><br>         306:  <span style="background-color: white">      </span><br>         307:  <span style="background-color: white"> 99+      public void setMarkerData(MarkerData markerData) {</span><br>         308:  <span style="background-color: white"> 99+          _markerData = markerData;</span><br>         309:  <span style="background-color: white">          }</span><br>         310:  <span style="background-color: white">      </span><br>         311:  <span style="background-color: red"> 99+      public void createMarkerData(LayoutContext c) {</span><br>         312:  <span style="background-color: red"> 99+          if (getMarkerData() != null)</span><br>         313:  <span style="background-color: white">              {</span><br>         314:  <span style="background-color: red">   0              return;</span><br>         315:  <span style="background-color: white">              }</span><br>         316:  <span style="background-color: white">      </span><br>         317:  <span style="background-color: white"> 99+          StrutMetrics strutMetrics = InlineBoxing.createDefaultStrutMetrics(c, this);</span><br>         318:  <span style="background-color: white">      </span><br>         319:  <span style="background-color: white"> 99+          boolean imageMarker = false;</span><br>         320:  <span style="background-color: white">      </span><br>         321:  <span style="background-color: white"> 99+          MarkerData result = new MarkerData();</span><br>         322:  <span style="background-color: white"> 99+          result.setStructMetrics(strutMetrics);</span><br>         323:  <span style="background-color: white">      </span><br>         324:  <span style="background-color: white"> 99+          CalculatedStyle style = getStyle();</span><br>         325:  <span style="background-color: white"> 99+          IdentValue listStyle = style.getIdent(CSSName.LIST_STYLE_TYPE);</span><br>         326:  <span style="background-color: white">      </span><br>         327:  <span style="background-color: white"> 99+          String image = style.getStringProperty(CSSName.LIST_STYLE_IMAGE);</span><br>         328:  <span style="background-color: white"> 99+          if (! image.equals("none")) {</span><br>         329:  <span style="background-color: white">   0              result.setImageMarker(makeImageMarker(c, strutMetrics, image));</span><br>         330:  <span style="background-color: white">   0              imageMarker = result.getImageMarker() != null;</span><br>         331:  <span style="background-color: white">              }</span><br>         332:  <span style="background-color: white">      </span><br>         333:  <span style="background-color: white"> 99+          if (listStyle != IdentValue.NONE &amp;&amp; ! imageMarker) {</span><br>         334:  <span style="background-color: white"> 99+              if (listStyle == IdentValue.CIRCLE || listStyle == IdentValue.SQUARE ||</span><br>         335:  <span style="background-color: white">                          listStyle == IdentValue.DISC) {</span><br>         336:  <span style="background-color: white">  97                  result.setGlyphMarker(makeGlyphMarker(strutMetrics));</span><br>         337:  <span style="background-color: white">                  } else {</span><br>         338:  <span style="background-color: white">  50                  result.setTextMarker(makeTextMarker(c, listStyle));</span><br>         339:  <span style="background-color: white">                  }</span><br>         340:  <span style="background-color: white">              }</span><br>         341:  <span style="background-color: white">      </span><br>         342:  <span style="background-color: white"> 99+          setMarkerData(result);</span><br>         343:  <span style="background-color: white">          }</span><br>         344:  <span style="background-color: white">      </span><br>         345:  <span style="background-color: white">  97      private MarkerData.GlyphMarker makeGlyphMarker(StrutMetrics strutMetrics) {</span><br>         346:  <span style="background-color: white">  97          int diameter = (int) ((strutMetrics.getAscent() + strutMetrics.getDescent()) / 3);</span><br>         347:  <span style="background-color: white">      </span><br>         348:  <span style="background-color: white">  97          MarkerData.GlyphMarker result = new MarkerData.GlyphMarker();</span><br>         349:  <span style="background-color: white">  97          result.setDiameter(diameter);</span><br>         350:  <span style="background-color: white">  97          result.setLayoutWidth(diameter * 3);</span><br>         351:  <span style="background-color: white">      </span><br>         352:  <span style="background-color: white">  97          return result;</span><br>         353:  <span style="background-color: white">          }</span><br>         354:  <span style="background-color: white">      </span><br>         355:  <span style="background-color: white">      </span><br>         356:  <span style="background-color: white">   0      private MarkerData.ImageMarker makeImageMarker(</span><br>         357:  <span style="background-color: white">                  LayoutContext c, StrutMetrics structMetrics, String image) {</span><br>         358:  <span style="background-color: white">   0          FSImage img = null;</span><br>         359:  <span style="background-color: white">   0          if (! image.equals("none")) {</span><br>         360:  <span style="background-color: white">   0              img = c.getUac().getImageResource(image).getImage();</span><br>         361:  <span style="background-color: white">   0              if (img != null) {</span><br>         362:  <span style="background-color: white">   0                  StrutMetrics strutMetrics = structMetrics;</span><br>         363:  <span style="background-color: white">   0                  if (img.getHeight() &gt; strutMetrics.getAscent()) {</span><br>         364:  <span style="background-color: white">   0                      img.scale(-1, (int) strutMetrics.getAscent());</span><br>         365:  <span style="background-color: white">                      }</span><br>         366:  <span style="background-color: white">   0                  MarkerData.ImageMarker result = new MarkerData.ImageMarker();</span><br>         367:  <span style="background-color: white">   0                  result.setImage(img);</span><br>         368:  <span style="background-color: white">   0                  result.setLayoutWidth(img.getWidth() * 2);</span><br>         369:  <span style="background-color: white">   0                  return result;</span><br>         370:  <span style="background-color: white">                  }</span><br>         371:  <span style="background-color: white">              }</span><br>         372:  <span style="background-color: white">   0          return null;</span><br>         373:  <span style="background-color: white">          }</span><br>         374:  <span style="background-color: white">      </span><br>         375:  <span style="background-color: white">  50      private MarkerData.TextMarker makeTextMarker(LayoutContext c, IdentValue listStyle) {</span><br>         376:  <span style="background-color: white">  50          String text;</span><br>         377:  <span style="background-color: white">      </span><br>         378:  <span style="background-color: white">  50          int listCounter = getListCounter();</span><br>         379:  <span style="background-color: white">  50          text = CounterFunction.createCounterText(listStyle, listCounter);</span><br>         380:  <span style="background-color: white">      </span><br>         381:  <span style="background-color: white">  50          IdentValue listDirection = getParent().getStyle().getDirection();</span><br>         382:  <span style="background-color: white">      </span><br>         383:  <span style="background-color: white">  50          if (listDirection == IdentValue.RTL) {</span><br>         384:  <span style="background-color: white">  12              text = "  .".concat(text);</span><br>         385:  <span style="background-color: white">              } else {</span><br>         386:  <span style="background-color: white">  38              assert listDirection == IdentValue.LTR || listDirection == IdentValue.AUTO;</span><br>         387:  <span style="background-color: white">  38              text = text.concat(".  ");</span><br>         388:  <span style="background-color: white">              }</span><br>         389:  <span style="background-color: white">      </span><br>         390:  <span style="background-color: white">  50          int w = c.getTextRenderer().getWidth(</span><br>         391:  <span style="background-color: white">                      c.getFontContext(),</span><br>         392:  <span style="background-color: white">                      getStyle().getFSFont(c),</span><br>         393:  <span style="background-color: white">                      text);</span><br>         394:  <span style="background-color: white">      </span><br>         395:  <span style="background-color: white">  50          MarkerData.TextMarker result = new MarkerData.TextMarker();</span><br>         396:  <span style="background-color: white">      </span><br>         397:  <span style="background-color: white">  50          result.setLayoutWidth(w);</span><br>         398:  <span style="background-color: white">  50          result.setText(text);</span><br>         399:  <span style="background-color: white">      </span><br>         400:  <span style="background-color: white">  50          return result;</span><br>         401:  <span style="background-color: white">          }</span><br>         402:  <span style="background-color: white">      </span><br>         403:  <span style="background-color: white">  50      public int getListCounter() {</span><br>         404:  <span style="background-color: white">  50          return _listCounter;</span><br>         405:  <span style="background-color: white">          }</span><br>         406:  <span style="background-color: white">      </span><br>         407:  <span style="background-color: white"> 99+      public void setListCounter(int listCounter) {</span><br>         408:  <span style="background-color: white"> 99+          _listCounter = listCounter;</span><br>         409:  <span style="background-color: white">          }</span><br>         410:  <span style="background-color: white">      </span><br>         411:  <span style="background-color: cyan"> 99+      public PersistentBFC getPersistentBFC() {</span><br>         412:  <span style="background-color: white"> 99+          return _persistentBFC;</span><br>         413:  <span style="background-color: white">          }</span><br>         414:  <span style="background-color: white">      </span><br>         415:  <span style="background-color: cyan"> 99+      public void setPersistentBFC(PersistentBFC persistentBFC) {</span><br>         416:  <span style="background-color: cyan"> 99+          _persistentBFC = persistentBFC;</span><br>         417:  <span style="background-color: white">          }</span><br>         418:  <span style="background-color: white">      </span><br>         419:  <span style="background-color: red"> 99+      public Box getStaticEquivalent() {</span><br>         420:  <span style="background-color: white"> 99+          return _staticEquivalent;</span><br>         421:  <span style="background-color: white">          }</span><br>         422:  <span style="background-color: white">      </span><br>         423:  <span style="background-color: red"> 99+      public void setStaticEquivalent(Box staticEquivalent) {</span><br>         424:  <span style="background-color: red"> 99+          _staticEquivalent = staticEquivalent;</span><br>         425:  <span style="background-color: white">          }</span><br>         426:  <span style="background-color: white">      </span><br>         427:  <span style="background-color: red"> 99+      public boolean shouldBeReplaced() {</span><br>         428:  <span style="background-color: white"> 99+      	return _isReplaced;</span><br>         429:  <span style="background-color: white">          }</span><br>         430:  <span style="background-color: white">          </span><br>         431:  <span style="background-color: red"> 99+      public boolean isReplaced() {</span><br>         432:  <span style="background-color: red"> 99+          return _replacedElement != null;</span><br>         433:  <span style="background-color: white">          }</span><br>         434:  <span style="background-color: white">      </span><br>         435:  <span style="background-color: red"> 99+      @Override</span><br>         436:  <span style="background-color: white">          public void calcCanvasLocation() {</span><br>         437:  <span style="background-color: white"> 99+          if (isFloated()) {</span><br>         438:  <span style="background-color: red"> 99+              FloatManager manager = _floatedBoxData.getManager();</span><br>         439:  <span style="background-color: red"> 99+              if (manager != null) {</span><br>         440:  <span style="background-color: red"> 99+                  Point offset = manager.getOffset(this);</span><br>         441:  <span style="background-color: red"> 99+                  setAbsX(manager.getMaster().getAbsX() + getX() - offset.x);</span><br>         442:  <span style="background-color: red"> 99+                  setAbsY(manager.getMaster().getAbsY() + getY() - offset.y);</span><br>         443:  <span style="background-color: white">                  }</span><br>         444:  <span style="background-color: white">              }</span><br>         445:  <span style="background-color: white">      </span><br>         446:  <span style="background-color: red"> 99+          LineBox lineBox = getLineBox();</span><br>         447:  <span style="background-color: red"> 99+          if (lineBox == null) {</span><br>         448:  <span style="background-color: red"> 99+              Box parent = getParent();</span><br>         449:  <span style="background-color: red"> 99+              if (parent != null) {</span><br>         450:  <span style="background-color: red"> 99+                  setAbsX(parent.getAbsX() + parent.getTx() + getX());</span><br>         451:  <span style="background-color: red"> 99+                  setAbsY(parent.getAbsY() + parent.getTy() + getY());</span><br>         452:  <span style="background-color: white"> 99+              } else if (isStyled() &amp;&amp; getStyle().isAbsFixedOrInlineBlockEquiv()) {</span><br>         453:  <span style="background-color: red"> 99+                  Box cb = getContainingBlock();</span><br>         454:  <span style="background-color: red"> 99+                  if (cb != null) {</span><br>         455:  <span style="background-color: red"> 99+                      setAbsX(cb.getAbsX() + getX());</span><br>         456:  <span style="background-color: red"> 99+                      setAbsY(cb.getAbsY() + getY());</span><br>         457:  <span style="background-color: white">                      }</span><br>         458:  <span style="background-color: white">                  }</span><br>         459:  <span style="background-color: white">              } else {</span><br>         460:  <span style="background-color: red"> 99+              setAbsX(lineBox.getAbsX() + getX());</span><br>         461:  <span style="background-color: red"> 99+              setAbsY(lineBox.getAbsY() + getY());</span><br>         462:  <span style="background-color: white">              }</span><br>         463:  <span style="background-color: white">      </span><br>         464:  <span style="background-color: white"> 99+          if (isReplaced()) {</span><br>         465:  <span style="background-color: red"> 99+              Point location = getReplacedElement().getLocation();</span><br>         466:  <span style="background-color: red"> 99+              if (location.x != getAbsX() || location.y != getAbsY()) {</span><br>         467:  <span style="background-color: white"> 99+                  getReplacedElement().setLocation(getAbsX(), getAbsY());</span><br>         468:  <span style="background-color: white">                  }</span><br>         469:  <span style="background-color: white">              }</span><br>         470:  <span style="background-color: white">          }</span><br>         471:  <span style="background-color: white">      </span><br>         472:  <span style="background-color: red"> 99+      public void calcInitialFloatedCanvasLocation(LayoutContext c) {</span><br>         473:  <span style="background-color: red"> 99+          Point offset = c.getBlockFormattingContext().getOffset();</span><br>         474:  <span style="background-color: red"> 99+          FloatManager manager = c.getBlockFormattingContext().getFloatManager();</span><br>         475:  <span style="background-color: red"> 99+          setAbsX(manager.getMaster().getAbsX() + getX() - offset.x);</span><br>         476:  <span style="background-color: red"> 99+          setAbsY(manager.getMaster().getAbsY() + getY() - offset.y);</span><br>         477:  <span style="background-color: white">          }</span><br>         478:  <span style="background-color: white">      </span><br>         479:  <span style="background-color: red"> 99+      @Override</span><br>         480:  <span style="background-color: white">          public void calcChildLocations() {</span><br>         481:  <span style="background-color: red"> 99+          super.calcChildLocations();</span><br>         482:  <span style="background-color: white">      </span><br>         483:  <span style="background-color: red"> 99+          if (_persistentBFC != null) {</span><br>         484:  <span style="background-color: white"> 99+              _persistentBFC.getFloatManager().calcFloatLocations();</span><br>         485:  <span style="background-color: white">              }</span><br>         486:  <span style="background-color: white">          }</span><br>         487:  <span style="background-color: white">      </span><br>         488:  <span style="background-color: red"> 99+      public boolean isNeedPageClear() {</span><br>         489:  <span style="background-color: white"> 99+          return _needPageClear;</span><br>         490:  <span style="background-color: white">          }</span><br>         491:  <span style="background-color: white">      </span><br>         492:  <span style="background-color: red"> 99+      public void setNeedPageClear(boolean needPageClear) {</span><br>         493:  <span style="background-color: red"> 99+          _needPageClear = needPageClear;</span><br>         494:  <span style="background-color: white">          }</span><br>         495:  <span style="background-color: white">      </span><br>         496:  <span style="background-color: white">      </span><br>         497:  <span style="background-color: red">  11      private void alignToStaticEquivalent() {</span><br>         498:  <span style="background-color: white">  11          if (_staticEquivalent.getAbsY() != getAbsY()) {</span><br>         499:  <span style="background-color: white">   8              setY(_staticEquivalent.getAbsY() - getAbsY());</span><br>         500:  <span style="background-color: white">   8              setAbsY(_staticEquivalent.getAbsY());</span><br>         501:  <span style="background-color: white">              }</span><br>         502:  <span style="background-color: white">          }</span><br>         503:  <span style="background-color: white">      </span><br>         504:  <span style="background-color: red"> 99+      public void positionAbsolute(CssContext cssCtx, int direction) {</span><br>         505:  <span style="background-color: red"> 99+          CalculatedStyle style = getStyle();</span><br>         506:  <span style="background-color: white">      </span><br>         507:  <span style="background-color: red"> 99+          Rectangle boundingBox = null;</span><br>         508:  <span style="background-color: white">      </span><br>         509:  <span style="background-color: red"> 99+          int cbContentHeight = getContainingBlock().getContentAreaEdge(0, 0, cssCtx).height;</span><br>         510:  <span style="background-color: white">      </span><br>         511:  <span style="background-color: red"> 99+          if (getContainingBlock() instanceof BlockBox) {</span><br>         512:  <span style="background-color: red"> 99+              boundingBox = getContainingBlock().getPaddingEdge(0, 0, cssCtx);</span><br>         513:  <span style="background-color: white">              } else {</span><br>         514:  <span style="background-color: white">   0              boundingBox = getContainingBlock().getContentAreaEdge(0, 0, cssCtx);</span><br>         515:  <span style="background-color: white">              }</span><br>         516:  <span style="background-color: white">      </span><br>         517:  <span style="background-color: red"> 99+          if ((direction &amp; POSITION_HORIZONTALLY) != 0) {</span><br>         518:  <span style="background-color: red"> 99+              setX(0);</span><br>         519:  <span style="background-color: red"> 99+              if (!style.isIdent(CSSName.LEFT, IdentValue.AUTO)) {</span><br>         520:  <span style="background-color: red"> 99+                  setX((int) style.getFloatPropertyProportionalWidth(CSSName.LEFT, getContainingBlock().getContentWidth(), cssCtx));</span><br>         521:  <span style="background-color: red">  79              } else if (!style.isIdent(CSSName.RIGHT, IdentValue.AUTO)) {</span><br>         522:  <span style="background-color: white">  35                  setX(boundingBox.width -</span><br>         523:  <span style="background-color: white">                              (int) style.getFloatPropertyProportionalWidth(CSSName.RIGHT, getContainingBlock().getContentWidth(), cssCtx) - getWidth());</span><br>         524:  <span style="background-color: white">                  }</span><br>         525:  <span style="background-color: red"> 99+              setX(getX() + boundingBox.x);</span><br>         526:  <span style="background-color: white">              }</span><br>         527:  <span style="background-color: white">      </span><br>         528:  <span style="background-color: red"> 99+          if ((direction &amp; POSITION_VERTICALLY) != 0) {</span><br>         529:  <span style="background-color: red"> 99+              setY(0);</span><br>         530:  <span style="background-color: red"> 99+              if (!style.isIdent(CSSName.TOP, IdentValue.AUTO)) {</span><br>         531:  <span style="background-color: red"> 99+                  setY((int) style.getFloatPropertyProportionalHeight(CSSName.TOP, cbContentHeight, cssCtx));</span><br>         532:  <span style="background-color: red">  46              } else if (!style.isIdent(CSSName.BOTTOM, IdentValue.AUTO)) {</span><br>         533:  <span style="background-color: red">  35                  setY(boundingBox.height -</span><br>         534:  <span style="background-color: white">                              (int) style.getFloatPropertyProportionalWidth(CSSName.BOTTOM, cbContentHeight, cssCtx) - getHeight());</span><br>         535:  <span style="background-color: white">                  }</span><br>         536:  <span style="background-color: white">      </span><br>         537:  <span style="background-color: white">                  // Can't do this before now because our containing block</span><br>         538:  <span style="background-color: white">                  // must be completed layed out</span><br>         539:  <span style="background-color: red"> 99+              int pinnedHeight = calcPinnedHeight(cssCtx);</span><br>         540:  <span style="background-color: red"> 99+              if (pinnedHeight != -1 &amp;&amp; getCSSHeight(cssCtx) == -1) {</span><br>         541:  <span style="background-color: white">   0                  setHeight(pinnedHeight);</span><br>         542:  <span style="background-color: white">   0                  applyCSSMinMaxHeight(cssCtx);</span><br>         543:  <span style="background-color: white">                  }</span><br>         544:  <span style="background-color: white">      </span><br>         545:  <span style="background-color: red"> 99+              setY(getY() + boundingBox.y);</span><br>         546:  <span style="background-color: white">              }</span><br>         547:  <span style="background-color: white">      </span><br>         548:  <span style="background-color: white"> 99+          calcCanvasLocation();</span><br>         549:  <span style="background-color: white">      </span><br>         550:  <span style="background-color: red"> 99+          if ((direction &amp; POSITION_VERTICALLY) != 0 &amp;&amp;</span><br>         551:  <span style="background-color: white">                      getStyle().isTopAuto() &amp;&amp; getStyle().isBottomAuto()) {</span><br>         552:  <span style="background-color: white">  11              alignToStaticEquivalent();</span><br>         553:  <span style="background-color: white">              }</span><br>         554:  <span style="background-color: white">      </span><br>         555:  <span style="background-color: white"> 99+          calcChildLocations();</span><br>         556:  <span style="background-color: white">          }</span><br>         557:  <span style="background-color: white">      </span><br>         558:  <span style="background-color: white">      	/**</span><br>         559:  <span style="background-color: white">           * Using the css:</span><br>         560:  <span style="background-color: white">           *</span><br>         561:  <span style="background-color: white">           * -fs-page-break-min-height: 5cm;</span><br>         562:  <span style="background-color: white">           *</span><br>         563:  <span style="background-color: white">           * on a block element you can force a pagebreak before this block, if not</span><br>         564:  <span style="background-color: white">           * enough space (e.g. 5cm in this case) is remaining on the current page for the block.</span><br>         565:  <span style="background-color: white">           *</span><br>         566:  <span style="background-color: white">           * @return true if a pagebreak is needed before this block because</span><br>         567:  <span style="background-color: white">           * there is not enough space left on the current page.</span><br>         568:  <span style="background-color: white">           */</span><br>         569:  <span style="background-color: red"> 99+      public boolean isPageBreakNeededBecauseOfMinHeight(LayoutContext context){</span><br>         570:  <span style="background-color: red"> 99+          float minHeight = getStyle().getFSPageBreakMinHeight(context);</span><br>         571:  <span style="background-color: red"> 99+          PageBox page = context.getRootLayer().getFirstPage(context, this);</span><br>         572:  <span style="background-color: red"> 99+          return page != null &amp;&amp; getAbsY() + minHeight &gt; page.getBottom();</span><br>         573:  <span style="background-color: white">          }</span><br>         574:  <span style="background-color: white">      </span><br>         575:  <span style="background-color: white">      </span><br>         576:  <span style="background-color: red">  93      public void positionAbsoluteOnPage(LayoutContext c) {</span><br>         577:  <span style="background-color: red">  93          if (c.isPrint() &amp;&amp;</span><br>         578:  <span style="background-color: white">                      (getStyle().isForcePageBreakBefore() || isNeedPageClear() || isPageBreakNeededBecauseOfMinHeight(c))) {</span><br>         579:  <span style="background-color: red">   0              forcePageBreakBefore(c, getStyle().getIdent(CSSName.PAGE_BREAK_BEFORE), false);</span><br>         580:  <span style="background-color: white">   0              calcCanvasLocation();</span><br>         581:  <span style="background-color: white">   0              calcChildLocations();</span><br>         582:  <span style="background-color: white">      </span><br>         583:  <span style="background-color: red">   0              setNeedPageClear(false);</span><br>         584:  <span style="background-color: white">              }</span><br>         585:  <span style="background-color: white">          }</span><br>         586:  <span style="background-color: white">      </span><br>         587:  <span style="background-color: red"> 99+      public ReplacedElement getReplacedElement() {</span><br>         588:  <span style="background-color: white"> 99+          return _replacedElement;</span><br>         589:  <span style="background-color: white">          }</span><br>         590:  <span style="background-color: white">      </span><br>         591:  <span style="background-color: red"> 99+      public void setReplacedElement(ReplacedElement replacedElement) {</span><br>         592:  <span style="background-color: red"> 99+          _replacedElement = replacedElement;</span><br>         593:  <span style="background-color: white">          }</span><br>         594:  <span style="background-color: white">      </span><br>         595:  <span style="background-color: red"> 99+      @Override</span><br>         596:  <span style="background-color: white">          public void reset(LayoutContext c) {</span><br>         597:  <span style="background-color: red"> 99+          super.reset(c);</span><br>         598:  <span style="background-color: red"> 99+          setTopMarginCalculated(false);</span><br>         599:  <span style="background-color: red"> 99+          setBottomMarginCalculated(false);</span><br>         600:  <span style="background-color: red"> 99+          setDimensionsCalculated(false);</span><br>         601:  <span style="background-color: red"> 99+          setMinMaxCalculated(false);</span><br>         602:  <span style="background-color: red"> 99+          setChildrenHeight(0);</span><br>         603:  <span style="background-color: white"> 99+          if (isReplaced()) {</span><br>         604:  <span style="background-color: red">  42              getReplacedElement().detach(c);</span><br>         605:  <span style="background-color: red">  42              setReplacedElement(null);</span><br>         606:  <span style="background-color: white">              }</span><br>         607:  <span style="background-color: yellow"> 99+          if (getChildrenContentType() == BlockBox.CONTENT_INLINE) {</span><br>         608:  <span style="background-color: white"> 99+              removeAllChildren();</span><br>         609:  <span style="background-color: white">              }</span><br>         610:  <span style="background-color: white">      </span><br>         611:  <span style="background-color: white"> 99+          if (isFloated()) {</span><br>         612:  <span style="background-color: white">  26              _floatedBoxData.getManager().removeFloat(this);</span><br>         613:  <span style="background-color: white">  26              _floatedBoxData.getDrawingLayer().removeFloat(this);</span><br>         614:  <span style="background-color: white">              }</span><br>         615:  <span style="background-color: white">      </span><br>         616:  <span style="background-color: white"> 99+          if (getStyle().isRunning()) {</span><br>         617:  <span style="background-color: white">   0              c.getRootLayer().removeRunningBlock(this);</span><br>         618:  <span style="background-color: white">              }</span><br>         619:  <span style="background-color: white">          }</span><br>         620:  <span style="background-color: white">      </span><br>         621:  <span style="background-color: red">  39      private int calcPinnedContentWidth(CssContext c) {</span><br>         622:  <span style="background-color: red">  39          if (! getStyle().isIdent(CSSName.LEFT, IdentValue.AUTO) &amp;&amp;</span><br>         623:  <span style="background-color: white">                      ! getStyle().isIdent(CSSName.RIGHT, IdentValue.AUTO)) {</span><br>         624:  <span style="background-color: red">  13              Rectangle paddingEdge = getContainingBlock().getPaddingEdge(0, 0, c);</span><br>         625:  <span style="background-color: white">      </span><br>         626:  <span style="background-color: red">  13              int left = (int) getStyle().getFloatPropertyProportionalTo(</span><br>         627:  <span style="background-color: white">                          CSSName.LEFT, paddingEdge.width, c);</span><br>         628:  <span style="background-color: red">  13              int right = (int) getStyle().getFloatPropertyProportionalTo(</span><br>         629:  <span style="background-color: white">                          CSSName.RIGHT, paddingEdge.width, c);</span><br>         630:  <span style="background-color: white">      </span><br>         631:  <span style="background-color: red">  13              int result = paddingEdge.width - left - right - getLeftMBP() - getRightMBP();</span><br>         632:  <span style="background-color: red">  13              return result &lt; 0 ? 0 : result;</span><br>         633:  <span style="background-color: white">              }</span><br>         634:  <span style="background-color: white">      </span><br>         635:  <span style="background-color: red">  26          return -1;</span><br>         636:  <span style="background-color: white">          }</span><br>         637:  <span style="background-color: white">      </span><br>         638:  <span style="background-color: red"> 99+      private int calcPinnedHeight(CssContext c) {</span><br>         639:  <span style="background-color: red"> 99+          if (! getStyle().isIdent(CSSName.TOP, IdentValue.AUTO) &amp;&amp;</span><br>         640:  <span style="background-color: white">                      ! getStyle().isIdent(CSSName.BOTTOM, IdentValue.AUTO)) {</span><br>         641:  <span style="background-color: white">   0              Rectangle paddingEdge = getContainingBlock().getPaddingEdge(0, 0, c);</span><br>         642:  <span style="background-color: white">      </span><br>         643:  <span style="background-color: white">   0              int top = (int) getStyle().getFloatPropertyProportionalTo(</span><br>         644:  <span style="background-color: white">                          CSSName.TOP, paddingEdge.height, c);</span><br>         645:  <span style="background-color: white">   0              int bottom = (int) getStyle().getFloatPropertyProportionalTo(</span><br>         646:  <span style="background-color: white">                          CSSName.BOTTOM, paddingEdge.height, c);</span><br>         647:  <span style="background-color: white">      </span><br>         648:  <span style="background-color: white">      </span><br>         649:  <span style="background-color: white">   0              int result = paddingEdge.height - top - bottom;</span><br>         650:  <span style="background-color: white">   0              return result &lt; 0 ? 0 : result;</span><br>         651:  <span style="background-color: white">              }</span><br>         652:  <span style="background-color: white">      </span><br>         653:  <span style="background-color: red"> 99+          return -1;</span><br>         654:  <span style="background-color: white">          }</span><br>         655:  <span style="background-color: white">      </span><br>         656:  <span style="background-color: white">   5      protected void resolveAutoMargins(</span><br>         657:  <span style="background-color: white">                  LayoutContext c, int cssWidth,</span><br>         658:  <span style="background-color: white">                  RectPropertySet padding, BorderPropertySet border) {</span><br>         659:  <span style="background-color: white">   5          int withoutMargins =</span><br>         660:  <span style="background-color: white">                      (int) border.left() + (int) padding.left() +</span><br>         661:  <span style="background-color: white">                              cssWidth +</span><br>         662:  <span style="background-color: white">                              (int) padding.right() + (int) border.right();</span><br>         663:  <span style="background-color: white">   5          if (withoutMargins &lt; getContainingBlockWidth()) {</span><br>         664:  <span style="background-color: white">   5              int available = getContainingBlockWidth() - withoutMargins;</span><br>         665:  <span style="background-color: white">      </span><br>         666:  <span style="background-color: white">   5              boolean autoLeft = getStyle().isAutoLeftMargin();</span><br>         667:  <span style="background-color: white">   5              boolean autoRight = getStyle().isAutoRightMargin();</span><br>         668:  <span style="background-color: white">      </span><br>         669:  <span style="background-color: white">   5              if (autoLeft &amp;&amp; autoRight) {</span><br>         670:  <span style="background-color: white">   5                  setMarginLeft(c, available / 2);</span><br>         671:  <span style="background-color: white">   5                  setMarginRight(c, available / 2);</span><br>         672:  <span style="background-color: white">   0              } else if (autoLeft) {</span><br>         673:  <span style="background-color: white">   0                  setMarginLeft(c, available);</span><br>         674:  <span style="background-color: white">   0              } else if (autoRight) {</span><br>         675:  <span style="background-color: white">   0                  setMarginRight(c, available);</span><br>         676:  <span style="background-color: white">                  }</span><br>         677:  <span style="background-color: white">              }</span><br>         678:  <span style="background-color: white">          }</span><br>         679:  <span style="background-color: white">      </span><br>         680:  <span style="background-color: white">   0      private int calcEffPageRelativeWidth(LayoutContext c) {</span><br>         681:  <span style="background-color: white">   0          int totalLeftMBP = 0;</span><br>         682:  <span style="background-color: white">   0          int totalRightMBP = 0;</span><br>         683:  <span style="background-color: white">      </span><br>         684:  <span style="background-color: white">   0          boolean usePageRelativeWidth = true;</span><br>         685:  <span style="background-color: white">      </span><br>         686:  <span style="background-color: white">   0          Box current = this;</span><br>         687:  <span style="background-color: white">   0          while (true) {</span><br>         688:  <span style="background-color: white">   0              CalculatedStyle style = current.getStyle();</span><br>         689:  <span style="background-color: white">   0              if (style.isAutoWidth() &amp;&amp; ! style.isCanBeShrunkToFit()) {</span><br>         690:  <span style="background-color: white">   0                  totalLeftMBP += current.getLeftMBP();</span><br>         691:  <span style="background-color: white">   0                  totalRightMBP += current.getRightMBP();</span><br>         692:  <span style="background-color: white">                  } else {</span><br>         693:  <span style="background-color: white">   0                  usePageRelativeWidth = false;</span><br>         694:  <span style="background-color: white">   0                  break;</span><br>         695:  <span style="background-color: white">                  }</span><br>         696:  <span style="background-color: white">      </span><br>         697:  <span style="background-color: white">   0              if (current.getContainingBlock().isInitialContainingBlock()) {</span><br>         698:  <span style="background-color: white">   0                  break;</span><br>         699:  <span style="background-color: white">                  } else {</span><br>         700:  <span style="background-color: white">   0                  current = current.getContainingBlock();</span><br>         701:  <span style="background-color: white">                  }</span><br>         702:  <span style="background-color: white">              }</span><br>         703:  <span style="background-color: white">      </span><br>         704:  <span style="background-color: white">   0          if (usePageRelativeWidth) {</span><br>         705:  <span style="background-color: white">   0              PageBox currentPage = c.getRootLayer().getFirstPage(c, this);</span><br>         706:  <span style="background-color: white">   0              return currentPage.getContentWidth(c) - totalLeftMBP - totalRightMBP;</span><br>         707:  <span style="background-color: white">              } else {</span><br>         708:  <span style="background-color: white">   0              return getContainingBlockWidth() - getLeftMBP() - getRightMBP();</span><br>         709:  <span style="background-color: white">              }</span><br>         710:  <span style="background-color: white">          }</span><br>         711:  <span style="background-color: white">      </span><br>         712:  <span style="background-color: white">          /**</span><br>         713:  <span style="background-color: white">           * Creates the replaced element as required. This method should be idempotent.</span><br>         714:  <span style="background-color: white">           */</span><br>         715:  <span style="background-color: red"> 99+      private void createReplaced(LayoutContext c) {</span><br>         716:  <span style="background-color: red"> 99+          ReplacedElement re = getReplacedElement();</span><br>         717:  <span style="background-color: white">              </span><br>         718:  <span style="background-color: red"> 99+          if (re == null) {</span><br>         719:  <span style="background-color: red"> 99+              int cssWidth = getCSSWidth(c);</span><br>         720:  <span style="background-color: red"> 99+              int cssHeight = getCSSHeight(c);</span><br>         721:  <span style="background-color: white">                  </span><br>         722:  <span style="background-color: white">                  // Since the interface doesn't allow us to pass min-width/height</span><br>         723:  <span style="background-color: white">                  // we implement it here.</span><br>         724:  <span style="background-color: red"> 99+              int minWidth = getCSSMinWidth(c);</span><br>         725:  <span style="background-color: red"> 99+              int minHeight = getCSSMinHeight(c);</span><br>         726:  <span style="background-color: white">                  </span><br>         727:  <span style="background-color: red"> 99+              if (minWidth &gt; cssWidth &amp;&amp;</span><br>         728:  <span style="background-color: white">                      minWidth &gt; 0) {</span><br>         729:  <span style="background-color: white"> 99+                  cssWidth = minWidth;</span><br>         730:  <span style="background-color: white">                  }</span><br>         731:  <span style="background-color: white">                  </span><br>         732:  <span style="background-color: red"> 99+              if (minHeight &gt; cssHeight &amp;&amp;</span><br>         733:  <span style="background-color: white">                      minHeight &gt; 0) {</span><br>         734:  <span style="background-color: red"> 99+                  cssHeight = minHeight;</span><br>         735:  <span style="background-color: white">                  }</span><br>         736:  <span style="background-color: white">                  </span><br>         737:  <span style="background-color: red"> 99+              re = c.getReplacedElementFactory().createReplacedElement(</span><br>         738:  <span style="background-color: white">                          c, this, c.getUac(), cssWidth, cssHeight);</span><br>         739:  <span style="background-color: white">                  </span><br>         740:  <span style="background-color: red"> 99+              if (re != null) {</span><br>         741:  <span style="background-color: red"> 99+                  setReplacedElement(re);</span><br>         742:  <span style="background-color: red"> 99+                  sizeReplacedElement(c, re);</span><br>         743:  <span style="background-color: white">                  }</span><br>         744:  <span style="background-color: white">              }</span><br>         745:  <span style="background-color: white">          }</span><br>         746:  <span style="background-color: white">          </span><br>         747:  <span style="background-color: white">          /**</span><br>         748:  <span style="background-color: white">           * Size a replaced element taking into account size properties including min/max,</span><br>         749:  <span style="background-color: white">           * border-box/content-box and the natural size/aspect ratio of the replaced object.</span><br>         750:  <span style="background-color: white">           * </span><br>         751:  <span style="background-color: white">           * This method may be called multiple times so must be idempotent.</span><br>         752:  <span style="background-color: white">           */</span><br>         753:  <span style="background-color: red"> 99+      private void sizeReplacedElement(LayoutContext c, ReplacedElement re) {</span><br>         754:  <span style="background-color: red"> 99+          int cssWidth = getCSSWidth(c);</span><br>         755:  <span style="background-color: red"> 99+          int cssHeight = getCSSHeight(c);</span><br>         756:  <span style="background-color: white">              </span><br>         757:  <span style="background-color: red"> 99+          boolean haveExactDims = cssWidth &gt;= 0 &amp;&amp; cssHeight &gt;= 0;</span><br>         758:  <span style="background-color: white">              </span><br>         759:  <span style="background-color: red"> 99+          boolean usedMinWidth = false;</span><br>         760:  <span style="background-color: red"> 99+          boolean usedMinHeight = false;</span><br>         761:  <span style="background-color: red"> 99+          boolean usedMaxWidth = false;</span><br>         762:  <span style="background-color: red"> 99+          boolean usedMaxHeight = false;</span><br>         763:  <span style="background-color: white">              </span><br>         764:  <span style="background-color: red"> 99+          int intrinsicWidth = re.getIntrinsicWidth();</span><br>         765:  <span style="background-color: red"> 99+          int intrinsicHeight = re.getIntrinsicHeight();</span><br>         766:  <span style="background-color: white">              </span><br>         767:  <span style="background-color: red"> 99+          int minWidth = getCSSMinWidth(c);</span><br>         768:  <span style="background-color: red"> 99+          int minHeight = getCSSMinHeight(c);</span><br>         769:  <span style="background-color: white">              </span><br>         770:  <span style="background-color: white">              // Clamp w to max-width if required.</span><br>         771:  <span style="background-color: white"> 99+          if (!getStyle().isMaxWidthNone() &amp;&amp;</span><br>         772:  <span style="background-color: white">                  (intrinsicWidth &gt; getCSSMaxWidth(c) || cssWidth &gt; getCSSMaxWidth(c))) {</span><br>         773:  <span style="background-color: white">  26              cssWidth = getCSSMaxWidth(c);</span><br>         774:  <span style="background-color: white">  26              usedMaxWidth = true;</span><br>         775:  <span style="background-color: white">              }</span><br>         776:  <span style="background-color: white">      </span><br>         777:  <span style="background-color: white">              // Clamp w to min-width if required.</span><br>         778:  <span style="background-color: red"> 99+          if (cssWidth &gt;= 0 &amp;&amp;</span><br>         779:  <span style="background-color: white">                  minWidth &gt; 0 &amp;&amp;</span><br>         780:  <span style="background-color: white">                  cssWidth &lt; minWidth) {</span><br>         781:  <span style="background-color: white">   4              cssWidth = minWidth;</span><br>         782:  <span style="background-color: white">   4              usedMinWidth = true;</span><br>         783:  <span style="background-color: white">              }</span><br>         784:  <span style="background-color: white">              </span><br>         785:  <span style="background-color: white">              // Clamp h to max-height if required.</span><br>         786:  <span style="background-color: white"> 99+          if (!getStyle().isMaxHeightNone() &amp;&amp;</span><br>         787:  <span style="background-color: white">                  (intrinsicHeight &gt; getCSSMaxHeight(c) || cssHeight &gt; getCSSMaxHeight(c))) {</span><br>         788:  <span style="background-color: white">  16              cssHeight = getCSSMaxHeight(c);</span><br>         789:  <span style="background-color: white">  16              usedMaxHeight = true;</span><br>         790:  <span style="background-color: white">              }</span><br>         791:  <span style="background-color: white">      </span><br>         792:  <span style="background-color: white">              // Clamp h to min-height if required.</span><br>         793:  <span style="background-color: red"> 99+          if (cssHeight &gt;= 0 &amp;&amp;</span><br>         794:  <span style="background-color: white">                  minHeight &gt; 0 &amp;&amp; </span><br>         795:  <span style="background-color: white">                  cssHeight &lt; minHeight) {</span><br>         796:  <span style="background-color: white">   2              cssHeight = minHeight;</span><br>         797:  <span style="background-color: white">   2              usedMinHeight = true;</span><br>         798:  <span style="background-color: white">              }</span><br>         799:  <span style="background-color: white">                                </span><br>         800:  <span style="background-color: white"> 99+          if (getStyle().isBorderBox()) {</span><br>         801:  <span style="background-color: white">  12              BorderPropertySet border = getBorder(c);</span><br>         802:  <span style="background-color: white">  12              RectPropertySet padding = getPadding(c);</span><br>         803:  <span style="background-color: white">  12              cssWidth = cssWidth &lt; 0 ? cssWidth : (int) Math.max(0, cssWidth - border.width() - padding.width());</span><br>         804:  <span style="background-color: white">  12              cssHeight = cssHeight &lt; 0 ? cssHeight : (int) Math.max(0, cssHeight - border.height() - padding.height());</span><br>         805:  <span style="background-color: white">              }</span><br>         806:  <span style="background-color: white">      </span><br>         807:  <span style="background-color: red"> 99+          int nw;</span><br>         808:  <span style="background-color: red"> 99+          int nh;</span><br>         809:  <span style="background-color: white">              </span><br>         810:  <span style="background-color: red"> 99+          boolean useExact = </span><br>         811:  <span style="background-color: white">                      (haveExactDims &amp;&amp; !usedMaxHeight &amp;&amp; !usedMaxWidth &amp;&amp; !usedMinWidth &amp;&amp; !usedMinHeight);</span><br>         812:  <span style="background-color: white">              </span><br>         813:  <span style="background-color: red"> 99+          if (cssWidth &gt; 0 &amp;&amp; cssHeight &gt; 0) {</span><br>         814:  <span style="background-color: white"> 99+              if (useExact) {</span><br>         815:  <span style="background-color: white">                      // We can warp the aspect ratio if we have explicit width and height values</span><br>         816:  <span style="background-color: white">                      // and the max/min values have not taken precedence.</span><br>         817:  <span style="background-color: white"> 99+                  nw = cssWidth;</span><br>         818:  <span style="background-color: white"> 99+                  nh = cssHeight;</span><br>         819:  <span style="background-color: white">  12              } else if (intrinsicWidth &gt; cssWidth || intrinsicHeight &gt; cssHeight) {</span><br>         820:  <span style="background-color: white">                      // Too large, so reduce respecting the aspect ratio.</span><br>         821:  <span style="background-color: white">   3                  double rw = (double) intrinsicWidth / (double) cssWidth;</span><br>         822:  <span style="background-color: white">   3                  double rh = (double) intrinsicHeight / (double) cssHeight;</span><br>         823:  <span style="background-color: white">      </span><br>         824:  <span style="background-color: white">   3                  if (rw &gt; rh) {</span><br>         825:  <span style="background-color: white">   1                      nw = cssWidth;</span><br>         826:  <span style="background-color: white">   1                      nh = (int) (intrinsicHeight / rw);</span><br>         827:  <span style="background-color: white">                      } else {</span><br>         828:  <span style="background-color: white">   2                      nw = (int) (intrinsicWidth / rh);</span><br>         829:  <span style="background-color: white">   2                      nh = cssHeight;</span><br>         830:  <span style="background-color: white">                      }</span><br>         831:  <span style="background-color: white">                  } else {</span><br>         832:  <span style="background-color: white">                      // Too small.</span><br>         833:  <span style="background-color: white">   9                  double rw = (double) intrinsicWidth / (double) cssWidth;</span><br>         834:  <span style="background-color: white">   9                  double rh = (double) intrinsicHeight / (double) cssHeight;</span><br>         835:  <span style="background-color: white">      </span><br>         836:  <span style="background-color: white">   9                  if (rw &gt; rh) {</span><br>         837:  <span style="background-color: white">   0                      nw = cssWidth;</span><br>         838:  <span style="background-color: white">   0                      nh = ((int) (intrinsicHeight / rw));</span><br>         839:  <span style="background-color: white">                      } else {</span><br>         840:  <span style="background-color: white">   9                      nw = ((int) (intrinsicWidth / rh));</span><br>         841:  <span style="background-color: white">   9                      nh = cssHeight;</span><br>         842:  <span style="background-color: white">                      }</span><br>         843:  <span style="background-color: white">                  }</span><br>         844:  <span style="background-color: red"> 99+          } else if (cssWidth &gt; 0) {</span><br>         845:  <span style="background-color: white">                  // Explicit min/max/width with auto height so keep aspect ratio.</span><br>         846:  <span style="background-color: white">  64              nw = cssWidth;</span><br>         847:  <span style="background-color: white">  64              nh = ((int) (((double) cssWidth / (double) intrinsicWidth) * intrinsicHeight));</span><br>         848:  <span style="background-color: red">  81          } else if (cssHeight &gt; 0) {</span><br>         849:  <span style="background-color: white">                  // Explicit min/max/height with auto width.</span><br>         850:  <span style="background-color: white">  30              nh = cssHeight;</span><br>         851:  <span style="background-color: white">  30              nw = ((int) (((double) cssHeight / (double) intrinsicHeight) * intrinsicWidth));</span><br>         852:  <span style="background-color: red">  51          } else if (cssWidth == 0 || cssHeight == 0) {</span><br>         853:  <span style="background-color: white">                  // Empty.</span><br>         854:  <span style="background-color: white">   0              nw = cssWidth;</span><br>         855:  <span style="background-color: white">   0              nh = cssHeight;</span><br>         856:  <span style="background-color: white">              } else {</span><br>         857:  <span style="background-color: white">                  // Auto width and height so use the natural dimensions of the replaced object.</span><br>         858:  <span style="background-color: red">  51              nw = intrinsicWidth;</span><br>         859:  <span style="background-color: red">  51              nh = intrinsicHeight;</span><br>         860:  <span style="background-color: white">              }</span><br>         861:  <span style="background-color: white">              </span><br>         862:  <span style="background-color: red"> 99+          setContentWidth(nw);</span><br>         863:  <span style="background-color: red"> 99+          setHeight(nh);</span><br>         864:  <span style="background-color: white">          }</span><br>         865:  <span style="background-color: white">          </span><br>         866:  <span style="background-color: red"> 99+      public void calcDimensions(LayoutContext c) {</span><br>         867:  <span style="background-color: red"> 99+          calcDimensions(c, getCSSWidth(c));</span><br>         868:  <span style="background-color: white">          }</span><br>         869:  <span style="background-color: white">      </span><br>         870:  <span style="background-color: red"> 99+      protected void calcDimensions(LayoutContext c, int cssWidth) {</span><br>         871:  <span style="background-color: white"> 99+          if (! isDimensionsCalculated()) {</span><br>         872:  <span style="background-color: red"> 99+              CalculatedStyle style = getStyle();</span><br>         873:  <span style="background-color: white">      </span><br>         874:  <span style="background-color: red"> 99+              RectPropertySet padding = getPadding(c);</span><br>         875:  <span style="background-color: red"> 99+              BorderPropertySet border = getBorder(c);</span><br>         876:  <span style="background-color: white">      </span><br>         877:  <span style="background-color: red"> 99+              if (cssWidth != -1 &amp;&amp; !isAnonymous() &amp;&amp;</span><br>         878:  <span style="background-color: white">                          (getStyle().isIdent(CSSName.MARGIN_LEFT, IdentValue.AUTO) ||</span><br>         879:  <span style="background-color: white">                                  getStyle().isIdent(CSSName.MARGIN_RIGHT, IdentValue.AUTO)) &amp;&amp;</span><br>         880:  <span style="background-color: white">                          getStyle().isNeedAutoMarginResolution()) {</span><br>         881:  <span style="background-color: white">   5                  resolveAutoMargins(c, cssWidth, padding, border);</span><br>         882:  <span style="background-color: white">                  }</span><br>         883:  <span style="background-color: white">      </span><br>         884:  <span style="background-color: red"> 99+              recalcMargin(c);</span><br>         885:  <span style="background-color: red"> 99+              RectPropertySet margin = getMargin(c);</span><br>         886:  <span style="background-color: white">      </span><br>         887:  <span style="background-color: white">                  // CLEAN: cast to int</span><br>         888:  <span style="background-color: red"> 99+              setLeftMBP((int) margin.left() + (int) border.left() + (int) padding.left());</span><br>         889:  <span style="background-color: red"> 99+              setRightMBP((int) padding.right() + (int) border.right() + (int) margin.right());</span><br>         890:  <span style="background-color: white">                  </span><br>         891:  <span style="background-color: red"> 99+              createReplaced(c);</span><br>         892:  <span style="background-color: white"> 99+              if (isReplaced()) {</span><br>         893:  <span style="background-color: red"> 99+                  setDimensionsCalculated(true);</span><br>         894:  <span style="background-color: red"> 99+                  return;</span><br>         895:  <span style="background-color: white">                  }</span><br>         896:  <span style="background-color: white">                  </span><br>         897:  <span style="background-color: red"> 99+              if (c.isPrint() &amp;&amp; getStyle().isDynamicAutoWidth()) {</span><br>         898:  <span style="background-color: white">   0                  setContentWidth(calcEffPageRelativeWidth(c));</span><br>         899:  <span style="background-color: white">                  } else {</span><br>         900:  <span style="background-color: white"> 99+                  setContentWidth((getContainingBlockWidth() - getLeftMBP() - getRightMBP()));</span><br>         901:  <span style="background-color: white">                  }</span><br>         902:  <span style="background-color: white">      </span><br>         903:  <span style="background-color: red"> 99+              setHeight(0);</span><br>         904:  <span style="background-color: white">      </span><br>         905:  <span style="background-color: white"> 99+              if (! isAnonymous() || (isFromCaptionedTable() &amp;&amp; isFloated())) {</span><br>         906:  <span style="background-color: red"> 99+                  int pinnedContentWidth = -1;</span><br>         907:  <span style="background-color: white">      </span><br>         908:  <span style="background-color: red"> 99+                  if (cssWidth != -1) {</span><br>         909:  <span style="background-color: red"> 99+                      if (style.isBorderBox()) {</span><br>         910:  <span style="background-color: cyan"> 99+                          setBorderBoxWidth(c, cssWidth);</span><br>         911:  <span style="background-color: white">                          } else {</span><br>         912:  <span style="background-color: red"> 99+                          setContentWidth(cssWidth);</span><br>         913:  <span style="background-color: white">                          }</span><br>         914:  <span style="background-color: white"> 99+                  } else if (getStyle().isAbsolute() || getStyle().isFixed()) {</span><br>         915:  <span style="background-color: red">  39                      pinnedContentWidth = calcPinnedContentWidth(c);</span><br>         916:  <span style="background-color: red">  39                      if (pinnedContentWidth != -1) {</span><br>         917:  <span style="background-color: red">  13                          setContentWidth(pinnedContentWidth);</span><br>         918:  <span style="background-color: white">                          }</span><br>         919:  <span style="background-color: white">                      }</span><br>         920:  <span style="background-color: white">      </span><br>         921:  <span style="background-color: red"> 99+                  int cssHeight = getCSSHeight(c);</span><br>         922:  <span style="background-color: red"> 99+                  if (cssHeight != -1) {</span><br>         923:  <span style="background-color: red"> 99+                      if (style.isBorderBox()) {</span><br>         924:  <span style="background-color: cyan"> 99+                          setBorderBoxHeight(c, cssHeight);</span><br>         925:  <span style="background-color: white">                          } else {</span><br>         926:  <span style="background-color: red"> 99+                          setHeight(cssHeight);</span><br>         927:  <span style="background-color: white">                          }</span><br>         928:  <span style="background-color: white">                      }</span><br>         929:  <span style="background-color: white">      </span><br>         930:  <span style="background-color: red"> 99+                  ReplacedElement re = getReplacedElement();</span><br>         931:  <span style="background-color: white">      </span><br>         932:  <span style="background-color: red"> 99+                  if (re != null) {</span><br>         933:  <span style="background-color: white">      </span><br>         934:  <span style="background-color: red"> 99+                  } else if (cssWidth == -1 &amp;&amp; pinnedContentWidth == -1 &amp;&amp;</span><br>         935:  <span style="background-color: white">                              style.isCanBeShrunkToFit()) {</span><br>         936:  <span style="background-color: red"> 99+                      setNeedShrinkToFitCalculatation(true);</span><br>         937:  <span style="background-color: white">                      }</span><br>         938:  <span style="background-color: white">      </span><br>         939:  <span style="background-color: white"> 99+                  if (! isReplaced()) {</span><br>         940:  <span style="background-color: red"> 99+                      applyCSSMinMaxWidth(c);</span><br>         941:  <span style="background-color: white">                      }</span><br>         942:  <span style="background-color: white">                  }</span><br>         943:  <span style="background-color: white">      </span><br>         944:  <span style="background-color: red"> 99+              setDimensionsCalculated(true);</span><br>         945:  <span style="background-color: white">              }</span><br>         946:  <span style="background-color: white">          }</span><br>         947:  <span style="background-color: white">      </span><br>         948:  <span style="background-color: red"> 99+      private void calcClearance(LayoutContext c) {</span><br>         949:  <span style="background-color: white"> 99+          if (getStyle().isCleared() &amp;&amp; ! getStyle().isFloated()) {</span><br>         950:  <span style="background-color: red">   5              c.translate(0, -getY());</span><br>         951:  <span style="background-color: red">   5              c.getBlockFormattingContext().clear(c, this);</span><br>         952:  <span style="background-color: red">   5              c.translate(0, getY());</span><br>         953:  <span style="background-color: white">   5              calcCanvasLocation();</span><br>         954:  <span style="background-color: white">              }</span><br>         955:  <span style="background-color: white">          }</span><br>         956:  <span style="background-color: white">      </span><br>         957:  <span style="background-color: red"> 99+      private void calcExtraPageClearance(LayoutContext c) {</span><br>         958:  <span style="background-color: red"> 99+          if (c.isPageBreaksAllowed() &amp;&amp;</span><br>         959:  <span style="background-color: white">                      c.getExtraSpaceTop() &gt; 0 &amp;&amp; (getStyle().isSpecifiedAsBlock() || getStyle().isListItem())) {</span><br>         960:  <span style="background-color: cyan"> 99+              PageBox first = c.getRootLayer().getFirstPage(c, this);</span><br>         961:  <span style="background-color: cyan"> 99+              if (first != null &amp;&amp; first.getTop() + c.getExtraSpaceTop() &gt; getAbsY()) {</span><br>         962:  <span style="background-color: red">   0                  int diff = first.getTop() + c.getExtraSpaceTop() - getAbsY();</span><br>         963:  <span style="background-color: red">   0                  setY(getY() + diff);</span><br>         964:  <span style="background-color: red">   0                  c.translate(0, diff);</span><br>         965:  <span style="background-color: white">   0                  calcCanvasLocation();</span><br>         966:  <span style="background-color: white">                  }</span><br>         967:  <span style="background-color: white">              }</span><br>         968:  <span style="background-color: white">          }</span><br>         969:  <span style="background-color: white">      </span><br>         970:  <span style="background-color: red"> 99+      protected void addBoxID(LayoutContext c) {</span><br>         971:  <span style="background-color: white"> 99+          if (! isAnonymous()) {</span><br>         972:  <span style="background-color: red"> 99+              String name = c.getNamespaceHandler().getAnchorName(getElement());</span><br>         973:  <span style="background-color: red"> 99+              if (name != null) {</span><br>         974:  <span style="background-color: white">   0                  c.addBoxId(name, this);</span><br>         975:  <span style="background-color: white">                  }</span><br>         976:  <span style="background-color: red"> 99+              String id = c.getNamespaceHandler().getID(getElement());</span><br>         977:  <span style="background-color: red"> 99+              if (id != null) {</span><br>         978:  <span style="background-color: red"> 99+                  c.addBoxId(id, this);</span><br>         979:  <span style="background-color: white">                  }</span><br>         980:  <span style="background-color: white">              }</span><br>         981:  <span style="background-color: white">          }</span><br>         982:  <span style="background-color: white">      </span><br>         983:  <span style="background-color: red"> 99+      public void layout(LayoutContext c) {</span><br>         984:  <span style="background-color: red"> 99+          layout(c, 0);</span><br>         985:  <span style="background-color: white">          }</span><br>         986:  <span style="background-color: white">      </span><br>         987:  <span style="background-color: red"> 99+      public void layout(LayoutContext c, int contentStart) {</span><br>         988:  <span style="background-color: red"> 99+          CalculatedStyle style = getStyle();</span><br>         989:  <span style="background-color: white">      </span><br>         990:  <span style="background-color: red"> 99+          boolean pushedLayer = checkPushLayer(c, style);</span><br>         991:  <span style="background-color: white">      </span><br>         992:  <span style="background-color: red"> 99+          calcClearance(c);</span><br>         993:  <span style="background-color: white">      </span><br>         994:  <span style="background-color: red"> 99+          checkPushBfc(c);</span><br>         995:  <span style="background-color: white">      </span><br>         996:  <span style="background-color: red"> 99+          addBoxID(c);</span><br>         997:  <span style="background-color: white">      </span><br>         998:  <span style="background-color: red"> 99+          if (c.isPrint() &amp;&amp; getStyle().isIdent(CSSName.FS_PAGE_SEQUENCE, IdentValue.START)) {</span><br>         999:  <span style="background-color: white">   0              c.getRootLayer().addPageSequence(this);</span><br>        1000:  <span style="background-color: white">              }</span><br>        1001:  <span style="background-color: white">      </span><br>        1002:  <span style="background-color: red"> 99+          createReplaced(c);</span><br>        1003:  <span style="background-color: red"> 99+          calcDimensions(c);</span><br>        1004:  <span style="background-color: red"> 99+          calcShrinkToFitWidthIfNeeded(c);</span><br>        1005:  <span style="background-color: red"> 99+          collapseMargins(c);</span><br>        1006:  <span style="background-color: white">      </span><br>        1007:  <span style="background-color: red"> 99+          calcExtraPageClearance(c);</span><br>        1008:  <span style="background-color: white">      </span><br>        1009:  <span style="background-color: red"> 99+          if (c.isPrint()) {</span><br>        1010:  <span style="background-color: red"> 99+              PageBox firstPage = c.getRootLayer().getFirstPage(c, this);</span><br>        1011:  <span style="background-color: red"> 99+              if (firstPage != null &amp;&amp; firstPage.getTop() == getAbsY() - getPageClearance()) {</span><br>        1012:  <span style="background-color: red"> 99+                  resetTopMargin(c);</span><br>        1013:  <span style="background-color: white">                  }</span><br>        1014:  <span style="background-color: white">              }</span><br>        1015:  <span style="background-color: white">      </span><br>        1016:  <span style="background-color: red"> 99+          BorderPropertySet border = getBorder(c);</span><br>        1017:  <span style="background-color: red"> 99+          RectPropertySet margin = getMargin(c);</span><br>        1018:  <span style="background-color: red"> 99+          RectPropertySet padding = getPadding(c);</span><br>        1019:  <span style="background-color: white">      </span><br>        1020:  <span style="background-color: white">              // save height in case fixed height</span><br>        1021:  <span style="background-color: red"> 99+          int originalHeight = getHeight();</span><br>        1022:  <span style="background-color: white">      </span><br>        1023:  <span style="background-color: white"> 99+          if (! isReplaced()) {</span><br>        1024:  <span style="background-color: red"> 99+              setHeight(0);</span><br>        1025:  <span style="background-color: white">              }</span><br>        1026:  <span style="background-color: white">      </span><br>        1027:  <span style="background-color: red"> 99+          boolean didSetMarkerData = false;</span><br>        1028:  <span style="background-color: white"> 99+          if (getStyle().isListItem()) {</span><br>        1029:  <span style="background-color: red"> 99+              createMarkerData(c);</span><br>        1030:  <span style="background-color: red"> 99+              c.setCurrentMarkerData(getMarkerData());</span><br>        1031:  <span style="background-color: red"> 99+              didSetMarkerData = true;</span><br>        1032:  <span style="background-color: white">              }</span><br>        1033:  <span style="background-color: white">      </span><br>        1034:  <span style="background-color: white">              // do children's layout</span><br>        1035:  <span style="background-color: red"> 99+          int tx = (int) margin.left() + (int) border.left() + (int) padding.left();</span><br>        1036:  <span style="background-color: red"> 99+          int ty = (int) margin.top() + (int) border.top() + (int) padding.top();</span><br>        1037:  <span style="background-color: red"> 99+          setTx(tx);</span><br>        1038:  <span style="background-color: red"> 99+          setTy(ty);</span><br>        1039:  <span style="background-color: red"> 99+          c.translate(getTx(), getTy());</span><br>        1040:  <span style="background-color: white"> 99+          if (! isReplaced())</span><br>        1041:  <span style="background-color: red"> 99+              layoutChildren(c, contentStart);</span><br>        1042:  <span style="background-color: white">              else {</span><br>        1043:  <span style="background-color: red"> 99+              setState(Box.DONE);</span><br>        1044:  <span style="background-color: white">              }</span><br>        1045:  <span style="background-color: red"> 99+          c.translate(-getTx(), -getTy());</span><br>        1046:  <span style="background-color: white">      </span><br>        1047:  <span style="background-color: white"> 99+          setChildrenHeight(getHeight());</span><br>        1048:  <span style="background-color: white">      </span><br>        1049:  <span style="background-color: white"> 99+          if (! isReplaced()) {</span><br>        1050:  <span style="background-color: white"> 99+              if (! isAutoHeight()) {</span><br>        1051:  <span style="background-color: red"> 99+                  int delta = originalHeight - getHeight();</span><br>        1052:  <span style="background-color: red"> 99+                  if (delta &gt; 0 || isAllowHeightToShrink()) {</span><br>        1053:  <span style="background-color: red"> 99+                      setHeight(originalHeight);</span><br>        1054:  <span style="background-color: white">                      }</span><br>        1055:  <span style="background-color: white">                  }</span><br>        1056:  <span style="background-color: white">      </span><br>        1057:  <span style="background-color: red"> 99+              applyCSSMinMaxHeight(c);</span><br>        1058:  <span style="background-color: white">              }</span><br>        1059:  <span style="background-color: white">      </span><br>        1060:  <span style="background-color: white"> 99+          if (isRoot() || getStyle().establishesBFC()) {</span><br>        1061:  <span style="background-color: white"> 99+              if (getStyle().isAutoHeight()) {</span><br>        1062:  <span style="background-color: cyan"> 99+                  int delta =</span><br>        1063:  <span style="background-color: white">                              c.getBlockFormattingContext().getFloatManager().getClearDelta(</span><br>        1064:  <span style="background-color: white">                                      c, getTy() + getHeight());</span><br>        1065:  <span style="background-color: cyan"> 99+                  if (delta &gt; 0) {</span><br>        1066:  <span style="background-color: red">  36                      setHeight(getHeight() + delta);</span><br>        1067:  <span style="background-color: red">  36                      setChildrenHeight(getChildrenHeight() + delta);</span><br>        1068:  <span style="background-color: white">                      }</span><br>        1069:  <span style="background-color: white">                  }</span><br>        1070:  <span style="background-color: white">              }</span><br>        1071:  <span style="background-color: white">      </span><br>        1072:  <span style="background-color: red"> 99+          if (didSetMarkerData) {</span><br>        1073:  <span style="background-color: red"> 99+              c.setCurrentMarkerData(null);</span><br>        1074:  <span style="background-color: white">              }</span><br>        1075:  <span style="background-color: white">      </span><br>        1076:  <span style="background-color: red"> 99+          calcLayoutHeight(c, border, margin, padding);</span><br>        1077:  <span style="background-color: white">      </span><br>        1078:  <span style="background-color: red"> 99+          checkPopBfc(c);</span><br>        1079:  <span style="background-color: white">      </span><br>        1080:  <span style="background-color: red"> 99+          if (pushedLayer) {</span><br>        1081:  <span style="background-color: red"> 99+              c.popLayer();</span><br>        1082:  <span style="background-color: white">              }</span><br>        1083:  <span style="background-color: white">          }</span><br>        1084:  <span style="background-color: white">      </span><br>        1085:  <span style="background-color: red"> 99+      protected boolean checkPushLayer(LayoutContext c, CalculatedStyle style) {</span><br>        1086:  <span style="background-color: white"> 99+          if (isRoot()) {</span><br>        1087:  <span style="background-color: red"> 99+              c.pushLayer(this);</span><br>        1088:  <span style="background-color: white">      </span><br>        1089:  <span style="background-color: red"> 99+              if (c.isPrint()) {</span><br>        1090:  <span style="background-color: red"> 99+                  if (!style.isIdent(CSSName.PAGE, IdentValue.AUTO)) {</span><br>        1091:  <span style="background-color: white">   0                      c.setPageName(style.getStringProperty(CSSName.PAGE));</span><br>        1092:  <span style="background-color: white">                      }</span><br>        1093:  <span style="background-color: red"> 99+                  c.getRootLayer().addPage(c);</span><br>        1094:  <span style="background-color: white">                  }</span><br>        1095:  <span style="background-color: white">      </span><br>        1096:  <span style="background-color: red"> 99+              return true;</span><br>        1097:  <span style="background-color: red"> 99+          } else if (style.requiresLayer() &amp;&amp; this.getLayer() == null) {</span><br>        1098:  <span style="background-color: red"> 99+              c.pushLayer(this);</span><br>        1099:  <span style="background-color: red"> 99+              return true;</span><br>        1100:  <span style="background-color: red"> 99+          } else if (style.requiresLayer()) {</span><br>        1101:  <span style="background-color: white">                  // FIXME: HACK. Some boxes can be layed out many times (to satisfy page constraints for example).</span><br>        1102:  <span style="background-color: white">                  // If this happens we just mark our old layer for deletion and create a new layer.</span><br>        1103:  <span style="background-color: white">                  // Not sure this is right, but doesn't break any correct tests.</span><br>        1104:  <span style="background-color: white">                  //</span><br>        1105:  <span style="background-color: white">                  // NOTE: This only happens if someone has called layout multiple times</span><br>        1106:  <span style="background-color: white">                  // without calling reset beforehand.</span><br>        1107:  <span style="background-color: red"> 99+              this.getLayer().setForDeletion(true);</span><br>        1108:  <span style="background-color: red"> 99+              c.pushLayer(this);</span><br>        1109:  <span style="background-color: red"> 99+              return true;</span><br>        1110:  <span style="background-color: white">              }</span><br>        1111:  <span style="background-color: white">      </span><br>        1112:  <span style="background-color: red"> 99+          return false;</span><br>        1113:  <span style="background-color: white">          }</span><br>        1114:  <span style="background-color: white">      </span><br>        1115:  <span style="background-color: white">          /**</span><br>        1116:  <span style="background-color: white">           * Checks if this box established a block formatting context and if so</span><br>        1117:  <span style="background-color: white">           * removes the last bfc from the stack.</span><br>        1118:  <span style="background-color: white">           * See also {@link #checkPushBfc(LayoutContext)}</span><br>        1119:  <span style="background-color: white">           */</span><br>        1120:  <span style="background-color: red"> 99+      protected void checkPopBfc(LayoutContext c) {</span><br>        1121:  <span style="background-color: white"> 99+          if (isRoot() || getStyle().establishesBFC()) {</span><br>        1122:  <span style="background-color: cyan"> 99+              c.popBFC();</span><br>        1123:  <span style="background-color: white">              }</span><br>        1124:  <span style="background-color: white">          }</span><br>        1125:  <span style="background-color: white">      </span><br>        1126:  <span style="background-color: white">          /**</span><br>        1127:  <span style="background-color: white">           * Checks if this box establishes a block formatting context and if</span><br>        1128:  <span style="background-color: white">           * so creates one and pushes it to the stack of bfcs.</span><br>        1129:  <span style="background-color: white">           * See also {@link #checkPopBfc(LayoutContext)}</span><br>        1130:  <span style="background-color: white">           */</span><br>        1131:  <span style="background-color: red"> 99+      protected void checkPushBfc(LayoutContext c) {</span><br>        1132:  <span style="background-color: white"> 99+          if (isRoot() || getStyle().establishesBFC() || isMarginAreaRoot()) {</span><br>        1133:  <span style="background-color: cyan"> 99+              BlockFormattingContext bfc = new BlockFormattingContext(this, c);</span><br>        1134:  <span style="background-color: cyan"> 99+              c.pushBFC(bfc);</span><br>        1135:  <span style="background-color: white">              }</span><br>        1136:  <span style="background-color: white">          }</span><br>        1137:  <span style="background-color: white">      </span><br>        1138:  <span style="background-color: white">  80      protected boolean isAllowHeightToShrink() {</span><br>        1139:  <span style="background-color: white">  80          return true;</span><br>        1140:  <span style="background-color: white">          }</span><br>        1141:  <span style="background-color: white">      </span><br>        1142:  <span style="background-color: red"> 99+      protected int getPageClearance() {</span><br>        1143:  <span style="background-color: red"> 99+          return 0;</span><br>        1144:  <span style="background-color: white">          }</span><br>        1145:  <span style="background-color: white">      </span><br>        1146:  <span style="background-color: white">          /**</span><br>        1147:  <span style="background-color: white">           * Oh oh! Up to this method height is used to track content height. After this method it is used</span><br>        1148:  <span style="background-color: white">           * to track total layout height! </span><br>        1149:  <span style="background-color: white">           */</span><br>        1150:  <span style="background-color: red"> 99+      protected void calcLayoutHeight(</span><br>        1151:  <span style="background-color: white">                  LayoutContext c, BorderPropertySet border,</span><br>        1152:  <span style="background-color: white">                  RectPropertySet margin, RectPropertySet padding) {</span><br>        1153:  <span style="background-color: red"> 99+          setHeight(getHeight() + ((int) margin.top() + (int) border.top() + (int) padding.top() +</span><br>        1154:  <span style="background-color: white">                      (int) padding.bottom() + (int) border.bottom() + (int) margin.bottom()));</span><br>        1155:  <span style="background-color: red"> 99+          setChildrenHeight(getChildrenHeight() + ((int) margin.top() + (int) border.top() + (int) padding.top() +</span><br>        1156:  <span style="background-color: white">                      (int) padding.bottom() + (int) border.bottom() + (int) margin.bottom()));</span><br>        1157:  <span style="background-color: white">          }</span><br>        1158:  <span style="background-color: white">      </span><br>        1159:  <span style="background-color: white">      </span><br>        1160:  <span style="background-color: red"> 99+      private void calcShrinkToFitWidthIfNeeded(LayoutContext c) {</span><br>        1161:  <span style="background-color: white"> 99+          if (isNeedShrinkToFitCalculatation()) {</span><br>        1162:  <span style="background-color: red"> 99+              setContentWidth(calcShrinkToFitWidth(c) - getLeftMBP() - getRightMBP());</span><br>        1163:  <span style="background-color: red"> 99+              applyCSSMinMaxWidth(c);</span><br>        1164:  <span style="background-color: red"> 99+              setNeedShrinkToFitCalculatation(false);</span><br>        1165:  <span style="background-color: white">              }</span><br>        1166:  <span style="background-color: white">          }</span><br>        1167:  <span style="background-color: white">      </span><br>        1168:  <span style="background-color: red"> 99+      private void applyCSSMinMaxWidth(CssContext c) {</span><br>        1169:  <span style="background-color: red"> 99+          int w = getStyle().isBorderBox() ? getBorderBoxWidth(c) : getContentWidth();</span><br>        1170:  <span style="background-color: white">              </span><br>        1171:  <span style="background-color: white"> 99+          if (! getStyle().isMaxWidthNone()) {</span><br>        1172:  <span style="background-color: red">  55              int cssMaxWidth = getCSSMaxWidth(c);</span><br>        1173:  <span style="background-color: red">  55              if (w &gt; cssMaxWidth) {</span><br>        1174:  <span style="background-color: white">   3                  if (getStyle().isBorderBox()) {</span><br>        1175:  <span style="background-color: white">   2                      setBorderBoxWidth(c, cssMaxWidth);</span><br>        1176:  <span style="background-color: white">                      } else {</span><br>        1177:  <span style="background-color: white">   1                      setContentWidth(cssMaxWidth);</span><br>        1178:  <span style="background-color: white">                      }</span><br>        1179:  <span style="background-color: white">                  }</span><br>        1180:  <span style="background-color: white">              }</span><br>        1181:  <span style="background-color: white">              </span><br>        1182:  <span style="background-color: red"> 99+          int cssMinWidth = getCSSMinWidth(c);</span><br>        1183:  <span style="background-color: red"> 99+          if (cssMinWidth &gt; 0 &amp;&amp; w &lt; cssMinWidth) {</span><br>        1184:  <span style="background-color: white">  40              if (getStyle().isBorderBox()) {</span><br>        1185:  <span style="background-color: white">  33                  setBorderBoxWidth(c, cssMinWidth);</span><br>        1186:  <span style="background-color: white">                  } else {</span><br>        1187:  <span style="background-color: white">   7                  setContentWidth(cssMinWidth);</span><br>        1188:  <span style="background-color: white">                  }</span><br>        1189:  <span style="background-color: white">              }</span><br>        1190:  <span style="background-color: white">          }</span><br>        1191:  <span style="background-color: white">      </span><br>        1192:  <span style="background-color: red"> 99+      private void applyCSSMinMaxHeight(CssContext c) {</span><br>        1193:  <span style="background-color: red"> 99+          int currentHeight = getStyle().isBorderBox() ? getBorderBoxHeight(c) : getHeight();</span><br>        1194:  <span style="background-color: white">              </span><br>        1195:  <span style="background-color: white"> 99+          if (! getStyle().isMaxHeightNone()) {</span><br>        1196:  <span style="background-color: white">  11              int cssMaxHeight = getCSSMaxHeight(c);</span><br>        1197:  <span style="background-color: white">  11              if (currentHeight &gt; cssMaxHeight) {</span><br>        1198:  <span style="background-color: white">   5                  if (getStyle().isBorderBox()) {</span><br>        1199:  <span style="background-color: white">   1                      setBorderBoxHeight(c, cssMaxHeight);</span><br>        1200:  <span style="background-color: white">                      } else {</span><br>        1201:  <span style="background-color: white">   4                      setHeight(cssMaxHeight);</span><br>        1202:  <span style="background-color: white">                      }</span><br>        1203:  <span style="background-color: white">                  }</span><br>        1204:  <span style="background-color: white">              }</span><br>        1205:  <span style="background-color: white">              </span><br>        1206:  <span style="background-color: red"> 99+          int cssMinHeight = getCSSMinHeight(c);</span><br>        1207:  <span style="background-color: red"> 99+          if (cssMinHeight &gt; 0 &amp;&amp; currentHeight &lt; cssMinHeight) {</span><br>        1208:  <span style="background-color: white"> 99+              if (getStyle().isBorderBox()) {</span><br>        1209:  <span style="background-color: white">  71                  setBorderBoxHeight(c, cssMinHeight);</span><br>        1210:  <span style="background-color: white">                  } else {</span><br>        1211:  <span style="background-color: red">  45                  setHeight(cssMinHeight);</span><br>        1212:  <span style="background-color: white">                  }</span><br>        1213:  <span style="background-color: white">              }</span><br>        1214:  <span style="background-color: white">          }</span><br>        1215:  <span style="background-color: white">      </span><br>        1216:  <span style="background-color: red"> 99+      public void ensureChildren(LayoutContext c) {</span><br>        1217:  <span style="background-color: yellow"> 99+          if (getChildrenContentType() == CONTENT_UNKNOWN) {</span><br>        1218:  <span style="background-color: red"> 99+              BoxBuilder.createChildren(c, this);</span><br>        1219:  <span style="background-color: white">              }</span><br>        1220:  <span style="background-color: white">          }</span><br>        1221:  <span style="background-color: white">      </span><br>        1222:  <span style="background-color: red"> 99+      protected void layoutChildren(LayoutContext c, int contentStart) {</span><br>        1223:  <span style="background-color: red"> 99+          setState(Box.CHILDREN_FLUX);</span><br>        1224:  <span style="background-color: red"> 99+          ensureChildren(c);</span><br>        1225:  <span style="background-color: white">      </span><br>        1226:  <span style="background-color: red"> 99+          if (getFirstLetterStyle() != null) {</span><br>        1227:  <span style="background-color: yellow">   0              c.getFirstLettersTracker().addStyle(getFirstLetterStyle());</span><br>        1228:  <span style="background-color: white">              }</span><br>        1229:  <span style="background-color: red"> 99+          if (getFirstLineStyle() != null) {</span><br>        1230:  <span style="background-color: yellow">   0              c.getFirstLinesTracker().addStyle(getFirstLineStyle());</span><br>        1231:  <span style="background-color: white">              }</span><br>        1232:  <span style="background-color: white">      </span><br>        1233:  <span style="background-color: white"> 99+          switch (getChildrenContentType()) {</span><br>        1234:  <span style="background-color: yellow"> 99+              case CONTENT_INLINE:</span><br>        1235:  <span style="background-color: red"> 99+                  layoutInlineChildren(c, contentStart, calcInitialBreakAtLine(c), true);</span><br>        1236:  <span style="background-color: red"> 99+                  break;</span><br>        1237:  <span style="background-color: yellow"> 99+              case CONTENT_BLOCK:</span><br>        1238:  <span style="background-color: red"> 99+                  BlockBoxing.layoutContent(c, this, contentStart);</span><br>        1239:  <span style="background-color: red"> 99+                  break;</span><br>        1240:  <span style="background-color: white">              }</span><br>        1241:  <span style="background-color: white">      </span><br>        1242:  <span style="background-color: red"> 99+          if (getFirstLetterStyle() != null) {</span><br>        1243:  <span style="background-color: yellow">   0              c.getFirstLettersTracker().removeLast();</span><br>        1244:  <span style="background-color: white">              }</span><br>        1245:  <span style="background-color: red"> 99+          if (getFirstLineStyle() != null) {</span><br>        1246:  <span style="background-color: yellow">   0              c.getFirstLinesTracker().removeLast();</span><br>        1247:  <span style="background-color: white">              }</span><br>        1248:  <span style="background-color: white">      </span><br>        1249:  <span style="background-color: red"> 99+          setState(Box.DONE);</span><br>        1250:  <span style="background-color: white">          }</span><br>        1251:  <span style="background-color: white">      </span><br>        1252:  <span style="background-color: red"> 99+      protected void layoutInlineChildren(</span><br>        1253:  <span style="background-color: white">                  LayoutContext c, int contentStart, int breakAtLine, boolean tryAgain) {</span><br>        1254:  <span style="background-color: red"> 99+          InlineBoxing.layoutContent(c, this, contentStart, breakAtLine);</span><br>        1255:  <span style="background-color: white">      </span><br>        1256:  <span style="background-color: red"> 99+          if (c.isPrint() &amp;&amp; c.isPageBreaksAllowed() &amp;&amp; getChildCount() &gt; 1) {</span><br>        1257:  <span style="background-color: cyan"> 99+              satisfyWidowsAndOrphans(c, contentStart, tryAgain);</span><br>        1258:  <span style="background-color: white">              }</span><br>        1259:  <span style="background-color: white">      </span><br>        1260:  <span style="background-color: red"> 99+          if (tryAgain &amp;&amp; (getStyle().isTextJustify())) {</span><br>        1261:  <span style="background-color: white">  57              justifyText(c);</span><br>        1262:  <span style="background-color: white">              }</span><br>        1263:  <span style="background-color: white">          }</span><br>        1264:  <span style="background-color: white">      </span><br>        1265:  <span style="background-color: white">  57      private void justifyText(LayoutContext c) {</span><br>        1266:  <span style="background-color: white"> 99+          for (Iterator
       <box>
         i = getChildIterator(); i.hasNext(); ) {
       </box></span><br>        1267:  <span style="background-color: white"> 99+              LineBox line = (LineBox)i.next();</span><br>        1268:  <span style="background-color: white"> 99+              line.justify(c);</span><br>        1269:  <span style="background-color: white">              }</span><br>        1270:  <span style="background-color: white">          }</span><br>        1271:  <span style="background-color: white">      </span><br>        1272:  <span style="background-color: cyan"> 99+      private void satisfyWidowsAndOrphans(LayoutContext c, int contentStart, boolean tryAgain) {</span><br>        1273:  <span style="background-color: cyan"> 99+          LineBox firstLineBox = (LineBox)getChild(0);</span><br>        1274:  <span style="background-color: cyan"> 99+          PageBox firstPage = c.getRootLayer().getFirstPage(c, firstLineBox);</span><br>        1275:  <span style="background-color: white">      </span><br>        1276:  <span style="background-color: cyan"> 99+          if (firstPage == null) {</span><br>        1277:  <span style="background-color: white">   0              return;</span><br>        1278:  <span style="background-color: white">              }</span><br>        1279:  <span style="background-color: white">      </span><br>        1280:  <span style="background-color: cyan"> 99+          int noContentLBs = 0;</span><br>        1281:  <span style="background-color: cyan"> 99+          int i = 0;</span><br>        1282:  <span style="background-color: cyan"> 99+          int cCount = getChildCount();</span><br>        1283:  <span style="background-color: red"> 99+          while (i &lt; cCount) {</span><br>        1284:  <span style="background-color: red"> 99+              LineBox lB = (LineBox)getChild(i);</span><br>        1285:  <span style="background-color: red"> 99+              if (lB.getAbsY() &gt;= firstPage.getBottom()) {</span><br>        1286:  <span style="background-color: red"> 99+                  break;</span><br>        1287:  <span style="background-color: white">                  }</span><br>        1288:  <span style="background-color: red"> 99+              if (! lB.isContainsContent()) {</span><br>        1289:  <span style="background-color: cyan"> 99+                  noContentLBs++;</span><br>        1290:  <span style="background-color: white">                  }</span><br>        1291:  <span style="background-color: red"> 99+              i++;</span><br>        1292:  <span style="background-color: white">              }</span><br>        1293:  <span style="background-color: white">      </span><br>        1294:  <span style="background-color: cyan"> 99+          if (i != cCount) {</span><br>        1295:  <span style="background-color: yellow"> 99+              int orphans = (int)getStyle().asFloat(CSSName.ORPHANS);</span><br>        1296:  <span style="background-color: red"> 99+              if (i - noContentLBs &lt; orphans) {</span><br>        1297:  <span style="background-color: cyan"> 99+                  setNeedPageClear(true);</span><br>        1298:  <span style="background-color: white">                  } else {</span><br>        1299:  <span style="background-color: red"> 99+                  LineBox lastLineBox = (LineBox)getChild(cCount-1);</span><br>        1300:  <span style="background-color: yellow"> 99+                  List
       <pagebox>
         pages = c.getRootLayer().getPages();
       </pagebox></span><br>        1301:  <span style="background-color: yellow"> 99+                  PageBox lastPage = pages.get(firstPage.getPageNo()+1);</span><br>        1302:  <span style="background-color: yellow"> 99+                  while (lastPage.getPageNo() != pages.size() - 1 &amp;&amp;</span><br>        1303:  <span style="background-color: yellow">                              lastPage.getBottom() &lt; lastLineBox.getAbsY()) {</span><br>        1304:  <span style="background-color: yellow">  80                      lastPage = pages.get(lastPage.getPageNo()+1);</span><br>        1305:  <span style="background-color: yellow">                      }</span><br>        1306:  <span style="background-color: white">      </span><br>        1307:  <span style="background-color: red"> 99+                  noContentLBs = 0;</span><br>        1308:  <span style="background-color: red"> 99+                  i = cCount-1;</span><br>        1309:  <span style="background-color: yellow"> 99+                  while (i &gt;= 0 &amp;&amp; getChild(i).getAbsY() &gt;= lastPage.getTop()) {</span><br>        1310:  <span style="background-color: cyan"> 99+                      LineBox lB = (LineBox)getChild(i);</span><br>        1311:  <span style="background-color: cyan"> 99+                      if (lB.getAbsY() &lt; lastPage.getTop()) {</span><br>        1312:  <span style="background-color: red">   0                          break;</span><br>        1313:  <span style="background-color: white">                          }</span><br>        1314:  <span style="background-color: cyan"> 99+                      if (! lB.isContainsContent()) {</span><br>        1315:  <span style="background-color: red"> 99+                          noContentLBs++;</span><br>        1316:  <span style="background-color: white">                          }</span><br>        1317:  <span style="background-color: cyan"> 99+                      i--;</span><br>        1318:  <span style="background-color: white">                      }</span><br>        1319:  <span style="background-color: white">      </span><br>        1320:  <span style="background-color: yellow"> 99+                  int widows = (int)getStyle().asFloat(CSSName.WIDOWS);</span><br>        1321:  <span style="background-color: yellow"> 99+                  if (cCount - 1 - i - noContentLBs &lt; widows) {</span><br>        1322:  <span style="background-color: cyan"> 99+                      if (cCount - 1 - widows &lt; orphans) {</span><br>        1323:  <span style="background-color: red">  14                          setNeedPageClear(true);</span><br>        1324:  <span style="background-color: cyan"> 99+                      } else if (tryAgain) {</span><br>        1325:  <span style="background-color: cyan"> 99+                          int breakAtLine = cCount - 1 - widows;</span><br>        1326:  <span style="background-color: white">      </span><br>        1327:  <span style="background-color: cyan"> 99+                          resetChildren(c);</span><br>        1328:  <span style="background-color: white"> 99+                          removeAllChildren();</span><br>        1329:  <span style="background-color: white">      </span><br>        1330:  <span style="background-color: cyan"> 99+                          layoutInlineChildren(c, contentStart, breakAtLine, false);</span><br>        1331:  <span style="background-color: white">                          }</span><br>        1332:  <span style="background-color: white">                      }</span><br>        1333:  <span style="background-color: white">                  }</span><br>        1334:  <span style="background-color: white">              }</span><br>        1335:  <span style="background-color: white">          }</span><br>        1336:  <span style="background-color: white">      </span><br>        1337:  <span style="background-color: yellow"> 99+      public int getChildrenContentType() {</span><br>        1338:  <span style="background-color: white"> 99+          return _childrenContentType;</span><br>        1339:  <span style="background-color: white">          }</span><br>        1340:  <span style="background-color: white">      </span><br>        1341:  <span style="background-color: yellow"> 99+      public void setChildrenContentType(int contentType) {</span><br>        1342:  <span style="background-color: red"> 99+          _childrenContentType = contentType;</span><br>        1343:  <span style="background-color: white">          }</span><br>        1344:  <span style="background-color: white">      </span><br>        1345:  <span style="background-color: red"> 99+      public List
       <styleable>
         getInlineContent() {
       </styleable></span><br>        1346:  <span style="background-color: white"> 99+          return _inlineContent;</span><br>        1347:  <span style="background-color: white">          }</span><br>        1348:  <span style="background-color: white">      </span><br>        1349:  <span style="background-color: red"> 99+      public void setInlineContent(List
       <styleable>
         inlineContent) {
       </styleable></span><br>        1350:  <span style="background-color: red"> 99+          _inlineContent = inlineContent;</span><br>        1351:  <span style="background-color: red"> 99+          if (inlineContent != null) {</span><br>        1352:  <span style="background-color: red"> 99+              for (Styleable child : inlineContent) {</span><br>        1353:  <span style="background-color: red"> 99+                  if (child instanceof Box) {</span><br>        1354:  <span style="background-color: red"> 99+                      ((Box) child).setContainingBlock(this);</span><br>        1355:  <span style="background-color: white">                      }</span><br>        1356:  <span style="background-color: white">                  }</span><br>        1357:  <span style="background-color: white">              }</span><br>        1358:  <span style="background-color: white">          }</span><br>        1359:  <span style="background-color: white">      </span><br>        1360:  <span style="background-color: red"> 99+      protected boolean isSkipWhenCollapsingMargins() {</span><br>        1361:  <span style="background-color: red"> 99+          return false;</span><br>        1362:  <span style="background-color: white">          }</span><br>        1363:  <span style="background-color: white">      </span><br>        1364:  <span style="background-color: red"> 99+      protected boolean isMayCollapseMarginsWithChildren() {</span><br>        1365:  <span style="background-color: white"> 99+          return (! isRoot()) &amp;&amp; getStyle().isMayCollapseMarginsWithChildren();</span><br>        1366:  <span style="background-color: white">          }</span><br>        1367:  <span style="background-color: white">      </span><br>        1368:  <span style="background-color: white">          // This will require a rethink if we ever truly layout incrementally</span><br>        1369:  <span style="background-color: white">          // Should only ever collapse top margin and pick up collapsable</span><br>        1370:  <span style="background-color: white">          // bottom margins by looking back up the tree.</span><br>        1371:  <span style="background-color: red"> 99+      protected void collapseMargins(LayoutContext c) {</span><br>        1372:  <span style="background-color: white"> 99+          if (! isTopMarginCalculated() || ! isBottomMarginCalculated()) {</span><br>        1373:  <span style="background-color: red"> 99+              recalcMargin(c);</span><br>        1374:  <span style="background-color: red"> 99+              RectPropertySet margin = getMargin(c);</span><br>        1375:  <span style="background-color: white">      </span><br>        1376:  <span style="background-color: red"> 99+              if (! isTopMarginCalculated() &amp;&amp; ! isBottomMarginCalculated() &amp;&amp; isVerticalMarginsAdjoin(c)) {</span><br>        1377:  <span style="background-color: red"> 99+                  MarginCollapseResult collapsedMargin =</span><br>        1378:  <span style="background-color: red"> 99+                          _pendingCollapseCalculation != null ?</span><br>        1379:  <span style="background-color: white">                                      _pendingCollapseCalculation : new MarginCollapseResult();</span><br>        1380:  <span style="background-color: red"> 99+                  collapseEmptySubtreeMargins(c, collapsedMargin);</span><br>        1381:  <span style="background-color: red"> 99+                  setCollapsedBottomMargin(c, margin, collapsedMargin);</span><br>        1382:  <span style="background-color: white">                  } else {</span><br>        1383:  <span style="background-color: white"> 99+                  if (! isTopMarginCalculated()) {</span><br>        1384:  <span style="background-color: red"> 99+                      MarginCollapseResult collapsedMargin =</span><br>        1385:  <span style="background-color: red"> 99+                              _pendingCollapseCalculation != null ?</span><br>        1386:  <span style="background-color: white">                                          _pendingCollapseCalculation : new MarginCollapseResult();</span><br>        1387:  <span style="background-color: white">      </span><br>        1388:  <span style="background-color: red"> 99+                      collapseTopMargin(c, true, collapsedMargin);</span><br>        1389:  <span style="background-color: red"> 99+                      if ((int) margin.top() != collapsedMargin.getMargin()) {</span><br>        1390:  <span style="background-color: red"> 99+                          setMarginTop(c, collapsedMargin.getMargin());</span><br>        1391:  <span style="background-color: white">                          }</span><br>        1392:  <span style="background-color: white">                      }</span><br>        1393:  <span style="background-color: white">      </span><br>        1394:  <span style="background-color: white"> 99+                  if (! isBottomMarginCalculated()) {</span><br>        1395:  <span style="background-color: red"> 99+                      MarginCollapseResult collapsedMargin = new MarginCollapseResult();</span><br>        1396:  <span style="background-color: red"> 99+                      collapseBottomMargin(c, true, collapsedMargin);</span><br>        1397:  <span style="background-color: white">      </span><br>        1398:  <span style="background-color: red"> 99+                      setCollapsedBottomMargin(c, margin, collapsedMargin);</span><br>        1399:  <span style="background-color: white">                      }</span><br>        1400:  <span style="background-color: white">                  }</span><br>        1401:  <span style="background-color: white">              }</span><br>        1402:  <span style="background-color: white">          }</span><br>        1403:  <span style="background-color: white">      </span><br>        1404:  <span style="background-color: red"> 99+      private void setCollapsedBottomMargin(LayoutContext c, RectPropertySet margin, MarginCollapseResult collapsedMargin) {</span><br>        1405:  <span style="background-color: red"> 99+          BlockBox next = null;</span><br>        1406:  <span style="background-color: white"> 99+          if (! isInline()) {</span><br>        1407:  <span style="background-color: red"> 99+              next = getNextCollapsableSibling(collapsedMargin);</span><br>        1408:  <span style="background-color: white">              }</span><br>        1409:  <span style="background-color: red"> 99+          if (! (next == null || next instanceof AnonymousBlockBox) &amp;&amp;</span><br>        1410:  <span style="background-color: white">                      collapsedMargin.hasMargin()) {</span><br>        1411:  <span style="background-color: red"> 99+              next._pendingCollapseCalculation = collapsedMargin;</span><br>        1412:  <span style="background-color: red"> 99+              setMarginBottom(c, 0);</span><br>        1413:  <span style="background-color: red"> 99+          } else if ((int) margin.bottom() != collapsedMargin.getMargin()) {</span><br>        1414:  <span style="background-color: red">  77              setMarginBottom(c, collapsedMargin.getMargin());</span><br>        1415:  <span style="background-color: white">              }</span><br>        1416:  <span style="background-color: white">          }</span><br>        1417:  <span style="background-color: white">      </span><br>        1418:  <span style="background-color: red"> 99+      protected BlockBox getNextCollapsableSibling(MarginCollapseResult collapsedMargin) {</span><br>        1419:  <span style="background-color: red"> 99+          BlockBox next = (BlockBox) getNextSibling();</span><br>        1420:  <span style="background-color: cyan"> 99+          while (next != null) {</span><br>        1421:  <span style="background-color: cyan"> 99+              if (next instanceof AnonymousBlockBox) {</span><br>        1422:  <span style="background-color: red"> 99+                  ((AnonymousBlockBox) next).provideSiblingMarginToFloats(</span><br>        1423:  <span style="background-color: white">                              collapsedMargin.getMargin());</span><br>        1424:  <span style="background-color: white">                  }</span><br>        1425:  <span style="background-color: cyan"> 99+              if (! next.isSkipWhenCollapsingMargins()) {</span><br>        1426:  <span style="background-color: red"> 99+                  break;</span><br>        1427:  <span style="background-color: white">                  } else {</span><br>        1428:  <span style="background-color: cyan"> 99+                  next = (BlockBox) next.getNextSibling();</span><br>        1429:  <span style="background-color: white">                  }</span><br>        1430:  <span style="background-color: white">              }</span><br>        1431:  <span style="background-color: red"> 99+          return next;</span><br>        1432:  <span style="background-color: white">          }</span><br>        1433:  <span style="background-color: white">      </span><br>        1434:  <span style="background-color: red"> 99+      private void collapseTopMargin(</span><br>        1435:  <span style="background-color: white">                  LayoutContext c, boolean calculationRoot, MarginCollapseResult result) {</span><br>        1436:  <span style="background-color: white"> 99+          if (! isTopMarginCalculated()) {</span><br>        1437:  <span style="background-color: white"> 99+              if (! isSkipWhenCollapsingMargins()) {</span><br>        1438:  <span style="background-color: red"> 99+                  calcDimensions(c);</span><br>        1439:  <span style="background-color: red"> 99+                  if (c.isPrint() &amp;&amp; getStyle().isDynamicAutoWidthApplicable()) {</span><br>        1440:  <span style="background-color: white">                          // Force recalculation once box is positioned</span><br>        1441:  <span style="background-color: white">   0                      setDimensionsCalculated(false);</span><br>        1442:  <span style="background-color: white">                      }</span><br>        1443:  <span style="background-color: red"> 99+                  RectPropertySet margin = getMargin(c);</span><br>        1444:  <span style="background-color: red"> 99+                  result.update((int) margin.top());</span><br>        1445:  <span style="background-color: white">      </span><br>        1446:  <span style="background-color: red"> 99+                  if (! calculationRoot &amp;&amp; (int) margin.top() != 0) {</span><br>        1447:  <span style="background-color: white"> 99+                      setMarginTop(c, 0);</span><br>        1448:  <span style="background-color: white">                      }</span><br>        1449:  <span style="background-color: white">      </span><br>        1450:  <span style="background-color: red"> 99+                  if (isMayCollapseMarginsWithChildren() &amp;&amp; isNoTopPaddingOrBorder(c)) {</span><br>        1451:  <span style="background-color: red"> 99+                      ensureChildren(c);</span><br>        1452:  <span style="background-color: yellow"> 99+                      if (getChildrenContentType() == CONTENT_BLOCK) {</span><br>        1453:  <span style="background-color: red"> 99+                          for (Iterator
       <box>
         i = getChildIterator(); i.hasNext();) {
       </box></span><br>        1454:  <span style="background-color: red"> 99+                              BlockBox child = (BlockBox) i.next();</span><br>        1455:  <span style="background-color: red"> 99+                              child.collapseTopMargin(c, false, result);</span><br>        1456:  <span style="background-color: white">      </span><br>        1457:  <span style="background-color: red"> 99+                              if (child.isSkipWhenCollapsingMargins()) {</span><br>        1458:  <span style="background-color: white">  44                                  continue;</span><br>        1459:  <span style="background-color: white">                                  }</span><br>        1460:  <span style="background-color: white">      </span><br>        1461:  <span style="background-color: red"> 99+                              break;</span><br>        1462:  <span style="background-color: white">                              }</span><br>        1463:  <span style="background-color: white">                          }</span><br>        1464:  <span style="background-color: white">                      }</span><br>        1465:  <span style="background-color: white">                  }</span><br>        1466:  <span style="background-color: white">      </span><br>        1467:  <span style="background-color: red"> 99+              setTopMarginCalculated(true);</span><br>        1468:  <span style="background-color: white">              }</span><br>        1469:  <span style="background-color: white">          }</span><br>        1470:  <span style="background-color: white">      </span><br>        1471:  <span style="background-color: red"> 99+      private void collapseBottomMargin(</span><br>        1472:  <span style="background-color: white">                  LayoutContext c, boolean calculationRoot, MarginCollapseResult result) {</span><br>        1473:  <span style="background-color: white"> 99+          if (! isBottomMarginCalculated()) {</span><br>        1474:  <span style="background-color: white"> 99+              if (! isSkipWhenCollapsingMargins()) {</span><br>        1475:  <span style="background-color: red"> 99+                  calcDimensions(c);</span><br>        1476:  <span style="background-color: red"> 99+                  if (c.isPrint() &amp;&amp; getStyle().isDynamicAutoWidthApplicable()) {</span><br>        1477:  <span style="background-color: white">                          // Force recalculation once box is positioned</span><br>        1478:  <span style="background-color: white">   0                      setDimensionsCalculated(false);</span><br>        1479:  <span style="background-color: white">                      }</span><br>        1480:  <span style="background-color: red"> 99+                  RectPropertySet margin = getMargin(c);</span><br>        1481:  <span style="background-color: red"> 99+                  result.update((int) margin.bottom());</span><br>        1482:  <span style="background-color: white">      </span><br>        1483:  <span style="background-color: red"> 99+                  if (! calculationRoot &amp;&amp; (int) margin.bottom() != 0) {</span><br>        1484:  <span style="background-color: red"> 99+                      setMarginBottom(c, 0);</span><br>        1485:  <span style="background-color: white">                      }</span><br>        1486:  <span style="background-color: white">      </span><br>        1487:  <span style="background-color: white"> 99+                  if (isMayCollapseMarginsWithChildren() &amp;&amp;</span><br>        1488:  <span style="background-color: white">                              ! getStyle().isTable() &amp;&amp; isNoBottomPaddingOrBorder(c)) {</span><br>        1489:  <span style="background-color: red"> 99+                      ensureChildren(c);</span><br>        1490:  <span style="background-color: yellow"> 99+                      if (getChildrenContentType() == CONTENT_BLOCK) {</span><br>        1491:  <span style="background-color: red"> 99+                          for (int i = getChildCount() - 1; i &gt;= 0; i--) {</span><br>        1492:  <span style="background-color: red"> 99+                              BlockBox child = (BlockBox) getChild(i);</span><br>        1493:  <span style="background-color: white">      </span><br>        1494:  <span style="background-color: red"> 99+                              if (child.isSkipWhenCollapsingMargins()) {</span><br>        1495:  <span style="background-color: red">   5                                  continue;</span><br>        1496:  <span style="background-color: white">                                  }</span><br>        1497:  <span style="background-color: white">      </span><br>        1498:  <span style="background-color: red"> 99+                              child.collapseBottomMargin(c, false, result);</span><br>        1499:  <span style="background-color: white">      </span><br>        1500:  <span style="background-color: red"> 99+                              break;</span><br>        1501:  <span style="background-color: white">                              }</span><br>        1502:  <span style="background-color: white">                          }</span><br>        1503:  <span style="background-color: white">                      }</span><br>        1504:  <span style="background-color: white">                  }</span><br>        1505:  <span style="background-color: white">      </span><br>        1506:  <span style="background-color: red"> 99+              setBottomMarginCalculated(true);</span><br>        1507:  <span style="background-color: white">              }</span><br>        1508:  <span style="background-color: white">          }</span><br>        1509:  <span style="background-color: white">      </span><br>        1510:  <span style="background-color: red"> 99+      private boolean isNoTopPaddingOrBorder(LayoutContext c) {</span><br>        1511:  <span style="background-color: red"> 99+          RectPropertySet padding = getPadding(c);</span><br>        1512:  <span style="background-color: red"> 99+          BorderPropertySet border = getBorder(c);</span><br>        1513:  <span style="background-color: white">      </span><br>        1514:  <span style="background-color: red"> 99+          return (int) padding.top() == 0 &amp;&amp; (int) border.top() == 0;</span><br>        1515:  <span style="background-color: white">          }</span><br>        1516:  <span style="background-color: white">      </span><br>        1517:  <span style="background-color: red"> 99+      private boolean isNoBottomPaddingOrBorder(LayoutContext c) {</span><br>        1518:  <span style="background-color: red"> 99+          RectPropertySet padding = getPadding(c);</span><br>        1519:  <span style="background-color: red"> 99+          BorderPropertySet border = getBorder(c);</span><br>        1520:  <span style="background-color: white">      </span><br>        1521:  <span style="background-color: red"> 99+          return (int) padding.bottom() == 0 &amp;&amp; (int) border.bottom() == 0;</span><br>        1522:  <span style="background-color: white">          }</span><br>        1523:  <span style="background-color: white">      </span><br>        1524:  <span style="background-color: red"> 99+      private void collapseEmptySubtreeMargins(LayoutContext c, MarginCollapseResult result) {</span><br>        1525:  <span style="background-color: red"> 99+          RectPropertySet margin = getMargin(c);</span><br>        1526:  <span style="background-color: red"> 99+          result.update((int) margin.top());</span><br>        1527:  <span style="background-color: red"> 99+          result.update((int) margin.bottom());</span><br>        1528:  <span style="background-color: white">      </span><br>        1529:  <span style="background-color: red"> 99+          setMarginTop(c, 0);</span><br>        1530:  <span style="background-color: red"> 99+          setTopMarginCalculated(true);</span><br>        1531:  <span style="background-color: red"> 99+          setMarginBottom(c, 0);</span><br>        1532:  <span style="background-color: red"> 99+          setBottomMarginCalculated(true);</span><br>        1533:  <span style="background-color: white">      </span><br>        1534:  <span style="background-color: red"> 99+          ensureChildren(c);</span><br>        1535:  <span style="background-color: yellow"> 99+          if (getChildrenContentType() == CONTENT_BLOCK) {</span><br>        1536:  <span style="background-color: white"> 99+              for (Iterator
       <box>
         i = getChildIterator(); i.hasNext();) {
       </box></span><br>        1537:  <span style="background-color: white">  79                  BlockBox child = (BlockBox) i.next();</span><br>        1538:  <span style="background-color: white">  79                  child.collapseEmptySubtreeMargins(c, result);</span><br>        1539:  <span style="background-color: white">                  }</span><br>        1540:  <span style="background-color: white">              }</span><br>        1541:  <span style="background-color: white">          }</span><br>        1542:  <span style="background-color: white">      </span><br>        1543:  <span style="background-color: red"> 99+      private boolean isVerticalMarginsAdjoin(LayoutContext c) {</span><br>        1544:  <span style="background-color: red"> 99+          CalculatedStyle style = getStyle();</span><br>        1545:  <span style="background-color: white">      </span><br>        1546:  <span style="background-color: red"> 99+          BorderPropertySet borderWidth = style.getBorder(c);</span><br>        1547:  <span style="background-color: red"> 99+          RectPropertySet padding = getPadding(c);</span><br>        1548:  <span style="background-color: white">      </span><br>        1549:  <span style="background-color: red"> 99+          boolean bordersOrPadding =</span><br>        1550:  <span style="background-color: white">                      (int) borderWidth.top() != 0 || (int) borderWidth.bottom() != 0 ||</span><br>        1551:  <span style="background-color: white">                              (int) padding.top() != 0 || (int) padding.bottom() != 0;</span><br>        1552:  <span style="background-color: white">      </span><br>        1553:  <span style="background-color: red"> 99+          if (bordersOrPadding) {</span><br>        1554:  <span style="background-color: cyan"> 99+              return false;</span><br>        1555:  <span style="background-color: white">              }</span><br>        1556:  <span style="background-color: white">      </span><br>        1557:  <span style="background-color: red"> 99+          ensureChildren(c);</span><br>        1558:  <span style="background-color: yellow"> 99+          if (getChildrenContentType() == CONTENT_INLINE) {</span><br>        1559:  <span style="background-color: red"> 99+              return false;</span><br>        1560:  <span style="background-color: yellow"> 99+          } else if (getChildrenContentType() == CONTENT_BLOCK) {</span><br>        1561:  <span style="background-color: red"> 99+              for (Iterator
       <box>
         i = getChildIterator(); i.hasNext();) {
       </box></span><br>        1562:  <span style="background-color: red"> 99+                  BlockBox child = (BlockBox) i.next();</span><br>        1563:  <span style="background-color: red"> 99+                  if (child.isSkipWhenCollapsingMargins() || ! child.isVerticalMarginsAdjoin(c)) {</span><br>        1564:  <span style="background-color: red"> 99+                      return false;</span><br>        1565:  <span style="background-color: white">                      }</span><br>        1566:  <span style="background-color: white">                  }</span><br>        1567:  <span style="background-color: white">              }</span><br>        1568:  <span style="background-color: white">      </span><br>        1569:  <span style="background-color: red"> 99+          return style.asFloat(CSSName.MIN_HEIGHT) == 0 &amp;&amp;</span><br>        1570:  <span style="background-color: white">                      (isAutoHeight() || style.asFloat(CSSName.HEIGHT) == 0);</span><br>        1571:  <span style="background-color: white">          }</span><br>        1572:  <span style="background-color: white">      </span><br>        1573:  <span style="background-color: red"> 99+      public boolean isTopMarginCalculated() {</span><br>        1574:  <span style="background-color: white"> 99+          return _topMarginCalculated;</span><br>        1575:  <span style="background-color: white">          }</span><br>        1576:  <span style="background-color: white">      </span><br>        1577:  <span style="background-color: red"> 99+      public void setTopMarginCalculated(boolean topMarginCalculated) {</span><br>        1578:  <span style="background-color: red"> 99+          _topMarginCalculated = topMarginCalculated;</span><br>        1579:  <span style="background-color: white">          }</span><br>        1580:  <span style="background-color: white">      </span><br>        1581:  <span style="background-color: red"> 99+      public boolean isBottomMarginCalculated() {</span><br>        1582:  <span style="background-color: white"> 99+          return _bottomMarginCalculated;</span><br>        1583:  <span style="background-color: white">          }</span><br>        1584:  <span style="background-color: white">      </span><br>        1585:  <span style="background-color: red"> 99+      public void setBottomMarginCalculated(boolean bottomMarginCalculated) {</span><br>        1586:  <span style="background-color: red"> 99+          _bottomMarginCalculated = bottomMarginCalculated;</span><br>        1587:  <span style="background-color: white">          }</span><br>        1588:  <span style="background-color: white">      </span><br>        1589:  <span style="background-color: red"> 99+      protected int getCSSWidth(CssContext c) {</span><br>        1590:  <span style="background-color: red"> 99+          return getCSSWidth(c, false);</span><br>        1591:  <span style="background-color: white">          }</span><br>        1592:  <span style="background-color: white">      </span><br>        1593:  <span style="background-color: red"> 99+      protected int getCSSWidth(CssContext c, boolean shrinkingToFit) {</span><br>        1594:  <span style="background-color: white"> 99+          if (! isAnonymous()) {</span><br>        1595:  <span style="background-color: white"> 99+              if (! getStyle().isAutoWidth()) {</span><br>        1596:  <span style="background-color: red"> 99+                  if (shrinkingToFit &amp;&amp; ! getStyle().isAbsoluteWidth()) {</span><br>        1597:  <span style="background-color: white"> 99+                      return -1;</span><br>        1598:  <span style="background-color: white">                      } else {</span><br>        1599:  <span style="background-color: red"> 99+                      int result = (int) getStyle().getFloatPropertyProportionalWidth(</span><br>        1600:  <span style="background-color: white">                                  CSSName.WIDTH, getContainingBlock().getContentWidth(), c);</span><br>        1601:  <span style="background-color: red"> 99+                      return result &gt;= 0 ? result : -1;</span><br>        1602:  <span style="background-color: white">                      }</span><br>        1603:  <span style="background-color: white">                  }</span><br>        1604:  <span style="background-color: white">              }</span><br>        1605:  <span style="background-color: white">      </span><br>        1606:  <span style="background-color: red"> 99+          return -1;</span><br>        1607:  <span style="background-color: white">          }</span><br>        1608:  <span style="background-color: white">      </span><br>        1609:  <span style="background-color: white">   0      protected int getCSSFitToWidth(CssContext c) {</span><br>        1610:  <span style="background-color: white">   0          if (! isAnonymous()) {</span><br>        1611:  <span style="background-color: white">   0              if (! getStyle().isIdent(CSSName.FS_FIT_IMAGES_TO_WIDTH, IdentValue.AUTO))</span><br>        1612:  <span style="background-color: white">                  {</span><br>        1613:  <span style="background-color: white">   0                  int result = (int) getStyle().getFloatPropertyProportionalWidth(</span><br>        1614:  <span style="background-color: white">                              CSSName.FS_FIT_IMAGES_TO_WIDTH, getContainingBlock().getContentWidth(), c);</span><br>        1615:  <span style="background-color: white">   0                  return result &gt;= 0 ? result : -1;</span><br>        1616:  <span style="background-color: white">                  }</span><br>        1617:  <span style="background-color: white">              }</span><br>        1618:  <span style="background-color: white">      </span><br>        1619:  <span style="background-color: white">   0          return -1;</span><br>        1620:  <span style="background-color: white">          }</span><br>        1621:  <span style="background-color: white">      </span><br>        1622:  <span style="background-color: red"> 99+      protected int getCSSHeight(CssContext c) {</span><br>        1623:  <span style="background-color: white"> 99+          if (! isAnonymous()) {</span><br>        1624:  <span style="background-color: white"> 99+              if (! isAutoHeight()) {</span><br>        1625:  <span style="background-color: red"> 99+                  if (getStyle().hasAbsoluteUnit(CSSName.HEIGHT)) {</span><br>        1626:  <span style="background-color: red"> 99+                      return (int)getStyle().getFloatPropertyProportionalHeight(CSSName.HEIGHT, 0, c);</span><br>        1627:  <span style="background-color: white">                      } else {</span><br>        1628:  <span style="background-color: white"> 99+                      return (int)getStyle().getFloatPropertyProportionalHeight(</span><br>        1629:  <span style="background-color: white">                                  CSSName.HEIGHT,</span><br>        1630:  <span style="background-color: white">                                  ((BlockBox)getContainingBlock()).getCSSHeight(c),</span><br>        1631:  <span style="background-color: white">                                  c);</span><br>        1632:  <span style="background-color: white">                      }</span><br>        1633:  <span style="background-color: white">                  }</span><br>        1634:  <span style="background-color: white">              }</span><br>        1635:  <span style="background-color: white">      </span><br>        1636:  <span style="background-color: red"> 99+          return -1;</span><br>        1637:  <span style="background-color: white">          }</span><br>        1638:  <span style="background-color: white">      </span><br>        1639:  <span style="background-color: red"> 99+      public boolean isAutoHeight() {</span><br>        1640:  <span style="background-color: white"> 99+          if (getStyle().isAutoHeight()) {</span><br>        1641:  <span style="background-color: red"> 99+              return true;</span><br>        1642:  <span style="background-color: red"> 99+          } else if (getStyle().hasAbsoluteUnit(CSSName.HEIGHT)) {</span><br>        1643:  <span style="background-color: red"> 99+              return false;</span><br>        1644:  <span style="background-color: white">              } else {</span><br>        1645:  <span style="background-color: white">                  // We have a percentage height, defer to our block parent (if applicable)</span><br>        1646:  <span style="background-color: white"> 99+              Box cb = getContainingBlock();</span><br>        1647:  <span style="background-color: white"> 99+              if (cb.isStyled() &amp;&amp; (cb instanceof BlockBox)) {</span><br>        1648:  <span style="background-color: white"> 99+                  return ((BlockBox)cb).isAutoHeight();</span><br>        1649:  <span style="background-color: white">   3              } else return !(cb instanceof BlockBox) || !cb.isInitialContainingBlock();</span><br>        1650:  <span style="background-color: white">              }</span><br>        1651:  <span style="background-color: white">          }</span><br>        1652:  <span style="background-color: white">      </span><br>        1653:  <span style="background-color: red"> 99+      private int getCSSMinWidth(CssContext c) {</span><br>        1654:  <span style="background-color: red"> 99+          return getStyle().getMinWidth(c, getContainingBlockWidth());</span><br>        1655:  <span style="background-color: white">          }</span><br>        1656:  <span style="background-color: white">      </span><br>        1657:  <span style="background-color: red"> 99+      private int getCSSMaxWidth(CssContext c) {</span><br>        1658:  <span style="background-color: red"> 99+          return getStyle().getMaxWidth(c, getContainingBlockWidth());</span><br>        1659:  <span style="background-color: white">          }</span><br>        1660:  <span style="background-color: white">      </span><br>        1661:  <span style="background-color: red"> 99+      private int getCSSMinHeight(CssContext c) {</span><br>        1662:  <span style="background-color: red"> 99+          return getStyle().getMinHeight(c, getContainingBlockCSSHeight(c));</span><br>        1663:  <span style="background-color: white">          }</span><br>        1664:  <span style="background-color: white">      </span><br>        1665:  <span style="background-color: white">  69      private int getCSSMaxHeight(CssContext c) {</span><br>        1666:  <span style="background-color: white">  69          return getStyle().getMaxHeight(c, getContainingBlockCSSHeight(c));</span><br>        1667:  <span style="background-color: white">          }</span><br>        1668:  <span style="background-color: white">      </span><br>        1669:  <span style="background-color: white">          // Use only when the height of the containing block is required for</span><br>        1670:  <span style="background-color: white">          // resolving percentage values.  Does not represent the actual (resolved) height</span><br>        1671:  <span style="background-color: white">          // of the containing block.</span><br>        1672:  <span style="background-color: red"> 99+      private int getContainingBlockCSSHeight(CssContext c) {</span><br>        1673:  <span style="background-color: white"> 99+          if (! getContainingBlock().isStyled() ||</span><br>        1674:  <span style="background-color: white">                      getContainingBlock().getStyle().isAutoHeight()) {</span><br>        1675:  <span style="background-color: red"> 99+              return 0;</span><br>        1676:  <span style="background-color: white">              } else {</span><br>        1677:  <span style="background-color: cyan"> 99+              if (getContainingBlock().getStyle().hasAbsoluteUnit(CSSName.HEIGHT)) {</span><br>        1678:  <span style="background-color: white"> 99+                  return (int) getContainingBlock().getStyle().getFloatPropertyProportionalTo(</span><br>        1679:  <span style="background-color: white">                              CSSName.HEIGHT, 0, c);</span><br>        1680:  <span style="background-color: white">                  } else {</span><br>        1681:  <span style="background-color: white">  17                  return 0;</span><br>        1682:  <span style="background-color: white">                  }</span><br>        1683:  <span style="background-color: white">              }</span><br>        1684:  <span style="background-color: white">          }</span><br>        1685:  <span style="background-color: white">      </span><br>        1686:  <span style="background-color: red"> 99+      private int calcShrinkToFitWidth(LayoutContext c) {</span><br>        1687:  <span style="background-color: red"> 99+          calcMinMaxWidth(c);</span><br>        1688:  <span style="background-color: white">      </span><br>        1689:  <span style="background-color: red"> 99+          return Math.min(Math.max(getMinWidth(), getAvailableWidth(c)), getMaxWidth());</span><br>        1690:  <span style="background-color: white">          }</span><br>        1691:  <span style="background-color: white">      </span><br>        1692:  <span style="background-color: red"> 99+      protected int getAvailableWidth(LayoutContext c) {</span><br>        1693:  <span style="background-color: white"> 99+          if (! getStyle().isAbsolute()) {</span><br>        1694:  <span style="background-color: white"> 99+              return getContainingBlockWidth();</span><br>        1695:  <span style="background-color: white">              } else {</span><br>        1696:  <span style="background-color: red">   9              int left = 0;</span><br>        1697:  <span style="background-color: red">   9              int right = 0;</span><br>        1698:  <span style="background-color: red">   9              if (! getStyle().isIdent(CSSName.LEFT, IdentValue.AUTO)) {</span><br>        1699:  <span style="background-color: white">   4                  left =</span><br>        1700:  <span style="background-color: white">                              (int) getStyle().getFloatPropertyProportionalTo(CSSName.LEFT,</span><br>        1701:  <span style="background-color: white">                                      getContainingBlock().getContentWidth(), c);</span><br>        1702:  <span style="background-color: white">                  }</span><br>        1703:  <span style="background-color: white">      </span><br>        1704:  <span style="background-color: red">   9              if (! getStyle().isIdent(CSSName.RIGHT, IdentValue.AUTO)) {</span><br>        1705:  <span style="background-color: white">   1                  right =</span><br>        1706:  <span style="background-color: white">                              (int) getStyle().getFloatPropertyProportionalTo(CSSName.RIGHT,</span><br>        1707:  <span style="background-color: white">                                      getContainingBlock().getContentWidth(), c);</span><br>        1708:  <span style="background-color: white">                  }</span><br>        1709:  <span style="background-color: white">      </span><br>        1710:  <span style="background-color: red">   9              return getContainingBlock().getPaddingWidth(c) - left - right;</span><br>        1711:  <span style="background-color: white">              }</span><br>        1712:  <span style="background-color: white">          }</span><br>        1713:  <span style="background-color: white">      </span><br>        1714:  <span style="background-color: red"> 99+      protected boolean isFixedWidthAdvisoryOnly() {</span><br>        1715:  <span style="background-color: red"> 99+          return false;</span><br>        1716:  <span style="background-color: white">          }</span><br>        1717:  <span style="background-color: white">      </span><br>        1718:  <span style="background-color: white">      </span><br>        1719:  <span style="background-color: red"> 99+      private void recalcMargin(LayoutContext c) {</span><br>        1720:  <span style="background-color: white"> 99+          if (isTopMarginCalculated() &amp;&amp; isBottomMarginCalculated()) {</span><br>        1721:  <span style="background-color: red"> 99+              return;</span><br>        1722:  <span style="background-color: white">              }</span><br>        1723:  <span style="background-color: white">      </span><br>        1724:  <span style="background-color: white">              // Check if we're a potential candidate upfront to avoid expensive</span><br>        1725:  <span style="background-color: white">              // getStyleMargin(c, false) call</span><br>        1726:  <span style="background-color: red"> 99+          FSDerivedValue topMargin = getStyle().valueByName(CSSName.MARGIN_TOP);</span><br>        1727:  <span style="background-color: red"> 99+          boolean resetTop = topMargin instanceof LengthValue &amp;&amp; ! topMargin.hasAbsoluteUnit();</span><br>        1728:  <span style="background-color: white">      </span><br>        1729:  <span style="background-color: red"> 99+          FSDerivedValue bottomMargin = getStyle().valueByName(CSSName.MARGIN_BOTTOM);</span><br>        1730:  <span style="background-color: red"> 99+          boolean resetBottom = bottomMargin instanceof LengthValue &amp;&amp; ! bottomMargin.hasAbsoluteUnit();</span><br>        1731:  <span style="background-color: white">      </span><br>        1732:  <span style="background-color: red"> 99+          if (! resetTop &amp;&amp; ! resetBottom) {</span><br>        1733:  <span style="background-color: red"> 99+              return;</span><br>        1734:  <span style="background-color: white">              }</span><br>        1735:  <span style="background-color: white">      </span><br>        1736:  <span style="background-color: white">   0          RectPropertySet styleMargin = getStyleMargin(c, false);</span><br>        1737:  <span style="background-color: white">   0          RectPropertySet workingMargin = getMargin(c);</span><br>        1738:  <span style="background-color: white">      </span><br>        1739:  <span style="background-color: white">              // A shrink-to-fit calculation may have set incorrect values for</span><br>        1740:  <span style="background-color: white">              // percentage margins (as the containing block width</span><br>        1741:  <span style="background-color: white">              // hasn't been calculated yet).  Reset top and bottom margins</span><br>        1742:  <span style="background-color: white">              // in this case.</span><br>        1743:  <span style="background-color: white">   0          if (! isTopMarginCalculated() &amp;&amp;</span><br>        1744:  <span style="background-color: white">                      styleMargin.top() != workingMargin.top()) {</span><br>        1745:  <span style="background-color: white">   0              setMarginTop(c, (int) styleMargin.top());</span><br>        1746:  <span style="background-color: white">              }</span><br>        1747:  <span style="background-color: white">      </span><br>        1748:  <span style="background-color: white">   0          if (! isBottomMarginCalculated() &amp;&amp;</span><br>        1749:  <span style="background-color: white">                      styleMargin.bottom() != workingMargin.bottom()) {</span><br>        1750:  <span style="background-color: white">   0              setMarginBottom(c, (int) styleMargin.bottom());</span><br>        1751:  <span style="background-color: white">              }</span><br>        1752:  <span style="background-color: white">          }</span><br>        1753:  <span style="background-color: white">      </span><br>        1754:  <span style="background-color: red"> 99+      public void calcMinMaxWidth(LayoutContext c) {</span><br>        1755:  <span style="background-color: white"> 99+          if (! isMinMaxCalculated()) {</span><br>        1756:  <span style="background-color: red"> 99+              RectPropertySet margin = getMargin(c);</span><br>        1757:  <span style="background-color: red"> 99+              BorderPropertySet border = getBorder(c);</span><br>        1758:  <span style="background-color: red"> 99+              RectPropertySet padding = getPadding(c);</span><br>        1759:  <span style="background-color: white">      </span><br>        1760:  <span style="background-color: red"> 99+              int width = getCSSWidth(c, true);</span><br>        1761:  <span style="background-color: white">      </span><br>        1762:  <span style="background-color: red"> 99+              createReplaced(c);</span><br>        1763:  <span style="background-color: red"> 99+              if (isReplaced() &amp;&amp; width == -1) {</span><br>        1764:  <span style="background-color: white">                      // FIXME: We need to special case this for issue 313.</span><br>        1765:  <span style="background-color: red">  18                  width = getContentWidth();</span><br>        1766:  <span style="background-color: white">                  }</span><br>        1767:  <span style="background-color: white">       </span><br>        1768:  <span style="background-color: red"> 99+              if (width != -1 &amp;&amp; !isFixedWidthAdvisoryOnly()) {</span><br>        1769:  <span style="background-color: white"> 99+                  _minWidth = _maxWidth =</span><br>        1770:  <span style="background-color: white">                              (int) margin.left() + (int) border.left() + (int) padding.left() +</span><br>        1771:  <span style="background-color: white">                                      width +</span><br>        1772:  <span style="background-color: white">                                      (int) margin.right() + (int) border.right() + (int) padding.right();</span><br>        1773:  <span style="background-color: white">                  } else {</span><br>        1774:  <span style="background-color: red"> 99+                  int cw = -1;</span><br>        1775:  <span style="background-color: red"> 99+                  if (width != -1) {</span><br>        1776:  <span style="background-color: white">                          // Set a provisional content width on table cells so</span><br>        1777:  <span style="background-color: white">                          // percentage values resolve correctly (but save and reset</span><br>        1778:  <span style="background-color: white">                          // the existing value)</span><br>        1779:  <span style="background-color: white">  53                      cw = getContentWidth();</span><br>        1780:  <span style="background-color: white">  53                      setContentWidth(width);</span><br>        1781:  <span style="background-color: white">                      }</span><br>        1782:  <span style="background-color: white">      </span><br>        1783:  <span style="background-color: white"> 99+                  _minWidth = _maxWidth =</span><br>        1784:  <span style="background-color: white">                              (int) margin.left() + (int) border.left() + (int) padding.left() +</span><br>        1785:  <span style="background-color: white">                                      (int) margin.right() + (int) border.right() + (int) padding.right();</span><br>        1786:  <span style="background-color: white">      </span><br>        1787:  <span style="background-color: red"> 99+                  int minimumMaxWidth = _maxWidth;</span><br>        1788:  <span style="background-color: red"> 99+                  if (width != -1) {</span><br>        1789:  <span style="background-color: white">  53                      minimumMaxWidth += width;</span><br>        1790:  <span style="background-color: white">                      }</span><br>        1791:  <span style="background-color: white">      </span><br>        1792:  <span style="background-color: red"> 99+                  ensureChildren(c);</span><br>        1793:  <span style="background-color: white">      </span><br>        1794:  <span style="background-color: yellow"> 99+                  if (getChildrenContentType() == CONTENT_BLOCK ||</span><br>        1795:  <span style="background-color: yellow">                              getChildrenContentType() == CONTENT_INLINE) {</span><br>        1796:  <span style="background-color: yellow"> 99+                      switch (getChildrenContentType()) {</span><br>        1797:  <span style="background-color: yellow"> 99+                          case CONTENT_BLOCK:</span><br>        1798:  <span style="background-color: yellow"> 99+                              calcMinMaxWidthBlockChildren(c);</span><br>        1799:  <span style="background-color: yellow"> 99+                              break;</span><br>        1800:  <span style="background-color: yellow"> 99+                          case CONTENT_INLINE:</span><br>        1801:  <span style="background-color: yellow"> 99+                              calcMinMaxWidthInlineChildren(c);</span><br>        1802:  <span style="background-color: yellow"> 99+                              break;</span><br>        1803:  <span style="background-color: yellow">                          }</span><br>        1804:  <span style="background-color: yellow">                      }</span><br>        1805:  <span style="background-color: white">      </span><br>        1806:  <span style="background-color: red"> 99+                  if (minimumMaxWidth &gt; _maxWidth) {</span><br>        1807:  <span style="background-color: white">  53                      _maxWidth = minimumMaxWidth;</span><br>        1808:  <span style="background-color: white">                      }</span><br>        1809:  <span style="background-color: white">      </span><br>        1810:  <span style="background-color: red"> 99+                  if (cw != -1) {</span><br>        1811:  <span style="background-color: white">  53                      setContentWidth(cw);</span><br>        1812:  <span style="background-color: white">                      }</span><br>        1813:  <span style="background-color: white">                  }</span><br>        1814:  <span style="background-color: white">      </span><br>        1815:  <span style="background-color: white"> 99+              if (! isReplaced()) {</span><br>        1816:  <span style="background-color: red"> 99+                  calcMinMaxCSSMinMaxWidth(c, margin, border, padding);</span><br>        1817:  <span style="background-color: white">                  }</span><br>        1818:  <span style="background-color: red"> 99+              setMinMaxCalculated(true);</span><br>        1819:  <span style="background-color: white">              }</span><br>        1820:  <span style="background-color: white">          }</span><br>        1821:  <span style="background-color: white">      </span><br>        1822:  <span style="background-color: white">   0      @Deprecated</span><br>        1823:  <span style="background-color: yellow">          private ReplacedElement fitReplacedElement(LayoutContext c,</span><br>        1824:  <span style="background-color: yellow">                  ReplacedElement re)</span><br>        1825:  <span style="background-color: yellow">          {</span><br>        1826:  <span style="background-color: yellow">   0          int maxImageWidth = getCSSFitToWidth(c);</span><br>        1827:  <span style="background-color: yellow">   0          if (maxImageWidth &gt; -1 &amp;&amp; re.getIntrinsicWidth() &gt; maxImageWidth)</span><br>        1828:  <span style="background-color: yellow">              {</span><br>        1829:  <span style="background-color: yellow">   0              double oldWidth = (double)re.getIntrinsicWidth();</span><br>        1830:  <span style="background-color: yellow">   0              double scale = ((double)maxImageWidth)/oldWidth;</span><br>        1831:  <span style="background-color: yellow">   0              re = c.getReplacedElementFactory().createReplacedElement(</span><br>        1832:  <span style="background-color: yellow">                          c, this, c.getUac(), maxImageWidth, (int)Math.rint(scale * (double)re.getIntrinsicHeight()));</span><br>        1833:  <span style="background-color: yellow">              }</span><br>        1834:  <span style="background-color: yellow">   0          return re;</span><br>        1835:  <span style="background-color: yellow">          }</span><br>        1836:  <span style="background-color: white">      </span><br>        1837:  <span style="background-color: red"> 99+      private void calcMinMaxCSSMinMaxWidth(</span><br>        1838:  <span style="background-color: white">                  LayoutContext c, RectPropertySet margin, BorderPropertySet border,</span><br>        1839:  <span style="background-color: white">                  RectPropertySet padding) {</span><br>        1840:  <span style="background-color: red"> 99+          int cssMinWidth = getCSSMinWidth(c);</span><br>        1841:  <span style="background-color: red"> 99+          if (cssMinWidth &gt; 0) {</span><br>        1842:  <span style="background-color: white">  36              cssMinWidth +=</span><br>        1843:  <span style="background-color: white">                          (int) margin.left() + (int) border.left() + (int) padding.left() +</span><br>        1844:  <span style="background-color: white">                                  (int) margin.right() + (int) border.right() + (int) padding.right();</span><br>        1845:  <span style="background-color: white">  36              if (_minWidth &lt; cssMinWidth) {</span><br>        1846:  <span style="background-color: white">  34                  _minWidth = cssMinWidth;</span><br>        1847:  <span style="background-color: white">                  }</span><br>        1848:  <span style="background-color: white">              }</span><br>        1849:  <span style="background-color: white"> 99+          if (! getStyle().isMaxWidthNone()) {</span><br>        1850:  <span style="background-color: white">   0              int cssMaxWidth = getCSSMaxWidth(c);</span><br>        1851:  <span style="background-color: white">   0              cssMaxWidth +=</span><br>        1852:  <span style="background-color: white">                          (int) margin.left() + (int) border.left() + (int) padding.left() +</span><br>        1853:  <span style="background-color: white">                                  (int) margin.right() + (int) border.right() + (int) padding.right();</span><br>        1854:  <span style="background-color: white">   0              if (_maxWidth &gt; cssMaxWidth) {</span><br>        1855:  <span style="background-color: white">   0                  if (cssMaxWidth &gt; _minWidth) {</span><br>        1856:  <span style="background-color: white">   0                      _maxWidth = cssMaxWidth;</span><br>        1857:  <span style="background-color: white">                      } else {</span><br>        1858:  <span style="background-color: white">   0                      _maxWidth = _minWidth;</span><br>        1859:  <span style="background-color: white">                      }</span><br>        1860:  <span style="background-color: white">                  }</span><br>        1861:  <span style="background-color: white">              }</span><br>        1862:  <span style="background-color: white">          }</span><br>        1863:  <span style="background-color: white">      </span><br>        1864:  <span style="background-color: red"> 99+      private void calcMinMaxWidthBlockChildren(LayoutContext c) {</span><br>        1865:  <span style="background-color: red"> 99+          int childMinWidth = 0;</span><br>        1866:  <span style="background-color: red"> 99+          int childMaxWidth = 0;</span><br>        1867:  <span style="background-color: white">      </span><br>        1868:  <span style="background-color: red"> 99+          for (Iterator
       <box>
         i = getChildIterator(); i.hasNext();) {
       </box></span><br>        1869:  <span style="background-color: red"> 99+              BlockBox child = (BlockBox) i.next();</span><br>        1870:  <span style="background-color: red"> 99+              child.calcMinMaxWidth(c);</span><br>        1871:  <span style="background-color: red"> 99+              if (child.getMinWidth() &gt; childMinWidth) {</span><br>        1872:  <span style="background-color: red"> 99+                  childMinWidth = child.getMinWidth();</span><br>        1873:  <span style="background-color: white">                  }</span><br>        1874:  <span style="background-color: red"> 99+              if (child.getMaxWidth() &gt; childMaxWidth) {</span><br>        1875:  <span style="background-color: red"> 99+                  childMaxWidth = child.getMaxWidth();</span><br>        1876:  <span style="background-color: white">                  }</span><br>        1877:  <span style="background-color: white">              }</span><br>        1878:  <span style="background-color: white">      </span><br>        1879:  <span style="background-color: red"> 99+          _minWidth += childMinWidth;</span><br>        1880:  <span style="background-color: red"> 99+          _maxWidth += childMaxWidth;</span><br>        1881:  <span style="background-color: white">          }</span><br>        1882:  <span style="background-color: white">      </span><br>        1883:  <span style="background-color: red"> 99+      private void calcMinMaxWidthInlineChildren(LayoutContext c) {</span><br>        1884:  <span style="background-color: red"> 99+          int textIndent = (int) getStyle().getFloatPropertyProportionalWidth(</span><br>        1885:  <span style="background-color: white">                      CSSName.TEXT_INDENT, getContentWidth(), c);</span><br>        1886:  <span style="background-color: white">      </span><br>        1887:  <span style="background-color: white"> 99+          if (getStyle().isListItem() &amp;&amp; getStyle().isListMarkerInside()) {</span><br>        1888:  <span style="background-color: white">   0              createMarkerData(c);</span><br>        1889:  <span style="background-color: white">   0              textIndent += getMarkerData().getLayoutWidth();</span><br>        1890:  <span style="background-color: white">              }</span><br>        1891:  <span style="background-color: white">      </span><br>        1892:  <span style="background-color: red"> 99+          int childMinWidth = 0;</span><br>        1893:  <span style="background-color: red"> 99+          int childMaxWidth = 0;</span><br>        1894:  <span style="background-color: red"> 99+          int lineWidth = 0;</span><br>        1895:  <span style="background-color: white">      </span><br>        1896:  <span style="background-color: red"> 99+          InlineBox trimmableIB = null;</span><br>        1897:  <span style="background-color: white">      </span><br>        1898:  <span style="background-color: red"> 99+          for (Styleable child : _inlineContent) {</span><br>        1899:  <span style="background-color: red"> 99+              if (child.getStyle().isAbsolute() || child.getStyle().isFixed() || child.getStyle().isRunning()) {</span><br>        1900:  <span style="background-color: red">   2                  continue;</span><br>        1901:  <span style="background-color: white">                  }</span><br>        1902:  <span style="background-color: white">      </span><br>        1903:  <span style="background-color: red"> 99+              if (child.getStyle().isFloated() || child.getStyle().isInlineBlock() ||</span><br>        1904:  <span style="background-color: white">                          child.getStyle().isInlineTable()) {</span><br>        1905:  <span style="background-color: red">  98                  if (child.getStyle().isFloated() &amp;&amp; child.getStyle().isCleared()) {</span><br>        1906:  <span style="background-color: white">   0                      if (trimmableIB != null) {</span><br>        1907:  <span style="background-color: white">   0                          lineWidth -= trimmableIB.getTrailingSpaceWidth(c);</span><br>        1908:  <span style="background-color: white">                          }</span><br>        1909:  <span style="background-color: white">   0                      if (lineWidth &gt; childMaxWidth) {</span><br>        1910:  <span style="background-color: white">   0                          childMaxWidth = lineWidth;</span><br>        1911:  <span style="background-color: white">                          }</span><br>        1912:  <span style="background-color: white">   0                      lineWidth = 0;</span><br>        1913:  <span style="background-color: white">                      }</span><br>        1914:  <span style="background-color: red">  98                  trimmableIB = null;</span><br>        1915:  <span style="background-color: red">  98                  BlockBox block = (BlockBox) child;</span><br>        1916:  <span style="background-color: red">  98                  block.calcMinMaxWidth(c);</span><br>        1917:  <span style="background-color: red">  98                  lineWidth += block.getMaxWidth();</span><br>        1918:  <span style="background-color: red">  98                  if (block.getMinWidth() &gt; childMinWidth) {</span><br>        1919:  <span style="background-color: red">  69                      childMinWidth = block.getMinWidth();</span><br>        1920:  <span style="background-color: white">                      }</span><br>        1921:  <span style="background-color: white">                  } else { /* child.getStyle().isInline() */</span><br>        1922:  <span style="background-color: red"> 99+                  InlineBox iB = (InlineBox) child;</span><br>        1923:  <span style="background-color: red"> 99+                  IdentValue whitespace = iB.getStyle().getWhitespace();</span><br>        1924:  <span style="background-color: white">      </span><br>        1925:  <span style="background-color: red"> 99+                  iB.calcMinMaxWidth(c, getContentWidth(), lineWidth == 0);</span><br>        1926:  <span style="background-color: white">      </span><br>        1927:  <span style="background-color: red"> 99+                  if (whitespace == IdentValue.NOWRAP) {</span><br>        1928:  <span style="background-color: red">  14                      lineWidth += textIndent + iB.getMaxWidth();</span><br>        1929:  <span style="background-color: red">  14                      if (iB.getMinWidth() &gt; childMinWidth) {</span><br>        1930:  <span style="background-color: red">  14                          childMinWidth = iB.getMinWidth();</span><br>        1931:  <span style="background-color: white">                          }</span><br>        1932:  <span style="background-color: red">  14                      trimmableIB = iB;</span><br>        1933:  <span style="background-color: red"> 99+                  } else if (whitespace == IdentValue.PRE) {</span><br>        1934:  <span style="background-color: red">  90                      if (trimmableIB != null) {</span><br>        1935:  <span style="background-color: white">   0                          lineWidth -= trimmableIB.getTrailingSpaceWidth(c);</span><br>        1936:  <span style="background-color: white">                          }</span><br>        1937:  <span style="background-color: red">  90                      trimmableIB = null;</span><br>        1938:  <span style="background-color: red">  90                      if (lineWidth &gt; childMaxWidth) {</span><br>        1939:  <span style="background-color: white">   0                          childMaxWidth = lineWidth;</span><br>        1940:  <span style="background-color: white">                          }</span><br>        1941:  <span style="background-color: red">  90                      lineWidth = textIndent + iB.getFirstLineWidth();</span><br>        1942:  <span style="background-color: red">  90                      if (lineWidth &gt; childMinWidth) {</span><br>        1943:  <span style="background-color: red">  90                          childMinWidth = lineWidth;</span><br>        1944:  <span style="background-color: white">                          }</span><br>        1945:  <span style="background-color: red">  90                      lineWidth = iB.getMaxWidth();</span><br>        1946:  <span style="background-color: red">  90                      if (lineWidth &gt; childMinWidth) {</span><br>        1947:  <span style="background-color: red">  88                          childMinWidth = lineWidth;</span><br>        1948:  <span style="background-color: white">                          }</span><br>        1949:  <span style="background-color: red">  90                      if (childMinWidth &gt; childMaxWidth) {</span><br>        1950:  <span style="background-color: red">  90                          childMaxWidth = childMinWidth;</span><br>        1951:  <span style="background-color: white">                          }</span><br>        1952:  <span style="background-color: red">  90                      lineWidth = 0;</span><br>        1953:  <span style="background-color: red"> 99+                  } else if (whitespace == IdentValue.PRE_WRAP || whitespace == IdentValue.PRE_LINE) {</span><br>        1954:  <span style="background-color: red"> 99+                      lineWidth += textIndent + iB.getFirstLineWidth();</span><br>        1955:  <span style="background-color: red"> 99+                      if (trimmableIB != null) {</span><br>        1956:  <span style="background-color: red"> 99+                          lineWidth -= trimmableIB.getTrailingSpaceWidth(c);</span><br>        1957:  <span style="background-color: white">                          }</span><br>        1958:  <span style="background-color: red"> 99+                      if (lineWidth &gt; childMaxWidth) {</span><br>        1959:  <span style="background-color: red"> 99+                          childMaxWidth = lineWidth;</span><br>        1960:  <span style="background-color: white">                          }</span><br>        1961:  <span style="background-color: white">      </span><br>        1962:  <span style="background-color: red"> 99+                      if (iB.getMaxWidth() &gt; childMaxWidth) {</span><br>        1963:  <span style="background-color: white">  54                          childMaxWidth = iB.getMaxWidth();</span><br>        1964:  <span style="background-color: white">                          }</span><br>        1965:  <span style="background-color: red"> 99+                      if (iB.getMinWidth() &gt; childMinWidth) {</span><br>        1966:  <span style="background-color: white">  69                          childMinWidth = iB.getMinWidth();</span><br>        1967:  <span style="background-color: white">                          }</span><br>        1968:  <span style="background-color: red"> 99+                      if (whitespace == IdentValue.PRE_LINE) {</span><br>        1969:  <span style="background-color: red"> 99+                          trimmableIB = iB;</span><br>        1970:  <span style="background-color: white">                          } else {</span><br>        1971:  <span style="background-color: white">  78                          trimmableIB = null;</span><br>        1972:  <span style="background-color: white">                          }</span><br>        1973:  <span style="background-color: red"> 99+                      lineWidth = 0;</span><br>        1974:  <span style="background-color: white">                      } else /* if (whitespace == IdentValue.NORMAL) */ {</span><br>        1975:  <span style="background-color: red"> 99+                      lineWidth += textIndent + iB.getMaxWidth();</span><br>        1976:  <span style="background-color: red"> 99+                      if (iB.getMinWidth() &gt; childMinWidth) {</span><br>        1977:  <span style="background-color: red"> 99+                          childMinWidth = textIndent + iB.getMinWidth();</span><br>        1978:  <span style="background-color: white">                          }</span><br>        1979:  <span style="background-color: red"> 99+                      trimmableIB = iB;</span><br>        1980:  <span style="background-color: white">                      }</span><br>        1981:  <span style="background-color: white">      </span><br>        1982:  <span style="background-color: red"> 99+                  if (textIndent &gt; 0) {</span><br>        1983:  <span style="background-color: white">   1                      textIndent = 0;</span><br>        1984:  <span style="background-color: white">                      }</span><br>        1985:  <span style="background-color: white">                  }</span><br>        1986:  <span style="background-color: white">              }</span><br>        1987:  <span style="background-color: white">      </span><br>        1988:  <span style="background-color: red"> 99+          if (trimmableIB != null) {</span><br>        1989:  <span style="background-color: red"> 99+              lineWidth -= trimmableIB.getTrailingSpaceWidth(c);</span><br>        1990:  <span style="background-color: white">              }</span><br>        1991:  <span style="background-color: red"> 99+          if (lineWidth &gt; childMaxWidth) {</span><br>        1992:  <span style="background-color: red"> 99+              childMaxWidth = lineWidth;</span><br>        1993:  <span style="background-color: white">              }</span><br>        1994:  <span style="background-color: white">      </span><br>        1995:  <span style="background-color: red"> 99+          _minWidth += childMinWidth;</span><br>        1996:  <span style="background-color: red"> 99+          _maxWidth += childMaxWidth;</span><br>        1997:  <span style="background-color: white">          }</span><br>        1998:  <span style="background-color: white">      </span><br>        1999:  <span style="background-color: red"> 99+      public int getMaxWidth() {</span><br>        2000:  <span style="background-color: white"> 99+          return _maxWidth;</span><br>        2001:  <span style="background-color: white">          }</span><br>        2002:  <span style="background-color: white">      </span><br>        2003:  <span style="background-color: red"> 99+      protected void setMaxWidth(int maxWidth) {</span><br>        2004:  <span style="background-color: red"> 99+          _maxWidth = maxWidth;</span><br>        2005:  <span style="background-color: white">          }</span><br>        2006:  <span style="background-color: white">      </span><br>        2007:  <span style="background-color: red"> 99+      public int getMinWidth() {</span><br>        2008:  <span style="background-color: white"> 99+          return _minWidth;</span><br>        2009:  <span style="background-color: white">          }</span><br>        2010:  <span style="background-color: white">      </span><br>        2011:  <span style="background-color: red"> 99+      protected void setMinWidth(int minWidth) {</span><br>        2012:  <span style="background-color: red"> 99+          _minWidth = minWidth;</span><br>        2013:  <span style="background-color: white">          }</span><br>        2014:  <span style="background-color: white">      </span><br>        2015:  <span style="background-color: white">   0      public void styleText(LayoutContext c) {</span><br>        2016:  <span style="background-color: white">   0          styleText(c, getStyle());</span><br>        2017:  <span style="background-color: white">          }</span><br>        2018:  <span style="background-color: white">      </span><br>        2019:  <span style="background-color: white">          // FIXME Should be expanded into generic restyle facility</span><br>        2020:  <span style="background-color: white">   0      public void styleText(LayoutContext c, CalculatedStyle style) {</span><br>        2021:  <span style="background-color: yellow">   0          if (getChildrenContentType() == CONTENT_INLINE) {</span><br>        2022:  <span style="background-color: white">   0              LinkedList
       <calculatedstyle>
         styles = new LinkedList&lt;&gt;();
       </calculatedstyle></span><br>        2023:  <span style="background-color: white">   0              styles.add(style);</span><br>        2024:  <span style="background-color: white">   0              for (Object a_inlineContent : _inlineContent) {</span><br>        2025:  <span style="background-color: white">   0                  Styleable child = (Styleable) a_inlineContent;</span><br>        2026:  <span style="background-color: white">   0                  if (child instanceof InlineBox) {</span><br>        2027:  <span style="background-color: white">   0                      InlineBox iB = (InlineBox) child;</span><br>        2028:  <span style="background-color: white">      </span><br>        2029:  <span style="background-color: white">   0                      if (iB.isStartsHere()) {</span><br>        2030:  <span style="background-color: white">   0                          CascadedStyle cs = null;</span><br>        2031:  <span style="background-color: white">   0                          if (iB.getElement() != null) {</span><br>        2032:  <span style="background-color: white">   0                              if (iB.getPseudoElementOrClass() == null) {</span><br>        2033:  <span style="background-color: white">   0                                  cs = c.getCss().getCascadedStyle(iB.getElement(), false);</span><br>        2034:  <span style="background-color: white">                                  } else {</span><br>        2035:  <span style="background-color: white">   0                                  cs = c.getCss().getPseudoElementStyle(</span><br>        2036:  <span style="background-color: white">                                              iB.getElement(), iB.getPseudoElementOrClass());</span><br>        2037:  <span style="background-color: white">                                  }</span><br>        2038:  <span style="background-color: white">   0                              styles.add(styles.getLast().deriveStyle(cs));</span><br>        2039:  <span style="background-color: white">                              } else {</span><br>        2040:  <span style="background-color: white">   0                              styles.add(style.createAnonymousStyle(IdentValue.INLINE));</span><br>        2041:  <span style="background-color: white">                              }</span><br>        2042:  <span style="background-color: white">                          }</span><br>        2043:  <span style="background-color: white">      </span><br>        2044:  <span style="background-color: white">   0                      iB.setStyle(styles.getLast());</span><br>        2045:  <span style="background-color: white">   0                      iB.applyTextTransform();</span><br>        2046:  <span style="background-color: white">      </span><br>        2047:  <span style="background-color: white">   0                      if (iB.isEndsHere()) {</span><br>        2048:  <span style="background-color: white">   0                          styles.removeLast();</span><br>        2049:  <span style="background-color: white">                          }</span><br>        2050:  <span style="background-color: white">                      }</span><br>        2051:  <span style="background-color: white">                  }</span><br>        2052:  <span style="background-color: white">              }</span><br>        2053:  <span style="background-color: white">          }</span><br>        2054:  <span style="background-color: white">      </span><br>        2055:  <span style="background-color: red"> 99+      @Override</span><br>        2056:  <span style="background-color: white">          protected void calcChildPaintingInfo(</span><br>        2057:  <span style="background-color: white">                  final CssContext c, final PaintingInfo result, final boolean useCache) {</span><br>        2058:  <span style="background-color: red"> 99+          if (getPersistentBFC() != null) {</span><br>        2059:  <span style="background-color: white"> 99+              (this).getPersistentBFC().getFloatManager().performFloatOperation(</span><br>        2060:  <span style="background-color: white">                          new FloatManager.FloatOperation() {</span><br>        2061:  <span style="background-color: cyan">  96                          public void operate(Box floater) {</span><br>        2062:  <span style="background-color: red">  96                              PaintingInfo info = floater.calcPaintingInfo(c, useCache);</span><br>        2063:  <span style="background-color: white">  96                              moveIfGreater(</span><br>        2064:  <span style="background-color: white">                                          result.getOuterMarginCorner(),</span><br>        2065:  <span style="background-color: white">                                          info.getOuterMarginCorner());</span><br>        2066:  <span style="background-color: white">                              }</span><br>        2067:  <span style="background-color: white">                          });</span><br>        2068:  <span style="background-color: white">              }</span><br>        2069:  <span style="background-color: red"> 99+          super.calcChildPaintingInfo(c, result, useCache);</span><br>        2070:  <span style="background-color: white">          }</span><br>        2071:  <span style="background-color: white">      </span><br>        2072:  <span style="background-color: red"> 99+      public CascadedStyle getFirstLetterStyle() {</span><br>        2073:  <span style="background-color: white"> 99+          return _firstLetterStyle;</span><br>        2074:  <span style="background-color: white">          }</span><br>        2075:  <span style="background-color: white">      </span><br>        2076:  <span style="background-color: red"> 99+      public void setFirstLetterStyle(CascadedStyle firstLetterStyle) {</span><br>        2077:  <span style="background-color: red"> 99+          _firstLetterStyle = firstLetterStyle;</span><br>        2078:  <span style="background-color: white">          }</span><br>        2079:  <span style="background-color: white">      </span><br>        2080:  <span style="background-color: red"> 99+      public CascadedStyle getFirstLineStyle() {</span><br>        2081:  <span style="background-color: white"> 99+          return _firstLineStyle;</span><br>        2082:  <span style="background-color: white">          }</span><br>        2083:  <span style="background-color: white">      </span><br>        2084:  <span style="background-color: red"> 99+      public void setFirstLineStyle(CascadedStyle firstLineStyle) {</span><br>        2085:  <span style="background-color: red"> 99+          _firstLineStyle = firstLineStyle;</span><br>        2086:  <span style="background-color: white">          }</span><br>        2087:  <span style="background-color: white">      </span><br>        2088:  <span style="background-color: red"> 99+      protected boolean isMinMaxCalculated() {</span><br>        2089:  <span style="background-color: white"> 99+          return _minMaxCalculated;</span><br>        2090:  <span style="background-color: white">          }</span><br>        2091:  <span style="background-color: white">      </span><br>        2092:  <span style="background-color: red"> 99+      protected void setMinMaxCalculated(boolean minMaxCalculated) {</span><br>        2093:  <span style="background-color: red"> 99+          _minMaxCalculated = minMaxCalculated;</span><br>        2094:  <span style="background-color: white">          }</span><br>        2095:  <span style="background-color: white">      </span><br>        2096:  <span style="background-color: red"> 99+      protected void setDimensionsCalculated(boolean dimensionsCalculated) {</span><br>        2097:  <span style="background-color: red"> 99+          _dimensionsCalculated = dimensionsCalculated;</span><br>        2098:  <span style="background-color: white">          }</span><br>        2099:  <span style="background-color: white">      </span><br>        2100:  <span style="background-color: red"> 99+      private boolean isDimensionsCalculated() {</span><br>        2101:  <span style="background-color: white"> 99+          return _dimensionsCalculated;</span><br>        2102:  <span style="background-color: white">          }</span><br>        2103:  <span style="background-color: white">      </span><br>        2104:  <span style="background-color: red"> 99+      protected void setNeedShrinkToFitCalculatation(boolean needShrinkToFitCalculatation) {</span><br>        2105:  <span style="background-color: red"> 99+          _needShrinkToFitCalculatation = needShrinkToFitCalculatation;</span><br>        2106:  <span style="background-color: white">          }</span><br>        2107:  <span style="background-color: white">      </span><br>        2108:  <span style="background-color: red"> 99+      private boolean isNeedShrinkToFitCalculatation() {</span><br>        2109:  <span style="background-color: white"> 99+          return _needShrinkToFitCalculatation;</span><br>        2110:  <span style="background-color: white">          }</span><br>        2111:  <span style="background-color: white">      </span><br>        2112:  <span style="background-color: red"> 99+      public void initStaticPos(LayoutContext c, BlockBox parent, int childOffset) {</span><br>        2113:  <span style="background-color: red"> 99+          setX(0);</span><br>        2114:  <span style="background-color: red"> 99+          setY(childOffset);</span><br>        2115:  <span style="background-color: white">          }</span><br>        2116:  <span style="background-color: white">      </span><br>        2117:  <span style="background-color: red"> 99+      public int calcBaseline(LayoutContext c) {</span><br>        2118:  <span style="background-color: red"> 99+          for (int i = 0; i &lt; getChildCount(); i++) {</span><br>        2119:  <span style="background-color: red"> 99+              Box b = getChild(i);</span><br>        2120:  <span style="background-color: red"> 99+              if (b instanceof LineBox) {</span><br>        2121:  <span style="background-color: red"> 99+                  return b.getAbsY() + ((LineBox) b).getBaseline();</span><br>        2122:  <span style="background-color: white">                  } else {</span><br>        2123:  <span style="background-color: red">  38                  if (b instanceof TableRowBox) {</span><br>        2124:  <span style="background-color: red">  10                      return b.getAbsY() + ((TableRowBox) b).getBaseline();</span><br>        2125:  <span style="background-color: white">                      } else {</span><br>        2126:  <span style="background-color: red">  28                      int result = ((BlockBox) b).calcBaseline(c);</span><br>        2127:  <span style="background-color: red">  28                      if (result != NO_BASELINE) {</span><br>        2128:  <span style="background-color: red">  28                          return result;</span><br>        2129:  <span style="background-color: white">                          }</span><br>        2130:  <span style="background-color: white">                      }</span><br>        2131:  <span style="background-color: white">                  }</span><br>        2132:  <span style="background-color: white">              }</span><br>        2133:  <span style="background-color: white">      </span><br>        2134:  <span style="background-color: white">   7          return NO_BASELINE;</span><br>        2135:  <span style="background-color: white">          }</span><br>        2136:  <span style="background-color: white">      </span><br>        2137:  <span style="background-color: red"> 99+      protected int calcInitialBreakAtLine(LayoutContext c) {</span><br>        2138:  <span style="background-color: red"> 99+          BreakAtLineContext bContext = c.getBreakAtLineContext();</span><br>        2139:  <span style="background-color: red"> 99+          if (bContext != null &amp;&amp; bContext.getBlock() == this) {</span><br>        2140:  <span style="background-color: white">   0              return bContext.getLine();</span><br>        2141:  <span style="background-color: white">              }</span><br>        2142:  <span style="background-color: red"> 99+          return 0;</span><br>        2143:  <span style="background-color: white">          }</span><br>        2144:  <span style="background-color: white">      </span><br>        2145:  <span style="background-color: red"> 99+      public boolean isCurrentBreakAtLineContext(LayoutContext c) {</span><br>        2146:  <span style="background-color: red"> 99+          BreakAtLineContext bContext = c.getBreakAtLineContext();</span><br>        2147:  <span style="background-color: red"> 99+          return bContext != null &amp;&amp; bContext.getBlock() == this;</span><br>        2148:  <span style="background-color: white">          }</span><br>        2149:  <span style="background-color: white">      </span><br>        2150:  <span style="background-color: red"> 99+      public BreakAtLineContext calcBreakAtLineContext(LayoutContext c) {</span><br>        2151:  <span style="background-color: red"> 99+          if (! c.isPrint() || ! getStyle().isKeepWithInline()) {</span><br>        2152:  <span style="background-color: red"> 99+              return null;</span><br>        2153:  <span style="background-color: white">              }</span><br>        2154:  <span style="background-color: white">      </span><br>        2155:  <span style="background-color: white">  30          LineBox breakLine = findLastNthLineBox((int)getStyle().asFloat(CSSName.WIDOWS));</span><br>        2156:  <span style="background-color: white">  30          if (breakLine != null) {</span><br>        2157:  <span style="background-color: white">  30              PageBox linePage = c.getRootLayer().getLastPage(c, breakLine);</span><br>        2158:  <span style="background-color: white">  30              PageBox ourPage = c.getRootLayer().getLastPage(c, this);</span><br>        2159:  <span style="background-color: white">  30              if (linePage != null &amp;&amp; ourPage != null &amp;&amp; linePage.getPageNo() + 1 == ourPage.getPageNo()) {</span><br>        2160:  <span style="background-color: white">   0                  BlockBox breakBox = (BlockBox)breakLine.getParent();</span><br>        2161:  <span style="background-color: white">   0                  return new BreakAtLineContext(breakBox, breakBox.findOffset(breakLine));</span><br>        2162:  <span style="background-color: white">                  }</span><br>        2163:  <span style="background-color: white">              }</span><br>        2164:  <span style="background-color: white">      </span><br>        2165:  <span style="background-color: white">  30          return null;</span><br>        2166:  <span style="background-color: white">          }</span><br>        2167:  <span style="background-color: white">      </span><br>        2168:  <span style="background-color: red"> 99+      public int calcInlineBaseline(CssContext c) {</span><br>        2169:  <span style="background-color: white"> 99+          if (isReplaced() &amp;&amp; getReplacedElement().hasBaseline()) {</span><br>        2170:  <span style="background-color: white">   0              Rectangle bounds = getContentAreaEdge(getAbsX(), getAbsY(), c);</span><br>        2171:  <span style="background-color: white">   0              return bounds.y + getReplacedElement().getBaseline() - getAbsY();</span><br>        2172:  <span style="background-color: white">              } else {</span><br>        2173:  <span style="background-color: red"> 99+              LineBox lastLine = findLastLineBox();</span><br>        2174:  <span style="background-color: red"> 99+              if (lastLine == null) {</span><br>        2175:  <span style="background-color: white"> 99+                  return getHeight();</span><br>        2176:  <span style="background-color: white">                  } else {</span><br>        2177:  <span style="background-color: red"> 99+                  return lastLine.getAbsY() + lastLine.getBaseline() - getAbsY();</span><br>        2178:  <span style="background-color: white">                  }</span><br>        2179:  <span style="background-color: white">              }</span><br>        2180:  <span style="background-color: white">          }</span><br>        2181:  <span style="background-color: white">      </span><br>        2182:  <span style="background-color: white">   0      public int findOffset(Box box) {</span><br>        2183:  <span style="background-color: white">   0          int ccount = getChildCount();</span><br>        2184:  <span style="background-color: white">   0          for (int i = 0; i &lt; ccount; i++) {</span><br>        2185:  <span style="background-color: white">   0              if (getChild(i) == box) {</span><br>        2186:  <span style="background-color: white">   0                  return i;</span><br>        2187:  <span style="background-color: white">                  }</span><br>        2188:  <span style="background-color: white">              }</span><br>        2189:  <span style="background-color: white">   0          return -1;</span><br>        2190:  <span style="background-color: white">          }</span><br>        2191:  <span style="background-color: white">      </span><br>        2192:  <span style="background-color: white">  30      public LineBox findLastNthLineBox(int count) {</span><br>        2193:  <span style="background-color: white">  30          LastLineBoxContext context = new LastLineBoxContext(count);</span><br>        2194:  <span style="background-color: white">  30          findLastLineBox(context);</span><br>        2195:  <span style="background-color: white">  30          return context.line;</span><br>        2196:  <span style="background-color: white">          }</span><br>        2197:  <span style="background-color: white">      </span><br>        2198:  <span style="background-color: white">          private static class LastLineBoxContext {</span><br>        2199:  <span style="background-color: white">              public int current;</span><br>        2200:  <span style="background-color: white">              public LineBox line;</span><br>        2201:  <span style="background-color: white">      </span><br>        2202:  <span style="background-color: white">  30          public LastLineBoxContext(int i) {</span><br>        2203:  <span style="background-color: white">  30              this.current = i;</span><br>        2204:  <span style="background-color: white">              }</span><br>        2205:  <span style="background-color: white">          }</span><br>        2206:  <span style="background-color: white">      </span><br>        2207:  <span style="background-color: white"> 99+      private void findLastLineBox(LastLineBoxContext context) {</span><br>        2208:  <span style="background-color: yellow"> 99+          int type = getChildrenContentType();</span><br>        2209:  <span style="background-color: white"> 99+          int ccount = getChildCount();</span><br>        2210:  <span style="background-color: white"> 99+          if (ccount &gt; 0) {</span><br>        2211:  <span style="background-color: yellow"> 99+              if (type == CONTENT_INLINE) {</span><br>        2212:  <span style="background-color: white">  86                  for (int i = ccount - 1; i &gt;= 0; i--) {</span><br>        2213:  <span style="background-color: white">  60                      LineBox child = (LineBox) getChild(i);</span><br>        2214:  <span style="background-color: white">  60                      if (child.getHeight() &gt; 0) {</span><br>        2215:  <span style="background-color: white">  60                          context.line = child;</span><br>        2216:  <span style="background-color: white">  60                          if (--context.current == 0) {</span><br>        2217:  <span style="background-color: white">  30                              return;</span><br>        2218:  <span style="background-color: white">                              }</span><br>        2219:  <span style="background-color: white">                          }</span><br>        2220:  <span style="background-color: white">                      }</span><br>        2221:  <span style="background-color: yellow"> 99+              } else if (type == CONTENT_BLOCK) {</span><br>        2222:  <span style="background-color: white"> 99+                  for (int i = ccount - 1; i &gt;= 0; i--) {</span><br>        2223:  <span style="background-color: white"> 99+                      ((BlockBox) getChild(i)).findLastLineBox(context);</span><br>        2224:  <span style="background-color: white"> 99+                      if (context.current == 0) {</span><br>        2225:  <span style="background-color: white"> 99+                          break;</span><br>        2226:  <span style="background-color: white">                          }</span><br>        2227:  <span style="background-color: white">                      }</span><br>        2228:  <span style="background-color: white">                  }</span><br>        2229:  <span style="background-color: white">              }</span><br>        2230:  <span style="background-color: white">          }</span><br>        2231:  <span style="background-color: white">      </span><br>        2232:  <span style="background-color: red"> 99+      private LineBox findLastLineBox() {</span><br>        2233:  <span style="background-color: yellow"> 99+          int type = getChildrenContentType();</span><br>        2234:  <span style="background-color: red"> 99+          int ccount = getChildCount();</span><br>        2235:  <span style="background-color: red"> 99+          if (ccount &gt; 0) {</span><br>        2236:  <span style="background-color: yellow"> 99+              if (type == CONTENT_INLINE) {</span><br>        2237:  <span style="background-color: red"> 99+                  for (int i = ccount - 1; i &gt;= 0; i--) {</span><br>        2238:  <span style="background-color: red"> 99+                      LineBox result = (LineBox) getChild(i);</span><br>        2239:  <span style="background-color: red"> 99+                      if (result.getHeight() &gt; 0) {</span><br>        2240:  <span style="background-color: red"> 99+                          return result;</span><br>        2241:  <span style="background-color: white">                          }</span><br>        2242:  <span style="background-color: white">                      }</span><br>        2243:  <span style="background-color: yellow">   0              } else if (type == CONTENT_BLOCK) {</span><br>        2244:  <span style="background-color: white">   0                  for (int i = ccount - 1; i &gt;= 0; i--) {</span><br>        2245:  <span style="background-color: white">   0                      LineBox result = ((BlockBox) getChild(i)).findLastLineBox();</span><br>        2246:  <span style="background-color: white">   0                      if (result != null) {</span><br>        2247:  <span style="background-color: white">   0                          return result;</span><br>        2248:  <span style="background-color: white">                          }</span><br>        2249:  <span style="background-color: white">                      }</span><br>        2250:  <span style="background-color: white">                  }</span><br>        2251:  <span style="background-color: white">              }</span><br>        2252:  <span style="background-color: white">      </span><br>        2253:  <span style="background-color: red"> 99+          return null;</span><br>        2254:  <span style="background-color: white">          }</span><br>        2255:  <span style="background-color: white">      </span><br>        2256:  <span style="background-color: white"> 99+      private LineBox findFirstLineBox() {</span><br>        2257:  <span style="background-color: yellow"> 99+          int type = getChildrenContentType();</span><br>        2258:  <span style="background-color: white"> 99+          int ccount = getChildCount();</span><br>        2259:  <span style="background-color: white"> 99+          if (ccount &gt; 0) {</span><br>        2260:  <span style="background-color: yellow"> 99+              if (type == CONTENT_INLINE) {</span><br>        2261:  <span style="background-color: white">  30                  for (int i = 0; i &lt; ccount; i++) {</span><br>        2262:  <span style="background-color: white">  30                      LineBox result = (LineBox) getChild(i);</span><br>        2263:  <span style="background-color: white">  30                      if (result.getHeight() &gt; 0) {</span><br>        2264:  <span style="background-color: white">  30                          return result;</span><br>        2265:  <span style="background-color: white">                          }</span><br>        2266:  <span style="background-color: white">                      }</span><br>        2267:  <span style="background-color: yellow">  94              } else if (type == CONTENT_BLOCK) {</span><br>        2268:  <span style="background-color: white">  94                  for (int i = 0; i &lt; ccount; i++) {</span><br>        2269:  <span style="background-color: white">  94                      LineBox result = ((BlockBox) getChild(i)).findFirstLineBox();</span><br>        2270:  <span style="background-color: white">  94                      if (result != null) {</span><br>        2271:  <span style="background-color: white">  94                          return result;</span><br>        2272:  <span style="background-color: white">                          }</span><br>        2273:  <span style="background-color: white">                      }</span><br>        2274:  <span style="background-color: white">                  }</span><br>        2275:  <span style="background-color: white">              }</span><br>        2276:  <span style="background-color: white">      </span><br>        2277:  <span style="background-color: white">   0          return null;</span><br>        2278:  <span style="background-color: white">          }</span><br>        2279:  <span style="background-color: white">      </span><br>        2280:  <span style="background-color: red"> 99+      public boolean isNeedsKeepWithInline(LayoutContext c) {</span><br>        2281:  <span style="background-color: red"> 99+          if (c.isPrint() &amp;&amp; getStyle().isKeepWithInline()) {</span><br>        2282:  <span style="background-color: white">  30              LineBox line = findFirstLineBox();</span><br>        2283:  <span style="background-color: white">  30              if (line != null) {</span><br>        2284:  <span style="background-color: white">  30                  PageBox linePage = c.getRootLayer().getFirstPage(c, line);</span><br>        2285:  <span style="background-color: white">  30                  PageBox ourPage = c.getRootLayer().getFirstPage(c, this);</span><br>        2286:  <span style="background-color: white">  30                  return linePage != null &amp;&amp; ourPage != null &amp;&amp; linePage.getPageNo() == ourPage.getPageNo()+1;</span><br>        2287:  <span style="background-color: white">                  }</span><br>        2288:  <span style="background-color: white">              }</span><br>        2289:  <span style="background-color: white">      </span><br>        2290:  <span style="background-color: red"> 99+          return false;</span><br>        2291:  <span style="background-color: white">          }</span><br>        2292:  <span style="background-color: white">      </span><br>        2293:  <span style="background-color: red"> 99+      public boolean isFloated() {</span><br>        2294:  <span style="background-color: red"> 99+          return _floatedBoxData != null;</span><br>        2295:  <span style="background-color: white">          }</span><br>        2296:  <span style="background-color: white">      </span><br>        2297:  <span style="background-color: red"> 99+      public FloatedBoxData getFloatedBoxData() {</span><br>        2298:  <span style="background-color: white"> 99+          return _floatedBoxData;</span><br>        2299:  <span style="background-color: white">          }</span><br>        2300:  <span style="background-color: white">      </span><br>        2301:  <span style="background-color: red"> 99+      public void setFloatedBoxData(FloatedBoxData floatedBoxData) {</span><br>        2302:  <span style="background-color: red"> 99+          _floatedBoxData = floatedBoxData;</span><br>        2303:  <span style="background-color: white">          }</span><br>        2304:  <span style="background-color: white">      </span><br>        2305:  <span style="background-color: red"> 99+      public int getChildrenHeight() {</span><br>        2306:  <span style="background-color: white"> 99+          return _childrenHeight;</span><br>        2307:  <span style="background-color: white">          }</span><br>        2308:  <span style="background-color: white">      </span><br>        2309:  <span style="background-color: red"> 99+      protected void setChildrenHeight(int childrenHeight) {</span><br>        2310:  <span style="background-color: red"> 99+          _childrenHeight = childrenHeight;</span><br>        2311:  <span style="background-color: white">          }</span><br>        2312:  <span style="background-color: white">      </span><br>        2313:  <span style="background-color: red"> 99+      public boolean isFromCaptionedTable() {</span><br>        2314:  <span style="background-color: white"> 99+          return _fromCaptionedTable;</span><br>        2315:  <span style="background-color: white">          }</span><br>        2316:  <span style="background-color: white">      </span><br>        2317:  <span style="background-color: red">   6      public void setFromCaptionedTable(boolean fromTable) {</span><br>        2318:  <span style="background-color: red">   6          _fromCaptionedTable = fromTable;</span><br>        2319:  <span style="background-color: white">          }</span><br>        2320:  <span style="background-color: white">      </span><br>        2321:  <span style="background-color: cyan">  61      protected boolean isInlineBlock() {</span><br>        2322:  <span style="background-color: white">  61          return isInline();</span><br>        2323:  <span style="background-color: white">          }</span><br>        2324:  <span style="background-color: white">      </span><br>        2325:  <span style="background-color: white">   0      public boolean isInMainFlow() {</span><br>        2326:  <span style="background-color: white">   0          Box flowRoot = rootBox();</span><br>        2327:  <span style="background-color: white">   0          return flowRoot.isRoot();</span><br>        2328:  <span style="background-color: white">          }</span><br>        2329:  <span style="background-color: white">      </span><br>        2330:  <span style="background-color: white">   0      @Override</span><br>        2331:  <span style="background-color: white">          public Box getDocumentParent() {</span><br>        2332:  <span style="background-color: white">   0          Box staticEquivalent = getStaticEquivalent();</span><br>        2333:  <span style="background-color: white">   0          if (staticEquivalent != null) {</span><br>        2334:  <span style="background-color: white">   0              return staticEquivalent;</span><br>        2335:  <span style="background-color: white">              } else {</span><br>        2336:  <span style="background-color: white">   0              return getParent();</span><br>        2337:  <span style="background-color: white">              }</span><br>        2338:  <span style="background-color: white">          }</span><br>        2339:  <span style="background-color: white">      </span><br>        2340:  <span style="background-color: white">   2      public boolean isContainsInlineContent(LayoutContext c) {</span><br>        2341:  <span style="background-color: white">   2          ensureChildren(c);</span><br>        2342:  <span style="background-color: white">   2          switch (getChildrenContentType()) {</span><br>        2343:  <span style="background-color: yellow">   0              case CONTENT_INLINE:</span><br>        2344:  <span style="background-color: white">   0                  return true;</span><br>        2345:  <span style="background-color: yellow">   1              case CONTENT_EMPTY:</span><br>        2346:  <span style="background-color: white">   1                  return false;</span><br>        2347:  <span style="background-color: yellow">   1              case CONTENT_BLOCK:</span><br>        2348:  <span style="background-color: white">   1                  return getChildren().stream().anyMatch(box -&gt; ((BlockBox) box).isContainsInlineContent(c));</span><br>        2349:  <span style="background-color: white">              }</span><br>        2350:  <span style="background-color: white">      </span><br>        2351:  <span style="background-color: yellow">   0          throw new RuntimeException("internal error: no children");</span><br>        2352:  <span style="background-color: white">          }</span><br>        2353:  <span style="background-color: white">      </span><br>        2354:  <span style="background-color: red"> 99+      public boolean checkPageContext(LayoutContext c) {</span><br>        2355:  <span style="background-color: red"> 99+          if (! getStyle().isIdent(CSSName.PAGE, IdentValue.AUTO)) {</span><br>        2356:  <span style="background-color: white">   2              String pageName = getStyle().getStringProperty(CSSName.PAGE);</span><br>        2357:  <span style="background-color: white">   2              if (!pageName.equals(c.getPageName()) &amp;&amp; </span><br>        2358:  <span style="background-color: white">                      isInDocumentFlow() &amp;&amp;</span><br>        2359:  <span style="background-color: white">                      (shouldBeReplaced() || isContainsInlineContent(c))) {</span><br>        2360:  <span style="background-color: white">   1                  c.setPendingPageName(pageName);</span><br>        2361:  <span style="background-color: white">   1                  return true;</span><br>        2362:  <span style="background-color: white">                  }</span><br>        2363:  <span style="background-color: red"> 99+          } else if (c.getPageName() != null &amp;&amp; isInDocumentFlow()) {</span><br>        2364:  <span style="background-color: white">   0              c.setPendingPageName(null);</span><br>        2365:  <span style="background-color: white">   0              return true;</span><br>        2366:  <span style="background-color: white">              }</span><br>        2367:  <span style="background-color: white">      </span><br>        2368:  <span style="background-color: red"> 99+          return false;</span><br>        2369:  <span style="background-color: white">          }</span><br>        2370:  <span style="background-color: white">      </span><br>        2371:  <span style="background-color: red"> 99+      public boolean isNeedsClipOnPaint(CssContext c) {</span><br>        2372:  <span style="background-color: white"> 99+          return ! isReplaced() &amp;&amp;</span><br>        2373:  <span style="background-color: white">                  getStyle().isIdent(CSSName.OVERFLOW, IdentValue.HIDDEN) &amp;&amp;</span><br>        2374:  <span style="background-color: white">                  getStyle().isOverflowApplies();</span><br>        2375:  <span style="background-color: white">          }</span><br>        2376:  <span style="background-color: white">      </span><br>        2377:  <span style="background-color: white">      </span><br>        2378:  <span style="background-color: white">   7      protected void propagateExtraSpace(</span><br>        2379:  <span style="background-color: white">                  LayoutContext c,</span><br>        2380:  <span style="background-color: white">                  ContentLimitContainer parentContainer, ContentLimitContainer currentContainer,</span><br>        2381:  <span style="background-color: white">                  int extraTop, int extraBottom) {</span><br>        2382:  <span style="background-color: white">   7          int start = currentContainer.getInitialPageNo();</span><br>        2383:  <span style="background-color: white">   7          int end = currentContainer.getLastPageNo();</span><br>        2384:  <span style="background-color: white">   7          int current = start;</span><br>        2385:  <span style="background-color: white">      </span><br>        2386:  <span style="background-color: white">  21          while (current &lt;= end) {</span><br>        2387:  <span style="background-color: white">  14              ContentLimit contentLimit =</span><br>        2388:  <span style="background-color: white">                      currentContainer.getContentLimit(current);</span><br>        2389:  <span style="background-color: white">      </span><br>        2390:  <span style="background-color: white">  14              if (current != start) {</span><br>        2391:  <span style="background-color: white">   7                  int top = contentLimit.getTop();</span><br>        2392:  <span style="background-color: white">   7                  if (top != ContentLimit.UNDEFINED) {</span><br>        2393:  <span style="background-color: white">   7                      parentContainer.updateTop(c, top - extraTop);</span><br>        2394:  <span style="background-color: white">                      }</span><br>        2395:  <span style="background-color: white">                  }</span><br>        2396:  <span style="background-color: white">      </span><br>        2397:  <span style="background-color: white">  14              if (current != end) {</span><br>        2398:  <span style="background-color: white">   7                  int bottom = contentLimit.getBottom();</span><br>        2399:  <span style="background-color: white">   7                  if (bottom != ContentLimit.UNDEFINED) {</span><br>        2400:  <span style="background-color: white">   7                      parentContainer.updateBottom(c, bottom + extraBottom);</span><br>        2401:  <span style="background-color: white">                      }</span><br>        2402:  <span style="background-color: white">                  }</span><br>        2403:  <span style="background-color: white">      </span><br>        2404:  <span style="background-color: white">  14              current++;</span><br>        2405:  <span style="background-color: white">              }</span><br>        2406:  <span style="background-color: white">          }</span><br>        2407:  <span style="background-color: white">      </span><br>        2408:  <span style="background-color: white">          public static class MarginCollapseResult {</span><br>        2409:  <span style="background-color: white">              private int maxPositive;</span><br>        2410:  <span style="background-color: white">              private int maxNegative;</span><br>        2411:  <span style="background-color: white">      </span><br>        2412:  <span style="background-color: red"> 99+          public void update(int value) {</span><br>        2413:  <span style="background-color: red"> 99+              if (value &lt; 0 &amp;&amp; value &lt; maxNegative) {</span><br>        2414:  <span style="background-color: white">   4                  maxNegative = value;</span><br>        2415:  <span style="background-color: white">                  }</span><br>        2416:  <span style="background-color: white">      </span><br>        2417:  <span style="background-color: red"> 99+              if (value &gt; 0 &amp;&amp; value &gt; maxPositive) {</span><br>        2418:  <span style="background-color: red"> 99+                  maxPositive = value;</span><br>        2419:  <span style="background-color: white">                  }</span><br>        2420:  <span style="background-color: white">              }</span><br>        2421:  <span style="background-color: white">      </span><br>        2422:  <span style="background-color: red"> 99+          public int getMargin() {</span><br>        2423:  <span style="background-color: white"> 99+              return maxPositive + maxNegative;</span><br>        2424:  <span style="background-color: white">              }</span><br>        2425:  <span style="background-color: white">      </span><br>        2426:  <span style="background-color: red"> 99+          public boolean hasMargin() {</span><br>        2427:  <span style="background-color: red"> 99+              return maxPositive != 0 || maxNegative != 0;</span><br>        2428:  <span style="background-color: white">              }</span><br>        2429:  <span style="background-color: white">          }</span><br>        2430:  <span style="background-color: white">      }</span><br>        2431:  <span style="background-color: white">      </span><br>        2432:  <span style="background-color: white">      /*</span><br>        2433:  <span style="background-color: white">       * $Id$</span><br>        2434:  <span style="background-color: white">       *</span><br>        2435:  <span style="background-color: white">       * $Log$</span><br>        2436:  <span style="background-color: white">       * Revision 1.102  2010/01/13 00:42:11  peterbrant</span><br>        2437:  <span style="background-color: white">       * Calculate clearance before possibly establishing new BFC.  It needs to be calculated relative to the existing BFC and not the new one.</span><br>        2438:  <span style="background-color: white">       *</span><br>        2439:  <span style="background-color: white">       * Revision 1.101  2010/01/12 14:33:27  peterbrant</span><br>        2440:  <span style="background-color: white">       * Ignore auto margins when calculating table min/max width.  Also, when deciding whether or not to proceed with the auto margin calculation for a table,  make sure we compare consistently with how the table min width is actually set.</span><br>        2441:  <span style="background-color: white">       *</span><br>        2442:  <span style="background-color: white">       * Revision 1.100  2009/11/08 23:52:48  peterbrant</span><br>        2443:  <span style="background-color: white">       * Treat percentage widths as auto when calculating min/max widths</span><br>        2444:  <span style="background-color: white">       *</span><br>        2445:  <span style="background-color: white">       * Revision 1.99  2008/12/14 19:20:05  peterbrant</span><br>        2446:  <span style="background-color: white">       * Skip running blocks when calculating min/max widths</span><br>        2447:  <span style="background-color: white">       *</span><br>        2448:  <span style="background-color: white">       * Revision 1.98  2008/12/14 13:53:31  peterbrant</span><br>        2449:  <span style="background-color: white">       * Implement -fs-keep-with-inline: keep property that instructs FS to try to avoid breaking a box so that only borders and padding appear on a page</span><br>        2450:  <span style="background-color: white">       *</span><br>        2451:  <span style="background-color: white">       * Revision 1.97  2008/09/06 18:21:50  peterbrant</span><br>        2452:  <span style="background-color: white">       * Need to account for list-marker-position: inside when calculating inline min/max widths</span><br>        2453:  <span style="background-color: white">       *</span><br>        2454:  <span style="background-color: white">       * Revision 1.96  2008/07/27 00:21:47  peterbrant</span><br>        2455:  <span style="background-color: white">       * Implement CMYK color support for PDF output, starting with patch from Mykola Gurov / Banish java.awt.Color from FS core layout classes</span><br>        2456:  <span style="background-color: white">       *</span><br>        2457:  <span style="background-color: white">       * Revision 1.95  2008/07/14 11:12:35  peterbrant</span><br>        2458:  <span style="background-color: white">       * Fix two bugs when -fs-table-paginate is paginate.  Block boxes in cells in a  that were also early on the page could be positioned incorrectly.  Line boxes contained within inline-block or inline-table content in a paginated table were generally placed incorrectly.</span><br>        2459:  <span style="background-color: white">       *</span><br>        2460:  <span style="background-color: white">       * Revision 1.94  2008/06/18 17:44:48  peterbrant</span><br>        2461:  <span style="background-color: white">       * Fix a pair of NPEs when absolutely positioned content is positioned off the page</span><br>        2462:  <span style="background-color: white">       *</span><br>        2463:  <span style="background-color: white">       * Revision 1.93  2008/05/24 16:36:22  peterbrant</span><br>        2464:  <span style="background-color: white">       * If our minimum width is greater than the calculated CSS width, don't try to allocate any margin space to auto margins.</span><br>        2465:  <span style="background-color: white">       *</span><br>        2466:  <span style="background-color: white">       * Revision 1.92  2007/10/15 22:33:44  peterbrant</span><br>        2467:  <span style="background-color: white">       * Only try to satisfy widows and orphans if page breaking is allowed</span><br>        2468:  <span style="background-color: white">       *</span><br>        2469:  <span style="background-color: white">       * Revision 1.91  2007/09/19 22:50:43  peterbrant</span><br>        2470:  <span style="background-color: white">       * Fix nested percentage height calculations (per report and test case from Simon Buettner)</span><br>        2471:  <span style="background-color: white">       *</span><br>        2472:  <span style="background-color: white">       * Revision 1.90  2007/08/29 22:18:17  peterbrant</span><br>        2473:  <span style="background-color: white">       * Experiment with text justification</span><br>        2474:  <span style="background-color: white">       *</span><br>        2475:  <span style="background-color: white">       * Revision 1.89  2007/08/28 22:31:26  peterbrant</span><br>        2476:  <span style="background-color: white">       * Implement widows and orphans properties</span><br>        2477:  <span style="background-color: white">       *</span><br>        2478:  <span style="background-color: white">       * Revision 1.88  2007/08/27 19:28:50  peterbrant</span><br>        2479:  <span style="background-color: white">       * Enable extra page clearance calculation</span><br>        2480:  <span style="background-color: white">       *</span><br>        2481:  <span style="background-color: white">       * Revision 1.87  2007/08/24 18:36:08  peterbrant</span><br>        2482:  <span style="background-color: white">       * Further progress on AcroForm support</span><br>        2483:  <span style="background-color: white">       *</span><br>        2484:  <span style="background-color: white">       * Revision 1.86  2007/08/23 20:52:31  peterbrant</span><br>        2485:  <span style="background-color: white">       * Begin work on AcroForm support</span><br>        2486:  <span style="background-color: white">       *</span><br>        2487:  <span style="background-color: white">       * Revision 1.85  2007/08/19 22:22:49  peterbrant</span><br>        2488:  <span style="background-color: white">       * Merge R8pbrant changes to HEAD</span><br>        2489:  <span style="background-color: white">       *</span><br>        2490:  <span style="background-color: white">       * Revision 1.84.2.13  2007/08/19 21:55:20  peterbrant</span><br>        2491:  <span style="background-color: white">       * Try to keep block boxes out of no man's land when paginating a table (commented out)</span><br>        2492:  <span style="background-color: white">       *</span><br>        2493:  <span style="background-color: white">       * Revision 1.84.2.12  2007/08/19 20:14:16  peterbrant</span><br>        2494:  <span style="background-color: white">       * Support nested paginated tables</span><br>        2495:  <span style="background-color: white">       *</span><br>        2496:  <span style="background-color: white">       * Revision 1.84.2.11  2007/08/17 23:53:32  peterbrant</span><br>        2497:  <span style="background-color: white">       * Get rid of layer hack for overflow: hidden</span><br>        2498:  <span style="background-color: white">       *</span><br>        2499:  <span style="background-color: white">       * Revision 1.84.2.10  2007/08/17 19:11:30  peterbrant</span><br>        2500:  <span style="background-color: white">       * When paginating a table, move table past page break if header would overlap the page break</span><br>        2501:  <span style="background-color: white">       *</span><br>        2502:  <span style="background-color: white">       * Revision 1.84.2.9  2007/08/17 17:11:00  peterbrant</span><br>        2503:  <span style="background-color: white">       * Try to avoid awkward row splits when paginating a table by making sure there is at least one line box on the same page as the start of the row</span><br>        2504:  <span style="background-color: white">       *</span><br>        2505:  <span style="background-color: white">       * Revision 1.84.2.8  2007/08/13 22:41:13  peterbrant</span><br>        2506:  <span style="background-color: white">       * First pass at exporting the render tree as text</span><br>        2507:  <span style="background-color: white">       *</span><br>        2508:  <span style="background-color: white">       * Revision 1.84.2.7  2007/08/09 20:18:15  peterbrant</span><br>        2509:  <span style="background-color: white">       * Bug fixes to improved pagination support</span><br>        2510:  <span style="background-color: white">       *</span><br>        2511:  <span style="background-color: white">       * Revision 1.84.2.6  2007/08/09 17:03:15  peterbrant</span><br>        2512:  <span style="background-color: white">       * Finish running block implementation</span><br>        2513:  <span style="background-color: white">       *</span><br>        2514:  <span style="background-color: white">       * Revision 1.84.2.5  2007/08/08 21:44:09  peterbrant</span><br>        2515:  <span style="background-color: white">       * Implement more flexible page numbering</span><br>        2516:  <span style="background-color: white">       *</span><br>        2517:  <span style="background-color: white">       * Revision 1.84.2.4  2007/08/08 18:28:25  peterbrant</span><br>        2518:  <span style="background-color: white">       * Further progress on CSS3 paged media</span><br>        2519:  <span style="background-color: white">       *</span><br>        2520:  <span style="background-color: white">       * Revision 1.84.2.3  2007/08/07 17:06:32  peterbrant</span><br>        2521:  <span style="background-color: white">       * Implement named pages / Implement page-break-before/after: left/right / Experiment with efficient selection</span><br>        2522:  <span style="background-color: white">       *</span><br>        2523:  <span style="background-color: white">       * Revision 1.84.2.2  2007/07/11 22:48:30  peterbrant</span><br>        2524:  <span style="background-color: white">       * Further progress on running headers and footers</span><br>        2525:  <span style="background-color: white">       *</span><br>        2526:  <span style="background-color: white">       * Revision 1.84.2.1  2007/07/09 22:18:03  peterbrant</span><br>        2527:  <span style="background-color: white">       * Begin work on running headers and footers and named pages</span><br>        2528:  <span style="background-color: white">       *</span><br>        2529:  <span style="background-color: white">       * Revision 1.84  2007/06/16 22:51:24  tobega</span><br>        2530:  <span style="background-color: white">       * We now support counters!</span><br>        2531:  <span style="background-color: white">       *</span><br>        2532:  <span style="background-color: white">       * Revision 1.83  2007/06/13 15:04:55  peterbrant</span><br>        2533:  <span style="background-color: white">       * Remove obsolete counter related code</span><br>        2534:  <span style="background-color: white">       *</span><br>        2535:  <span style="background-color: white">       * Revision 1.82  2007/06/07 16:56:29  peterbrant</span><br>        2536:  <span style="background-color: white">       * When vertically aligning table cell content, call layout again on cells as necessary to make sure pagination properties are respected at the cell's final position (and to make sure line boxes can't straddle page breaks).</span><br>        2537:  <span style="background-color: white">       *</span><br>        2538:  <span style="background-color: white">       * Revision 1.81  2007/06/05 19:29:53  peterbrant</span><br>        2539:  <span style="background-color: white">       * More progress on counter support</span><br>        2540:  <span style="background-color: white">       *</span><br>        2541:  <span style="background-color: white">       * Revision 1.80  2007/06/02 06:56:44  peterbrant</span><br>        2542:  <span style="background-color: white">       * Table page clearance should be taken into account when checking whether or not the top margin should be reset when a box is moved to a new page</span><br>        2543:  <span style="background-color: white">       *</span><br>        2544:  <span style="background-color: white">       * Revision 1.79  2007/04/25 18:09:41  peterbrant</span><br>        2545:  <span style="background-color: white">       * Always reset block box margin if it is the first thing on a page</span><br>        2546:  <span style="background-color: white">       *</span><br>        2547:  <span style="background-color: white">       * Revision 1.78  2007/04/23 21:13:16  peterbrant</span><br>        2548:  <span style="background-color: white">       * Calculate table cell height as if it included borders and padding (matches FF and Opera behavior)</span><br>        2549:  <span style="background-color: white">       *</span><br>        2550:  <span style="background-color: white">       * Revision 1.77  2007/04/16 01:10:05  peterbrant</span><br>        2551:  <span style="background-color: white">       * Vertical margin and padding with percentage values may be incorrect if box participated in a shrink-to-fit calculation.  Fix margin calculation.</span><br>        2552:  <span style="background-color: white">       *</span><br>        2553:  <span style="background-color: white">       * Revision 1.76  2007/04/15 00:34:40  peterbrant</span><br>        2554:  <span style="background-color: white">       * Allow inline-block / inline-table content to be relatively positioned</span><br>        2555:  <span style="background-color: white">       *</span><br>        2556:  <span style="background-color: white">       * Revision 1.75  2007/04/12 12:29:10  peterbrant</span><br>        2557:  <span style="background-color: white">       * Properly handle floated tables with captions</span><br>        2558:  <span style="background-color: white">       *</span><br>        2559:  <span style="background-color: white">       * Revision 1.74  2007/03/17 22:55:51  peterbrant</span><br>        2560:  <span style="background-color: white">       * Remove distinction between box IDs and named anchors</span><br>        2561:  <span style="background-color: white">       *</span><br>        2562:  <span style="background-color: white">       * Revision 1.73  2007/03/12 21:11:20  peterbrant</span><br>        2563:  <span style="background-color: white">       * Documentation update</span><br>        2564:  <span style="background-color: white">       *</span><br>        2565:  <span style="background-color: white">       * Revision 1.72  2007/03/08 01:41:50  peterbrant</span><br>        2566:  <span style="background-color: white">       * Don't calculate clearance for floated boxes (clear on floated boxes is handled directly by FloatManager) / Make sure we have a root layer before checking whether we have a fixed background or not</span><br>        2567:  <span style="background-color: white">       *</span><br>        2568:  <span style="background-color: white">       * Revision 1.71  2007/03/07 20:34:51  peterbrant</span><br>        2569:  <span style="background-color: white">       * Set a provisional content width on table cells when calulating min/max width to make sure percentage values in children resolve to something other than zero / Make sure style changes correctly account for text-transform</span><br>        2570:  <span style="background-color: white">       *</span><br>        2571:  <span style="background-color: white">       * Revision 1.70  2007/03/02 00:45:15  peterbrant</span><br>        2572:  <span style="background-color: white">       * Calculate baseline correctly for inline-block and inline-table elements</span><br>        2573:  <span style="background-color: white">       *</span><br>        2574:  <span style="background-color: white">       * Revision 1.69  2007/02/24 01:57:30  peterbrant</span><br>        2575:  <span style="background-color: white">       * toString() changes</span><br>        2576:  <span style="background-color: white">       *</span><br>        2577:  <span style="background-color: white">       * Revision 1.68  2007/02/23 15:50:37  peterbrant</span><br>        2578:  <span style="background-color: white">       * Fix incorrect absolute box positioning with print medium</span><br>        2579:  <span style="background-color: white">       *</span><br>        2580:  <span style="background-color: white">       * Revision 1.67  2007/02/22 18:21:19  peterbrant</span><br>        2581:  <span style="background-color: white">       * Add support for overflow: visible/hidden</span><br>        2582:  <span style="background-color: white">       *</span><br>        2583:  <span style="background-color: white">       * Revision 1.66  2007/02/22 16:10:54  peterbrant</span><br>        2584:  <span style="background-color: white">       * Remove unused API</span><br>        2585:  <span style="background-color: white">       *</span><br>        2586:  <span style="background-color: white">       * Revision 1.65  2007/02/22 15:30:42  peterbrant</span><br>        2587:  <span style="background-color: white">       * Internal links should be able to target block boxes too (plus other minor cleanup)</span><br>        2588:  <span style="background-color: white">       *</span><br>        2589:  <span style="background-color: white">       * Revision 1.64  2007/02/21 23:49:41  peterbrant</span><br>        2590:  <span style="background-color: white">       * Can't calculate clearance until margins have been collapsed / Clearance must be calculated relative to the box's border edge, not margin edge</span><br>        2591:  <span style="background-color: white">       *</span><br>        2592:  <span style="background-color: white">       * Revision 1.63  2007/02/21 21:47:26  peterbrant</span><br>        2593:  <span style="background-color: white">       * Implement (limited) support for collapsing through blocks with adjoining top and bottom margins /  should collapse with children</span><br>        2594:  <span style="background-color: white">       *</span><br>        2595:  <span style="background-color: white">       * Revision 1.62  2007/02/21 17:17:04  peterbrant</span><br>        2596:  <span style="background-color: white">       * Calculate position of next child and block height independently.  They may not</span><br>        2597:  <span style="background-color: white">       * move in lockstep in the face of negative vertical margins.</span><br>        2598:  <span style="background-color: white">       *</span><br>        2599:  <span style="background-color: white">       * Revision 1.61  2007/02/20 23:46:06  peterbrant</span><br>        2600:  <span style="background-color: white">       * Include pseudo element in toString()</span><br>        2601:  <span style="background-color: white">       *</span><br>        2602:  <span style="background-color: white">       * Revision 1.60  2007/02/11 23:10:59  peterbrant</span><br>        2603:  <span style="background-color: white">       * Make sure bounds information is calculated for fixed layers</span><br>        2604:  <span style="background-color: white">       *</span><br>        2605:  <span style="background-color: white">       * Revision 1.59  2007/02/07 16:33:25  peterbrant</span><br>        2606:  <span style="background-color: white">       * Initial commit of rewritten table support and associated refactorings</span><br>        2607:  <span style="background-color: white">       *</span><br>        2608:  <span style="background-color: white">       * Revision 1.58  2006/10/04 23:52:57  peterbrant</span><br>        2609:  <span style="background-color: white">       * Implement support for margin: auto (centering blocks in their containing block)</span><br>        2610:  <span style="background-color: white">       *</span><br>        2611:  <span style="background-color: white">       * Revision 1.57  2006/10/04 21:35:49  peterbrant</span><br>        2612:  <span style="background-color: white">       * Allow dimensions of absolutely positioned content to be specified with all four corners, not just one of left/right, top/bottom</span><br>        2613:  <span style="background-color: white">       *</span><br>        2614:  <span style="background-color: white">       * Revision 1.56  2006/10/04 19:49:08  peterbrant</span><br>        2615:  <span style="background-color: white">       * Improve calculation of available width when calculating shrink-to-fit width</span><br>        2616:  <span style="background-color: white">       *</span><br>        2617:  <span style="background-color: white">       * Revision 1.55  2006/09/08 15:41:58  peterbrant</span><br>        2618:  <span style="background-color: white">       * Calculate containing block width accurately when collapsing margins / Provide collapsed bottom</span><br>        2619:  <span style="background-color: white">       * margin to floats / Revive :first-line and :first-letter / Minor simplication in InlineBoxing</span><br>        2620:  <span style="background-color: white">       * (get rid of now-superfluous InlineBoxInfo)</span><br>        2621:  <span style="background-color: white">       *</span><br>        2622:  <span style="background-color: white">       * Revision 1.54  2006/09/07 16:24:50  peterbrant</span><br>        2623:  <span style="background-color: white">       * Need to calculate (preliminary) box dimensions when collapsing margins</span><br>        2624:  <span style="background-color: white">       *</span><br>        2625:  <span style="background-color: white">       * Revision 1.53  2006/09/06 22:42:30  peterbrant</span><br>        2626:  <span style="background-color: white">       * Implement min/max-height (non-replaced content only)</span><br>        2627:  <span style="background-color: white">       *</span><br>        2628:  <span style="background-color: white">       * Revision 1.52  2006/09/06 22:21:43  peterbrant</span><br>        2629:  <span style="background-color: white">       * Fixes to shrink-to-fit implementation / Implement min/max-width (non-replaced content) only</span><br>        2630:  <span style="background-color: white">       *</span><br>        2631:  <span style="background-color: white">       * Revision 1.51  2006/09/05 23:03:44  peterbrant</span><br>        2632:  <span style="background-color: white">       * Initial draft of shrink-to-fit support</span><br>        2633:  <span style="background-color: white">       *</span><br>        2634:  <span style="background-color: white">       * Revision 1.50  2006/09/01 23:49:38  peterbrant</span><br>        2635:  <span style="background-color: white">       * Implement basic margin collapsing / Various refactorings in preparation for shrink-to-fit / Add hack to treat auto margins as zero</span><br>        2636:  <span style="background-color: white">       *</span><br>        2637:  <span style="background-color: white">       * Revision 1.49  2006/08/30 18:25:41  peterbrant</span><br>        2638:  <span style="background-color: white">       * Further refactoring / Bug fix for problem reported by Mike Curtis</span><br>        2639:  <span style="background-color: white">       *</span><br>        2640:  <span style="background-color: white">       * Revision 1.48  2006/08/29 17:29:12  peterbrant</span><br>        2641:  <span style="background-color: white">       * Make Style object a thing of the past</span><br>        2642:  <span style="background-color: white">       *</span><br>        2643:  <span style="background-color: white">       * Revision 1.47  2006/08/27 01:16:20  peterbrant</span><br>        2644:  <span style="background-color: white">       * decimal-leading-zero patch from Thomas Palmer</span><br>        2645:  <span style="background-color: white">       *</span><br>        2646:  <span style="background-color: white">       * Revision 1.46  2006/08/27 01:15:00  peterbrant</span><br>        2647:  <span style="background-color: white">       * Revert makeTextMarker() change to commit with proper attribution</span><br>        2648:  <span style="background-color: white">       *</span><br>        2649:  <span style="background-color: white">       * Revision 1.45  2006/08/27 00:36:47  peterbrant</span><br>        2650:  <span style="background-color: white">       * Initial commit of (initial) R7 work</span><br>        2651:  <span style="background-color: white">       *</span><br>        2652:  <span style="background-color: white">       * Revision 1.44  2006/03/01 00:45:03  peterbrant</span><br>        2653:  <span style="background-color: white">       * Provide LayoutContext when calling detach() and friends</span><br>        2654:  <span style="background-color: white">       *</span><br>        2655:  <span style="background-color: white">       * Revision 1.43  2006/02/22 02:20:19  peterbrant</span><br>        2656:  <span style="background-color: white">       * Links and hover work again</span><br>        2657:  <span style="background-color: white">       *</span><br>        2658:  <span style="background-color: white">       * Revision 1.42  2006/02/21 20:55:45  peterbrant</span><br>        2659:  <span style="background-color: white">       * Handle image marker failover and list-style-type: none</span><br>        2660:  <span style="background-color: white">       *</span><br>        2661:  <span style="background-color: white">       * Revision 1.41  2006/02/21 20:41:15  peterbrant</span><br>        2662:  <span style="background-color: white">       * Default to decimal for text list markers</span><br>        2663:  <span style="background-color: white">       *</span><br>        2664:  <span style="background-color: white">       * Revision 1.40  2006/02/09 19:12:25  peterbrant</span><br>        2665:  <span style="background-color: white">       * Fix bad interaction between page-break-inside: avoid and top: auto/bottom: auto for absolute blocks</span><br>        2666:  <span style="background-color: white">       *</span><br>        2667:  <span style="background-color: white">       * Revision 1.39  2006/02/02 02:47:35  peterbrant</span><br>        2668:  <span style="background-color: white">       * Support non-AWT images</span><br>        2669:  <span style="background-color: white">       *</span><br>        2670:  <span style="background-color: white">       * Revision 1.38  2006/02/01 01:30:13  peterbrant</span><br>        2671:  <span style="background-color: white">       * Initial commit of PDF work</span><br>        2672:  <span style="background-color: white">       *</span><br>        2673:  <span style="background-color: white">       * Revision 1.37  2006/01/27 01:15:35  peterbrant</span><br>        2674:  <span style="background-color: white">       * Start on better support for different output devices</span><br>        2675:  <span style="background-color: white">       *</span><br>        2676:  <span style="background-color: white">       * Revision 1.36  2006/01/10 19:56:01  peterbrant</span><br>        2677:  <span style="background-color: white">       * Fix inappropriate box resizing when width: auto</span><br>        2678:  <span style="background-color: white">       *</span><br>        2679:  <span style="background-color: white">       * Revision 1.35  2006/01/03 23:52:40  peterbrant</span><br>        2680:  <span style="background-color: white">       * Remove unhelpful comment</span><br>        2681:  <span style="background-color: white">       *</span><br>        2682:  <span style="background-color: white">       * Revision 1.34  2006/01/03 17:04:50  peterbrant</span><br>        2683:  <span style="background-color: white">       * Many pagination bug fixes / Add ability to position absolute boxes in margin area</span><br>        2684:  <span style="background-color: white">       *</span><br>        2685:  <span style="background-color: white">       * Revision 1.33  2006/01/03 02:12:21  peterbrant</span><br>        2686:  <span style="background-color: white">       * Various pagination fixes / Fix fixed positioning</span><br>        2687:  <span style="background-color: white">       *</span><br>        2688:  <span style="background-color: white">       * Revision 1.32  2006/01/01 02:38:18  peterbrant</span><br>        2689:  <span style="background-color: white">       * Merge more pagination work / Various minor cleanups</span><br>        2690:  <span style="background-color: white">       *</span><br>        2691:  <span style="background-color: white">       * Revision 1.31  2005/12/30 01:32:39  peterbrant</span><br>        2692:  <span style="background-color: white">       * First merge of parts of pagination work</span><br>        2693:  <span style="background-color: white">       *</span><br>        2694:  <span style="background-color: white">       * Revision 1.30  2005/12/21 02:36:29  peterbrant</span><br>        2695:  <span style="background-color: white">       * - Calculate absolute positions incrementally (prep work for pagination)</span><br>        2696:  <span style="background-color: white">       * - Light cleanup</span><br>        2697:  <span style="background-color: white">       * - Fix bug where floats nested in floats could cause the outer float to be positioned in the wrong place</span><br>        2698:  <span style="background-color: white">       *</span><br>        2699:  <span style="background-color: white">       * Revision 1.29  2005/12/17 02:24:14  peterbrant</span><br>        2700:  <span style="background-color: white">       * Remove last pieces of old (now non-working) clip region checking / Push down handful of fields from Box to BlockBox</span><br>        2701:  <span style="background-color: white">       *</span><br>        2702:  <span style="background-color: white">       * Revision 1.28  2005/12/15 20:04:48  peterbrant</span><br>        2703:  <span style="background-color: white">       * Implement visibility: hidden</span><br>        2704:  <span style="background-color: white">       *</span><br>        2705:  <span style="background-color: white">       * Revision 1.27  2005/12/13 20:46:06  peterbrant</span><br>        2706:  <span style="background-color: white">       * Improve list support (implement list-style-position: inside, marker "sticks" to first line box even if there are other block boxes in between, plus other minor fixes) / Experimental support for optionally extending text decorations to box edge vs line edge</span><br>        2707:  <span style="background-color: white">       *</span><br>        2708:  <span style="background-color: white">       * Revision 1.26  2005/12/13 02:41:33  peterbrant</span><br>        2709:  <span style="background-color: white">       * Initial implementation of vertical-align: top/bottom (not done yet) / Minor cleanup and optimization</span><br>        2710:  <span style="background-color: white">       *</span><br>        2711:  <span style="background-color: white">       * Revision 1.25  2005/12/09 21:41:20  peterbrant</span><br>        2712:  <span style="background-color: white">       * Finish support for relative inline layers</span><br>        2713:  <span style="background-color: white">       *</span><br>        2714:  <span style="background-color: white">       * Revision 1.24  2005/12/09 01:24:56  peterbrant</span><br>        2715:  <span style="background-color: white">       * Initial commit of relative inline layers</span><br>        2716:  <span style="background-color: white">       *</span><br>        2717:  <span style="background-color: white">       * Revision 1.23  2005/12/05 00:13:53  peterbrant</span><br>        2718:  <span style="background-color: white">       * Improve list-item support (marker positioning is now correct) / Start support for relative inline layers</span><br>        2719:  <span style="background-color: white">       *</span><br>        2720:  <span style="background-color: white">       * Revision 1.22  2005/11/25 22:38:39  peterbrant</span><br>        2721:  <span style="background-color: white">       * Clean imports</span><br>        2722:  <span style="background-color: white">       *</span><br>        2723:  <span style="background-color: white">       * Revision 1.21  2005/11/25 16:57:19  peterbrant</span><br>        2724:  <span style="background-color: white">       * Initial commit of inline content refactoring</span><br>        2725:  <span style="background-color: white">       *</span><br>        2726:  <span style="background-color: white">       * Revision 1.20  2005/11/12 21:55:27  tobega</span><br>        2727:  <span style="background-color: white">       * Inline enhancements: block box text decorations, correct line-height when it is a number, better first-letter handling</span><br>        2728:  <span style="background-color: white">       *</span><br>        2729:  <span style="background-color: white">       * Revision 1.19  2005/11/08 22:53:46  tobega</span><br>        2730:  <span style="background-color: white">       * added getLineHeight method to CalculatedStyle and hacked in some list-item support</span><br>        2731:  <span style="background-color: white">       *</span><br>        2732:  <span style="background-color: white">       * Revision 1.18  2005/11/08 20:03:57  peterbrant</span><br>        2733:  <span style="background-color: white">       * Further progress on painting order / improved positioning implementation</span><br>        2734:  <span style="background-color: white">       *</span><br>        2735:  <span style="background-color: white">       * Revision 1.17  2005/11/05 18:45:06  peterbrant</span><br>        2736:  <span style="background-color: white">       * General cleanup / Remove obsolete code</span><br>        2737:  <span style="background-color: white">       *</span><br>        2738:  <span style="background-color: white">       * Revision 1.16  2005/10/27 00:09:02  tobega</span><br>        2739:  <span style="background-color: white">       * Sorted out Context into RenderingContext and LayoutContext</span><br>        2740:  <span style="background-color: white">       *</span><br>        2741:  <span style="background-color: white">       * Revision 1.15  2005/10/21 13:17:15  pdoubleya</span><br>        2742:  <span style="background-color: white">       * Rename some methods in RectPropertySet, cleanup.</span><br>        2743:  <span style="background-color: white">       *</span><br>        2744:  <span style="background-color: white">       * Revision 1.14  2005/10/21 12:01:20  pdoubleya</span><br>        2745:  <span style="background-color: white">       * Added cachable rect property for margin, cleanup minor in styling.</span><br>        2746:  <span style="background-color: white">       *</span><br>        2747:  <span style="background-color: white">       * Revision 1.13  2005/10/21 05:52:10  tobega</span><br>        2748:  <span style="background-color: white">       * A little more experimenting with flattened render tree</span><br>        2749:  <span style="background-color: white">       *</span><br>        2750:  <span style="background-color: white">       * Revision 1.12  2005/10/18 20:57:04  tobega</span><br>        2751:  <span style="background-color: white">       * Patch from Peter Brant</span><br>        2752:  <span style="background-color: white">       *</span><br>        2753:  <span style="background-color: white">       * Revision 1.11  2005/10/16 23:57:16  tobega</span><br>        2754:  <span style="background-color: white">       * Starting experiment with flat representation of render tree</span><br>        2755:  <span style="background-color: white">       *</span><br>        2756:  <span style="background-color: white">       * Revision 1.10  2005/10/06 03:20:22  tobega</span><br>        2757:  <span style="background-color: white">       * Prettier incremental rendering. Ran into more trouble than expected and some creepy crawlies and a few pages don't look right (forms.xhtml, splash.xhtml)</span><br>        2758:  <span style="background-color: white">       *</span><br>        2759:  <span style="background-color: white">       * Revision 1.9  2005/10/02 21:29:59  tobega</span><br>        2760:  <span style="background-color: white">       * Fixed a lot of concurrency (and other) issues from incremental rendering. Also some house-cleaning.</span><br>        2761:  <span style="background-color: white">       *</span><br>        2762:  <span style="background-color: white">       * Revision 1.8  2005/09/26 22:40:20  tobega</span><br>        2763:  <span style="background-color: white">       * Applied patch from Peter Brant concerning margin collapsing</span><br>        2764:  <span style="background-color: white">       *</span><br>        2765:  <span style="background-color: white">       * Revision 1.7  2005/01/29 20:24:23  pdoubleya</span><br>        2766:  <span style="background-color: white">       * Clean/reformat code. Removed commented blocks, checked copyright.</span><br>        2767:  <span style="background-color: white">       *</span><br>        2768:  <span style="background-color: white">       * Revision 1.6  2004/12/16 15:53:10  joshy</span><br>        2769:  <span style="background-color: white">       * fixes for absolute layout</span><br>        2770:  <span style="background-color: white">       *</span><br>        2771:  <span style="background-color: white">       * Issue number:</span><br>        2772:  <span style="background-color: white">       * Obtained from:</span><br>        2773:  <span style="background-color: white">       * Submitted by:</span><br>        2774:  <span style="background-color: white">       * Reviewed by:</span><br>        2775:  <span style="background-color: white">       *</span><br>        2776:  <span style="background-color: white">       * Revision 1.5  2004/12/11 23:36:49  tobega</span><br>        2777:  <span style="background-color: white">       * Progressing on cleaning up layout and boxes. Still broken, won't even compile at the moment. Working hard to fix it, though.</span><br>        2778:  <span style="background-color: white">       *</span><br>        2779:  <span style="background-color: white">       * Revision 1.4  2004/12/01 01:57:02  joshy</span><br>        2780:  <span style="background-color: white">       * more updates for float support.</span><br>        2781:  <span style="background-color: white">       *</span><br>        2782:  <span style="background-color: white">       * Issue number:</span><br>        2783:  <span style="background-color: white">       * Obtained from:</span><br>        2784:  <span style="background-color: white">       * Submitted by:</span><br>        2785:  <span style="background-color: white">       * Reviewed by:</span><br>        2786:  <span style="background-color: white">       *</span><br>        2787:  <span style="background-color: white">       * Revision 1.3  2004/11/18 16:45:12  joshy</span><br>        2788:  <span style="background-color: white">       * improved the float code a bit.</span><br>        2789:  <span style="background-color: white">       * now floats are automatically forced to be blocks</span><br>        2790:  <span style="background-color: white">       *</span><br>        2791:  <span style="background-color: white">       *</span><br>        2792:  <span style="background-color: white">       * Issue number:</span><br>        2793:  <span style="background-color: white">       * Obtained from:</span><br>        2794:  <span style="background-color: white">       * Submitted by:</span><br>        2795:  <span style="background-color: white">       * Reviewed by:</span><br>        2796:  <span style="background-color: white">       *</span><br>        2797:  <span style="background-color: white">       * Revision 1.2  2004/10/23 13:50:26  pdoubleya</span><br>        2798:  <span style="background-color: white">       * Re-formatted using JavaStyle tool.</span><br>        2799:  <span style="background-color: white">       * Cleaned imports to resolve wildcards except for common packages (java.io, java.util, etc).</span><br>        2800:  <span style="background-color: white">       * Added CVS log comments at bottom.</span><br>        2801:  <span style="background-color: white">       *</span><br>        2802:  <span style="background-color: white">       *</span><br>        2803:  <span style="background-color: white">       */</span><br>        2804:  <span style="background-color: white">      </span><br></pre> </code> 
   </div> 
   <div class="column"> 
    <h2>Patched Code:</h2> <code> <pre id="patched-trace">        1-&gt;N:  <span style="background-color: white">      /*</span><br>        2-&gt;N:  <span style="background-color: white">       * {{{ header &amp; license</span><br>        3-&gt;N:  <span style="background-color: white">       * Copyright (c) 2004, 2005 Joshua Marinacci</span><br>        4-&gt;N:  <span style="background-color: white">       * Copyright (c) 2006, 2007 Wisconsin Courts System</span><br>        5-&gt;N:  <span style="background-color: white">       *</span><br>        6-&gt;N:  <span style="background-color: white">       * This program is free software; you can redistribute it and/or</span><br>        7-&gt;N:  <span style="background-color: white">       * modify it under the terms of the GNU Lesser General Public License</span><br>        8-&gt;N:  <span style="background-color: white">       * as published by the Free Software Foundation; either version 2.1</span><br>        9-&gt;N:  <span style="background-color: white">       * of the License, or (at your option) any later version.</span><br>       10-&gt;N:  <span style="background-color: white">       *</span><br>       11-&gt;N:  <span style="background-color: white">       * This program is distributed in the hope that it will be useful,</span><br>       12-&gt;N:  <span style="background-color: white">       * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br>       13-&gt;N:  <span style="background-color: white">       * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span><br>       14-&gt;N:  <span style="background-color: white">       * GNU Lesser General Public License for more details.</span><br>       15-&gt;N:  <span style="background-color: white">       *</span><br>       16-&gt;N:  <span style="background-color: white">       * You should have received a copy of the GNU Lesser General Public License</span><br>       17-&gt;N:  <span style="background-color: white">       * along with this program; if not, write to the Free Software</span><br>       18-&gt;N:  <span style="background-color: white">       * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span><br>       19-&gt;N:  <span style="background-color: white">       * }}}</span><br>       20-&gt;N:  <span style="background-color: white">       */</span><br>       21-&gt;N:  <span style="background-color: white">      package com.openhtmltopdf.render;</span><br>       22-&gt;N:  <span style="background-color: white">      </span><br>       23-&gt;N:  <span style="background-color: white">      import java.awt.Point;</span><br>       24-&gt;N:  <span style="background-color: white">      import java.awt.Rectangle;</span><br>       25-&gt;N:  <span style="background-color: white">      import java.util.Iterator;</span><br>       26-&gt;N:  <span style="background-color: white">      import java.util.LinkedList;</span><br>       27-&gt;N:  <span style="background-color: white">      import java.util.List;</span><br>       28-&gt;N:  <span style="background-color: white">      </span><br>       29-&gt;N:  <span style="background-color: white">      import org.w3c.dom.Element;</span><br>       30-&gt;N:  <span style="background-color: white">      </span><br>       31-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.CSSName;</span><br>       32-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.IdentValue;</span><br>       33-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.CascadedStyle;</span><br>       34-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.FSRGBColor;</span><br>       35-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.CalculatedStyle;</span><br>       36-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.CssContext;</span><br>       37-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.FSDerivedValue;</span><br>       38-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.derived.BorderPropertySet;</span><br>       39-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.derived.LengthValue;</span><br>       40-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.derived.RectPropertySet;</span><br>       41-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.extend.FSImage;</span><br>       42-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.extend.ReplacedElement;</span><br>       43-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.BlockBoxing;</span><br>       44-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.BlockFormattingContext;</span><br>       45-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.BoxBuilder;</span><br>       46-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.BreakAtLineContext;</span><br>       47-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.CounterFunction;</span><br>       48-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.FloatManager;</span><br>       49-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.InlineBoxing;</span><br>       50-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.InlinePaintable;</span><br>       51-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.LayoutContext;</span><br>       52-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.PaintingInfo;</span><br>       53-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.PersistentBFC;</span><br>       54-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.Styleable;</span><br>       55-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableRowBox;</span><br>       56-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.ThreadCtx;</span><br>       57-&gt;N:  <span style="background-color: white">      </span><br>       58-&gt;N:  <span style="background-color: white">      /**</span><br>       59-&gt;N:  <span style="background-color: white">       * A block box as defined in the CSS spec.  It also provides a base class for</span><br>       60-&gt;N:  <span style="background-color: white">       * other kinds of block content (for example table rows or cells).</span><br>       61-&gt;N:  <span style="background-color: white">       * See {@link ContentType}</span><br>       62-&gt;N:  <span style="background-color: white">       */</span><br>      63-&gt;64:  <span style="background-color: white">      public class BlockBox extends Box implements InlinePaintable {</span><br>       64-&gt;N:  <span style="background-color: white">      </span><br>      65-&gt;66:  <span style="background-color: white">          public static final int POSITION_VERTICALLY = 1;</span><br>      66-&gt;67:  <span style="background-color: white">          public static final int POSITION_HORIZONTALLY = 2;</span><br>      67-&gt;68:  <span style="background-color: white">          public static final int POSITION_BOTH = POSITION_VERTICALLY | POSITION_HORIZONTALLY;</span><br>       68-&gt;N:  <span style="background-color: white">      </span><br>       69-&gt;N:  <span style="background-color: white">          /**</span><br>       70-&gt;N:  <span style="background-color: white">           * What type of direct child content this block box contains.</span><br>       71-&gt;N:  <span style="background-color: white">           * <br><br></span><br>       72-&gt;N:  <span style="background-color: white">           * NOTE: A {@link BlockBox} can only contain inline or block content (not both) as direct children.</span><br>       73-&gt;N:  <span style="background-color: white">           * If this constraint is not met by the original document, the {@link BoxBuilder}</span><br>       74-&gt;N:  <span style="background-color: white">           * will insert {@link AnonymousBlockBox} with inline content.</span><br>       75-&gt;N:  <span style="background-color: white">           */</span><br>       76-&gt;U:  <span style="background-color: yellow">          public static enum ContentType {</span><br>       77-&gt;U:  <span style="background-color: yellow">              /**</span><br>       78-&gt;U:  <span style="background-color: yellow">               * The box builder has not yet run to</span><br>       79-&gt;U:  <span style="background-color: yellow">               * create our child boxes. The box builder can be run</span><br>       80-&gt;U:  <span style="background-color: yellow">               * with {@link BlockBox#ensureChildren(LayoutContext)}.</span><br>       81-&gt;U:  <span style="background-color: yellow">               */</span><br>       82-&gt;U:  <span style="background-color: yellow">              UNKNOWN,</span><br>       83-&gt;U:  <span style="background-color: yellow">      </span><br>       84-&gt;U:  <span style="background-color: yellow">              /**</span><br>       85-&gt;U:  <span style="background-color: yellow">               * This block box contains inline content in the {@link BlockBox#getInlineContent()}</span><br>       86-&gt;U:  <span style="background-color: yellow">               * property. If it has also been laid out it will contain</span><br>       87-&gt;U:  <span style="background-color: yellow">               * children in {@link Box#getChildren()} and associated methods.</span><br>       88-&gt;U:  <span style="background-color: yellow">               * Children will be only {@link LineBox} objects.</span><br>       89-&gt;U:  <span style="background-color: yellow">               */</span><br>       90-&gt;U:  <span style="background-color: yellow">              INLINE,</span><br>       91-&gt;U:  <span style="background-color: yellow">      </span><br>       92-&gt;U:  <span style="background-color: yellow">              /**</span><br>       93-&gt;U:  <span style="background-color: yellow">               * This block box's direct children consist only of</span><br>       94-&gt;U:  <span style="background-color: yellow">               * {@link BlockBox} and subclassed objects.</span><br>       95-&gt;U:  <span style="background-color: yellow">               * The method {@link BlockBox#setInlineContent(List)} must not be used</span><br>       96-&gt;U:  <span style="background-color: yellow">               * with block content.</span><br>       97-&gt;U:  <span style="background-color: yellow">               */</span><br>       98-&gt;U:  <span style="background-color: yellow">              BLOCK,</span><br>       99-&gt;U:  <span style="background-color: yellow">      </span><br>      100-&gt;U:  <span style="background-color: yellow">              /**</span><br>      101-&gt;U:  <span style="background-color: yellow">               * This block box is empty but may still have border, etc.</span><br>      102-&gt;U:  <span style="background-color: yellow">               */</span><br>      103-&gt;U:  <span style="background-color: yellow">              EMPTY;</span><br>      104-&gt;U:  <span style="background-color: yellow">          }</span><br>      105-&gt;N:  <span style="background-color: white">      </span><br>     106-&gt;75:  <span style="background-color: white">          protected static final int NO_BASELINE = Integer.MIN_VALUE;</span><br>      107-&gt;N:  <span style="background-color: white">      </span><br>     108-&gt;77:  <span style="background-color: white">          private MarkerData _markerData;</span><br>      109-&gt;N:  <span style="background-color: white">      </span><br>     110-&gt;79:  <span style="background-color: white">          private int _listCounter;</span><br>      111-&gt;N:  <span style="background-color: white">      </span><br>     112-&gt;81:  <span style="background-color: white">          private PersistentBFC _persistentBFC;</span><br>      113-&gt;N:  <span style="background-color: white">      </span><br>     114-&gt;83:  <span style="background-color: white">          private Box _staticEquivalent;</span><br>      115-&gt;N:  <span style="background-color: white">      </span><br>     116-&gt;85:  <span style="background-color: white">          private boolean _needPageClear;</span><br>      117-&gt;N:  <span style="background-color: white">      </span><br>     118-&gt;87:  <span style="background-color: white">          private ReplacedElement _replacedElement;</span><br>      119-&gt;N:  <span style="background-color: white">      </span><br>      120-&gt;U:  <span style="background-color: yellow">          private ContentType _childrenContentType = ContentType.UNKNOWN;</span><br>      121-&gt;N:  <span style="background-color: white">      </span><br>     122-&gt;91:  <span style="background-color: white">          private List
       <styleable>
         _inlineContent;
       </styleable></span><br>      123-&gt;N:  <span style="background-color: white">      </span><br>     124-&gt;93:  <span style="background-color: white">          private boolean _topMarginCalculated;</span><br>     125-&gt;94:  <span style="background-color: white">          private boolean _bottomMarginCalculated;</span><br>     126-&gt;95:  <span style="background-color: white">          private MarginCollapseResult _pendingCollapseCalculation;</span><br>      127-&gt;N:  <span style="background-color: white">      </span><br>     128-&gt;97:  <span style="background-color: white">          private int _minWidth;</span><br>     129-&gt;98:  <span style="background-color: white">          private int _maxWidth;</span><br>     130-&gt;99:  <span style="background-color: white">          private boolean _minMaxCalculated;</span><br>      131-&gt;N:  <span style="background-color: white">      </span><br>    132-&gt;101:  <span style="background-color: white">          private boolean _dimensionsCalculated;</span><br>    133-&gt;102:  <span style="background-color: white">          private boolean _needShrinkToFitCalculatation;</span><br>      134-&gt;N:  <span style="background-color: white">      </span><br>    135-&gt;104:  <span style="background-color: white">          private CascadedStyle _firstLineStyle;</span><br>    136-&gt;105:  <span style="background-color: white">          private CascadedStyle _firstLetterStyle;</span><br>      137-&gt;N:  <span style="background-color: white">      </span><br>    138-&gt;107:  <span style="background-color: white">          private FloatedBoxData _floatedBoxData;</span><br>      139-&gt;N:  <span style="background-color: white">      </span><br>    140-&gt;109:  <span style="background-color: white">          private int _childrenHeight;</span><br>      141-&gt;N:  <span style="background-color: white">      </span><br>    142-&gt;111:  <span style="background-color: white">          private boolean _fromCaptionedTable;</span><br>      143-&gt;N:  <span style="background-color: white">      </span><br>    144-&gt;113:  <span style="background-color: white">          private boolean _isReplaced;</span><br>      145-&gt;N:  <span style="background-color: white">      </span><br>      146-&gt;N:  <span style="background-color: white"> 99+      public BlockBox() {</span><br>    147-&gt;116:  <span style="background-color: cyan"> 99+          super();</span><br>      148-&gt;N:  <span style="background-color: white">          }</span><br>      149-&gt;N:  <span style="background-color: white">          </span><br>    150-&gt;119:  <span style="background-color: cyan"> 99+      @Override</span><br>    151-&gt;120:  <span style="background-color: white">          public void setElement(Element element) {</span><br>    152-&gt;121:  <span style="background-color: cyan"> 99+      	super.setElement(element);</span><br>    153-&gt;122:  <span style="background-color: cyan"> 99+      	_isReplaced = ThreadCtx.get().sharedContext().getReplacedElementFactory().isReplacedElement(element);</span><br>      154-&gt;N:  <span style="background-color: white">          }</span><br>      155-&gt;N:  <span style="background-color: white">      </span><br>    156-&gt;125:  <span style="background-color: cyan"> 99+      public BlockBox copyOf() {</span><br>    157-&gt;126:  <span style="background-color: cyan"> 99+          BlockBox result = new BlockBox();</span><br>    158-&gt;127:  <span style="background-color: cyan"> 99+          result.setStyle(getStyle());</span><br>    159-&gt;128:  <span style="background-color: cyan"> 99+          result.setElement(getElement());</span><br>      160-&gt;N:  <span style="background-color: white">      </span><br>    161-&gt;130:  <span style="background-color: cyan"> 99+          return result;</span><br>      162-&gt;N:  <span style="background-color: white">          }</span><br>      163-&gt;N:  <span style="background-color: white">      </span><br>    164-&gt;133:  <span style="background-color: white">   0      protected String getExtraBoxDescription() {</span><br>    165-&gt;134:  <span style="background-color: white">   0          return "";</span><br>      166-&gt;N:  <span style="background-color: white">          }</span><br>      167-&gt;N:  <span style="background-color: white">      </span><br>      168-&gt;U:  <span style="background-color: yellow">   0      @Override</span><br>    169-&gt;137:  <span style="background-color: red">          public String toString() {</span><br>    170-&gt;138:  <span style="background-color: white">   0          StringBuilder result = new StringBuilder();</span><br>    171-&gt;139:  <span style="background-color: white">   0          String className = getClass().getName();</span><br>    172-&gt;140:  <span style="background-color: white">   0          result.append(className.substring(className.lastIndexOf('.') + 1));</span><br>    173-&gt;141:  <span style="background-color: white">   0          result.append(": ");</span><br>    174-&gt;142:  <span style="background-color: white">   0          if (getElement() != null &amp;&amp; ! isAnonymous()) {</span><br>    175-&gt;143:  <span style="background-color: white">   0              result.append("&lt;");</span><br>    176-&gt;144:  <span style="background-color: white">   0              result.append(getElement().getNodeName());</span><br>    177-&gt;145:  <span style="background-color: white">   0              result.append("&gt; ");</span><br>      178-&gt;N:  <span style="background-color: white">              }</span><br>      179-&gt;N:  <span style="background-color: white">   0          if (isAnonymous()) {</span><br>    180-&gt;148:  <span style="background-color: white">   0              result.append("(anonymous) ");</span><br>      181-&gt;N:  <span style="background-color: white">              }</span><br>    182-&gt;150:  <span style="background-color: white">   0          if (getPseudoElementOrClass() != null) {</span><br>    183-&gt;151:  <span style="background-color: white">   0              result.append(':');</span><br>    184-&gt;152:  <span style="background-color: white">   0              result.append(getPseudoElementOrClass());</span><br>    185-&gt;153:  <span style="background-color: white">   0              result.append(' ');</span><br>      186-&gt;N:  <span style="background-color: white">              }</span><br>    187-&gt;155:  <span style="background-color: white">   0          result.append('(');</span><br>    188-&gt;156:  <span style="background-color: white">   0          result.append(getStyle().getIdent(CSSName.DISPLAY).toString());</span><br>    189-&gt;157:  <span style="background-color: white">   0          result.append(") ");</span><br>      190-&gt;N:  <span style="background-color: white">      </span><br>      191-&gt;N:  <span style="background-color: white">   0          if (getStyle().isRunning()) {</span><br>    192-&gt;160:  <span style="background-color: white">   0              result.append("(running) ");</span><br>      193-&gt;N:  <span style="background-color: white">              }</span><br>      194-&gt;N:  <span style="background-color: white">      </span><br>    195-&gt;163:  <span style="background-color: white">   0          result.append('(');</span><br>      196-&gt;N:  <span style="background-color: white">   0          switch (getChildrenContentType()) {</span><br>      197-&gt;U:  <span style="background-color: yellow">   0              case BLOCK:</span><br>    198-&gt;166:  <span style="background-color: white">   0                  result.append('B');</span><br>    199-&gt;167:  <span style="background-color: white">   0                  break;</span><br>      200-&gt;U:  <span style="background-color: yellow">   0              case INLINE:</span><br>    201-&gt;169:  <span style="background-color: white">   0                  result.append('I');</span><br>    202-&gt;170:  <span style="background-color: white">   0                  break;</span><br>      203-&gt;U:  <span style="background-color: yellow">   0              case EMPTY:</span><br>    204-&gt;172:  <span style="background-color: white">   0                  result.append('E');</span><br>    205-&gt;173:  <span style="background-color: white">   0                  break;</span><br>      206-&gt;U:  <span style="background-color: yellow">   0              case UNKNOWN:</span><br>      207-&gt;U:  <span style="background-color: yellow">   0                  result.append('U');</span><br>      208-&gt;U:  <span style="background-color: yellow">   0                  break;</span><br>      209-&gt;U:  <span style="background-color: yellow">   0              default:</span><br>      210-&gt;U:  <span style="background-color: yellow">   0                  result.append('U');</span><br>      211-&gt;U:  <span style="background-color: yellow">   0                  break;</span><br>      212-&gt;N:  <span style="background-color: white">              }</span><br>    213-&gt;175:  <span style="background-color: white">   0          result.append(") ");</span><br>      214-&gt;N:  <span style="background-color: white">      </span><br>    215-&gt;177:  <span style="background-color: white">   0          result.append(getExtraBoxDescription());</span><br>      216-&gt;N:  <span style="background-color: white">      </span><br>    217-&gt;179:  <span style="background-color: white">   0          appendPositioningInfo(result);</span><br>    218-&gt;180:  <span style="background-color: white">   0          result.append("(" + getAbsX() + "," + getAbsY() + ")-&gt;(" + getWidth() + " x " + getHeight() + ")");</span><br>    219-&gt;181:  <span style="background-color: white">   0          return result.toString();</span><br>      220-&gt;N:  <span style="background-color: white">          }</span><br>      221-&gt;N:  <span style="background-color: white">      </span><br>    222-&gt;184:  <span style="background-color: white">   0      protected void appendPositioningInfo(StringBuilder result) {</span><br>      223-&gt;N:  <span style="background-color: white">   0          if (getStyle().isRelative()) {</span><br>    224-&gt;186:  <span style="background-color: white">   0              result.append("(relative) ");</span><br>      225-&gt;N:  <span style="background-color: white">              }</span><br>      226-&gt;N:  <span style="background-color: white">   0          if (getStyle().isFixed()) {</span><br>    227-&gt;189:  <span style="background-color: white">   0              result.append("(fixed) ");</span><br>      228-&gt;N:  <span style="background-color: white">              }</span><br>      229-&gt;N:  <span style="background-color: white">   0          if (getStyle().isAbsolute()) {</span><br>    230-&gt;192:  <span style="background-color: white">   0              result.append("(absolute) ");</span><br>      231-&gt;N:  <span style="background-color: white">              }</span><br>      232-&gt;N:  <span style="background-color: white">   0          if (getStyle().isFloated()) {</span><br>    233-&gt;195:  <span style="background-color: white">   0              result.append("(floated) ");</span><br>      234-&gt;N:  <span style="background-color: white">              }</span><br>      235-&gt;N:  <span style="background-color: white">          }</span><br>      236-&gt;N:  <span style="background-color: white">      </span><br>      237-&gt;U:  <span style="background-color: yellow">   0      @Override</span><br>    238-&gt;199:  <span style="background-color: red">          public String dump(LayoutContext c, String indent, int which) {</span><br>    239-&gt;200:  <span style="background-color: white">   0          StringBuilder result = new StringBuilder(indent);</span><br>      240-&gt;N:  <span style="background-color: white">      </span><br>    241-&gt;202:  <span style="background-color: white">   0          ensureChildren(c);</span><br>      242-&gt;N:  <span style="background-color: white">      </span><br>    243-&gt;204:  <span style="background-color: white">   0          result.append(this);</span><br>      244-&gt;U:  <span style="background-color: yellow">   0          result.append(getMargin(c).toString(" effMargin="));</span><br>      245-&gt;U:  <span style="background-color: yellow">   0          result.append(getStyleMargin(c).toString(" styleMargin="));</span><br>      246-&gt;N:  <span style="background-color: white">      </span><br>      247-&gt;U:  <span style="background-color: yellow">   0          if (getChildrenContentType() != ContentType.EMPTY) {</span><br>    248-&gt;214:  <span style="background-color: white">   0              result.append('\n');</span><br>      249-&gt;N:  <span style="background-color: white">              }</span><br>      250-&gt;N:  <span style="background-color: white">      </span><br>      251-&gt;N:  <span style="background-color: white">   0          switch (getChildrenContentType()) {</span><br>      252-&gt;U:  <span style="background-color: yellow">   0              case BLOCK:</span><br>    253-&gt;219:  <span style="background-color: white">   0                  dumpBoxes(c, indent, getChildren(), which, result);</span><br>    254-&gt;220:  <span style="background-color: white">   0                  break;</span><br>      255-&gt;N:  <span style="background-color: white">      </span><br>      256-&gt;U:  <span style="background-color: yellow">   0              case INLINE:</span><br>    257-&gt;222:  <span style="background-color: white">   0                  if (which == Box.DUMP_RENDER) {</span><br>    258-&gt;223:  <span style="background-color: white">   0                      dumpBoxes(c, indent, getChildren(), which, result);</span><br>      259-&gt;N:  <span style="background-color: white">                      } else {</span><br>    260-&gt;225:  <span style="background-color: white">   0                      for (Iterator
       <styleable>
         i = getInlineContent().iterator(); i.hasNext();) {
       </styleable></span><br>    261-&gt;226:  <span style="background-color: white">   0                          Styleable styleable = i.next();</span><br>      262-&gt;N:  <span style="background-color: white">      </span><br>    263-&gt;227:  <span style="background-color: white">   0                          if (styleable instanceof BlockBox) {</span><br>    264-&gt;228:  <span style="background-color: white">   0                              BlockBox b = (BlockBox) styleable;</span><br>    265-&gt;229:  <span style="background-color: white">   0                              result.append(b.dump(c, indent + "  ", which));</span><br>    266-&gt;230:  <span style="background-color: white">   0                              if (result.charAt(result.length() - 1) == '\n') {</span><br>    267-&gt;231:  <span style="background-color: white">   0                                  result.deleteCharAt(result.length() - 1);</span><br>      268-&gt;N:  <span style="background-color: white">                                  }</span><br>      269-&gt;N:  <span style="background-color: white">                              } else {</span><br>    270-&gt;234:  <span style="background-color: white">   0                              result.append(indent + "  ");</span><br>    271-&gt;235:  <span style="background-color: white">   0                              result.append(styleable.toString());</span><br>      272-&gt;N:  <span style="background-color: white">                              }</span><br>    273-&gt;237:  <span style="background-color: white">   0                          if (i.hasNext()) {</span><br>    274-&gt;238:  <span style="background-color: white">   0                              result.append('\n');</span><br>      275-&gt;N:  <span style="background-color: white">                              }</span><br>      276-&gt;N:  <span style="background-color: white">                          }</span><br>      277-&gt;N:  <span style="background-color: white">                      }</span><br>    278-&gt;242:  <span style="background-color: white">   0                  break;</span><br>      279-&gt;N:  <span style="background-color: white">      </span><br>      280-&gt;U:  <span style="background-color: yellow">   0              case EMPTY:</span><br>      281-&gt;U:  <span style="background-color: yellow">   0                  break;</span><br>      282-&gt;U:  <span style="background-color: yellow">   0              case UNKNOWN:</span><br>      283-&gt;U:  <span style="background-color: yellow">   0                  break;</span><br>      284-&gt;U:  <span style="background-color: yellow">   0              default:</span><br>      285-&gt;U:  <span style="background-color: yellow">   0                  break;</span><br>      286-&gt;N:  <span style="background-color: white">              }</span><br>      287-&gt;N:  <span style="background-color: white">      </span><br>    288-&gt;245:  <span style="background-color: white">   0          return result.toString();</span><br>      289-&gt;N:  <span style="background-color: white">          }</span><br>      290-&gt;N:  <span style="background-color: white">      </span><br>    291-&gt;248:  <span style="background-color: cyan"> 99+      public boolean isListItem() {</span><br>      292-&gt;N:  <span style="background-color: white"> 99+      	return getStyle().isListItem();</span><br>      293-&gt;N:  <span style="background-color: white">          }</span><br>      294-&gt;N:  <span style="background-color: white">      </span><br>    295-&gt;252:  <span style="background-color: red"> 99+      public void paintListMarker(RenderingContext c) {</span><br>    296-&gt;253:  <span style="background-color: red"> 99+          if (! getStyle().isVisible(c, this)) {</span><br>    297-&gt;254:  <span style="background-color: white">   0              return;</span><br>      298-&gt;N:  <span style="background-color: white">              }</span><br>      299-&gt;N:  <span style="background-color: white">      </span><br>      300-&gt;N:  <span style="background-color: white"> 99+          if (isListItem()) {</span><br>    301-&gt;258:  <span style="background-color: red"> 99+              ListItemPainter.paint(c, this);</span><br>      302-&gt;N:  <span style="background-color: white">              }</span><br>      303-&gt;N:  <span style="background-color: white">          }</span><br>      304-&gt;N:  <span style="background-color: white">      </span><br>      305-&gt;U:  <span style="background-color: yellow"> 99+      @Override</span><br>    306-&gt;262:  <span style="background-color: red">          public Rectangle getPaintingClipEdge(CssContext cssCtx) {</span><br>    307-&gt;263:  <span style="background-color: cyan"> 99+          Rectangle result = super.getPaintingClipEdge(cssCtx);</span><br>      308-&gt;N:  <span style="background-color: white">      </span><br>      309-&gt;N:  <span style="background-color: white">              // HACK Don't know how wide the list marker is (or even where it is)</span><br>      310-&gt;N:  <span style="background-color: white">              // so extend the bounding box all the way over to the left edge of</span><br>      311-&gt;N:  <span style="background-color: white">              // the canvas</span><br>      312-&gt;N:  <span style="background-color: white"> 99+          if (getStyle().isListItem()) {</span><br>    313-&gt;269:  <span style="background-color: white"> 99+              int delta = result.x;</span><br>    314-&gt;270:  <span style="background-color: white"> 99+              result.x = 0;</span><br>    315-&gt;271:  <span style="background-color: white"> 99+              result.width += delta;</span><br>      316-&gt;N:  <span style="background-color: white">              }</span><br>      317-&gt;N:  <span style="background-color: white">      </span><br>    318-&gt;274:  <span style="background-color: cyan"> 99+          return result;</span><br>      319-&gt;N:  <span style="background-color: white">          }</span><br>      320-&gt;N:  <span style="background-color: white">      </span><br>    321-&gt;277:  <span style="background-color: white">   0      @Override</span><br>    322-&gt;278:  <span style="background-color: white">          public void paintInline(RenderingContext c) {</span><br>    323-&gt;279:  <span style="background-color: white">   0          if (! getStyle().isVisible(c, this)) {</span><br>    324-&gt;280:  <span style="background-color: white">   0              return;</span><br>      325-&gt;N:  <span style="background-color: white">              }</span><br>      326-&gt;N:  <span style="background-color: white">      </span><br>    327-&gt;283:  <span style="background-color: white">   0          getContainingLayer().paintAsLayer(c, this);</span><br>      328-&gt;N:  <span style="background-color: white">          }</span><br>      329-&gt;N:  <span style="background-color: white">      </span><br>    330-&gt;286:  <span style="background-color: cyan"> 99+      public boolean isInline() {</span><br>    331-&gt;287:  <span style="background-color: cyan"> 99+          Box parent = getParent();</span><br>    332-&gt;288:  <span style="background-color: cyan"> 99+          return parent instanceof LineBox || parent instanceof InlineLayoutBox;</span><br>      333-&gt;N:  <span style="background-color: white">          }</span><br>      334-&gt;N:  <span style="background-color: white">      </span><br>    335-&gt;291:  <span style="background-color: cyan"> 99+      public LineBox getLineBox() {</span><br>      336-&gt;N:  <span style="background-color: white"> 99+          if (! isInline()) {</span><br>    337-&gt;293:  <span style="background-color: cyan"> 99+              return null;</span><br>      338-&gt;N:  <span style="background-color: white">              } else {</span><br>    339-&gt;295:  <span style="background-color: cyan"> 99+              return (LineBox) findAncestor(bx -&gt; bx instanceof LineBox);</span><br>      340-&gt;N:  <span style="background-color: white">              }</span><br>      341-&gt;N:  <span style="background-color: white">          }</span><br>      342-&gt;N:  <span style="background-color: white">      </span><br>    343-&gt;299:  <span style="background-color: white">   0      public void paintDebugOutline(RenderingContext c) {</span><br>    344-&gt;300:  <span style="background-color: white">   0          c.getOutputDevice().drawDebugOutline(c, this, FSRGBColor.RED);</span><br>      345-&gt;N:  <span style="background-color: white">          }</span><br>      346-&gt;N:  <span style="background-color: white">      </span><br>    347-&gt;303:  <span style="background-color: cyan"> 99+      public MarkerData getMarkerData() {</span><br>      348-&gt;N:  <span style="background-color: white"> 99+          return _markerData;</span><br>      349-&gt;N:  <span style="background-color: white">          }</span><br>      350-&gt;N:  <span style="background-color: white">      </span><br>    351-&gt;307:  <span style="background-color: white"> 99+      public void setMarkerData(MarkerData markerData) {</span><br>    352-&gt;308:  <span style="background-color: white"> 99+          _markerData = markerData;</span><br>      353-&gt;N:  <span style="background-color: white">          }</span><br>      354-&gt;N:  <span style="background-color: white">      </span><br>    355-&gt;311:  <span style="background-color: cyan"> 99+      public void createMarkerData(LayoutContext c) {</span><br>    356-&gt;312:  <span style="background-color: cyan"> 99+          if (getMarkerData() != null)</span><br>      357-&gt;N:  <span style="background-color: white">              {</span><br>    358-&gt;314:  <span style="background-color: cyan">   4              return;</span><br>      359-&gt;N:  <span style="background-color: white">              }</span><br>      360-&gt;N:  <span style="background-color: white">      </span><br>    361-&gt;317:  <span style="background-color: white"> 99+          StrutMetrics strutMetrics = InlineBoxing.createDefaultStrutMetrics(c, this);</span><br>      362-&gt;N:  <span style="background-color: white">      </span><br>    363-&gt;319:  <span style="background-color: white"> 99+          boolean imageMarker = false;</span><br>      364-&gt;N:  <span style="background-color: white">      </span><br>    365-&gt;321:  <span style="background-color: white"> 99+          MarkerData result = new MarkerData();</span><br>    366-&gt;322:  <span style="background-color: white"> 99+          result.setStructMetrics(strutMetrics);</span><br>      367-&gt;N:  <span style="background-color: white">      </span><br>    368-&gt;324:  <span style="background-color: white"> 99+          CalculatedStyle style = getStyle();</span><br>    369-&gt;325:  <span style="background-color: white"> 99+          IdentValue listStyle = style.getIdent(CSSName.LIST_STYLE_TYPE);</span><br>      370-&gt;N:  <span style="background-color: white">      </span><br>    371-&gt;327:  <span style="background-color: white"> 99+          String image = style.getStringProperty(CSSName.LIST_STYLE_IMAGE);</span><br>    372-&gt;328:  <span style="background-color: white"> 99+          if (! image.equals("none")) {</span><br>    373-&gt;329:  <span style="background-color: white">   0              result.setImageMarker(makeImageMarker(c, strutMetrics, image));</span><br>    374-&gt;330:  <span style="background-color: white">   0              imageMarker = result.getImageMarker() != null;</span><br>      375-&gt;N:  <span style="background-color: white">              }</span><br>      376-&gt;N:  <span style="background-color: white">      </span><br>    377-&gt;333:  <span style="background-color: white"> 99+          if (listStyle != IdentValue.NONE &amp;&amp; ! imageMarker) {</span><br>    378-&gt;334:  <span style="background-color: white"> 99+              if (listStyle == IdentValue.CIRCLE || listStyle == IdentValue.SQUARE ||</span><br>    379-&gt;335:  <span style="background-color: white">                          listStyle == IdentValue.DISC) {</span><br>    380-&gt;336:  <span style="background-color: white">  97                  result.setGlyphMarker(makeGlyphMarker(strutMetrics));</span><br>      381-&gt;N:  <span style="background-color: white">                  } else {</span><br>    382-&gt;338:  <span style="background-color: white">  50                  result.setTextMarker(makeTextMarker(c, listStyle));</span><br>      383-&gt;N:  <span style="background-color: white">                  }</span><br>      384-&gt;N:  <span style="background-color: white">              }</span><br>      385-&gt;N:  <span style="background-color: white">      </span><br>    386-&gt;342:  <span style="background-color: white"> 99+          setMarkerData(result);</span><br>      387-&gt;N:  <span style="background-color: white">          }</span><br>      388-&gt;N:  <span style="background-color: white">      </span><br>    389-&gt;345:  <span style="background-color: white">  97      private MarkerData.GlyphMarker makeGlyphMarker(StrutMetrics strutMetrics) {</span><br>    390-&gt;346:  <span style="background-color: white">  97          int diameter = (int) ((strutMetrics.getAscent() + strutMetrics.getDescent()) / 3);</span><br>      391-&gt;N:  <span style="background-color: white">      </span><br>    392-&gt;348:  <span style="background-color: white">  97          MarkerData.GlyphMarker result = new MarkerData.GlyphMarker();</span><br>    393-&gt;349:  <span style="background-color: white">  97          result.setDiameter(diameter);</span><br>    394-&gt;350:  <span style="background-color: white">  97          result.setLayoutWidth(diameter * 3);</span><br>      395-&gt;N:  <span style="background-color: white">      </span><br>    396-&gt;352:  <span style="background-color: white">  97          return result;</span><br>      397-&gt;N:  <span style="background-color: white">          }</span><br>      398-&gt;N:  <span style="background-color: white">      </span><br>      399-&gt;N:  <span style="background-color: white">      </span><br>    400-&gt;356:  <span style="background-color: white">   0      private MarkerData.ImageMarker makeImageMarker(</span><br>    401-&gt;357:  <span style="background-color: white">                  LayoutContext c, StrutMetrics structMetrics, String image) {</span><br>    402-&gt;358:  <span style="background-color: white">   0          FSImage img = null;</span><br>    403-&gt;359:  <span style="background-color: white">   0          if (! image.equals("none")) {</span><br>    404-&gt;360:  <span style="background-color: white">   0              img = c.getUac().getImageResource(image).getImage();</span><br>    405-&gt;361:  <span style="background-color: white">   0              if (img != null) {</span><br>    406-&gt;362:  <span style="background-color: white">   0                  StrutMetrics strutMetrics = structMetrics;</span><br>    407-&gt;363:  <span style="background-color: white">   0                  if (img.getHeight() &gt; strutMetrics.getAscent()) {</span><br>    408-&gt;364:  <span style="background-color: white">   0                      img.scale(-1, (int) strutMetrics.getAscent());</span><br>      409-&gt;N:  <span style="background-color: white">                      }</span><br>    410-&gt;366:  <span style="background-color: white">   0                  MarkerData.ImageMarker result = new MarkerData.ImageMarker();</span><br>    411-&gt;367:  <span style="background-color: white">   0                  result.setImage(img);</span><br>    412-&gt;368:  <span style="background-color: white">   0                  result.setLayoutWidth(img.getWidth() * 2);</span><br>    413-&gt;369:  <span style="background-color: white">   0                  return result;</span><br>      414-&gt;N:  <span style="background-color: white">                  }</span><br>      415-&gt;N:  <span style="background-color: white">              }</span><br>    416-&gt;372:  <span style="background-color: white">   0          return null;</span><br>      417-&gt;N:  <span style="background-color: white">          }</span><br>      418-&gt;N:  <span style="background-color: white">      </span><br>    419-&gt;375:  <span style="background-color: white">  50      private MarkerData.TextMarker makeTextMarker(LayoutContext c, IdentValue listStyle) {</span><br>    420-&gt;376:  <span style="background-color: white">  50          String text;</span><br>      421-&gt;N:  <span style="background-color: white">      </span><br>    422-&gt;378:  <span style="background-color: white">  50          int listCounter = getListCounter();</span><br>    423-&gt;379:  <span style="background-color: white">  50          text = CounterFunction.createCounterText(listStyle, listCounter);</span><br>      424-&gt;N:  <span style="background-color: white">      </span><br>    425-&gt;381:  <span style="background-color: white">  50          IdentValue listDirection = getParent().getStyle().getDirection();</span><br>      426-&gt;N:  <span style="background-color: white">      </span><br>    427-&gt;383:  <span style="background-color: white">  50          if (listDirection == IdentValue.RTL) {</span><br>    428-&gt;384:  <span style="background-color: white">  12              text = "  .".concat(text);</span><br>      429-&gt;N:  <span style="background-color: white">              } else {</span><br>    430-&gt;386:  <span style="background-color: white">  38              assert listDirection == IdentValue.LTR || listDirection == IdentValue.AUTO;</span><br>    431-&gt;387:  <span style="background-color: white">  38              text = text.concat(".  ");</span><br>      432-&gt;N:  <span style="background-color: white">              }</span><br>      433-&gt;N:  <span style="background-color: white">      </span><br>    434-&gt;390:  <span style="background-color: white">  50          int w = c.getTextRenderer().getWidth(</span><br>    435-&gt;391:  <span style="background-color: white">                      c.getFontContext(),</span><br>    436-&gt;392:  <span style="background-color: white">                      getStyle().getFSFont(c),</span><br>    437-&gt;393:  <span style="background-color: white">                      text);</span><br>      438-&gt;N:  <span style="background-color: white">      </span><br>    439-&gt;395:  <span style="background-color: white">  50          MarkerData.TextMarker result = new MarkerData.TextMarker();</span><br>      440-&gt;N:  <span style="background-color: white">      </span><br>    441-&gt;397:  <span style="background-color: white">  50          result.setLayoutWidth(w);</span><br>    442-&gt;398:  <span style="background-color: white">  50          result.setText(text);</span><br>      443-&gt;N:  <span style="background-color: white">      </span><br>    444-&gt;400:  <span style="background-color: white">  50          return result;</span><br>      445-&gt;N:  <span style="background-color: white">          }</span><br>      446-&gt;N:  <span style="background-color: white">      </span><br>    447-&gt;403:  <span style="background-color: white">  50      public int getListCounter() {</span><br>      448-&gt;N:  <span style="background-color: white">  50          return _listCounter;</span><br>      449-&gt;N:  <span style="background-color: white">          }</span><br>      450-&gt;N:  <span style="background-color: white">      </span><br>    451-&gt;407:  <span style="background-color: white"> 99+      public void setListCounter(int listCounter) {</span><br>    452-&gt;408:  <span style="background-color: white"> 99+          _listCounter = listCounter;</span><br>      453-&gt;N:  <span style="background-color: white">          }</span><br>      454-&gt;N:  <span style="background-color: white">      </span><br>    455-&gt;411:  <span style="background-color: red"> 99+      public PersistentBFC getPersistentBFC() {</span><br>      456-&gt;N:  <span style="background-color: white"> 99+          return _persistentBFC;</span><br>      457-&gt;N:  <span style="background-color: white">          }</span><br>      458-&gt;N:  <span style="background-color: white">      </span><br>    459-&gt;415:  <span style="background-color: red"> 99+      public void setPersistentBFC(PersistentBFC persistentBFC) {</span><br>    460-&gt;416:  <span style="background-color: red"> 99+          _persistentBFC = persistentBFC;</span><br>      461-&gt;N:  <span style="background-color: white">          }</span><br>      462-&gt;N:  <span style="background-color: white">      </span><br>    463-&gt;419:  <span style="background-color: cyan"> 99+      public Box getStaticEquivalent() {</span><br>      464-&gt;N:  <span style="background-color: white"> 99+          return _staticEquivalent;</span><br>      465-&gt;N:  <span style="background-color: white">          }</span><br>      466-&gt;N:  <span style="background-color: white">      </span><br>    467-&gt;423:  <span style="background-color: cyan"> 99+      public void setStaticEquivalent(Box staticEquivalent) {</span><br>    468-&gt;424:  <span style="background-color: cyan"> 99+          _staticEquivalent = staticEquivalent;</span><br>      469-&gt;N:  <span style="background-color: white">          }</span><br>      470-&gt;N:  <span style="background-color: white">      </span><br>    471-&gt;427:  <span style="background-color: cyan"> 99+      public boolean shouldBeReplaced() {</span><br>      472-&gt;N:  <span style="background-color: white"> 99+      	return _isReplaced;</span><br>      473-&gt;N:  <span style="background-color: white">          }</span><br>      474-&gt;N:  <span style="background-color: white">          </span><br>    475-&gt;431:  <span style="background-color: cyan"> 99+      public boolean isReplaced() {</span><br>    476-&gt;432:  <span style="background-color: cyan"> 99+          return _replacedElement != null;</span><br>      477-&gt;N:  <span style="background-color: white">          }</span><br>      478-&gt;N:  <span style="background-color: white">      </span><br>    479-&gt;435:  <span style="background-color: cyan"> 99+      @Override</span><br>    480-&gt;436:  <span style="background-color: white">          public void calcCanvasLocation() {</span><br>      481-&gt;N:  <span style="background-color: white"> 99+          if (isFloated()) {</span><br>    482-&gt;438:  <span style="background-color: cyan"> 99+              FloatManager manager = _floatedBoxData.getManager();</span><br>    483-&gt;439:  <span style="background-color: cyan"> 99+              if (manager != null) {</span><br>    484-&gt;440:  <span style="background-color: cyan"> 99+                  Point offset = manager.getOffset(this);</span><br>    485-&gt;441:  <span style="background-color: cyan"> 99+                  setAbsX(manager.getMaster().getAbsX() + getX() - offset.x);</span><br>    486-&gt;442:  <span style="background-color: cyan"> 99+                  setAbsY(manager.getMaster().getAbsY() + getY() - offset.y);</span><br>      487-&gt;N:  <span style="background-color: white">                  }</span><br>      488-&gt;N:  <span style="background-color: white">              }</span><br>      489-&gt;N:  <span style="background-color: white">      </span><br>    490-&gt;446:  <span style="background-color: cyan"> 99+          LineBox lineBox = getLineBox();</span><br>    491-&gt;447:  <span style="background-color: cyan"> 99+          if (lineBox == null) {</span><br>    492-&gt;448:  <span style="background-color: cyan"> 99+              Box parent = getParent();</span><br>    493-&gt;449:  <span style="background-color: cyan"> 99+              if (parent != null) {</span><br>    494-&gt;450:  <span style="background-color: cyan"> 99+                  setAbsX(parent.getAbsX() + parent.getTx() + getX());</span><br>    495-&gt;451:  <span style="background-color: cyan"> 99+                  setAbsY(parent.getAbsY() + parent.getTy() + getY());</span><br>      496-&gt;N:  <span style="background-color: white"> 99+              } else if (isStyled() &amp;&amp; getStyle().isAbsFixedOrInlineBlockEquiv()) {</span><br>    497-&gt;453:  <span style="background-color: cyan"> 99+                  Box cb = getContainingBlock();</span><br>    498-&gt;454:  <span style="background-color: cyan"> 99+                  if (cb != null) {</span><br>    499-&gt;455:  <span style="background-color: cyan"> 99+                      setAbsX(cb.getAbsX() + getX());</span><br>    500-&gt;456:  <span style="background-color: cyan"> 99+                      setAbsY(cb.getAbsY() + getY());</span><br>      501-&gt;N:  <span style="background-color: white">                      }</span><br>      502-&gt;N:  <span style="background-color: white">                  }</span><br>      503-&gt;N:  <span style="background-color: white">              } else {</span><br>    504-&gt;460:  <span style="background-color: cyan"> 99+              setAbsX(lineBox.getAbsX() + getX());</span><br>    505-&gt;461:  <span style="background-color: cyan"> 99+              setAbsY(lineBox.getAbsY() + getY());</span><br>      506-&gt;N:  <span style="background-color: white">              }</span><br>      507-&gt;N:  <span style="background-color: white">      </span><br>      508-&gt;N:  <span style="background-color: white"> 99+          if (isReplaced()) {</span><br>    509-&gt;465:  <span style="background-color: cyan"> 99+              Point location = getReplacedElement().getLocation();</span><br>    510-&gt;466:  <span style="background-color: cyan"> 99+              if (location.x != getAbsX() || location.y != getAbsY()) {</span><br>      511-&gt;N:  <span style="background-color: white"> 99+                  getReplacedElement().setLocation(getAbsX(), getAbsY());</span><br>      512-&gt;N:  <span style="background-color: white">                  }</span><br>      513-&gt;N:  <span style="background-color: white">              }</span><br>      514-&gt;N:  <span style="background-color: white">          }</span><br>      515-&gt;N:  <span style="background-color: white">      </span><br>    516-&gt;472:  <span style="background-color: cyan"> 99+      public void calcInitialFloatedCanvasLocation(LayoutContext c) {</span><br>    517-&gt;473:  <span style="background-color: cyan"> 99+          Point offset = c.getBlockFormattingContext().getOffset();</span><br>    518-&gt;474:  <span style="background-color: cyan"> 99+          FloatManager manager = c.getBlockFormattingContext().getFloatManager();</span><br>    519-&gt;475:  <span style="background-color: cyan"> 99+          setAbsX(manager.getMaster().getAbsX() + getX() - offset.x);</span><br>    520-&gt;476:  <span style="background-color: cyan"> 99+          setAbsY(manager.getMaster().getAbsY() + getY() - offset.y);</span><br>      521-&gt;N:  <span style="background-color: white">          }</span><br>      522-&gt;N:  <span style="background-color: white">      </span><br>    523-&gt;479:  <span style="background-color: cyan"> 99+      @Override</span><br>    524-&gt;480:  <span style="background-color: white">          public void calcChildLocations() {</span><br>    525-&gt;481:  <span style="background-color: cyan"> 99+          super.calcChildLocations();</span><br>      526-&gt;N:  <span style="background-color: white">      </span><br>    527-&gt;483:  <span style="background-color: cyan"> 99+          if (_persistentBFC != null) {</span><br>      528-&gt;N:  <span style="background-color: white"> 99+              _persistentBFC.getFloatManager().calcFloatLocations();</span><br>      529-&gt;N:  <span style="background-color: white">              }</span><br>      530-&gt;N:  <span style="background-color: white">          }</span><br>      531-&gt;N:  <span style="background-color: white">      </span><br>    532-&gt;488:  <span style="background-color: cyan"> 99+      public boolean isNeedPageClear() {</span><br>      533-&gt;N:  <span style="background-color: white"> 99+          return _needPageClear;</span><br>      534-&gt;N:  <span style="background-color: white">          }</span><br>      535-&gt;N:  <span style="background-color: white">      </span><br>    536-&gt;492:  <span style="background-color: cyan"> 99+      public void setNeedPageClear(boolean needPageClear) {</span><br>    537-&gt;493:  <span style="background-color: cyan"> 99+          _needPageClear = needPageClear;</span><br>      538-&gt;N:  <span style="background-color: white">          }</span><br>      539-&gt;N:  <span style="background-color: white">      </span><br>      540-&gt;N:  <span style="background-color: white">      </span><br>    541-&gt;497:  <span style="background-color: cyan">  61      private void alignToStaticEquivalent() {</span><br>      542-&gt;N:  <span style="background-color: white">  61          if (_staticEquivalent.getAbsY() != getAbsY()) {</span><br>      543-&gt;N:  <span style="background-color: white">   9              setY(_staticEquivalent.getAbsY() - getAbsY());</span><br>      544-&gt;N:  <span style="background-color: white">   9              setAbsY(_staticEquivalent.getAbsY());</span><br>      545-&gt;N:  <span style="background-color: white">              }</span><br>      546-&gt;N:  <span style="background-color: white">          }</span><br>      547-&gt;N:  <span style="background-color: white">      </span><br>    548-&gt;504:  <span style="background-color: cyan"> 99+      public void positionAbsolute(CssContext cssCtx, int direction) {</span><br>    549-&gt;505:  <span style="background-color: cyan"> 99+          CalculatedStyle style = getStyle();</span><br>      550-&gt;N:  <span style="background-color: white">      </span><br>    551-&gt;507:  <span style="background-color: cyan"> 99+          Rectangle boundingBox = null;</span><br>      552-&gt;N:  <span style="background-color: white">      </span><br>    553-&gt;509:  <span style="background-color: cyan"> 99+          int cbContentHeight = getContainingBlock().getContentAreaEdge(0, 0, cssCtx).height;</span><br>      554-&gt;N:  <span style="background-color: white">      </span><br>    555-&gt;511:  <span style="background-color: cyan"> 99+          if (getContainingBlock() instanceof BlockBox) {</span><br>    556-&gt;512:  <span style="background-color: cyan"> 99+              boundingBox = getContainingBlock().getPaddingEdge(0, 0, cssCtx);</span><br>      557-&gt;N:  <span style="background-color: white">              } else {</span><br>    558-&gt;514:  <span style="background-color: white">   0              boundingBox = getContainingBlock().getContentAreaEdge(0, 0, cssCtx);</span><br>      559-&gt;N:  <span style="background-color: white">              }</span><br>      560-&gt;N:  <span style="background-color: white">      </span><br>    561-&gt;517:  <span style="background-color: cyan"> 99+          if ((direction &amp; POSITION_HORIZONTALLY) != 0) {</span><br>    562-&gt;518:  <span style="background-color: cyan"> 99+              setX(0);</span><br>    563-&gt;519:  <span style="background-color: cyan"> 99+              if (!style.isIdent(CSSName.LEFT, IdentValue.AUTO)) {</span><br>    564-&gt;520:  <span style="background-color: cyan"> 99+                  setX((int) style.getFloatPropertyProportionalWidth(CSSName.LEFT, getContainingBlock().getContentWidth(), cssCtx));</span><br>    565-&gt;521:  <span style="background-color: cyan"> 99+              } else if (!style.isIdent(CSSName.RIGHT, IdentValue.AUTO)) {</span><br>    566-&gt;522:  <span style="background-color: white">  35                  setX(boundingBox.width -</span><br>    567-&gt;523:  <span style="background-color: white">                              (int) style.getFloatPropertyProportionalWidth(CSSName.RIGHT, getContainingBlock().getContentWidth(), cssCtx) - getWidth());</span><br>      568-&gt;N:  <span style="background-color: white">                  }</span><br>    569-&gt;525:  <span style="background-color: cyan"> 99+              setX(getX() + boundingBox.x);</span><br>      570-&gt;N:  <span style="background-color: white">              }</span><br>      571-&gt;N:  <span style="background-color: white">      </span><br>    572-&gt;528:  <span style="background-color: cyan"> 99+          if ((direction &amp; POSITION_VERTICALLY) != 0) {</span><br>    573-&gt;529:  <span style="background-color: cyan"> 99+              setY(0);</span><br>    574-&gt;530:  <span style="background-color: cyan"> 99+              if (!style.isIdent(CSSName.TOP, IdentValue.AUTO)) {</span><br>    575-&gt;531:  <span style="background-color: cyan"> 99+                  setY((int) style.getFloatPropertyProportionalHeight(CSSName.TOP, cbContentHeight, cssCtx));</span><br>    576-&gt;532:  <span style="background-color: cyan"> 99+              } else if (!style.isIdent(CSSName.BOTTOM, IdentValue.AUTO)) {</span><br>    577-&gt;533:  <span style="background-color: cyan">  51                  setY(boundingBox.height -</span><br>    578-&gt;534:  <span style="background-color: white">                              (int) style.getFloatPropertyProportionalWidth(CSSName.BOTTOM, cbContentHeight, cssCtx) - getHeight());</span><br>      579-&gt;N:  <span style="background-color: white">                  }</span><br>      580-&gt;N:  <span style="background-color: white">      </span><br>      581-&gt;N:  <span style="background-color: white">                  // Can't do this before now because our containing block</span><br>      582-&gt;N:  <span style="background-color: white">                  // must be completed layed out</span><br>    583-&gt;539:  <span style="background-color: cyan"> 99+              int pinnedHeight = calcPinnedHeight(cssCtx);</span><br>    584-&gt;540:  <span style="background-color: cyan"> 99+              if (pinnedHeight != -1 &amp;&amp; getCSSHeight(cssCtx) == -1) {</span><br>    585-&gt;541:  <span style="background-color: white">   0                  setHeight(pinnedHeight);</span><br>    586-&gt;542:  <span style="background-color: white">   0                  applyCSSMinMaxHeight(cssCtx);</span><br>      587-&gt;N:  <span style="background-color: white">                  }</span><br>      588-&gt;N:  <span style="background-color: white">      </span><br>    589-&gt;545:  <span style="background-color: cyan"> 99+              setY(getY() + boundingBox.y);</span><br>      590-&gt;N:  <span style="background-color: white">              }</span><br>      591-&gt;N:  <span style="background-color: white">      </span><br>      592-&gt;N:  <span style="background-color: white"> 99+          calcCanvasLocation();</span><br>      593-&gt;N:  <span style="background-color: white">      </span><br>    594-&gt;550:  <span style="background-color: cyan"> 99+          if ((direction &amp; POSITION_VERTICALLY) != 0 &amp;&amp;</span><br>      595-&gt;N:  <span style="background-color: white">                      getStyle().isTopAuto() &amp;&amp; getStyle().isBottomAuto()) {</span><br>      596-&gt;N:  <span style="background-color: white">  61              alignToStaticEquivalent();</span><br>      597-&gt;N:  <span style="background-color: white">              }</span><br>      598-&gt;N:  <span style="background-color: white">      </span><br>      599-&gt;N:  <span style="background-color: white"> 99+          calcChildLocations();</span><br>      600-&gt;N:  <span style="background-color: white">          }</span><br>      601-&gt;N:  <span style="background-color: white">      </span><br>      602-&gt;N:  <span style="background-color: white">      	/**</span><br>      603-&gt;N:  <span style="background-color: white">           * Using the css:</span><br>      604-&gt;N:  <span style="background-color: white">           *</span><br>      605-&gt;N:  <span style="background-color: white">           * -fs-page-break-min-height: 5cm;</span><br>      606-&gt;N:  <span style="background-color: white">           *</span><br>      607-&gt;N:  <span style="background-color: white">           * on a block element you can force a pagebreak before this block, if not</span><br>      608-&gt;N:  <span style="background-color: white">           * enough space (e.g. 5cm in this case) is remaining on the current page for the block.</span><br>      609-&gt;N:  <span style="background-color: white">           *</span><br>      610-&gt;N:  <span style="background-color: white">           * @return true if a pagebreak is needed before this block because</span><br>      611-&gt;N:  <span style="background-color: white">           * there is not enough space left on the current page.</span><br>      612-&gt;N:  <span style="background-color: white">           */</span><br>    613-&gt;569:  <span style="background-color: cyan"> 99+      public boolean isPageBreakNeededBecauseOfMinHeight(LayoutContext context){</span><br>    614-&gt;570:  <span style="background-color: cyan"> 99+          float minHeight = getStyle().getFSPageBreakMinHeight(context);</span><br>    615-&gt;571:  <span style="background-color: cyan"> 99+          PageBox page = context.getRootLayer().getFirstPage(context, this);</span><br>      616-&gt;U:  <span style="background-color: yellow"> 99+          return page != null &amp;&amp; getAbsY() + minHeight &gt; page.getBottom(context);</span><br>      617-&gt;N:  <span style="background-color: white">          }</span><br>      618-&gt;N:  <span style="background-color: white">      </span><br>      619-&gt;N:  <span style="background-color: white">      </span><br>    620-&gt;576:  <span style="background-color: cyan"> 99+      public void positionAbsoluteOnPage(LayoutContext c) {</span><br>    621-&gt;577:  <span style="background-color: cyan"> 99+          if (c.isPrint() &amp;&amp;</span><br>    622-&gt;578:  <span style="background-color: white">                      (getStyle().isForcePageBreakBefore() || isNeedPageClear() || isPageBreakNeededBecauseOfMinHeight(c))) {</span><br>    623-&gt;579:  <span style="background-color: cyan">   2              forcePageBreakBefore(c, getStyle().getIdent(CSSName.PAGE_BREAK_BEFORE), false);</span><br>      624-&gt;N:  <span style="background-color: white">   2              calcCanvasLocation();</span><br>      625-&gt;N:  <span style="background-color: white">   2              calcChildLocations();</span><br>      626-&gt;N:  <span style="background-color: white">      </span><br>    627-&gt;583:  <span style="background-color: cyan">   2              setNeedPageClear(false);</span><br>      628-&gt;N:  <span style="background-color: white">              }</span><br>      629-&gt;N:  <span style="background-color: white">          }</span><br>      630-&gt;N:  <span style="background-color: white">      </span><br>    631-&gt;587:  <span style="background-color: cyan"> 99+      public ReplacedElement getReplacedElement() {</span><br>      632-&gt;N:  <span style="background-color: white"> 99+          return _replacedElement;</span><br>      633-&gt;N:  <span style="background-color: white">          }</span><br>      634-&gt;N:  <span style="background-color: white">      </span><br>    635-&gt;591:  <span style="background-color: cyan"> 99+      public void setReplacedElement(ReplacedElement replacedElement) {</span><br>    636-&gt;592:  <span style="background-color: cyan"> 99+          _replacedElement = replacedElement;</span><br>      637-&gt;N:  <span style="background-color: white">          }</span><br>      638-&gt;N:  <span style="background-color: white">      </span><br>    639-&gt;595:  <span style="background-color: cyan"> 99+      @Override</span><br>    640-&gt;596:  <span style="background-color: white">          public void reset(LayoutContext c) {</span><br>    641-&gt;597:  <span style="background-color: cyan"> 99+          super.reset(c);</span><br>    642-&gt;598:  <span style="background-color: cyan"> 99+          setTopMarginCalculated(false);</span><br>    643-&gt;599:  <span style="background-color: cyan"> 99+          setBottomMarginCalculated(false);</span><br>    644-&gt;600:  <span style="background-color: cyan"> 99+          setDimensionsCalculated(false);</span><br>    645-&gt;601:  <span style="background-color: cyan"> 99+          setMinMaxCalculated(false);</span><br>    646-&gt;602:  <span style="background-color: cyan"> 99+          setChildrenHeight(0);</span><br>      647-&gt;N:  <span style="background-color: white"> 99+          if (isReplaced()) {</span><br>    648-&gt;604:  <span style="background-color: cyan">  45              getReplacedElement().detach(c);</span><br>    649-&gt;605:  <span style="background-color: cyan">  45              setReplacedElement(null);</span><br>      650-&gt;N:  <span style="background-color: white">              }</span><br>      651-&gt;U:  <span style="background-color: yellow"> 99+          if (getChildrenContentType() == ContentType.INLINE) {</span><br>      652-&gt;N:  <span style="background-color: white"> 99+              removeAllChildren();</span><br>      653-&gt;N:  <span style="background-color: white">              }</span><br>      654-&gt;N:  <span style="background-color: white">      </span><br>      655-&gt;N:  <span style="background-color: white"> 99+          if (isFloated()) {</span><br>      656-&gt;N:  <span style="background-color: white">  38              _floatedBoxData.getManager().removeFloat(this);</span><br>      657-&gt;N:  <span style="background-color: white">  38              _floatedBoxData.getDrawingLayer().removeFloat(this);</span><br>      658-&gt;N:  <span style="background-color: white">              }</span><br>      659-&gt;N:  <span style="background-color: white">      </span><br>      660-&gt;N:  <span style="background-color: white"> 99+          if (getStyle().isRunning()) {</span><br>    661-&gt;617:  <span style="background-color: white">   0              c.getRootLayer().removeRunningBlock(this);</span><br>      662-&gt;N:  <span style="background-color: white">              }</span><br>      663-&gt;N:  <span style="background-color: white">          }</span><br>      664-&gt;N:  <span style="background-color: white">      </span><br>    665-&gt;621:  <span style="background-color: cyan"> 99+      private int calcPinnedContentWidth(CssContext c) {</span><br>    666-&gt;622:  <span style="background-color: cyan"> 99+          if (! getStyle().isIdent(CSSName.LEFT, IdentValue.AUTO) &amp;&amp;</span><br>    667-&gt;623:  <span style="background-color: white">                      ! getStyle().isIdent(CSSName.RIGHT, IdentValue.AUTO)) {</span><br>    668-&gt;624:  <span style="background-color: cyan">  18              Rectangle paddingEdge = getContainingBlock().getPaddingEdge(0, 0, c);</span><br>      669-&gt;N:  <span style="background-color: white">      </span><br>    670-&gt;626:  <span style="background-color: cyan">  18              int left = (int) getStyle().getFloatPropertyProportionalTo(</span><br>    671-&gt;627:  <span style="background-color: white">                          CSSName.LEFT, paddingEdge.width, c);</span><br>    672-&gt;628:  <span style="background-color: cyan">  18              int right = (int) getStyle().getFloatPropertyProportionalTo(</span><br>    673-&gt;629:  <span style="background-color: white">                          CSSName.RIGHT, paddingEdge.width, c);</span><br>      674-&gt;N:  <span style="background-color: white">      </span><br>    675-&gt;631:  <span style="background-color: cyan">  18              int result = paddingEdge.width - left - right - getLeftMBP() - getRightMBP();</span><br>    676-&gt;632:  <span style="background-color: cyan">  18              return result &lt; 0 ? 0 : result;</span><br>      677-&gt;N:  <span style="background-color: white">              }</span><br>      678-&gt;N:  <span style="background-color: white">      </span><br>    679-&gt;635:  <span style="background-color: cyan"> 99+          return -1;</span><br>      680-&gt;N:  <span style="background-color: white">          }</span><br>      681-&gt;N:  <span style="background-color: white">      </span><br>    682-&gt;638:  <span style="background-color: cyan"> 99+      private int calcPinnedHeight(CssContext c) {</span><br>    683-&gt;639:  <span style="background-color: cyan"> 99+          if (! getStyle().isIdent(CSSName.TOP, IdentValue.AUTO) &amp;&amp;</span><br>    684-&gt;640:  <span style="background-color: white">                      ! getStyle().isIdent(CSSName.BOTTOM, IdentValue.AUTO)) {</span><br>    685-&gt;641:  <span style="background-color: white">   0              Rectangle paddingEdge = getContainingBlock().getPaddingEdge(0, 0, c);</span><br>      686-&gt;N:  <span style="background-color: white">      </span><br>    687-&gt;643:  <span style="background-color: white">   0              int top = (int) getStyle().getFloatPropertyProportionalTo(</span><br>    688-&gt;644:  <span style="background-color: white">                          CSSName.TOP, paddingEdge.height, c);</span><br>    689-&gt;645:  <span style="background-color: white">   0              int bottom = (int) getStyle().getFloatPropertyProportionalTo(</span><br>    690-&gt;646:  <span style="background-color: white">                          CSSName.BOTTOM, paddingEdge.height, c);</span><br>      691-&gt;N:  <span style="background-color: white">      </span><br>      692-&gt;N:  <span style="background-color: white">      </span><br>    693-&gt;649:  <span style="background-color: white">   0              int result = paddingEdge.height - top - bottom;</span><br>    694-&gt;650:  <span style="background-color: white">   0              return result &lt; 0 ? 0 : result;</span><br>      695-&gt;N:  <span style="background-color: white">              }</span><br>      696-&gt;N:  <span style="background-color: white">      </span><br>    697-&gt;653:  <span style="background-color: cyan"> 99+          return -1;</span><br>      698-&gt;N:  <span style="background-color: white">          }</span><br>      699-&gt;N:  <span style="background-color: white">      </span><br>    700-&gt;656:  <span style="background-color: white">   5      protected void resolveAutoMargins(</span><br>    701-&gt;657:  <span style="background-color: white">                  LayoutContext c, int cssWidth,</span><br>    702-&gt;658:  <span style="background-color: white">                  RectPropertySet padding, BorderPropertySet border) {</span><br>    703-&gt;659:  <span style="background-color: white">   5          int withoutMargins =</span><br>    704-&gt;660:  <span style="background-color: white">                      (int) border.left() + (int) padding.left() +</span><br>    705-&gt;661:  <span style="background-color: white">                              cssWidth +</span><br>    706-&gt;662:  <span style="background-color: white">                              (int) padding.right() + (int) border.right();</span><br>    707-&gt;663:  <span style="background-color: white">   5          if (withoutMargins &lt; getContainingBlockWidth()) {</span><br>    708-&gt;664:  <span style="background-color: white">   5              int available = getContainingBlockWidth() - withoutMargins;</span><br>      709-&gt;N:  <span style="background-color: white">      </span><br>    710-&gt;666:  <span style="background-color: white">   5              boolean autoLeft = getStyle().isAutoLeftMargin();</span><br>    711-&gt;667:  <span style="background-color: white">   5              boolean autoRight = getStyle().isAutoRightMargin();</span><br>      712-&gt;N:  <span style="background-color: white">      </span><br>    713-&gt;669:  <span style="background-color: white">   5              if (autoLeft &amp;&amp; autoRight) {</span><br>    714-&gt;670:  <span style="background-color: white">   5                  setMarginLeft(c, available / 2);</span><br>    715-&gt;671:  <span style="background-color: white">   5                  setMarginRight(c, available / 2);</span><br>    716-&gt;672:  <span style="background-color: white">   0              } else if (autoLeft) {</span><br>    717-&gt;673:  <span style="background-color: white">   0                  setMarginLeft(c, available);</span><br>    718-&gt;674:  <span style="background-color: white">   0              } else if (autoRight) {</span><br>    719-&gt;675:  <span style="background-color: white">   0                  setMarginRight(c, available);</span><br>      720-&gt;N:  <span style="background-color: white">                  }</span><br>      721-&gt;N:  <span style="background-color: white">              }</span><br>      722-&gt;N:  <span style="background-color: white">          }</span><br>      723-&gt;N:  <span style="background-color: white">      </span><br>    724-&gt;680:  <span style="background-color: white">   0      private int calcEffPageRelativeWidth(LayoutContext c) {</span><br>    725-&gt;681:  <span style="background-color: white">   0          int totalLeftMBP = 0;</span><br>    726-&gt;682:  <span style="background-color: white">   0          int totalRightMBP = 0;</span><br>      727-&gt;N:  <span style="background-color: white">      </span><br>    728-&gt;684:  <span style="background-color: white">   0          boolean usePageRelativeWidth = true;</span><br>      729-&gt;N:  <span style="background-color: white">      </span><br>    730-&gt;686:  <span style="background-color: white">   0          Box current = this;</span><br>    731-&gt;687:  <span style="background-color: white">   0          while (true) {</span><br>    732-&gt;688:  <span style="background-color: white">   0              CalculatedStyle style = current.getStyle();</span><br>    733-&gt;689:  <span style="background-color: white">   0              if (style.isAutoWidth() &amp;&amp; ! style.isCanBeShrunkToFit()) {</span><br>    734-&gt;690:  <span style="background-color: white">   0                  totalLeftMBP += current.getLeftMBP();</span><br>    735-&gt;691:  <span style="background-color: white">   0                  totalRightMBP += current.getRightMBP();</span><br>      736-&gt;N:  <span style="background-color: white">                  } else {</span><br>    737-&gt;693:  <span style="background-color: white">   0                  usePageRelativeWidth = false;</span><br>    738-&gt;694:  <span style="background-color: white">   0                  break;</span><br>      739-&gt;N:  <span style="background-color: white">                  }</span><br>      740-&gt;N:  <span style="background-color: white">      </span><br>    741-&gt;697:  <span style="background-color: white">   0              if (current.getContainingBlock().isInitialContainingBlock()) {</span><br>    742-&gt;698:  <span style="background-color: white">   0                  break;</span><br>      743-&gt;N:  <span style="background-color: white">                  } else {</span><br>    744-&gt;700:  <span style="background-color: white">   0                  current = current.getContainingBlock();</span><br>      745-&gt;N:  <span style="background-color: white">                  }</span><br>      746-&gt;N:  <span style="background-color: white">              }</span><br>      747-&gt;N:  <span style="background-color: white">      </span><br>    748-&gt;704:  <span style="background-color: white">   0          if (usePageRelativeWidth) {</span><br>    749-&gt;705:  <span style="background-color: white">   0              PageBox currentPage = c.getRootLayer().getFirstPage(c, this);</span><br>    750-&gt;706:  <span style="background-color: white">   0              return currentPage.getContentWidth(c) - totalLeftMBP - totalRightMBP;</span><br>      751-&gt;N:  <span style="background-color: white">              } else {</span><br>      752-&gt;N:  <span style="background-color: white">   0              return getContainingBlockWidth() - getLeftMBP() - getRightMBP();</span><br>      753-&gt;N:  <span style="background-color: white">              }</span><br>      754-&gt;N:  <span style="background-color: white">          }</span><br>      755-&gt;N:  <span style="background-color: white">      </span><br>      756-&gt;N:  <span style="background-color: white">          /**</span><br>      757-&gt;N:  <span style="background-color: white">           * Creates the replaced element as required. This method should be idempotent.</span><br>      758-&gt;N:  <span style="background-color: white">           */</span><br>    759-&gt;715:  <span style="background-color: cyan"> 99+      private void createReplaced(LayoutContext c) {</span><br>    760-&gt;716:  <span style="background-color: cyan"> 99+          ReplacedElement re = getReplacedElement();</span><br>      761-&gt;N:  <span style="background-color: white">              </span><br>    762-&gt;718:  <span style="background-color: cyan"> 99+          if (re == null) {</span><br>    763-&gt;719:  <span style="background-color: cyan"> 99+              int cssWidth = getCSSWidth(c);</span><br>    764-&gt;720:  <span style="background-color: cyan"> 99+              int cssHeight = getCSSHeight(c);</span><br>      765-&gt;N:  <span style="background-color: white">                  </span><br>      766-&gt;N:  <span style="background-color: white">                  // Since the interface doesn't allow us to pass min-width/height</span><br>      767-&gt;N:  <span style="background-color: white">                  // we implement it here.</span><br>    768-&gt;724:  <span style="background-color: cyan"> 99+              int minWidth = getCSSMinWidth(c);</span><br>    769-&gt;725:  <span style="background-color: cyan"> 99+              int minHeight = getCSSMinHeight(c);</span><br>      770-&gt;N:  <span style="background-color: white">                  </span><br>    771-&gt;727:  <span style="background-color: cyan"> 99+              if (minWidth &gt; cssWidth &amp;&amp;</span><br>    772-&gt;728:  <span style="background-color: white">                      minWidth &gt; 0) {</span><br>    773-&gt;729:  <span style="background-color: white"> 99+                  cssWidth = minWidth;</span><br>      774-&gt;N:  <span style="background-color: white">                  }</span><br>      775-&gt;N:  <span style="background-color: white">                  </span><br>    776-&gt;732:  <span style="background-color: cyan"> 99+              if (minHeight &gt; cssHeight &amp;&amp;</span><br>    777-&gt;733:  <span style="background-color: white">                      minHeight &gt; 0) {</span><br>    778-&gt;734:  <span style="background-color: cyan"> 99+                  cssHeight = minHeight;</span><br>      779-&gt;N:  <span style="background-color: white">                  }</span><br>      780-&gt;N:  <span style="background-color: white">                  </span><br>    781-&gt;737:  <span style="background-color: cyan"> 99+              re = c.getReplacedElementFactory().createReplacedElement(</span><br>    782-&gt;738:  <span style="background-color: white">                          c, this, c.getUac(), cssWidth, cssHeight);</span><br>      783-&gt;N:  <span style="background-color: white">                  </span><br>    784-&gt;740:  <span style="background-color: cyan"> 99+              if (re != null) {</span><br>    785-&gt;741:  <span style="background-color: cyan"> 99+                  setReplacedElement(re);</span><br>    786-&gt;742:  <span style="background-color: cyan"> 99+                  sizeReplacedElement(c, re);</span><br>      787-&gt;N:  <span style="background-color: white">                  }</span><br>      788-&gt;N:  <span style="background-color: white">              }</span><br>      789-&gt;N:  <span style="background-color: white">          }</span><br>      790-&gt;N:  <span style="background-color: white">          </span><br>      791-&gt;N:  <span style="background-color: white">          /**</span><br>      792-&gt;N:  <span style="background-color: white">           * Size a replaced element taking into account size properties including min/max,</span><br>      793-&gt;N:  <span style="background-color: white">           * border-box/content-box and the natural size/aspect ratio of the replaced object.</span><br>      794-&gt;N:  <span style="background-color: white">           * </span><br>      795-&gt;N:  <span style="background-color: white">           * This method may be called multiple times so must be idempotent.</span><br>      796-&gt;N:  <span style="background-color: white">           */</span><br>    797-&gt;753:  <span style="background-color: cyan"> 99+      private void sizeReplacedElement(LayoutContext c, ReplacedElement re) {</span><br>    798-&gt;754:  <span style="background-color: cyan"> 99+          int cssWidth = getCSSWidth(c);</span><br>    799-&gt;755:  <span style="background-color: cyan"> 99+          int cssHeight = getCSSHeight(c);</span><br>      800-&gt;N:  <span style="background-color: white">              </span><br>    801-&gt;757:  <span style="background-color: cyan"> 99+          boolean haveExactDims = cssWidth &gt;= 0 &amp;&amp; cssHeight &gt;= 0;</span><br>      802-&gt;N:  <span style="background-color: white">              </span><br>    803-&gt;759:  <span style="background-color: cyan"> 99+          boolean usedMinWidth = false;</span><br>    804-&gt;760:  <span style="background-color: cyan"> 99+          boolean usedMinHeight = false;</span><br>    805-&gt;761:  <span style="background-color: cyan"> 99+          boolean usedMaxWidth = false;</span><br>    806-&gt;762:  <span style="background-color: cyan"> 99+          boolean usedMaxHeight = false;</span><br>      807-&gt;N:  <span style="background-color: white">              </span><br>    808-&gt;764:  <span style="background-color: cyan"> 99+          int intrinsicWidth = re.getIntrinsicWidth();</span><br>    809-&gt;765:  <span style="background-color: cyan"> 99+          int intrinsicHeight = re.getIntrinsicHeight();</span><br>      810-&gt;N:  <span style="background-color: white">              </span><br>    811-&gt;767:  <span style="background-color: cyan"> 99+          int minWidth = getCSSMinWidth(c);</span><br>    812-&gt;768:  <span style="background-color: cyan"> 99+          int minHeight = getCSSMinHeight(c);</span><br>      813-&gt;N:  <span style="background-color: white">              </span><br>      814-&gt;N:  <span style="background-color: white">              // Clamp w to max-width if required.</span><br>      815-&gt;N:  <span style="background-color: white"> 99+          if (!getStyle().isMaxWidthNone() &amp;&amp;</span><br>    816-&gt;772:  <span style="background-color: white">                  (intrinsicWidth &gt; getCSSMaxWidth(c) || cssWidth &gt; getCSSMaxWidth(c))) {</span><br>    817-&gt;773:  <span style="background-color: white">  26              cssWidth = getCSSMaxWidth(c);</span><br>    818-&gt;774:  <span style="background-color: white">  26              usedMaxWidth = true;</span><br>      819-&gt;N:  <span style="background-color: white">              }</span><br>      820-&gt;N:  <span style="background-color: white">      </span><br>      821-&gt;N:  <span style="background-color: white">              // Clamp w to min-width if required.</span><br>    822-&gt;778:  <span style="background-color: cyan"> 99+          if (cssWidth &gt;= 0 &amp;&amp;</span><br>    823-&gt;779:  <span style="background-color: white">                  minWidth &gt; 0 &amp;&amp;</span><br>    824-&gt;780:  <span style="background-color: white">                  cssWidth &lt; minWidth) {</span><br>    825-&gt;781:  <span style="background-color: white">   4              cssWidth = minWidth;</span><br>    826-&gt;782:  <span style="background-color: white">   4              usedMinWidth = true;</span><br>      827-&gt;N:  <span style="background-color: white">              }</span><br>      828-&gt;N:  <span style="background-color: white">              </span><br>      829-&gt;N:  <span style="background-color: white">              // Clamp h to max-height if required.</span><br>      830-&gt;N:  <span style="background-color: white"> 99+          if (!getStyle().isMaxHeightNone() &amp;&amp;</span><br>    831-&gt;787:  <span style="background-color: white">                  (intrinsicHeight &gt; getCSSMaxHeight(c) || cssHeight &gt; getCSSMaxHeight(c))) {</span><br>    832-&gt;788:  <span style="background-color: white">  16              cssHeight = getCSSMaxHeight(c);</span><br>    833-&gt;789:  <span style="background-color: white">  16              usedMaxHeight = true;</span><br>      834-&gt;N:  <span style="background-color: white">              }</span><br>      835-&gt;N:  <span style="background-color: white">      </span><br>      836-&gt;N:  <span style="background-color: white">              // Clamp h to min-height if required.</span><br>    837-&gt;793:  <span style="background-color: cyan"> 99+          if (cssHeight &gt;= 0 &amp;&amp;</span><br>    838-&gt;794:  <span style="background-color: white">                  minHeight &gt; 0 &amp;&amp; </span><br>    839-&gt;795:  <span style="background-color: white">                  cssHeight &lt; minHeight) {</span><br>    840-&gt;796:  <span style="background-color: white">   2              cssHeight = minHeight;</span><br>    841-&gt;797:  <span style="background-color: white">   2              usedMinHeight = true;</span><br>      842-&gt;N:  <span style="background-color: white">              }</span><br>      843-&gt;N:  <span style="background-color: white">                                </span><br>      844-&gt;N:  <span style="background-color: white"> 99+          if (getStyle().isBorderBox()) {</span><br>    845-&gt;801:  <span style="background-color: white">  12              BorderPropertySet border = getBorder(c);</span><br>    846-&gt;802:  <span style="background-color: white">  12              RectPropertySet padding = getPadding(c);</span><br>    847-&gt;803:  <span style="background-color: white">  12              cssWidth = cssWidth &lt; 0 ? cssWidth : (int) Math.max(0, cssWidth - border.width() - padding.width());</span><br>    848-&gt;804:  <span style="background-color: white">  12              cssHeight = cssHeight &lt; 0 ? cssHeight : (int) Math.max(0, cssHeight - border.height() - padding.height());</span><br>      849-&gt;N:  <span style="background-color: white">              }</span><br>      850-&gt;N:  <span style="background-color: white">      </span><br>    851-&gt;807:  <span style="background-color: cyan"> 99+          int nw;</span><br>    852-&gt;808:  <span style="background-color: cyan"> 99+          int nh;</span><br>      853-&gt;N:  <span style="background-color: white">              </span><br>    854-&gt;810:  <span style="background-color: cyan"> 99+          boolean useExact = </span><br>    855-&gt;811:  <span style="background-color: white">                      (haveExactDims &amp;&amp; !usedMaxHeight &amp;&amp; !usedMaxWidth &amp;&amp; !usedMinWidth &amp;&amp; !usedMinHeight);</span><br>      856-&gt;N:  <span style="background-color: white">              </span><br>    857-&gt;813:  <span style="background-color: cyan"> 99+          if (cssWidth &gt; 0 &amp;&amp; cssHeight &gt; 0) {</span><br>    858-&gt;814:  <span style="background-color: white"> 99+              if (useExact) {</span><br>      859-&gt;N:  <span style="background-color: white">                      // We can warp the aspect ratio if we have explicit width and height values</span><br>      860-&gt;N:  <span style="background-color: white">                      // and the max/min values have not taken precedence.</span><br>    861-&gt;817:  <span style="background-color: white"> 99+                  nw = cssWidth;</span><br>    862-&gt;818:  <span style="background-color: white"> 99+                  nh = cssHeight;</span><br>    863-&gt;819:  <span style="background-color: white">  12              } else if (intrinsicWidth &gt; cssWidth || intrinsicHeight &gt; cssHeight) {</span><br>      864-&gt;N:  <span style="background-color: white">                      // Too large, so reduce respecting the aspect ratio.</span><br>    865-&gt;821:  <span style="background-color: white">   3                  double rw = (double) intrinsicWidth / (double) cssWidth;</span><br>    866-&gt;822:  <span style="background-color: white">   3                  double rh = (double) intrinsicHeight / (double) cssHeight;</span><br>      867-&gt;N:  <span style="background-color: white">      </span><br>    868-&gt;824:  <span style="background-color: white">   3                  if (rw &gt; rh) {</span><br>    869-&gt;825:  <span style="background-color: white">   1                      nw = cssWidth;</span><br>    870-&gt;826:  <span style="background-color: white">   1                      nh = (int) (intrinsicHeight / rw);</span><br>      871-&gt;N:  <span style="background-color: white">                      } else {</span><br>    872-&gt;828:  <span style="background-color: white">   2                      nw = (int) (intrinsicWidth / rh);</span><br>    873-&gt;829:  <span style="background-color: white">   2                      nh = cssHeight;</span><br>      874-&gt;N:  <span style="background-color: white">                      }</span><br>      875-&gt;N:  <span style="background-color: white">                  } else {</span><br>      876-&gt;N:  <span style="background-color: white">                      // Too small.</span><br>    877-&gt;833:  <span style="background-color: white">   9                  double rw = (double) intrinsicWidth / (double) cssWidth;</span><br>    878-&gt;834:  <span style="background-color: white">   9                  double rh = (double) intrinsicHeight / (double) cssHeight;</span><br>      879-&gt;N:  <span style="background-color: white">      </span><br>    880-&gt;836:  <span style="background-color: white">   9                  if (rw &gt; rh) {</span><br>    881-&gt;837:  <span style="background-color: white">   0                      nw = cssWidth;</span><br>    882-&gt;838:  <span style="background-color: white">   0                      nh = ((int) (intrinsicHeight / rw));</span><br>      883-&gt;N:  <span style="background-color: white">                      } else {</span><br>    884-&gt;840:  <span style="background-color: white">   9                      nw = ((int) (intrinsicWidth / rh));</span><br>    885-&gt;841:  <span style="background-color: white">   9                      nh = cssHeight;</span><br>      886-&gt;N:  <span style="background-color: white">                      }</span><br>      887-&gt;N:  <span style="background-color: white">                  }</span><br>    888-&gt;844:  <span style="background-color: cyan"> 99+          } else if (cssWidth &gt; 0) {</span><br>      889-&gt;N:  <span style="background-color: white">                  // Explicit min/max/width with auto height so keep aspect ratio.</span><br>    890-&gt;846:  <span style="background-color: white">  64              nw = cssWidth;</span><br>    891-&gt;847:  <span style="background-color: white">  64              nh = ((int) (((double) cssWidth / (double) intrinsicWidth) * intrinsicHeight));</span><br>    892-&gt;848:  <span style="background-color: cyan">  94          } else if (cssHeight &gt; 0) {</span><br>      893-&gt;N:  <span style="background-color: white">                  // Explicit min/max/height with auto width.</span><br>    894-&gt;850:  <span style="background-color: white">  30              nh = cssHeight;</span><br>    895-&gt;851:  <span style="background-color: white">  30              nw = ((int) (((double) cssHeight / (double) intrinsicHeight) * intrinsicWidth));</span><br>    896-&gt;852:  <span style="background-color: cyan">  64          } else if (cssWidth == 0 || cssHeight == 0) {</span><br>      897-&gt;N:  <span style="background-color: white">                  // Empty.</span><br>    898-&gt;854:  <span style="background-color: white">   0              nw = cssWidth;</span><br>    899-&gt;855:  <span style="background-color: white">   0              nh = cssHeight;</span><br>      900-&gt;N:  <span style="background-color: white">              } else {</span><br>      901-&gt;N:  <span style="background-color: white">                  // Auto width and height so use the natural dimensions of the replaced object.</span><br>    902-&gt;858:  <span style="background-color: cyan">  64              nw = intrinsicWidth;</span><br>    903-&gt;859:  <span style="background-color: cyan">  64              nh = intrinsicHeight;</span><br>      904-&gt;N:  <span style="background-color: white">              }</span><br>      905-&gt;N:  <span style="background-color: white">              </span><br>    906-&gt;862:  <span style="background-color: cyan"> 99+          setContentWidth(nw);</span><br>    907-&gt;863:  <span style="background-color: cyan"> 99+          setHeight(nh);</span><br>      908-&gt;N:  <span style="background-color: white">          }</span><br>      909-&gt;N:  <span style="background-color: white">          </span><br>    910-&gt;866:  <span style="background-color: cyan"> 99+      public void calcDimensions(LayoutContext c) {</span><br>    911-&gt;867:  <span style="background-color: cyan"> 99+          calcDimensions(c, getCSSWidth(c));</span><br>      912-&gt;N:  <span style="background-color: white">          }</span><br>      913-&gt;N:  <span style="background-color: white">      </span><br>    914-&gt;870:  <span style="background-color: cyan"> 99+      protected void calcDimensions(LayoutContext c, int cssWidth) {</span><br>      915-&gt;N:  <span style="background-color: white"> 99+          if (! isDimensionsCalculated()) {</span><br>    916-&gt;872:  <span style="background-color: cyan"> 99+              CalculatedStyle style = getStyle();</span><br>      917-&gt;N:  <span style="background-color: white">      </span><br>    918-&gt;874:  <span style="background-color: cyan"> 99+              RectPropertySet padding = getPadding(c);</span><br>    919-&gt;875:  <span style="background-color: cyan"> 99+              BorderPropertySet border = getBorder(c);</span><br>      920-&gt;N:  <span style="background-color: white">      </span><br>    921-&gt;877:  <span style="background-color: cyan"> 99+              if (cssWidth != -1 &amp;&amp; !isAnonymous() &amp;&amp;</span><br>    922-&gt;878:  <span style="background-color: white">                          (getStyle().isIdent(CSSName.MARGIN_LEFT, IdentValue.AUTO) ||</span><br>    923-&gt;879:  <span style="background-color: white">                                  getStyle().isIdent(CSSName.MARGIN_RIGHT, IdentValue.AUTO)) &amp;&amp;</span><br>      924-&gt;N:  <span style="background-color: white">                          getStyle().isNeedAutoMarginResolution()) {</span><br>    925-&gt;881:  <span style="background-color: white">   5                  resolveAutoMargins(c, cssWidth, padding, border);</span><br>      926-&gt;N:  <span style="background-color: white">                  }</span><br>      927-&gt;N:  <span style="background-color: white">      </span><br>    928-&gt;884:  <span style="background-color: cyan"> 99+              recalcMargin(c);</span><br>    929-&gt;885:  <span style="background-color: cyan"> 99+              RectPropertySet margin = getMargin(c);</span><br>      930-&gt;N:  <span style="background-color: white">      </span><br>      931-&gt;N:  <span style="background-color: white">                  // CLEAN: cast to int</span><br>    932-&gt;888:  <span style="background-color: cyan"> 99+              setLeftMBP((int) margin.left() + (int) border.left() + (int) padding.left());</span><br>    933-&gt;889:  <span style="background-color: cyan"> 99+              setRightMBP((int) padding.right() + (int) border.right() + (int) margin.right());</span><br>      934-&gt;N:  <span style="background-color: white">                  </span><br>    935-&gt;891:  <span style="background-color: cyan"> 99+              createReplaced(c);</span><br>      936-&gt;N:  <span style="background-color: white"> 99+              if (isReplaced()) {</span><br>    937-&gt;893:  <span style="background-color: cyan"> 99+                  setDimensionsCalculated(true);</span><br>    938-&gt;894:  <span style="background-color: cyan"> 99+                  return;</span><br>      939-&gt;N:  <span style="background-color: white">                  }</span><br>      940-&gt;N:  <span style="background-color: white">                  </span><br>    941-&gt;897:  <span style="background-color: cyan"> 99+              if (c.isPrint() &amp;&amp; getStyle().isDynamicAutoWidth()) {</span><br>    942-&gt;898:  <span style="background-color: white">   0                  setContentWidth(calcEffPageRelativeWidth(c));</span><br>      943-&gt;N:  <span style="background-color: white">                  } else {</span><br>      944-&gt;N:  <span style="background-color: white"> 99+                  setContentWidth((getContainingBlockWidth() - getLeftMBP() - getRightMBP()));</span><br>      945-&gt;N:  <span style="background-color: white">                  }</span><br>      946-&gt;N:  <span style="background-color: white">      </span><br>    947-&gt;903:  <span style="background-color: cyan"> 99+              setHeight(0);</span><br>      948-&gt;N:  <span style="background-color: white">      </span><br>      949-&gt;N:  <span style="background-color: white"> 99+              if (! isAnonymous() || (isFromCaptionedTable() &amp;&amp; isFloated())) {</span><br>    950-&gt;906:  <span style="background-color: cyan"> 99+                  int pinnedContentWidth = -1;</span><br>      951-&gt;N:  <span style="background-color: white">      </span><br>    952-&gt;908:  <span style="background-color: cyan"> 99+                  if (cssWidth != -1) {</span><br>    953-&gt;909:  <span style="background-color: cyan"> 99+                      if (style.isBorderBox()) {</span><br>    954-&gt;910:  <span style="background-color: red"> 99+                          setBorderBoxWidth(c, cssWidth);</span><br>      955-&gt;N:  <span style="background-color: white">                          } else {</span><br>    956-&gt;912:  <span style="background-color: cyan"> 99+                          setContentWidth(cssWidth);</span><br>      957-&gt;N:  <span style="background-color: white">                          }</span><br>      958-&gt;N:  <span style="background-color: white"> 99+                  } else if (getStyle().isAbsolute() || getStyle().isFixed()) {</span><br>    959-&gt;915:  <span style="background-color: cyan"> 99+                      pinnedContentWidth = calcPinnedContentWidth(c);</span><br>    960-&gt;916:  <span style="background-color: cyan"> 99+                      if (pinnedContentWidth != -1) {</span><br>    961-&gt;917:  <span style="background-color: cyan">  18                          setContentWidth(pinnedContentWidth);</span><br>      962-&gt;N:  <span style="background-color: white">                          }</span><br>      963-&gt;N:  <span style="background-color: white">                      }</span><br>      964-&gt;N:  <span style="background-color: white">      </span><br>    965-&gt;921:  <span style="background-color: cyan"> 99+                  int cssHeight = getCSSHeight(c);</span><br>    966-&gt;922:  <span style="background-color: cyan"> 99+                  if (cssHeight != -1) {</span><br>    967-&gt;923:  <span style="background-color: cyan"> 99+                      if (style.isBorderBox()) {</span><br>    968-&gt;924:  <span style="background-color: red"> 99+                          setBorderBoxHeight(c, cssHeight);</span><br>      969-&gt;N:  <span style="background-color: white">                          } else {</span><br>    970-&gt;926:  <span style="background-color: cyan"> 99+                          setHeight(cssHeight);</span><br>      971-&gt;N:  <span style="background-color: white">                          }</span><br>      972-&gt;N:  <span style="background-color: white">                      }</span><br>      973-&gt;N:  <span style="background-color: white">      </span><br>    974-&gt;930:  <span style="background-color: cyan"> 99+                  ReplacedElement re = getReplacedElement();</span><br>      975-&gt;N:  <span style="background-color: white">      </span><br>    976-&gt;932:  <span style="background-color: cyan"> 99+                  if (re != null) {</span><br>      977-&gt;N:  <span style="background-color: white">      </span><br>    978-&gt;934:  <span style="background-color: cyan"> 99+                  } else if (cssWidth == -1 &amp;&amp; pinnedContentWidth == -1 &amp;&amp;</span><br>    979-&gt;935:  <span style="background-color: white">                              style.isCanBeShrunkToFit()) {</span><br>    980-&gt;936:  <span style="background-color: cyan"> 99+                      setNeedShrinkToFitCalculatation(true);</span><br>      981-&gt;N:  <span style="background-color: white">                      }</span><br>      982-&gt;N:  <span style="background-color: white">      </span><br>      983-&gt;N:  <span style="background-color: white"> 99+                  if (! isReplaced()) {</span><br>    984-&gt;940:  <span style="background-color: cyan"> 99+                      applyCSSMinMaxWidth(c);</span><br>      985-&gt;N:  <span style="background-color: white">                      }</span><br>      986-&gt;N:  <span style="background-color: white">                  }</span><br>      987-&gt;N:  <span style="background-color: white">      </span><br>    988-&gt;944:  <span style="background-color: cyan"> 99+              setDimensionsCalculated(true);</span><br>      989-&gt;N:  <span style="background-color: white">              }</span><br>      990-&gt;N:  <span style="background-color: white">          }</span><br>      991-&gt;N:  <span style="background-color: white">      </span><br>    992-&gt;948:  <span style="background-color: cyan"> 99+      private void calcClearance(LayoutContext c) {</span><br>      993-&gt;N:  <span style="background-color: white"> 99+          if (getStyle().isCleared() &amp;&amp; ! getStyle().isFloated()) {</span><br>    994-&gt;950:  <span style="background-color: cyan">   8              c.translate(0, -getY());</span><br>    995-&gt;951:  <span style="background-color: cyan">   8              c.getBlockFormattingContext().clear(c, this);</span><br>    996-&gt;952:  <span style="background-color: cyan">   8              c.translate(0, getY());</span><br>      997-&gt;N:  <span style="background-color: white">   8              calcCanvasLocation();</span><br>      998-&gt;N:  <span style="background-color: white">              }</span><br>      999-&gt;N:  <span style="background-color: white">          }</span><br>     1000-&gt;N:  <span style="background-color: white">      </span><br>   1001-&gt;957:  <span style="background-color: cyan"> 99+      private void calcExtraPageClearance(LayoutContext c) {</span><br>   1002-&gt;958:  <span style="background-color: cyan"> 99+          if (c.isPageBreaksAllowed() &amp;&amp;</span><br>   1003-&gt;959:  <span style="background-color: white">                      c.getExtraSpaceTop() &gt; 0 &amp;&amp; (getStyle().isSpecifiedAsBlock() || getStyle().isListItem())) {</span><br>   1004-&gt;960:  <span style="background-color: red"> 99+              PageBox first = c.getRootLayer().getFirstPage(c, this);</span><br>   1005-&gt;961:  <span style="background-color: red"> 99+              if (first != null &amp;&amp; first.getTop() + c.getExtraSpaceTop() &gt; getAbsY()) {</span><br>   1006-&gt;962:  <span style="background-color: cyan">   3                  int diff = first.getTop() + c.getExtraSpaceTop() - getAbsY();</span><br>   1007-&gt;963:  <span style="background-color: cyan">   3                  setY(getY() + diff);</span><br>   1008-&gt;964:  <span style="background-color: cyan">   3                  c.translate(0, diff);</span><br>     1009-&gt;N:  <span style="background-color: white">   3                  calcCanvasLocation();</span><br>     1010-&gt;N:  <span style="background-color: white">                  }</span><br>     1011-&gt;N:  <span style="background-color: white">              }</span><br>     1012-&gt;N:  <span style="background-color: white">          }</span><br>     1013-&gt;N:  <span style="background-color: white">      </span><br>   1014-&gt;970:  <span style="background-color: cyan"> 99+      protected void addBoxID(LayoutContext c) {</span><br>     1015-&gt;N:  <span style="background-color: white"> 99+          if (! isAnonymous()) {</span><br>   1016-&gt;972:  <span style="background-color: cyan"> 99+              String name = c.getNamespaceHandler().getAnchorName(getElement());</span><br>   1017-&gt;973:  <span style="background-color: cyan"> 99+              if (name != null) {</span><br>   1018-&gt;974:  <span style="background-color: white">   0                  c.addBoxId(name, this);</span><br>     1019-&gt;N:  <span style="background-color: white">                  }</span><br>   1020-&gt;976:  <span style="background-color: cyan"> 99+              String id = c.getNamespaceHandler().getID(getElement());</span><br>   1021-&gt;977:  <span style="background-color: cyan"> 99+              if (id != null) {</span><br>   1022-&gt;978:  <span style="background-color: cyan"> 99+                  c.addBoxId(id, this);</span><br>     1023-&gt;N:  <span style="background-color: white">                  }</span><br>     1024-&gt;N:  <span style="background-color: white">              }</span><br>     1025-&gt;N:  <span style="background-color: white">          }</span><br>     1026-&gt;N:  <span style="background-color: white">      </span><br>   1027-&gt;983:  <span style="background-color: cyan"> 99+      public void layout(LayoutContext c) {</span><br>   1028-&gt;984:  <span style="background-color: cyan"> 99+          layout(c, 0);</span><br>     1029-&gt;N:  <span style="background-color: white">          }</span><br>     1030-&gt;N:  <span style="background-color: white">      </span><br>   1031-&gt;987:  <span style="background-color: cyan"> 99+      public void layout(LayoutContext c, int contentStart) {</span><br>   1032-&gt;988:  <span style="background-color: cyan"> 99+          CalculatedStyle style = getStyle();</span><br>     1033-&gt;N:  <span style="background-color: white">      </span><br>   1034-&gt;990:  <span style="background-color: cyan"> 99+          boolean pushedLayer = checkPushLayer(c, style);</span><br>     1035-&gt;N:  <span style="background-color: white">      </span><br>   1036-&gt;992:  <span style="background-color: cyan"> 99+          calcClearance(c);</span><br>     1037-&gt;N:  <span style="background-color: white">      </span><br>   1038-&gt;994:  <span style="background-color: cyan"> 99+          checkPushBfc(c);</span><br>     1039-&gt;N:  <span style="background-color: white">      </span><br>   1040-&gt;996:  <span style="background-color: cyan"> 99+          addBoxID(c);</span><br>     1041-&gt;N:  <span style="background-color: white">      </span><br>   1042-&gt;998:  <span style="background-color: cyan"> 99+          if (c.isPrint() &amp;&amp; getStyle().isIdent(CSSName.FS_PAGE_SEQUENCE, IdentValue.START)) {</span><br>   1043-&gt;999:  <span style="background-color: white">   0              c.getRootLayer().addPageSequence(this);</span><br>     1044-&gt;N:  <span style="background-color: white">              }</span><br>     1045-&gt;N:  <span style="background-color: white">      </span><br>  1046-&gt;1002:  <span style="background-color: cyan"> 99+          createReplaced(c);</span><br>  1047-&gt;1003:  <span style="background-color: cyan"> 99+          calcDimensions(c);</span><br>  1048-&gt;1004:  <span style="background-color: cyan"> 99+          calcShrinkToFitWidthIfNeeded(c);</span><br>  1049-&gt;1005:  <span style="background-color: cyan"> 99+          collapseMargins(c);</span><br>     1050-&gt;N:  <span style="background-color: white">      </span><br>  1051-&gt;1007:  <span style="background-color: cyan"> 99+          calcExtraPageClearance(c);</span><br>     1052-&gt;N:  <span style="background-color: white">      </span><br>  1053-&gt;1009:  <span style="background-color: cyan"> 99+          if (c.isPrint()) {</span><br>  1054-&gt;1010:  <span style="background-color: cyan"> 99+              PageBox firstPage = c.getRootLayer().getFirstPage(c, this);</span><br>  1055-&gt;1011:  <span style="background-color: cyan"> 99+              if (firstPage != null &amp;&amp; firstPage.getTop() == getAbsY() - getPageClearance()) {</span><br>  1056-&gt;1012:  <span style="background-color: cyan"> 99+                  resetTopMargin(c);</span><br>     1057-&gt;N:  <span style="background-color: white">                  }</span><br>     1058-&gt;N:  <span style="background-color: white">              }</span><br>     1059-&gt;N:  <span style="background-color: white">      </span><br>  1060-&gt;1016:  <span style="background-color: cyan"> 99+          BorderPropertySet border = getBorder(c);</span><br>  1061-&gt;1017:  <span style="background-color: cyan"> 99+          RectPropertySet margin = getMargin(c);</span><br>  1062-&gt;1018:  <span style="background-color: cyan"> 99+          RectPropertySet padding = getPadding(c);</span><br>     1063-&gt;N:  <span style="background-color: white">      </span><br>     1064-&gt;N:  <span style="background-color: white">              // save height in case fixed height</span><br>  1065-&gt;1021:  <span style="background-color: cyan"> 99+          int originalHeight = getHeight();</span><br>     1066-&gt;N:  <span style="background-color: white">      </span><br>     1067-&gt;N:  <span style="background-color: white"> 99+          if (! isReplaced()) {</span><br>  1068-&gt;1024:  <span style="background-color: cyan"> 99+              setHeight(0);</span><br>     1069-&gt;N:  <span style="background-color: white">              }</span><br>     1070-&gt;N:  <span style="background-color: white">      </span><br>  1071-&gt;1027:  <span style="background-color: cyan"> 99+          boolean didSetMarkerData = false;</span><br>     1072-&gt;N:  <span style="background-color: white"> 99+          if (getStyle().isListItem()) {</span><br>  1073-&gt;1029:  <span style="background-color: cyan"> 99+              createMarkerData(c);</span><br>  1074-&gt;1030:  <span style="background-color: cyan"> 99+              c.setCurrentMarkerData(getMarkerData());</span><br>  1075-&gt;1031:  <span style="background-color: cyan"> 99+              didSetMarkerData = true;</span><br>     1076-&gt;N:  <span style="background-color: white">              }</span><br>     1077-&gt;N:  <span style="background-color: white">      </span><br>     1078-&gt;N:  <span style="background-color: white">              // do children's layout</span><br>  1079-&gt;1035:  <span style="background-color: cyan"> 99+          int tx = (int) margin.left() + (int) border.left() + (int) padding.left();</span><br>  1080-&gt;1036:  <span style="background-color: cyan"> 99+          int ty = (int) margin.top() + (int) border.top() + (int) padding.top();</span><br>  1081-&gt;1037:  <span style="background-color: cyan"> 99+          setTx(tx);</span><br>  1082-&gt;1038:  <span style="background-color: cyan"> 99+          setTy(ty);</span><br>  1083-&gt;1039:  <span style="background-color: cyan"> 99+          c.translate(getTx(), getTy());</span><br>     1084-&gt;N:  <span style="background-color: white"> 99+          if (! isReplaced()) {</span><br>  1085-&gt;1041:  <span style="background-color: cyan"> 99+              layoutChildren(c, contentStart);</span><br>     1086-&gt;N:  <span style="background-color: white">              } else {</span><br>  1087-&gt;1043:  <span style="background-color: cyan"> 99+              setState(Box.DONE);</span><br>     1088-&gt;N:  <span style="background-color: white">              }</span><br>  1089-&gt;1045:  <span style="background-color: cyan"> 99+          c.translate(-getTx(), -getTy());</span><br>     1090-&gt;N:  <span style="background-color: white">      </span><br>     1091-&gt;N:  <span style="background-color: white"> 99+          setChildrenHeight(getHeight());</span><br>     1092-&gt;N:  <span style="background-color: white">      </span><br>     1093-&gt;N:  <span style="background-color: white"> 99+          if (! isReplaced()) {</span><br>     1094-&gt;N:  <span style="background-color: white"> 99+              if (! isAutoHeight()) {</span><br>  1095-&gt;1051:  <span style="background-color: cyan"> 99+                  int delta = originalHeight - getHeight();</span><br>  1096-&gt;1052:  <span style="background-color: cyan"> 99+                  if (delta &gt; 0 || isAllowHeightToShrink()) {</span><br>  1097-&gt;1053:  <span style="background-color: cyan"> 99+                      setHeight(originalHeight);</span><br>     1098-&gt;N:  <span style="background-color: white">                      }</span><br>     1099-&gt;N:  <span style="background-color: white">                  }</span><br>     1100-&gt;N:  <span style="background-color: white">      </span><br>  1101-&gt;1057:  <span style="background-color: cyan"> 99+              applyCSSMinMaxHeight(c);</span><br>     1102-&gt;N:  <span style="background-color: white">              }</span><br>     1103-&gt;N:  <span style="background-color: white">      </span><br>     1104-&gt;N:  <span style="background-color: white"> 99+          if (isRoot() || getStyle().establishesBFC()) {</span><br>     1105-&gt;N:  <span style="background-color: white"> 99+              if (getStyle().isAutoHeight()) {</span><br>  1106-&gt;1062:  <span style="background-color: red"> 99+                  int delta =</span><br>  1107-&gt;1063:  <span style="background-color: white">                              c.getBlockFormattingContext().getFloatManager().getClearDelta(</span><br>  1108-&gt;1064:  <span style="background-color: white">                                      c, getTy() + getHeight());</span><br>  1109-&gt;1065:  <span style="background-color: red"> 99+                  if (delta &gt; 0) {</span><br>  1110-&gt;1066:  <span style="background-color: cyan">  88                      setHeight(getHeight() + delta);</span><br>  1111-&gt;1067:  <span style="background-color: cyan">  88                      setChildrenHeight(getChildrenHeight() + delta);</span><br>     1112-&gt;N:  <span style="background-color: white">                      }</span><br>     1113-&gt;N:  <span style="background-color: white">                  }</span><br>     1114-&gt;N:  <span style="background-color: white">              }</span><br>     1115-&gt;N:  <span style="background-color: white">      </span><br>  1116-&gt;1072:  <span style="background-color: cyan"> 99+          if (didSetMarkerData) {</span><br>  1117-&gt;1073:  <span style="background-color: cyan"> 99+              c.setCurrentMarkerData(null);</span><br>     1118-&gt;N:  <span style="background-color: white">              }</span><br>     1119-&gt;N:  <span style="background-color: white">      </span><br>  1120-&gt;1076:  <span style="background-color: cyan"> 99+          calcLayoutHeight(c, border, margin, padding);</span><br>     1121-&gt;N:  <span style="background-color: white">      </span><br>  1122-&gt;1078:  <span style="background-color: cyan"> 99+          checkPopBfc(c);</span><br>     1123-&gt;N:  <span style="background-color: white">      </span><br>  1124-&gt;1080:  <span style="background-color: cyan"> 99+          if (pushedLayer) {</span><br>  1125-&gt;1081:  <span style="background-color: cyan"> 99+              c.popLayer();</span><br>     1126-&gt;N:  <span style="background-color: white">              }</span><br>     1127-&gt;N:  <span style="background-color: white">          }</span><br>     1128-&gt;N:  <span style="background-color: white">      </span><br>  1129-&gt;1085:  <span style="background-color: cyan"> 99+      protected boolean checkPushLayer(LayoutContext c, CalculatedStyle style) {</span><br>     1130-&gt;N:  <span style="background-color: white"> 99+          if (isRoot()) {</span><br>  1131-&gt;1087:  <span style="background-color: cyan"> 99+              c.pushLayer(this);</span><br>     1132-&gt;N:  <span style="background-color: white">      </span><br>  1133-&gt;1089:  <span style="background-color: cyan"> 99+              if (c.isPrint()) {</span><br>  1134-&gt;1090:  <span style="background-color: cyan"> 99+                  if (!style.isIdent(CSSName.PAGE, IdentValue.AUTO)) {</span><br>  1135-&gt;1091:  <span style="background-color: white">   0                      c.setPageName(style.getStringProperty(CSSName.PAGE));</span><br>     1136-&gt;N:  <span style="background-color: white">                      }</span><br>  1137-&gt;1093:  <span style="background-color: cyan"> 99+                  c.getRootLayer().addPage(c);</span><br>     1138-&gt;N:  <span style="background-color: white">                  }</span><br>     1139-&gt;N:  <span style="background-color: white">      </span><br>  1140-&gt;1096:  <span style="background-color: cyan"> 99+              return true;</span><br>  1141-&gt;1097:  <span style="background-color: cyan"> 99+          } else if (style.requiresLayer() &amp;&amp; this.getLayer() == null) {</span><br>  1142-&gt;1098:  <span style="background-color: cyan"> 99+              c.pushLayer(this);</span><br>  1143-&gt;1099:  <span style="background-color: cyan"> 99+              return true;</span><br>  1144-&gt;1100:  <span style="background-color: cyan"> 99+          } else if (style.requiresLayer()) {</span><br>     1145-&gt;N:  <span style="background-color: white">                  // FIXME: HACK. Some boxes can be layed out many times (to satisfy page constraints for example).</span><br>     1146-&gt;N:  <span style="background-color: white">                  // If this happens we just mark our old layer for deletion and create a new layer.</span><br>     1147-&gt;N:  <span style="background-color: white">                  // Not sure this is right, but doesn't break any correct tests.</span><br>     1148-&gt;N:  <span style="background-color: white">                  //</span><br>     1149-&gt;N:  <span style="background-color: white">                  // NOTE: This only happens if someone has called layout multiple times</span><br>     1150-&gt;N:  <span style="background-color: white">                  // without calling reset beforehand.</span><br>  1151-&gt;1107:  <span style="background-color: cyan"> 99+              this.getLayer().setForDeletion(true);</span><br>  1152-&gt;1108:  <span style="background-color: cyan"> 99+              c.pushLayer(this);</span><br>  1153-&gt;1109:  <span style="background-color: cyan"> 99+              return true;</span><br>     1154-&gt;N:  <span style="background-color: white">              }</span><br>     1155-&gt;N:  <span style="background-color: white">      </span><br>  1156-&gt;1112:  <span style="background-color: cyan"> 99+          return false;</span><br>     1157-&gt;N:  <span style="background-color: white">          }</span><br>     1158-&gt;N:  <span style="background-color: white">      </span><br>     1159-&gt;N:  <span style="background-color: white">          /**</span><br>     1160-&gt;N:  <span style="background-color: white">           * Checks if this box established a block formatting context and if so</span><br>     1161-&gt;N:  <span style="background-color: white">           * removes the last bfc from the stack.</span><br>     1162-&gt;N:  <span style="background-color: white">           * See also {@link #checkPushBfc(LayoutContext)}</span><br>     1163-&gt;N:  <span style="background-color: white">           */</span><br>  1164-&gt;1120:  <span style="background-color: cyan"> 99+      protected void checkPopBfc(LayoutContext c) {</span><br>     1165-&gt;N:  <span style="background-color: white"> 99+          if (isRoot() || getStyle().establishesBFC()) {</span><br>  1166-&gt;1122:  <span style="background-color: red"> 99+              c.popBFC();</span><br>     1167-&gt;N:  <span style="background-color: white">              }</span><br>     1168-&gt;N:  <span style="background-color: white">          }</span><br>     1169-&gt;N:  <span style="background-color: white">      </span><br>     1170-&gt;N:  <span style="background-color: white">          /**</span><br>     1171-&gt;N:  <span style="background-color: white">           * Checks if this box establishes a block formatting context and if</span><br>     1172-&gt;N:  <span style="background-color: white">           * so creates one and pushes it to the stack of bfcs.</span><br>     1173-&gt;N:  <span style="background-color: white">           * See also {@link #checkPopBfc(LayoutContext)}</span><br>     1174-&gt;N:  <span style="background-color: white">           */</span><br>  1175-&gt;1131:  <span style="background-color: cyan"> 99+      protected void checkPushBfc(LayoutContext c) {</span><br>     1176-&gt;N:  <span style="background-color: white"> 99+          if (isRoot() || getStyle().establishesBFC() || isMarginAreaRoot()) {</span><br>  1177-&gt;1133:  <span style="background-color: red"> 99+              BlockFormattingContext bfc = new BlockFormattingContext(this, c);</span><br>  1178-&gt;1134:  <span style="background-color: red"> 99+              c.pushBFC(bfc);</span><br>     1179-&gt;N:  <span style="background-color: white">              }</span><br>     1180-&gt;N:  <span style="background-color: white">          }</span><br>     1181-&gt;N:  <span style="background-color: white">      </span><br>  1182-&gt;1138:  <span style="background-color: white">  80      protected boolean isAllowHeightToShrink() {</span><br>  1183-&gt;1139:  <span style="background-color: white">  80          return true;</span><br>     1184-&gt;N:  <span style="background-color: white">          }</span><br>     1185-&gt;N:  <span style="background-color: white">      </span><br>  1186-&gt;1142:  <span style="background-color: cyan"> 99+      protected int getPageClearance() {</span><br>  1187-&gt;1143:  <span style="background-color: cyan"> 99+          return 0;</span><br>     1188-&gt;N:  <span style="background-color: white">          }</span><br>     1189-&gt;N:  <span style="background-color: white">      </span><br>     1190-&gt;N:  <span style="background-color: white">          /**</span><br>     1191-&gt;N:  <span style="background-color: white">           * Oh oh! Up to this method height is used to track content height. After this method it is used</span><br>     1192-&gt;N:  <span style="background-color: white">           * to track total layout height! </span><br>     1193-&gt;N:  <span style="background-color: white">           */</span><br>  1194-&gt;1150:  <span style="background-color: cyan"> 99+      protected void calcLayoutHeight(</span><br>  1195-&gt;1151:  <span style="background-color: white">                  LayoutContext c, BorderPropertySet border,</span><br>  1196-&gt;1152:  <span style="background-color: white">                  RectPropertySet margin, RectPropertySet padding) {</span><br>  1197-&gt;1153:  <span style="background-color: cyan"> 99+          setHeight(getHeight() + ((int) margin.top() + (int) border.top() + (int) padding.top() +</span><br>  1198-&gt;1154:  <span style="background-color: white">                      (int) padding.bottom() + (int) border.bottom() + (int) margin.bottom()));</span><br>  1199-&gt;1155:  <span style="background-color: cyan"> 99+          setChildrenHeight(getChildrenHeight() + ((int) margin.top() + (int) border.top() + (int) padding.top() +</span><br>  1200-&gt;1156:  <span style="background-color: white">                      (int) padding.bottom() + (int) border.bottom() + (int) margin.bottom()));</span><br>     1201-&gt;N:  <span style="background-color: white">          }</span><br>     1202-&gt;N:  <span style="background-color: white">      </span><br>     1203-&gt;N:  <span style="background-color: white">      </span><br>  1204-&gt;1160:  <span style="background-color: cyan"> 99+      private void calcShrinkToFitWidthIfNeeded(LayoutContext c) {</span><br>     1205-&gt;N:  <span style="background-color: white"> 99+          if (isNeedShrinkToFitCalculatation()) {</span><br>  1206-&gt;1162:  <span style="background-color: cyan"> 99+              setContentWidth(calcShrinkToFitWidth(c) - getLeftMBP() - getRightMBP());</span><br>  1207-&gt;1163:  <span style="background-color: cyan"> 99+              applyCSSMinMaxWidth(c);</span><br>  1208-&gt;1164:  <span style="background-color: cyan"> 99+              setNeedShrinkToFitCalculatation(false);</span><br>     1209-&gt;N:  <span style="background-color: white">              }</span><br>     1210-&gt;N:  <span style="background-color: white">          }</span><br>     1211-&gt;N:  <span style="background-color: white">      </span><br>  1212-&gt;1168:  <span style="background-color: cyan"> 99+      private void applyCSSMinMaxWidth(CssContext c) {</span><br>  1213-&gt;1169:  <span style="background-color: cyan"> 99+          int w = getStyle().isBorderBox() ? getBorderBoxWidth(c) : getContentWidth();</span><br>     1214-&gt;N:  <span style="background-color: white">              </span><br>     1215-&gt;N:  <span style="background-color: white"> 99+          if (! getStyle().isMaxWidthNone()) {</span><br>  1216-&gt;1172:  <span style="background-color: cyan">  56              int cssMaxWidth = getCSSMaxWidth(c);</span><br>  1217-&gt;1173:  <span style="background-color: cyan">  56              if (w &gt; cssMaxWidth) {</span><br>     1218-&gt;N:  <span style="background-color: white">   3                  if (getStyle().isBorderBox()) {</span><br>  1219-&gt;1175:  <span style="background-color: white">   2                      setBorderBoxWidth(c, cssMaxWidth);</span><br>     1220-&gt;N:  <span style="background-color: white">                      } else {</span><br>  1221-&gt;1177:  <span style="background-color: white">   1                      setContentWidth(cssMaxWidth);</span><br>     1222-&gt;N:  <span style="background-color: white">                      }</span><br>     1223-&gt;N:  <span style="background-color: white">                  }</span><br>     1224-&gt;N:  <span style="background-color: white">              }</span><br>     1225-&gt;N:  <span style="background-color: white">              </span><br>  1226-&gt;1182:  <span style="background-color: cyan"> 99+          int cssMinWidth = getCSSMinWidth(c);</span><br>  1227-&gt;1183:  <span style="background-color: cyan"> 99+          if (cssMinWidth &gt; 0 &amp;&amp; w &lt; cssMinWidth) {</span><br>     1228-&gt;N:  <span style="background-color: white">  40              if (getStyle().isBorderBox()) {</span><br>  1229-&gt;1185:  <span style="background-color: white">  33                  setBorderBoxWidth(c, cssMinWidth);</span><br>     1230-&gt;N:  <span style="background-color: white">                  } else {</span><br>  1231-&gt;1187:  <span style="background-color: white">   7                  setContentWidth(cssMinWidth);</span><br>     1232-&gt;N:  <span style="background-color: white">                  }</span><br>     1233-&gt;N:  <span style="background-color: white">              }</span><br>     1234-&gt;N:  <span style="background-color: white">          }</span><br>     1235-&gt;N:  <span style="background-color: white">      </span><br>  1236-&gt;1192:  <span style="background-color: cyan"> 99+      private void applyCSSMinMaxHeight(CssContext c) {</span><br>  1237-&gt;1193:  <span style="background-color: cyan"> 99+          int currentHeight = getStyle().isBorderBox() ? getBorderBoxHeight(c) : getHeight();</span><br>     1238-&gt;N:  <span style="background-color: white">              </span><br>     1239-&gt;N:  <span style="background-color: white"> 99+          if (! getStyle().isMaxHeightNone()) {</span><br>  1240-&gt;1196:  <span style="background-color: white">  11              int cssMaxHeight = getCSSMaxHeight(c);</span><br>  1241-&gt;1197:  <span style="background-color: white">  11              if (currentHeight &gt; cssMaxHeight) {</span><br>     1242-&gt;N:  <span style="background-color: white">   5                  if (getStyle().isBorderBox()) {</span><br>  1243-&gt;1199:  <span style="background-color: white">   1                      setBorderBoxHeight(c, cssMaxHeight);</span><br>     1244-&gt;N:  <span style="background-color: white">                      } else {</span><br>  1245-&gt;1201:  <span style="background-color: white">   4                      setHeight(cssMaxHeight);</span><br>     1246-&gt;N:  <span style="background-color: white">                      }</span><br>     1247-&gt;N:  <span style="background-color: white">                  }</span><br>     1248-&gt;N:  <span style="background-color: white">              }</span><br>     1249-&gt;N:  <span style="background-color: white">              </span><br>  1250-&gt;1206:  <span style="background-color: cyan"> 99+          int cssMinHeight = getCSSMinHeight(c);</span><br>  1251-&gt;1207:  <span style="background-color: cyan"> 99+          if (cssMinHeight &gt; 0 &amp;&amp; currentHeight &lt; cssMinHeight) {</span><br>     1252-&gt;N:  <span style="background-color: white"> 99+              if (getStyle().isBorderBox()) {</span><br>  1253-&gt;1209:  <span style="background-color: white">  71                  setBorderBoxHeight(c, cssMinHeight);</span><br>     1254-&gt;N:  <span style="background-color: white">                  } else {</span><br>  1255-&gt;1211:  <span style="background-color: cyan"> 99+                  setHeight(cssMinHeight);</span><br>     1256-&gt;N:  <span style="background-color: white">                  }</span><br>     1257-&gt;N:  <span style="background-color: white">              }</span><br>     1258-&gt;N:  <span style="background-color: white">          }</span><br>     1259-&gt;N:  <span style="background-color: white">      </span><br>  1260-&gt;1216:  <span style="background-color: cyan"> 99+      public void ensureChildren(LayoutContext c) {</span><br>     1261-&gt;U:  <span style="background-color: yellow"> 99+          if (getChildrenContentType() == ContentType.UNKNOWN) {</span><br>  1262-&gt;1218:  <span style="background-color: cyan"> 99+              BoxBuilder.createChildren(c, this);</span><br>     1263-&gt;N:  <span style="background-color: white">              }</span><br>     1264-&gt;N:  <span style="background-color: white">          }</span><br>     1265-&gt;N:  <span style="background-color: white">      </span><br>  1266-&gt;1222:  <span style="background-color: cyan"> 99+      protected void layoutChildren(LayoutContext c, int contentStart) {</span><br>  1267-&gt;1223:  <span style="background-color: cyan"> 99+          setState(Box.CHILDREN_FLUX);</span><br>  1268-&gt;1224:  <span style="background-color: cyan"> 99+          ensureChildren(c);</span><br>     1269-&gt;N:  <span style="background-color: white">      </span><br>  1270-&gt;1226:  <span style="background-color: cyan"> 99+          if (getFirstLetterStyle() != null) {</span><br>     1271-&gt;U:  <span style="background-color: yellow">   0              c.setFirstLettersTracker(</span><br>     1272-&gt;U:  <span style="background-color: yellow">                      c.getFirstLettersTracker().withStyle(getFirstLetterStyle()));</span><br>     1273-&gt;N:  <span style="background-color: white">              }</span><br>  1274-&gt;1229:  <span style="background-color: cyan"> 99+          if (getFirstLineStyle() != null) {</span><br>     1275-&gt;U:  <span style="background-color: yellow">   0              c.setFirstLinesTracker(</span><br>     1276-&gt;U:  <span style="background-color: yellow">                      c.getFirstLinesTracker().withStyle(getFirstLineStyle()));</span><br>     1277-&gt;N:  <span style="background-color: white">              }</span><br>     1278-&gt;N:  <span style="background-color: white">      </span><br>     1279-&gt;N:  <span style="background-color: white"> 99+          switch (getChildrenContentType()) {</span><br>     1280-&gt;U:  <span style="background-color: yellow"> 99+              case INLINE:</span><br>  1281-&gt;1235:  <span style="background-color: cyan"> 99+                  layoutInlineChildren(c, contentStart, calcInitialBreakAtLine(c), true);</span><br>  1282-&gt;1236:  <span style="background-color: cyan"> 99+                  break;</span><br>     1283-&gt;U:  <span style="background-color: yellow"> 99+              case BLOCK:</span><br>  1284-&gt;1238:  <span style="background-color: cyan"> 99+                  BlockBoxing.layoutContent(c, this, contentStart);</span><br>  1285-&gt;1239:  <span style="background-color: cyan"> 99+                  break;</span><br>     1286-&gt;U:  <span style="background-color: yellow">   0              case UNKNOWN:</span><br>     1287-&gt;N:  <span style="background-color: white">                      // FALL-THRU - Can not happen due to ensureChildren call above.</span><br>     1288-&gt;U:  <span style="background-color: yellow"> 99+              case EMPTY:</span><br>     1289-&gt;N:  <span style="background-color: white">                      // FALL-THRU</span><br>     1290-&gt;U:  <span style="background-color: yellow">   0              default:</span><br>     1291-&gt;U:  <span style="background-color: yellow"> 99+                  break;</span><br>     1292-&gt;N:  <span style="background-color: white">              }</span><br>     1293-&gt;N:  <span style="background-color: white">      </span><br>  1294-&gt;1242:  <span style="background-color: cyan"> 99+          if (getFirstLetterStyle() != null) {</span><br>     1295-&gt;U:  <span style="background-color: yellow">   0              c.setFirstLettersTracker(</span><br>     1296-&gt;U:  <span style="background-color: yellow">                      c.getFirstLettersTracker().withOutLast());</span><br>     1297-&gt;N:  <span style="background-color: white">              }</span><br>  1298-&gt;1245:  <span style="background-color: cyan"> 99+          if (getFirstLineStyle() != null) {</span><br>     1299-&gt;U:  <span style="background-color: yellow">   0              c.setFirstLinesTracker(</span><br>     1300-&gt;U:  <span style="background-color: yellow">                      c.getFirstLinesTracker().withOutLast());</span><br>     1301-&gt;N:  <span style="background-color: white">              }</span><br>     1302-&gt;N:  <span style="background-color: white">      </span><br>  1303-&gt;1249:  <span style="background-color: cyan"> 99+          setState(Box.DONE);</span><br>     1304-&gt;N:  <span style="background-color: white">          }</span><br>     1305-&gt;N:  <span style="background-color: white">      </span><br>  1306-&gt;1252:  <span style="background-color: cyan"> 99+      protected void layoutInlineChildren(</span><br>  1307-&gt;1253:  <span style="background-color: white">                  LayoutContext c, int contentStart, int breakAtLine, boolean tryAgain) {</span><br>  1308-&gt;1254:  <span style="background-color: cyan"> 99+          InlineBoxing.layoutContent(c, this, contentStart, breakAtLine);</span><br>     1309-&gt;N:  <span style="background-color: white">      </span><br>  1310-&gt;1256:  <span style="background-color: cyan"> 99+          if (c.isPrint() &amp;&amp; c.isPageBreaksAllowed() &amp;&amp; getChildCount() &gt; 1) {</span><br>  1311-&gt;1257:  <span style="background-color: red"> 99+              satisfyWidowsAndOrphans(c, contentStart, tryAgain);</span><br>     1312-&gt;N:  <span style="background-color: white">              }</span><br>     1313-&gt;N:  <span style="background-color: white">      </span><br>  1314-&gt;1260:  <span style="background-color: cyan"> 99+          if (tryAgain &amp;&amp; (getStyle().isTextJustify())) {</span><br>  1315-&gt;1261:  <span style="background-color: white">  57              justifyText(c);</span><br>     1316-&gt;N:  <span style="background-color: white">              }</span><br>     1317-&gt;N:  <span style="background-color: white">          }</span><br>     1318-&gt;N:  <span style="background-color: white">      </span><br>  1319-&gt;1265:  <span style="background-color: white">  57      private void justifyText(LayoutContext c) {</span><br>  1320-&gt;1266:  <span style="background-color: white"> 99+          for (Iterator
       <box>
         i = getChildIterator(); i.hasNext(); ) {
       </box></span><br>  1321-&gt;1267:  <span style="background-color: white"> 99+              LineBox line = (LineBox)i.next();</span><br>  1322-&gt;1268:  <span style="background-color: white"> 99+              line.justify(c);</span><br>     1323-&gt;N:  <span style="background-color: white">              }</span><br>     1324-&gt;N:  <span style="background-color: white">          }</span><br>     1325-&gt;N:  <span style="background-color: white">      </span><br>     1326-&gt;N:  <span style="background-color: white">          /**</span><br>     1327-&gt;N:  <span style="background-color: white">           * TERMINOLOGY:</span><br>     1328-&gt;N:  <span style="background-color: white">           * Orphans refers to the number of lines of content in this</span><br>     1329-&gt;N:  <span style="background-color: white">           * box before the first page break.</span><br>     1330-&gt;N:  <span style="background-color: white">           * Widows refers to the number of lines of content on the last page.</span><br>     1331-&gt;N:  <span style="background-color: white">           * <br><br></span><br>     1332-&gt;N:  <span style="background-color: white">           * METHOD AIM:</span><br>     1333-&gt;N:  <span style="background-color: white">           * This method aims (but can not guarantee) to satisfy the <code>orphans</code> and</span><br>     1334-&gt;N:  <span style="background-color: white">           * <code>widows</code> CSS properties. Each of these provide a number</span><br>     1335-&gt;N:  <span style="background-color: white">           * specifying a minimum number of content lines.</span><br>     1336-&gt;N:  <span style="background-color: white">           * <br><br></span><br>     1337-&gt;N:  <span style="background-color: white">           * HOW:</span><br>     1338-&gt;N:  <span style="background-color: white">           * By inserting page breaks, either before this box or between certain</span><br>     1339-&gt;N:  <span style="background-color: white">           * lines in this box.</span><br>     1340-&gt;N:  <span style="background-color: white">           * <br><br></span><br>     1341-&gt;N:  <span style="background-color: white">           * PREREQUISITES:</span><br>     1342-&gt;N:  <span style="background-color: white">           * That the content of this box is <code>CONTENT_INLINE</code> and layout has</span><br>     1343-&gt;N:  <span style="background-color: white">           * been done on this box. This means that the children of this box will consist</span><br>     1344-&gt;N:  <span style="background-color: white">           * entirely of LineBox objects.</span><br>     1345-&gt;N:  <span style="background-color: white">           */</span><br>  1346-&gt;1272:  <span style="background-color: red"> 99+      private void satisfyWidowsAndOrphans(LayoutContext c, int contentStart, boolean tryAgain) {</span><br>     1347-&gt;U:  <span style="background-color: yellow"> 99+          int orphans = (int) getStyle().asFloat(CSSName.ORPHANS);</span><br>     1348-&gt;U:  <span style="background-color: yellow"> 99+          int widows = (int) getStyle().asFloat(CSSName.WIDOWS);</span><br>     1349-&gt;N:  <span style="background-color: white">      </span><br>     1350-&gt;U:  <span style="background-color: yellow"> 99+          if (orphans == 0 &amp;&amp; widows == 0) {</span><br>     1351-&gt;U:  <span style="background-color: yellow">  72              return;</span><br>     1352-&gt;U:  <span style="background-color: yellow">              }</span><br>     1353-&gt;N:  <span style="background-color: white">      </span><br>  1354-&gt;1273:  <span style="background-color: red"> 99+          LineBox firstLineBox = (LineBox)getChild(0);</span><br>  1355-&gt;1274:  <span style="background-color: red"> 99+          PageBox firstPage = c.getRootLayer().getFirstPage(c, firstLineBox);</span><br>     1356-&gt;N:  <span style="background-color: white">      </span><br>  1357-&gt;1276:  <span style="background-color: red"> 99+          if (firstPage == null) {</span><br>  1358-&gt;1277:  <span style="background-color: white">   0              return;</span><br>     1359-&gt;N:  <span style="background-color: white">              }</span><br>     1360-&gt;N:  <span style="background-color: white">      </span><br>  1361-&gt;1280:  <span style="background-color: red"> 99+          int noContentLBs = 0;</span><br>  1362-&gt;1281:  <span style="background-color: red"> 99+          int i = 0;</span><br>  1363-&gt;1282:  <span style="background-color: red"> 99+          int cCount = getChildCount();</span><br>     1364-&gt;N:  <span style="background-color: white">      </span><br>     1365-&gt;N:  <span style="background-color: white">              // First count the number of lines on the first page.</span><br>  1366-&gt;1283:  <span style="background-color: cyan"> 99+          while (i &lt; cCount) {</span><br>  1367-&gt;1284:  <span style="background-color: cyan"> 99+              LineBox lB = (LineBox)getChild(i);</span><br>     1368-&gt;N:  <span style="background-color: white">      </span><br>     1369-&gt;U:  <span style="background-color: yellow"> 99+              if (lB.getAbsY() &gt;= firstPage.getBottom(c)) {</span><br>  1370-&gt;1286:  <span style="background-color: cyan"> 99+                  break;</span><br>     1371-&gt;N:  <span style="background-color: white">                  }</span><br>     1372-&gt;N:  <span style="background-color: white">      </span><br>  1373-&gt;1288:  <span style="background-color: cyan"> 99+              if (! lB.isContainsContent()) {</span><br>  1374-&gt;1289:  <span style="background-color: red"> 99+                  noContentLBs++;</span><br>     1375-&gt;N:  <span style="background-color: white">                  }</span><br>     1376-&gt;N:  <span style="background-color: white">      </span><br>  1377-&gt;1291:  <span style="background-color: cyan"> 99+              i++;</span><br>     1378-&gt;N:  <span style="background-color: white">              }</span><br>     1379-&gt;N:  <span style="background-color: white">      </span><br>     1380-&gt;N:  <span style="background-color: white">              // Check if all lines are on the one page.</span><br>  1381-&gt;1294:  <span style="background-color: red"> 99+          if (i != cCount) {</span><br>     1382-&gt;N:  <span style="background-color: white">      </span><br>  1383-&gt;1296:  <span style="background-color: cyan"> 99+              if (i - noContentLBs &lt; orphans) {</span><br>     1384-&gt;N:  <span style="background-color: white">                      // We don't have enough lines on first page.</span><br>  1385-&gt;1297:  <span style="background-color: red"> 99+                  setNeedPageClear(true);</span><br>     1386-&gt;N:  <span style="background-color: white">                  } else {</span><br>     1387-&gt;N:  <span style="background-color: white">                      // We have to check the last page for widows.</span><br>  1388-&gt;1299:  <span style="background-color: cyan"> 99+                  LineBox lastLineBox = (LineBox)getChild(cCount-1);</span><br>     1389-&gt;U:  <span style="background-color: yellow"> 99+                  PageBox lastPage = c.getRootLayer().getFirstPage(c, lastLineBox.getAbsY());</span><br>     1390-&gt;N:  <span style="background-color: white">      </span><br>  1391-&gt;1307:  <span style="background-color: cyan"> 99+                  noContentLBs = 0;</span><br>  1392-&gt;1308:  <span style="background-color: cyan"> 99+                  i = cCount - 1;</span><br>     1393-&gt;U:  <span style="background-color: yellow"> 99+                  int lastPageLineCount = 0;</span><br>     1394-&gt;N:  <span style="background-color: white">      </span><br>     1395-&gt;N:  <span style="background-color: white">                      // Going backwards, count lines on the last page.</span><br>     1396-&gt;U:  <span style="background-color: yellow"> 99+                  while (i &gt;= 0) {</span><br>  1397-&gt;1310:  <span style="background-color: red"> 99+                      LineBox lB = (LineBox) getChild(i);</span><br>     1398-&gt;N:  <span style="background-color: white">      </span><br>  1399-&gt;1311:  <span style="background-color: red"> 99+                      if (lB.getAbsY() &lt; lastPage.getTop()) {</span><br>  1400-&gt;1312:  <span style="background-color: cyan"> 99+                          break;</span><br>     1401-&gt;N:  <span style="background-color: white">                          }</span><br>     1402-&gt;N:  <span style="background-color: white">      </span><br>  1403-&gt;1314:  <span style="background-color: red"> 99+                      if (! lB.isContainsContent()) {</span><br>  1404-&gt;1315:  <span style="background-color: cyan"> 99+                          noContentLBs++;</span><br>     1405-&gt;N:  <span style="background-color: white">                          }</span><br>     1406-&gt;N:  <span style="background-color: white">      </span><br>  1407-&gt;1317:  <span style="background-color: red"> 99+                      i--;</span><br>     1408-&gt;U:  <span style="background-color: yellow"> 99+                      lastPageLineCount++;</span><br>     1409-&gt;N:  <span style="background-color: white">                      }</span><br>     1410-&gt;N:  <span style="background-color: white">      </span><br>     1411-&gt;U:  <span style="background-color: yellow"> 99+                  lastPageLineCount -= noContentLBs;</span><br>     1412-&gt;N:  <span style="background-color: white">      </span><br>     1413-&gt;U:  <span style="background-color: yellow"> 99+                  if (lastPageLineCount &lt; widows) {</span><br>     1414-&gt;N:  <span style="background-color: white">                          // We don't have enough lines on last page.</span><br>     1415-&gt;N:  <span style="background-color: white">      </span><br>  1416-&gt;1322:  <span style="background-color: red"> 99+                      if (cCount - 1 - widows &lt; orphans) {</span><br>     1417-&gt;N:  <span style="background-color: white">                              // If adding a page break to satisfy widows property would</span><br>     1418-&gt;N:  <span style="background-color: white">                              // break orphans constraint insert a page break at start.</span><br>  1419-&gt;1323:  <span style="background-color: cyan">  16                          setNeedPageClear(true);</span><br>  1420-&gt;1324:  <span style="background-color: red"> 99+                      } else if (tryAgain) {</span><br>     1421-&gt;N:  <span style="background-color: white">                              // Else, if we are allowed, lay out our line boxes with</span><br>     1422-&gt;N:  <span style="background-color: white">                              // a page break inserted after breakAtLine.</span><br>  1423-&gt;1325:  <span style="background-color: red"> 99+                          int breakAtLine = cCount - 1 - widows;</span><br>     1424-&gt;N:  <span style="background-color: white">      </span><br>  1425-&gt;1327:  <span style="background-color: red"> 99+                          resetChildren(c);</span><br>     1426-&gt;N:  <span style="background-color: white"> 99+                          removeAllChildren();</span><br>     1427-&gt;N:  <span style="background-color: white">      </span><br>  1428-&gt;1330:  <span style="background-color: red"> 99+                          layoutInlineChildren(c, contentStart, breakAtLine, false);</span><br>     1429-&gt;N:  <span style="background-color: white">                          }</span><br>     1430-&gt;N:  <span style="background-color: white">                      }</span><br>     1431-&gt;N:  <span style="background-color: white">                  }</span><br>     1432-&gt;N:  <span style="background-color: white">              }</span><br>     1433-&gt;N:  <span style="background-color: white">          }</span><br>     1434-&gt;N:  <span style="background-color: white">      </span><br>     1435-&gt;N:  <span style="background-color: white">          /**</span><br>     1436-&gt;N:  <span style="background-color: white">           * See {@link ContentType}</span><br>     1437-&gt;N:  <span style="background-color: white">           */</span><br>     1438-&gt;U:  <span style="background-color: yellow"> 99+      public ContentType getChildrenContentType() {</span><br>     1439-&gt;N:  <span style="background-color: white"> 99+          return _childrenContentType;</span><br>     1440-&gt;N:  <span style="background-color: white">          }</span><br>     1441-&gt;N:  <span style="background-color: white">      </span><br>     1442-&gt;N:  <span style="background-color: white">          /**</span><br>     1443-&gt;N:  <span style="background-color: white">           * See {@link ContentType}</span><br>     1444-&gt;N:  <span style="background-color: white">           */</span><br>     1445-&gt;U:  <span style="background-color: yellow"> 99+      public void setChildrenContentType(ContentType contentType) {</span><br>  1446-&gt;1342:  <span style="background-color: cyan"> 99+          _childrenContentType = contentType;</span><br>     1447-&gt;N:  <span style="background-color: white">          }</span><br>     1448-&gt;N:  <span style="background-color: white">      </span><br>     1449-&gt;N:  <span style="background-color: white">          /**</span><br>     1450-&gt;N:  <span style="background-color: white">           * See {@link #setInlineContent(List)}</span><br>     1451-&gt;N:  <span style="background-color: white">           */</span><br>  1452-&gt;1345:  <span style="background-color: cyan"> 99+      public List
       <styleable>
         getInlineContent() {
       </styleable></span><br>     1453-&gt;N:  <span style="background-color: white"> 99+          return _inlineContent;</span><br>     1454-&gt;N:  <span style="background-color: white">          }</span><br>     1455-&gt;N:  <span style="background-color: white">      </span><br>     1456-&gt;N:  <span style="background-color: white">          /**</span><br>     1457-&gt;N:  <span style="background-color: white">           * Inline content is created by the box builder.</span><br>     1458-&gt;N:  <span style="background-color: white">           * It is important to note that the inline content here is stored in</span><br>     1459-&gt;N:  <span style="background-color: white">           * the pre-layout state. Ie. It has not been flowed out into</span><br>     1460-&gt;N:  <span style="background-color: white">           * {@link LineBox} and {@link InlineLayoutBox} objects but is stored</span><br>     1461-&gt;N:  <span style="background-color: white">           * as {@link InlineBox} and block boxes that are laid out inline such</span><br>     1462-&gt;N:  <span style="background-color: white">           * as inline-block and inline-table.</span><br>     1463-&gt;N:  <span style="background-color: white">           * <br><br></span><br>     1464-&gt;N:  <span style="background-color: white">           * During layout inline-content is laid out into lines and so on but</span><br>     1465-&gt;N:  <span style="background-color: white">           * the inline content is left untouched so as to be able to run layout</span><br>     1466-&gt;N:  <span style="background-color: white">           * multiple times to satisfy constraints.</span><br>     1467-&gt;N:  <span style="background-color: white">           * <br><br></span><br>     1468-&gt;N:  <span style="background-color: white">           * This method should be called with {@link #setChildrenContentType(ContentType)} set</span><br>     1469-&gt;N:  <span style="background-color: white">           * to {@link ContentType#INLINE} as block boxes can not contain mixed content.</span><br>     1470-&gt;N:  <span style="background-color: white">           */</span><br>  1471-&gt;1349:  <span style="background-color: cyan"> 99+      public void setInlineContent(List
       <styleable>
         inlineContent) {
       </styleable></span><br>  1472-&gt;1350:  <span style="background-color: cyan"> 99+          _inlineContent = inlineContent;</span><br>     1473-&gt;N:  <span style="background-color: white">      </span><br>  1474-&gt;1351:  <span style="background-color: cyan"> 99+          if (inlineContent != null) {</span><br>  1475-&gt;1352:  <span style="background-color: cyan"> 99+              for (Styleable child : inlineContent) {</span><br>  1476-&gt;1353:  <span style="background-color: cyan"> 99+                  if (child instanceof Box) {</span><br>  1477-&gt;1354:  <span style="background-color: cyan"> 99+                      ((Box) child).setContainingBlock(this);</span><br>     1478-&gt;N:  <span style="background-color: white">                      }</span><br>     1479-&gt;N:  <span style="background-color: white">                  }</span><br>     1480-&gt;N:  <span style="background-color: white">              }</span><br>     1481-&gt;N:  <span style="background-color: white">          }</span><br>     1482-&gt;N:  <span style="background-color: white">      </span><br>  1483-&gt;1360:  <span style="background-color: cyan"> 99+      protected boolean isSkipWhenCollapsingMargins() {</span><br>  1484-&gt;1361:  <span style="background-color: cyan"> 99+          return false;</span><br>     1485-&gt;N:  <span style="background-color: white">          }</span><br>     1486-&gt;N:  <span style="background-color: white">      </span><br>  1487-&gt;1364:  <span style="background-color: cyan"> 99+      protected boolean isMayCollapseMarginsWithChildren() {</span><br>     1488-&gt;N:  <span style="background-color: white"> 99+          return (! isRoot()) &amp;&amp; getStyle().isMayCollapseMarginsWithChildren();</span><br>     1489-&gt;N:  <span style="background-color: white">          }</span><br>     1490-&gt;N:  <span style="background-color: white">      </span><br>     1491-&gt;N:  <span style="background-color: white">          // This will require a rethink if we ever truly layout incrementally</span><br>     1492-&gt;N:  <span style="background-color: white">          // Should only ever collapse top margin and pick up collapsable</span><br>     1493-&gt;N:  <span style="background-color: white">          // bottom margins by looking back up the tree.</span><br>  1494-&gt;1371:  <span style="background-color: cyan"> 99+      protected void collapseMargins(LayoutContext c) {</span><br>     1495-&gt;N:  <span style="background-color: white"> 99+          if (! isTopMarginCalculated() || ! isBottomMarginCalculated()) {</span><br>  1496-&gt;1373:  <span style="background-color: cyan"> 99+              recalcMargin(c);</span><br>  1497-&gt;1374:  <span style="background-color: cyan"> 99+              RectPropertySet margin = getMargin(c);</span><br>     1498-&gt;N:  <span style="background-color: white">      </span><br>  1499-&gt;1376:  <span style="background-color: cyan"> 99+              if (! isTopMarginCalculated() &amp;&amp; ! isBottomMarginCalculated() &amp;&amp; isVerticalMarginsAdjoin(c)) {</span><br>  1500-&gt;1377:  <span style="background-color: cyan"> 99+                  MarginCollapseResult collapsedMargin =</span><br>  1501-&gt;1378:  <span style="background-color: cyan"> 99+                          _pendingCollapseCalculation != null ?</span><br>  1502-&gt;1379:  <span style="background-color: white">                                      _pendingCollapseCalculation : new MarginCollapseResult();</span><br>  1503-&gt;1380:  <span style="background-color: cyan"> 99+                  collapseEmptySubtreeMargins(c, collapsedMargin);</span><br>  1504-&gt;1381:  <span style="background-color: cyan"> 99+                  setCollapsedBottomMargin(c, margin, collapsedMargin);</span><br>     1505-&gt;N:  <span style="background-color: white">                  } else {</span><br>     1506-&gt;N:  <span style="background-color: white"> 99+                  if (! isTopMarginCalculated()) {</span><br>  1507-&gt;1384:  <span style="background-color: cyan"> 99+                      MarginCollapseResult collapsedMargin =</span><br>  1508-&gt;1385:  <span style="background-color: cyan"> 99+                              _pendingCollapseCalculation != null ?</span><br>  1509-&gt;1386:  <span style="background-color: white">                                          _pendingCollapseCalculation : new MarginCollapseResult();</span><br>     1510-&gt;N:  <span style="background-color: white">      </span><br>  1511-&gt;1388:  <span style="background-color: cyan"> 99+                      collapseTopMargin(c, true, collapsedMargin);</span><br>  1512-&gt;1389:  <span style="background-color: cyan"> 99+                      if ((int) margin.top() != collapsedMargin.getMargin()) {</span><br>  1513-&gt;1390:  <span style="background-color: cyan"> 99+                          setMarginTop(c, collapsedMargin.getMargin());</span><br>     1514-&gt;N:  <span style="background-color: white">                          }</span><br>     1515-&gt;N:  <span style="background-color: white">                      }</span><br>     1516-&gt;N:  <span style="background-color: white">      </span><br>     1517-&gt;N:  <span style="background-color: white"> 99+                  if (! isBottomMarginCalculated()) {</span><br>  1518-&gt;1395:  <span style="background-color: cyan"> 99+                      MarginCollapseResult collapsedMargin = new MarginCollapseResult();</span><br>  1519-&gt;1396:  <span style="background-color: cyan"> 99+                      collapseBottomMargin(c, true, collapsedMargin);</span><br>     1520-&gt;N:  <span style="background-color: white">      </span><br>  1521-&gt;1398:  <span style="background-color: cyan"> 99+                      setCollapsedBottomMargin(c, margin, collapsedMargin);</span><br>     1522-&gt;N:  <span style="background-color: white">                      }</span><br>     1523-&gt;N:  <span style="background-color: white">                  }</span><br>     1524-&gt;N:  <span style="background-color: white">              }</span><br>     1525-&gt;N:  <span style="background-color: white">          }</span><br>     1526-&gt;N:  <span style="background-color: white">      </span><br>  1527-&gt;1404:  <span style="background-color: cyan"> 99+      private void setCollapsedBottomMargin(LayoutContext c, RectPropertySet margin, MarginCollapseResult collapsedMargin) {</span><br>  1528-&gt;1405:  <span style="background-color: cyan"> 99+          BlockBox next = null;</span><br>     1529-&gt;N:  <span style="background-color: white"> 99+          if (! isInline()) {</span><br>  1530-&gt;1407:  <span style="background-color: cyan"> 99+              next = getNextCollapsableSibling(collapsedMargin);</span><br>     1531-&gt;N:  <span style="background-color: white">              }</span><br>  1532-&gt;1409:  <span style="background-color: cyan"> 99+          if (! (next == null || next instanceof AnonymousBlockBox) &amp;&amp;</span><br>  1533-&gt;1410:  <span style="background-color: white">                      collapsedMargin.hasMargin()) {</span><br>  1534-&gt;1411:  <span style="background-color: cyan"> 99+              next._pendingCollapseCalculation = collapsedMargin;</span><br>  1535-&gt;1412:  <span style="background-color: cyan"> 99+              setMarginBottom(c, 0);</span><br>  1536-&gt;1413:  <span style="background-color: cyan"> 99+          } else if ((int) margin.bottom() != collapsedMargin.getMargin()) {</span><br>  1537-&gt;1414:  <span style="background-color: cyan">  78              setMarginBottom(c, collapsedMargin.getMargin());</span><br>     1538-&gt;N:  <span style="background-color: white">              }</span><br>     1539-&gt;N:  <span style="background-color: white">          }</span><br>     1540-&gt;N:  <span style="background-color: white">      </span><br>  1541-&gt;1418:  <span style="background-color: cyan"> 99+      protected BlockBox getNextCollapsableSibling(MarginCollapseResult collapsedMargin) {</span><br>  1542-&gt;1419:  <span style="background-color: cyan"> 99+          BlockBox next = (BlockBox) getNextSibling();</span><br>  1543-&gt;1420:  <span style="background-color: red"> 99+          while (next != null) {</span><br>  1544-&gt;1421:  <span style="background-color: red"> 99+              if (next instanceof AnonymousBlockBox) {</span><br>  1545-&gt;1422:  <span style="background-color: cyan"> 99+                  ((AnonymousBlockBox) next).provideSiblingMarginToFloats(</span><br>  1546-&gt;1423:  <span style="background-color: white">                              collapsedMargin.getMargin());</span><br>     1547-&gt;N:  <span style="background-color: white">                  }</span><br>  1548-&gt;1425:  <span style="background-color: red"> 99+              if (! next.isSkipWhenCollapsingMargins()) {</span><br>  1549-&gt;1426:  <span style="background-color: cyan"> 99+                  break;</span><br>     1550-&gt;N:  <span style="background-color: white">                  } else {</span><br>  1551-&gt;1428:  <span style="background-color: red"> 99+                  next = (BlockBox) next.getNextSibling();</span><br>     1552-&gt;N:  <span style="background-color: white">                  }</span><br>     1553-&gt;N:  <span style="background-color: white">              }</span><br>  1554-&gt;1431:  <span style="background-color: cyan"> 99+          return next;</span><br>     1555-&gt;N:  <span style="background-color: white">          }</span><br>     1556-&gt;N:  <span style="background-color: white">      </span><br>  1557-&gt;1434:  <span style="background-color: cyan"> 99+      private void collapseTopMargin(</span><br>  1558-&gt;1435:  <span style="background-color: white">                  LayoutContext c, boolean calculationRoot, MarginCollapseResult result) {</span><br>     1559-&gt;N:  <span style="background-color: white"> 99+          if (! isTopMarginCalculated()) {</span><br>     1560-&gt;N:  <span style="background-color: white"> 99+              if (! isSkipWhenCollapsingMargins()) {</span><br>  1561-&gt;1438:  <span style="background-color: cyan"> 99+                  calcDimensions(c);</span><br>  1562-&gt;1439:  <span style="background-color: cyan"> 99+                  if (c.isPrint() &amp;&amp; getStyle().isDynamicAutoWidthApplicable()) {</span><br>     1563-&gt;N:  <span style="background-color: white">                          // Force recalculation once box is positioned</span><br>  1564-&gt;1441:  <span style="background-color: white">   0                      setDimensionsCalculated(false);</span><br>     1565-&gt;N:  <span style="background-color: white">                      }</span><br>  1566-&gt;1443:  <span style="background-color: cyan"> 99+                  RectPropertySet margin = getMargin(c);</span><br>  1567-&gt;1444:  <span style="background-color: cyan"> 99+                  result.update((int) margin.top());</span><br>     1568-&gt;N:  <span style="background-color: white">      </span><br>  1569-&gt;1446:  <span style="background-color: cyan"> 99+                  if (! calculationRoot &amp;&amp; (int) margin.top() != 0) {</span><br>  1570-&gt;1447:  <span style="background-color: white"> 99+                      setMarginTop(c, 0);</span><br>     1571-&gt;N:  <span style="background-color: white">                      }</span><br>     1572-&gt;N:  <span style="background-color: white">      </span><br>  1573-&gt;1450:  <span style="background-color: cyan"> 99+                  if (isMayCollapseMarginsWithChildren() &amp;&amp; isNoTopPaddingOrBorder(c)) {</span><br>  1574-&gt;1451:  <span style="background-color: cyan"> 99+                      ensureChildren(c);</span><br>     1575-&gt;U:  <span style="background-color: yellow"> 99+                      if (getChildrenContentType() == ContentType.BLOCK) {</span><br>  1576-&gt;1453:  <span style="background-color: cyan"> 99+                          for (Iterator
       <box>
         i = getChildIterator(); i.hasNext();) {
       </box></span><br>  1577-&gt;1454:  <span style="background-color: cyan"> 99+                              BlockBox child = (BlockBox) i.next();</span><br>  1578-&gt;1455:  <span style="background-color: cyan"> 99+                              child.collapseTopMargin(c, false, result);</span><br>     1579-&gt;N:  <span style="background-color: white">      </span><br>  1580-&gt;1457:  <span style="background-color: cyan"> 99+                              if (child.isSkipWhenCollapsingMargins()) {</span><br>  1581-&gt;1458:  <span style="background-color: white">  44                                  continue;</span><br>     1582-&gt;N:  <span style="background-color: white">                                  }</span><br>     1583-&gt;N:  <span style="background-color: white">      </span><br>  1584-&gt;1461:  <span style="background-color: cyan"> 99+                              break;</span><br>     1585-&gt;N:  <span style="background-color: white">                              }</span><br>     1586-&gt;N:  <span style="background-color: white">                          }</span><br>     1587-&gt;N:  <span style="background-color: white">                      }</span><br>     1588-&gt;N:  <span style="background-color: white">                  }</span><br>     1589-&gt;N:  <span style="background-color: white">      </span><br>  1590-&gt;1467:  <span style="background-color: cyan"> 99+              setTopMarginCalculated(true);</span><br>     1591-&gt;N:  <span style="background-color: white">              }</span><br>     1592-&gt;N:  <span style="background-color: white">          }</span><br>     1593-&gt;N:  <span style="background-color: white">      </span><br>  1594-&gt;1471:  <span style="background-color: cyan"> 99+      private void collapseBottomMargin(</span><br>  1595-&gt;1472:  <span style="background-color: white">                  LayoutContext c, boolean calculationRoot, MarginCollapseResult result) {</span><br>     1596-&gt;N:  <span style="background-color: white"> 99+          if (! isBottomMarginCalculated()) {</span><br>     1597-&gt;N:  <span style="background-color: white"> 99+              if (! isSkipWhenCollapsingMargins()) {</span><br>  1598-&gt;1475:  <span style="background-color: cyan"> 99+                  calcDimensions(c);</span><br>  1599-&gt;1476:  <span style="background-color: cyan"> 99+                  if (c.isPrint() &amp;&amp; getStyle().isDynamicAutoWidthApplicable()) {</span><br>     1600-&gt;N:  <span style="background-color: white">                          // Force recalculation once box is positioned</span><br>  1601-&gt;1478:  <span style="background-color: white">   0                      setDimensionsCalculated(false);</span><br>     1602-&gt;N:  <span style="background-color: white">                      }</span><br>  1603-&gt;1480:  <span style="background-color: cyan"> 99+                  RectPropertySet margin = getMargin(c);</span><br>  1604-&gt;1481:  <span style="background-color: cyan"> 99+                  result.update((int) margin.bottom());</span><br>     1605-&gt;N:  <span style="background-color: white">      </span><br>  1606-&gt;1483:  <span style="background-color: cyan"> 99+                  if (! calculationRoot &amp;&amp; (int) margin.bottom() != 0) {</span><br>  1607-&gt;1484:  <span style="background-color: cyan"> 99+                      setMarginBottom(c, 0);</span><br>     1608-&gt;N:  <span style="background-color: white">                      }</span><br>     1609-&gt;N:  <span style="background-color: white">      </span><br>     1610-&gt;N:  <span style="background-color: white"> 99+                  if (isMayCollapseMarginsWithChildren() &amp;&amp;</span><br>  1611-&gt;1488:  <span style="background-color: white">                              ! getStyle().isTable() &amp;&amp; isNoBottomPaddingOrBorder(c)) {</span><br>  1612-&gt;1489:  <span style="background-color: cyan"> 99+                      ensureChildren(c);</span><br>     1613-&gt;U:  <span style="background-color: yellow"> 99+                      if (getChildrenContentType() == ContentType.BLOCK) {</span><br>  1614-&gt;1491:  <span style="background-color: cyan"> 99+                          for (int i = getChildCount() - 1; i &gt;= 0; i--) {</span><br>  1615-&gt;1492:  <span style="background-color: cyan"> 99+                              BlockBox child = (BlockBox) getChild(i);</span><br>     1616-&gt;N:  <span style="background-color: white">      </span><br>  1617-&gt;1494:  <span style="background-color: cyan"> 99+                              if (child.isSkipWhenCollapsingMargins()) {</span><br>  1618-&gt;1495:  <span style="background-color: cyan">   6                                  continue;</span><br>     1619-&gt;N:  <span style="background-color: white">                                  }</span><br>     1620-&gt;N:  <span style="background-color: white">      </span><br>  1621-&gt;1498:  <span style="background-color: cyan"> 99+                              child.collapseBottomMargin(c, false, result);</span><br>     1622-&gt;N:  <span style="background-color: white">      </span><br>  1623-&gt;1500:  <span style="background-color: cyan"> 99+                              break;</span><br>     1624-&gt;N:  <span style="background-color: white">                              }</span><br>     1625-&gt;N:  <span style="background-color: white">                          }</span><br>     1626-&gt;N:  <span style="background-color: white">                      }</span><br>     1627-&gt;N:  <span style="background-color: white">                  }</span><br>     1628-&gt;N:  <span style="background-color: white">      </span><br>  1629-&gt;1506:  <span style="background-color: cyan"> 99+              setBottomMarginCalculated(true);</span><br>     1630-&gt;N:  <span style="background-color: white">              }</span><br>     1631-&gt;N:  <span style="background-color: white">          }</span><br>     1632-&gt;N:  <span style="background-color: white">      </span><br>  1633-&gt;1510:  <span style="background-color: cyan"> 99+      private boolean isNoTopPaddingOrBorder(LayoutContext c) {</span><br>  1634-&gt;1511:  <span style="background-color: cyan"> 99+          RectPropertySet padding = getPadding(c);</span><br>  1635-&gt;1512:  <span style="background-color: cyan"> 99+          BorderPropertySet border = getBorder(c);</span><br>     1636-&gt;N:  <span style="background-color: white">      </span><br>  1637-&gt;1514:  <span style="background-color: cyan"> 99+          return (int) padding.top() == 0 &amp;&amp; (int) border.top() == 0;</span><br>     1638-&gt;N:  <span style="background-color: white">          }</span><br>     1639-&gt;N:  <span style="background-color: white">      </span><br>  1640-&gt;1517:  <span style="background-color: cyan"> 99+      private boolean isNoBottomPaddingOrBorder(LayoutContext c) {</span><br>  1641-&gt;1518:  <span style="background-color: cyan"> 99+          RectPropertySet padding = getPadding(c);</span><br>  1642-&gt;1519:  <span style="background-color: cyan"> 99+          BorderPropertySet border = getBorder(c);</span><br>     1643-&gt;N:  <span style="background-color: white">      </span><br>  1644-&gt;1521:  <span style="background-color: cyan"> 99+          return (int) padding.bottom() == 0 &amp;&amp; (int) border.bottom() == 0;</span><br>     1645-&gt;N:  <span style="background-color: white">          }</span><br>     1646-&gt;N:  <span style="background-color: white">      </span><br>  1647-&gt;1524:  <span style="background-color: cyan"> 99+      private void collapseEmptySubtreeMargins(LayoutContext c, MarginCollapseResult result) {</span><br>  1648-&gt;1525:  <span style="background-color: cyan"> 99+          RectPropertySet margin = getMargin(c);</span><br>  1649-&gt;1526:  <span style="background-color: cyan"> 99+          result.update((int) margin.top());</span><br>  1650-&gt;1527:  <span style="background-color: cyan"> 99+          result.update((int) margin.bottom());</span><br>     1651-&gt;N:  <span style="background-color: white">      </span><br>  1652-&gt;1529:  <span style="background-color: cyan"> 99+          setMarginTop(c, 0);</span><br>  1653-&gt;1530:  <span style="background-color: cyan"> 99+          setTopMarginCalculated(true);</span><br>  1654-&gt;1531:  <span style="background-color: cyan"> 99+          setMarginBottom(c, 0);</span><br>  1655-&gt;1532:  <span style="background-color: cyan"> 99+          setBottomMarginCalculated(true);</span><br>     1656-&gt;N:  <span style="background-color: white">      </span><br>  1657-&gt;1534:  <span style="background-color: cyan"> 99+          ensureChildren(c);</span><br>     1658-&gt;U:  <span style="background-color: yellow"> 99+          if (getChildrenContentType() == ContentType.BLOCK) {</span><br>  1659-&gt;1536:  <span style="background-color: white"> 99+              for (Iterator
       <box>
         i = getChildIterator(); i.hasNext();) {
       </box></span><br>  1660-&gt;1537:  <span style="background-color: white">  79                  BlockBox child = (BlockBox) i.next();</span><br>  1661-&gt;1538:  <span style="background-color: white">  79                  child.collapseEmptySubtreeMargins(c, result);</span><br>     1662-&gt;N:  <span style="background-color: white">                  }</span><br>     1663-&gt;N:  <span style="background-color: white">              }</span><br>     1664-&gt;N:  <span style="background-color: white">          }</span><br>     1665-&gt;N:  <span style="background-color: white">      </span><br>  1666-&gt;1543:  <span style="background-color: cyan"> 99+      private boolean isVerticalMarginsAdjoin(LayoutContext c) {</span><br>  1667-&gt;1544:  <span style="background-color: cyan"> 99+          CalculatedStyle style = getStyle();</span><br>     1668-&gt;N:  <span style="background-color: white">      </span><br>  1669-&gt;1546:  <span style="background-color: cyan"> 99+          BorderPropertySet borderWidth = style.getBorder(c);</span><br>  1670-&gt;1547:  <span style="background-color: cyan"> 99+          RectPropertySet padding = getPadding(c);</span><br>     1671-&gt;N:  <span style="background-color: white">      </span><br>  1672-&gt;1549:  <span style="background-color: cyan"> 99+          boolean bordersOrPadding =</span><br>  1673-&gt;1550:  <span style="background-color: white">                      (int) borderWidth.top() != 0 || (int) borderWidth.bottom() != 0 ||</span><br>  1674-&gt;1551:  <span style="background-color: white">                              (int) padding.top() != 0 || (int) padding.bottom() != 0;</span><br>     1675-&gt;N:  <span style="background-color: white">      </span><br>  1676-&gt;1553:  <span style="background-color: cyan"> 99+          if (bordersOrPadding) {</span><br>  1677-&gt;1554:  <span style="background-color: red"> 99+              return false;</span><br>     1678-&gt;N:  <span style="background-color: white">              }</span><br>     1679-&gt;N:  <span style="background-color: white">      </span><br>  1680-&gt;1557:  <span style="background-color: cyan"> 99+          ensureChildren(c);</span><br>     1681-&gt;U:  <span style="background-color: yellow"> 99+          if (getChildrenContentType() == ContentType.INLINE) {</span><br>  1682-&gt;1559:  <span style="background-color: cyan"> 99+              return false;</span><br>     1683-&gt;U:  <span style="background-color: yellow"> 99+          } else if (getChildrenContentType() == ContentType.BLOCK) {</span><br>  1684-&gt;1561:  <span style="background-color: cyan"> 99+              for (Iterator
       <box>
         i = getChildIterator(); i.hasNext();) {
       </box></span><br>  1685-&gt;1562:  <span style="background-color: cyan"> 99+                  BlockBox child = (BlockBox) i.next();</span><br>  1686-&gt;1563:  <span style="background-color: cyan"> 99+                  if (child.isSkipWhenCollapsingMargins() || ! child.isVerticalMarginsAdjoin(c)) {</span><br>  1687-&gt;1564:  <span style="background-color: cyan"> 99+                      return false;</span><br>     1688-&gt;N:  <span style="background-color: white">                      }</span><br>     1689-&gt;N:  <span style="background-color: white">                  }</span><br>     1690-&gt;N:  <span style="background-color: white">              }</span><br>     1691-&gt;N:  <span style="background-color: white">      </span><br>  1692-&gt;1569:  <span style="background-color: cyan"> 99+          return style.asFloat(CSSName.MIN_HEIGHT) == 0 &amp;&amp;</span><br>  1693-&gt;1570:  <span style="background-color: white">                      (isAutoHeight() || style.asFloat(CSSName.HEIGHT) == 0);</span><br>     1694-&gt;N:  <span style="background-color: white">          }</span><br>     1695-&gt;N:  <span style="background-color: white">      </span><br>  1696-&gt;1573:  <span style="background-color: cyan"> 99+      public boolean isTopMarginCalculated() {</span><br>     1697-&gt;N:  <span style="background-color: white"> 99+          return _topMarginCalculated;</span><br>     1698-&gt;N:  <span style="background-color: white">          }</span><br>     1699-&gt;N:  <span style="background-color: white">      </span><br>  1700-&gt;1577:  <span style="background-color: cyan"> 99+      public void setTopMarginCalculated(boolean topMarginCalculated) {</span><br>  1701-&gt;1578:  <span style="background-color: cyan"> 99+          _topMarginCalculated = topMarginCalculated;</span><br>     1702-&gt;N:  <span style="background-color: white">          }</span><br>     1703-&gt;N:  <span style="background-color: white">      </span><br>  1704-&gt;1581:  <span style="background-color: cyan"> 99+      public boolean isBottomMarginCalculated() {</span><br>     1705-&gt;N:  <span style="background-color: white"> 99+          return _bottomMarginCalculated;</span><br>     1706-&gt;N:  <span style="background-color: white">          }</span><br>     1707-&gt;N:  <span style="background-color: white">      </span><br>  1708-&gt;1585:  <span style="background-color: cyan"> 99+      public void setBottomMarginCalculated(boolean bottomMarginCalculated) {</span><br>  1709-&gt;1586:  <span style="background-color: cyan"> 99+          _bottomMarginCalculated = bottomMarginCalculated;</span><br>     1710-&gt;N:  <span style="background-color: white">          }</span><br>     1711-&gt;N:  <span style="background-color: white">      </span><br>  1712-&gt;1589:  <span style="background-color: cyan"> 99+      protected int getCSSWidth(CssContext c) {</span><br>  1713-&gt;1590:  <span style="background-color: cyan"> 99+          return getCSSWidth(c, false);</span><br>     1714-&gt;N:  <span style="background-color: white">          }</span><br>     1715-&gt;N:  <span style="background-color: white">      </span><br>  1716-&gt;1593:  <span style="background-color: cyan"> 99+      protected int getCSSWidth(CssContext c, boolean shrinkingToFit) {</span><br>     1717-&gt;N:  <span style="background-color: white"> 99+          if (! isAnonymous()) {</span><br>     1718-&gt;N:  <span style="background-color: white"> 99+              if (! getStyle().isAutoWidth()) {</span><br>  1719-&gt;1596:  <span style="background-color: cyan"> 99+                  if (shrinkingToFit &amp;&amp; ! getStyle().isAbsoluteWidth()) {</span><br>  1720-&gt;1597:  <span style="background-color: white"> 99+                      return -1;</span><br>     1721-&gt;N:  <span style="background-color: white">                      } else {</span><br>  1722-&gt;1599:  <span style="background-color: cyan"> 99+                      int result = (int) getStyle().getFloatPropertyProportionalWidth(</span><br>  1723-&gt;1600:  <span style="background-color: white">                                  CSSName.WIDTH, getContainingBlock().getContentWidth(), c);</span><br>  1724-&gt;1601:  <span style="background-color: cyan"> 99+                      return result &gt;= 0 ? result : -1;</span><br>     1725-&gt;N:  <span style="background-color: white">                      }</span><br>     1726-&gt;N:  <span style="background-color: white">                  }</span><br>     1727-&gt;N:  <span style="background-color: white">              }</span><br>     1728-&gt;N:  <span style="background-color: white">      </span><br>  1729-&gt;1606:  <span style="background-color: cyan"> 99+          return -1;</span><br>     1730-&gt;N:  <span style="background-color: white">          }</span><br>     1731-&gt;N:  <span style="background-color: white">      </span><br>  1732-&gt;1609:  <span style="background-color: white">   0      protected int getCSSFitToWidth(CssContext c) {</span><br>     1733-&gt;N:  <span style="background-color: white">   0          if (! isAnonymous()) {</span><br>  1734-&gt;1611:  <span style="background-color: white">   0              if (! getStyle().isIdent(CSSName.FS_FIT_IMAGES_TO_WIDTH, IdentValue.AUTO))</span><br>     1735-&gt;N:  <span style="background-color: white">                  {</span><br>  1736-&gt;1613:  <span style="background-color: white">   0                  int result = (int) getStyle().getFloatPropertyProportionalWidth(</span><br>  1737-&gt;1614:  <span style="background-color: white">                              CSSName.FS_FIT_IMAGES_TO_WIDTH, getContainingBlock().getContentWidth(), c);</span><br>  1738-&gt;1615:  <span style="background-color: white">   0                  return result &gt;= 0 ? result : -1;</span><br>     1739-&gt;N:  <span style="background-color: white">                  }</span><br>     1740-&gt;N:  <span style="background-color: white">              }</span><br>     1741-&gt;N:  <span style="background-color: white">      </span><br>  1742-&gt;1619:  <span style="background-color: white">   0          return -1;</span><br>     1743-&gt;N:  <span style="background-color: white">          }</span><br>     1744-&gt;N:  <span style="background-color: white">      </span><br>  1745-&gt;1622:  <span style="background-color: cyan"> 99+      protected int getCSSHeight(CssContext c) {</span><br>     1746-&gt;N:  <span style="background-color: white"> 99+          if (! isAnonymous()) {</span><br>     1747-&gt;N:  <span style="background-color: white"> 99+              if (! isAutoHeight()) {</span><br>  1748-&gt;1625:  <span style="background-color: cyan"> 99+                  if (getStyle().hasAbsoluteUnit(CSSName.HEIGHT)) {</span><br>  1749-&gt;1626:  <span style="background-color: cyan"> 99+                      return (int)getStyle().getFloatPropertyProportionalHeight(CSSName.HEIGHT, 0, c);</span><br>     1750-&gt;N:  <span style="background-color: white">                      } else {</span><br>     1751-&gt;N:  <span style="background-color: white"> 99+                      return (int)getStyle().getFloatPropertyProportionalHeight(</span><br>  1752-&gt;1629:  <span style="background-color: white">                                  CSSName.HEIGHT,</span><br>  1753-&gt;1630:  <span style="background-color: white">                                  ((BlockBox)getContainingBlock()).getCSSHeight(c),</span><br>  1754-&gt;1631:  <span style="background-color: white">                                  c);</span><br>     1755-&gt;N:  <span style="background-color: white">                      }</span><br>     1756-&gt;N:  <span style="background-color: white">                  }</span><br>     1757-&gt;N:  <span style="background-color: white">              }</span><br>     1758-&gt;N:  <span style="background-color: white">      </span><br>  1759-&gt;1636:  <span style="background-color: cyan"> 99+          return -1;</span><br>     1760-&gt;N:  <span style="background-color: white">          }</span><br>     1761-&gt;N:  <span style="background-color: white">      </span><br>  1762-&gt;1639:  <span style="background-color: cyan"> 99+      public boolean isAutoHeight() {</span><br>     1763-&gt;N:  <span style="background-color: white"> 99+          if (getStyle().isAutoHeight()) {</span><br>  1764-&gt;1641:  <span style="background-color: cyan"> 99+              return true;</span><br>  1765-&gt;1642:  <span style="background-color: cyan"> 99+          } else if (getStyle().hasAbsoluteUnit(CSSName.HEIGHT)) {</span><br>  1766-&gt;1643:  <span style="background-color: cyan"> 99+              return false;</span><br>     1767-&gt;N:  <span style="background-color: white">              } else {</span><br>     1768-&gt;N:  <span style="background-color: white">                  // We have a percentage height, defer to our block parent (if applicable)</span><br>  1769-&gt;1646:  <span style="background-color: white"> 99+              Box cb = getContainingBlock();</span><br>  1770-&gt;1647:  <span style="background-color: white"> 99+              if (cb.isStyled() &amp;&amp; (cb instanceof BlockBox)) {</span><br>  1771-&gt;1648:  <span style="background-color: white"> 99+                  return ((BlockBox)cb).isAutoHeight();</span><br>  1772-&gt;1649:  <span style="background-color: white">   3              } else return !(cb instanceof BlockBox) || !cb.isInitialContainingBlock();</span><br>     1773-&gt;N:  <span style="background-color: white">              }</span><br>     1774-&gt;N:  <span style="background-color: white">          }</span><br>     1775-&gt;N:  <span style="background-color: white">      </span><br>  1776-&gt;1653:  <span style="background-color: cyan"> 99+      private int getCSSMinWidth(CssContext c) {</span><br>  1777-&gt;1654:  <span style="background-color: cyan"> 99+          return getStyle().getMinWidth(c, getContainingBlockWidth());</span><br>     1778-&gt;N:  <span style="background-color: white">          }</span><br>     1779-&gt;N:  <span style="background-color: white">      </span><br>  1780-&gt;1657:  <span style="background-color: cyan"> 99+      private int getCSSMaxWidth(CssContext c) {</span><br>  1781-&gt;1658:  <span style="background-color: cyan"> 99+          return getStyle().getMaxWidth(c, getContainingBlockWidth());</span><br>     1782-&gt;N:  <span style="background-color: white">          }</span><br>     1783-&gt;N:  <span style="background-color: white">      </span><br>  1784-&gt;1661:  <span style="background-color: cyan"> 99+      private int getCSSMinHeight(CssContext c) {</span><br>  1785-&gt;1662:  <span style="background-color: cyan"> 99+          return getStyle().getMinHeight(c, getContainingBlockCSSHeight(c));</span><br>     1786-&gt;N:  <span style="background-color: white">          }</span><br>     1787-&gt;N:  <span style="background-color: white">      </span><br>  1788-&gt;1665:  <span style="background-color: white">  69      private int getCSSMaxHeight(CssContext c) {</span><br>  1789-&gt;1666:  <span style="background-color: white">  69          return getStyle().getMaxHeight(c, getContainingBlockCSSHeight(c));</span><br>     1790-&gt;N:  <span style="background-color: white">          }</span><br>     1791-&gt;N:  <span style="background-color: white">      </span><br>     1792-&gt;N:  <span style="background-color: white">          // Use only when the height of the containing block is required for</span><br>     1793-&gt;N:  <span style="background-color: white">          // resolving percentage values.  Does not represent the actual (resolved) height</span><br>     1794-&gt;N:  <span style="background-color: white">          // of the containing block.</span><br>  1795-&gt;1672:  <span style="background-color: cyan"> 99+      private int getContainingBlockCSSHeight(CssContext c) {</span><br>     1796-&gt;N:  <span style="background-color: white"> 99+          if (! getContainingBlock().isStyled() ||</span><br>     1797-&gt;N:  <span style="background-color: white">                      getContainingBlock().getStyle().isAutoHeight()) {</span><br>  1798-&gt;1675:  <span style="background-color: cyan"> 99+              return 0;</span><br>     1799-&gt;N:  <span style="background-color: white">              } else {</span><br>  1800-&gt;1677:  <span style="background-color: red"> 99+              if (getContainingBlock().getStyle().hasAbsoluteUnit(CSSName.HEIGHT)) {</span><br>     1801-&gt;N:  <span style="background-color: white"> 99+                  return (int) getContainingBlock().getStyle().getFloatPropertyProportionalTo(</span><br>  1802-&gt;1679:  <span style="background-color: white">                              CSSName.HEIGHT, 0, c);</span><br>     1803-&gt;N:  <span style="background-color: white">                  } else {</span><br>  1804-&gt;1681:  <span style="background-color: white">  17                  return 0;</span><br>     1805-&gt;N:  <span style="background-color: white">                  }</span><br>     1806-&gt;N:  <span style="background-color: white">              }</span><br>     1807-&gt;N:  <span style="background-color: white">          }</span><br>     1808-&gt;N:  <span style="background-color: white">      </span><br>  1809-&gt;1686:  <span style="background-color: cyan"> 99+      private int calcShrinkToFitWidth(LayoutContext c) {</span><br>  1810-&gt;1687:  <span style="background-color: cyan"> 99+          calcMinMaxWidth(c);</span><br>     1811-&gt;N:  <span style="background-color: white">      </span><br>  1812-&gt;1689:  <span style="background-color: cyan"> 99+          return Math.min(Math.max(getMinWidth(), getAvailableWidth(c)), getMaxWidth());</span><br>     1813-&gt;N:  <span style="background-color: white">          }</span><br>     1814-&gt;N:  <span style="background-color: white">      </span><br>  1815-&gt;1692:  <span style="background-color: cyan"> 99+      protected int getAvailableWidth(LayoutContext c) {</span><br>     1816-&gt;N:  <span style="background-color: white"> 99+          if (! getStyle().isAbsolute()) {</span><br>     1817-&gt;N:  <span style="background-color: white"> 99+              return getContainingBlockWidth();</span><br>     1818-&gt;N:  <span style="background-color: white">              } else {</span><br>  1819-&gt;1696:  <span style="background-color: cyan"> 99+              int left = 0;</span><br>  1820-&gt;1697:  <span style="background-color: cyan"> 99+              int right = 0;</span><br>  1821-&gt;1698:  <span style="background-color: cyan"> 99+              if (! getStyle().isIdent(CSSName.LEFT, IdentValue.AUTO)) {</span><br>  1822-&gt;1699:  <span style="background-color: white">   4                  left =</span><br>  1823-&gt;1700:  <span style="background-color: white">                              (int) getStyle().getFloatPropertyProportionalTo(CSSName.LEFT,</span><br>  1824-&gt;1701:  <span style="background-color: white">                                      getContainingBlock().getContentWidth(), c);</span><br>     1825-&gt;N:  <span style="background-color: white">                  }</span><br>     1826-&gt;N:  <span style="background-color: white">      </span><br>  1827-&gt;1704:  <span style="background-color: cyan"> 99+              if (! getStyle().isIdent(CSSName.RIGHT, IdentValue.AUTO)) {</span><br>  1828-&gt;1705:  <span style="background-color: white">   1                  right =</span><br>  1829-&gt;1706:  <span style="background-color: white">                              (int) getStyle().getFloatPropertyProportionalTo(CSSName.RIGHT,</span><br>  1830-&gt;1707:  <span style="background-color: white">                                      getContainingBlock().getContentWidth(), c);</span><br>     1831-&gt;N:  <span style="background-color: white">                  }</span><br>     1832-&gt;N:  <span style="background-color: white">      </span><br>  1833-&gt;1710:  <span style="background-color: cyan"> 99+              return getContainingBlock().getPaddingWidth(c) - left - right;</span><br>     1834-&gt;N:  <span style="background-color: white">              }</span><br>     1835-&gt;N:  <span style="background-color: white">          }</span><br>     1836-&gt;N:  <span style="background-color: white">      </span><br>  1837-&gt;1714:  <span style="background-color: cyan"> 99+      protected boolean isFixedWidthAdvisoryOnly() {</span><br>  1838-&gt;1715:  <span style="background-color: cyan"> 99+          return false;</span><br>     1839-&gt;N:  <span style="background-color: white">          }</span><br>     1840-&gt;N:  <span style="background-color: white">      </span><br>     1841-&gt;N:  <span style="background-color: white">      </span><br>  1842-&gt;1719:  <span style="background-color: cyan"> 99+      private void recalcMargin(LayoutContext c) {</span><br>     1843-&gt;N:  <span style="background-color: white"> 99+          if (isTopMarginCalculated() &amp;&amp; isBottomMarginCalculated()) {</span><br>  1844-&gt;1721:  <span style="background-color: cyan"> 99+              return;</span><br>     1845-&gt;N:  <span style="background-color: white">              }</span><br>     1846-&gt;N:  <span style="background-color: white">      </span><br>     1847-&gt;N:  <span style="background-color: white">              // Check if we're a potential candidate upfront to avoid expensive</span><br>     1848-&gt;N:  <span style="background-color: white">              // getStyleMargin(c, false) call</span><br>  1849-&gt;1726:  <span style="background-color: cyan"> 99+          FSDerivedValue topMargin = getStyle().valueByName(CSSName.MARGIN_TOP);</span><br>  1850-&gt;1727:  <span style="background-color: cyan"> 99+          boolean resetTop = topMargin instanceof LengthValue &amp;&amp; ! topMargin.hasAbsoluteUnit();</span><br>     1851-&gt;N:  <span style="background-color: white">      </span><br>  1852-&gt;1729:  <span style="background-color: cyan"> 99+          FSDerivedValue bottomMargin = getStyle().valueByName(CSSName.MARGIN_BOTTOM);</span><br>  1853-&gt;1730:  <span style="background-color: cyan"> 99+          boolean resetBottom = bottomMargin instanceof LengthValue &amp;&amp; ! bottomMargin.hasAbsoluteUnit();</span><br>     1854-&gt;N:  <span style="background-color: white">      </span><br>  1855-&gt;1732:  <span style="background-color: cyan"> 99+          if (! resetTop &amp;&amp; ! resetBottom) {</span><br>  1856-&gt;1733:  <span style="background-color: cyan"> 99+              return;</span><br>     1857-&gt;N:  <span style="background-color: white">              }</span><br>     1858-&gt;N:  <span style="background-color: white">      </span><br>  1859-&gt;1736:  <span style="background-color: white">   0          RectPropertySet styleMargin = getStyleMargin(c, false);</span><br>  1860-&gt;1737:  <span style="background-color: white">   0          RectPropertySet workingMargin = getMargin(c);</span><br>     1861-&gt;N:  <span style="background-color: white">      </span><br>     1862-&gt;N:  <span style="background-color: white">              // A shrink-to-fit calculation may have set incorrect values for</span><br>     1863-&gt;N:  <span style="background-color: white">              // percentage margins (as the containing block width</span><br>     1864-&gt;N:  <span style="background-color: white">              // hasn't been calculated yet).  Reset top and bottom margins</span><br>     1865-&gt;N:  <span style="background-color: white">              // in this case.</span><br>     1866-&gt;N:  <span style="background-color: white">   0          if (! isTopMarginCalculated() &amp;&amp;</span><br>  1867-&gt;1744:  <span style="background-color: white">                      styleMargin.top() != workingMargin.top()) {</span><br>  1868-&gt;1745:  <span style="background-color: white">   0              setMarginTop(c, (int) styleMargin.top());</span><br>     1869-&gt;N:  <span style="background-color: white">              }</span><br>     1870-&gt;N:  <span style="background-color: white">      </span><br>     1871-&gt;N:  <span style="background-color: white">   0          if (! isBottomMarginCalculated() &amp;&amp;</span><br>  1872-&gt;1749:  <span style="background-color: white">                      styleMargin.bottom() != workingMargin.bottom()) {</span><br>  1873-&gt;1750:  <span style="background-color: white">   0              setMarginBottom(c, (int) styleMargin.bottom());</span><br>     1874-&gt;N:  <span style="background-color: white">              }</span><br>     1875-&gt;N:  <span style="background-color: white">          }</span><br>     1876-&gt;N:  <span style="background-color: white">      </span><br>  1877-&gt;1754:  <span style="background-color: cyan"> 99+      public void calcMinMaxWidth(LayoutContext c) {</span><br>     1878-&gt;N:  <span style="background-color: white"> 99+          if (! isMinMaxCalculated()) {</span><br>  1879-&gt;1756:  <span style="background-color: cyan"> 99+              RectPropertySet margin = getMargin(c);</span><br>  1880-&gt;1757:  <span style="background-color: cyan"> 99+              BorderPropertySet border = getBorder(c);</span><br>  1881-&gt;1758:  <span style="background-color: cyan"> 99+              RectPropertySet padding = getPadding(c);</span><br>     1882-&gt;N:  <span style="background-color: white">      </span><br>  1883-&gt;1760:  <span style="background-color: cyan"> 99+              int width = getCSSWidth(c, true);</span><br>     1884-&gt;N:  <span style="background-color: white">      </span><br>  1885-&gt;1762:  <span style="background-color: cyan"> 99+              createReplaced(c);</span><br>  1886-&gt;1763:  <span style="background-color: cyan"> 99+              if (isReplaced() &amp;&amp; width == -1) {</span><br>     1887-&gt;N:  <span style="background-color: white">                      // FIXME: We need to special case this for issue 313.</span><br>  1888-&gt;1765:  <span style="background-color: cyan">  19                  width = getContentWidth();</span><br>     1889-&gt;N:  <span style="background-color: white">                  }</span><br>     1890-&gt;N:  <span style="background-color: white">       </span><br>  1891-&gt;1768:  <span style="background-color: cyan"> 99+              if (width != -1 &amp;&amp; !isFixedWidthAdvisoryOnly()) {</span><br>     1892-&gt;N:  <span style="background-color: white"> 99+                  _minWidth = _maxWidth =</span><br>  1893-&gt;1770:  <span style="background-color: white">                              (int) margin.left() + (int) border.left() + (int) padding.left() +</span><br>  1894-&gt;1771:  <span style="background-color: white">                                      width +</span><br>  1895-&gt;1772:  <span style="background-color: white">                                      (int) margin.right() + (int) border.right() + (int) padding.right();</span><br>     1896-&gt;N:  <span style="background-color: white">                  } else {</span><br>  1897-&gt;1774:  <span style="background-color: cyan"> 99+                  int cw = -1;</span><br>  1898-&gt;1775:  <span style="background-color: cyan"> 99+                  if (width != -1) {</span><br>     1899-&gt;N:  <span style="background-color: white">                          // Set a provisional content width on table cells so</span><br>     1900-&gt;N:  <span style="background-color: white">                          // percentage values resolve correctly (but save and reset</span><br>     1901-&gt;N:  <span style="background-color: white">                          // the existing value)</span><br>  1902-&gt;1779:  <span style="background-color: white">  53                      cw = getContentWidth();</span><br>  1903-&gt;1780:  <span style="background-color: white">  53                      setContentWidth(width);</span><br>     1904-&gt;N:  <span style="background-color: white">                      }</span><br>     1905-&gt;N:  <span style="background-color: white">      </span><br>     1906-&gt;N:  <span style="background-color: white"> 99+                  _minWidth = _maxWidth =</span><br>  1907-&gt;1784:  <span style="background-color: white">                              (int) margin.left() + (int) border.left() + (int) padding.left() +</span><br>  1908-&gt;1785:  <span style="background-color: white">                                      (int) margin.right() + (int) border.right() + (int) padding.right();</span><br>     1909-&gt;N:  <span style="background-color: white">      </span><br>  1910-&gt;1787:  <span style="background-color: cyan"> 99+                  int minimumMaxWidth = _maxWidth;</span><br>  1911-&gt;1788:  <span style="background-color: cyan"> 99+                  if (width != -1) {</span><br>  1912-&gt;1789:  <span style="background-color: white">  53                      minimumMaxWidth += width;</span><br>     1913-&gt;N:  <span style="background-color: white">                      }</span><br>     1914-&gt;N:  <span style="background-color: white">      </span><br>  1915-&gt;1792:  <span style="background-color: cyan"> 99+                  ensureChildren(c);</span><br>     1916-&gt;N:  <span style="background-color: white">      </span><br>     1917-&gt;U:  <span style="background-color: yellow"> 99+                  if (getChildrenContentType() == ContentType.BLOCK) {</span><br>     1918-&gt;U:  <span style="background-color: yellow"> 99+                      calcMinMaxWidthBlockChildren(c);</span><br>     1919-&gt;U:  <span style="background-color: yellow"> 99+                  } else if (getChildrenContentType() == ContentType.INLINE) {</span><br>     1920-&gt;U:  <span style="background-color: yellow"> 99+                      calcMinMaxWidthInlineChildren(c);</span><br>     1921-&gt;U:  <span style="background-color: yellow">                      }</span><br>     1922-&gt;N:  <span style="background-color: white">      </span><br>  1923-&gt;1806:  <span style="background-color: cyan"> 99+                  if (minimumMaxWidth &gt; _maxWidth) {</span><br>  1924-&gt;1807:  <span style="background-color: white">  53                      _maxWidth = minimumMaxWidth;</span><br>     1925-&gt;N:  <span style="background-color: white">                      }</span><br>     1926-&gt;N:  <span style="background-color: white">      </span><br>  1927-&gt;1810:  <span style="background-color: cyan"> 99+                  if (cw != -1) {</span><br>  1928-&gt;1811:  <span style="background-color: white">  53                      setContentWidth(cw);</span><br>     1929-&gt;N:  <span style="background-color: white">                      }</span><br>     1930-&gt;N:  <span style="background-color: white">                  }</span><br>     1931-&gt;N:  <span style="background-color: white">      </span><br>     1932-&gt;N:  <span style="background-color: white"> 99+              if (! isReplaced()) {</span><br>  1933-&gt;1816:  <span style="background-color: cyan"> 99+                  calcMinMaxCSSMinMaxWidth(c, margin, border, padding);</span><br>     1934-&gt;N:  <span style="background-color: white">                  }</span><br>  1935-&gt;1818:  <span style="background-color: cyan"> 99+              setMinMaxCalculated(true);</span><br>     1936-&gt;N:  <span style="background-color: white">              }</span><br>     1937-&gt;N:  <span style="background-color: white">          }</span><br>     1938-&gt;N:  <span style="background-color: white">      </span><br>  1939-&gt;1837:  <span style="background-color: cyan"> 99+      private void calcMinMaxCSSMinMaxWidth(</span><br>  1940-&gt;1838:  <span style="background-color: white">                  LayoutContext c, RectPropertySet margin, BorderPropertySet border,</span><br>  1941-&gt;1839:  <span style="background-color: white">                  RectPropertySet padding) {</span><br>  1942-&gt;1840:  <span style="background-color: cyan"> 99+          int cssMinWidth = getCSSMinWidth(c);</span><br>  1943-&gt;1841:  <span style="background-color: cyan"> 99+          if (cssMinWidth &gt; 0) {</span><br>  1944-&gt;1842:  <span style="background-color: white">  36              cssMinWidth +=</span><br>  1945-&gt;1843:  <span style="background-color: white">                          (int) margin.left() + (int) border.left() + (int) padding.left() +</span><br>  1946-&gt;1844:  <span style="background-color: white">                                  (int) margin.right() + (int) border.right() + (int) padding.right();</span><br>  1947-&gt;1845:  <span style="background-color: white">  36              if (_minWidth &lt; cssMinWidth) {</span><br>  1948-&gt;1846:  <span style="background-color: white">  34                  _minWidth = cssMinWidth;</span><br>     1949-&gt;N:  <span style="background-color: white">                  }</span><br>     1950-&gt;N:  <span style="background-color: white">              }</span><br>     1951-&gt;N:  <span style="background-color: white"> 99+          if (! getStyle().isMaxWidthNone()) {</span><br>  1952-&gt;1850:  <span style="background-color: white">   0              int cssMaxWidth = getCSSMaxWidth(c);</span><br>  1953-&gt;1851:  <span style="background-color: white">   0              cssMaxWidth +=</span><br>  1954-&gt;1852:  <span style="background-color: white">                          (int) margin.left() + (int) border.left() + (int) padding.left() +</span><br>  1955-&gt;1853:  <span style="background-color: white">                                  (int) margin.right() + (int) border.right() + (int) padding.right();</span><br>  1956-&gt;1854:  <span style="background-color: white">   0              if (_maxWidth &gt; cssMaxWidth) {</span><br>  1957-&gt;1855:  <span style="background-color: white">   0                  if (cssMaxWidth &gt; _minWidth) {</span><br>  1958-&gt;1856:  <span style="background-color: white">   0                      _maxWidth = cssMaxWidth;</span><br>     1959-&gt;N:  <span style="background-color: white">                      } else {</span><br>     1960-&gt;N:  <span style="background-color: white">   0                      _maxWidth = _minWidth;</span><br>     1961-&gt;N:  <span style="background-color: white">                      }</span><br>     1962-&gt;N:  <span style="background-color: white">                  }</span><br>     1963-&gt;N:  <span style="background-color: white">              }</span><br>     1964-&gt;N:  <span style="background-color: white">          }</span><br>     1965-&gt;N:  <span style="background-color: white">      </span><br>  1966-&gt;1864:  <span style="background-color: cyan"> 99+      private void calcMinMaxWidthBlockChildren(LayoutContext c) {</span><br>  1967-&gt;1865:  <span style="background-color: cyan"> 99+          int childMinWidth = 0;</span><br>  1968-&gt;1866:  <span style="background-color: cyan"> 99+          int childMaxWidth = 0;</span><br>     1969-&gt;N:  <span style="background-color: white">      </span><br>  1970-&gt;1868:  <span style="background-color: cyan"> 99+          for (Iterator
       <box>
         i = getChildIterator(); i.hasNext();) {
       </box></span><br>  1971-&gt;1869:  <span style="background-color: cyan"> 99+              BlockBox child = (BlockBox) i.next();</span><br>  1972-&gt;1870:  <span style="background-color: cyan"> 99+              child.calcMinMaxWidth(c);</span><br>  1973-&gt;1871:  <span style="background-color: cyan"> 99+              if (child.getMinWidth() &gt; childMinWidth) {</span><br>  1974-&gt;1872:  <span style="background-color: cyan"> 99+                  childMinWidth = child.getMinWidth();</span><br>     1975-&gt;N:  <span style="background-color: white">                  }</span><br>  1976-&gt;1874:  <span style="background-color: cyan"> 99+              if (child.getMaxWidth() &gt; childMaxWidth) {</span><br>  1977-&gt;1875:  <span style="background-color: cyan"> 99+                  childMaxWidth = child.getMaxWidth();</span><br>     1978-&gt;N:  <span style="background-color: white">                  }</span><br>     1979-&gt;N:  <span style="background-color: white">              }</span><br>     1980-&gt;N:  <span style="background-color: white">      </span><br>  1981-&gt;1879:  <span style="background-color: cyan"> 99+          _minWidth += childMinWidth;</span><br>  1982-&gt;1880:  <span style="background-color: cyan"> 99+          _maxWidth += childMaxWidth;</span><br>     1983-&gt;N:  <span style="background-color: white">          }</span><br>     1984-&gt;N:  <span style="background-color: white">      </span><br>  1985-&gt;1883:  <span style="background-color: cyan"> 99+      private void calcMinMaxWidthInlineChildren(LayoutContext c) {</span><br>  1986-&gt;1884:  <span style="background-color: cyan"> 99+          int textIndent = (int) getStyle().getFloatPropertyProportionalWidth(</span><br>  1987-&gt;1885:  <span style="background-color: white">                      CSSName.TEXT_INDENT, getContentWidth(), c);</span><br>     1988-&gt;N:  <span style="background-color: white">      </span><br>     1989-&gt;N:  <span style="background-color: white"> 99+          if (getStyle().isListItem() &amp;&amp; getStyle().isListMarkerInside()) {</span><br>  1990-&gt;1888:  <span style="background-color: white">   0              createMarkerData(c);</span><br>  1991-&gt;1889:  <span style="background-color: white">   0              textIndent += getMarkerData().getLayoutWidth();</span><br>     1992-&gt;N:  <span style="background-color: white">              }</span><br>     1993-&gt;N:  <span style="background-color: white">      </span><br>  1994-&gt;1892:  <span style="background-color: cyan"> 99+          int childMinWidth = 0;</span><br>  1995-&gt;1893:  <span style="background-color: cyan"> 99+          int childMaxWidth = 0;</span><br>  1996-&gt;1894:  <span style="background-color: cyan"> 99+          int lineWidth = 0;</span><br>     1997-&gt;N:  <span style="background-color: white">      </span><br>  1998-&gt;1896:  <span style="background-color: cyan"> 99+          InlineBox trimmableIB = null;</span><br>     1999-&gt;N:  <span style="background-color: white">      </span><br>  2000-&gt;1898:  <span style="background-color: cyan"> 99+          for (Styleable child : _inlineContent) {</span><br>  2001-&gt;1899:  <span style="background-color: cyan"> 99+              if (child.getStyle().isAbsolute() || child.getStyle().isFixed() || child.getStyle().isRunning()) {</span><br>  2002-&gt;1900:  <span style="background-color: cyan">  51                  continue;</span><br>     2003-&gt;N:  <span style="background-color: white">                  }</span><br>     2004-&gt;N:  <span style="background-color: white">      </span><br>  2005-&gt;1903:  <span style="background-color: cyan"> 99+              if (child.getStyle().isFloated() || child.getStyle().isInlineBlock() ||</span><br>  2006-&gt;1904:  <span style="background-color: white">                          child.getStyle().isInlineTable()) {</span><br>  2007-&gt;1905:  <span style="background-color: cyan"> 99+                  if (child.getStyle().isFloated() &amp;&amp; child.getStyle().isCleared()) {</span><br>  2008-&gt;1906:  <span style="background-color: white">   0                      if (trimmableIB != null) {</span><br>  2009-&gt;1907:  <span style="background-color: white">   0                          lineWidth -= trimmableIB.getTrailingSpaceWidth(c);</span><br>     2010-&gt;N:  <span style="background-color: white">                          }</span><br>  2011-&gt;1909:  <span style="background-color: white">   0                      if (lineWidth &gt; childMaxWidth) {</span><br>  2012-&gt;1910:  <span style="background-color: white">   0                          childMaxWidth = lineWidth;</span><br>     2013-&gt;N:  <span style="background-color: white">                          }</span><br>  2014-&gt;1912:  <span style="background-color: white">   0                      lineWidth = 0;</span><br>     2015-&gt;N:  <span style="background-color: white">                      }</span><br>  2016-&gt;1914:  <span style="background-color: cyan"> 99+                  trimmableIB = null;</span><br>  2017-&gt;1915:  <span style="background-color: cyan"> 99+                  BlockBox block = (BlockBox) child;</span><br>  2018-&gt;1916:  <span style="background-color: cyan"> 99+                  block.calcMinMaxWidth(c);</span><br>  2019-&gt;1917:  <span style="background-color: cyan"> 99+                  lineWidth += block.getMaxWidth();</span><br>  2020-&gt;1918:  <span style="background-color: cyan"> 99+                  if (block.getMinWidth() &gt; childMinWidth) {</span><br>  2021-&gt;1919:  <span style="background-color: cyan"> 99+                      childMinWidth = block.getMinWidth();</span><br>     2022-&gt;N:  <span style="background-color: white">                      }</span><br>     2023-&gt;N:  <span style="background-color: white">                  } else { /* child.getStyle().isInline() */</span><br>  2024-&gt;1922:  <span style="background-color: cyan"> 99+                  InlineBox iB = (InlineBox) child;</span><br>  2025-&gt;1923:  <span style="background-color: cyan"> 99+                  IdentValue whitespace = iB.getStyle().getWhitespace();</span><br>     2026-&gt;N:  <span style="background-color: white">      </span><br>  2027-&gt;1925:  <span style="background-color: cyan"> 99+                  iB.calcMinMaxWidth(c, getContentWidth(), lineWidth == 0);</span><br>     2028-&gt;N:  <span style="background-color: white">      </span><br>  2029-&gt;1927:  <span style="background-color: cyan"> 99+                  if (whitespace == IdentValue.NOWRAP) {</span><br>  2030-&gt;1928:  <span style="background-color: cyan">  28                      lineWidth += textIndent + iB.getMaxWidth();</span><br>  2031-&gt;1929:  <span style="background-color: cyan">  28                      if (iB.getMinWidth() &gt; childMinWidth) {</span><br>  2032-&gt;1930:  <span style="background-color: cyan">  26                          childMinWidth = iB.getMinWidth();</span><br>     2033-&gt;N:  <span style="background-color: white">                          }</span><br>  2034-&gt;1932:  <span style="background-color: cyan">  28                      trimmableIB = iB;</span><br>  2035-&gt;1933:  <span style="background-color: cyan"> 99+                  } else if (whitespace == IdentValue.PRE) {</span><br>  2036-&gt;1934:  <span style="background-color: cyan">  97                      if (trimmableIB != null) {</span><br>  2037-&gt;1935:  <span style="background-color: white">   0                          lineWidth -= trimmableIB.getTrailingSpaceWidth(c);</span><br>     2038-&gt;N:  <span style="background-color: white">                          }</span><br>  2039-&gt;1937:  <span style="background-color: cyan">  97                      trimmableIB = null;</span><br>  2040-&gt;1938:  <span style="background-color: cyan">  97                      if (lineWidth &gt; childMaxWidth) {</span><br>  2041-&gt;1939:  <span style="background-color: white">   0                          childMaxWidth = lineWidth;</span><br>     2042-&gt;N:  <span style="background-color: white">                          }</span><br>  2043-&gt;1941:  <span style="background-color: cyan">  97                      lineWidth = textIndent + iB.getFirstLineWidth();</span><br>  2044-&gt;1942:  <span style="background-color: cyan">  97                      if (lineWidth &gt; childMinWidth) {</span><br>  2045-&gt;1943:  <span style="background-color: cyan">  97                          childMinWidth = lineWidth;</span><br>     2046-&gt;N:  <span style="background-color: white">                          }</span><br>  2047-&gt;1945:  <span style="background-color: cyan">  97                      lineWidth = iB.getMaxWidth();</span><br>  2048-&gt;1946:  <span style="background-color: cyan">  97                      if (lineWidth &gt; childMinWidth) {</span><br>  2049-&gt;1947:  <span style="background-color: cyan">  95                          childMinWidth = lineWidth;</span><br>     2050-&gt;N:  <span style="background-color: white">                          }</span><br>  2051-&gt;1949:  <span style="background-color: cyan">  97                      if (childMinWidth &gt; childMaxWidth) {</span><br>  2052-&gt;1950:  <span style="background-color: cyan">  97                          childMaxWidth = childMinWidth;</span><br>     2053-&gt;N:  <span style="background-color: white">                          }</span><br>  2054-&gt;1952:  <span style="background-color: cyan">  97                      lineWidth = 0;</span><br>  2055-&gt;1953:  <span style="background-color: cyan"> 99+                  } else if (whitespace == IdentValue.PRE_WRAP || whitespace == IdentValue.PRE_LINE) {</span><br>  2056-&gt;1954:  <span style="background-color: cyan"> 99+                      lineWidth += textIndent + iB.getFirstLineWidth();</span><br>  2057-&gt;1955:  <span style="background-color: cyan"> 99+                      if (trimmableIB != null) {</span><br>  2058-&gt;1956:  <span style="background-color: cyan"> 99+                          lineWidth -= trimmableIB.getTrailingSpaceWidth(c);</span><br>     2059-&gt;N:  <span style="background-color: white">                          }</span><br>  2060-&gt;1958:  <span style="background-color: cyan"> 99+                      if (lineWidth &gt; childMaxWidth) {</span><br>  2061-&gt;1959:  <span style="background-color: cyan"> 99+                          childMaxWidth = lineWidth;</span><br>     2062-&gt;N:  <span style="background-color: white">                          }</span><br>     2063-&gt;N:  <span style="background-color: white">      </span><br>  2064-&gt;1962:  <span style="background-color: cyan"> 99+                      if (iB.getMaxWidth() &gt; childMaxWidth) {</span><br>  2065-&gt;1963:  <span style="background-color: white">  54                          childMaxWidth = iB.getMaxWidth();</span><br>     2066-&gt;N:  <span style="background-color: white">                          }</span><br>  2067-&gt;1965:  <span style="background-color: cyan"> 99+                      if (iB.getMinWidth() &gt; childMinWidth) {</span><br>  2068-&gt;1966:  <span style="background-color: white">  69                          childMinWidth = iB.getMinWidth();</span><br>     2069-&gt;N:  <span style="background-color: white">                          }</span><br>  2070-&gt;1968:  <span style="background-color: cyan"> 99+                      if (whitespace == IdentValue.PRE_LINE) {</span><br>  2071-&gt;1969:  <span style="background-color: cyan"> 99+                          trimmableIB = iB;</span><br>     2072-&gt;N:  <span style="background-color: white">                          } else {</span><br>  2073-&gt;1971:  <span style="background-color: white">  78                          trimmableIB = null;</span><br>     2074-&gt;N:  <span style="background-color: white">                          }</span><br>  2075-&gt;1973:  <span style="background-color: cyan"> 99+                      lineWidth = 0;</span><br>     2076-&gt;N:  <span style="background-color: white">                      } else /* if (whitespace == IdentValue.NORMAL) */ {</span><br>  2077-&gt;1975:  <span style="background-color: cyan"> 99+                      lineWidth += textIndent + iB.getMaxWidth();</span><br>  2078-&gt;1976:  <span style="background-color: cyan"> 99+                      if (iB.getMinWidth() &gt; childMinWidth) {</span><br>  2079-&gt;1977:  <span style="background-color: cyan"> 99+                          childMinWidth = textIndent + iB.getMinWidth();</span><br>     2080-&gt;N:  <span style="background-color: white">                          }</span><br>  2081-&gt;1979:  <span style="background-color: cyan"> 99+                      trimmableIB = iB;</span><br>     2082-&gt;N:  <span style="background-color: white">                      }</span><br>     2083-&gt;N:  <span style="background-color: white">      </span><br>  2084-&gt;1982:  <span style="background-color: cyan"> 99+                  if (textIndent &gt; 0) {</span><br>  2085-&gt;1983:  <span style="background-color: white">   1                      textIndent = 0;</span><br>     2086-&gt;N:  <span style="background-color: white">                      }</span><br>     2087-&gt;N:  <span style="background-color: white">                  }</span><br>     2088-&gt;N:  <span style="background-color: white">              }</span><br>     2089-&gt;N:  <span style="background-color: white">      </span><br>  2090-&gt;1988:  <span style="background-color: cyan"> 99+          if (trimmableIB != null) {</span><br>  2091-&gt;1989:  <span style="background-color: cyan"> 99+              lineWidth -= trimmableIB.getTrailingSpaceWidth(c);</span><br>     2092-&gt;N:  <span style="background-color: white">              }</span><br>  2093-&gt;1991:  <span style="background-color: cyan"> 99+          if (lineWidth &gt; childMaxWidth) {</span><br>  2094-&gt;1992:  <span style="background-color: cyan"> 99+              childMaxWidth = lineWidth;</span><br>     2095-&gt;N:  <span style="background-color: white">              }</span><br>     2096-&gt;N:  <span style="background-color: white">      </span><br>  2097-&gt;1995:  <span style="background-color: cyan"> 99+          _minWidth += childMinWidth;</span><br>  2098-&gt;1996:  <span style="background-color: cyan"> 99+          _maxWidth += childMaxWidth;</span><br>     2099-&gt;N:  <span style="background-color: white">          }</span><br>     2100-&gt;N:  <span style="background-color: white">      </span><br>  2101-&gt;1999:  <span style="background-color: cyan"> 99+      public int getMaxWidth() {</span><br>     2102-&gt;N:  <span style="background-color: white"> 99+          return _maxWidth;</span><br>     2103-&gt;N:  <span style="background-color: white">          }</span><br>     2104-&gt;N:  <span style="background-color: white">      </span><br>  2105-&gt;2003:  <span style="background-color: cyan"> 99+      protected void setMaxWidth(int maxWidth) {</span><br>  2106-&gt;2004:  <span style="background-color: cyan"> 99+          _maxWidth = maxWidth;</span><br>     2107-&gt;N:  <span style="background-color: white">          }</span><br>     2108-&gt;N:  <span style="background-color: white">      </span><br>  2109-&gt;2007:  <span style="background-color: cyan"> 99+      public int getMinWidth() {</span><br>     2110-&gt;N:  <span style="background-color: white"> 99+          return _minWidth;</span><br>     2111-&gt;N:  <span style="background-color: white">          }</span><br>     2112-&gt;N:  <span style="background-color: white">      </span><br>  2113-&gt;2011:  <span style="background-color: cyan"> 99+      protected void setMinWidth(int minWidth) {</span><br>  2114-&gt;2012:  <span style="background-color: cyan"> 99+          _minWidth = minWidth;</span><br>     2115-&gt;N:  <span style="background-color: white">          }</span><br>     2116-&gt;N:  <span style="background-color: white">      </span><br>  2117-&gt;2015:  <span style="background-color: white">   0      public void styleText(LayoutContext c) {</span><br>  2118-&gt;2016:  <span style="background-color: white">   0          styleText(c, getStyle());</span><br>     2119-&gt;N:  <span style="background-color: white">          }</span><br>     2120-&gt;N:  <span style="background-color: white">      </span><br>     2121-&gt;N:  <span style="background-color: white">          // FIXME Should be expanded into generic restyle facility</span><br>  2122-&gt;2020:  <span style="background-color: white">   0      public void styleText(LayoutContext c, CalculatedStyle style) {</span><br>     2123-&gt;U:  <span style="background-color: yellow">   0          if (getChildrenContentType() == ContentType.INLINE) {</span><br>  2124-&gt;2022:  <span style="background-color: white">   0              LinkedList
       <calculatedstyle>
         styles = new LinkedList&lt;&gt;();
       </calculatedstyle></span><br>  2125-&gt;2023:  <span style="background-color: white">   0              styles.add(style);</span><br>  2126-&gt;2024:  <span style="background-color: white">   0              for (Object a_inlineContent : _inlineContent) {</span><br>  2127-&gt;2025:  <span style="background-color: white">   0                  Styleable child = (Styleable) a_inlineContent;</span><br>  2128-&gt;2026:  <span style="background-color: white">   0                  if (child instanceof InlineBox) {</span><br>  2129-&gt;2027:  <span style="background-color: white">   0                      InlineBox iB = (InlineBox) child;</span><br>     2130-&gt;N:  <span style="background-color: white">      </span><br>  2131-&gt;2029:  <span style="background-color: white">   0                      if (iB.isStartsHere()) {</span><br>  2132-&gt;2030:  <span style="background-color: white">   0                          CascadedStyle cs = null;</span><br>  2133-&gt;2031:  <span style="background-color: white">   0                          if (iB.getElement() != null) {</span><br>  2134-&gt;2032:  <span style="background-color: white">   0                              if (iB.getPseudoElementOrClass() == null) {</span><br>  2135-&gt;2033:  <span style="background-color: white">   0                                  cs = c.getCss().getCascadedStyle(iB.getElement(), false);</span><br>     2136-&gt;N:  <span style="background-color: white">                                  } else {</span><br>  2137-&gt;2035:  <span style="background-color: white">   0                                  cs = c.getCss().getPseudoElementStyle(</span><br>  2138-&gt;2036:  <span style="background-color: white">                                              iB.getElement(), iB.getPseudoElementOrClass());</span><br>     2139-&gt;N:  <span style="background-color: white">                                  }</span><br>  2140-&gt;2038:  <span style="background-color: white">   0                              styles.add(styles.getLast().deriveStyle(cs));</span><br>     2141-&gt;N:  <span style="background-color: white">                              } else {</span><br>  2142-&gt;2040:  <span style="background-color: white">   0                              styles.add(style.createAnonymousStyle(IdentValue.INLINE));</span><br>     2143-&gt;N:  <span style="background-color: white">                              }</span><br>     2144-&gt;N:  <span style="background-color: white">                          }</span><br>     2145-&gt;N:  <span style="background-color: white">      </span><br>  2146-&gt;2044:  <span style="background-color: white">   0                      iB.setStyle(styles.getLast());</span><br>  2147-&gt;2045:  <span style="background-color: white">   0                      iB.applyTextTransform();</span><br>     2148-&gt;N:  <span style="background-color: white">      </span><br>  2149-&gt;2047:  <span style="background-color: white">   0                      if (iB.isEndsHere()) {</span><br>  2150-&gt;2048:  <span style="background-color: white">   0                          styles.removeLast();</span><br>     2151-&gt;N:  <span style="background-color: white">                          }</span><br>     2152-&gt;N:  <span style="background-color: white">                      }</span><br>     2153-&gt;N:  <span style="background-color: white">                  }</span><br>     2154-&gt;N:  <span style="background-color: white">              }</span><br>     2155-&gt;N:  <span style="background-color: white">          }</span><br>     2156-&gt;N:  <span style="background-color: white">      </span><br>  2157-&gt;2055:  <span style="background-color: cyan"> 99+      @Override</span><br>  2158-&gt;2056:  <span style="background-color: white">          protected void calcChildPaintingInfo(</span><br>  2159-&gt;2057:  <span style="background-color: white">                  final CssContext c, final PaintingInfo result, final boolean useCache) {</span><br>  2160-&gt;2058:  <span style="background-color: cyan"> 99+          if (getPersistentBFC() != null) {</span><br>     2161-&gt;N:  <span style="background-color: white"> 99+              (this).getPersistentBFC().getFloatManager().performFloatOperation(</span><br>     2162-&gt;N:  <span style="background-color: white">                          new FloatManager.FloatOperation() {</span><br>     2163-&gt;U:  <span style="background-color: yellow"> 99+                          @Override</span><br>  2164-&gt;2061:  <span style="background-color: red">                              public void operate(Box floater) {</span><br>  2165-&gt;2062:  <span style="background-color: cyan"> 99+                              PaintingInfo info = floater.calcPaintingInfo(c, useCache);</span><br>     2166-&gt;N:  <span style="background-color: white"> 99+                              moveIfGreater(</span><br>  2167-&gt;2064:  <span style="background-color: white">                                          result.getOuterMarginCorner(),</span><br>  2168-&gt;2065:  <span style="background-color: white">                                          info.getOuterMarginCorner());</span><br>     2169-&gt;N:  <span style="background-color: white">                              }</span><br>     2170-&gt;N:  <span style="background-color: white">                          });</span><br>     2171-&gt;N:  <span style="background-color: white">              }</span><br>  2172-&gt;2069:  <span style="background-color: cyan"> 99+          super.calcChildPaintingInfo(c, result, useCache);</span><br>     2173-&gt;N:  <span style="background-color: white">          }</span><br>     2174-&gt;N:  <span style="background-color: white">      </span><br>  2175-&gt;2072:  <span style="background-color: cyan"> 99+      public CascadedStyle getFirstLetterStyle() {</span><br>     2176-&gt;N:  <span style="background-color: white"> 99+          return _firstLetterStyle;</span><br>     2177-&gt;N:  <span style="background-color: white">          }</span><br>     2178-&gt;N:  <span style="background-color: white">      </span><br>  2179-&gt;2076:  <span style="background-color: cyan"> 99+      public void setFirstLetterStyle(CascadedStyle firstLetterStyle) {</span><br>  2180-&gt;2077:  <span style="background-color: cyan"> 99+          _firstLetterStyle = firstLetterStyle;</span><br>     2181-&gt;N:  <span style="background-color: white">          }</span><br>     2182-&gt;N:  <span style="background-color: white">      </span><br>  2183-&gt;2080:  <span style="background-color: cyan"> 99+      public CascadedStyle getFirstLineStyle() {</span><br>     2184-&gt;N:  <span style="background-color: white"> 99+          return _firstLineStyle;</span><br>     2185-&gt;N:  <span style="background-color: white">          }</span><br>     2186-&gt;N:  <span style="background-color: white">      </span><br>  2187-&gt;2084:  <span style="background-color: cyan"> 99+      public void setFirstLineStyle(CascadedStyle firstLineStyle) {</span><br>  2188-&gt;2085:  <span style="background-color: cyan"> 99+          _firstLineStyle = firstLineStyle;</span><br>     2189-&gt;N:  <span style="background-color: white">          }</span><br>     2190-&gt;N:  <span style="background-color: white">      </span><br>  2191-&gt;2088:  <span style="background-color: cyan"> 99+      protected boolean isMinMaxCalculated() {</span><br>     2192-&gt;N:  <span style="background-color: white"> 99+          return _minMaxCalculated;</span><br>     2193-&gt;N:  <span style="background-color: white">          }</span><br>     2194-&gt;N:  <span style="background-color: white">      </span><br>  2195-&gt;2092:  <span style="background-color: cyan"> 99+      protected void setMinMaxCalculated(boolean minMaxCalculated) {</span><br>  2196-&gt;2093:  <span style="background-color: cyan"> 99+          _minMaxCalculated = minMaxCalculated;</span><br>     2197-&gt;N:  <span style="background-color: white">          }</span><br>     2198-&gt;N:  <span style="background-color: white">      </span><br>  2199-&gt;2096:  <span style="background-color: cyan"> 99+      protected void setDimensionsCalculated(boolean dimensionsCalculated) {</span><br>  2200-&gt;2097:  <span style="background-color: cyan"> 99+          _dimensionsCalculated = dimensionsCalculated;</span><br>     2201-&gt;N:  <span style="background-color: white">          }</span><br>     2202-&gt;N:  <span style="background-color: white">      </span><br>  2203-&gt;2100:  <span style="background-color: cyan"> 99+      private boolean isDimensionsCalculated() {</span><br>     2204-&gt;N:  <span style="background-color: white"> 99+          return _dimensionsCalculated;</span><br>     2205-&gt;N:  <span style="background-color: white">          }</span><br>     2206-&gt;N:  <span style="background-color: white">      </span><br>  2207-&gt;2104:  <span style="background-color: cyan"> 99+      protected void setNeedShrinkToFitCalculatation(boolean needShrinkToFitCalculatation) {</span><br>  2208-&gt;2105:  <span style="background-color: cyan"> 99+          _needShrinkToFitCalculatation = needShrinkToFitCalculatation;</span><br>     2209-&gt;N:  <span style="background-color: white">          }</span><br>     2210-&gt;N:  <span style="background-color: white">      </span><br>  2211-&gt;2108:  <span style="background-color: cyan"> 99+      private boolean isNeedShrinkToFitCalculatation() {</span><br>     2212-&gt;N:  <span style="background-color: white"> 99+          return _needShrinkToFitCalculatation;</span><br>     2213-&gt;N:  <span style="background-color: white">          }</span><br>     2214-&gt;N:  <span style="background-color: white">      </span><br>  2215-&gt;2112:  <span style="background-color: cyan"> 99+      public void initStaticPos(LayoutContext c, BlockBox parent, int childOffset) {</span><br>  2216-&gt;2113:  <span style="background-color: cyan"> 99+          setX(0);</span><br>  2217-&gt;2114:  <span style="background-color: cyan"> 99+          setY(childOffset);</span><br>     2218-&gt;N:  <span style="background-color: white">          }</span><br>     2219-&gt;N:  <span style="background-color: white">      </span><br>  2220-&gt;2117:  <span style="background-color: cyan"> 99+      public int calcBaseline(LayoutContext c) {</span><br>  2221-&gt;2118:  <span style="background-color: cyan"> 99+          for (int i = 0; i &lt; getChildCount(); i++) {</span><br>  2222-&gt;2119:  <span style="background-color: cyan"> 99+              Box b = getChild(i);</span><br>  2223-&gt;2120:  <span style="background-color: cyan"> 99+              if (b instanceof LineBox) {</span><br>  2224-&gt;2121:  <span style="background-color: cyan"> 99+                  return b.getAbsY() + ((LineBox) b).getBaseline();</span><br>     2225-&gt;N:  <span style="background-color: white">                  } else {</span><br>  2226-&gt;2123:  <span style="background-color: cyan"> 99+                  if (b instanceof TableRowBox) {</span><br>  2227-&gt;2124:  <span style="background-color: cyan">  59                      return b.getAbsY() + ((TableRowBox) b).getBaseline();</span><br>     2228-&gt;N:  <span style="background-color: white">                      } else {</span><br>  2229-&gt;2126:  <span style="background-color: cyan"> 99+                      int result = ((BlockBox) b).calcBaseline(c);</span><br>  2230-&gt;2127:  <span style="background-color: cyan"> 99+                      if (result != NO_BASELINE) {</span><br>  2231-&gt;2128:  <span style="background-color: cyan"> 99+                          return result;</span><br>     2232-&gt;N:  <span style="background-color: white">                          }</span><br>     2233-&gt;N:  <span style="background-color: white">                      }</span><br>     2234-&gt;N:  <span style="background-color: white">                  }</span><br>     2235-&gt;N:  <span style="background-color: white">              }</span><br>     2236-&gt;N:  <span style="background-color: white">      </span><br>  2237-&gt;2134:  <span style="background-color: white">   7          return NO_BASELINE;</span><br>     2238-&gt;N:  <span style="background-color: white">          }</span><br>     2239-&gt;N:  <span style="background-color: white">      </span><br>  2240-&gt;2137:  <span style="background-color: cyan"> 99+      protected int calcInitialBreakAtLine(LayoutContext c) {</span><br>  2241-&gt;2138:  <span style="background-color: cyan"> 99+          BreakAtLineContext bContext = c.getBreakAtLineContext();</span><br>  2242-&gt;2139:  <span style="background-color: cyan"> 99+          if (bContext != null &amp;&amp; bContext.getBlock() == this) {</span><br>  2243-&gt;2140:  <span style="background-color: white">   0              return bContext.getLine();</span><br>     2244-&gt;N:  <span style="background-color: white">              }</span><br>  2245-&gt;2142:  <span style="background-color: cyan"> 99+          return 0;</span><br>     2246-&gt;N:  <span style="background-color: white">          }</span><br>     2247-&gt;N:  <span style="background-color: white">      </span><br>  2248-&gt;2145:  <span style="background-color: cyan"> 99+      public boolean isCurrentBreakAtLineContext(LayoutContext c) {</span><br>  2249-&gt;2146:  <span style="background-color: cyan"> 99+          BreakAtLineContext bContext = c.getBreakAtLineContext();</span><br>  2250-&gt;2147:  <span style="background-color: cyan"> 99+          return bContext != null &amp;&amp; bContext.getBlock() == this;</span><br>     2251-&gt;N:  <span style="background-color: white">          }</span><br>     2252-&gt;N:  <span style="background-color: white">      </span><br>  2253-&gt;2150:  <span style="background-color: cyan"> 99+      public BreakAtLineContext calcBreakAtLineContext(LayoutContext c) {</span><br>  2254-&gt;2151:  <span style="background-color: cyan"> 99+          if (! c.isPrint() || ! getStyle().isKeepWithInline()) {</span><br>  2255-&gt;2152:  <span style="background-color: cyan"> 99+              return null;</span><br>     2256-&gt;N:  <span style="background-color: white">              }</span><br>     2257-&gt;N:  <span style="background-color: white">      </span><br>  2258-&gt;2155:  <span style="background-color: white">  30          LineBox breakLine = findLastNthLineBox((int)getStyle().asFloat(CSSName.WIDOWS));</span><br>  2259-&gt;2156:  <span style="background-color: white">  30          if (breakLine != null) {</span><br>  2260-&gt;2157:  <span style="background-color: white">  30              PageBox linePage = c.getRootLayer().getLastPage(c, breakLine);</span><br>  2261-&gt;2158:  <span style="background-color: white">  30              PageBox ourPage = c.getRootLayer().getLastPage(c, this);</span><br>  2262-&gt;2159:  <span style="background-color: white">  30              if (linePage != null &amp;&amp; ourPage != null &amp;&amp; linePage.getPageNo() + 1 == ourPage.getPageNo()) {</span><br>  2263-&gt;2160:  <span style="background-color: white">   0                  BlockBox breakBox = breakLine.getParent();</span><br>  2264-&gt;2161:  <span style="background-color: white">   0                  return new BreakAtLineContext(breakBox, breakBox.findOffset(breakLine));</span><br>     2265-&gt;N:  <span style="background-color: white">                  }</span><br>     2266-&gt;N:  <span style="background-color: white">              }</span><br>     2267-&gt;N:  <span style="background-color: white">      </span><br>  2268-&gt;2165:  <span style="background-color: white">  30          return null;</span><br>     2269-&gt;N:  <span style="background-color: white">          }</span><br>     2270-&gt;N:  <span style="background-color: white">      </span><br>  2271-&gt;2168:  <span style="background-color: cyan"> 99+      public int calcInlineBaseline(CssContext c) {</span><br>     2272-&gt;N:  <span style="background-color: white"> 99+          if (isReplaced() &amp;&amp; getReplacedElement().hasBaseline()) {</span><br>  2273-&gt;2170:  <span style="background-color: white">   0              Rectangle bounds = getContentAreaEdge(getAbsX(), getAbsY(), c);</span><br>  2274-&gt;2171:  <span style="background-color: white">   0              return bounds.y + getReplacedElement().getBaseline() - getAbsY();</span><br>     2275-&gt;N:  <span style="background-color: white">              } else {</span><br>  2276-&gt;2173:  <span style="background-color: cyan"> 99+              LineBox lastLine = findLastLineBox();</span><br>  2277-&gt;2174:  <span style="background-color: cyan"> 99+              if (lastLine == null) {</span><br>     2278-&gt;N:  <span style="background-color: white"> 99+                  return getHeight();</span><br>     2279-&gt;N:  <span style="background-color: white">                  } else {</span><br>  2280-&gt;2177:  <span style="background-color: cyan"> 99+                  return lastLine.getAbsY() + lastLine.getBaseline() - getAbsY();</span><br>     2281-&gt;N:  <span style="background-color: white">                  }</span><br>     2282-&gt;N:  <span style="background-color: white">              }</span><br>     2283-&gt;N:  <span style="background-color: white">          }</span><br>     2284-&gt;N:  <span style="background-color: white">      </span><br>  2285-&gt;2182:  <span style="background-color: white">   0      public int findOffset(Box box) {</span><br>  2286-&gt;2183:  <span style="background-color: white">   0          int ccount = getChildCount();</span><br>  2287-&gt;2184:  <span style="background-color: white">   0          for (int i = 0; i &lt; ccount; i++) {</span><br>  2288-&gt;2185:  <span style="background-color: white">   0              if (getChild(i) == box) {</span><br>  2289-&gt;2186:  <span style="background-color: white">   0                  return i;</span><br>     2290-&gt;N:  <span style="background-color: white">                  }</span><br>     2291-&gt;N:  <span style="background-color: white">              }</span><br>  2292-&gt;2189:  <span style="background-color: white">   0          return -1;</span><br>     2293-&gt;N:  <span style="background-color: white">          }</span><br>     2294-&gt;N:  <span style="background-color: white">      </span><br>  2295-&gt;2192:  <span style="background-color: white">  30      public LineBox findLastNthLineBox(int count) {</span><br>  2296-&gt;2193:  <span style="background-color: white">  30          LastLineBoxContext context = new LastLineBoxContext(count);</span><br>  2297-&gt;2194:  <span style="background-color: white">  30          findLastLineBox(context);</span><br>  2298-&gt;2195:  <span style="background-color: white">  30          return context.line;</span><br>     2299-&gt;N:  <span style="background-color: white">          }</span><br>     2300-&gt;N:  <span style="background-color: white">      </span><br>     2301-&gt;N:  <span style="background-color: white">          private static class LastLineBoxContext {</span><br>  2302-&gt;2199:  <span style="background-color: white">              public int current;</span><br>  2303-&gt;2200:  <span style="background-color: white">              public LineBox line;</span><br>     2304-&gt;N:  <span style="background-color: white">      </span><br>  2305-&gt;2202:  <span style="background-color: white">  30          public LastLineBoxContext(int i) {</span><br>  2306-&gt;2203:  <span style="background-color: white">  30              this.current = i;</span><br>     2307-&gt;N:  <span style="background-color: white">              }</span><br>     2308-&gt;N:  <span style="background-color: white">          }</span><br>     2309-&gt;N:  <span style="background-color: white">      </span><br>  2310-&gt;2207:  <span style="background-color: white"> 99+      private void findLastLineBox(LastLineBoxContext context) {</span><br>     2311-&gt;U:  <span style="background-color: yellow"> 99+          ContentType type = getChildrenContentType();</span><br>  2312-&gt;2209:  <span style="background-color: white"> 99+          int ccount = getChildCount();</span><br>  2313-&gt;2210:  <span style="background-color: white"> 99+          if (ccount &gt; 0) {</span><br>     2314-&gt;U:  <span style="background-color: yellow"> 99+              if (type == ContentType.INLINE) {</span><br>  2315-&gt;2212:  <span style="background-color: white">  86                  for (int i = ccount - 1; i &gt;= 0; i--) {</span><br>  2316-&gt;2213:  <span style="background-color: white">  60                      LineBox child = (LineBox) getChild(i);</span><br>  2317-&gt;2214:  <span style="background-color: white">  60                      if (child.getHeight() &gt; 0) {</span><br>  2318-&gt;2215:  <span style="background-color: white">  60                          context.line = child;</span><br>  2319-&gt;2216:  <span style="background-color: white">  60                          if (--context.current == 0) {</span><br>  2320-&gt;2217:  <span style="background-color: white">  30                              return;</span><br>     2321-&gt;N:  <span style="background-color: white">                              }</span><br>     2322-&gt;N:  <span style="background-color: white">                          }</span><br>     2323-&gt;N:  <span style="background-color: white">                      }</span><br>     2324-&gt;U:  <span style="background-color: yellow"> 99+              } else if (type == ContentType.BLOCK) {</span><br>  2325-&gt;2222:  <span style="background-color: white"> 99+                  for (int i = ccount - 1; i &gt;= 0; i--) {</span><br>  2326-&gt;2223:  <span style="background-color: white"> 99+                      ((BlockBox) getChild(i)).findLastLineBox(context);</span><br>  2327-&gt;2224:  <span style="background-color: white"> 99+                      if (context.current == 0) {</span><br>  2328-&gt;2225:  <span style="background-color: white"> 99+                          break;</span><br>     2329-&gt;N:  <span style="background-color: white">                          }</span><br>     2330-&gt;N:  <span style="background-color: white">                      }</span><br>     2331-&gt;N:  <span style="background-color: white">                  }</span><br>     2332-&gt;N:  <span style="background-color: white">              }</span><br>     2333-&gt;N:  <span style="background-color: white">          }</span><br>     2334-&gt;N:  <span style="background-color: white">      </span><br>  2335-&gt;2232:  <span style="background-color: cyan"> 99+      private LineBox findLastLineBox() {</span><br>     2336-&gt;U:  <span style="background-color: yellow"> 99+          ContentType type = getChildrenContentType();</span><br>  2337-&gt;2234:  <span style="background-color: cyan"> 99+          int ccount = getChildCount();</span><br>  2338-&gt;2235:  <span style="background-color: cyan"> 99+          if (ccount &gt; 0) {</span><br>     2339-&gt;U:  <span style="background-color: yellow"> 99+              if (type == ContentType.INLINE) {</span><br>  2340-&gt;2237:  <span style="background-color: cyan"> 99+                  for (int i = ccount - 1; i &gt;= 0; i--) {</span><br>  2341-&gt;2238:  <span style="background-color: cyan"> 99+                      LineBox result = (LineBox) getChild(i);</span><br>  2342-&gt;2239:  <span style="background-color: cyan"> 99+                      if (result.getHeight() &gt; 0) {</span><br>  2343-&gt;2240:  <span style="background-color: cyan"> 99+                          return result;</span><br>     2344-&gt;N:  <span style="background-color: white">                          }</span><br>     2345-&gt;N:  <span style="background-color: white">                      }</span><br>     2346-&gt;U:  <span style="background-color: yellow">   0              } else if (type == ContentType.BLOCK) {</span><br>  2347-&gt;2244:  <span style="background-color: white">   0                  for (int i = ccount - 1; i &gt;= 0; i--) {</span><br>  2348-&gt;2245:  <span style="background-color: white">   0                      LineBox result = ((BlockBox) getChild(i)).findLastLineBox();</span><br>  2349-&gt;2246:  <span style="background-color: white">   0                      if (result != null) {</span><br>  2350-&gt;2247:  <span style="background-color: white">   0                          return result;</span><br>     2351-&gt;N:  <span style="background-color: white">                          }</span><br>     2352-&gt;N:  <span style="background-color: white">                      }</span><br>     2353-&gt;N:  <span style="background-color: white">                  }</span><br>     2354-&gt;N:  <span style="background-color: white">              }</span><br>     2355-&gt;N:  <span style="background-color: white">      </span><br>  2356-&gt;2253:  <span style="background-color: cyan"> 99+          return null;</span><br>     2357-&gt;N:  <span style="background-color: white">          }</span><br>     2358-&gt;N:  <span style="background-color: white">      </span><br>  2359-&gt;2256:  <span style="background-color: white"> 99+      private LineBox findFirstLineBox() {</span><br>     2360-&gt;U:  <span style="background-color: yellow"> 99+          ContentType type = getChildrenContentType();</span><br>  2361-&gt;2258:  <span style="background-color: white"> 99+          int ccount = getChildCount();</span><br>  2362-&gt;2259:  <span style="background-color: white"> 99+          if (ccount &gt; 0) {</span><br>     2363-&gt;U:  <span style="background-color: yellow"> 99+              if (type == ContentType.INLINE) {</span><br>  2364-&gt;2261:  <span style="background-color: white">  30                  for (int i = 0; i &lt; ccount; i++) {</span><br>  2365-&gt;2262:  <span style="background-color: white">  30                      LineBox result = (LineBox) getChild(i);</span><br>  2366-&gt;2263:  <span style="background-color: white">  30                      if (result.getHeight() &gt; 0) {</span><br>  2367-&gt;2264:  <span style="background-color: white">  30                          return result;</span><br>     2368-&gt;N:  <span style="background-color: white">                          }</span><br>     2369-&gt;N:  <span style="background-color: white">                      }</span><br>     2370-&gt;U:  <span style="background-color: yellow">  94              } else if (type == ContentType.BLOCK) {</span><br>  2371-&gt;2268:  <span style="background-color: white">  94                  for (int i = 0; i &lt; ccount; i++) {</span><br>  2372-&gt;2269:  <span style="background-color: white">  94                      LineBox result = ((BlockBox) getChild(i)).findFirstLineBox();</span><br>  2373-&gt;2270:  <span style="background-color: white">  94                      if (result != null) {</span><br>  2374-&gt;2271:  <span style="background-color: white">  94                          return result;</span><br>     2375-&gt;N:  <span style="background-color: white">                          }</span><br>     2376-&gt;N:  <span style="background-color: white">                      }</span><br>     2377-&gt;N:  <span style="background-color: white">                  }</span><br>     2378-&gt;N:  <span style="background-color: white">              }</span><br>     2379-&gt;N:  <span style="background-color: white">      </span><br>  2380-&gt;2277:  <span style="background-color: white">   0          return null;</span><br>     2381-&gt;N:  <span style="background-color: white">          }</span><br>     2382-&gt;N:  <span style="background-color: white">      </span><br>  2383-&gt;2280:  <span style="background-color: cyan"> 99+      public boolean isNeedsKeepWithInline(LayoutContext c) {</span><br>  2384-&gt;2281:  <span style="background-color: cyan"> 99+          if (c.isPrint() &amp;&amp; getStyle().isKeepWithInline()) {</span><br>  2385-&gt;2282:  <span style="background-color: white">  30              LineBox line = findFirstLineBox();</span><br>  2386-&gt;2283:  <span style="background-color: white">  30              if (line != null) {</span><br>  2387-&gt;2284:  <span style="background-color: white">  30                  PageBox linePage = c.getRootLayer().getFirstPage(c, line);</span><br>  2388-&gt;2285:  <span style="background-color: white">  30                  PageBox ourPage = c.getRootLayer().getFirstPage(c, this);</span><br>  2389-&gt;2286:  <span style="background-color: white">  30                  return linePage != null &amp;&amp; ourPage != null &amp;&amp; linePage.getPageNo() == ourPage.getPageNo()+1;</span><br>     2390-&gt;N:  <span style="background-color: white">                  }</span><br>     2391-&gt;N:  <span style="background-color: white">              }</span><br>     2392-&gt;N:  <span style="background-color: white">      </span><br>  2393-&gt;2290:  <span style="background-color: cyan"> 99+          return false;</span><br>     2394-&gt;N:  <span style="background-color: white">          }</span><br>     2395-&gt;N:  <span style="background-color: white">      </span><br>  2396-&gt;2293:  <span style="background-color: cyan"> 99+      public boolean isFloated() {</span><br>  2397-&gt;2294:  <span style="background-color: cyan"> 99+          return _floatedBoxData != null;</span><br>     2398-&gt;N:  <span style="background-color: white">          }</span><br>     2399-&gt;N:  <span style="background-color: white">      </span><br>  2400-&gt;2297:  <span style="background-color: cyan"> 99+      public FloatedBoxData getFloatedBoxData() {</span><br>     2401-&gt;N:  <span style="background-color: white"> 99+          return _floatedBoxData;</span><br>     2402-&gt;N:  <span style="background-color: white">          }</span><br>     2403-&gt;N:  <span style="background-color: white">      </span><br>  2404-&gt;2301:  <span style="background-color: cyan"> 99+      public void setFloatedBoxData(FloatedBoxData floatedBoxData) {</span><br>  2405-&gt;2302:  <span style="background-color: cyan"> 99+          _floatedBoxData = floatedBoxData;</span><br>     2406-&gt;N:  <span style="background-color: white">          }</span><br>     2407-&gt;N:  <span style="background-color: white">      </span><br>  2408-&gt;2305:  <span style="background-color: cyan"> 99+      public int getChildrenHeight() {</span><br>     2409-&gt;N:  <span style="background-color: white"> 99+          return _childrenHeight;</span><br>     2410-&gt;N:  <span style="background-color: white">          }</span><br>     2411-&gt;N:  <span style="background-color: white">      </span><br>  2412-&gt;2309:  <span style="background-color: cyan"> 99+      protected void setChildrenHeight(int childrenHeight) {</span><br>  2413-&gt;2310:  <span style="background-color: cyan"> 99+          _childrenHeight = childrenHeight;</span><br>     2414-&gt;N:  <span style="background-color: white">          }</span><br>     2415-&gt;N:  <span style="background-color: white">      </span><br>  2416-&gt;2313:  <span style="background-color: cyan"> 99+      public boolean isFromCaptionedTable() {</span><br>     2417-&gt;N:  <span style="background-color: white"> 99+          return _fromCaptionedTable;</span><br>     2418-&gt;N:  <span style="background-color: white">          }</span><br>     2419-&gt;N:  <span style="background-color: white">      </span><br>  2420-&gt;2317:  <span style="background-color: cyan">   7      public void setFromCaptionedTable(boolean fromTable) {</span><br>  2421-&gt;2318:  <span style="background-color: cyan">   7          _fromCaptionedTable = fromTable;</span><br>     2422-&gt;N:  <span style="background-color: white">          }</span><br>     2423-&gt;N:  <span style="background-color: white">      </span><br>     2424-&gt;U:  <span style="background-color: yellow">  78      @Override</span><br>  2425-&gt;2321:  <span style="background-color: red">          protected boolean isInlineBlock() {</span><br>     2426-&gt;N:  <span style="background-color: white">  78          return isInline();</span><br>     2427-&gt;N:  <span style="background-color: white">          }</span><br>     2428-&gt;N:  <span style="background-color: white">      </span><br>  2429-&gt;2325:  <span style="background-color: white">   0      public boolean isInMainFlow() {</span><br>  2430-&gt;2326:  <span style="background-color: white">   0          Box flowRoot = rootBox();</span><br>  2431-&gt;2327:  <span style="background-color: white">   0          return flowRoot.isRoot();</span><br>     2432-&gt;N:  <span style="background-color: white">          }</span><br>     2433-&gt;N:  <span style="background-color: white">      </span><br>  2434-&gt;2330:  <span style="background-color: white">   0      @Override</span><br>  2435-&gt;2331:  <span style="background-color: white">          public Box getDocumentParent() {</span><br>  2436-&gt;2332:  <span style="background-color: white">   0          Box staticEquivalent = getStaticEquivalent();</span><br>  2437-&gt;2333:  <span style="background-color: white">   0          if (staticEquivalent != null) {</span><br>  2438-&gt;2334:  <span style="background-color: white">   0              return staticEquivalent;</span><br>     2439-&gt;N:  <span style="background-color: white">              } else {</span><br>     2440-&gt;N:  <span style="background-color: white">   0              return getParent();</span><br>     2441-&gt;N:  <span style="background-color: white">              }</span><br>     2442-&gt;N:  <span style="background-color: white">          }</span><br>     2443-&gt;N:  <span style="background-color: white">      </span><br>  2444-&gt;2340:  <span style="background-color: white">   2      public boolean isContainsInlineContent(LayoutContext c) {</span><br>  2445-&gt;2341:  <span style="background-color: white">   2          ensureChildren(c);</span><br>     2446-&gt;N:  <span style="background-color: white">   2          switch (getChildrenContentType()) {</span><br>     2447-&gt;U:  <span style="background-color: yellow">   0              case INLINE:</span><br>  2448-&gt;2344:  <span style="background-color: white">   0                  return true;</span><br>     2449-&gt;U:  <span style="background-color: yellow">   1              case EMPTY:</span><br>  2450-&gt;2346:  <span style="background-color: white">   1                  return false;</span><br>     2451-&gt;U:  <span style="background-color: yellow">   1              case BLOCK:</span><br>  2452-&gt;2348:  <span style="background-color: white">   1                  return getChildren().stream().anyMatch(box -&gt; ((BlockBox) box).isContainsInlineContent(c));</span><br>     2453-&gt;U:  <span style="background-color: yellow">   0              case UNKNOWN:</span><br>     2454-&gt;N:  <span style="background-color: white">                      // FALL-THRU - Can not happen due to ensureChildren call above.</span><br>     2455-&gt;U:  <span style="background-color: yellow">   0              default:</span><br>     2456-&gt;U:  <span style="background-color: yellow">   0                  throw new RuntimeException("internal error: no children");</span><br>     2457-&gt;N:  <span style="background-color: white">              }</span><br>     2458-&gt;N:  <span style="background-color: white">          }</span><br>     2459-&gt;N:  <span style="background-color: white">      </span><br>  2460-&gt;2354:  <span style="background-color: cyan"> 99+      public boolean checkPageContext(LayoutContext c) {</span><br>  2461-&gt;2355:  <span style="background-color: cyan"> 99+          if (! getStyle().isIdent(CSSName.PAGE, IdentValue.AUTO)) {</span><br>  2462-&gt;2356:  <span style="background-color: white">   2              String pageName = getStyle().getStringProperty(CSSName.PAGE);</span><br>  2463-&gt;2357:  <span style="background-color: white">   2              if (!pageName.equals(c.getPageName()) &amp;&amp; </span><br>     2464-&gt;N:  <span style="background-color: white">                      isInDocumentFlow() &amp;&amp;</span><br>  2465-&gt;2359:  <span style="background-color: white">                      (shouldBeReplaced() || isContainsInlineContent(c))) {</span><br>  2466-&gt;2360:  <span style="background-color: white">   1                  c.setPendingPageName(pageName);</span><br>  2467-&gt;2361:  <span style="background-color: white">   1                  return true;</span><br>     2468-&gt;N:  <span style="background-color: white">                  }</span><br>  2469-&gt;2363:  <span style="background-color: cyan"> 99+          } else if (c.getPageName() != null &amp;&amp; isInDocumentFlow()) {</span><br>  2470-&gt;2364:  <span style="background-color: white">   0              c.setPendingPageName(null);</span><br>  2471-&gt;2365:  <span style="background-color: white">   0              return true;</span><br>     2472-&gt;N:  <span style="background-color: white">              }</span><br>     2473-&gt;N:  <span style="background-color: white">      </span><br>  2474-&gt;2368:  <span style="background-color: cyan"> 99+          return false;</span><br>     2475-&gt;N:  <span style="background-color: white">          }</span><br>     2476-&gt;N:  <span style="background-color: white">      </span><br>  2477-&gt;2371:  <span style="background-color: cyan"> 99+      public boolean isNeedsClipOnPaint(CssContext c) {</span><br>     2478-&gt;N:  <span style="background-color: white"> 99+          return ! isReplaced() &amp;&amp;</span><br>  2479-&gt;2373:  <span style="background-color: white">                  getStyle().isIdent(CSSName.OVERFLOW, IdentValue.HIDDEN) &amp;&amp;</span><br>     2480-&gt;N:  <span style="background-color: white">                  getStyle().isOverflowApplies();</span><br>     2481-&gt;N:  <span style="background-color: white">          }</span><br>     2482-&gt;N:  <span style="background-color: white">      </span><br>     2483-&gt;N:  <span style="background-color: white">      </span><br>  2484-&gt;2378:  <span style="background-color: white">   7      protected void propagateExtraSpace(</span><br>  2485-&gt;2379:  <span style="background-color: white">                  LayoutContext c,</span><br>  2486-&gt;2380:  <span style="background-color: white">                  ContentLimitContainer parentContainer, ContentLimitContainer currentContainer,</span><br>  2487-&gt;2381:  <span style="background-color: white">                  int extraTop, int extraBottom) {</span><br>  2488-&gt;2382:  <span style="background-color: white">   7          int start = currentContainer.getInitialPageNo();</span><br>  2489-&gt;2383:  <span style="background-color: white">   7          int end = currentContainer.getLastPageNo();</span><br>  2490-&gt;2384:  <span style="background-color: white">   7          int current = start;</span><br>     2491-&gt;N:  <span style="background-color: white">      </span><br>  2492-&gt;2386:  <span style="background-color: white">  21          while (current &lt;= end) {</span><br>  2493-&gt;2387:  <span style="background-color: white">  14              ContentLimit contentLimit =</span><br>  2494-&gt;2388:  <span style="background-color: white">                      currentContainer.getContentLimit(current);</span><br>     2495-&gt;N:  <span style="background-color: white">      </span><br>  2496-&gt;2390:  <span style="background-color: white">  14              if (current != start) {</span><br>  2497-&gt;2391:  <span style="background-color: white">   7                  int top = contentLimit.getTop();</span><br>  2498-&gt;2392:  <span style="background-color: white">   7                  if (top != ContentLimit.UNDEFINED) {</span><br>  2499-&gt;2393:  <span style="background-color: white">   7                      parentContainer.updateTop(c, top - extraTop);</span><br>     2500-&gt;N:  <span style="background-color: white">                      }</span><br>     2501-&gt;N:  <span style="background-color: white">                  }</span><br>     2502-&gt;N:  <span style="background-color: white">      </span><br>  2503-&gt;2397:  <span style="background-color: white">  14              if (current != end) {</span><br>  2504-&gt;2398:  <span style="background-color: white">   7                  int bottom = contentLimit.getBottom();</span><br>  2505-&gt;2399:  <span style="background-color: white">   7                  if (bottom != ContentLimit.UNDEFINED) {</span><br>  2506-&gt;2400:  <span style="background-color: white">   7                      parentContainer.updateBottom(c, bottom + extraBottom);</span><br>     2507-&gt;N:  <span style="background-color: white">                      }</span><br>     2508-&gt;N:  <span style="background-color: white">                  }</span><br>     2509-&gt;N:  <span style="background-color: white">      </span><br>  2510-&gt;2404:  <span style="background-color: white">  14              current++;</span><br>     2511-&gt;N:  <span style="background-color: white">              }</span><br>     2512-&gt;N:  <span style="background-color: white">          }</span><br>     2513-&gt;N:  <span style="background-color: white">      </span><br>     2514-&gt;N:  <span style="background-color: white">          public static class MarginCollapseResult {</span><br>  2515-&gt;2409:  <span style="background-color: white">              private int maxPositive;</span><br>  2516-&gt;2410:  <span style="background-color: white">              private int maxNegative;</span><br>     2517-&gt;N:  <span style="background-color: white">      </span><br>  2518-&gt;2412:  <span style="background-color: cyan"> 99+          public void update(int value) {</span><br>  2519-&gt;2413:  <span style="background-color: cyan"> 99+              if (value &lt; 0 &amp;&amp; value &lt; maxNegative) {</span><br>  2520-&gt;2414:  <span style="background-color: white">   4                  maxNegative = value;</span><br>     2521-&gt;N:  <span style="background-color: white">                  }</span><br>     2522-&gt;N:  <span style="background-color: white">      </span><br>  2523-&gt;2417:  <span style="background-color: cyan"> 99+              if (value &gt; 0 &amp;&amp; value &gt; maxPositive) {</span><br>  2524-&gt;2418:  <span style="background-color: cyan"> 99+                  maxPositive = value;</span><br>     2525-&gt;N:  <span style="background-color: white">                  }</span><br>     2526-&gt;N:  <span style="background-color: white">              }</span><br>     2527-&gt;N:  <span style="background-color: white">      </span><br>  2528-&gt;2422:  <span style="background-color: cyan"> 99+          public int getMargin() {</span><br>     2529-&gt;N:  <span style="background-color: white"> 99+              return maxPositive + maxNegative;</span><br>     2530-&gt;N:  <span style="background-color: white">              }</span><br>     2531-&gt;N:  <span style="background-color: white">      </span><br>  2532-&gt;2426:  <span style="background-color: cyan"> 99+          public boolean hasMargin() {</span><br>  2533-&gt;2427:  <span style="background-color: cyan"> 99+              return maxPositive != 0 || maxNegative != 0;</span><br>     2534-&gt;N:  <span style="background-color: white">              }</span><br>     2535-&gt;N:  <span style="background-color: white">          }</span><br>     2536-&gt;N:  <span style="background-color: white">      </span><br>     2537-&gt;N:  <span style="background-color: white">      }</span><br></pre> </code> 
   </div> 
  </div>  
 </body>
</html>
<!doctype html>
<html lang="en"> 
 <head> 
  <meta charset="UTF-8"> 
  <title>Execution Trace Diff</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <style>
* {
  box-sizing: border-box;
}

/* Create two equal columns that floats next to each other */
.column {
  float: left;
  width: 50%;
  padding: 10px;
  height: 300px; /* Should be removed. Only for demonstration */
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

.test {
    border: 1px solid darkblue;
    padding-left: 10px;
}
</style> 
 </head> 
 <body> 
  <div class="row test"> 
   <h2>Differencing Test:</h2> <code> <pre>@Test <br>
public void test_main(){ <br>
    String ret = NumberAnalyzer.analyze(1); <br>
    assertThat(ret, containsString("greater")); <br>
}
        </pre> </code> 
  </div> 
  <div class="row"> 
   <div class="column"> 
    <h2>Original Code:</h2> <code> <pre id="original-trace">           1:  <span style="background-color: white">      /*</span><br>           2:  <span style="background-color: white">       * {{{ header &amp; license</span><br>           3:  <span style="background-color: white">       * Copyright (c) 2004, 2005 Torbjoern Gannholm, Joshua Marinacci</span><br>           4:  <span style="background-color: white">       * Copyright (c) 2006 Wisconsin Court System</span><br>           5:  <span style="background-color: white">       *</span><br>           6:  <span style="background-color: white">       * This program is free software; you can redistribute it and/or</span><br>           7:  <span style="background-color: white">       * modify it under the terms of the GNU Lesser General Public License</span><br>           8:  <span style="background-color: white">       * as published by the Free Software Foundation; either version 2.1</span><br>           9:  <span style="background-color: white">       * of the License, or (at your option) any later version.</span><br>          10:  <span style="background-color: white">       *</span><br>          11:  <span style="background-color: white">       * This program is distributed in the hope that it will be useful,</span><br>          12:  <span style="background-color: white">       * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br>          13:  <span style="background-color: white">       * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span><br>          14:  <span style="background-color: white">       * GNU Lesser General Public License for more details.</span><br>          15:  <span style="background-color: white">       *</span><br>          16:  <span style="background-color: white">       * You should have received a copy of the GNU Lesser General Public License</span><br>          17:  <span style="background-color: white">       * along with this program; if not, write to the Free Software</span><br>          18:  <span style="background-color: white">       * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span><br>          19:  <span style="background-color: white">       * }}}</span><br>          20:  <span style="background-color: white">       */</span><br>          21:  <span style="background-color: white">      package com.openhtmltopdf.layout;</span><br>          22:  <span style="background-color: white">      </span><br>          23:  <span style="background-color: white">      import java.util.ArrayDeque;</span><br>          24:  <span style="background-color: white">      import java.util.ArrayList;</span><br>          25:  <span style="background-color: white">      import java.util.Collections;</span><br>          26:  <span style="background-color: white">      import java.util.Deque;</span><br>          27:  <span style="background-color: white">      import java.util.HashMap;</span><br>          28:  <span style="background-color: white">      import java.util.Iterator;</span><br>          29:  <span style="background-color: white">      import java.util.List;</span><br>          30:  <span style="background-color: white">      import java.util.Map;</span><br>          31:  <span style="background-color: white">      </span><br>          32:  <span style="background-color: white">      import org.w3c.dom.Document;</span><br>          33:  <span style="background-color: white">      import org.w3c.dom.Element;</span><br>          34:  <span style="background-color: white">      import org.w3c.dom.Node;</span><br>          35:  <span style="background-color: white">      import org.w3c.dom.Text;</span><br>          36:  <span style="background-color: white">      </span><br>          37:  <span style="background-color: white">      import com.openhtmltopdf.bidi.BidiSplitter;</span><br>          38:  <span style="background-color: white">      import com.openhtmltopdf.bidi.BidiTextRun;</span><br>          39:  <span style="background-color: white">      import com.openhtmltopdf.bidi.ParagraphSplitter.Paragraph;</span><br>          40:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.CSSName;</span><br>          41:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.IdentValue;</span><br>          42:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.MarginBoxName;</span><br>          43:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.PageElementPosition;</span><br>          44:  <span style="background-color: white">      import com.openhtmltopdf.css.extend.ContentFunction;</span><br>          45:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.CascadedStyle;</span><br>          46:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.PageInfo;</span><br>          47:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.CSSPrimitiveValue;</span><br>          48:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.FSFunction;</span><br>          49:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.PropertyValue;</span><br>          50:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.PropertyDeclaration;</span><br>          51:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.StylesheetInfo;</span><br>          52:  <span style="background-color: white">      import com.openhtmltopdf.css.style.CalculatedStyle;</span><br>          53:  <span style="background-color: white">      import com.openhtmltopdf.css.style.EmptyStyle;</span><br>          54:  <span style="background-color: white">      import com.openhtmltopdf.css.style.FSDerivedValue;</span><br>          55:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableBox;</span><br>          56:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableCellBox;</span><br>          57:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableColumn;</span><br>          58:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableRowBox;</span><br>          59:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableSectionBox;</span><br>          60:  <span style="background-color: white">      import com.openhtmltopdf.render.AnonymousBlockBox;</span><br>          61:  <span style="background-color: white">      import com.openhtmltopdf.render.BlockBox;</span><br>          62:  <span style="background-color: white">      import com.openhtmltopdf.render.Box;</span><br>          63:  <span style="background-color: white">      import com.openhtmltopdf.render.FloatedBoxData;</span><br>          64:  <span style="background-color: white">      import com.openhtmltopdf.render.FlowingColumnBox;</span><br>          65:  <span style="background-color: white">      import com.openhtmltopdf.render.FlowingColumnContainerBox;</span><br>          66:  <span style="background-color: white">      import com.openhtmltopdf.render.InlineBox;</span><br>          67:  <span style="background-color: white">      </span><br>          68:  <span style="background-color: white">      /**</span><br>          69:  <span style="background-color: white">       * This class is responsible for creating the box tree from the DOM.  This is</span><br>          70:  <span style="background-color: white">       * mostly just a one-to-one translation from the <code>Element</code> to an</span><br>          71:  <span style="background-color: white">       * <code>InlineBox</code> or a <code>BlockBox</code> (or some subclass of</span><br>          72:  <span style="background-color: white">       * <code>BlockBox</code>), but the tree is reorganized according to the CSS rules.</span><br>          73:  <span style="background-color: white">       * This includes inserting anonymous block and inline boxes, anonymous table</span><br>          74:  <span style="background-color: white">       * content, and <code>:before</code> and <code>:after</code> content.  White</span><br>          75:  <span style="background-color: white">       * space is also normalized at this point.  Table columns and table column groups</span><br>          76:  <span style="background-color: white">       * are added to the table which owns them, but are not created as regular boxes.</span><br>          77:  <span style="background-color: white">       * Floated and absolutely positioned content is always treated as inline</span><br>          78:  <span style="background-color: white">       * content for purposes of inserting anonymous block boxes and calculating</span><br>          79:  <span style="background-color: white">       * the kind of content contained in a given block box.</span><br>          80:  <span style="background-color: white">       */</span><br>          81:  <span style="background-color: white">      public class BoxBuilder {</span><br>          82:  <span style="background-color: white">          public static final int MARGIN_BOX_VERTICAL = 1;</span><br>          83:  <span style="background-color: white">          public static final int MARGIN_BOX_HORIZONTAL = 2;</span><br>          84:  <span style="background-color: white">      </span><br>          85:  <span style="background-color: white">          private static final int CONTENT_LIST_DOCUMENT = 1;</span><br>          86:  <span style="background-color: white">          private static final int CONTENT_LIST_MARGIN_BOX = 2;</span><br>          87:  <span style="background-color: white">      </span><br>          88:  <span style="background-color: white">          /**</span><br>          89:  <span style="background-color: white">           * Split the document into paragraphs for use in analyzing bi-directional text runs.</span><br>          90:  <span style="background-color: white">           * @param c</span><br>          91:  <span style="background-color: white">           * @param document</span><br>          92:  <span style="background-color: white">           */</span><br>          93:  <span style="background-color: white"> 99+      private static void splitParagraphs(LayoutContext c, Document document) {</span><br>          94:  <span style="background-color: white"> 99+          c.getParagraphSplitter().splitRoot(c, document);</span><br>          95:  <span style="background-color: white"> 99+          c.getParagraphSplitter().runBidiOnParagraphs(c);</span><br>          96:  <span style="background-color: white">          }</span><br>          97:  <span style="background-color: white">          </span><br>          98:  <span style="background-color: white"> 99+      public static BlockBox createRootBox(LayoutContext c, Document document) {</span><br>          99:  <span style="background-color: white"> 99+          splitParagraphs(c, document);</span><br>         100:  <span style="background-color: white">          	</span><br>         101:  <span style="background-color: white"> 99+          Element root = document.getDocumentElement();</span><br>         102:  <span style="background-color: white">      </span><br>         103:  <span style="background-color: white"> 99+          CalculatedStyle style = c.getSharedContext().getStyle(root);</span><br>         104:  <span style="background-color: white">      </span><br>         105:  <span style="background-color: white"> 99+          BlockBox result;</span><br>         106:  <span style="background-color: white"> 99+          if (style.isTable() || style.isInlineTable()) {</span><br>         107:  <span style="background-color: white">   0              result = new TableBox();</span><br>         108:  <span style="background-color: white">              } else {</span><br>         109:  <span style="background-color: white"> 99+              result = new BlockBox();</span><br>         110:  <span style="background-color: white">              }</span><br>         111:  <span style="background-color: white">      </span><br>         112:  <span style="background-color: white"> 99+          result.setStyle(style);</span><br>         113:  <span style="background-color: white"> 99+          result.setElement(root);</span><br>         114:  <span style="background-color: white">      </span><br>         115:  <span style="background-color: white"> 99+          c.resolveCounters(style);</span><br>         116:  <span style="background-color: white">      </span><br>         117:  <span style="background-color: white"> 99+          return result;</span><br>         118:  <span style="background-color: white">          }</span><br>         119:  <span style="background-color: white">      </span><br>         120:  <span style="background-color: white"> 99+      public static void createChildren(LayoutContext c, BlockBox parent) {</span><br>         121:  <span style="background-color: white"> 99+          if (parent.shouldBeReplaced()) {</span><br>         122:  <span style="background-color: yellow"> 99+              parent.setChildrenContentType(BlockBox.CONTENT_EMPTY);</span><br>         123:  <span style="background-color: white"> 99+              return;</span><br>         124:  <span style="background-color: white">              }</span><br>         125:  <span style="background-color: white">      </span><br>         126:  <span style="background-color: white"> 99+          List
       <styleable>
         children = new ArrayList&lt;&gt;();
       </styleable></span><br>         127:  <span style="background-color: white">      </span><br>         128:  <span style="background-color: white"> 99+          ChildBoxInfo info = new ChildBoxInfo();</span><br>         129:  <span style="background-color: white">      </span><br>         130:  <span style="background-color: white"> 99+          createChildren(c, parent, parent.getElement(), children, info, false);</span><br>         131:  <span style="background-color: white">      </span><br>         132:  <span style="background-color: yellow"> 99+          boolean parentIsNestingTableContent = isNestingTableContent(parent.getStyle().getIdent(</span><br>         133:  <span style="background-color: white">                      CSSName.DISPLAY));</span><br>         134:  <span style="background-color: white">              </span><br>         135:  <span style="background-color: white"> 99+          if (!parentIsNestingTableContent &amp;&amp; !info.isContainsTableContent()) {</span><br>         136:  <span style="background-color: white"> 99+              resolveChildren(c, parent, children, info);</span><br>         137:  <span style="background-color: white">              } else {</span><br>         138:  <span style="background-color: white"> 99+              stripAllWhitespace(children);</span><br>         139:  <span style="background-color: white"> 99+              if (parentIsNestingTableContent) {</span><br>         140:  <span style="background-color: white"> 99+                  resolveTableContent(c, parent, children, info);</span><br>         141:  <span style="background-color: white">                  } else {</span><br>         142:  <span style="background-color: white">   7                  resolveChildTableContent(c, parent, children, info, IdentValue.TABLE_CELL);</span><br>         143:  <span style="background-color: white">                  }</span><br>         144:  <span style="background-color: white">              }</span><br>         145:  <span style="background-color: white">          }</span><br>         146:  <span style="background-color: white">      </span><br>         147:  <span style="background-color: white"> 99+      public static TableBox createMarginTable(</span><br>         148:  <span style="background-color: white">                  LayoutContext c,</span><br>         149:  <span style="background-color: white">                  PageInfo pageInfo,</span><br>         150:  <span style="background-color: white">                  MarginBoxName[] names,</span><br>         151:  <span style="background-color: white">                  int height,</span><br>         152:  <span style="background-color: white">                  int direction)</span><br>         153:  <span style="background-color: white">          {</span><br>         154:  <span style="background-color: white"> 99+          if (! pageInfo.hasAny(names)) {</span><br>         155:  <span style="background-color: white"> 99+              return null;</span><br>         156:  <span style="background-color: white">              }</span><br>         157:  <span style="background-color: white">      </span><br>         158:  <span style="background-color: white"> 99+          Element source = c.getRootLayer().getMaster().getElement(); // HACK</span><br>         159:  <span style="background-color: white">      </span><br>         160:  <span style="background-color: white"> 99+          ChildBoxInfo info = new ChildBoxInfo();</span><br>         161:  <span style="background-color: white"> 99+          CalculatedStyle pageStyle = new EmptyStyle().deriveStyle(pageInfo.getPageStyle());</span><br>         162:  <span style="background-color: white">      </span><br>         163:  <span style="background-color: white"> 99+          CalculatedStyle tableStyle = pageStyle.deriveStyle(</span><br>         164:  <span style="background-color: white">                      CascadedStyle.createLayoutStyle(new PropertyDeclaration[] {</span><br>         165:  <span style="background-color: white">                              new PropertyDeclaration(</span><br>         166:  <span style="background-color: white">                                      CSSName.DISPLAY,</span><br>         167:  <span style="background-color: white">                                      new PropertyValue(IdentValue.TABLE),</span><br>         168:  <span style="background-color: white">                                      true,</span><br>         169:  <span style="background-color: white">                                      StylesheetInfo.USER),</span><br>         170:  <span style="background-color: white">                              new PropertyDeclaration(</span><br>         171:  <span style="background-color: white">                                      CSSName.WIDTH,</span><br>         172:  <span style="background-color: white">                                      new PropertyValue(CSSPrimitiveValue.CSS_PERCENTAGE, 100.0f, "100%"),</span><br>         173:  <span style="background-color: white">                                      true,</span><br>         174:  <span style="background-color: white">                                      StylesheetInfo.USER),</span><br>         175:  <span style="background-color: white">                      }));</span><br>         176:  <span style="background-color: white"> 99+          TableBox result = (TableBox)createBlockBox(tableStyle, info, false);</span><br>         177:  <span style="background-color: white"> 99+          result.setMarginAreaRoot(true);</span><br>         178:  <span style="background-color: white"> 99+          result.setStyle(tableStyle);</span><br>         179:  <span style="background-color: white"> 99+          result.setElement(source);</span><br>         180:  <span style="background-color: white"> 99+          result.setAnonymous(true);</span><br>         181:  <span style="background-color: yellow"> 99+          result.setChildrenContentType(BlockBox.CONTENT_BLOCK);</span><br>         182:  <span style="background-color: white">      </span><br>         183:  <span style="background-color: white"> 99+          CalculatedStyle tableSectionStyle = pageStyle.createAnonymousStyle(IdentValue.TABLE_ROW_GROUP);</span><br>         184:  <span style="background-color: white"> 99+          TableSectionBox section = (TableSectionBox)createBlockBox(tableSectionStyle, info, false);</span><br>         185:  <span style="background-color: white"> 99+          section.setStyle(tableSectionStyle);</span><br>         186:  <span style="background-color: white"> 99+          section.setElement(source);</span><br>         187:  <span style="background-color: white"> 99+          section.setAnonymous(true);</span><br>         188:  <span style="background-color: yellow"> 99+          section.setChildrenContentType(BlockBox.CONTENT_BLOCK);</span><br>         189:  <span style="background-color: white">      </span><br>         190:  <span style="background-color: white"> 99+          result.addChild(section);</span><br>         191:  <span style="background-color: white">      </span><br>         192:  <span style="background-color: white"> 99+          TableRowBox row = null;</span><br>         193:  <span style="background-color: yellow"> 99+          if (direction == MARGIN_BOX_HORIZONTAL) {</span><br>         194:  <span style="background-color: yellow"> 99+              CalculatedStyle tableRowStyle = pageStyle.createAnonymousStyle(IdentValue.TABLE_ROW);</span><br>         195:  <span style="background-color: yellow"> 99+              row = (TableRowBox)createBlockBox(tableRowStyle, info, false);</span><br>         196:  <span style="background-color: yellow"> 99+              row.setStyle(tableRowStyle);</span><br>         197:  <span style="background-color: yellow"> 99+              row.setElement(source);</span><br>         198:  <span style="background-color: yellow"> 99+              row.setAnonymous(true);</span><br>         199:  <span style="background-color: yellow"> 99+              row.setChildrenContentType(BlockBox.CONTENT_BLOCK);</span><br>         200:  <span style="background-color: yellow">      </span><br>         201:  <span style="background-color: yellow"> 99+              row.setHeightOverride(height);</span><br>         202:  <span style="background-color: yellow">      </span><br>         203:  <span style="background-color: yellow"> 99+              section.addChild(row);</span><br>         204:  <span style="background-color: yellow">              }</span><br>         205:  <span style="background-color: white">      </span><br>         206:  <span style="background-color: white"> 99+          int cellCount = 0;</span><br>         207:  <span style="background-color: white"> 99+          boolean alwaysCreate = names.length &gt; 1 &amp;&amp; direction == MARGIN_BOX_HORIZONTAL;</span><br>         208:  <span style="background-color: white">      </span><br>         209:  <span style="background-color: white"> 99+          for (int i = 0; i &lt; names.length; i++) {</span><br>         210:  <span style="background-color: white"> 99+              CascadedStyle cellStyle = pageInfo.createMarginBoxStyle(names[i], alwaysCreate);</span><br>         211:  <span style="background-color: white"> 99+              if (cellStyle != null) {</span><br>         212:  <span style="background-color: white"> 99+                  TableCellBox cell = createMarginBox(c, cellStyle, alwaysCreate);</span><br>         213:  <span style="background-color: white"> 99+                  if (cell != null) {</span><br>         214:  <span style="background-color: yellow"> 99+                      if (direction == MARGIN_BOX_VERTICAL) {</span><br>         215:  <span style="background-color: yellow">  84                          CalculatedStyle tableRowStyle = pageStyle.createAnonymousStyle(IdentValue.TABLE_ROW);</span><br>         216:  <span style="background-color: yellow">  84                          row = (TableRowBox)createBlockBox(tableRowStyle, info, false);</span><br>         217:  <span style="background-color: yellow">  84                          row.setStyle(tableRowStyle);</span><br>         218:  <span style="background-color: yellow">  84                          row.setElement(source);</span><br>         219:  <span style="background-color: yellow">  84                          row.setAnonymous(true);</span><br>         220:  <span style="background-color: yellow">  84                          row.setChildrenContentType(BlockBox.CONTENT_BLOCK);</span><br>         221:  <span style="background-color: yellow">      </span><br>         222:  <span style="background-color: yellow">  84                          row.setHeightOverride(height);</span><br>         223:  <span style="background-color: yellow">      </span><br>         224:  <span style="background-color: yellow">  84                          section.addChild(row);</span><br>         225:  <span style="background-color: yellow">                          }</span><br>         226:  <span style="background-color: white"> 99+                      row.addChild(cell);</span><br>         227:  <span style="background-color: white"> 99+                      cellCount++;</span><br>         228:  <span style="background-color: white">                      }</span><br>         229:  <span style="background-color: white">                  }</span><br>         230:  <span style="background-color: white">              }</span><br>         231:  <span style="background-color: white">      </span><br>         232:  <span style="background-color: white"> 99+          if (direction == MARGIN_BOX_VERTICAL &amp;&amp; cellCount &gt; 0) {</span><br>         233:  <span style="background-color: white">  62              int rHeight = 0;</span><br>         234:  <span style="background-color: white"> 99+              for (Iterator
       <box>
         i = section.getChildIterator(); i.hasNext(); ) {
       </box></span><br>         235:  <span style="background-color: white">  84                  TableRowBox r = (TableRowBox)i.next();</span><br>         236:  <span style="background-color: white">  84                  r.setHeightOverride(height / cellCount);</span><br>         237:  <span style="background-color: white">  84                  rHeight += r.getHeightOverride();</span><br>         238:  <span style="background-color: white">                  }</span><br>         239:  <span style="background-color: white">      </span><br>         240:  <span style="background-color: white">  74              for (Iterator
       <box>
         i = section.getChildIterator(); i.hasNext() &amp;&amp; rHeight &lt; height; ) {
       </box></span><br>         241:  <span style="background-color: white">  12                  TableRowBox r = (TableRowBox)i.next();</span><br>         242:  <span style="background-color: white">  12                  r.setHeightOverride(r.getHeightOverride()+1);</span><br>         243:  <span style="background-color: white">  12                  rHeight++;</span><br>         244:  <span style="background-color: white">                  }</span><br>         245:  <span style="background-color: white">              }</span><br>         246:  <span style="background-color: white">      </span><br>         247:  <span style="background-color: white"> 99+          return cellCount &gt; 0 ? result : null;</span><br>         248:  <span style="background-color: white">          }</span><br>         249:  <span style="background-color: white">      </span><br>         250:  <span style="background-color: white"> 99+      private static TableCellBox createMarginBox(</span><br>         251:  <span style="background-color: white">                  LayoutContext c,</span><br>         252:  <span style="background-color: white">                  CascadedStyle cascadedStyle,</span><br>         253:  <span style="background-color: white">                  boolean alwaysCreate) {</span><br>         254:  <span style="background-color: white"> 99+          boolean hasContent = true;</span><br>         255:  <span style="background-color: white">      </span><br>         256:  <span style="background-color: white"> 99+          PropertyDeclaration contentDecl = cascadedStyle.propertyByName(CSSName.CONTENT);</span><br>         257:  <span style="background-color: white">      </span><br>         258:  <span style="background-color: white"> 99+          CalculatedStyle style = new EmptyStyle().deriveStyle(cascadedStyle);</span><br>         259:  <span style="background-color: white">      </span><br>         260:  <span style="background-color: white"> 99+          if (style.isDisplayNone() &amp;&amp; ! alwaysCreate) {</span><br>         261:  <span style="background-color: white">   0              return null;</span><br>         262:  <span style="background-color: white">              }</span><br>         263:  <span style="background-color: white">      </span><br>         264:  <span style="background-color: white"> 99+          if (style.isIdent(CSSName.CONTENT, IdentValue.NONE) ||</span><br>         265:  <span style="background-color: white">                      style.isIdent(CSSName.CONTENT, IdentValue.NORMAL)) {</span><br>         266:  <span style="background-color: white"> 99+              hasContent = false;</span><br>         267:  <span style="background-color: white">              }</span><br>         268:  <span style="background-color: white">      </span><br>         269:  <span style="background-color: white"> 99+          if (style.isAutoWidth() &amp;&amp; ! alwaysCreate &amp;&amp; ! hasContent) {</span><br>         270:  <span style="background-color: white">   0              return null;</span><br>         271:  <span style="background-color: white">              }</span><br>         272:  <span style="background-color: white">      </span><br>         273:  <span style="background-color: white"> 99+          List
       <styleable>
         children = new ArrayList&lt;&gt;();
       </styleable></span><br>         274:  <span style="background-color: white">      </span><br>         275:  <span style="background-color: white"> 99+          ChildBoxInfo info = new ChildBoxInfo();</span><br>         276:  <span style="background-color: white"> 99+          info.setContainsTableContent(true);</span><br>         277:  <span style="background-color: white"> 99+          info.setLayoutRunningBlocks(true);</span><br>         278:  <span style="background-color: white">      </span><br>         279:  <span style="background-color: white"> 99+          TableCellBox result = new TableCellBox();</span><br>         280:  <span style="background-color: white"> 99+          result.setAnonymous(true);</span><br>         281:  <span style="background-color: white"> 99+          result.setStyle(style);</span><br>         282:  <span style="background-color: white"> 99+          result.setElement(c.getRootLayer().getMaster().getElement()); // XXX Doesn't make sense, but we need something here</span><br>         283:  <span style="background-color: white">      </span><br>         284:  <span style="background-color: white"> 99+          if (hasContent &amp;&amp; ! style.isDisplayNone()) {</span><br>         285:  <span style="background-color: white"> 99+              children.addAll(createGeneratedMarginBoxContent(</span><br>         286:  <span style="background-color: white">                          c,</span><br>         287:  <span style="background-color: white">                          c.getRootLayer().getMaster().getElement(),</span><br>         288:  <span style="background-color: white">                          (PropertyValue)contentDecl.getValue(),</span><br>         289:  <span style="background-color: white">                          style,</span><br>         290:  <span style="background-color: white">                          info));</span><br>         291:  <span style="background-color: white">      </span><br>         292:  <span style="background-color: white"> 99+              stripAllWhitespace(children);</span><br>         293:  <span style="background-color: white">              }</span><br>         294:  <span style="background-color: white">      </span><br>         295:  <span style="background-color: white"> 99+          resolveChildTableContent(c, result, children, info, IdentValue.TABLE_CELL);</span><br>         296:  <span style="background-color: white">      </span><br>         297:  <span style="background-color: white"> 99+          return result;</span><br>         298:  <span style="background-color: white">          }</span><br>         299:  <span style="background-color: white">      </span><br>         300:  <span style="background-color: white"> 99+      private static void resolveChildren(</span><br>         301:  <span style="background-color: white">                  LayoutContext c, BlockBox owner, List
       <styleable>
         children, ChildBoxInfo info) {
       </styleable></span><br>         302:  <span style="background-color: white"> 99+          if (children.size() &gt; 0) {</span><br>         303:  <span style="background-color: white"> 99+              if (info.isContainsBlockLevelContent()) {</span><br>         304:  <span style="background-color: white"> 99+                  insertAnonymousBlocks(</span><br>         305:  <span style="background-color: white">                              c.getSharedContext(), owner, children, info.isLayoutRunningBlocks());</span><br>         306:  <span style="background-color: yellow"> 99+                  owner.setChildrenContentType(BlockBox.CONTENT_BLOCK);</span><br>         307:  <span style="background-color: white">                  } else {</span><br>         308:  <span style="background-color: white"> 99+                  WhitespaceStripper.stripInlineContent(children);</span><br>         309:  <span style="background-color: white"> 99+                  if (children.size() &gt; 0) {</span><br>         310:  <span style="background-color: white"> 99+                      owner.setInlineContent(children);</span><br>         311:  <span style="background-color: yellow"> 99+                      owner.setChildrenContentType(BlockBox.CONTENT_INLINE);</span><br>         312:  <span style="background-color: white">                      } else {</span><br>         313:  <span style="background-color: yellow"> 99+                      owner.setChildrenContentType(BlockBox.CONTENT_EMPTY);</span><br>         314:  <span style="background-color: white">                      }</span><br>         315:  <span style="background-color: white">                  }</span><br>         316:  <span style="background-color: white">              } else {</span><br>         317:  <span style="background-color: yellow"> 99+              owner.setChildrenContentType(BlockBox.CONTENT_EMPTY);</span><br>         318:  <span style="background-color: white">              }</span><br>         319:  <span style="background-color: white">          }</span><br>         320:  <span style="background-color: white">      </span><br>         321:  <span style="background-color: white"> 99+      private static boolean isAllProperTableNesting(IdentValue parentDisplay, List
       <styleable>
         children) {
       </styleable></span><br>         322:  <span style="background-color: white"> 99+          return children.stream().allMatch(child -&gt; isProperTableNesting(parentDisplay, child.getStyle().getIdent(CSSName.DISPLAY)));</span><br>         323:  <span style="background-color: white">          }</span><br>         324:  <span style="background-color: white">      </span><br>         325:  <span style="background-color: white">          /**</span><br>         326:  <span style="background-color: white">           * Handles the situation when we find table content, but our parent is not</span><br>         327:  <span style="background-color: white">           * table related.  For example, <code>div</code> -&gt; <code>td</code>.</span><br>         328:  <span style="background-color: white">           * Anonymous tables are then constructed by repeatedly pulling together</span><br>         329:  <span style="background-color: white">           * consecutive same-table-level siblings and wrapping them in the next</span><br>         330:  <span style="background-color: white">           * highest table level (e.g. consecutive <code>td</code> elements will</span><br>         331:  <span style="background-color: white">           * be wrapped in an anonymous <code>tr</code>, then a <code>tbody</code>, and</span><br>         332:  <span style="background-color: white">           * finally a <code>table</code>).</span><br>         333:  <span style="background-color: white">           */</span><br>         334:  <span style="background-color: white"> 99+      private static void resolveChildTableContent(</span><br>         335:  <span style="background-color: white">                  LayoutContext c, BlockBox parent, List
       <styleable>
         children, ChildBoxInfo info, IdentValue target) {
       </styleable></span><br>         336:  <span style="background-color: white"> 99+          List
       <styleable>
         childrenForAnonymous = new ArrayList&lt;&gt;();
       </styleable></span><br>         337:  <span style="background-color: white"> 99+          List
       <styleable>
         childrenWithAnonymous = new ArrayList&lt;&gt;();
       </styleable></span><br>         338:  <span style="background-color: white">      </span><br>         339:  <span style="background-color: white"> 99+          IdentValue nextUp = getPreviousTableNestingLevel(target);</span><br>         340:  <span style="background-color: white">              </span><br>         341:  <span style="background-color: white"> 99+          for (Styleable styleable : children) {</span><br>         342:  <span style="background-color: white"> 99+              if (matchesTableLevel(target, styleable.getStyle().getIdent(CSSName.DISPLAY))) {</span><br>         343:  <span style="background-color: white">  54                  childrenForAnonymous.add(styleable);</span><br>         344:  <span style="background-color: white">                  } else {</span><br>         345:  <span style="background-color: white"> 99+                  if (childrenForAnonymous.size() &gt; 0) {</span><br>         346:  <span style="background-color: white">  20                      createAnonymousTableContent(c, (BlockBox) childrenForAnonymous.get(0), nextUp,</span><br>         347:  <span style="background-color: white">                                  childrenForAnonymous, childrenWithAnonymous);</span><br>         348:  <span style="background-color: white">      </span><br>         349:  <span style="background-color: white">  20                      childrenForAnonymous = new ArrayList&lt;&gt;();</span><br>         350:  <span style="background-color: white">                      }</span><br>         351:  <span style="background-color: white"> 99+                  childrenWithAnonymous.add(styleable);</span><br>         352:  <span style="background-color: white">                  }</span><br>         353:  <span style="background-color: white">              }</span><br>         354:  <span style="background-color: white">      </span><br>         355:  <span style="background-color: white"> 99+          if (childrenForAnonymous.size() &gt; 0) {</span><br>         356:  <span style="background-color: white">  24              createAnonymousTableContent(c, (BlockBox) childrenForAnonymous.get(0), nextUp,</span><br>         357:  <span style="background-color: white">                          childrenForAnonymous, childrenWithAnonymous);</span><br>         358:  <span style="background-color: white">              }</span><br>         359:  <span style="background-color: white">      </span><br>         360:  <span style="background-color: white"> 99+          if (nextUp == IdentValue.TABLE) {</span><br>         361:  <span style="background-color: white"> 99+              rebalanceInlineContent(childrenWithAnonymous);</span><br>         362:  <span style="background-color: white"> 99+              info.setContainsBlockLevelContent(true);</span><br>         363:  <span style="background-color: white"> 99+              resolveChildren(c, parent, childrenWithAnonymous, info);</span><br>         364:  <span style="background-color: white">              } else {</span><br>         365:  <span style="background-color: white"> 99+              resolveChildTableContent(c, parent, childrenWithAnonymous, info, nextUp);</span><br>         366:  <span style="background-color: white">              }</span><br>         367:  <span style="background-color: white">          }</span><br>         368:  <span style="background-color: white">      </span><br>         369:  <span style="background-color: white"> 99+      private static boolean matchesTableLevel(IdentValue target, IdentValue value) {</span><br>         370:  <span style="background-color: white"> 99+          if (target == IdentValue.TABLE_ROW_GROUP) {</span><br>         371:  <span style="background-color: white"> 99+              return value == IdentValue.TABLE_ROW_GROUP || value == IdentValue.TABLE_HEADER_GROUP</span><br>         372:  <span style="background-color: white">                          || value == IdentValue.TABLE_FOOTER_GROUP || value == IdentValue.TABLE_CAPTION;</span><br>         373:  <span style="background-color: white">              } else {</span><br>         374:  <span style="background-color: white"> 99+              return target == value;</span><br>         375:  <span style="background-color: white">              }</span><br>         376:  <span style="background-color: white">          }</span><br>         377:  <span style="background-color: white">      </span><br>         378:  <span style="background-color: white">          /**</span><br>         379:  <span style="background-color: white">           * Makes sure that any <code>InlineBox</code> in <code>content</code></span><br>         380:  <span style="background-color: white">           * both starts and ends within <code>content</code>. Used to ensure that</span><br>         381:  <span style="background-color: white">           * it is always possible to construct anonymous blocks once an element's</span><br>         382:  <span style="background-color: white">           * children has been distributed among anonymous table objects.</span><br>         383:  <span style="background-color: white">           */</span><br>         384:  <span style="background-color: white"> 99+      private static void rebalanceInlineContent(List
       <styleable>
         content) {
       </styleable></span><br>         385:  <span style="background-color: white"> 99+          Map
       <element, inlinebox>
         boxesByElement = new HashMap&lt;&gt;();
       </element,></span><br>         386:  <span style="background-color: white"> 99+          for (Styleable styleable : content) {</span><br>         387:  <span style="background-color: white"> 99+              if (styleable instanceof InlineBox) {</span><br>         388:  <span style="background-color: white"> 99+                  InlineBox iB = (InlineBox) styleable;</span><br>         389:  <span style="background-color: white"> 99+                  Element elem = iB.getElement();</span><br>         390:  <span style="background-color: white">      </span><br>         391:  <span style="background-color: white"> 99+                  if (!boxesByElement.containsKey(elem)) {</span><br>         392:  <span style="background-color: white"> 99+                      iB.setStartsHere(true);</span><br>         393:  <span style="background-color: white">                      }</span><br>         394:  <span style="background-color: white">      </span><br>         395:  <span style="background-color: white"> 99+                  boxesByElement.put(elem, iB);</span><br>         396:  <span style="background-color: white">                  }</span><br>         397:  <span style="background-color: white">              }</span><br>         398:  <span style="background-color: white">      </span><br>         399:  <span style="background-color: white"> 99+          for (InlineBox iB : boxesByElement.values()) {</span><br>         400:  <span style="background-color: white"> 99+              iB.setEndsHere(true);</span><br>         401:  <span style="background-color: white">              }</span><br>         402:  <span style="background-color: white">          }</span><br>         403:  <span style="background-color: white">      </span><br>         404:  <span style="background-color: white"> 99+      private static void stripAllWhitespace(List
       <styleable>
         content) {
       </styleable></span><br>         405:  <span style="background-color: white"> 99+          int start = 0;</span><br>         406:  <span style="background-color: white"> 99+          int current = 0;</span><br>         407:  <span style="background-color: white"> 99+          boolean started = false;</span><br>         408:  <span style="background-color: white"> 99+          for (current = 0; current &lt; content.size(); current++) {</span><br>         409:  <span style="background-color: white"> 99+              Styleable styleable = content.get(current);</span><br>         410:  <span style="background-color: white"> 99+              if (! styleable.getStyle().isLayedOutInInlineContext()) {</span><br>         411:  <span style="background-color: white"> 99+                  if (started) {</span><br>         412:  <span style="background-color: white"> 99+                      int before = content.size();</span><br>         413:  <span style="background-color: white"> 99+                      WhitespaceStripper.stripInlineContent(content.subList(start, current));</span><br>         414:  <span style="background-color: white"> 99+                      int after = content.size();</span><br>         415:  <span style="background-color: white"> 99+                      current -= (before - after);</span><br>         416:  <span style="background-color: white">                      }</span><br>         417:  <span style="background-color: white"> 99+                  started = false;</span><br>         418:  <span style="background-color: white">                  } else {</span><br>         419:  <span style="background-color: white"> 99+                  if (! started) {</span><br>         420:  <span style="background-color: white"> 99+                      started = true;</span><br>         421:  <span style="background-color: white"> 99+                      start = current;</span><br>         422:  <span style="background-color: white">                      }</span><br>         423:  <span style="background-color: white">                  }</span><br>         424:  <span style="background-color: white">              }</span><br>         425:  <span style="background-color: white">      </span><br>         426:  <span style="background-color: white"> 99+          if (started) {</span><br>         427:  <span style="background-color: white"> 99+              WhitespaceStripper.stripInlineContent(content.subList(start, current));</span><br>         428:  <span style="background-color: white">              }</span><br>         429:  <span style="background-color: white">          }</span><br>         430:  <span style="background-color: white">      </span><br>         431:  <span style="background-color: white">          /**</span><br>         432:  <span style="background-color: white">           * Handles the situation when our current parent is table related.  If</span><br>         433:  <span style="background-color: white">           * everything is properly nested (e.g. a <code>tr</code> contains only</span><br>         434:  <span style="background-color: white">           * <code>td</code> elements), nothing is done.  Otherwise anonymous boxes</span><br>         435:  <span style="background-color: white">           * are inserted to ensure the integrity of the table model.</span><br>         436:  <span style="background-color: white">           */</span><br>         437:  <span style="background-color: white"> 99+      private static void resolveTableContent(</span><br>         438:  <span style="background-color: white">                  LayoutContext c, BlockBox parent, List
       <styleable>
         children, ChildBoxInfo info) {
       </styleable></span><br>         439:  <span style="background-color: white"> 99+          IdentValue parentDisplay = parent.getStyle().getIdent(CSSName.DISPLAY);</span><br>         440:  <span style="background-color: white"> 99+          IdentValue next = getNextTableNestingLevel(parentDisplay);</span><br>         441:  <span style="background-color: white"> 99+          if (next == null &amp;&amp; parent.isAnonymous() &amp;&amp; containsOrphanedTableContent(children)) {</span><br>         442:  <span style="background-color: white">  10              resolveChildTableContent(c, parent, children, info, IdentValue.TABLE_CELL);</span><br>         443:  <span style="background-color: white"> 99+          } else if (next == null || isAllProperTableNesting(parentDisplay, children)) {</span><br>         444:  <span style="background-color: white"> 99+              if (parent.isAnonymous()) {</span><br>         445:  <span style="background-color: white"> 99+                  rebalanceInlineContent(children);</span><br>         446:  <span style="background-color: white">                  }</span><br>         447:  <span style="background-color: white"> 99+              resolveChildren(c, parent, children, info);</span><br>         448:  <span style="background-color: white">              } else {</span><br>         449:  <span style="background-color: white"> 99+              List
       <styleable>
         childrenForAnonymous = new ArrayList&lt;&gt;();
       </styleable></span><br>         450:  <span style="background-color: white"> 99+              List
       <styleable>
         childrenWithAnonymous = new ArrayList&lt;&gt;();
       </styleable></span><br>         451:  <span style="background-color: white">                  </span><br>         452:  <span style="background-color: white"> 99+              for (Styleable child : children) {</span><br>         453:  <span style="background-color: white"> 99+                  IdentValue childDisplay = child.getStyle().getIdent(CSSName.DISPLAY);</span><br>         454:  <span style="background-color: white">      </span><br>         455:  <span style="background-color: white"> 99+                  if (isProperTableNesting(parentDisplay, childDisplay)) {</span><br>         456:  <span style="background-color: white">  56                      if (childrenForAnonymous.size() &gt; 0) {</span><br>         457:  <span style="background-color: white">  36                          createAnonymousTableContent(c, parent, next, childrenForAnonymous,</span><br>         458:  <span style="background-color: white">                                      childrenWithAnonymous);</span><br>         459:  <span style="background-color: white">      </span><br>         460:  <span style="background-color: white">  36                          childrenForAnonymous = new ArrayList&lt;&gt;();</span><br>         461:  <span style="background-color: white">                          }</span><br>         462:  <span style="background-color: white">  56                      childrenWithAnonymous.add(child);</span><br>         463:  <span style="background-color: white">                      } else {</span><br>         464:  <span style="background-color: white"> 99+                      childrenForAnonymous.add(child);</span><br>         465:  <span style="background-color: white">                      }</span><br>         466:  <span style="background-color: white">                  }</span><br>         467:  <span style="background-color: white">      </span><br>         468:  <span style="background-color: white"> 99+              if (childrenForAnonymous.size() &gt; 0) {</span><br>         469:  <span style="background-color: white"> 99+                  createAnonymousTableContent(c, parent, next, childrenForAnonymous,</span><br>         470:  <span style="background-color: white">                              childrenWithAnonymous);</span><br>         471:  <span style="background-color: white">                  }</span><br>         472:  <span style="background-color: white">      </span><br>         473:  <span style="background-color: white"> 99+              info.setContainsBlockLevelContent(true);</span><br>         474:  <span style="background-color: white"> 99+              resolveChildren(c, parent, childrenWithAnonymous, info);</span><br>         475:  <span style="background-color: white">              }</span><br>         476:  <span style="background-color: white">          }</span><br>         477:  <span style="background-color: white">          </span><br>         478:  <span style="background-color: white">  70      private static boolean isTableRowOrRowGroup(Styleable child) {</span><br>         479:  <span style="background-color: white">  70          IdentValue display = child.getStyle().getIdent(CSSName.DISPLAY);</span><br>         480:  <span style="background-color: white">  70          return (display == IdentValue.TABLE_HEADER_GROUP ||</span><br>         481:  <span style="background-color: white">                      display == IdentValue.TABLE_ROW_GROUP ||</span><br>         482:  <span style="background-color: white">                      display == IdentValue.TABLE_FOOTER_GROUP ||</span><br>         483:  <span style="background-color: white">                      display == IdentValue.TABLE_ROW);</span><br>         484:  <span style="background-color: white">          }</span><br>         485:  <span style="background-color: white">      </span><br>         486:  <span style="background-color: white">  70      private static boolean containsOrphanedTableContent(List
       <styleable>
         children) {
       </styleable></span><br>         487:  <span style="background-color: white">  70          return children.stream().anyMatch(BoxBuilder::isTableRowOrRowGroup);</span><br>         488:  <span style="background-color: white">          }</span><br>         489:  <span style="background-color: white">      </span><br>         490:  <span style="background-color: white"> 99+      private static boolean isParentInline(BlockBox box) {</span><br>         491:  <span style="background-color: white"> 99+          CalculatedStyle parentStyle = box.getStyle().getParent();</span><br>         492:  <span style="background-color: white"> 99+          return parentStyle != null &amp;&amp; parentStyle.isInline();</span><br>         493:  <span style="background-color: white">          }</span><br>         494:  <span style="background-color: white">      </span><br>         495:  <span style="background-color: white"> 99+      private static void createAnonymousTableContent(LayoutContext c, BlockBox source,</span><br>         496:  <span style="background-color: white">                                                          IdentValue next, List
       <styleable>
         childrenForAnonymous, List
        <styleable>
          childrenWithAnonymous) {
        </styleable>
       </styleable></span><br>         497:  <span style="background-color: white"> 99+          ChildBoxInfo nested = lookForBlockContent(childrenForAnonymous);</span><br>         498:  <span style="background-color: white"> 99+          IdentValue anonDisplay;</span><br>         499:  <span style="background-color: white"> 99+          if (isParentInline(source) &amp;&amp; next == IdentValue.TABLE) {</span><br>         500:  <span style="background-color: white">   0              anonDisplay = IdentValue.INLINE_TABLE;</span><br>         501:  <span style="background-color: white">              } else {</span><br>         502:  <span style="background-color: white"> 99+              anonDisplay = next;</span><br>         503:  <span style="background-color: white">              }</span><br>         504:  <span style="background-color: white"> 99+          CalculatedStyle anonStyle = source.getStyle().createAnonymousStyle(anonDisplay);</span><br>         505:  <span style="background-color: white"> 99+          BlockBox anonBox = createBlockBox(anonStyle, nested, false);</span><br>         506:  <span style="background-color: white"> 99+          anonBox.setStyle(anonStyle);</span><br>         507:  <span style="background-color: white"> 99+          anonBox.setAnonymous(true);</span><br>         508:  <span style="background-color: white">              // XXX Doesn't really make sense, but what to do?</span><br>         509:  <span style="background-color: white"> 99+          anonBox.setElement(source.getElement());</span><br>         510:  <span style="background-color: white"> 99+          resolveTableContent(c, anonBox, childrenForAnonymous, nested);</span><br>         511:  <span style="background-color: white">      </span><br>         512:  <span style="background-color: white"> 99+          if (next == IdentValue.TABLE) {</span><br>         513:  <span style="background-color: white">  36              childrenWithAnonymous.add(reorderTableContent(c, (TableBox) anonBox));</span><br>         514:  <span style="background-color: white">              } else {</span><br>         515:  <span style="background-color: white"> 99+              childrenWithAnonymous.add(anonBox);</span><br>         516:  <span style="background-color: white">              }</span><br>         517:  <span style="background-color: white">          }</span><br>         518:  <span style="background-color: white">      </span><br>         519:  <span style="background-color: white">          /**</span><br>         520:  <span style="background-color: white">           * Reorganizes a table so that the header is the first row group and the</span><br>         521:  <span style="background-color: white">           * footer the last.  If the table has caption boxes, they will be pulled</span><br>         522:  <span style="background-color: white">           * out and added to an anonymous block box along with the table itself.</span><br>         523:  <span style="background-color: white">           * If not, the table is returned.</span><br>         524:  <span style="background-color: white">           */</span><br>         525:  <span style="background-color: white"> 99+      private static BlockBox reorderTableContent(LayoutContext c, TableBox table) {</span><br>         526:  <span style="background-color: white"> 99+          List
       <box>
         topCaptions = new ArrayList&lt;&gt;();
       </box></span><br>         527:  <span style="background-color: white"> 99+          Box header = null;</span><br>         528:  <span style="background-color: white"> 99+          List
       <box>
         bodies = new ArrayList&lt;&gt;();
       </box></span><br>         529:  <span style="background-color: white"> 99+          Box footer = null;</span><br>         530:  <span style="background-color: white"> 99+          List
       <box>
         bottomCaptions = new ArrayList&lt;&gt;();
       </box></span><br>         531:  <span style="background-color: white">      </span><br>         532:  <span style="background-color: white"> 99+          for (Box b : table.getChildren()) {</span><br>         533:  <span style="background-color: white"> 99+              IdentValue display = b.getStyle().getIdent(CSSName.DISPLAY);</span><br>         534:  <span style="background-color: white">                  </span><br>         535:  <span style="background-color: white"> 99+              if (display == IdentValue.TABLE_CAPTION) {</span><br>         536:  <span style="background-color: white">   6                  IdentValue side = b.getStyle().getIdent(CSSName.CAPTION_SIDE);</span><br>         537:  <span style="background-color: white">   6                  if (side == IdentValue.BOTTOM) {</span><br>         538:  <span style="background-color: white">   0                      bottomCaptions.add(b);</span><br>         539:  <span style="background-color: white">                      } else { /* side == IdentValue.TOP */</span><br>         540:  <span style="background-color: white">   6                      topCaptions.add(b);</span><br>         541:  <span style="background-color: white">                      }</span><br>         542:  <span style="background-color: white"> 99+              } else if (display == IdentValue.TABLE_HEADER_GROUP &amp;&amp; header == null) {</span><br>         543:  <span style="background-color: white">  76                  header = b;</span><br>         544:  <span style="background-color: white"> 99+              } else if (display == IdentValue.TABLE_FOOTER_GROUP &amp;&amp; footer == null) {</span><br>         545:  <span style="background-color: white">   8                  footer = b;</span><br>         546:  <span style="background-color: white">                  } else {</span><br>         547:  <span style="background-color: white"> 99+                  bodies.add(b);</span><br>         548:  <span style="background-color: white">                  }</span><br>         549:  <span style="background-color: white">              }</span><br>         550:  <span style="background-color: white">      </span><br>         551:  <span style="background-color: white"> 99+          table.removeAllChildren();</span><br>         552:  <span style="background-color: white"> 99+          if (header != null) {</span><br>         553:  <span style="background-color: white">  76              ((TableSectionBox)header).setHeader(true);</span><br>         554:  <span style="background-color: white">  76              table.addChild(header);</span><br>         555:  <span style="background-color: white">              }</span><br>         556:  <span style="background-color: white"> 99+          table.addAllChildren(bodies);</span><br>         557:  <span style="background-color: white"> 99+          if (footer != null) {</span><br>         558:  <span style="background-color: white">   8              ((TableSectionBox)footer).setFooter(true);</span><br>         559:  <span style="background-color: white">   8              table.addChild(footer);</span><br>         560:  <span style="background-color: white">              }</span><br>         561:  <span style="background-color: white">      </span><br>         562:  <span style="background-color: white"> 99+          if (topCaptions.size() == 0 &amp;&amp; bottomCaptions.size() == 0) {</span><br>         563:  <span style="background-color: white"> 99+              return table;</span><br>         564:  <span style="background-color: white">              } else {</span><br>         565:  <span style="background-color: white">                  // If we have a floated table with a caption, we need to float the</span><br>         566:  <span style="background-color: white">                  // outer anonymous box and not the table</span><br>         567:  <span style="background-color: white">   6              CalculatedStyle anonStyle;</span><br>         568:  <span style="background-color: white">   6              if (table.getStyle().isFloated()) {</span><br>         569:  <span style="background-color: white">   0                  CascadedStyle cascadedStyle = CascadedStyle.createLayoutStyle(</span><br>         570:  <span style="background-color: white">                              new PropertyDeclaration[]{</span><br>         571:  <span style="background-color: white">                                      CascadedStyle.createLayoutPropertyDeclaration(</span><br>         572:  <span style="background-color: white">                                              CSSName.DISPLAY, IdentValue.BLOCK),</span><br>         573:  <span style="background-color: white">                                      CascadedStyle.createLayoutPropertyDeclaration(</span><br>         574:  <span style="background-color: white">                                              CSSName.FLOAT, table.getStyle().getIdent(CSSName.FLOAT))});</span><br>         575:  <span style="background-color: white">      </span><br>         576:  <span style="background-color: white">   0                  anonStyle = table.getStyle().deriveStyle(cascadedStyle);</span><br>         577:  <span style="background-color: white">                  } else {</span><br>         578:  <span style="background-color: white">   6                  anonStyle = table.getStyle().createAnonymousStyle(IdentValue.BLOCK);</span><br>         579:  <span style="background-color: white">                  }</span><br>         580:  <span style="background-color: white">      </span><br>         581:  <span style="background-color: white">   6              BlockBox anonBox = new BlockBox();</span><br>         582:  <span style="background-color: white">   6              anonBox.setStyle(anonStyle);</span><br>         583:  <span style="background-color: white">   6              anonBox.setAnonymous(true);</span><br>         584:  <span style="background-color: white">   6              anonBox.setFromCaptionedTable(true);</span><br>         585:  <span style="background-color: white">   6              anonBox.setElement(table.getElement());</span><br>         586:  <span style="background-color: white">      </span><br>         587:  <span style="background-color: yellow">   6              anonBox.setChildrenContentType(BlockBox.CONTENT_BLOCK);</span><br>         588:  <span style="background-color: white">   6              anonBox.addAllChildren(topCaptions);</span><br>         589:  <span style="background-color: white">   6              anonBox.addChild(table);</span><br>         590:  <span style="background-color: white">   6              anonBox.addAllChildren(bottomCaptions);</span><br>         591:  <span style="background-color: white">      </span><br>         592:  <span style="background-color: white">   6              if (table.getStyle().isFloated()) {</span><br>         593:  <span style="background-color: white">   0                  anonBox.setFloatedBoxData(new FloatedBoxData());</span><br>         594:  <span style="background-color: white">   0                  table.setFloatedBoxData(null);</span><br>         595:  <span style="background-color: white">      </span><br>         596:  <span style="background-color: white">   0                  CascadedStyle original = c.getSharedContext().getCss().getCascadedStyle(</span><br>         597:  <span style="background-color: white">                              table.getElement(), false);</span><br>         598:  <span style="background-color: white">   0                  CascadedStyle modified = CascadedStyle.createLayoutStyle(</span><br>         599:  <span style="background-color: white">                              original,</span><br>         600:  <span style="background-color: white">                              new PropertyDeclaration[]{</span><br>         601:  <span style="background-color: white">                                      CascadedStyle.createLayoutPropertyDeclaration(</span><br>         602:  <span style="background-color: white">                                              CSSName.FLOAT, IdentValue.NONE)</span><br>         603:  <span style="background-color: white">                              });</span><br>         604:  <span style="background-color: white">   0                  table.setStyle(table.getStyle().getParent().deriveStyle(modified));</span><br>         605:  <span style="background-color: white">                  }</span><br>         606:  <span style="background-color: white">      </span><br>         607:  <span style="background-color: white">   6              return anonBox;</span><br>         608:  <span style="background-color: white">              }</span><br>         609:  <span style="background-color: white">          }</span><br>         610:  <span style="background-color: white">      </span><br>         611:  <span style="background-color: white"> 99+      private static ChildBoxInfo lookForBlockContent(List
       <styleable>
         styleables) {
       </styleable></span><br>         612:  <span style="background-color: white"> 99+          ChildBoxInfo result = new ChildBoxInfo();</span><br>         613:  <span style="background-color: white">              </span><br>         614:  <span style="background-color: white"> 99+          if (styleables.stream().anyMatch(s -&gt; !s.getStyle().isLayedOutInInlineContext())) {</span><br>         615:  <span style="background-color: white"> 99+              result.setContainsBlockLevelContent(true);</span><br>         616:  <span style="background-color: white">              }</span><br>         617:  <span style="background-color: white">              </span><br>         618:  <span style="background-color: white"> 99+          return result;</span><br>         619:  <span style="background-color: white">          }</span><br>         620:  <span style="background-color: white">      </span><br>         621:  <span style="background-color: white"> 99+      private static IdentValue getNextTableNestingLevel(IdentValue display) {</span><br>         622:  <span style="background-color: white"> 99+          if (display == IdentValue.TABLE || display == IdentValue.INLINE_TABLE) {</span><br>         623:  <span style="background-color: white"> 99+              return IdentValue.TABLE_ROW_GROUP;</span><br>         624:  <span style="background-color: white"> 99+          } else if (display == IdentValue.TABLE_HEADER_GROUP</span><br>         625:  <span style="background-color: white">                      || display == IdentValue.TABLE_ROW_GROUP</span><br>         626:  <span style="background-color: white">                      || display == IdentValue.TABLE_FOOTER_GROUP) {</span><br>         627:  <span style="background-color: white"> 99+              return IdentValue.TABLE_ROW;</span><br>         628:  <span style="background-color: white"> 99+          } else if (display == IdentValue.TABLE_ROW) {</span><br>         629:  <span style="background-color: white"> 99+              return IdentValue.TABLE_CELL;</span><br>         630:  <span style="background-color: white">              } else {</span><br>         631:  <span style="background-color: white">  70              return null;</span><br>         632:  <span style="background-color: white">              }</span><br>         633:  <span style="background-color: white">          }</span><br>         634:  <span style="background-color: white">      </span><br>         635:  <span style="background-color: white"> 99+      private static IdentValue getPreviousTableNestingLevel(IdentValue display) {</span><br>         636:  <span style="background-color: white"> 99+          if (display == IdentValue.TABLE_CELL) {</span><br>         637:  <span style="background-color: white"> 99+              return IdentValue.TABLE_ROW;</span><br>         638:  <span style="background-color: white"> 99+          } else if (display == IdentValue.TABLE_ROW) {</span><br>         639:  <span style="background-color: white"> 99+              return IdentValue.TABLE_ROW_GROUP;</span><br>         640:  <span style="background-color: white"> 99+          } else if (display == IdentValue.TABLE_HEADER_GROUP</span><br>         641:  <span style="background-color: white">                      || display == IdentValue.TABLE_ROW_GROUP</span><br>         642:  <span style="background-color: white">                      || display == IdentValue.TABLE_FOOTER_GROUP) {</span><br>         643:  <span style="background-color: white"> 99+              return IdentValue.TABLE;</span><br>         644:  <span style="background-color: white">              } else {</span><br>         645:  <span style="background-color: white">   0              return null;</span><br>         646:  <span style="background-color: white">              }</span><br>         647:  <span style="background-color: white">          }</span><br>         648:  <span style="background-color: white">      </span><br>         649:  <span style="background-color: white"> 99+      private static boolean isProperTableNesting(IdentValue parent, IdentValue child) {</span><br>         650:  <span style="background-color: white"> 99+          return (parent == IdentValue.TABLE &amp;&amp; (child == IdentValue.TABLE_HEADER_GROUP ||</span><br>         651:  <span style="background-color: white">                      child == IdentValue.TABLE_ROW_GROUP ||</span><br>         652:  <span style="background-color: white">                      child == IdentValue.TABLE_FOOTER_GROUP ||</span><br>         653:  <span style="background-color: white">                      child == IdentValue.TABLE_CAPTION))</span><br>         654:  <span style="background-color: white">                      || ((parent == IdentValue.TABLE_HEADER_GROUP ||</span><br>         655:  <span style="background-color: white">                      parent == IdentValue.TABLE_ROW_GROUP ||</span><br>         656:  <span style="background-color: white">                      parent == IdentValue.TABLE_FOOTER_GROUP) &amp;&amp;</span><br>         657:  <span style="background-color: white">                      child == IdentValue.TABLE_ROW)</span><br>         658:  <span style="background-color: white">                      || (parent == IdentValue.TABLE_ROW &amp;&amp; child == IdentValue.TABLE_CELL)</span><br>         659:  <span style="background-color: white">                      || (parent == IdentValue.INLINE_TABLE &amp;&amp; (child == IdentValue.TABLE_HEADER_GROUP ||</span><br>         660:  <span style="background-color: white">                      child == IdentValue.TABLE_ROW_GROUP ||</span><br>         661:  <span style="background-color: white">                      child == IdentValue.TABLE_FOOTER_GROUP));</span><br>         662:  <span style="background-color: white">      </span><br>         663:  <span style="background-color: white">          }</span><br>         664:  <span style="background-color: white">      </span><br>         665:  <span style="background-color: white"> 99+      private static boolean isNestingTableContent(IdentValue display) {</span><br>         666:  <span style="background-color: white"> 99+          return display == IdentValue.TABLE || display == IdentValue.INLINE_TABLE ||</span><br>         667:  <span style="background-color: white">                      display == IdentValue.TABLE_HEADER_GROUP || display == IdentValue.TABLE_ROW_GROUP ||</span><br>         668:  <span style="background-color: white">                      display == IdentValue.TABLE_FOOTER_GROUP || display == IdentValue.TABLE_ROW;</span><br>         669:  <span style="background-color: white">          }</span><br>         670:  <span style="background-color: white">      </span><br>         671:  <span style="background-color: white"> 99+      private static boolean isAttrFunction(FSFunction function) {</span><br>         672:  <span style="background-color: white"> 99+          if (function.getName().equals("attr")) {</span><br>         673:  <span style="background-color: white">   8              List
       <propertyvalue>
         params = function.getParameters();
       </propertyvalue></span><br>         674:  <span style="background-color: white">   8              if (params.size() == 1) {</span><br>         675:  <span style="background-color: white">   8                  PropertyValue value = params.get(0);</span><br>         676:  <span style="background-color: white">   8                  return value.getPrimitiveType() == CSSPrimitiveValue.CSS_IDENT;</span><br>         677:  <span style="background-color: white">                  }</span><br>         678:  <span style="background-color: white">              }</span><br>         679:  <span style="background-color: white">      </span><br>         680:  <span style="background-color: white"> 99+          return false;</span><br>         681:  <span style="background-color: white">          }</span><br>         682:  <span style="background-color: white">      </span><br>         683:  <span style="background-color: white"> 99+      public static boolean isElementFunction(FSFunction function) {</span><br>         684:  <span style="background-color: white"> 99+          if (function.getName().equals("element")) {</span><br>         685:  <span style="background-color: white"> 99+              List
       <propertyvalue>
         params = function.getParameters();
       </propertyvalue></span><br>         686:  <span style="background-color: white"> 99+              if (params.size() &lt; 1 || params.size() &gt; 2) {</span><br>         687:  <span style="background-color: white">   0                  return false;</span><br>         688:  <span style="background-color: white">                  }</span><br>         689:  <span style="background-color: white"> 99+              boolean ok = true;</span><br>         690:  <span style="background-color: white"> 99+              PropertyValue value1 = params.get(0);</span><br>         691:  <span style="background-color: white"> 99+              ok = value1.getPrimitiveType() == CSSPrimitiveValue.CSS_IDENT;</span><br>         692:  <span style="background-color: white"> 99+              if (ok &amp;&amp; params.size() == 2) {</span><br>         693:  <span style="background-color: white">   0                  PropertyValue value2 = params.get(1);</span><br>         694:  <span style="background-color: white">   0                  ok = value2.getPrimitiveType() == CSSPrimitiveValue.CSS_IDENT;</span><br>         695:  <span style="background-color: white">                  }</span><br>         696:  <span style="background-color: white">      </span><br>         697:  <span style="background-color: white"> 99+              return ok;</span><br>         698:  <span style="background-color: white">              }</span><br>         699:  <span style="background-color: white">      </span><br>         700:  <span style="background-color: white">  86          return false;</span><br>         701:  <span style="background-color: white">          }</span><br>         702:  <span style="background-color: white">      </span><br>         703:  <span style="background-color: white"> 99+      private static CounterFunction makeCounterFunction(FSFunction function, LayoutContext c, CalculatedStyle style) {</span><br>         704:  <span style="background-color: white"> 99+          if (function.getName().equals("counter")) {</span><br>         705:  <span style="background-color: white"> 99+              List
       <propertyvalue>
         params = function.getParameters();
       </propertyvalue></span><br>         706:  <span style="background-color: white"> 99+              if (params.size() &lt; 1 || params.size() &gt; 2) {</span><br>         707:  <span style="background-color: white">   0                  return null;</span><br>         708:  <span style="background-color: white">                  }</span><br>         709:  <span style="background-color: white">      </span><br>         710:  <span style="background-color: white"> 99+              PropertyValue value = params.get(0);</span><br>         711:  <span style="background-color: white"> 99+              if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_IDENT) {</span><br>         712:  <span style="background-color: white">   0                  return null;</span><br>         713:  <span style="background-color: white">                  }</span><br>         714:  <span style="background-color: white">      </span><br>         715:  <span style="background-color: white"> 99+              String s = value.getStringValue();</span><br>         716:  <span style="background-color: white">                  // counter(page) and counter(pages) are handled separately</span><br>         717:  <span style="background-color: white"> 99+              if (s.equals("page") || s.equals("pages")) {</span><br>         718:  <span style="background-color: white"> 99+                  return null;</span><br>         719:  <span style="background-color: white">                  }</span><br>         720:  <span style="background-color: white">      </span><br>         721:  <span style="background-color: white">   0              String counter = value.getStringValue();</span><br>         722:  <span style="background-color: white">   0              IdentValue listStyleType = IdentValue.DECIMAL;</span><br>         723:  <span style="background-color: white">   0              if (params.size() == 2) {</span><br>         724:  <span style="background-color: white">   0                  value = params.get(1);</span><br>         725:  <span style="background-color: white">   0                  if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_IDENT) {</span><br>         726:  <span style="background-color: white">   0                      return null;</span><br>         727:  <span style="background-color: white">                      }</span><br>         728:  <span style="background-color: white">      </span><br>         729:  <span style="background-color: white">   0                  IdentValue identValue = IdentValue.valueOf(value.getStringValue());</span><br>         730:  <span style="background-color: white">   0                  if (identValue != null) {</span><br>         731:  <span style="background-color: white">   0                      value.setIdentValue(identValue);</span><br>         732:  <span style="background-color: white">   0                      listStyleType = identValue;</span><br>         733:  <span style="background-color: white">                      }</span><br>         734:  <span style="background-color: white">                  }</span><br>         735:  <span style="background-color: white">      </span><br>         736:  <span style="background-color: yellow">   0              int counterValue = c.getCounterContext(style).getCurrentCounterValue(counter);</span><br>         737:  <span style="background-color: white">      </span><br>         738:  <span style="background-color: white">   0              return new CounterFunction(counterValue, listStyleType);</span><br>         739:  <span style="background-color: white">  16          } else if (function.getName().equals("counters")) {</span><br>         740:  <span style="background-color: white">   0              List
       <propertyvalue>
         params = function.getParameters();
       </propertyvalue></span><br>         741:  <span style="background-color: white">   0              if (params.size() &lt; 2 || params.size() &gt; 3) {</span><br>         742:  <span style="background-color: white">   0                  return null;</span><br>         743:  <span style="background-color: white">                  }</span><br>         744:  <span style="background-color: white">      </span><br>         745:  <span style="background-color: white">   0              PropertyValue value = params.get(0);</span><br>         746:  <span style="background-color: white">   0              if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_IDENT) {</span><br>         747:  <span style="background-color: white">   0                  return null;</span><br>         748:  <span style="background-color: white">                  }</span><br>         749:  <span style="background-color: white">      </span><br>         750:  <span style="background-color: white">   0              String counter = value.getStringValue();</span><br>         751:  <span style="background-color: white">      </span><br>         752:  <span style="background-color: white">   0              value = params.get(1);</span><br>         753:  <span style="background-color: white">   0              if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_STRING) {</span><br>         754:  <span style="background-color: white">   0                  return null;</span><br>         755:  <span style="background-color: white">                  }</span><br>         756:  <span style="background-color: white">      </span><br>         757:  <span style="background-color: white">   0              String separator = value.getStringValue();</span><br>         758:  <span style="background-color: white">      </span><br>         759:  <span style="background-color: white">   0              IdentValue listStyleType = IdentValue.DECIMAL;</span><br>         760:  <span style="background-color: white">   0              if (params.size() == 3) {</span><br>         761:  <span style="background-color: white">   0                  value = params.get(2);</span><br>         762:  <span style="background-color: white">   0                  if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_IDENT) {</span><br>         763:  <span style="background-color: white">   0                      return null;</span><br>         764:  <span style="background-color: white">                      }</span><br>         765:  <span style="background-color: white">      </span><br>         766:  <span style="background-color: white">   0                  IdentValue identValue = IdentValue.valueOf(value.getStringValue());</span><br>         767:  <span style="background-color: white">   0                  if (identValue != null) {</span><br>         768:  <span style="background-color: white">   0                      value.setIdentValue(identValue);</span><br>         769:  <span style="background-color: white">   0                      listStyleType = identValue;</span><br>         770:  <span style="background-color: white">                      }</span><br>         771:  <span style="background-color: white">                  }</span><br>         772:  <span style="background-color: white">      </span><br>         773:  <span style="background-color: white">   0              List
       <integer>
         counterValues = c.getCounterContext(style).getCurrentCounterValues(counter);
       </integer></span><br>         774:  <span style="background-color: white">      </span><br>         775:  <span style="background-color: white">   0              return new CounterFunction(counterValues, separator, listStyleType);</span><br>         776:  <span style="background-color: white">              } else {</span><br>         777:  <span style="background-color: white">  16              return null;</span><br>         778:  <span style="background-color: white">              }</span><br>         779:  <span style="background-color: white">          }</span><br>         780:  <span style="background-color: white">      </span><br>         781:  <span style="background-color: white">   8      private static String getAttributeValue(FSFunction attrFunc, Element e) {</span><br>         782:  <span style="background-color: white">   8          PropertyValue value = (PropertyValue) attrFunc.getParameters().get(0);</span><br>         783:  <span style="background-color: white">   8          return e.getAttribute(value.getStringValue());</span><br>         784:  <span style="background-color: white">          }</span><br>         785:  <span style="background-color: white">      </span><br>         786:  <span style="background-color: white"> 99+      private static List
       <styleable>
         createGeneratedContentList(
       </styleable></span><br>         787:  <span style="background-color: yellow">                  LayoutContext c, Element element, PropertyValue propValue,</span><br>         788:  <span style="background-color: white">                  String peName, CalculatedStyle style, int mode, ChildBoxInfo info) {</span><br>         789:  <span style="background-color: yellow"> 99+          List
       <propertyvalue>
         values = propValue.getValues();
       </propertyvalue></span><br>         790:  <span style="background-color: white">      </span><br>         791:  <span style="background-color: yellow"> 99+          if (values == null) {</span><br>         792:  <span style="background-color: yellow">                  // content: normal or content: none</span><br>         793:  <span style="background-color: yellow">   0              return Collections.emptyList();</span><br>         794:  <span style="background-color: yellow">              }</span><br>         795:  <span style="background-color: white">      </span><br>         796:  <span style="background-color: yellow"> 99+          List
       <styleable>
         result = new ArrayList&lt;&gt;(values.size());
       </styleable></span><br>         797:  <span style="background-color: white">      </span><br>         798:  <span style="background-color: white"> 99+          for (PropertyValue value : values) {</span><br>         799:  <span style="background-color: white"> 99+              ContentFunction contentFunction = null;</span><br>         800:  <span style="background-color: white"> 99+              FSFunction function = null;</span><br>         801:  <span style="background-color: white">      </span><br>         802:  <span style="background-color: white"> 99+              String content = null;</span><br>         803:  <span style="background-color: white">      </span><br>         804:  <span style="background-color: white"> 99+              short type = value.getPrimitiveType();</span><br>         805:  <span style="background-color: white"> 99+              if (type == CSSPrimitiveValue.CSS_STRING) {</span><br>         806:  <span style="background-color: white"> 99+                  content = value.getStringValue();</span><br>         807:  <span style="background-color: white"> 99+              } else if (type == CSSPrimitiveValue.CSS_URI) {</span><br>         808:  <span style="background-color: white">   4                  Element creator = element != null ? element : c.getRootLayer().getMaster().getElement();</span><br>         809:  <span style="background-color: white">   4                  Document doc = creator.getOwnerDocument();</span><br>         810:  <span style="background-color: white">   4                  Element img = doc.createElement("img");</span><br>         811:  <span style="background-color: white">   4                  img.setAttribute("src", value.getStringValue());</span><br>         812:  <span style="background-color: white">   4                  creator.appendChild(img);</span><br>         813:  <span style="background-color: white">      </span><br>         814:  <span style="background-color: white">   4                  BlockBox iB = new BlockBox();</span><br>         815:  <span style="background-color: white">   4                  iB.setElement(img);</span><br>         816:  <span style="background-color: yellow">   4                  CalculatedStyle anon = new EmptyStyle().createAnonymousStyle(IdentValue.INLINE_BLOCK);</span><br>         817:  <span style="background-color: white">   4                  iB.setStyle(anon);</span><br>         818:  <span style="background-color: white">      </span><br>         819:  <span style="background-color: yellow">   4                  info.setContainsBlockLevelContent(true);</span><br>         820:  <span style="background-color: white">      </span><br>         821:  <span style="background-color: white">   4                  result.add(iB);</span><br>         822:  <span style="background-color: white"> 99+              } else if (value.getPropertyValueType() == PropertyValue.VALUE_TYPE_FUNCTION) {</span><br>         823:  <span style="background-color: white"> 99+                  if (mode == CONTENT_LIST_DOCUMENT &amp;&amp; isAttrFunction(value.getFunction())) {</span><br>         824:  <span style="background-color: white">   8                      content = getAttributeValue(value.getFunction(), element);</span><br>         825:  <span style="background-color: white">                      } else {</span><br>         826:  <span style="background-color: white"> 99+                      CounterFunction cFunc = null;</span><br>         827:  <span style="background-color: white">      </span><br>         828:  <span style="background-color: white"> 99+                      if (mode == CONTENT_LIST_DOCUMENT) {</span><br>         829:  <span style="background-color: white"> 99+                          cFunc = makeCounterFunction(value.getFunction(), c, style);</span><br>         830:  <span style="background-color: white">                          }</span><br>         831:  <span style="background-color: white">      </span><br>         832:  <span style="background-color: white"> 99+                      if (cFunc != null) {</span><br>         833:  <span style="background-color: white">                              //TODO: counter functions may be called with non-ordered list-style-types, e.g. disc</span><br>         834:  <span style="background-color: white">   0                          content = cFunc.evaluate();</span><br>         835:  <span style="background-color: white">   0                          contentFunction = null;</span><br>         836:  <span style="background-color: white">   0                          function = null;</span><br>         837:  <span style="background-color: white"> 99+                      } else if (mode == CONTENT_LIST_MARGIN_BOX &amp;&amp; isElementFunction(value.getFunction())) {</span><br>         838:  <span style="background-color: white"> 99+                          BlockBox target = getRunningBlock(c, value);</span><br>         839:  <span style="background-color: white"> 99+                          if (target != null) {</span><br>         840:  <span style="background-color: white"> 99+                              result.add(target.copyOf());</span><br>         841:  <span style="background-color: white"> 99+                              info.setContainsBlockLevelContent(true);</span><br>         842:  <span style="background-color: white">                              }</span><br>         843:  <span style="background-color: white">                          } else {</span><br>         844:  <span style="background-color: white"> 99+                          contentFunction =</span><br>         845:  <span style="background-color: white">                                      c.getContentFunctionFactory().lookupFunction(c, value.getFunction());</span><br>         846:  <span style="background-color: white"> 99+                          if (contentFunction != null) {</span><br>         847:  <span style="background-color: white"> 99+                              function = value.getFunction();</span><br>         848:  <span style="background-color: white">      </span><br>         849:  <span style="background-color: white"> 99+                              if (contentFunction.isStatic()) {</span><br>         850:  <span style="background-color: white">   0                                  content = contentFunction.calculate(c, function);</span><br>         851:  <span style="background-color: white">   0                                  contentFunction = null;</span><br>         852:  <span style="background-color: white">   0                                  function = null;</span><br>         853:  <span style="background-color: white">                                  } else {</span><br>         854:  <span style="background-color: white"> 99+                                  content = contentFunction.getLayoutReplacementText();</span><br>         855:  <span style="background-color: white">                                  }</span><br>         856:  <span style="background-color: white">                              }</span><br>         857:  <span style="background-color: white">                          }</span><br>         858:  <span style="background-color: white">                      }</span><br>         859:  <span style="background-color: white">  30              } else if (type == CSSPrimitiveValue.CSS_IDENT) {</span><br>         860:  <span style="background-color: white">  30                  FSDerivedValue dv = style.valueByName(CSSName.QUOTES);</span><br>         861:  <span style="background-color: white">      </span><br>         862:  <span style="background-color: white">  30                  if (dv != IdentValue.NONE) {</span><br>         863:  <span style="background-color: white">  30                      IdentValue ident = value.getIdentValue();</span><br>         864:  <span style="background-color: white">      </span><br>         865:  <span style="background-color: white">  30                      if (ident == IdentValue.OPEN_QUOTE) {</span><br>         866:  <span style="background-color: white">  15                          String[] quotes = style.asStringArray(CSSName.QUOTES);</span><br>         867:  <span style="background-color: white">  15                          content = quotes[0];</span><br>         868:  <span style="background-color: white">  15                      } else if (ident == IdentValue.CLOSE_QUOTE) {</span><br>         869:  <span style="background-color: white">   9                          String[] quotes = style.asStringArray(CSSName.QUOTES);</span><br>         870:  <span style="background-color: white">   9                          content = quotes[1];</span><br>         871:  <span style="background-color: white">                          }</span><br>         872:  <span style="background-color: white">                      }</span><br>         873:  <span style="background-color: white">                  }</span><br>         874:  <span style="background-color: white">      </span><br>         875:  <span style="background-color: white"> 99+              if (content != null) {</span><br>         876:  <span style="background-color: white"> 99+                  InlineBox iB = new InlineBox(content);</span><br>         877:  <span style="background-color: white"> 99+                  iB.setContentFunction(contentFunction);</span><br>         878:  <span style="background-color: white"> 99+                  iB.setFunction(function);</span><br>         879:  <span style="background-color: white"> 99+                  iB.setElement(element);</span><br>         880:  <span style="background-color: white"> 99+                  iB.setPseudoElementOrClass(peName);</span><br>         881:  <span style="background-color: white"> 99+                  iB.setStartsHere(true);</span><br>         882:  <span style="background-color: white"> 99+                  iB.setEndsHere(true);</span><br>         883:  <span style="background-color: white">      </span><br>         884:  <span style="background-color: white"> 99+                  result.add(iB);</span><br>         885:  <span style="background-color: white">                  }</span><br>         886:  <span style="background-color: white">              }</span><br>         887:  <span style="background-color: white">      </span><br>         888:  <span style="background-color: white"> 99+          return result;</span><br>         889:  <span style="background-color: white">          }</span><br>         890:  <span style="background-color: white">      </span><br>         891:  <span style="background-color: white"> 99+      public static BlockBox getRunningBlock(LayoutContext c, PropertyValue value) {</span><br>         892:  <span style="background-color: white"> 99+          List
       <propertyvalue>
         params = value.getFunction().getParameters();
       </propertyvalue></span><br>         893:  <span style="background-color: white"> 99+          String ident = ((PropertyValue)params.get(0)).getStringValue();</span><br>         894:  <span style="background-color: white"> 99+          PageElementPosition position = null;</span><br>         895:  <span style="background-color: white"> 99+          if (params.size() == 2) {</span><br>         896:  <span style="background-color: white">   0              position = PageElementPosition.valueOf(</span><br>         897:  <span style="background-color: white">                          ((PropertyValue)params.get(1)).getStringValue());</span><br>         898:  <span style="background-color: white">              }</span><br>         899:  <span style="background-color: white"> 99+          if (position == null) {</span><br>         900:  <span style="background-color: white"> 99+              position = PageElementPosition.FIRST;</span><br>         901:  <span style="background-color: white">              }</span><br>         902:  <span style="background-color: white"> 99+          BlockBox target = c.getRootDocumentLayer().getRunningBlock(ident, c.getPage(), position);</span><br>         903:  <span style="background-color: white"> 99+          return target;</span><br>         904:  <span style="background-color: white">          }</span><br>         905:  <span style="background-color: white">      </span><br>         906:  <span style="background-color: white"> 99+      private static void insertGeneratedContent(</span><br>         907:  <span style="background-color: white">                  LayoutContext c, Element element, CalculatedStyle parentStyle,</span><br>         908:  <span style="background-color: white">                  String peName, List
       <styleable>
         children, ChildBoxInfo info) {
       </styleable></span><br>         909:  <span style="background-color: white"> 99+          CascadedStyle peStyle = c.getCss().getPseudoElementStyle(element, peName);</span><br>         910:  <span style="background-color: white"> 99+          if (peStyle != null) {</span><br>         911:  <span style="background-color: white"> 99+              PropertyDeclaration contentDecl = peStyle.propertyByName(CSSName.CONTENT);</span><br>         912:  <span style="background-color: white"> 99+              PropertyDeclaration counterResetDecl = peStyle.propertyByName(CSSName.COUNTER_RESET);</span><br>         913:  <span style="background-color: white"> 99+              PropertyDeclaration counterIncrDecl = peStyle.propertyByName(CSSName.COUNTER_INCREMENT);</span><br>         914:  <span style="background-color: white">      </span><br>         915:  <span style="background-color: white"> 99+              CalculatedStyle calculatedStyle = null;</span><br>         916:  <span style="background-color: white"> 99+              if (contentDecl != null || counterResetDecl != null || counterIncrDecl != null) {</span><br>         917:  <span style="background-color: white"> 99+                  calculatedStyle = parentStyle.deriveStyle(peStyle);</span><br>         918:  <span style="background-color: yellow"> 99+                  if (calculatedStyle.isDisplayNone()) return;</span><br>         919:  <span style="background-color: yellow"> 99+                  if (calculatedStyle.isIdent(CSSName.CONTENT, IdentValue.NONE)) return;</span><br>         920:  <span style="background-color: yellow"> 99+                  if (calculatedStyle.isIdent(CSSName.CONTENT, IdentValue.NORMAL) &amp;&amp; (peName.equals("before") || peName.equals("after")))</span><br>         921:  <span style="background-color: white">   0                      return;</span><br>         922:  <span style="background-color: white">      </span><br>         923:  <span style="background-color: white"> 99+                  if (calculatedStyle.isTable() || calculatedStyle.isTableRow() || calculatedStyle.isTableSection()) {</span><br>         924:  <span style="background-color: yellow">   0                      CascadedStyle newPeStyle =</span><br>         925:  <span style="background-color: yellow">                              CascadedStyle.createLayoutStyle(peStyle, new PropertyDeclaration[] {</span><br>         926:  <span style="background-color: yellow">                                  CascadedStyle.createLayoutPropertyDeclaration(</span><br>         927:  <span style="background-color: yellow">                                      CSSName.DISPLAY,</span><br>         928:  <span style="background-color: yellow">                                      IdentValue.BLOCK),</span><br>         929:  <span style="background-color: yellow">                              });</span><br>         930:  <span style="background-color: yellow">   0                      calculatedStyle = parentStyle.deriveStyle(newPeStyle);</span><br>         931:  <span style="background-color: white">                      }</span><br>         932:  <span style="background-color: white"> 99+                  c.resolveCounters(calculatedStyle);</span><br>         933:  <span style="background-color: white">                  }</span><br>         934:  <span style="background-color: white">      </span><br>         935:  <span style="background-color: white"> 99+              if (contentDecl != null) {</span><br>         936:  <span style="background-color: white"> 99+                  CSSPrimitiveValue propValue = contentDecl.getValue();</span><br>         937:  <span style="background-color: white"> 99+                  children.addAll(createGeneratedContent(c, element, peName, calculatedStyle,</span><br>         938:  <span style="background-color: white">                              (PropertyValue) propValue, info));</span><br>         939:  <span style="background-color: white">                  }</span><br>         940:  <span style="background-color: white">              }</span><br>         941:  <span style="background-color: white">          }</span><br>         942:  <span style="background-color: white">      </span><br>         943:  <span style="background-color: yellow"> 99+      private static List
       <styleable>
         createGeneratedContent(
       </styleable></span><br>         944:  <span style="background-color: yellow">                  LayoutContext c, Element element, String peName,</span><br>         945:  <span style="background-color: yellow">                  CalculatedStyle style, PropertyValue property, ChildBoxInfo info) {</span><br>         946:  <span style="background-color: yellow"> 99+          if (style.isDisplayNone() || style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN)</span><br>         947:  <span style="background-color: yellow">                      || style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN_GROUP)) {</span><br>         948:  <span style="background-color: yellow">   0              return Collections.emptyList();</span><br>         949:  <span style="background-color: yellow">              }</span><br>         950:  <span style="background-color: yellow">      </span><br>         951:  <span style="background-color: yellow"> 99+          ChildBoxInfo childInfo = new ChildBoxInfo();</span><br>         952:  <span style="background-color: yellow"> 99+          List
       <styleable>
         inlineBoxes = createGeneratedContentList(
       </styleable></span><br>         953:  <span style="background-color: yellow">                      c, element, property, peName, style, CONTENT_LIST_DOCUMENT, childInfo);</span><br>         954:  <span style="background-color: yellow">      </span><br>         955:  <span style="background-color: yellow"> 99+          if (childInfo.isContainsBlockLevelContent()) {</span><br>         956:  <span style="background-color: yellow">   1              List
       <styleable>
         inlines = new ArrayList&lt;&gt;();
       </styleable></span><br>         957:  <span style="background-color: yellow">      </span><br>         958:  <span style="background-color: yellow">   1              CalculatedStyle anonStyle = style.isInlineBlock() || style.isInline() ?</span><br>         959:  <span style="background-color: yellow">                                 style : style.createAnonymousStyle(IdentValue.INLINE_BLOCK);</span><br>         960:  <span style="background-color: yellow">      </span><br>         961:  <span style="background-color: yellow">   1              BlockBox result = createBlockBox(style, info, true);</span><br>         962:  <span style="background-color: yellow">   1              result.setStyle(anonStyle);</span><br>         963:  <span style="background-color: yellow">   1              result.setElement(element);</span><br>         964:  <span style="background-color: yellow">   1              result.setChildrenContentType(BlockBox.CONTENT_INLINE);</span><br>         965:  <span style="background-color: yellow">   1              result.setPseudoElementOrClass(peName);</span><br>         966:  <span style="background-color: yellow">      </span><br>         967:  <span style="background-color: yellow">   1              CalculatedStyle anon = style.createAnonymousStyle(IdentValue.INLINE);</span><br>         968:  <span style="background-color: yellow">   4              for (Iterator
       <styleable>
         i = inlineBoxes.iterator(); i.hasNext();) {
       </styleable></span><br>         969:  <span style="background-color: yellow">   3                 Styleable b = i.next();</span><br>         970:  <span style="background-color: yellow">      </span><br>         971:  <span style="background-color: yellow">   3                 if (b instanceof BlockBox) {</span><br>         972:  <span style="background-color: yellow">   2                     inlines.add(b);</span><br>         973:  <span style="background-color: yellow">                     } else {</span><br>         974:  <span style="background-color: yellow">   1                     InlineBox iB = (InlineBox) b;</span><br>         975:  <span style="background-color: yellow">      </span><br>         976:  <span style="background-color: yellow">   1                     iB.setStyle(anon);</span><br>         977:  <span style="background-color: yellow">   1                     iB.applyTextTransform();</span><br>         978:  <span style="background-color: yellow">   1                     iB.setElement(null);</span><br>         979:  <span style="background-color: yellow">      </span><br>         980:  <span style="background-color: yellow">   1                     inlines.add(iB);</span><br>         981:  <span style="background-color: yellow">                     }</span><br>         982:  <span style="background-color: yellow">                  }</span><br>         983:  <span style="background-color: yellow">      </span><br>         984:  <span style="background-color: yellow">   1              if (!inlines.isEmpty()) {</span><br>         985:  <span style="background-color: yellow">   1                  result.setInlineContent(inlines);</span><br>         986:  <span style="background-color: yellow">                  }</span><br>         987:  <span style="background-color: yellow">   1              return Collections.singletonList(result);</span><br>         988:  <span style="background-color: yellow"> 99+          } else if (style.isInline()) {</span><br>         989:  <span style="background-color: yellow"> 99+              for (Iterator
       <styleable>
         i = inlineBoxes.iterator(); i.hasNext();) {
       </styleable></span><br>         990:  <span style="background-color: yellow"> 99+                  InlineBox iB = (InlineBox) i.next();</span><br>         991:  <span style="background-color: yellow"> 99+                  iB.setStyle(style);</span><br>         992:  <span style="background-color: yellow"> 99+                  iB.applyTextTransform();</span><br>         993:  <span style="background-color: yellow">                  }</span><br>         994:  <span style="background-color: yellow"> 99+              return inlineBoxes;</span><br>         995:  <span style="background-color: yellow">              } else {</span><br>         996:  <span style="background-color: yellow">   5              CalculatedStyle anon = style.createAnonymousStyle(IdentValue.INLINE);</span><br>         997:  <span style="background-color: yellow">   9              for (Iterator
       <styleable>
         i = inlineBoxes.iterator(); i.hasNext();) {
       </styleable></span><br>         998:  <span style="background-color: yellow">   4                  InlineBox iB = (InlineBox) i.next();</span><br>         999:  <span style="background-color: yellow">   4                  iB.setStyle(anon);</span><br>        1000:  <span style="background-color: yellow">   4                  iB.applyTextTransform();</span><br>        1001:  <span style="background-color: yellow">   4                  iB.setElement(null);</span><br>        1002:  <span style="background-color: yellow">                  }</span><br>        1003:  <span style="background-color: yellow">      </span><br>        1004:  <span style="background-color: yellow">   5              BlockBox result = createBlockBox(style, info, true);</span><br>        1005:  <span style="background-color: yellow">   5              result.setStyle(style);</span><br>        1006:  <span style="background-color: yellow">   5              result.setInlineContent(inlineBoxes);</span><br>        1007:  <span style="background-color: yellow">   5              result.setElement(element);</span><br>        1008:  <span style="background-color: yellow">   5              result.setChildrenContentType(BlockBox.CONTENT_INLINE);</span><br>        1009:  <span style="background-color: yellow">   5              result.setPseudoElementOrClass(peName);</span><br>        1010:  <span style="background-color: yellow">      </span><br>        1011:  <span style="background-color: yellow">   5              if (! style.isLayedOutInInlineContext()) {</span><br>        1012:  <span style="background-color: yellow">   1                  info.setContainsBlockLevelContent(true);</span><br>        1013:  <span style="background-color: yellow">                  }</span><br>        1014:  <span style="background-color: yellow">      </span><br>        1015:  <span style="background-color: yellow">   5              return new ArrayList&lt;&gt;(Collections.singletonList(result));</span><br>        1016:  <span style="background-color: yellow">              }</span><br>        1017:  <span style="background-color: yellow">          }</span><br>        1018:  <span style="background-color: white">      </span><br>        1019:  <span style="background-color: white"> 99+      private static List
       <styleable>
         createGeneratedMarginBoxContent(
       </styleable></span><br>        1020:  <span style="background-color: white">                  LayoutContext c, Element element, PropertyValue property,</span><br>        1021:  <span style="background-color: white">                  CalculatedStyle style, ChildBoxInfo info) {</span><br>        1022:  <span style="background-color: white">              </span><br>        1023:  <span style="background-color: yellow"> 99+          List
       <styleable>
         result = createGeneratedContentList(
       </styleable></span><br>        1024:  <span style="background-color: yellow">                      c, element, property, null, style, CONTENT_LIST_MARGIN_BOX, info);</span><br>        1025:  <span style="background-color: white">      </span><br>        1026:  <span style="background-color: white"> 99+          CalculatedStyle anon = style.createAnonymousStyle(IdentValue.INLINE);</span><br>        1027:  <span style="background-color: white"> 99+          for (Styleable s : result) {</span><br>        1028:  <span style="background-color: white"> 99+              if (s instanceof InlineBox) {</span><br>        1029:  <span style="background-color: white"> 99+                  InlineBox iB = (InlineBox)s;</span><br>        1030:  <span style="background-color: white"> 99+                  iB.setElement(null);</span><br>        1031:  <span style="background-color: white"> 99+                  iB.setStyle(anon);</span><br>        1032:  <span style="background-color: white"> 99+                  iB.applyTextTransform();</span><br>        1033:  <span style="background-color: white">                  }</span><br>        1034:  <span style="background-color: white">              }</span><br>        1035:  <span style="background-color: white">      </span><br>        1036:  <span style="background-color: white"> 99+          return result;</span><br>        1037:  <span style="background-color: white">          }</span><br>        1038:  <span style="background-color: white">      </span><br>        1039:  <span style="background-color: white"> 99+      private static BlockBox createBlockBox(</span><br>        1040:  <span style="background-color: white">                  CalculatedStyle style, ChildBoxInfo info, boolean generated) {</span><br>        1041:  <span style="background-color: white"> 99+      	if (style.isFloated() &amp;&amp; !(style.isAbsolute() || style.isFixed())) {</span><br>        1042:  <span style="background-color: white"> 99+              BlockBox result;</span><br>        1043:  <span style="background-color: white"> 99+              if (style.isTable() || style.isInlineTable()) {</span><br>        1044:  <span style="background-color: white">   0                  result = new TableBox();</span><br>        1045:  <span style="background-color: white"> 99+              } else if (style.isTableCell()) {</span><br>        1046:  <span style="background-color: white">   1                  info.setContainsTableContent(true);</span><br>        1047:  <span style="background-color: white">   1                  result = new TableCellBox();</span><br>        1048:  <span style="background-color: white">                  } else {</span><br>        1049:  <span style="background-color: white"> 99+                  result = new BlockBox();</span><br>        1050:  <span style="background-color: white">                  }</span><br>        1051:  <span style="background-color: white"> 99+              result.setFloatedBoxData(new FloatedBoxData());</span><br>        1052:  <span style="background-color: white"> 99+              return result;</span><br>        1053:  <span style="background-color: white"> 99+          } else if (style.isSpecifiedAsBlock()) {</span><br>        1054:  <span style="background-color: white"> 99+              return new BlockBox();</span><br>        1055:  <span style="background-color: white"> 99+          } else if (! generated &amp;&amp; (style.isTable() || style.isInlineTable())) {</span><br>        1056:  <span style="background-color: white"> 99+              return new TableBox();</span><br>        1057:  <span style="background-color: white"> 99+          } else if (style.isTableCell()) {</span><br>        1058:  <span style="background-color: white"> 99+              info.setContainsTableContent(true);</span><br>        1059:  <span style="background-color: white"> 99+              return new TableCellBox();</span><br>        1060:  <span style="background-color: white"> 99+          } else if (! generated &amp;&amp; style.isTableRow()) {</span><br>        1061:  <span style="background-color: white"> 99+              info.setContainsTableContent(true);</span><br>        1062:  <span style="background-color: white"> 99+              return new TableRowBox();</span><br>        1063:  <span style="background-color: white"> 99+          } else if (! generated &amp;&amp; style.isTableSection()) {</span><br>        1064:  <span style="background-color: white"> 99+              info.setContainsTableContent(true);</span><br>        1065:  <span style="background-color: white"> 99+              return new TableSectionBox();</span><br>        1066:  <span style="background-color: white"> 99+          } else if (style.isTableCaption()) {</span><br>        1067:  <span style="background-color: white">   6              info.setContainsTableContent(true);</span><br>        1068:  <span style="background-color: white">   6              return new BlockBox();</span><br>        1069:  <span style="background-color: white">              } else {</span><br>        1070:  <span style="background-color: white"> 99+              return new BlockBox();</span><br>        1071:  <span style="background-color: white">              }</span><br>        1072:  <span style="background-color: white">          }</span><br>        1073:  <span style="background-color: white">      </span><br>        1074:  <span style="background-color: white">  22      private static void addColumns(LayoutContext c, TableBox table, TableColumn parent) {</span><br>        1075:  <span style="background-color: white">  22          SharedContext sharedContext = c.getSharedContext();</span><br>        1076:  <span style="background-color: white">      </span><br>        1077:  <span style="background-color: white">  22          Node working = parent.getElement().getFirstChild();</span><br>        1078:  <span style="background-color: white">  22          boolean found = false;</span><br>        1079:  <span style="background-color: white"> 99+          while (working != null) {</span><br>        1080:  <span style="background-color: white"> 99+              if (working.getNodeType() == Node.ELEMENT_NODE) {</span><br>        1081:  <span style="background-color: white"> 99+                  Element element = (Element) working;</span><br>        1082:  <span style="background-color: white"> 99+                  CalculatedStyle style = sharedContext.getStyle(element);</span><br>        1083:  <span style="background-color: white">      </span><br>        1084:  <span style="background-color: white"> 99+                  if (style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN)) {</span><br>        1085:  <span style="background-color: white"> 99+                      found = true;</span><br>        1086:  <span style="background-color: white"> 99+                      TableColumn col = new TableColumn(element, style);</span><br>        1087:  <span style="background-color: white"> 99+                      col.setParent(parent);</span><br>        1088:  <span style="background-color: white"> 99+                      table.addStyleColumn(col);</span><br>        1089:  <span style="background-color: white">                      }</span><br>        1090:  <span style="background-color: white">                  }</span><br>        1091:  <span style="background-color: white"> 99+              working = working.getNextSibling();</span><br>        1092:  <span style="background-color: white">              }</span><br>        1093:  <span style="background-color: white">  22          if (! found) {</span><br>        1094:  <span style="background-color: white">   0              table.addStyleColumn(parent);</span><br>        1095:  <span style="background-color: white">              }</span><br>        1096:  <span style="background-color: white">          }</span><br>        1097:  <span style="background-color: white">      </span><br>        1098:  <span style="background-color: white">  22      private static void addColumnOrColumnGroup(</span><br>        1099:  <span style="background-color: white">                  LayoutContext c, TableBox table, Element e, CalculatedStyle style) {</span><br>        1100:  <span style="background-color: white">  22          if (style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN)) {</span><br>        1101:  <span style="background-color: white">   0              table.addStyleColumn(new TableColumn(e, style));</span><br>        1102:  <span style="background-color: white">              } else { /* style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN_GROUP) */</span><br>        1103:  <span style="background-color: white">  22              addColumns(c, table, new TableColumn(e, style));</span><br>        1104:  <span style="background-color: white">              }</span><br>        1105:  <span style="background-color: white">          }</span><br>        1106:  <span style="background-color: white">      </span><br>        1107:  <span style="background-color: white"> 99+      private static InlineBox createInlineBox(</span><br>        1108:  <span style="background-color: white">                  String text, Element parent, CalculatedStyle parentStyle, Text node) {</span><br>        1109:  <span style="background-color: white"> 99+          InlineBox result = new InlineBox(text);</span><br>        1110:  <span style="background-color: white">      </span><br>        1111:  <span style="background-color: white"> 99+          if (parentStyle.isInline() &amp;&amp; ! (parent.getParentNode() instanceof Document)) {</span><br>        1112:  <span style="background-color: white"> 99+              result.setStyle(parentStyle);</span><br>        1113:  <span style="background-color: white"> 99+              result.setElement(parent);</span><br>        1114:  <span style="background-color: white">              } else {</span><br>        1115:  <span style="background-color: white"> 99+              result.setStyle(parentStyle.createAnonymousStyle(IdentValue.INLINE));</span><br>        1116:  <span style="background-color: white">              }</span><br>        1117:  <span style="background-color: white">      </span><br>        1118:  <span style="background-color: white"> 99+          result.applyTextTransform();</span><br>        1119:  <span style="background-color: white">      </span><br>        1120:  <span style="background-color: white"> 99+          return result;</span><br>        1121:  <span style="background-color: white">          }</span><br>        1122:  <span style="background-color: white">      </span><br>        1123:  <span style="background-color: yellow"> 99+      private static void createChildren(</span><br>        1124:  <span style="background-color: yellow">                  LayoutContext c, BlockBox blockParent, Element parent,</span><br>        1125:  <span style="background-color: yellow">                  List
       <styleable>
         children, ChildBoxInfo info, boolean inline) {
       </styleable></span><br>        1126:  <span style="background-color: yellow"> 99+          SharedContext sharedContext = c.getSharedContext();</span><br>        1127:  <span style="background-color: yellow">      </span><br>        1128:  <span style="background-color: yellow"> 99+          CalculatedStyle parentStyle = sharedContext.getStyle(parent);</span><br>        1129:  <span style="background-color: yellow">      </span><br>        1130:  <span style="background-color: yellow"> 99+          insertGeneratedContent(c, parent, parentStyle, "before", children, info);</span><br>        1131:  <span style="background-color: yellow">      </span><br>        1132:  <span style="background-color: yellow"> 99+          Node working = parent.getFirstChild();</span><br>        1133:  <span style="background-color: yellow"> 99+          boolean needStartText = inline;</span><br>        1134:  <span style="background-color: yellow"> 99+          boolean needEndText = inline;</span><br>        1135:  <span style="background-color: yellow"> 99+          if (working != null) {</span><br>        1136:  <span style="background-color: yellow"> 99+              InlineBox previousIB = null;</span><br>        1137:  <span style="background-color: yellow"> 99+              do {</span><br>        1138:  <span style="background-color: yellow"> 99+                  Styleable child = null;</span><br>        1139:  <span style="background-color: yellow"> 99+                  short nodeType = working.getNodeType();</span><br>        1140:  <span style="background-color: yellow"> 99+                  if (nodeType == Node.ELEMENT_NODE) {</span><br>        1141:  <span style="background-color: yellow"> 99+                      Element element = (Element) working;</span><br>        1142:  <span style="background-color: yellow"> 99+                      CalculatedStyle style = sharedContext.getStyle(element);</span><br>        1143:  <span style="background-color: yellow">      </span><br>        1144:  <span style="background-color: yellow"> 99+                      if (style.isDisplayNone()) {</span><br>        1145:  <span style="background-color: yellow"> 99+                          continue;</span><br>        1146:  <span style="background-color: yellow">                          }</span><br>        1147:  <span style="background-color: yellow">      </span><br>        1148:  <span style="background-color: yellow"> 99+                      Integer start = null;</span><br>        1149:  <span style="background-color: yellow"> 99+  					if ("ol".equals(working.getNodeName())) {</span><br>        1150:  <span style="background-color: yellow">   9  						Node startAttribute = working.getAttributes().getNamedItem("start");</span><br>        1151:  <span style="background-color: yellow">   9  						if (startAttribute != null) {</span><br>        1152:  <span style="background-color: yellow">   0  							try {</span><br>        1153:  <span style="background-color: yellow">   0  								start = Integer.valueOf(Integer.parseInt(startAttribute.getNodeValue()) - 1);</span><br>        1154:  <span style="background-color: yellow">      							} catch (NumberFormatException e) {</span><br>        1155:  <span style="background-color: yellow">      								// ignore</span><br>        1156:  <span style="background-color: yellow">      							}</span><br>        1157:  <span style="background-color: yellow">      						}</span><br>        1158:  <span style="background-color: yellow"> 99+  					} else if ("li".equals(working.getNodeName())) {</span><br>        1159:  <span style="background-color: yellow"> 99+  						Node valueAttribute = working.getAttributes().getNamedItem("value");</span><br>        1160:  <span style="background-color: yellow"> 99+  						if (valueAttribute != null) {</span><br>        1161:  <span style="background-color: yellow">   0  							try {</span><br>        1162:  <span style="background-color: yellow">   0  								start = Integer.valueOf(Integer.parseInt(valueAttribute.getNodeValue()) - 1);</span><br>        1163:  <span style="background-color: yellow">      							} catch (NumberFormatException e) {</span><br>        1164:  <span style="background-color: yellow">      								// ignore</span><br>        1165:  <span style="background-color: yellow">      							}</span><br>        1166:  <span style="background-color: yellow">      						}</span><br>        1167:  <span style="background-color: yellow">      					}</span><br>        1168:  <span style="background-color: yellow">      </span><br>        1169:  <span style="background-color: yellow"> 99+  	                c.resolveCounters(style, start);</span><br>        1170:  <span style="background-color: yellow">      </span><br>        1171:  <span style="background-color: yellow"> 99+                      if (style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN)</span><br>        1172:  <span style="background-color: yellow">                                  || style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN_GROUP)) {</span><br>        1173:  <span style="background-color: yellow">  42                          if ((blockParent != null) &amp;&amp;</span><br>        1174:  <span style="background-color: yellow">                                      (blockParent.getStyle().isTable() || blockParent.getStyle().isInlineTable())) {</span><br>        1175:  <span style="background-color: yellow">  22                              TableBox table = (TableBox) blockParent;</span><br>        1176:  <span style="background-color: yellow">  22                              addColumnOrColumnGroup(c, table, element, style);</span><br>        1177:  <span style="background-color: yellow">                              }</span><br>        1178:  <span style="background-color: yellow">      </span><br>        1179:  <span style="background-color: yellow">  42                          continue;</span><br>        1180:  <span style="background-color: yellow">                          }</span><br>        1181:  <span style="background-color: yellow">      </span><br>        1182:  <span style="background-color: yellow"> 99+                      if (style.isInline()) {</span><br>        1183:  <span style="background-color: yellow"> 99+                          if (needStartText) {</span><br>        1184:  <span style="background-color: yellow">   2                              needStartText = false;</span><br>        1185:  <span style="background-color: yellow">   2                              InlineBox iB = createInlineBox("", parent, parentStyle, null);</span><br>        1186:  <span style="background-color: yellow">   2                              iB.setStartsHere(true);</span><br>        1187:  <span style="background-color: yellow">   2                              iB.setEndsHere(false);</span><br>        1188:  <span style="background-color: yellow">   2                              children.add(iB);</span><br>        1189:  <span style="background-color: yellow">   2                              previousIB = iB;</span><br>        1190:  <span style="background-color: yellow">                              }</span><br>        1191:  <span style="background-color: yellow"> 99+                          createChildren(c, null, element, children, info, true);</span><br>        1192:  <span style="background-color: yellow"> 99+                          if (inline) {</span><br>        1193:  <span style="background-color: yellow">  25                              if (previousIB != null) {</span><br>        1194:  <span style="background-color: yellow">  25                                  previousIB.setEndsHere(false);</span><br>        1195:  <span style="background-color: yellow">                                  }</span><br>        1196:  <span style="background-color: yellow">  25                              needEndText = true;</span><br>        1197:  <span style="background-color: yellow">                              }</span><br>        1198:  <span style="background-color: yellow">                          } else {</span><br>        1199:  <span style="background-color: yellow"> 99+                      	if (style.hasColumns() &amp;&amp; c.isPrint()) {</span><br>        1200:  <span style="background-color: yellow">   8                              child = new FlowingColumnContainerBox();</span><br>        1201:  <span style="background-color: yellow">                          	} else {</span><br>        1202:  <span style="background-color: yellow"> 99+                      		child = createBlockBox(style, info, false);</span><br>        1203:  <span style="background-color: yellow">                          	}</span><br>        1204:  <span style="background-color: yellow">                          	</span><br>        1205:  <span style="background-color: yellow"> 99+                          child.setStyle(style);</span><br>        1206:  <span style="background-color: yellow"> 99+                          child.setElement(element);</span><br>        1207:  <span style="background-color: yellow">                              </span><br>        1208:  <span style="background-color: yellow"> 99+                          if (style.hasColumns() &amp;&amp; c.isPrint()) {</span><br>        1209:  <span style="background-color: yellow">   8                              FlowingColumnContainerBox cont = (FlowingColumnContainerBox) child;</span><br>        1210:  <span style="background-color: yellow">   8                              cont.setOnlyChild(c, new FlowingColumnBox(cont));</span><br>        1211:  <span style="background-color: yellow">   8                              cont.getChild().setStyle(style.createAnonymousStyle(IdentValue.BLOCK));</span><br>        1212:  <span style="background-color: yellow">   8                              cont.getChild().setElement(element);</span><br>        1213:  <span style="background-color: yellow">   8                              cont.getChild().ensureChildren(c);</span><br>        1214:  <span style="background-color: yellow">                              }</span><br>        1215:  <span style="background-color: yellow">                              </span><br>        1216:  <span style="background-color: yellow"> 99+                          if (style.isListItem()) {</span><br>        1217:  <span style="background-color: yellow"> 99+                              BlockBox block = (BlockBox) child;</span><br>        1218:  <span style="background-color: yellow"> 99+                              block.setListCounter(c.getCounterContext(style).getCurrentCounterValue("list-item"));</span><br>        1219:  <span style="background-color: yellow">                              }</span><br>        1220:  <span style="background-color: yellow">      </span><br>        1221:  <span style="background-color: yellow"> 99+                          if (style.isTable() || style.isInlineTable()) {</span><br>        1222:  <span style="background-color: yellow"> 99+                              TableBox table = (TableBox) child;</span><br>        1223:  <span style="background-color: yellow"> 99+                              table.ensureChildren(c);</span><br>        1224:  <span style="background-color: yellow">      </span><br>        1225:  <span style="background-color: yellow"> 99+                              child = reorderTableContent(c, table);</span><br>        1226:  <span style="background-color: yellow">                              }</span><br>        1227:  <span style="background-color: yellow">      </span><br>        1228:  <span style="background-color: yellow"> 99+                          if (!info.isContainsBlockLevelContent()</span><br>        1229:  <span style="background-color: yellow">                                      &amp;&amp; !style.isLayedOutInInlineContext()) {</span><br>        1230:  <span style="background-color: yellow"> 99+                              info.setContainsBlockLevelContent(true);</span><br>        1231:  <span style="background-color: yellow">                              }</span><br>        1232:  <span style="background-color: yellow">      </span><br>        1233:  <span style="background-color: yellow"> 99+                          BlockBox block = (BlockBox) child;</span><br>        1234:  <span style="background-color: yellow"> 99+                          if (block.getStyle().mayHaveFirstLine()) {</span><br>        1235:  <span style="background-color: yellow"> 99+                              block.setFirstLineStyle(c.getCss().getPseudoElementStyle(element,</span><br>        1236:  <span style="background-color: yellow">                                          "first-line"));</span><br>        1237:  <span style="background-color: yellow">                              }</span><br>        1238:  <span style="background-color: yellow"> 99+                          if (block.getStyle().mayHaveFirstLetter()) {</span><br>        1239:  <span style="background-color: yellow"> 99+                              block.setFirstLetterStyle(c.getCss().getPseudoElementStyle(element,</span><br>        1240:  <span style="background-color: yellow">                                          "first-letter"));</span><br>        1241:  <span style="background-color: yellow">                              }</span><br>        1242:  <span style="background-color: yellow">                              //I think we need to do this to evaluate counters correctly</span><br>        1243:  <span style="background-color: yellow"> 99+                          block.ensureChildren(c);</span><br>        1244:  <span style="background-color: yellow">                          }</span><br>        1245:  <span style="background-color: yellow"> 99+                  } else if (nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE) {</span><br>        1246:  <span style="background-color: yellow"> 99+                      needStartText = false;</span><br>        1247:  <span style="background-color: yellow"> 99+                      needEndText = false;</span><br>        1248:  <span style="background-color: yellow">      </span><br>        1249:  <span style="background-color: yellow"> 99+                      Text textNode = (Text) working;</span><br>        1250:  <span style="background-color: yellow">      </span><br>        1251:  <span style="background-color: yellow">                          // Ignore the text belonging to a textarea.</span><br>        1252:  <span style="background-color: yellow"> 99+                      if (!textNode.getParentNode().getNodeName().equals("textarea")) {</span><br>        1253:  <span style="background-color: yellow"> 99+                        	previousIB = doBidi(c, textNode, parent, parentStyle, previousIB, children);</span><br>        1254:  <span style="background-color: yellow">                          }</span><br>        1255:  <span style="background-color: yellow"> 99+                      child = null;</span><br>        1256:  <span style="background-color: yellow">                      }</span><br>        1257:  <span style="background-color: yellow">      </span><br>        1258:  <span style="background-color: yellow"> 99+                  if (child != null) {</span><br>        1259:  <span style="background-color: yellow"> 99+                      children.add(child);</span><br>        1260:  <span style="background-color: yellow">                      }</span><br>        1261:  <span style="background-color: yellow">   0              } while ((working = working.getNextSibling()) != null);</span><br>        1262:  <span style="background-color: yellow">              }</span><br>        1263:  <span style="background-color: yellow"> 99+          if (needStartText || needEndText) {</span><br>        1264:  <span style="background-color: yellow"> 99+              InlineBox iB = createInlineBox("", parent, parentStyle, null);</span><br>        1265:  <span style="background-color: yellow"> 99+              iB.setStartsHere(needStartText);</span><br>        1266:  <span style="background-color: yellow"> 99+              iB.setEndsHere(needEndText);</span><br>        1267:  <span style="background-color: yellow"> 99+              children.add(iB);</span><br>        1268:  <span style="background-color: yellow">              }</span><br>        1269:  <span style="background-color: yellow"> 99+          insertGeneratedContent(c, parent, parentStyle, "after", children, info);</span><br>        1270:  <span style="background-color: yellow">          }</span><br>        1271:  <span style="background-color: white">      </span><br>        1272:  <span style="background-color: white"> 99+      private static InlineBox setupInlineChild(InlineBox child, InlineBox previousIB) {</span><br>        1273:  <span style="background-color: white"> 99+          child.setEndsHere(true);</span><br>        1274:  <span style="background-color: white">              </span><br>        1275:  <span style="background-color: white"> 99+          if (previousIB == null) {</span><br>        1276:  <span style="background-color: white"> 99+              child.setStartsHere(true);</span><br>        1277:  <span style="background-color: white">              } else {</span><br>        1278:  <span style="background-color: white"> 99+              previousIB.setEndsHere(false);</span><br>        1279:  <span style="background-color: white">              }</span><br>        1280:  <span style="background-color: white">              </span><br>        1281:  <span style="background-color: white"> 99+          return child;</span><br>        1282:  <span style="background-color: white">          }</span><br>        1283:  <span style="background-color: white">          </span><br>        1284:  <span style="background-color: white"> 99+      private static InlineBox doFakeBidi(LayoutContext c, Text textNode, Element parent, CalculatedStyle parentStyle, InlineBox previousIB, List
       <styleable>
         children) {
       </styleable></span><br>        1285:  <span style="background-color: white"> 99+      	String runText = textNode.getData();</span><br>        1286:  <span style="background-color: white"> 99+      	InlineBox child = createInlineBox(runText, parent, parentStyle, textNode);</span><br>        1287:  <span style="background-color: white"> 99+      	child.setTextDirection(BidiSplitter.LTR);</span><br>        1288:  <span style="background-color: white"> 99+      	previousIB = setupInlineChild(child, previousIB);</span><br>        1289:  <span style="background-color: white"> 99+         	children.add(child);</span><br>        1290:  <span style="background-color: white"> 99+         	return previousIB;</span><br>        1291:  <span style="background-color: white">          }</span><br>        1292:  <span style="background-color: white">          </span><br>        1293:  <span style="background-color: white">          </span><br>        1294:  <span style="background-color: white">          /**</span><br>        1295:  <span style="background-color: white">           * Attempts to divide a Text node further into directional text runs, either LTR or RTL. </span><br>        1296:  <span style="background-color: white">           * @param c</span><br>        1297:  <span style="background-color: white">           * @param textNode</span><br>        1298:  <span style="background-color: white">           * @param parent</span><br>        1299:  <span style="background-color: white">           * @param parentStyle</span><br>        1300:  <span style="background-color: white">           * @return the previousIB.</span><br>        1301:  <span style="background-color: white">           */</span><br>        1302:  <span style="background-color: white"> 99+      private static InlineBox doBidi(LayoutContext c, Text textNode, Element parent, CalculatedStyle parentStyle, InlineBox previousIB, List
       <styleable>
         children) {
       </styleable></span><br>        1303:  <span style="background-color: white">          	</span><br>        1304:  <span style="background-color: white"> 99+          Paragraph para = c.getParagraphSplitter().lookupParagraph(textNode);</span><br>        1305:  <span style="background-color: white"> 99+          if (para == null) {</span><br>        1306:  <span style="background-color: white">              	// Must be no implementation of BIDI for this Text node.</span><br>        1307:  <span style="background-color: white">   0          	return doFakeBidi(c, textNode, parent, parentStyle, previousIB, children);</span><br>        1308:  <span style="background-color: white">              }</span><br>        1309:  <span style="background-color: white">              </span><br>        1310:  <span style="background-color: white"> 99+          int startIndex = para.getFirstCharIndexInParagraph(textNode); // Index into the paragraph.</span><br>        1311:  <span style="background-color: white">              </span><br>        1312:  <span style="background-color: white"> 99+          if (startIndex &lt; 0) {</span><br>        1313:  <span style="background-color: white">              	// Must be a fake implementation of BIDI.</span><br>        1314:  <span style="background-color: white"> 99+          	return doFakeBidi(c, textNode, parent, parentStyle, previousIB, children);</span><br>        1315:  <span style="background-color: white">              }</span><br>        1316:  <span style="background-color: white">              </span><br>        1317:  <span style="background-color: white"> 99+          int nodeIndex = 0;                                            // Index into the text node.</span><br>        1318:  <span style="background-color: white"> 99+          String runText;                                               // Calculated text for the directional run.</span><br>        1319:  <span style="background-color: white">              </span><br>        1320:  <span style="background-color: white"> 99+          BidiTextRun prevSplit = para.prevSplit(startIndex); // Get directional run at or before startIndex.</span><br>        1321:  <span style="background-color: white">              	</span><br>        1322:  <span style="background-color: white"> 99+          assert(prevSplit != null);                  // There should always be a split at zero (start of paragraph) to fall back on. </span><br>        1323:  <span style="background-color: white"> 99+          assert(prevSplit.getStart() &lt;= startIndex); // Split should always be before or at the start of this text node.</span><br>        1324:  <span style="background-color: white">      </span><br>        1325:  <span style="background-color: white">              // When calculating length, remember that it may overlap the start and/or end of the text node.</span><br>        1326:  <span style="background-color: white"> 99+          int maxRunLength = prevSplit.getLength() - (startIndex - prevSplit.getStart());</span><br>        1327:  <span style="background-color: white"> 99+         	int splitLength = Math.min(maxRunLength, textNode.getLength());</span><br>        1328:  <span style="background-color: white">              </span><br>        1329:  <span style="background-color: white">             	// Advance char indexes.</span><br>        1330:  <span style="background-color: white"> 99+         	nodeIndex += splitLength;</span><br>        1331:  <span style="background-color: white"> 99+         	startIndex += splitLength;</span><br>        1332:  <span style="background-color: white">             	</span><br>        1333:  <span style="background-color: white"> 99+         	assert(prevSplit.getDirection() == BidiSplitter.LTR || prevSplit.getDirection() == BidiSplitter.RTL);</span><br>        1334:  <span style="background-color: white">      </span><br>        1335:  <span style="background-color: white"> 99+         	if (splitLength == textNode.getLength()) {</span><br>        1336:  <span style="background-color: white">             		// The simple case: the entire text node is part of a single direction run.</span><br>        1337:  <span style="background-color: white"> 99+         		runText = textNode.getData();</span><br>        1338:  <span style="background-color: white">             	}</span><br>        1339:  <span style="background-color: white">             	else {</span><br>        1340:  <span style="background-color: white">             		// The complex case: the first directional run only encompasses part of the text node. </span><br>        1341:  <span style="background-color: white">   6         		runText = textNode.getData().substring(0, nodeIndex);</span><br>        1342:  <span style="background-color: white">             	}</span><br>        1343:  <span style="background-color: white">             	</span><br>        1344:  <span style="background-color: white">      		// Shape here, so the layout will get the right visual length for the run.</span><br>        1345:  <span style="background-color: white"> 99+  		if (prevSplit.getDirection() == BidiSplitter.RTL) {</span><br>        1346:  <span style="background-color: white">  34  			runText = c.getBidiReorderer().shapeText(runText);</span><br>        1347:  <span style="background-color: white">      		}</span><br>        1348:  <span style="background-color: white">      </span><br>        1349:  <span style="background-color: white"> 99+         	InlineBox child = createInlineBox(runText, parent, parentStyle, textNode);</span><br>        1350:  <span style="background-color: white"> 99+         	child.setTextDirection(prevSplit.getDirection());</span><br>        1351:  <span style="background-color: white"> 99+         	previousIB = setupInlineChild(child, previousIB);</span><br>        1352:  <span style="background-color: white"> 99+         	children.add(child);</span><br>        1353:  <span style="background-color: white">             	</span><br>        1354:  <span style="background-color: white"> 99+         	if (splitLength != textNode.getLength()) {</span><br>        1355:  <span style="background-color: white">             		// We have more directional runs to extract.</span><br>        1356:  <span style="background-color: white">             		</span><br>        1357:  <span style="background-color: white">   6         		do {</span><br>        1358:  <span style="background-color: white">  30          		BidiTextRun newSplit = para.nextSplit(startIndex);</span><br>        1359:  <span style="background-color: white">  30          		assert(newSplit != null); // There should always be enough splits to completely cover the text node.</span><br>        1360:  <span style="background-color: white">              		</span><br>        1361:  <span style="background-color: white">  30          		int newLength;</span><br>        1362:  <span style="background-color: white">              		</span><br>        1363:  <span style="background-color: white">  30          		if (newSplit != null) {</span><br>        1364:  <span style="background-color: white">              			// When calculating length, remember that it may overlap the start and/or end of the text node.</span><br>        1365:  <span style="background-color: white">  30          			int newMaxRunLength = newSplit.getLength() - (startIndex - newSplit.getStart());</span><br>        1366:  <span style="background-color: white">  30          			newLength = Math.min(newMaxRunLength, textNode.getLength() - nodeIndex);</span><br>        1367:  <span style="background-color: white">              			</span><br>        1368:  <span style="background-color: white">  30          			runText = textNode.getData().substring(nodeIndex, nodeIndex + newLength);</span><br>        1369:  <span style="background-color: white">              			</span><br>        1370:  <span style="background-color: white">              			// Shape here, so the layout will get the right visual length for the run.</span><br>        1371:  <span style="background-color: white">  30          			if (newSplit.getDirection() == BidiSplitter.RTL) {</span><br>        1372:  <span style="background-color: white">  15          				runText = c.getBidiReorderer().shapeText(runText);</span><br>        1373:  <span style="background-color: white">              			}</span><br>        1374:  <span style="background-color: white">              			</span><br>        1375:  <span style="background-color: white">  30          			startIndex += newLength;</span><br>        1376:  <span style="background-color: white">  30          			nodeIndex += newLength;</span><br>        1377:  <span style="background-color: white">              			</span><br>        1378:  <span style="background-color: white">  30          			child = createInlineBox(runText, parent, parentStyle, textNode);</span><br>        1379:  <span style="background-color: white">  30          			child.setTextDirection(newSplit.getDirection());</span><br>        1380:  <span style="background-color: white">  30          	       	previousIB = setupInlineChild(child, previousIB);</span><br>        1381:  <span style="background-color: white">  30          	       	children.add(child);</span><br>        1382:  <span style="background-color: white">              		}</span><br>        1383:  <span style="background-color: white">              		else {</span><br>        1384:  <span style="background-color: white">              			// We should never get here, but handle it just in case.</span><br>        1385:  <span style="background-color: white">              			</span><br>        1386:  <span style="background-color: white">   0          			newLength = textNode.getLength() - nodeIndex;</span><br>        1387:  <span style="background-color: white">   0          			runText = textNode.getData().substring(nodeIndex, newLength);</span><br>        1388:  <span style="background-color: white">              			</span><br>        1389:  <span style="background-color: white">   0          			child = createInlineBox(runText, parent, parentStyle, textNode);</span><br>        1390:  <span style="background-color: white">   0          			child.setTextDirection(c.getDefaultTextDirection());</span><br>        1391:  <span style="background-color: white">   0          	       	previousIB = setupInlineChild(child, previousIB);</span><br>        1392:  <span style="background-color: white">   0          	       	children.add(child);</span><br>        1393:  <span style="background-color: white">      </span><br>        1394:  <span style="background-color: white">   0          			startIndex += newLength;</span><br>        1395:  <span style="background-color: white">   0          			nodeIndex += newLength;</span><br>        1396:  <span style="background-color: white">              		}</span><br>        1397:  <span style="background-color: white">  30          	} while(nodeIndex &lt; textNode.getLength());</span><br>        1398:  <span style="background-color: white">              }</span><br>        1399:  <span style="background-color: white">             	</span><br>        1400:  <span style="background-color: white"> 99+         	return previousIB;</span><br>        1401:  <span style="background-color: white">          }</span><br>        1402:  <span style="background-color: white">          </span><br>        1403:  <span style="background-color: white"> 99+      private static void insertAnonymousBlocks(</span><br>        1404:  <span style="background-color: white">                  SharedContext c, Box parent, List
       <styleable>
         children, boolean layoutRunningBlocks) {
       </styleable></span><br>        1405:  <span style="background-color: white">      </span><br>        1406:  <span style="background-color: white"> 99+          List
       <styleable>
         inline = new ArrayList&lt;&gt;();
       </styleable></span><br>        1407:  <span style="background-color: white"> 99+          Deque
       <inlinebox>
         parents = new ArrayDeque&lt;&gt;();
       </inlinebox></span><br>        1408:  <span style="background-color: white"> 99+          List
       <inlinebox>
         savedParents = null;
       </inlinebox></span><br>        1409:  <span style="background-color: white">      </span><br>        1410:  <span style="background-color: white"> 99+          for (Styleable child : children) {</span><br>        1411:  <span style="background-color: white"> 99+              if (child.getStyle().isLayedOutInInlineContext() &amp;&amp;</span><br>        1412:  <span style="background-color: white">                          ! (layoutRunningBlocks &amp;&amp; child.getStyle().isRunning()) &amp;&amp;</span><br>        1413:  <span style="background-color: white">                          !child.getStyle().isTableCell() //see issue https://github.com/danfickle/openhtmltopdf/issues/309</span><br>        1414:  <span style="background-color: white">                  ) {</span><br>        1415:  <span style="background-color: white"> 99+                  inline.add(child);</span><br>        1416:  <span style="background-color: white">      </span><br>        1417:  <span style="background-color: white"> 99+                  if (child.getStyle().isInline()) {</span><br>        1418:  <span style="background-color: white"> 99+                      InlineBox iB = (InlineBox) child;</span><br>        1419:  <span style="background-color: white"> 99+                      if (iB.isStartsHere()) {</span><br>        1420:  <span style="background-color: white"> 99+                          parents.add(iB);</span><br>        1421:  <span style="background-color: white">                          }</span><br>        1422:  <span style="background-color: white"> 99+                      if (iB.isEndsHere()) {</span><br>        1423:  <span style="background-color: white"> 99+                          parents.removeLast();</span><br>        1424:  <span style="background-color: white">                          }</span><br>        1425:  <span style="background-color: white">                      }</span><br>        1426:  <span style="background-color: white">                  } else {</span><br>        1427:  <span style="background-color: white"> 99+                  if (inline.size() &gt; 0) {</span><br>        1428:  <span style="background-color: white"> 99+                      createAnonymousBlock(c, parent, inline, savedParents);</span><br>        1429:  <span style="background-color: white"> 99+                      inline = new ArrayList&lt;&gt;();</span><br>        1430:  <span style="background-color: white"> 99+                      savedParents = new ArrayList&lt;&gt;(parents);</span><br>        1431:  <span style="background-color: white">                      }</span><br>        1432:  <span style="background-color: white"> 99+                  parent.addChild((Box) child);</span><br>        1433:  <span style="background-color: white">                  }</span><br>        1434:  <span style="background-color: white">              }</span><br>        1435:  <span style="background-color: white">      </span><br>        1436:  <span style="background-color: white"> 99+          createAnonymousBlock(c, parent, inline, savedParents);</span><br>        1437:  <span style="background-color: white">          }</span><br>        1438:  <span style="background-color: white">      </span><br>        1439:  <span style="background-color: yellow">   0      private static void createAnonymousInlineBlock(SharedContext c, Box parent, List
       <styleable>
         inline, List
        <inlinebox>
          savedParents) {
        </inlinebox>
       </styleable></span><br>        1440:  <span style="background-color: yellow">   0          createAnonymousBlock(c, parent, inline, savedParents, IdentValue.INLINE_BLOCK);</span><br>        1441:  <span style="background-color: yellow">          }</span><br>        1442:  <span style="background-color: white">      </span><br>        1443:  <span style="background-color: white"> 99+      private static void createAnonymousBlock(SharedContext c, Box parent, List
       <styleable>
         inline, List
        <inlinebox>
          savedParents) {
        </inlinebox>
       </styleable></span><br>        1444:  <span style="background-color: white"> 99+          createAnonymousBlock(c, parent, inline, savedParents, IdentValue.BLOCK);</span><br>        1445:  <span style="background-color: white">          }</span><br>        1446:  <span style="background-color: white">      </span><br>        1447:  <span style="background-color: white"> 99+      private static void createAnonymousBlock(SharedContext c, Box parent, List
       <styleable>
         inline, List
        <inlinebox>
          savedParents, IdentValue display) {
        </inlinebox>
       </styleable></span><br>        1448:  <span style="background-color: white"> 99+          WhitespaceStripper.stripInlineContent(inline);</span><br>        1449:  <span style="background-color: white"> 99+          if (inline.size() &gt; 0) {</span><br>        1450:  <span style="background-color: white"> 99+              AnonymousBlockBox anon = new AnonymousBlockBox(parent.getElement());</span><br>        1451:  <span style="background-color: white"> 99+              anon.setStyle(parent.getStyle().createAnonymousStyle(display));</span><br>        1452:  <span style="background-color: white"> 99+              anon.setAnonymous(true);</span><br>        1453:  <span style="background-color: white"> 99+              if (savedParents != null &amp;&amp; savedParents.size() &gt; 0) {</span><br>        1454:  <span style="background-color: white"> 99+                  anon.setOpenInlineBoxes(savedParents);</span><br>        1455:  <span style="background-color: white">                  }</span><br>        1456:  <span style="background-color: white"> 99+              parent.addChild(anon);</span><br>        1457:  <span style="background-color: yellow"> 99+              anon.setChildrenContentType(BlockBox.CONTENT_INLINE);</span><br>        1458:  <span style="background-color: white"> 99+              anon.setInlineContent(inline);</span><br>        1459:  <span style="background-color: white">              }</span><br>        1460:  <span style="background-color: white">          }</span><br>        1461:  <span style="background-color: white">      </span><br>        1462:  <span style="background-color: white">          private static class ChildBoxInfo {</span><br>        1463:  <span style="background-color: white">              private boolean _containsBlockLevelContent;</span><br>        1464:  <span style="background-color: white">              private boolean _containsTableContent;</span><br>        1465:  <span style="background-color: white">              private boolean _layoutRunningBlocks;</span><br>        1466:  <span style="background-color: white">      </span><br>        1467:  <span style="background-color: white"> 99+          public ChildBoxInfo() {</span><br>        1468:  <span style="background-color: white">              }</span><br>        1469:  <span style="background-color: white">      </span><br>        1470:  <span style="background-color: white"> 99+          public boolean isContainsBlockLevelContent() {</span><br>        1471:  <span style="background-color: white"> 99+              return _containsBlockLevelContent;</span><br>        1472:  <span style="background-color: white">              }</span><br>        1473:  <span style="background-color: white">      </span><br>        1474:  <span style="background-color: white"> 99+          public void setContainsBlockLevelContent(boolean containsBlockLevelContent) {</span><br>        1475:  <span style="background-color: white"> 99+              _containsBlockLevelContent = containsBlockLevelContent;</span><br>        1476:  <span style="background-color: white">              }</span><br>        1477:  <span style="background-color: white">      </span><br>        1478:  <span style="background-color: white"> 99+          public boolean isContainsTableContent() {</span><br>        1479:  <span style="background-color: white"> 99+              return _containsTableContent;</span><br>        1480:  <span style="background-color: white">              }</span><br>        1481:  <span style="background-color: white">      </span><br>        1482:  <span style="background-color: white"> 99+          public void setContainsTableContent(boolean containsTableContent) {</span><br>        1483:  <span style="background-color: white"> 99+              _containsTableContent = containsTableContent;</span><br>        1484:  <span style="background-color: white">              }</span><br>        1485:  <span style="background-color: white">      </span><br>        1486:  <span style="background-color: white"> 99+          public boolean isLayoutRunningBlocks() {</span><br>        1487:  <span style="background-color: white"> 99+              return _layoutRunningBlocks;</span><br>        1488:  <span style="background-color: white">              }</span><br>        1489:  <span style="background-color: white">      </span><br>        1490:  <span style="background-color: white"> 99+          public void setLayoutRunningBlocks(boolean layoutRunningBlocks) {</span><br>        1491:  <span style="background-color: white"> 99+              _layoutRunningBlocks = layoutRunningBlocks;</span><br>        1492:  <span style="background-color: white">              }</span><br>        1493:  <span style="background-color: white">          }</span><br>        1494:  <span style="background-color: white">      }</span><br></pre> </code> 
   </div> 
   <div class="column"> 
    <h2>Patched Code:</h2> <code> <pre id="patched-trace">        1-&gt;N:  <span style="background-color: white">      /*</span><br>        2-&gt;N:  <span style="background-color: white">       * {{{ header &amp; license</span><br>        3-&gt;N:  <span style="background-color: white">       * Copyright (c) 2004, 2005 Torbjoern Gannholm, Joshua Marinacci</span><br>        4-&gt;N:  <span style="background-color: white">       * Copyright (c) 2006 Wisconsin Court System</span><br>        5-&gt;N:  <span style="background-color: white">       *</span><br>        6-&gt;N:  <span style="background-color: white">       * This program is free software; you can redistribute it and/or</span><br>        7-&gt;N:  <span style="background-color: white">       * modify it under the terms of the GNU Lesser General Public License</span><br>        8-&gt;N:  <span style="background-color: white">       * as published by the Free Software Foundation; either version 2.1</span><br>        9-&gt;N:  <span style="background-color: white">       * of the License, or (at your option) any later version.</span><br>       10-&gt;N:  <span style="background-color: white">       *</span><br>       11-&gt;N:  <span style="background-color: white">       * This program is distributed in the hope that it will be useful,</span><br>       12-&gt;N:  <span style="background-color: white">       * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br>       13-&gt;N:  <span style="background-color: white">       * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span><br>       14-&gt;N:  <span style="background-color: white">       * GNU Lesser General Public License for more details.</span><br>       15-&gt;N:  <span style="background-color: white">       *</span><br>       16-&gt;N:  <span style="background-color: white">       * You should have received a copy of the GNU Lesser General Public License</span><br>       17-&gt;N:  <span style="background-color: white">       * along with this program; if not, write to the Free Software</span><br>       18-&gt;N:  <span style="background-color: white">       * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span><br>       19-&gt;N:  <span style="background-color: white">       * }}}</span><br>       20-&gt;N:  <span style="background-color: white">       */</span><br>       21-&gt;N:  <span style="background-color: white">      package com.openhtmltopdf.layout;</span><br>       22-&gt;N:  <span style="background-color: white">      </span><br>       23-&gt;N:  <span style="background-color: white">      import java.util.ArrayDeque;</span><br>       24-&gt;N:  <span style="background-color: white">      import java.util.ArrayList;</span><br>       25-&gt;N:  <span style="background-color: white">      import java.util.Collections;</span><br>       26-&gt;N:  <span style="background-color: white">      import java.util.Deque;</span><br>       27-&gt;N:  <span style="background-color: white">      import java.util.HashMap;</span><br>       28-&gt;N:  <span style="background-color: white">      import java.util.Iterator;</span><br>       29-&gt;N:  <span style="background-color: white">      import java.util.List;</span><br>       30-&gt;N:  <span style="background-color: white">      import java.util.Map;</span><br>       31-&gt;N:  <span style="background-color: white">      import java.util.logging.Level;</span><br>       32-&gt;N:  <span style="background-color: white">      </span><br>       33-&gt;N:  <span style="background-color: white">      import org.w3c.dom.Document;</span><br>       34-&gt;N:  <span style="background-color: white">      import org.w3c.dom.Element;</span><br>       35-&gt;N:  <span style="background-color: white">      import org.w3c.dom.Node;</span><br>       36-&gt;N:  <span style="background-color: white">      import org.w3c.dom.Text;</span><br>       37-&gt;N:  <span style="background-color: white">      </span><br>       38-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.bidi.BidiSplitter;</span><br>       39-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.bidi.BidiTextRun;</span><br>       40-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.bidi.ParagraphSplitter.Paragraph;</span><br>       41-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.CSSName;</span><br>       42-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.IdentValue;</span><br>       43-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.MarginBoxName;</span><br>       44-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.constants.PageElementPosition;</span><br>       45-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.extend.ContentFunction;</span><br>       46-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.CascadedStyle;</span><br>       47-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.newmatch.PageInfo;</span><br>       48-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.CSSPrimitiveValue;</span><br>       49-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.FSFunction;</span><br>       50-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.parser.PropertyValue;</span><br>       51-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.PropertyDeclaration;</span><br>       52-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.sheet.StylesheetInfo;</span><br>       53-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.CalculatedStyle;</span><br>       54-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.EmptyStyle;</span><br>       55-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.css.style.FSDerivedValue;</span><br>       56-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.counter.AbstractCounterContext;</span><br>       57-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.layout.counter.RootCounterContext;</span><br>       58-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableBox;</span><br>       59-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableCellBox;</span><br>       60-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableColumn;</span><br>       61-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableRowBox;</span><br>       62-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.newtable.TableSectionBox;</span><br>       63-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.AnonymousBlockBox;</span><br>       64-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.BlockBox;</span><br>       65-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.Box;</span><br>       66-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.FloatedBoxData;</span><br>       67-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.FlowingColumnBox;</span><br>       68-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.FlowingColumnContainerBox;</span><br>       69-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.render.InlineBox;</span><br>       70-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.OpenUtil;</span><br>       71-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.XRLog;</span><br>       72-&gt;N:  <span style="background-color: white">      import com.openhtmltopdf.util.LogMessageId;</span><br>       73-&gt;N:  <span style="background-color: white">      </span><br>       74-&gt;N:  <span style="background-color: white">      /**</span><br>       75-&gt;N:  <span style="background-color: white">       * This class is responsible for creating the box tree from the DOM.  This is</span><br>       76-&gt;N:  <span style="background-color: white">       * mostly just a one-to-one translation from the <code>Element</code> to an</span><br>       77-&gt;N:  <span style="background-color: white">       * <code>InlineBox</code> or a <code>BlockBox</code> (or some subclass of</span><br>       78-&gt;N:  <span style="background-color: white">       * <code>BlockBox</code>), but the tree is reorganized according to the CSS rules.</span><br>       79-&gt;N:  <span style="background-color: white">       * This includes inserting anonymous block and inline boxes, anonymous table</span><br>       80-&gt;N:  <span style="background-color: white">       * content, and <code>:before</code> and <code>:after</code> content.  White</span><br>       81-&gt;N:  <span style="background-color: white">       * space is also normalized at this point.  Table columns and table column groups</span><br>       82-&gt;N:  <span style="background-color: white">       * are added to the table which owns them, but are not created as regular boxes.</span><br>       83-&gt;N:  <span style="background-color: white">       * Floated and absolutely positioned content is always treated as inline</span><br>       84-&gt;N:  <span style="background-color: white">       * content for purposes of inserting anonymous block boxes and calculating</span><br>       85-&gt;N:  <span style="background-color: white">       * the kind of content contained in a given block box.</span><br>       86-&gt;N:  <span style="background-color: white">       */</span><br>       87-&gt;N:  <span style="background-color: white">      public class BoxBuilder {</span><br>      88-&gt;82:  <span style="background-color: white">          public static final int MARGIN_BOX_VERTICAL = 1;</span><br>      89-&gt;83:  <span style="background-color: white">          public static final int MARGIN_BOX_HORIZONTAL = 2;</span><br>       90-&gt;N:  <span style="background-color: white">      </span><br>      91-&gt;85:  <span style="background-color: white">          private static final int CONTENT_LIST_DOCUMENT = 1;</span><br>      92-&gt;86:  <span style="background-color: white">          private static final int CONTENT_LIST_MARGIN_BOX = 2;</span><br>       93-&gt;N:  <span style="background-color: white">      </span><br>       94-&gt;N:  <span style="background-color: white">          /**</span><br>       95-&gt;N:  <span style="background-color: white">           * Split the document into paragraphs for use in analyzing bi-directional text runs.</span><br>       96-&gt;N:  <span style="background-color: white">           * @param c</span><br>       97-&gt;N:  <span style="background-color: white">           * @param document</span><br>       98-&gt;N:  <span style="background-color: white">           */</span><br>      99-&gt;93:  <span style="background-color: cyan"> 99+      private static void splitParagraphs(LayoutContext c, Document document) {</span><br>     100-&gt;94:  <span style="background-color: cyan"> 99+          c.getParagraphSplitter().splitRoot(c, document);</span><br>     101-&gt;95:  <span style="background-color: cyan"> 99+          c.getParagraphSplitter().runBidiOnParagraphs(c);</span><br>      102-&gt;N:  <span style="background-color: white">          }</span><br>      103-&gt;N:  <span style="background-color: white">      </span><br>     104-&gt;98:  <span style="background-color: cyan"> 99+      public static BlockBox createRootBox(LayoutContext c, Document document) {</span><br>     105-&gt;99:  <span style="background-color: cyan"> 99+          splitParagraphs(c, document);</span><br>      106-&gt;N:  <span style="background-color: white">      </span><br>    107-&gt;101:  <span style="background-color: cyan"> 99+          Element root = document.getDocumentElement();</span><br>      108-&gt;N:  <span style="background-color: white">      </span><br>    109-&gt;103:  <span style="background-color: cyan"> 99+          CalculatedStyle style = c.getSharedContext().getStyle(root);</span><br>      110-&gt;N:  <span style="background-color: white">      </span><br>    111-&gt;105:  <span style="background-color: cyan"> 99+          BlockBox result;</span><br>    112-&gt;106:  <span style="background-color: cyan"> 99+          if (style.isTable() || style.isInlineTable()) {</span><br>    113-&gt;107:  <span style="background-color: white">   0              result = new TableBox();</span><br>      114-&gt;N:  <span style="background-color: white">              } else {</span><br>    115-&gt;109:  <span style="background-color: cyan"> 99+              result = new BlockBox();</span><br>      116-&gt;N:  <span style="background-color: white">              }</span><br>      117-&gt;N:  <span style="background-color: white">      </span><br>    118-&gt;112:  <span style="background-color: cyan"> 99+          result.setStyle(style);</span><br>    119-&gt;113:  <span style="background-color: cyan"> 99+          result.setElement(root);</span><br>      120-&gt;N:  <span style="background-color: white">      </span><br>    121-&gt;115:  <span style="background-color: cyan"> 99+          c.resolveCounters(style);</span><br>      122-&gt;N:  <span style="background-color: white">      </span><br>    123-&gt;117:  <span style="background-color: cyan"> 99+          return result;</span><br>      124-&gt;N:  <span style="background-color: white">          }</span><br>      125-&gt;N:  <span style="background-color: white">      </span><br>    126-&gt;120:  <span style="background-color: cyan"> 99+      public static void createChildren(LayoutContext c, BlockBox parent) {</span><br>    127-&gt;121:  <span style="background-color: cyan"> 99+          if (parent.shouldBeReplaced()) {</span><br>      128-&gt;N:  <span style="background-color: white">                  // Don't create boxes for elements in a SVG element.</span><br>      129-&gt;N:  <span style="background-color: white">                  // This avoids many warnings and improves performance.</span><br>      130-&gt;U:  <span style="background-color: yellow"> 99+              parent.setChildrenContentType(BlockBox.ContentType.EMPTY);</span><br>    131-&gt;123:  <span style="background-color: cyan"> 99+              return;</span><br>      132-&gt;U:  <span style="background-color: yellow"> 99+          } else if (isInsertedBoxIgnored(parent.getElement())) {</span><br>      133-&gt;U:  <span style="background-color: yellow">   0              return;</span><br>      134-&gt;U:  <span style="background-color: yellow">              }</span><br>      135-&gt;N:  <span style="background-color: white">      </span><br>    136-&gt;126:  <span style="background-color: cyan"> 99+          List
       <styleable>
         children = new ArrayList&lt;&gt;();
       </styleable></span><br>    137-&gt;128:  <span style="background-color: cyan"> 99+          ChildBoxInfo info = new ChildBoxInfo();</span><br>      138-&gt;U:  <span style="background-color: yellow"> 99+          CalculatedStyle parentStyle = parent.getStyle();</span><br>      139-&gt;N:  <span style="background-color: white">      </span><br>      140-&gt;U:  <span style="background-color: yellow"> 99+          boolean oldAllowFootnotes = c.isFootnoteAllowed();</span><br>      141-&gt;U:  <span style="background-color: yellow"> 99+          if (parentStyle.isFixed() || parentStyle.isRunning()) {</span><br>      142-&gt;U:  <span style="background-color: yellow"> 99+              c.setFootnoteAllowed(false);</span><br>      143-&gt;U:  <span style="background-color: yellow">              }</span><br>      144-&gt;N:  <span style="background-color: white">      </span><br>    145-&gt;130:  <span style="background-color: cyan"> 99+          createChildren(c, parent, parent.getElement(), children, info, false);</span><br>      146-&gt;N:  <span style="background-color: white">      </span><br>      147-&gt;U:  <span style="background-color: yellow"> 99+          boolean parentIsNestingTableContent = isNestingTableContent(parentStyle.getIdent(</span><br>    148-&gt;133:  <span style="background-color: white">                      CSSName.DISPLAY));</span><br>      149-&gt;N:  <span style="background-color: white">      </span><br>    150-&gt;135:  <span style="background-color: cyan"> 99+          if (!parentIsNestingTableContent &amp;&amp; !info.isContainsTableContent()) {</span><br>    151-&gt;136:  <span style="background-color: cyan"> 99+              resolveChildren(c, parent, children, info);</span><br>      152-&gt;N:  <span style="background-color: white">              } else {</span><br>    153-&gt;138:  <span style="background-color: cyan"> 99+              stripAllWhitespace(children);</span><br>    154-&gt;139:  <span style="background-color: cyan"> 99+              if (parentIsNestingTableContent) {</span><br>    155-&gt;140:  <span style="background-color: cyan"> 99+                  resolveTableContent(c, parent, children, info);</span><br>      156-&gt;N:  <span style="background-color: white">                  } else {</span><br>    157-&gt;142:  <span style="background-color: cyan">  57                  resolveChildTableContent(c, parent, children, info, IdentValue.TABLE_CELL);</span><br>      158-&gt;N:  <span style="background-color: white">                  }</span><br>      159-&gt;N:  <span style="background-color: white">              }</span><br>      160-&gt;N:  <span style="background-color: white">      </span><br>      161-&gt;U:  <span style="background-color: yellow"> 99+          c.setFootnoteAllowed(oldAllowFootnotes);</span><br>      162-&gt;N:  <span style="background-color: white">      </span><br>      163-&gt;N:  <span style="background-color: white">              // The following is very useful for debugging.</span><br>      164-&gt;N:  <span style="background-color: white">              // It shows the contents of the box tree before layout.</span><br>      165-&gt;N:  <span style="background-color: white">      //        if (parent == c.getRootLayer().getMaster()) {</span><br>      166-&gt;N:  <span style="background-color: white">      //            System.out.println(com.openhtmltopdf.util.LambdaUtil.descendantDump(parent));</span><br>      167-&gt;N:  <span style="background-color: white">      //        }</span><br>      168-&gt;N:  <span style="background-color: white">          }</span><br>      169-&gt;N:  <span style="background-color: white">      </span><br>      170-&gt;U:  <span style="background-color: yellow"> 99+      private static boolean isInsertedBoxIgnored(Element element) {</span><br>      171-&gt;U:  <span style="background-color: yellow"> 99+          if (element == null) {</span><br>      172-&gt;U:  <span style="background-color: yellow">   0              return false;</span><br>      173-&gt;U:  <span style="background-color: yellow">              }</span><br>      174-&gt;U:  <span style="background-color: yellow">      </span><br>      175-&gt;U:  <span style="background-color: yellow"> 99+          String tag = element.getTagName();</span><br>      176-&gt;U:  <span style="background-color: yellow">      </span><br>      177-&gt;U:  <span style="background-color: yellow"> 99+          if (!tag.startsWith("fs-")) {</span><br>      178-&gt;U:  <span style="background-color: yellow"> 99+              return false;</span><br>      179-&gt;U:  <span style="background-color: yellow">              }</span><br>      180-&gt;U:  <span style="background-color: yellow">      </span><br>      181-&gt;U:  <span style="background-color: yellow"> 99+          switch (tag) {</span><br>      182-&gt;U:  <span style="background-color: yellow">   0          case "fs-footnote":</span><br>      183-&gt;U:  <span style="background-color: yellow"> 99+          case "fs-footnote-body":</span><br>      184-&gt;U:  <span style="background-color: yellow"> 99+              return true;</span><br>      185-&gt;U:  <span style="background-color: yellow">   0          default:</span><br>      186-&gt;U:  <span style="background-color: yellow">   0              return false;</span><br>      187-&gt;U:  <span style="background-color: yellow">              }</span><br>      188-&gt;U:  <span style="background-color: yellow">          }</span><br>      189-&gt;N:  <span style="background-color: white">      </span><br>    190-&gt;147:  <span style="background-color: cyan"> 99+      public static TableBox createMarginTable(</span><br>    191-&gt;148:  <span style="background-color: white">                  LayoutContext c,</span><br>    192-&gt;149:  <span style="background-color: white">                  PageInfo pageInfo,</span><br>    193-&gt;150:  <span style="background-color: white">                  MarginBoxName[] names,</span><br>    194-&gt;151:  <span style="background-color: white">                  int height,</span><br>    195-&gt;152:  <span style="background-color: white">                  int direction)</span><br>      196-&gt;N:  <span style="background-color: white">          {</span><br>    197-&gt;154:  <span style="background-color: cyan"> 99+          if (! pageInfo.hasAny(names)) {</span><br>    198-&gt;155:  <span style="background-color: cyan"> 99+              return null;</span><br>      199-&gt;N:  <span style="background-color: white">              }</span><br>      200-&gt;N:  <span style="background-color: white">      </span><br>    201-&gt;158:  <span style="background-color: cyan"> 99+          Element source = c.getRootLayer().getMaster().getElement(); // HACK</span><br>      202-&gt;N:  <span style="background-color: white">      </span><br>    203-&gt;160:  <span style="background-color: cyan"> 99+          ChildBoxInfo info = new ChildBoxInfo();</span><br>    204-&gt;161:  <span style="background-color: cyan"> 99+          CalculatedStyle pageStyle = new EmptyStyle().deriveStyle(pageInfo.getPageStyle());</span><br>      205-&gt;N:  <span style="background-color: white">      </span><br>    206-&gt;163:  <span style="background-color: cyan"> 99+          CalculatedStyle tableStyle = pageStyle.deriveStyle(</span><br>    207-&gt;164:  <span style="background-color: white">                      CascadedStyle.createLayoutStyle(new PropertyDeclaration[] {</span><br>      208-&gt;N:  <span style="background-color: white">                              new PropertyDeclaration(</span><br>      209-&gt;N:  <span style="background-color: white">                                      CSSName.DISPLAY,</span><br>      210-&gt;N:  <span style="background-color: white">                                      new PropertyValue(IdentValue.TABLE),</span><br>    211-&gt;168:  <span style="background-color: white">                                      true,</span><br>      212-&gt;N:  <span style="background-color: white">                                      StylesheetInfo.USER),</span><br>      213-&gt;N:  <span style="background-color: white">                              new PropertyDeclaration(</span><br>      214-&gt;N:  <span style="background-color: white">                                      CSSName.WIDTH,</span><br>    215-&gt;172:  <span style="background-color: white">                                      new PropertyValue(CSSPrimitiveValue.CSS_PERCENTAGE, 100.0f, "100%"),</span><br>    216-&gt;173:  <span style="background-color: white">                                      true,</span><br>      217-&gt;N:  <span style="background-color: white">                                      StylesheetInfo.USER),</span><br>      218-&gt;N:  <span style="background-color: white">                      }));</span><br>    219-&gt;176:  <span style="background-color: cyan"> 99+          TableBox result = (TableBox)createBlockBox(tableStyle, info, false);</span><br>    220-&gt;177:  <span style="background-color: cyan"> 99+          result.setMarginAreaRoot(true);</span><br>    221-&gt;178:  <span style="background-color: cyan"> 99+          result.setStyle(tableStyle);</span><br>    222-&gt;179:  <span style="background-color: cyan"> 99+          result.setElement(source);</span><br>    223-&gt;180:  <span style="background-color: cyan"> 99+          result.setAnonymous(true);</span><br>      224-&gt;U:  <span style="background-color: yellow"> 99+          result.setChildrenContentType(BlockBox.ContentType.BLOCK);</span><br>      225-&gt;N:  <span style="background-color: white">      </span><br>    226-&gt;183:  <span style="background-color: cyan"> 99+          CalculatedStyle tableSectionStyle = pageStyle.createAnonymousStyle(IdentValue.TABLE_ROW_GROUP);</span><br>    227-&gt;184:  <span style="background-color: cyan"> 99+          TableSectionBox section = (TableSectionBox)createBlockBox(tableSectionStyle, info, false);</span><br>    228-&gt;185:  <span style="background-color: cyan"> 99+          section.setStyle(tableSectionStyle);</span><br>    229-&gt;186:  <span style="background-color: cyan"> 99+          section.setElement(source);</span><br>    230-&gt;187:  <span style="background-color: cyan"> 99+          section.setAnonymous(true);</span><br>      231-&gt;U:  <span style="background-color: yellow"> 99+          section.setChildrenContentType(BlockBox.ContentType.BLOCK);</span><br>      232-&gt;N:  <span style="background-color: white">      </span><br>    233-&gt;190:  <span style="background-color: cyan"> 99+          result.addChild(section);</span><br>      234-&gt;N:  <span style="background-color: white">      </span><br>    235-&gt;192:  <span style="background-color: cyan"> 99+          TableRowBox row = null;</span><br>      236-&gt;U:  <span style="background-color: yellow"> 99+          if (direction == MARGIN_BOX_HORIZONTAL) {</span><br>      237-&gt;U:  <span style="background-color: yellow"> 99+              CalculatedStyle tableRowStyle = pageStyle.createAnonymousStyle(IdentValue.TABLE_ROW);</span><br>      238-&gt;U:  <span style="background-color: yellow"> 99+              row = (TableRowBox)createBlockBox(tableRowStyle, info, false);</span><br>      239-&gt;U:  <span style="background-color: yellow"> 99+              row.setStyle(tableRowStyle);</span><br>      240-&gt;U:  <span style="background-color: yellow"> 99+              row.setElement(source);</span><br>      241-&gt;U:  <span style="background-color: yellow"> 99+              row.setAnonymous(true);</span><br>      242-&gt;U:  <span style="background-color: yellow"> 99+              row.setChildrenContentType(BlockBox.ContentType.BLOCK);</span><br>      243-&gt;U:  <span style="background-color: yellow">      </span><br>      244-&gt;U:  <span style="background-color: yellow"> 99+              row.setHeightOverride(height);</span><br>      245-&gt;U:  <span style="background-color: yellow">      </span><br>      246-&gt;U:  <span style="background-color: yellow"> 99+              section.addChild(row);</span><br>      247-&gt;U:  <span style="background-color: yellow">              }</span><br>      248-&gt;N:  <span style="background-color: white">      </span><br>    249-&gt;206:  <span style="background-color: cyan"> 99+          int cellCount = 0;</span><br>    250-&gt;207:  <span style="background-color: cyan"> 99+          boolean alwaysCreate = names.length &gt; 1 &amp;&amp; direction == MARGIN_BOX_HORIZONTAL;</span><br>      251-&gt;N:  <span style="background-color: white">      </span><br>    252-&gt;209:  <span style="background-color: cyan"> 99+          for (int i = 0; i &lt; names.length; i++) {</span><br>    253-&gt;210:  <span style="background-color: cyan"> 99+              CascadedStyle cellStyle = pageInfo.createMarginBoxStyle(names[i], alwaysCreate);</span><br>    254-&gt;211:  <span style="background-color: cyan"> 99+              if (cellStyle != null) {</span><br>    255-&gt;212:  <span style="background-color: cyan"> 99+                  TableCellBox cell = createMarginBox(c, cellStyle, alwaysCreate);</span><br>    256-&gt;213:  <span style="background-color: cyan"> 99+                  if (cell != null) {</span><br>      257-&gt;U:  <span style="background-color: yellow"> 99+                      if (direction == MARGIN_BOX_VERTICAL) {</span><br>      258-&gt;U:  <span style="background-color: yellow">  84                          CalculatedStyle tableRowStyle = pageStyle.createAnonymousStyle(IdentValue.TABLE_ROW);</span><br>      259-&gt;U:  <span style="background-color: yellow">  84                          row = (TableRowBox)createBlockBox(tableRowStyle, info, false);</span><br>      260-&gt;U:  <span style="background-color: yellow">  84                          row.setStyle(tableRowStyle);</span><br>      261-&gt;U:  <span style="background-color: yellow">  84                          row.setElement(source);</span><br>      262-&gt;U:  <span style="background-color: yellow">  84                          row.setAnonymous(true);</span><br>      263-&gt;U:  <span style="background-color: yellow">  84                          row.setChildrenContentType(BlockBox.ContentType.BLOCK);</span><br>      264-&gt;U:  <span style="background-color: yellow">      </span><br>      265-&gt;U:  <span style="background-color: yellow">  84                          row.setHeightOverride(height);</span><br>      266-&gt;U:  <span style="background-color: yellow">      </span><br>      267-&gt;U:  <span style="background-color: yellow">  84                          section.addChild(row);</span><br>      268-&gt;U:  <span style="background-color: yellow">                          }</span><br>    269-&gt;226:  <span style="background-color: cyan"> 99+                      row.addChild(cell);</span><br>    270-&gt;227:  <span style="background-color: cyan"> 99+                      cellCount++;</span><br>      271-&gt;N:  <span style="background-color: white">                      }</span><br>      272-&gt;N:  <span style="background-color: white">                  }</span><br>      273-&gt;N:  <span style="background-color: white">              }</span><br>      274-&gt;N:  <span style="background-color: white">      </span><br>    275-&gt;232:  <span style="background-color: cyan"> 99+          if (direction == MARGIN_BOX_VERTICAL &amp;&amp; cellCount &gt; 0) {</span><br>    276-&gt;233:  <span style="background-color: white">  62              int rHeight = 0;</span><br>    277-&gt;234:  <span style="background-color: white"> 99+              for (Iterator
       <box>
         i = section.getChildIterator(); i.hasNext(); ) {
       </box></span><br>    278-&gt;235:  <span style="background-color: white">  84                  TableRowBox r = (TableRowBox)i.next();</span><br>    279-&gt;236:  <span style="background-color: white">  84                  r.setHeightOverride(height / cellCount);</span><br>    280-&gt;237:  <span style="background-color: white">  84                  rHeight += r.getHeightOverride();</span><br>      281-&gt;N:  <span style="background-color: white">                  }</span><br>      282-&gt;N:  <span style="background-color: white">      </span><br>    283-&gt;240:  <span style="background-color: white">  74              for (Iterator
       <box>
         i = section.getChildIterator(); i.hasNext() &amp;&amp; rHeight &lt; height; ) {
       </box></span><br>    284-&gt;241:  <span style="background-color: white">  12                  TableRowBox r = (TableRowBox)i.next();</span><br>    285-&gt;242:  <span style="background-color: white">  12                  r.setHeightOverride(r.getHeightOverride()+1);</span><br>    286-&gt;243:  <span style="background-color: white">  12                  rHeight++;</span><br>      287-&gt;N:  <span style="background-color: white">                  }</span><br>      288-&gt;N:  <span style="background-color: white">              }</span><br>      289-&gt;N:  <span style="background-color: white">      </span><br>    290-&gt;247:  <span style="background-color: cyan"> 99+          return cellCount &gt; 0 ? result : null;</span><br>      291-&gt;N:  <span style="background-color: white">          }</span><br>      292-&gt;N:  <span style="background-color: white">      </span><br>    293-&gt;250:  <span style="background-color: cyan"> 99+      private static TableCellBox createMarginBox(</span><br>    294-&gt;251:  <span style="background-color: white">                  LayoutContext c,</span><br>    295-&gt;252:  <span style="background-color: white">                  CascadedStyle cascadedStyle,</span><br>    296-&gt;253:  <span style="background-color: white">                  boolean alwaysCreate) {</span><br>    297-&gt;254:  <span style="background-color: cyan"> 99+          boolean hasContent = true;</span><br>      298-&gt;N:  <span style="background-color: white">      </span><br>    299-&gt;256:  <span style="background-color: cyan"> 99+          PropertyDeclaration contentDecl = cascadedStyle.propertyByName(CSSName.CONTENT);</span><br>      300-&gt;N:  <span style="background-color: white">      </span><br>    301-&gt;258:  <span style="background-color: cyan"> 99+          CalculatedStyle style = new EmptyStyle().deriveStyle(cascadedStyle);</span><br>      302-&gt;N:  <span style="background-color: white">      </span><br>    303-&gt;260:  <span style="background-color: cyan"> 99+          if (style.isDisplayNone() &amp;&amp; ! alwaysCreate) {</span><br>    304-&gt;261:  <span style="background-color: white">   0              return null;</span><br>      305-&gt;N:  <span style="background-color: white">              }</span><br>      306-&gt;N:  <span style="background-color: white">      </span><br>    307-&gt;264:  <span style="background-color: cyan"> 99+          if (style.isIdent(CSSName.CONTENT, IdentValue.NONE) ||</span><br>    308-&gt;265:  <span style="background-color: white">                      style.isIdent(CSSName.CONTENT, IdentValue.NORMAL)) {</span><br>    309-&gt;266:  <span style="background-color: cyan"> 99+              hasContent = false;</span><br>      310-&gt;N:  <span style="background-color: white">              }</span><br>      311-&gt;N:  <span style="background-color: white">      </span><br>    312-&gt;269:  <span style="background-color: cyan"> 99+          if (style.isAutoWidth() &amp;&amp; ! alwaysCreate &amp;&amp; ! hasContent) {</span><br>    313-&gt;270:  <span style="background-color: white">   0              return null;</span><br>      314-&gt;N:  <span style="background-color: white">              }</span><br>      315-&gt;N:  <span style="background-color: white">      </span><br>    316-&gt;273:  <span style="background-color: cyan"> 99+          List
       <styleable>
         children = new ArrayList&lt;&gt;();
       </styleable></span><br>      317-&gt;N:  <span style="background-color: white">      </span><br>    318-&gt;275:  <span style="background-color: cyan"> 99+          ChildBoxInfo info = new ChildBoxInfo();</span><br>    319-&gt;276:  <span style="background-color: cyan"> 99+          info.setContainsTableContent(true);</span><br>    320-&gt;277:  <span style="background-color: cyan"> 99+          info.setLayoutRunningBlocks(true);</span><br>      321-&gt;N:  <span style="background-color: white">      </span><br>    322-&gt;279:  <span style="background-color: cyan"> 99+          TableCellBox result = new TableCellBox();</span><br>    323-&gt;280:  <span style="background-color: cyan"> 99+          result.setAnonymous(true);</span><br>    324-&gt;281:  <span style="background-color: cyan"> 99+          result.setStyle(style);</span><br>    325-&gt;282:  <span style="background-color: cyan"> 99+          result.setElement(c.getRootLayer().getMaster().getElement()); // XXX Doesn't make sense, but we need something here</span><br>      326-&gt;N:  <span style="background-color: white">      </span><br>    327-&gt;284:  <span style="background-color: cyan"> 99+          if (hasContent &amp;&amp; ! style.isDisplayNone()) {</span><br>    328-&gt;285:  <span style="background-color: cyan"> 99+              children.addAll(createGeneratedMarginBoxContent(</span><br>    329-&gt;286:  <span style="background-color: white">                          c,</span><br>    330-&gt;287:  <span style="background-color: white">                          c.getRootLayer().getMaster().getElement(),</span><br>    331-&gt;288:  <span style="background-color: white">                          (PropertyValue)contentDecl.getValue(),</span><br>    332-&gt;289:  <span style="background-color: white">                          style,</span><br>    333-&gt;290:  <span style="background-color: white">                          info));</span><br>      334-&gt;N:  <span style="background-color: white">      </span><br>    335-&gt;292:  <span style="background-color: cyan"> 99+              stripAllWhitespace(children);</span><br>      336-&gt;N:  <span style="background-color: white">              }</span><br>      337-&gt;N:  <span style="background-color: white">      </span><br>    338-&gt;295:  <span style="background-color: cyan"> 99+          resolveChildTableContent(c, result, children, info, IdentValue.TABLE_CELL);</span><br>      339-&gt;N:  <span style="background-color: white">      </span><br>    340-&gt;297:  <span style="background-color: cyan"> 99+          return result;</span><br>      341-&gt;N:  <span style="background-color: white">          }</span><br>      342-&gt;N:  <span style="background-color: white">      </span><br>    343-&gt;300:  <span style="background-color: cyan"> 99+      private static void resolveChildren(</span><br>    344-&gt;301:  <span style="background-color: white">                  LayoutContext c, BlockBox owner, List
       <styleable>
         children, ChildBoxInfo info) {
       </styleable></span><br>    345-&gt;302:  <span style="background-color: cyan"> 99+          if (children.size() &gt; 0) {</span><br>    346-&gt;303:  <span style="background-color: cyan"> 99+              if (info.isContainsBlockLevelContent()) {</span><br>      347-&gt;N:  <span style="background-color: white"> 99+                  insertAnonymousBlocks(</span><br>    348-&gt;305:  <span style="background-color: white">                              c.getSharedContext(), owner, children, info.isLayoutRunningBlocks());</span><br>      349-&gt;U:  <span style="background-color: yellow"> 99+                  owner.setChildrenContentType(BlockBox.ContentType.BLOCK);</span><br>      350-&gt;N:  <span style="background-color: white">                  } else {</span><br>    351-&gt;308:  <span style="background-color: cyan"> 99+                  WhitespaceStripper.stripInlineContent(children);</span><br>    352-&gt;309:  <span style="background-color: cyan"> 99+                  if (children.size() &gt; 0) {</span><br>    353-&gt;310:  <span style="background-color: cyan"> 99+                      owner.setInlineContent(children);</span><br>      354-&gt;U:  <span style="background-color: yellow"> 99+                      owner.setChildrenContentType(BlockBox.ContentType.INLINE);</span><br>      355-&gt;N:  <span style="background-color: white">                      } else {</span><br>      356-&gt;U:  <span style="background-color: yellow"> 99+                      owner.setChildrenContentType(BlockBox.ContentType.EMPTY);</span><br>      357-&gt;N:  <span style="background-color: white">                      }</span><br>      358-&gt;N:  <span style="background-color: white">                  }</span><br>      359-&gt;N:  <span style="background-color: white">              } else {</span><br>      360-&gt;U:  <span style="background-color: yellow"> 99+              owner.setChildrenContentType(BlockBox.ContentType.EMPTY);</span><br>      361-&gt;N:  <span style="background-color: white">              }</span><br>      362-&gt;N:  <span style="background-color: white">          }</span><br>      363-&gt;N:  <span style="background-color: white">      </span><br>    364-&gt;321:  <span style="background-color: cyan"> 99+      private static boolean isAllProperTableNesting(IdentValue parentDisplay, List
       <styleable>
         children) {
       </styleable></span><br>    365-&gt;322:  <span style="background-color: cyan"> 99+          return children.stream().allMatch(child -&gt; isProperTableNesting(parentDisplay, child.getStyle().getIdent(CSSName.DISPLAY)));</span><br>      366-&gt;N:  <span style="background-color: white">          }</span><br>      367-&gt;N:  <span style="background-color: white">      </span><br>      368-&gt;N:  <span style="background-color: white">          /**</span><br>      369-&gt;N:  <span style="background-color: white">           * Handles the situation when we find table content, but our parent is not</span><br>      370-&gt;N:  <span style="background-color: white">           * table related.  For example, <code>div</code> -&gt; <code>td</code>.</span><br>      371-&gt;N:  <span style="background-color: white">           * Anonymous tables are then constructed by repeatedly pulling together</span><br>      372-&gt;N:  <span style="background-color: white">           * consecutive same-table-level siblings and wrapping them in the next</span><br>      373-&gt;N:  <span style="background-color: white">           * highest table level (e.g. consecutive <code>td</code> elements will</span><br>      374-&gt;N:  <span style="background-color: white">           * be wrapped in an anonymous <code>tr</code>, then a <code>tbody</code>, and</span><br>      375-&gt;N:  <span style="background-color: white">           * finally a <code>table</code>).</span><br>      376-&gt;N:  <span style="background-color: white">           */</span><br>    377-&gt;334:  <span style="background-color: cyan"> 99+      private static void resolveChildTableContent(</span><br>    378-&gt;335:  <span style="background-color: white">                  LayoutContext c, BlockBox parent, List
       <styleable>
         children, ChildBoxInfo info, IdentValue target) {
       </styleable></span><br>    379-&gt;336:  <span style="background-color: cyan"> 99+          List
       <styleable>
         childrenForAnonymous = new ArrayList&lt;&gt;();
       </styleable></span><br>    380-&gt;337:  <span style="background-color: cyan"> 99+          List
       <styleable>
         childrenWithAnonymous = new ArrayList&lt;&gt;();
       </styleable></span><br>      381-&gt;N:  <span style="background-color: white">      </span><br>    382-&gt;339:  <span style="background-color: cyan"> 99+          IdentValue nextUp = getPreviousTableNestingLevel(target);</span><br>      383-&gt;N:  <span style="background-color: white">              </span><br>    384-&gt;341:  <span style="background-color: cyan"> 99+          for (Styleable styleable : children) {</span><br>    385-&gt;342:  <span style="background-color: cyan"> 99+              if (matchesTableLevel(target, styleable.getStyle().getIdent(CSSName.DISPLAY))) {</span><br>    386-&gt;343:  <span style="background-color: cyan"> 99+                  childrenForAnonymous.add(styleable);</span><br>      387-&gt;N:  <span style="background-color: white">                  } else {</span><br>    388-&gt;345:  <span style="background-color: cyan"> 99+                  if (childrenForAnonymous.size() &gt; 0) {</span><br>    389-&gt;346:  <span style="background-color: cyan">  23                      createAnonymousTableContent(c, (BlockBox) childrenForAnonymous.get(0), nextUp,</span><br>    390-&gt;347:  <span style="background-color: white">                                  childrenForAnonymous, childrenWithAnonymous);</span><br>      391-&gt;N:  <span style="background-color: white">      </span><br>    392-&gt;349:  <span style="background-color: cyan">  23                      childrenForAnonymous = new ArrayList&lt;&gt;();</span><br>      393-&gt;N:  <span style="background-color: white">                      }</span><br>    394-&gt;351:  <span style="background-color: cyan"> 99+                  childrenWithAnonymous.add(styleable);</span><br>      395-&gt;N:  <span style="background-color: white">                  }</span><br>      396-&gt;N:  <span style="background-color: white">              }</span><br>      397-&gt;N:  <span style="background-color: white">      </span><br>    398-&gt;355:  <span style="background-color: cyan"> 99+          if (childrenForAnonymous.size() &gt; 0) {</span><br>    399-&gt;356:  <span style="background-color: cyan"> 99+              createAnonymousTableContent(c, (BlockBox) childrenForAnonymous.get(0), nextUp,</span><br>    400-&gt;357:  <span style="background-color: white">                          childrenForAnonymous, childrenWithAnonymous);</span><br>      401-&gt;N:  <span style="background-color: white">              }</span><br>      402-&gt;N:  <span style="background-color: white">      </span><br>    403-&gt;360:  <span style="background-color: cyan"> 99+          if (nextUp == IdentValue.TABLE) {</span><br>    404-&gt;361:  <span style="background-color: cyan"> 99+              rebalanceInlineContent(childrenWithAnonymous);</span><br>    405-&gt;362:  <span style="background-color: cyan"> 99+              info.setContainsBlockLevelContent(true);</span><br>    406-&gt;363:  <span style="background-color: cyan"> 99+              resolveChildren(c, parent, childrenWithAnonymous, info);</span><br>      407-&gt;N:  <span style="background-color: white">              } else {</span><br>    408-&gt;365:  <span style="background-color: cyan"> 99+              resolveChildTableContent(c, parent, childrenWithAnonymous, info, nextUp);</span><br>      409-&gt;N:  <span style="background-color: white">              }</span><br>      410-&gt;N:  <span style="background-color: white">          }</span><br>      411-&gt;N:  <span style="background-color: white">      </span><br>    412-&gt;369:  <span style="background-color: cyan"> 99+      private static boolean matchesTableLevel(IdentValue target, IdentValue value) {</span><br>    413-&gt;370:  <span style="background-color: cyan"> 99+          if (target == IdentValue.TABLE_ROW_GROUP) {</span><br>    414-&gt;371:  <span style="background-color: cyan"> 99+              return value == IdentValue.TABLE_ROW_GROUP || value == IdentValue.TABLE_HEADER_GROUP</span><br>    415-&gt;372:  <span style="background-color: white">                          || value == IdentValue.TABLE_FOOTER_GROUP || value == IdentValue.TABLE_CAPTION;</span><br>      416-&gt;N:  <span style="background-color: white">              } else {</span><br>    417-&gt;374:  <span style="background-color: cyan"> 99+              return target == value;</span><br>      418-&gt;N:  <span style="background-color: white">              }</span><br>      419-&gt;N:  <span style="background-color: white">          }</span><br>      420-&gt;N:  <span style="background-color: white">      </span><br>      421-&gt;N:  <span style="background-color: white">          /**</span><br>      422-&gt;N:  <span style="background-color: white">           * Makes sure that any <code>InlineBox</code> in <code>content</code></span><br>      423-&gt;N:  <span style="background-color: white">           * both starts and ends within <code>content</code>. Used to ensure that</span><br>      424-&gt;N:  <span style="background-color: white">           * it is always possible to construct anonymous blocks once an element's</span><br>      425-&gt;N:  <span style="background-color: white">           * children has been distributed among anonymous table objects.</span><br>      426-&gt;N:  <span style="background-color: white">           */</span><br>    427-&gt;384:  <span style="background-color: cyan"> 99+      private static void rebalanceInlineContent(List
       <styleable>
         content) {
       </styleable></span><br>    428-&gt;385:  <span style="background-color: cyan"> 99+          Map
       <element, inlinebox>
         boxesByElement = new HashMap&lt;&gt;();
       </element,></span><br>    429-&gt;386:  <span style="background-color: cyan"> 99+          for (Styleable styleable : content) {</span><br>    430-&gt;387:  <span style="background-color: cyan"> 99+              if (styleable instanceof InlineBox) {</span><br>    431-&gt;388:  <span style="background-color: cyan"> 99+                  InlineBox iB = (InlineBox) styleable;</span><br>    432-&gt;389:  <span style="background-color: cyan"> 99+                  Element elem = iB.getElement();</span><br>      433-&gt;N:  <span style="background-color: white">      </span><br>    434-&gt;391:  <span style="background-color: cyan"> 99+                  if (!boxesByElement.containsKey(elem)) {</span><br>    435-&gt;392:  <span style="background-color: cyan"> 99+                      iB.setStartsHere(true);</span><br>      436-&gt;N:  <span style="background-color: white">                      }</span><br>      437-&gt;N:  <span style="background-color: white">      </span><br>    438-&gt;395:  <span style="background-color: cyan"> 99+                  boxesByElement.put(elem, iB);</span><br>      439-&gt;N:  <span style="background-color: white">                  }</span><br>      440-&gt;N:  <span style="background-color: white">              }</span><br>      441-&gt;N:  <span style="background-color: white">      </span><br>    442-&gt;399:  <span style="background-color: cyan"> 99+          for (InlineBox iB : boxesByElement.values()) {</span><br>    443-&gt;400:  <span style="background-color: cyan"> 99+              iB.setEndsHere(true);</span><br>      444-&gt;N:  <span style="background-color: white">              }</span><br>      445-&gt;N:  <span style="background-color: white">          }</span><br>      446-&gt;N:  <span style="background-color: white">      </span><br>    447-&gt;404:  <span style="background-color: cyan"> 99+      private static void stripAllWhitespace(List
       <styleable>
         content) {
       </styleable></span><br>    448-&gt;405:  <span style="background-color: cyan"> 99+          int start = 0;</span><br>    449-&gt;406:  <span style="background-color: cyan"> 99+          int current = 0;</span><br>    450-&gt;407:  <span style="background-color: cyan"> 99+          boolean started = false;</span><br>    451-&gt;408:  <span style="background-color: cyan"> 99+          for (current = 0; current &lt; content.size(); current++) {</span><br>    452-&gt;409:  <span style="background-color: cyan"> 99+              Styleable styleable = content.get(current);</span><br>    453-&gt;410:  <span style="background-color: cyan"> 99+              if (! styleable.getStyle().isLayedOutInInlineContext()) {</span><br>    454-&gt;411:  <span style="background-color: cyan"> 99+                  if (started) {</span><br>    455-&gt;412:  <span style="background-color: cyan"> 99+                      int before = content.size();</span><br>    456-&gt;413:  <span style="background-color: cyan"> 99+                      WhitespaceStripper.stripInlineContent(content.subList(start, current));</span><br>    457-&gt;414:  <span style="background-color: cyan"> 99+                      int after = content.size();</span><br>    458-&gt;415:  <span style="background-color: cyan"> 99+                      current -= (before - after);</span><br>      459-&gt;N:  <span style="background-color: white">                      }</span><br>    460-&gt;417:  <span style="background-color: cyan"> 99+                  started = false;</span><br>      461-&gt;N:  <span style="background-color: white">                  } else {</span><br>    462-&gt;419:  <span style="background-color: cyan"> 99+                  if (! started) {</span><br>    463-&gt;420:  <span style="background-color: cyan"> 99+                      started = true;</span><br>    464-&gt;421:  <span style="background-color: cyan"> 99+                      start = current;</span><br>      465-&gt;N:  <span style="background-color: white">                      }</span><br>      466-&gt;N:  <span style="background-color: white">                  }</span><br>      467-&gt;N:  <span style="background-color: white">              }</span><br>      468-&gt;N:  <span style="background-color: white">      </span><br>    469-&gt;426:  <span style="background-color: cyan"> 99+          if (started) {</span><br>    470-&gt;427:  <span style="background-color: cyan"> 99+              WhitespaceStripper.stripInlineContent(content.subList(start, current));</span><br>      471-&gt;N:  <span style="background-color: white">              }</span><br>      472-&gt;N:  <span style="background-color: white">          }</span><br>      473-&gt;N:  <span style="background-color: white">      </span><br>      474-&gt;N:  <span style="background-color: white">          /**</span><br>      475-&gt;N:  <span style="background-color: white">           * Handles the situation when our current parent is table related.  If</span><br>      476-&gt;N:  <span style="background-color: white">           * everything is properly nested (e.g. a <code>tr</code> contains only</span><br>      477-&gt;N:  <span style="background-color: white">           * <code>td</code> elements), nothing is done.  Otherwise anonymous boxes</span><br>      478-&gt;N:  <span style="background-color: white">           * are inserted to ensure the integrity of the table model.</span><br>      479-&gt;N:  <span style="background-color: white">           */</span><br>    480-&gt;437:  <span style="background-color: cyan"> 99+      private static void resolveTableContent(</span><br>    481-&gt;438:  <span style="background-color: white">                  LayoutContext c, BlockBox parent, List
       <styleable>
         children, ChildBoxInfo info) {
       </styleable></span><br>    482-&gt;439:  <span style="background-color: cyan"> 99+          IdentValue parentDisplay = parent.getStyle().getIdent(CSSName.DISPLAY);</span><br>    483-&gt;440:  <span style="background-color: cyan"> 99+          IdentValue next = getNextTableNestingLevel(parentDisplay);</span><br>    484-&gt;441:  <span style="background-color: cyan"> 99+          if (next == null &amp;&amp; parent.isAnonymous() &amp;&amp; containsOrphanedTableContent(children)) {</span><br>    485-&gt;442:  <span style="background-color: white">  10              resolveChildTableContent(c, parent, children, info, IdentValue.TABLE_CELL);</span><br>    486-&gt;443:  <span style="background-color: cyan"> 99+          } else if (next == null || isAllProperTableNesting(parentDisplay, children)) {</span><br>    487-&gt;444:  <span style="background-color: cyan"> 99+              if (parent.isAnonymous()) {</span><br>    488-&gt;445:  <span style="background-color: cyan"> 99+                  rebalanceInlineContent(children);</span><br>      489-&gt;N:  <span style="background-color: white">                  }</span><br>    490-&gt;447:  <span style="background-color: cyan"> 99+              resolveChildren(c, parent, children, info);</span><br>      491-&gt;N:  <span style="background-color: white">              } else {</span><br>    492-&gt;449:  <span style="background-color: cyan"> 99+              List
       <styleable>
         childrenForAnonymous = new ArrayList&lt;&gt;();
       </styleable></span><br>    493-&gt;450:  <span style="background-color: cyan"> 99+              List
       <styleable>
         childrenWithAnonymous = new ArrayList&lt;&gt;();
       </styleable></span><br>      494-&gt;N:  <span style="background-color: white">                  </span><br>    495-&gt;452:  <span style="background-color: cyan"> 99+              for (Styleable child : children) {</span><br>    496-&gt;453:  <span style="background-color: cyan"> 99+                  IdentValue childDisplay = child.getStyle().getIdent(CSSName.DISPLAY);</span><br>      497-&gt;N:  <span style="background-color: white">      </span><br>    498-&gt;455:  <span style="background-color: cyan"> 99+                  if (isProperTableNesting(parentDisplay, childDisplay)) {</span><br>    499-&gt;456:  <span style="background-color: cyan">  57                      if (childrenForAnonymous.size() &gt; 0) {</span><br>    500-&gt;457:  <span style="background-color: white">  36                          createAnonymousTableContent(c, parent, next, childrenForAnonymous,</span><br>    501-&gt;458:  <span style="background-color: white">                                      childrenWithAnonymous);</span><br>      502-&gt;N:  <span style="background-color: white">      </span><br>    503-&gt;460:  <span style="background-color: white">  36                          childrenForAnonymous = new ArrayList&lt;&gt;();</span><br>      504-&gt;N:  <span style="background-color: white">                          }</span><br>    505-&gt;462:  <span style="background-color: cyan">  57                      childrenWithAnonymous.add(child);</span><br>      506-&gt;N:  <span style="background-color: white">                      } else {</span><br>    507-&gt;464:  <span style="background-color: cyan"> 99+                      childrenForAnonymous.add(child);</span><br>      508-&gt;N:  <span style="background-color: white">                      }</span><br>      509-&gt;N:  <span style="background-color: white">                  }</span><br>      510-&gt;N:  <span style="background-color: white">      </span><br>    511-&gt;468:  <span style="background-color: cyan"> 99+              if (childrenForAnonymous.size() &gt; 0) {</span><br>    512-&gt;469:  <span style="background-color: cyan"> 99+                  createAnonymousTableContent(c, parent, next, childrenForAnonymous,</span><br>    513-&gt;470:  <span style="background-color: white">                              childrenWithAnonymous);</span><br>      514-&gt;N:  <span style="background-color: white">                  }</span><br>      515-&gt;N:  <span style="background-color: white">      </span><br>    516-&gt;473:  <span style="background-color: cyan"> 99+              info.setContainsBlockLevelContent(true);</span><br>    517-&gt;474:  <span style="background-color: cyan"> 99+              resolveChildren(c, parent, childrenWithAnonymous, info);</span><br>      518-&gt;N:  <span style="background-color: white">              }</span><br>      519-&gt;N:  <span style="background-color: white">          }</span><br>      520-&gt;N:  <span style="background-color: white">          </span><br>    521-&gt;478:  <span style="background-color: white">  70      private static boolean isTableRowOrRowGroup(Styleable child) {</span><br>    522-&gt;479:  <span style="background-color: white">  70          IdentValue display = child.getStyle().getIdent(CSSName.DISPLAY);</span><br>    523-&gt;480:  <span style="background-color: white">  70          return (display == IdentValue.TABLE_HEADER_GROUP ||</span><br>    524-&gt;481:  <span style="background-color: white">                      display == IdentValue.TABLE_ROW_GROUP ||</span><br>    525-&gt;482:  <span style="background-color: white">                      display == IdentValue.TABLE_FOOTER_GROUP ||</span><br>    526-&gt;483:  <span style="background-color: white">                      display == IdentValue.TABLE_ROW);</span><br>      527-&gt;N:  <span style="background-color: white">          }</span><br>      528-&gt;N:  <span style="background-color: white">      </span><br>    529-&gt;486:  <span style="background-color: white">  70      private static boolean containsOrphanedTableContent(List
       <styleable>
         children) {
       </styleable></span><br>    530-&gt;487:  <span style="background-color: white">  70          return children.stream().anyMatch(BoxBuilder::isTableRowOrRowGroup);</span><br>      531-&gt;N:  <span style="background-color: white">          }</span><br>      532-&gt;N:  <span style="background-color: white">      </span><br>    533-&gt;490:  <span style="background-color: cyan"> 99+      private static boolean isParentInline(BlockBox box) {</span><br>    534-&gt;491:  <span style="background-color: cyan"> 99+          CalculatedStyle parentStyle = box.getStyle().getParent();</span><br>    535-&gt;492:  <span style="background-color: cyan"> 99+          return parentStyle != null &amp;&amp; parentStyle.isInline();</span><br>      536-&gt;N:  <span style="background-color: white">          }</span><br>      537-&gt;N:  <span style="background-color: white">      </span><br>    538-&gt;495:  <span style="background-color: cyan"> 99+      private static void createAnonymousTableContent(LayoutContext c, BlockBox source,</span><br>    539-&gt;496:  <span style="background-color: white">                                                          IdentValue next, List
       <styleable>
         childrenForAnonymous, List
        <styleable>
          childrenWithAnonymous) {
        </styleable>
       </styleable></span><br>    540-&gt;497:  <span style="background-color: cyan"> 99+          ChildBoxInfo nested = lookForBlockContent(childrenForAnonymous);</span><br>    541-&gt;498:  <span style="background-color: cyan"> 99+          IdentValue anonDisplay;</span><br>    542-&gt;499:  <span style="background-color: cyan"> 99+          if (isParentInline(source) &amp;&amp; next == IdentValue.TABLE) {</span><br>    543-&gt;500:  <span style="background-color: white">   0              anonDisplay = IdentValue.INLINE_TABLE;</span><br>      544-&gt;N:  <span style="background-color: white">              } else {</span><br>    545-&gt;502:  <span style="background-color: cyan"> 99+              anonDisplay = next;</span><br>      546-&gt;N:  <span style="background-color: white">              }</span><br>    547-&gt;504:  <span style="background-color: cyan"> 99+          CalculatedStyle anonStyle = source.getStyle().createAnonymousStyle(anonDisplay);</span><br>    548-&gt;505:  <span style="background-color: cyan"> 99+          BlockBox anonBox = createBlockBox(anonStyle, nested, false);</span><br>    549-&gt;506:  <span style="background-color: cyan"> 99+          anonBox.setStyle(anonStyle);</span><br>    550-&gt;507:  <span style="background-color: cyan"> 99+          anonBox.setAnonymous(true);</span><br>      551-&gt;N:  <span style="background-color: white">              // XXX Doesn't really make sense, but what to do?</span><br>    552-&gt;509:  <span style="background-color: cyan"> 99+          anonBox.setElement(source.getElement());</span><br>    553-&gt;510:  <span style="background-color: cyan"> 99+          resolveTableContent(c, anonBox, childrenForAnonymous, nested);</span><br>      554-&gt;N:  <span style="background-color: white">      </span><br>    555-&gt;512:  <span style="background-color: cyan"> 99+          if (next == IdentValue.TABLE) {</span><br>    556-&gt;513:  <span style="background-color: cyan">  86              childrenWithAnonymous.add(reorderTableContent(c, (TableBox) anonBox));</span><br>      557-&gt;N:  <span style="background-color: white">              } else {</span><br>    558-&gt;515:  <span style="background-color: cyan"> 99+              childrenWithAnonymous.add(anonBox);</span><br>      559-&gt;N:  <span style="background-color: white">              }</span><br>      560-&gt;N:  <span style="background-color: white">          }</span><br>      561-&gt;N:  <span style="background-color: white">      </span><br>      562-&gt;N:  <span style="background-color: white">          /**</span><br>      563-&gt;N:  <span style="background-color: white">           * Reorganizes a table so that the header is the first row group and the</span><br>      564-&gt;N:  <span style="background-color: white">           * footer the last.  If the table has caption boxes, they will be pulled</span><br>      565-&gt;N:  <span style="background-color: white">           * out and added to an anonymous block box along with the table itself.</span><br>      566-&gt;N:  <span style="background-color: white">           * If not, the table is returned.</span><br>      567-&gt;N:  <span style="background-color: white">           */</span><br>    568-&gt;525:  <span style="background-color: cyan"> 99+      private static BlockBox reorderTableContent(LayoutContext c, TableBox table) {</span><br>    569-&gt;526:  <span style="background-color: cyan"> 99+          List
       <box>
         topCaptions = new ArrayList&lt;&gt;();
       </box></span><br>    570-&gt;527:  <span style="background-color: cyan"> 99+          Box header = null;</span><br>    571-&gt;528:  <span style="background-color: cyan"> 99+          List
       <box>
         bodies = new ArrayList&lt;&gt;();
       </box></span><br>    572-&gt;529:  <span style="background-color: cyan"> 99+          Box footer = null;</span><br>    573-&gt;530:  <span style="background-color: cyan"> 99+          List
       <box>
         bottomCaptions = new ArrayList&lt;&gt;();
       </box></span><br>      574-&gt;N:  <span style="background-color: white">      </span><br>    575-&gt;532:  <span style="background-color: cyan"> 99+          for (Box b : table.getChildren()) {</span><br>    576-&gt;533:  <span style="background-color: cyan"> 99+              IdentValue display = b.getStyle().getIdent(CSSName.DISPLAY);</span><br>      577-&gt;N:  <span style="background-color: white">                  </span><br>    578-&gt;535:  <span style="background-color: cyan"> 99+              if (display == IdentValue.TABLE_CAPTION) {</span><br>    579-&gt;536:  <span style="background-color: cyan">   7                  IdentValue side = b.getStyle().getIdent(CSSName.CAPTION_SIDE);</span><br>    580-&gt;537:  <span style="background-color: cyan">   7                  if (side == IdentValue.BOTTOM) {</span><br>    581-&gt;538:  <span style="background-color: white">   0                      bottomCaptions.add(b);</span><br>      582-&gt;N:  <span style="background-color: white">                      } else { /* side == IdentValue.TOP */</span><br>    583-&gt;540:  <span style="background-color: cyan">   7                      topCaptions.add(b);</span><br>      584-&gt;N:  <span style="background-color: white">                      }</span><br>    585-&gt;542:  <span style="background-color: cyan"> 99+              } else if (display == IdentValue.TABLE_HEADER_GROUP &amp;&amp; header == null) {</span><br>    586-&gt;543:  <span style="background-color: cyan">  78                  header = b;</span><br>    587-&gt;544:  <span style="background-color: cyan"> 99+              } else if (display == IdentValue.TABLE_FOOTER_GROUP &amp;&amp; footer == null) {</span><br>    588-&gt;545:  <span style="background-color: cyan">  10                  footer = b;</span><br>      589-&gt;N:  <span style="background-color: white">                  } else {</span><br>    590-&gt;547:  <span style="background-color: cyan"> 99+                  bodies.add(b);</span><br>      591-&gt;N:  <span style="background-color: white">                  }</span><br>      592-&gt;N:  <span style="background-color: white">              }</span><br>      593-&gt;N:  <span style="background-color: white">      </span><br>    594-&gt;551:  <span style="background-color: cyan"> 99+          table.removeAllChildren();</span><br>    595-&gt;552:  <span style="background-color: cyan"> 99+          if (header != null) {</span><br>    596-&gt;553:  <span style="background-color: cyan">  78              ((TableSectionBox)header).setHeader(true);</span><br>    597-&gt;554:  <span style="background-color: cyan">  78              table.addChild(header);</span><br>      598-&gt;N:  <span style="background-color: white">              }</span><br>    599-&gt;556:  <span style="background-color: cyan"> 99+          table.addAllChildren(bodies);</span><br>    600-&gt;557:  <span style="background-color: cyan"> 99+          if (footer != null) {</span><br>    601-&gt;558:  <span style="background-color: cyan">  10              ((TableSectionBox)footer).setFooter(true);</span><br>    602-&gt;559:  <span style="background-color: cyan">  10              table.addChild(footer);</span><br>      603-&gt;N:  <span style="background-color: white">              }</span><br>      604-&gt;N:  <span style="background-color: white">      </span><br>    605-&gt;562:  <span style="background-color: cyan"> 99+          if (topCaptions.size() == 0 &amp;&amp; bottomCaptions.size() == 0) {</span><br>    606-&gt;563:  <span style="background-color: cyan"> 99+              return table;</span><br>      607-&gt;N:  <span style="background-color: white">              } else {</span><br>      608-&gt;N:  <span style="background-color: white">                  // If we have a floated table with a caption, we need to float the</span><br>      609-&gt;N:  <span style="background-color: white">                  // outer anonymous box and not the table</span><br>    610-&gt;567:  <span style="background-color: cyan">   7              CalculatedStyle anonStyle;</span><br>    611-&gt;568:  <span style="background-color: cyan">   7              if (table.getStyle().isFloated()) {</span><br>    612-&gt;569:  <span style="background-color: white">   0                  CascadedStyle cascadedStyle = CascadedStyle.createLayoutStyle(</span><br>      613-&gt;N:  <span style="background-color: white">                              new PropertyDeclaration[]{</span><br>    614-&gt;571:  <span style="background-color: white">                                      CascadedStyle.createLayoutPropertyDeclaration(</span><br>    615-&gt;572:  <span style="background-color: white">                                              CSSName.DISPLAY, IdentValue.BLOCK),</span><br>    616-&gt;573:  <span style="background-color: white">                                      CascadedStyle.createLayoutPropertyDeclaration(</span><br>    617-&gt;574:  <span style="background-color: white">                                              CSSName.FLOAT, table.getStyle().getIdent(CSSName.FLOAT))});</span><br>      618-&gt;N:  <span style="background-color: white">      </span><br>    619-&gt;576:  <span style="background-color: white">   0                  anonStyle = table.getStyle().deriveStyle(cascadedStyle);</span><br>      620-&gt;N:  <span style="background-color: white">                  } else {</span><br>    621-&gt;578:  <span style="background-color: cyan">   7                  anonStyle = table.getStyle().createAnonymousStyle(IdentValue.BLOCK);</span><br>      622-&gt;N:  <span style="background-color: white">                  }</span><br>      623-&gt;N:  <span style="background-color: white">      </span><br>    624-&gt;581:  <span style="background-color: cyan">   7              BlockBox anonBox = new BlockBox();</span><br>    625-&gt;582:  <span style="background-color: cyan">   7              anonBox.setStyle(anonStyle);</span><br>    626-&gt;583:  <span style="background-color: cyan">   7              anonBox.setAnonymous(true);</span><br>    627-&gt;584:  <span style="background-color: cyan">   7              anonBox.setFromCaptionedTable(true);</span><br>    628-&gt;585:  <span style="background-color: cyan">   7              anonBox.setElement(table.getElement());</span><br>      629-&gt;N:  <span style="background-color: white">      </span><br>      630-&gt;U:  <span style="background-color: yellow">   7              anonBox.setChildrenContentType(BlockBox.ContentType.BLOCK);</span><br>    631-&gt;588:  <span style="background-color: cyan">   7              anonBox.addAllChildren(topCaptions);</span><br>    632-&gt;589:  <span style="background-color: cyan">   7              anonBox.addChild(table);</span><br>    633-&gt;590:  <span style="background-color: cyan">   7              anonBox.addAllChildren(bottomCaptions);</span><br>      634-&gt;N:  <span style="background-color: white">      </span><br>    635-&gt;592:  <span style="background-color: cyan">   7              if (table.getStyle().isFloated()) {</span><br>    636-&gt;593:  <span style="background-color: white">   0                  anonBox.setFloatedBoxData(new FloatedBoxData());</span><br>    637-&gt;594:  <span style="background-color: white">   0                  table.setFloatedBoxData(null);</span><br>      638-&gt;N:  <span style="background-color: white">      </span><br>    639-&gt;596:  <span style="background-color: white">   0                  CascadedStyle original = c.getSharedContext().getCss().getCascadedStyle(</span><br>    640-&gt;597:  <span style="background-color: white">                              table.getElement(), false);</span><br>    641-&gt;598:  <span style="background-color: white">   0                  CascadedStyle modified = CascadedStyle.createLayoutStyle(</span><br>    642-&gt;599:  <span style="background-color: white">                              original,</span><br>      643-&gt;N:  <span style="background-color: white">                              new PropertyDeclaration[]{</span><br>    644-&gt;601:  <span style="background-color: white">                                      CascadedStyle.createLayoutPropertyDeclaration(</span><br>    645-&gt;602:  <span style="background-color: white">                                              CSSName.FLOAT, IdentValue.NONE)</span><br>      646-&gt;N:  <span style="background-color: white">                              });</span><br>    647-&gt;604:  <span style="background-color: white">   0                  table.setStyle(table.getStyle().getParent().deriveStyle(modified));</span><br>      648-&gt;N:  <span style="background-color: white">                  }</span><br>      649-&gt;N:  <span style="background-color: white">      </span><br>    650-&gt;607:  <span style="background-color: cyan">   7              return anonBox;</span><br>      651-&gt;N:  <span style="background-color: white">              }</span><br>      652-&gt;N:  <span style="background-color: white">          }</span><br>      653-&gt;N:  <span style="background-color: white">      </span><br>    654-&gt;611:  <span style="background-color: cyan"> 99+      private static ChildBoxInfo lookForBlockContent(List
       <styleable>
         styleables) {
       </styleable></span><br>    655-&gt;612:  <span style="background-color: cyan"> 99+          ChildBoxInfo result = new ChildBoxInfo();</span><br>      656-&gt;N:  <span style="background-color: white">              </span><br>    657-&gt;614:  <span style="background-color: cyan"> 99+          if (styleables.stream().anyMatch(s -&gt; !s.getStyle().isLayedOutInInlineContext())) {</span><br>    658-&gt;615:  <span style="background-color: cyan"> 99+              result.setContainsBlockLevelContent(true);</span><br>      659-&gt;N:  <span style="background-color: white">              }</span><br>      660-&gt;N:  <span style="background-color: white">              </span><br>    661-&gt;618:  <span style="background-color: cyan"> 99+          return result;</span><br>      662-&gt;N:  <span style="background-color: white">          }</span><br>      663-&gt;N:  <span style="background-color: white">      </span><br>    664-&gt;621:  <span style="background-color: cyan"> 99+      private static IdentValue getNextTableNestingLevel(IdentValue display) {</span><br>    665-&gt;622:  <span style="background-color: cyan"> 99+          if (display == IdentValue.TABLE || display == IdentValue.INLINE_TABLE) {</span><br>      666-&gt;N:  <span style="background-color: white"> 99+              return IdentValue.TABLE_ROW_GROUP;</span><br>    667-&gt;624:  <span style="background-color: cyan"> 99+          } else if (display == IdentValue.TABLE_HEADER_GROUP</span><br>    668-&gt;625:  <span style="background-color: white">                      || display == IdentValue.TABLE_ROW_GROUP</span><br>    669-&gt;626:  <span style="background-color: white">                      || display == IdentValue.TABLE_FOOTER_GROUP) {</span><br>      670-&gt;N:  <span style="background-color: white"> 99+              return IdentValue.TABLE_ROW;</span><br>    671-&gt;628:  <span style="background-color: cyan"> 99+          } else if (display == IdentValue.TABLE_ROW) {</span><br>      672-&gt;N:  <span style="background-color: white"> 99+              return IdentValue.TABLE_CELL;</span><br>      673-&gt;N:  <span style="background-color: white">              } else {</span><br>    674-&gt;631:  <span style="background-color: white">  70              return null;</span><br>      675-&gt;N:  <span style="background-color: white">              }</span><br>      676-&gt;N:  <span style="background-color: white">          }</span><br>      677-&gt;N:  <span style="background-color: white">      </span><br>    678-&gt;635:  <span style="background-color: cyan"> 99+      private static IdentValue getPreviousTableNestingLevel(IdentValue display) {</span><br>    679-&gt;636:  <span style="background-color: cyan"> 99+          if (display == IdentValue.TABLE_CELL) {</span><br>      680-&gt;N:  <span style="background-color: white"> 99+              return IdentValue.TABLE_ROW;</span><br>    681-&gt;638:  <span style="background-color: cyan"> 99+          } else if (display == IdentValue.TABLE_ROW) {</span><br>      682-&gt;N:  <span style="background-color: white"> 99+              return IdentValue.TABLE_ROW_GROUP;</span><br>    683-&gt;640:  <span style="background-color: cyan"> 99+          } else if (display == IdentValue.TABLE_HEADER_GROUP</span><br>    684-&gt;641:  <span style="background-color: white">                      || display == IdentValue.TABLE_ROW_GROUP</span><br>    685-&gt;642:  <span style="background-color: white">                      || display == IdentValue.TABLE_FOOTER_GROUP) {</span><br>      686-&gt;N:  <span style="background-color: white"> 99+              return IdentValue.TABLE;</span><br>      687-&gt;N:  <span style="background-color: white">              } else {</span><br>    688-&gt;645:  <span style="background-color: white">   0              return null;</span><br>      689-&gt;N:  <span style="background-color: white">              }</span><br>      690-&gt;N:  <span style="background-color: white">          }</span><br>      691-&gt;N:  <span style="background-color: white">      </span><br>    692-&gt;649:  <span style="background-color: cyan"> 99+      private static boolean isProperTableNesting(IdentValue parent, IdentValue child) {</span><br>    693-&gt;650:  <span style="background-color: cyan"> 99+          return (parent == IdentValue.TABLE &amp;&amp; (child == IdentValue.TABLE_HEADER_GROUP ||</span><br>    694-&gt;651:  <span style="background-color: white">                      child == IdentValue.TABLE_ROW_GROUP ||</span><br>    695-&gt;652:  <span style="background-color: white">                      child == IdentValue.TABLE_FOOTER_GROUP ||</span><br>    696-&gt;653:  <span style="background-color: white">                      child == IdentValue.TABLE_CAPTION))</span><br>    697-&gt;654:  <span style="background-color: white">                      || ((parent == IdentValue.TABLE_HEADER_GROUP ||</span><br>    698-&gt;655:  <span style="background-color: white">                      parent == IdentValue.TABLE_ROW_GROUP ||</span><br>    699-&gt;656:  <span style="background-color: white">                      parent == IdentValue.TABLE_FOOTER_GROUP) &amp;&amp;</span><br>    700-&gt;657:  <span style="background-color: white">                      child == IdentValue.TABLE_ROW)</span><br>    701-&gt;658:  <span style="background-color: white">                      || (parent == IdentValue.TABLE_ROW &amp;&amp; child == IdentValue.TABLE_CELL)</span><br>    702-&gt;659:  <span style="background-color: white">                      || (parent == IdentValue.INLINE_TABLE &amp;&amp; (child == IdentValue.TABLE_HEADER_GROUP ||</span><br>    703-&gt;660:  <span style="background-color: white">                      child == IdentValue.TABLE_ROW_GROUP ||</span><br>    704-&gt;661:  <span style="background-color: white">                      child == IdentValue.TABLE_FOOTER_GROUP));</span><br>      705-&gt;N:  <span style="background-color: white">      </span><br>      706-&gt;N:  <span style="background-color: white">          }</span><br>      707-&gt;N:  <span style="background-color: white">      </span><br>    708-&gt;665:  <span style="background-color: cyan"> 99+      private static boolean isNestingTableContent(IdentValue display) {</span><br>    709-&gt;666:  <span style="background-color: cyan"> 99+          return display == IdentValue.TABLE || display == IdentValue.INLINE_TABLE ||</span><br>    710-&gt;667:  <span style="background-color: white">                      display == IdentValue.TABLE_HEADER_GROUP || display == IdentValue.TABLE_ROW_GROUP ||</span><br>    711-&gt;668:  <span style="background-color: white">                      display == IdentValue.TABLE_FOOTER_GROUP || display == IdentValue.TABLE_ROW;</span><br>      712-&gt;N:  <span style="background-color: white">          }</span><br>      713-&gt;N:  <span style="background-color: white">      </span><br>    714-&gt;671:  <span style="background-color: cyan"> 99+      private static boolean isAttrFunction(FSFunction function) {</span><br>    715-&gt;672:  <span style="background-color: cyan"> 99+          if (function.getName().equals("attr")) {</span><br>    716-&gt;673:  <span style="background-color: white">   8              List
       <propertyvalue>
         params = function.getParameters();
       </propertyvalue></span><br>    717-&gt;674:  <span style="background-color: white">   8              if (params.size() == 1) {</span><br>    718-&gt;675:  <span style="background-color: white">   8                  PropertyValue value = params.get(0);</span><br>    719-&gt;676:  <span style="background-color: white">   8                  return value.getPrimitiveType() == CSSPrimitiveValue.CSS_IDENT;</span><br>      720-&gt;N:  <span style="background-color: white">                  }</span><br>      721-&gt;N:  <span style="background-color: white">              }</span><br>      722-&gt;N:  <span style="background-color: white">      </span><br>    723-&gt;680:  <span style="background-color: cyan"> 99+          return false;</span><br>      724-&gt;N:  <span style="background-color: white">          }</span><br>      725-&gt;N:  <span style="background-color: white">      </span><br>    726-&gt;683:  <span style="background-color: cyan"> 99+      public static boolean isElementFunction(FSFunction function) {</span><br>    727-&gt;684:  <span style="background-color: cyan"> 99+          if (function.getName().equals("element")) {</span><br>    728-&gt;685:  <span style="background-color: cyan"> 99+              List
       <propertyvalue>
         params = function.getParameters();
       </propertyvalue></span><br>    729-&gt;686:  <span style="background-color: cyan"> 99+              if (params.size() &lt; 1 || params.size() &gt; 2) {</span><br>    730-&gt;687:  <span style="background-color: white">   0                  return false;</span><br>      731-&gt;N:  <span style="background-color: white">                  }</span><br>    732-&gt;689:  <span style="background-color: cyan"> 99+              boolean ok = true;</span><br>    733-&gt;690:  <span style="background-color: cyan"> 99+              PropertyValue value1 = params.get(0);</span><br>    734-&gt;691:  <span style="background-color: cyan"> 99+              ok = value1.getPrimitiveType() == CSSPrimitiveValue.CSS_IDENT;</span><br>    735-&gt;692:  <span style="background-color: cyan"> 99+              if (ok &amp;&amp; params.size() == 2) {</span><br>    736-&gt;693:  <span style="background-color: white">   0                  PropertyValue value2 = params.get(1);</span><br>    737-&gt;694:  <span style="background-color: white">   0                  ok = value2.getPrimitiveType() == CSSPrimitiveValue.CSS_IDENT;</span><br>      738-&gt;N:  <span style="background-color: white">                  }</span><br>      739-&gt;N:  <span style="background-color: white">      </span><br>    740-&gt;697:  <span style="background-color: cyan"> 99+              return ok;</span><br>      741-&gt;N:  <span style="background-color: white">              }</span><br>      742-&gt;N:  <span style="background-color: white">      </span><br>    743-&gt;700:  <span style="background-color: white">  86          return false;</span><br>      744-&gt;N:  <span style="background-color: white">          }</span><br>      745-&gt;N:  <span style="background-color: white">      </span><br>    746-&gt;703:  <span style="background-color: cyan"> 99+      private static CounterFunction makeCounterFunction(</span><br>    747-&gt;703:  <span style="background-color: red">                  FSFunction function, LayoutContext c, CalculatedStyle style) {</span><br>      748-&gt;N:  <span style="background-color: white">      </span><br>    749-&gt;704:  <span style="background-color: cyan"> 99+          if (function.getName().equals("counter")) {</span><br>    750-&gt;705:  <span style="background-color: cyan"> 99+              List
       <propertyvalue>
         params = function.getParameters();
       </propertyvalue></span><br>    751-&gt;706:  <span style="background-color: cyan"> 99+              if (params.size() &lt; 1 || params.size() &gt; 2) {</span><br>    752-&gt;707:  <span style="background-color: white">   0                  return null;</span><br>      753-&gt;N:  <span style="background-color: white">                  }</span><br>      754-&gt;N:  <span style="background-color: white">      </span><br>    755-&gt;710:  <span style="background-color: cyan"> 99+              PropertyValue value = params.get(0);</span><br>    756-&gt;711:  <span style="background-color: cyan"> 99+              if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_IDENT) {</span><br>    757-&gt;712:  <span style="background-color: white">   0                  return null;</span><br>      758-&gt;N:  <span style="background-color: white">                  }</span><br>      759-&gt;N:  <span style="background-color: white">      </span><br>    760-&gt;715:  <span style="background-color: cyan"> 99+              String s = value.getStringValue();</span><br>      761-&gt;N:  <span style="background-color: white">                  // counter(page) and counter(pages) are handled separately</span><br>    762-&gt;717:  <span style="background-color: cyan"> 99+              if (s.equals("page") || s.equals("pages")) {</span><br>    763-&gt;718:  <span style="background-color: white"> 99+                  return null;</span><br>      764-&gt;N:  <span style="background-color: white">                  }</span><br>      765-&gt;N:  <span style="background-color: white">      </span><br>    766-&gt;721:  <span style="background-color: cyan">  90              String counter = value.getStringValue();</span><br>    767-&gt;722:  <span style="background-color: cyan">  90              IdentValue listStyleType = IdentValue.DECIMAL;</span><br>    768-&gt;723:  <span style="background-color: cyan">  90              if (params.size() == 2) {</span><br>    769-&gt;724:  <span style="background-color: white">   0                  value = params.get(1);</span><br>    770-&gt;725:  <span style="background-color: white">   0                  if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_IDENT) {</span><br>    771-&gt;726:  <span style="background-color: white">   0                      return null;</span><br>      772-&gt;N:  <span style="background-color: white">                      }</span><br>      773-&gt;N:  <span style="background-color: white">      </span><br>    774-&gt;729:  <span style="background-color: white">   0                  IdentValue identValue = IdentValue.valueOf(value.getStringValue());</span><br>    775-&gt;730:  <span style="background-color: white">   0                  if (identValue != null) {</span><br>    776-&gt;731:  <span style="background-color: white">   0                      value.setIdentValue(identValue);</span><br>    777-&gt;732:  <span style="background-color: white">   0                      listStyleType = identValue;</span><br>      778-&gt;N:  <span style="background-color: white">                      }</span><br>      779-&gt;N:  <span style="background-color: white">                  }</span><br>      780-&gt;N:  <span style="background-color: white">      </span><br>      781-&gt;U:  <span style="background-color: yellow">  90              if ("footnote".equals(s)) {</span><br>      782-&gt;U:  <span style="background-color: yellow">  90                  RootCounterContext rootCc = c.getSharedContext().getGlobalCounterContext();</span><br>      783-&gt;U:  <span style="background-color: yellow">      </span><br>      784-&gt;U:  <span style="background-color: yellow">  90                  int counterValue = rootCc.getCurrentCounterValue(s);</span><br>      785-&gt;U:  <span style="background-color: yellow">  90                  return new CounterFunction(counterValue, listStyleType);</span><br>      786-&gt;U:  <span style="background-color: yellow">                  }</span><br>      787-&gt;N:  <span style="background-color: white">      </span><br>      788-&gt;U:  <span style="background-color: yellow">   0              AbstractCounterContext cc = c.getCounterContext(style);</span><br>      789-&gt;N:  <span style="background-color: white">      </span><br>      790-&gt;U:  <span style="background-color: yellow">   0              int counterValue = cc.getCurrentCounterValue(counter);</span><br>      791-&gt;N:  <span style="background-color: white">      </span><br>    792-&gt;738:  <span style="background-color: white">   0              return new CounterFunction(counterValue, listStyleType);</span><br>    793-&gt;739:  <span style="background-color: white">  16          } else if (function.getName().equals("counters")) {</span><br>    794-&gt;740:  <span style="background-color: white">   0              List
       <propertyvalue>
         params = function.getParameters();
       </propertyvalue></span><br>    795-&gt;741:  <span style="background-color: white">   0              if (params.size() &lt; 2 || params.size() &gt; 3) {</span><br>    796-&gt;742:  <span style="background-color: white">   0                  return null;</span><br>      797-&gt;N:  <span style="background-color: white">                  }</span><br>      798-&gt;N:  <span style="background-color: white">      </span><br>    799-&gt;745:  <span style="background-color: white">   0              PropertyValue value = params.get(0);</span><br>    800-&gt;746:  <span style="background-color: white">   0              if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_IDENT) {</span><br>    801-&gt;747:  <span style="background-color: white">   0                  return null;</span><br>      802-&gt;N:  <span style="background-color: white">                  }</span><br>      803-&gt;N:  <span style="background-color: white">      </span><br>    804-&gt;750:  <span style="background-color: white">   0              String counter = value.getStringValue();</span><br>      805-&gt;N:  <span style="background-color: white">      </span><br>    806-&gt;752:  <span style="background-color: white">   0              value = params.get(1);</span><br>    807-&gt;753:  <span style="background-color: white">   0              if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_STRING) {</span><br>    808-&gt;754:  <span style="background-color: white">   0                  return null;</span><br>      809-&gt;N:  <span style="background-color: white">                  }</span><br>      810-&gt;N:  <span style="background-color: white">      </span><br>    811-&gt;757:  <span style="background-color: white">   0              String separator = value.getStringValue();</span><br>      812-&gt;N:  <span style="background-color: white">      </span><br>    813-&gt;759:  <span style="background-color: white">   0              IdentValue listStyleType = IdentValue.DECIMAL;</span><br>    814-&gt;760:  <span style="background-color: white">   0              if (params.size() == 3) {</span><br>    815-&gt;761:  <span style="background-color: white">   0                  value = params.get(2);</span><br>    816-&gt;762:  <span style="background-color: white">   0                  if (value.getPrimitiveType() != CSSPrimitiveValue.CSS_IDENT) {</span><br>    817-&gt;763:  <span style="background-color: white">   0                      return null;</span><br>      818-&gt;N:  <span style="background-color: white">                      }</span><br>      819-&gt;N:  <span style="background-color: white">      </span><br>    820-&gt;766:  <span style="background-color: white">   0                  IdentValue identValue = IdentValue.valueOf(value.getStringValue());</span><br>    821-&gt;767:  <span style="background-color: white">   0                  if (identValue != null) {</span><br>    822-&gt;768:  <span style="background-color: white">   0                      value.setIdentValue(identValue);</span><br>    823-&gt;769:  <span style="background-color: white">   0                      listStyleType = identValue;</span><br>      824-&gt;N:  <span style="background-color: white">                      }</span><br>      825-&gt;N:  <span style="background-color: white">                  }</span><br>      826-&gt;N:  <span style="background-color: white">      </span><br>    827-&gt;773:  <span style="background-color: white">   0              List
       <integer>
         counterValues = c.getCounterContext(style).getCurrentCounterValues(counter);
       </integer></span><br>      828-&gt;N:  <span style="background-color: white">      </span><br>    829-&gt;775:  <span style="background-color: white">   0              return new CounterFunction(counterValues, separator, listStyleType);</span><br>      830-&gt;N:  <span style="background-color: white">              } else {</span><br>    831-&gt;777:  <span style="background-color: white">  16              return null;</span><br>      832-&gt;N:  <span style="background-color: white">              }</span><br>      833-&gt;N:  <span style="background-color: white">          }</span><br>      834-&gt;N:  <span style="background-color: white">      </span><br>    835-&gt;781:  <span style="background-color: white">   8      private static String getAttributeValue(FSFunction attrFunc, Element e) {</span><br>    836-&gt;782:  <span style="background-color: white">   8          PropertyValue value = attrFunc.getParameters().get(0);</span><br>    837-&gt;783:  <span style="background-color: white">   8          return e.getAttribute(value.getStringValue());</span><br>      838-&gt;N:  <span style="background-color: white">          }</span><br>      839-&gt;N:  <span style="background-color: white">      </span><br>    840-&gt;786:  <span style="background-color: cyan"> 99+      private static List
       <styleable>
         createGeneratedContentList(
       </styleable></span><br>      841-&gt;U:  <span style="background-color: yellow">                  LayoutContext c, Element element, List
       <propertyvalue>
         values,
       </propertyvalue></span><br>    842-&gt;788:  <span style="background-color: white">                  String peName, CalculatedStyle style, int mode, ChildBoxInfo info,</span><br>      843-&gt;U:  <span style="background-color: yellow">                  List
       <styleable>
         result) {
       </styleable></span><br>      844-&gt;N:  <span style="background-color: white">      </span><br>    845-&gt;798:  <span style="background-color: cyan"> 99+          for (PropertyValue value : values) {</span><br>    846-&gt;799:  <span style="background-color: cyan"> 99+              ContentFunction contentFunction = null;</span><br>    847-&gt;800:  <span style="background-color: cyan"> 99+              FSFunction function = null;</span><br>      848-&gt;N:  <span style="background-color: white">      </span><br>    849-&gt;802:  <span style="background-color: cyan"> 99+              String content = null;</span><br>      850-&gt;N:  <span style="background-color: white">      </span><br>    851-&gt;804:  <span style="background-color: cyan"> 99+              short type = value.getPrimitiveType();</span><br>    852-&gt;805:  <span style="background-color: cyan"> 99+              if (type == CSSPrimitiveValue.CSS_STRING) {</span><br>    853-&gt;806:  <span style="background-color: cyan"> 99+                  content = value.getStringValue();</span><br>    854-&gt;807:  <span style="background-color: cyan"> 99+              } else if (type == CSSPrimitiveValue.CSS_URI) {</span><br>    855-&gt;808:  <span style="background-color: cyan">  10                  Element creator = element != null ? element : c.getRootLayer().getMaster().getElement(); </span><br>      856-&gt;N:  <span style="background-color: white">      </span><br>    857-&gt;809:  <span style="background-color: cyan">  10                  Document doc = creator.getOwnerDocument();</span><br>    858-&gt;810:  <span style="background-color: cyan">  10                  Element img = doc.createElement("img");</span><br>      859-&gt;N:  <span style="background-color: white">      </span><br>    860-&gt;811:  <span style="background-color: cyan">  10                  img.setAttribute("src", value.getStringValue());</span><br>      861-&gt;N:  <span style="background-color: white">                      // So we don't recurse into the element and create a duplicate box.</span><br>      862-&gt;U:  <span style="background-color: yellow">  10                  img.setAttribute("fs-ignore", "true");</span><br>    863-&gt;812:  <span style="background-color: cyan">  10                  creator.appendChild(img);</span><br>      864-&gt;N:  <span style="background-color: white">      </span><br>      865-&gt;U:  <span style="background-color: yellow">  10                  CalculatedStyle anon = style.createAnonymousStyle(IdentValue.INLINE_BLOCK);</span><br>      866-&gt;N:  <span style="background-color: white">      </span><br>    867-&gt;814:  <span style="background-color: cyan">  10                  BlockBox iB = new BlockBox();</span><br>    868-&gt;815:  <span style="background-color: cyan">  10                  iB.setElement(img);</span><br>    869-&gt;817:  <span style="background-color: cyan">  10                  iB.setStyle(anon);</span><br>      870-&gt;U:  <span style="background-color: yellow">  10                  iB.setPseudoElementOrClass(peName);</span><br>      871-&gt;N:  <span style="background-color: white">      </span><br>    872-&gt;821:  <span style="background-color: cyan">  10                  result.add(iB);</span><br>    873-&gt;822:  <span style="background-color: cyan"> 99+              } else if (value.getPropertyValueType() == PropertyValue.VALUE_TYPE_FUNCTION) {</span><br>    874-&gt;823:  <span style="background-color: cyan"> 99+                  if (mode == CONTENT_LIST_DOCUMENT &amp;&amp; isAttrFunction(value.getFunction())) {</span><br>    875-&gt;824:  <span style="background-color: white">   8                      content = getAttributeValue(value.getFunction(), element);</span><br>      876-&gt;N:  <span style="background-color: white">                      } else {</span><br>    877-&gt;826:  <span style="background-color: cyan"> 99+                      CounterFunction cFunc = null;</span><br>      878-&gt;N:  <span style="background-color: white">      </span><br>    879-&gt;828:  <span style="background-color: cyan"> 99+                      if (mode == CONTENT_LIST_DOCUMENT) {</span><br>    880-&gt;829:  <span style="background-color: cyan"> 99+                          cFunc = makeCounterFunction(value.getFunction(), c, style);</span><br>      881-&gt;N:  <span style="background-color: white">                          }</span><br>      882-&gt;N:  <span style="background-color: white">      </span><br>    883-&gt;832:  <span style="background-color: cyan"> 99+                      if (cFunc != null) {</span><br>      884-&gt;N:  <span style="background-color: white">                              //TODO: counter functions may be called with non-ordered list-style-types, e.g. disc</span><br>    885-&gt;834:  <span style="background-color: cyan">  90                          content = cFunc.evaluate();</span><br>    886-&gt;835:  <span style="background-color: cyan">  90                          contentFunction = null;</span><br>    887-&gt;836:  <span style="background-color: cyan">  90                          function = null;</span><br>    888-&gt;837:  <span style="background-color: cyan"> 99+                      } else if (mode == CONTENT_LIST_MARGIN_BOX &amp;&amp; isElementFunction(value.getFunction())) {</span><br>    889-&gt;838:  <span style="background-color: cyan"> 99+                          BlockBox target = getRunningBlock(c, value);</span><br>    890-&gt;839:  <span style="background-color: cyan"> 99+                          if (target != null) {</span><br>    891-&gt;840:  <span style="background-color: cyan"> 99+                              result.add(target.copyOf());</span><br>    892-&gt;841:  <span style="background-color: cyan"> 99+                              info.setContainsBlockLevelContent(true);</span><br>      893-&gt;N:  <span style="background-color: white">                              }</span><br>      894-&gt;N:  <span style="background-color: white">                          } else {</span><br>    895-&gt;844:  <span style="background-color: white"> 99+                          contentFunction =</span><br>    896-&gt;845:  <span style="background-color: white">                                      c.getContentFunctionFactory().lookupFunction(c, value.getFunction());</span><br>    897-&gt;846:  <span style="background-color: white"> 99+                          if (contentFunction != null) {</span><br>    898-&gt;847:  <span style="background-color: white"> 99+                              function = value.getFunction();</span><br>      899-&gt;N:  <span style="background-color: white">      </span><br>    900-&gt;849:  <span style="background-color: white"> 99+                              if (contentFunction.isStatic()) {</span><br>    901-&gt;850:  <span style="background-color: white">   0                                  content = contentFunction.calculate(c, function);</span><br>    902-&gt;851:  <span style="background-color: white">   0                                  contentFunction = null;</span><br>    903-&gt;852:  <span style="background-color: white">   0                                  function = null;</span><br>      904-&gt;N:  <span style="background-color: white">                                  } else {</span><br>    905-&gt;854:  <span style="background-color: white"> 99+                                  content = contentFunction.getLayoutReplacementText();</span><br>      906-&gt;N:  <span style="background-color: white">                                  }</span><br>      907-&gt;N:  <span style="background-color: white">                              }</span><br>      908-&gt;N:  <span style="background-color: white">                          }</span><br>      909-&gt;N:  <span style="background-color: white">                      }</span><br>    910-&gt;859:  <span style="background-color: white">  30              } else if (type == CSSPrimitiveValue.CSS_IDENT) {</span><br>    911-&gt;860:  <span style="background-color: white">  30                  FSDerivedValue dv = style.valueByName(CSSName.QUOTES);</span><br>      912-&gt;N:  <span style="background-color: white">      </span><br>    913-&gt;862:  <span style="background-color: white">  30                  if (dv != IdentValue.NONE) {</span><br>    914-&gt;863:  <span style="background-color: white">  30                      IdentValue ident = value.getIdentValue();</span><br>      915-&gt;N:  <span style="background-color: white">      </span><br>    916-&gt;865:  <span style="background-color: white">  30                      if (ident == IdentValue.OPEN_QUOTE) {</span><br>    917-&gt;866:  <span style="background-color: white">  15                          String[] quotes = style.asStringArray(CSSName.QUOTES);</span><br>    918-&gt;867:  <span style="background-color: white">  15                          content = quotes[0];</span><br>    919-&gt;868:  <span style="background-color: white">  15                      } else if (ident == IdentValue.CLOSE_QUOTE) {</span><br>    920-&gt;869:  <span style="background-color: white">   9                          String[] quotes = style.asStringArray(CSSName.QUOTES);</span><br>    921-&gt;870:  <span style="background-color: white">   9                          content = quotes[1];</span><br>      922-&gt;N:  <span style="background-color: white">                          }</span><br>      923-&gt;N:  <span style="background-color: white">                      }</span><br>      924-&gt;N:  <span style="background-color: white">                  }</span><br>      925-&gt;N:  <span style="background-color: white">      </span><br>    926-&gt;875:  <span style="background-color: cyan"> 99+              if (content != null) {</span><br>    927-&gt;876:  <span style="background-color: cyan"> 99+                  InlineBox iB = new InlineBox(content);</span><br>      928-&gt;N:  <span style="background-color: white">      </span><br>    929-&gt;877:  <span style="background-color: cyan"> 99+                  iB.setContentFunction(contentFunction);</span><br>    930-&gt;878:  <span style="background-color: cyan"> 99+                  iB.setFunction(function);</span><br>    931-&gt;879:  <span style="background-color: cyan"> 99+                  iB.setElement(element);</span><br>    932-&gt;880:  <span style="background-color: cyan"> 99+                  iB.setPseudoElementOrClass(peName);</span><br>    933-&gt;881:  <span style="background-color: cyan"> 99+                  iB.setStartsHere(true);</span><br>    934-&gt;882:  <span style="background-color: cyan"> 99+                  iB.setEndsHere(true);</span><br>      935-&gt;N:  <span style="background-color: white">      </span><br>    936-&gt;884:  <span style="background-color: cyan"> 99+                  result.add(iB);</span><br>      937-&gt;N:  <span style="background-color: white">                  }</span><br>      938-&gt;N:  <span style="background-color: white">              }</span><br>      939-&gt;N:  <span style="background-color: white">      </span><br>    940-&gt;888:  <span style="background-color: cyan"> 99+          return result;</span><br>      941-&gt;N:  <span style="background-color: white">          }</span><br>      942-&gt;N:  <span style="background-color: white">      </span><br>      943-&gt;N:  <span style="background-color: white">          /**</span><br>      944-&gt;N:  <span style="background-color: white">           * Creates an element with id for the footnote-marker pseudo element</span><br>      945-&gt;N:  <span style="background-color: white">           * so we can link to it from the footnote-call pseduo element.</span><br>      946-&gt;N:  <span style="background-color: white">           * <br><br></span><br>      947-&gt;N:  <span style="background-color: white">           * See {@link #createFootnoteCallAnchor(LayoutContext, Element)}</span><br>      948-&gt;N:  <span style="background-color: white">           */</span><br>      949-&gt;U:  <span style="background-color: yellow">  50      private static Element createFootnoteTarget(LayoutContext c, Element parent) {</span><br>      950-&gt;U:  <span style="background-color: yellow">  50          if (parent == null) {</span><br>      951-&gt;U:  <span style="background-color: yellow">   0              return null;</span><br>      952-&gt;U:  <span style="background-color: yellow">              }</span><br>      953-&gt;U:  <span style="background-color: yellow">      </span><br>      954-&gt;U:  <span style="background-color: yellow">  50          Document doc = parent.getOwnerDocument();</span><br>      955-&gt;U:  <span style="background-color: yellow">  50          Element target = doc.createElement("fs-footnote-marker");</span><br>      956-&gt;U:  <span style="background-color: yellow">      </span><br>      957-&gt;U:  <span style="background-color: yellow">  50          target.setAttribute("id", "fs-footnote-" + c.getFootnoteIndex());</span><br>      958-&gt;U:  <span style="background-color: yellow">      </span><br>      959-&gt;U:  <span style="background-color: yellow">  50          parent.appendChild(target);</span><br>      960-&gt;U:  <span style="background-color: yellow">      </span><br>      961-&gt;U:  <span style="background-color: yellow">  50          return target;</span><br>      962-&gt;U:  <span style="background-color: yellow">          }</span><br>      963-&gt;N:  <span style="background-color: white">      </span><br>      964-&gt;N:  <span style="background-color: white">          /**</span><br>      965-&gt;N:  <span style="background-color: white">           * Used to create the anchor element to link to the footnote body for</span><br>      966-&gt;N:  <span style="background-color: white">           * the footnote-call pseudo element.</span><br>      967-&gt;N:  <span style="background-color: white">           * <br><br></span><br>      968-&gt;N:  <span style="background-color: white">           * See {@link #createFootnoteTarget(LayoutContext, Element)}</span><br>      969-&gt;N:  <span style="background-color: white">           */</span><br>      970-&gt;U:  <span style="background-color: yellow">  50      private static Element createFootnoteCallAnchor(LayoutContext c, Element parent) {</span><br>      971-&gt;U:  <span style="background-color: yellow">  50          if (parent == null) {</span><br>      972-&gt;U:  <span style="background-color: yellow">   0              return null;</span><br>      973-&gt;U:  <span style="background-color: yellow">              }</span><br>      974-&gt;U:  <span style="background-color: yellow">      </span><br>      975-&gt;U:  <span style="background-color: yellow">  50          Document doc = parent.getOwnerDocument();</span><br>      976-&gt;U:  <span style="background-color: yellow">  50          Element anchor = doc.createElement("a");</span><br>      977-&gt;U:  <span style="background-color: yellow">      </span><br>      978-&gt;U:  <span style="background-color: yellow">  50          anchor.setAttribute("href", "#fs-footnote-" + c.getFootnoteIndex());</span><br>      979-&gt;U:  <span style="background-color: yellow">      </span><br>      980-&gt;U:  <span style="background-color: yellow">  50          parent.appendChild(anchor);</span><br>      981-&gt;U:  <span style="background-color: yellow">      </span><br>      982-&gt;U:  <span style="background-color: yellow">  50          return anchor;</span><br>      983-&gt;U:  <span style="background-color: yellow">          }</span><br>      984-&gt;N:  <span style="background-color: white">      </span><br>    985-&gt;891:  <span style="background-color: cyan"> 99+      public static BlockBox getRunningBlock(LayoutContext c, PropertyValue value) {</span><br>    986-&gt;892:  <span style="background-color: cyan"> 99+          List
       <propertyvalue>
         params = value.getFunction().getParameters();
       </propertyvalue></span><br>    987-&gt;893:  <span style="background-color: cyan"> 99+          String ident = params.get(0).getStringValue();</span><br>    988-&gt;894:  <span style="background-color: cyan"> 99+          PageElementPosition position = null;</span><br>    989-&gt;895:  <span style="background-color: cyan"> 99+          if (params.size() == 2) {</span><br>    990-&gt;897:  <span style="background-color: cyan">   0              position = PageElementPosition.valueOf(params.get(1).getStringValue());</span><br>      991-&gt;N:  <span style="background-color: white">              }</span><br>    992-&gt;899:  <span style="background-color: cyan"> 99+          if (position == null) {</span><br>    993-&gt;900:  <span style="background-color: cyan"> 99+              position = PageElementPosition.FIRST;</span><br>      994-&gt;N:  <span style="background-color: white">              }</span><br>    995-&gt;902:  <span style="background-color: cyan"> 99+          BlockBox target = c.getRootDocumentLayer().getRunningBlock(ident, c.getPage(), position);</span><br>    996-&gt;903:  <span style="background-color: cyan"> 99+          return target;</span><br>      997-&gt;N:  <span style="background-color: white">          }</span><br>      998-&gt;N:  <span style="background-color: white">      </span><br>    999-&gt;906:  <span style="background-color: cyan"> 99+      private static void insertGeneratedContent(</span><br>   1000-&gt;907:  <span style="background-color: white">                  LayoutContext c, Element element, CalculatedStyle parentStyle,</span><br>   1001-&gt;908:  <span style="background-color: white">                  String peName, List
       <styleable>
         children, ChildBoxInfo info) {
       </styleable></span><br>     1002-&gt;N:  <span style="background-color: white">      </span><br>   1003-&gt;909:  <span style="background-color: cyan"> 99+          CascadedStyle peStyle = c.getCss().getPseudoElementStyle(element, peName);</span><br>     1004-&gt;N:  <span style="background-color: white">      </span><br>   1005-&gt;910:  <span style="background-color: cyan"> 99+          if (peStyle != null) {</span><br>   1006-&gt;911:  <span style="background-color: cyan"> 99+              PropertyDeclaration contentDecl = peStyle.propertyByName(CSSName.CONTENT);</span><br>   1007-&gt;912:  <span style="background-color: cyan"> 99+              PropertyDeclaration counterResetDecl = peStyle.propertyByName(CSSName.COUNTER_RESET);</span><br>   1008-&gt;913:  <span style="background-color: cyan"> 99+              PropertyDeclaration counterIncrDecl = peStyle.propertyByName(CSSName.COUNTER_INCREMENT);</span><br>     1009-&gt;N:  <span style="background-color: white">      </span><br>   1010-&gt;915:  <span style="background-color: cyan"> 99+              CalculatedStyle calculatedStyle = null;</span><br>     1011-&gt;N:  <span style="background-color: white">      </span><br>   1012-&gt;916:  <span style="background-color: cyan"> 99+              if (contentDecl != null || counterResetDecl != null || counterIncrDecl != null) {</span><br>   1013-&gt;917:  <span style="background-color: cyan"> 99+                  calculatedStyle = parentStyle.deriveStyle(peStyle);</span><br>     1014-&gt;N:  <span style="background-color: white">      </span><br>     1015-&gt;U:  <span style="background-color: yellow"> 99+                  if (calculatedStyle.isDisplayNone() ||</span><br>     1016-&gt;U:  <span style="background-color: yellow">                          calculatedStyle.isIdent(CSSName.CONTENT, IdentValue.NONE) ||</span><br>     1017-&gt;U:  <span style="background-color: yellow">                          (calculatedStyle.isIdent(CSSName.CONTENT, IdentValue.NORMAL) &amp;&amp; </span><br>     1018-&gt;U:  <span style="background-color: yellow">                             (peName.equals("before") || peName.equals("after")))) {</span><br>   1019-&gt;921:  <span style="background-color: white">   0                      return;</span><br>     1020-&gt;N:  <span style="background-color: white">                      }</span><br>     1021-&gt;N:  <span style="background-color: white">      </span><br>   1022-&gt;923:  <span style="background-color: cyan"> 99+                  if (calculatedStyle.isTable() ||</span><br>   1023-&gt;923:  <span style="background-color: red">                          calculatedStyle.isTableRow() ||</span><br>   1024-&gt;923:  <span style="background-color: red">                          calculatedStyle.isTableSection()) {</span><br>     1025-&gt;N:  <span style="background-color: white">      </span><br>     1026-&gt;U:  <span style="background-color: yellow">   0                      calculatedStyle = parentStyle.createAnonymousStyle(IdentValue.BLOCK);</span><br>     1027-&gt;N:  <span style="background-color: white">                      }</span><br>     1028-&gt;N:  <span style="background-color: white">      </span><br>   1029-&gt;932:  <span style="background-color: cyan"> 99+                  c.resolveCounters(calculatedStyle);</span><br>     1030-&gt;N:  <span style="background-color: white">                  }</span><br>     1031-&gt;N:  <span style="background-color: white">      </span><br>   1032-&gt;935:  <span style="background-color: cyan"> 99+              if (contentDecl != null) {</span><br>   1033-&gt;936:  <span style="background-color: cyan"> 99+                  CSSPrimitiveValue propValue = contentDecl.getValue();</span><br>   1034-&gt;937:  <span style="background-color: cyan"> 99+                  children.addAll(createGeneratedContent(c, element, peName, calculatedStyle,</span><br>   1035-&gt;938:  <span style="background-color: white">                              (PropertyValue) propValue, info));</span><br>     1036-&gt;N:  <span style="background-color: white">                  }</span><br>     1037-&gt;N:  <span style="background-color: white">              }</span><br>     1038-&gt;N:  <span style="background-color: white">          }</span><br>     1039-&gt;N:  <span style="background-color: white">      </span><br>     1040-&gt;N:  <span style="background-color: white">          /**</span><br>     1041-&gt;N:  <span style="background-color: white">           * Creates generated content boxes for pseudo elements such as <code>::before</code>.</span><br>     1042-&gt;N:  <span style="background-color: white">           *</span><br>     1043-&gt;N:  <span style="background-color: white">           * @param element The containing element where the pseudo element appears.</span><br>     1044-&gt;N:  <span style="background-color: white">           * For <code>span::before</code> the element would be a <code>span</code>.</span><br>     1045-&gt;N:  <span style="background-color: white">           *</span><br>     1046-&gt;N:  <span style="background-color: white">           * @param peName Examples include <code>before</code>, <code>after</code>,</span><br>     1047-&gt;N:  <span style="background-color: white">           * <code>footnote-call</code> and <code>footnote-marker</code>.</span><br>     1048-&gt;N:  <span style="background-color: white">           *</span><br>     1049-&gt;N:  <span style="background-color: white">           * @param style The child style for this pseudo element. For <code>span::before</code></span><br>     1050-&gt;N:  <span style="background-color: white">           * this would include all the styles set explicitly on <code>::before</code> as well as</span><br>     1051-&gt;N:  <span style="background-color: white">           * those that inherit from <code>span</code> following the cascade rules.</span><br>     1052-&gt;N:  <span style="background-color: white">           *</span><br>     1053-&gt;N:  <span style="background-color: white">           * @param property The values of the <code>content</code> CSS property.</span><br>     1054-&gt;N:  <span style="background-color: white">           * @param info In/out param. Whether the resultant box(es) contain block level content.</span><br>     1055-&gt;N:  <span style="background-color: white">           * @return The generated box(es). Typically one {@link BlockBox} or multiple inline boxes.</span><br>     1056-&gt;N:  <span style="background-color: white">           */</span><br>     1057-&gt;U:  <span style="background-color: yellow"> 99+      private static List
       <styleable>
         createGeneratedContent(
       </styleable></span><br>     1058-&gt;U:  <span style="background-color: yellow">                  LayoutContext c, Element element, String peName,</span><br>     1059-&gt;U:  <span style="background-color: yellow">                  CalculatedStyle style, PropertyValue property, ChildBoxInfo info) {</span><br>     1060-&gt;U:  <span style="background-color: yellow">      </span><br>     1061-&gt;U:  <span style="background-color: yellow"> 99+          if (style.isDisplayNone()</span><br>     1062-&gt;U:  <span style="background-color: yellow">                      || style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN)</span><br>     1063-&gt;U:  <span style="background-color: yellow">                      || style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN_GROUP)</span><br>     1064-&gt;U:  <span style="background-color: yellow">                      || property.getValues() == null) {</span><br>     1065-&gt;U:  <span style="background-color: yellow">   0              return Collections.emptyList();</span><br>     1066-&gt;U:  <span style="background-color: yellow">              }</span><br>     1067-&gt;U:  <span style="background-color: yellow">      </span><br>     1068-&gt;U:  <span style="background-color: yellow"> 99+          if ("footnote-call".equals(peName) || "footnote-marker".equals(peName)) {</span><br>     1069-&gt;U:  <span style="background-color: yellow"> 99+              if (!isValidFootnotePseudo(style)) {</span><br>     1070-&gt;U:  <span style="background-color: yellow">   4                  logInvalidFootnotePseudo(peName, style);</span><br>     1071-&gt;U:  <span style="background-color: yellow">   4                  return Collections.emptyList();</span><br>     1072-&gt;U:  <span style="background-color: yellow">                  }</span><br>     1073-&gt;U:  <span style="background-color: yellow">              } else {</span><br>     1074-&gt;U:  <span style="background-color: yellow">      </span><br>     1075-&gt;U:  <span style="background-color: yellow"> 99+              if (c.isInFloatBottom() &amp;&amp; !isValidFootnotePseudo(style)) {</span><br>     1076-&gt;U:  <span style="background-color: yellow">                      // ::before or ::after in footnote.</span><br>     1077-&gt;U:  <span style="background-color: yellow">   2                  logInvalidFootnotePseudo(peName, style);</span><br>     1078-&gt;U:  <span style="background-color: yellow">   2                  return Collections.emptyList();</span><br>     1079-&gt;U:  <span style="background-color: yellow"> 99+              } else if (style.isFootnote()) {</span><br>     1080-&gt;U:  <span style="background-color: yellow">                      // ::before or ::after trying to be a footnote.</span><br>     1081-&gt;U:  <span style="background-color: yellow">   1                  XRLog.log(Level.WARNING, LogMessageId.LogMessageId1Param.GENERAL_FOOTNOTE_CAN_NOT_BE_PSEUDO, peName);</span><br>     1082-&gt;U:  <span style="background-color: yellow">   1                  return Collections.emptyList();</span><br>     1083-&gt;U:  <span style="background-color: yellow">                  }</span><br>     1084-&gt;U:  <span style="background-color: yellow">              }</span><br>     1085-&gt;U:  <span style="background-color: yellow">      </span><br>     1086-&gt;U:  <span style="background-color: yellow"> 99+          ChildBoxInfo childInfo = new ChildBoxInfo();</span><br>     1087-&gt;U:  <span style="background-color: yellow">      </span><br>     1088-&gt;U:  <span style="background-color: yellow"> 99+          List
       <propertyvalue>
         values = property.getValues();
       </propertyvalue></span><br>     1089-&gt;U:  <span style="background-color: yellow"> 99+          List
       <styleable>
         result = new ArrayList&lt;&gt;(values.size());
       </styleable></span><br>     1090-&gt;U:  <span style="background-color: yellow">      </span><br>     1091-&gt;U:  <span style="background-color: yellow"> 99+          createGeneratedContentList(</span><br>     1092-&gt;U:  <span style="background-color: yellow">                      c, element, values, peName, style, CONTENT_LIST_DOCUMENT, childInfo, result);</span><br>     1093-&gt;U:  <span style="background-color: yellow">      </span><br>     1094-&gt;U:  <span style="background-color: yellow"> 99+          return wrapGeneratedContent(c, element, peName, style, info, childInfo, result);</span><br>     1095-&gt;U:  <span style="background-color: yellow">          }</span><br>     1096-&gt;N:  <span style="background-color: white">      </span><br>     1097-&gt;U:  <span style="background-color: yellow"> 99+      private static List
       <styleable>
         wrapGeneratedContent(
       </styleable></span><br>     1098-&gt;U:  <span style="background-color: yellow">                  LayoutContext c,</span><br>     1099-&gt;U:  <span style="background-color: yellow">                  Element element, String peName, CalculatedStyle style,</span><br>     1100-&gt;U:  <span style="background-color: yellow">                  ChildBoxInfo info, ChildBoxInfo childInfo, List
       <styleable>
         inlineBoxes) {
       </styleable></span><br>     1101-&gt;U:  <span style="background-color: yellow">      </span><br>     1102-&gt;U:  <span style="background-color: yellow"> 99+          Element wrapperElement = element;</span><br>     1103-&gt;U:  <span style="background-color: yellow"> 99+          if ("footnote-call".equals(peName)) {</span><br>     1104-&gt;U:  <span style="background-color: yellow">  50              wrapperElement = createFootnoteCallAnchor(c, element);</span><br>     1105-&gt;U:  <span style="background-color: yellow"> 99+          } else if ("footnote-marker".equals(peName)) {</span><br>     1106-&gt;U:  <span style="background-color: yellow">  50              wrapperElement = createFootnoteTarget(c, element);</span><br>     1107-&gt;U:  <span style="background-color: yellow">              }</span><br>     1108-&gt;U:  <span style="background-color: yellow">      </span><br>     1109-&gt;U:  <span style="background-color: yellow"> 99+          if (style.isInline()) {</span><br>     1110-&gt;U:  <span style="background-color: yellow">                  // Because a content property like: content: counter(page) ". ";</span><br>     1111-&gt;U:  <span style="background-color: yellow">                  // will generate multiple inline boxes we have to wrap them in a inline-box</span><br>     1112-&gt;U:  <span style="background-color: yellow">                  // and use a child style for the generated boxes. Otherwise, if we use the</span><br>     1113-&gt;U:  <span style="background-color: yellow">                  // pseudo style directly and it has a border, etc we will incorrectly get a border</span><br>     1114-&gt;U:  <span style="background-color: yellow">                  // around every content box.</span><br>     1115-&gt;U:  <span style="background-color: yellow">      </span><br>     1116-&gt;U:  <span style="background-color: yellow"> 99+              List
       <styleable>
         pseudoInlines = new ArrayList&lt;&gt;(inlineBoxes.size() + 2);
       </styleable></span><br>     1117-&gt;U:  <span style="background-color: yellow">      </span><br>     1118-&gt;U:  <span style="background-color: yellow"> 99+              InlineBox pseudoStart = new InlineBox("");</span><br>     1119-&gt;U:  <span style="background-color: yellow"> 99+              pseudoStart.setStartsHere(true);</span><br>     1120-&gt;U:  <span style="background-color: yellow"> 99+              pseudoStart.setEndsHere(false);</span><br>     1121-&gt;U:  <span style="background-color: yellow"> 99+              pseudoStart.setStyle(style);</span><br>     1122-&gt;U:  <span style="background-color: yellow"> 99+              pseudoStart.setElement(wrapperElement);</span><br>     1123-&gt;U:  <span style="background-color: yellow"> 99+              pseudoStart.setPseudoElementOrClass(peName);</span><br>     1124-&gt;U:  <span style="background-color: yellow">      </span><br>     1125-&gt;U:  <span style="background-color: yellow"> 99+              pseudoInlines.add(pseudoStart);</span><br>     1126-&gt;U:  <span style="background-color: yellow">      </span><br>     1127-&gt;U:  <span style="background-color: yellow"> 99+              CalculatedStyle inlineContent = style.createAnonymousStyle(IdentValue.INLINE);</span><br>     1128-&gt;U:  <span style="background-color: yellow">      </span><br>     1129-&gt;U:  <span style="background-color: yellow"> 99+              for (Styleable styleable : inlineBoxes) {</span><br>     1130-&gt;U:  <span style="background-color: yellow"> 99+                  if (styleable instanceof InlineBox) {</span><br>     1131-&gt;U:  <span style="background-color: yellow"> 99+                      InlineBox iB = (InlineBox) styleable;</span><br>     1132-&gt;U:  <span style="background-color: yellow">      </span><br>     1133-&gt;U:  <span style="background-color: yellow"> 99+                      iB.setElement(null);</span><br>     1134-&gt;U:  <span style="background-color: yellow"> 99+                      iB.setStyle(inlineContent);</span><br>     1135-&gt;U:  <span style="background-color: yellow"> 99+                      iB.applyTextTransform();</span><br>     1136-&gt;U:  <span style="background-color: yellow">                      }</span><br>     1137-&gt;U:  <span style="background-color: yellow">      </span><br>     1138-&gt;U:  <span style="background-color: yellow"> 99+                  pseudoInlines.add(styleable);</span><br>     1139-&gt;U:  <span style="background-color: yellow">                  }</span><br>     1140-&gt;U:  <span style="background-color: yellow">      </span><br>     1141-&gt;U:  <span style="background-color: yellow"> 99+              InlineBox pseudoEnd = new InlineBox("");</span><br>     1142-&gt;U:  <span style="background-color: yellow"> 99+              pseudoEnd.setStartsHere(false);</span><br>     1143-&gt;U:  <span style="background-color: yellow"> 99+              pseudoEnd.setEndsHere(true);</span><br>     1144-&gt;U:  <span style="background-color: yellow"> 99+              pseudoEnd.setStyle(style);</span><br>     1145-&gt;U:  <span style="background-color: yellow"> 99+              pseudoEnd.setElement(wrapperElement);</span><br>     1146-&gt;U:  <span style="background-color: yellow"> 99+              pseudoEnd.setPseudoElementOrClass(peName);</span><br>     1147-&gt;U:  <span style="background-color: yellow">      </span><br>     1148-&gt;U:  <span style="background-color: yellow"> 99+              pseudoInlines.add(pseudoEnd);</span><br>     1149-&gt;U:  <span style="background-color: yellow">      </span><br>     1150-&gt;U:  <span style="background-color: yellow"> 99+              return pseudoInlines;</span><br>     1151-&gt;U:  <span style="background-color: yellow">              } else {</span><br>     1152-&gt;U:  <span style="background-color: yellow">  26              CalculatedStyle anon = style.createAnonymousStyle(IdentValue.INLINE);</span><br>     1153-&gt;U:  <span style="background-color: yellow">      </span><br>     1154-&gt;U:  <span style="background-color: yellow">  26              for (Styleable styleable : inlineBoxes) {</span><br>     1155-&gt;U:  <span style="background-color: yellow">  59                  if (styleable instanceof InlineBox) {</span><br>     1156-&gt;U:  <span style="background-color: yellow">  55                      InlineBox iB = (InlineBox) styleable;</span><br>     1157-&gt;U:  <span style="background-color: yellow">      </span><br>     1158-&gt;U:  <span style="background-color: yellow">  55                      iB.setElement(null);</span><br>     1159-&gt;U:  <span style="background-color: yellow">  55                      iB.setStyle(anon);</span><br>     1160-&gt;U:  <span style="background-color: yellow">  55                      iB.applyTextTransform();</span><br>     1161-&gt;U:  <span style="background-color: yellow">                      }</span><br>     1162-&gt;U:  <span style="background-color: yellow">                  }</span><br>     1163-&gt;U:  <span style="background-color: yellow">      </span><br>     1164-&gt;U:  <span style="background-color: yellow">  26              BlockBox result = createBlockBox(style, info, true);</span><br>     1165-&gt;U:  <span style="background-color: yellow">  26              result.setStyle(style);</span><br>     1166-&gt;U:  <span style="background-color: yellow">  26              result.setInlineContent(inlineBoxes);</span><br>     1167-&gt;U:  <span style="background-color: yellow">  26              result.setElement(wrapperElement);</span><br>     1168-&gt;U:  <span style="background-color: yellow">  26              result.setChildrenContentType(BlockBox.ContentType.INLINE);</span><br>     1169-&gt;U:  <span style="background-color: yellow">  26              result.setPseudoElementOrClass(peName);</span><br>     1170-&gt;U:  <span style="background-color: yellow">      </span><br>     1171-&gt;U:  <span style="background-color: yellow">  26              if (! style.isLayedOutInInlineContext()) {</span><br>     1172-&gt;U:  <span style="background-color: yellow">   5                  info.setContainsBlockLevelContent(true);</span><br>     1173-&gt;U:  <span style="background-color: yellow">                  }</span><br>     1174-&gt;U:  <span style="background-color: yellow">      </span><br>     1175-&gt;U:  <span style="background-color: yellow">  26              return new ArrayList&lt;&gt;(Collections.singletonList(result));</span><br>     1176-&gt;U:  <span style="background-color: yellow">              }</span><br>     1177-&gt;U:  <span style="background-color: yellow">          }</span><br>     1178-&gt;N:  <span style="background-color: white">      </span><br>  1179-&gt;1019:  <span style="background-color: cyan"> 99+      private static List
       <styleable>
         createGeneratedMarginBoxContent(
       </styleable></span><br>  1180-&gt;1020:  <span style="background-color: white">                  LayoutContext c, Element element, PropertyValue property,</span><br>  1181-&gt;1021:  <span style="background-color: white">                  CalculatedStyle style, ChildBoxInfo info) {</span><br>     1182-&gt;U:  <span style="background-color: yellow"> 99+          List
       <propertyvalue>
         values = property.getValues();
       </propertyvalue></span><br>     1183-&gt;N:  <span style="background-color: white">      </span><br>     1184-&gt;U:  <span style="background-color: yellow"> 99+          if (values == null) {</span><br>     1185-&gt;U:  <span style="background-color: yellow">   0             return Collections.emptyList();</span><br>     1186-&gt;U:  <span style="background-color: yellow">              }</span><br>     1187-&gt;N:  <span style="background-color: white">      </span><br>     1188-&gt;U:  <span style="background-color: yellow"> 99+          List
       <styleable>
         result = new ArrayList&lt;&gt;(values.size());
       </styleable></span><br>     1189-&gt;U:  <span style="background-color: yellow"> 99+          createGeneratedContentList(</span><br>     1190-&gt;U:  <span style="background-color: yellow">                      c, element, values, null, style, CONTENT_LIST_MARGIN_BOX, info, result);</span><br>     1191-&gt;N:  <span style="background-color: white">      </span><br>  1192-&gt;1026:  <span style="background-color: cyan"> 99+          CalculatedStyle anon = style.createAnonymousStyle(IdentValue.INLINE);</span><br>  1193-&gt;1027:  <span style="background-color: cyan"> 99+          for (Styleable s : result) {</span><br>  1194-&gt;1028:  <span style="background-color: cyan"> 99+              if (s instanceof InlineBox) {</span><br>  1195-&gt;1029:  <span style="background-color: cyan"> 99+                  InlineBox iB = (InlineBox)s;</span><br>  1196-&gt;1030:  <span style="background-color: cyan"> 99+                  iB.setElement(null);</span><br>  1197-&gt;1031:  <span style="background-color: cyan"> 99+                  iB.setStyle(anon);</span><br>  1198-&gt;1032:  <span style="background-color: cyan"> 99+                  iB.applyTextTransform();</span><br>     1199-&gt;N:  <span style="background-color: white">                  }</span><br>     1200-&gt;N:  <span style="background-color: white">              }</span><br>     1201-&gt;N:  <span style="background-color: white">      </span><br>  1202-&gt;1036:  <span style="background-color: cyan"> 99+          return result;</span><br>     1203-&gt;N:  <span style="background-color: white">          }</span><br>     1204-&gt;N:  <span style="background-color: white">      </span><br>  1205-&gt;1039:  <span style="background-color: cyan"> 99+      private static BlockBox createBlockBox(</span><br>  1206-&gt;1040:  <span style="background-color: white">                  CalculatedStyle style, ChildBoxInfo info, boolean generated) {</span><br>  1207-&gt;1041:  <span style="background-color: cyan"> 99+          if (style.isFloated() &amp;&amp; !(style.isAbsolute() || style.isFixed())) {</span><br>  1208-&gt;1042:  <span style="background-color: cyan"> 99+              BlockBox result;</span><br>  1209-&gt;1043:  <span style="background-color: cyan"> 99+              if (style.isTable() || style.isInlineTable()) {</span><br>  1210-&gt;1044:  <span style="background-color: white">   0                  result = new TableBox();</span><br>  1211-&gt;1045:  <span style="background-color: cyan"> 99+              } else if (style.isTableCell()) {</span><br>  1212-&gt;1046:  <span style="background-color: white">   1                  info.setContainsTableContent(true);</span><br>  1213-&gt;1047:  <span style="background-color: white">   1                  result = new TableCellBox();</span><br>     1214-&gt;N:  <span style="background-color: white">                  } else {</span><br>  1215-&gt;1049:  <span style="background-color: cyan"> 99+                  result = new BlockBox();</span><br>     1216-&gt;N:  <span style="background-color: white">                  }</span><br>  1217-&gt;1051:  <span style="background-color: cyan"> 99+              result.setFloatedBoxData(new FloatedBoxData());</span><br>  1218-&gt;1052:  <span style="background-color: cyan"> 99+              return result;</span><br>  1219-&gt;1053:  <span style="background-color: cyan"> 99+          } else if (style.isSpecifiedAsBlock()) {</span><br>  1220-&gt;1054:  <span style="background-color: cyan"> 99+              return new BlockBox();</span><br>  1221-&gt;1055:  <span style="background-color: cyan"> 99+          } else if (! generated &amp;&amp; (style.isTable() || style.isInlineTable())) {</span><br>  1222-&gt;1056:  <span style="background-color: cyan"> 99+              return new TableBox();</span><br>  1223-&gt;1057:  <span style="background-color: cyan"> 99+          } else if (style.isTableCell()) {</span><br>  1224-&gt;1058:  <span style="background-color: cyan"> 99+              info.setContainsTableContent(true);</span><br>  1225-&gt;1059:  <span style="background-color: cyan"> 99+              return new TableCellBox();</span><br>  1226-&gt;1060:  <span style="background-color: cyan"> 99+          } else if (! generated &amp;&amp; style.isTableRow()) {</span><br>  1227-&gt;1061:  <span style="background-color: cyan"> 99+              info.setContainsTableContent(true);</span><br>  1228-&gt;1062:  <span style="background-color: cyan"> 99+              return new TableRowBox();</span><br>  1229-&gt;1063:  <span style="background-color: cyan"> 99+          } else if (! generated &amp;&amp; style.isTableSection()) {</span><br>  1230-&gt;1064:  <span style="background-color: cyan"> 99+              info.setContainsTableContent(true);</span><br>  1231-&gt;1065:  <span style="background-color: cyan"> 99+              return new TableSectionBox();</span><br>  1232-&gt;1066:  <span style="background-color: cyan"> 99+          } else if (style.isTableCaption()) {</span><br>  1233-&gt;1067:  <span style="background-color: cyan">   7              info.setContainsTableContent(true);</span><br>  1234-&gt;1068:  <span style="background-color: cyan">   7              return new BlockBox();</span><br>     1235-&gt;N:  <span style="background-color: white">              } else {</span><br>  1236-&gt;1070:  <span style="background-color: cyan"> 99+              return new BlockBox();</span><br>     1237-&gt;N:  <span style="background-color: white">              }</span><br>     1238-&gt;N:  <span style="background-color: white">          }</span><br>     1239-&gt;N:  <span style="background-color: white">      </span><br>  1240-&gt;1074:  <span style="background-color: white">  22      private static void addColumns(LayoutContext c, TableBox table, TableColumn parent) {</span><br>  1241-&gt;1075:  <span style="background-color: white">  22          SharedContext sharedContext = c.getSharedContext();</span><br>     1242-&gt;N:  <span style="background-color: white">      </span><br>  1243-&gt;1077:  <span style="background-color: white">  22          Node working = parent.getElement().getFirstChild();</span><br>  1244-&gt;1078:  <span style="background-color: white">  22          boolean found = false;</span><br>  1245-&gt;1079:  <span style="background-color: white"> 99+          while (working != null) {</span><br>  1246-&gt;1080:  <span style="background-color: white"> 99+              if (working.getNodeType() == Node.ELEMENT_NODE) {</span><br>  1247-&gt;1081:  <span style="background-color: white"> 99+                  Element element = (Element) working;</span><br>  1248-&gt;1082:  <span style="background-color: white"> 99+                  CalculatedStyle style = sharedContext.getStyle(element);</span><br>     1249-&gt;N:  <span style="background-color: white">      </span><br>  1250-&gt;1084:  <span style="background-color: white"> 99+                  if (style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN)) {</span><br>  1251-&gt;1085:  <span style="background-color: white"> 99+                      found = true;</span><br>  1252-&gt;1086:  <span style="background-color: white"> 99+                      TableColumn col = new TableColumn(element, style);</span><br>  1253-&gt;1087:  <span style="background-color: white"> 99+                      col.setParent(parent);</span><br>  1254-&gt;1088:  <span style="background-color: white"> 99+                      table.addStyleColumn(col);</span><br>     1255-&gt;N:  <span style="background-color: white">                      }</span><br>     1256-&gt;N:  <span style="background-color: white">                  }</span><br>  1257-&gt;1091:  <span style="background-color: white"> 99+              working = working.getNextSibling();</span><br>     1258-&gt;N:  <span style="background-color: white">              }</span><br>  1259-&gt;1093:  <span style="background-color: white">  22          if (! found) {</span><br>  1260-&gt;1094:  <span style="background-color: white">   0              table.addStyleColumn(parent);</span><br>     1261-&gt;N:  <span style="background-color: white">              }</span><br>     1262-&gt;N:  <span style="background-color: white">          }</span><br>     1263-&gt;N:  <span style="background-color: white">      </span><br>  1264-&gt;1098:  <span style="background-color: white">  22      private static void addColumnOrColumnGroup(</span><br>  1265-&gt;1099:  <span style="background-color: white">                  LayoutContext c, TableBox table, Element e, CalculatedStyle style) {</span><br>  1266-&gt;1100:  <span style="background-color: white">  22          if (style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN)) {</span><br>  1267-&gt;1101:  <span style="background-color: white">   0              table.addStyleColumn(new TableColumn(e, style));</span><br>     1268-&gt;N:  <span style="background-color: white">              } else { /* style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN_GROUP) */</span><br>  1269-&gt;1103:  <span style="background-color: white">  22              addColumns(c, table, new TableColumn(e, style));</span><br>     1270-&gt;N:  <span style="background-color: white">              }</span><br>     1271-&gt;N:  <span style="background-color: white">          }</span><br>     1272-&gt;N:  <span style="background-color: white">      </span><br>  1273-&gt;1107:  <span style="background-color: cyan"> 99+      private static InlineBox createInlineBox(</span><br>  1274-&gt;1108:  <span style="background-color: white">                  String text, Element parent, CalculatedStyle parentStyle, Text node) {</span><br>  1275-&gt;1109:  <span style="background-color: cyan"> 99+          InlineBox result = new InlineBox(text);</span><br>     1276-&gt;N:  <span style="background-color: white">      </span><br>  1277-&gt;1111:  <span style="background-color: cyan"> 99+          if (parentStyle.isInline() &amp;&amp; ! (parent.getParentNode() instanceof Document)) {</span><br>  1278-&gt;1112:  <span style="background-color: cyan"> 99+              result.setStyle(parentStyle);</span><br>  1279-&gt;1113:  <span style="background-color: cyan"> 99+              result.setElement(parent);</span><br>     1280-&gt;N:  <span style="background-color: white">              } else {</span><br>  1281-&gt;1115:  <span style="background-color: cyan"> 99+              result.setStyle(parentStyle.createAnonymousStyle(IdentValue.INLINE));</span><br>     1282-&gt;N:  <span style="background-color: white">              }</span><br>     1283-&gt;N:  <span style="background-color: white">      </span><br>  1284-&gt;1118:  <span style="background-color: cyan"> 99+          result.applyTextTransform();</span><br>     1285-&gt;N:  <span style="background-color: white">      </span><br>  1286-&gt;1120:  <span style="background-color: cyan"> 99+          return result;</span><br>     1287-&gt;N:  <span style="background-color: white">          }</span><br>     1288-&gt;N:  <span style="background-color: white">      </span><br>     1289-&gt;U:  <span style="background-color: yellow">          private static class CreateChildrenContext {</span><br>     1290-&gt;U:  <span style="background-color: yellow"> 99+          CreateChildrenContext(</span><br>     1291-&gt;U:  <span style="background-color: yellow">                  boolean needStartText, boolean needEndText,</span><br>     1292-&gt;U:  <span style="background-color: yellow">                  CalculatedStyle parentStyle, boolean inline) {</span><br>     1293-&gt;U:  <span style="background-color: yellow"> 99+              this.needStartText = needStartText;</span><br>     1294-&gt;U:  <span style="background-color: yellow"> 99+              this.needEndText = needEndText;</span><br>     1295-&gt;U:  <span style="background-color: yellow"> 99+              this.parentStyle = parentStyle;</span><br>     1296-&gt;U:  <span style="background-color: yellow"> 99+              this.inline = inline;</span><br>     1297-&gt;U:  <span style="background-color: yellow">              }</span><br>     1298-&gt;U:  <span style="background-color: yellow">      </span><br>     1299-&gt;U:  <span style="background-color: yellow">              boolean needStartText;</span><br>     1300-&gt;U:  <span style="background-color: yellow">              boolean needEndText;</span><br>     1301-&gt;U:  <span style="background-color: yellow">              boolean inline;</span><br>     1302-&gt;U:  <span style="background-color: yellow">      </span><br>     1303-&gt;U:  <span style="background-color: yellow">              InlineBox previousIB = null;</span><br>     1304-&gt;U:  <span style="background-color: yellow">              final CalculatedStyle parentStyle;</span><br>     1305-&gt;U:  <span style="background-color: yellow">          }</span><br>     1306-&gt;N:  <span style="background-color: white">      </span><br>     1307-&gt;U:  <span style="background-color: yellow"> 99+      private static boolean isValidFootnote(</span><br>     1308-&gt;U:  <span style="background-color: yellow">                  LayoutContext c, Element element, CalculatedStyle style) {</span><br>     1309-&gt;U:  <span style="background-color: yellow"> 99+          return c.isPrint() &amp;&amp;</span><br>     1310-&gt;U:  <span style="background-color: yellow">                     (style.isInline() || style.isSpecifiedAsBlock()) &amp;&amp;</span><br>     1311-&gt;U:  <span style="background-color: yellow">                     !style.isPostionedOrFloated() &amp;&amp;</span><br>     1312-&gt;U:  <span style="background-color: yellow">                     !style.isRunning() &amp;&amp;</span><br>     1313-&gt;U:  <span style="background-color: yellow">                     !c.getSharedContext().getReplacedElementFactory().isReplacedElement(element);</span><br>     1314-&gt;U:  <span style="background-color: yellow">          }</span><br>     1315-&gt;N:  <span style="background-color: white">      </span><br>     1316-&gt;U:  <span style="background-color: yellow">   5      private static void logInvalidFootnoteStyle(</span><br>     1317-&gt;U:  <span style="background-color: yellow">                  LayoutContext c, Element element, CalculatedStyle style) {</span><br>     1318-&gt;U:  <span style="background-color: yellow">   5          String cause = "";</span><br>     1319-&gt;U:  <span style="background-color: yellow">      </span><br>     1320-&gt;U:  <span style="background-color: yellow">   5          if (!style.isInline() &amp;&amp; !style.isSpecifiedAsBlock()) {</span><br>     1321-&gt;U:  <span style="background-color: yellow">   1              cause = "The footnote element should be display: block (such as 
       <div>
        )";
       </div></span><br>     1322-&gt;U:  <span style="background-color: yellow">   4          } else if (style.isFloated()) {</span><br>     1323-&gt;U:  <span style="background-color: yellow">   0              cause = "The footnote element must not be floated";</span><br>     1324-&gt;U:  <span style="background-color: yellow">   4          } else if (c.getSharedContext().getReplacedElementFactory().isReplacedElement(element)) {</span><br>     1325-&gt;U:  <span style="background-color: yellow">   1              cause = "The footnote element must not be replaced (such as <img>)";</span><br>     1326-&gt;U:  <span style="background-color: yellow">   3          } else if (style.isPositioned() || style.isRunning()) {</span><br>     1327-&gt;U:  <span style="background-color: yellow">   3              cause = "The footnote element must have position: static (not absolute, relative, running or fixed)";</span><br>     1328-&gt;U:  <span style="background-color: yellow">              }</span><br>     1329-&gt;U:  <span style="background-color: yellow">      </span><br>     1330-&gt;U:  <span style="background-color: yellow">   5          XRLog.log(Level.WARNING, LogMessageId.LogMessageId1Param.GENERAL_FOOTNOTE_INVALID, cause);</span><br>     1331-&gt;U:  <span style="background-color: yellow">          }</span><br>     1332-&gt;N:  <span style="background-color: white">      </span><br>     1333-&gt;U:  <span style="background-color: yellow"> 99+      private static boolean isValidFootnotePseudo(CalculatedStyle style) {</span><br>     1334-&gt;U:  <span style="background-color: yellow"> 99+          return !style.isFixed() &amp;&amp; !style.isFootnote();</span><br>     1335-&gt;U:  <span style="background-color: yellow">          }</span><br>     1336-&gt;N:  <span style="background-color: white">      </span><br>     1337-&gt;U:  <span style="background-color: yellow">   6      private static void logInvalidFootnotePseudo(String peName, CalculatedStyle style) {</span><br>     1338-&gt;U:  <span style="background-color: yellow">   6          String cause = "";</span><br>     1339-&gt;U:  <span style="background-color: yellow">      </span><br>     1340-&gt;U:  <span style="background-color: yellow">   6          if (style.isFixed()) {</span><br>     1341-&gt;U:  <span style="background-color: yellow">   3              cause = "Footnote pseudo element (" + peName + ") may not have fixed position";</span><br>     1342-&gt;U:  <span style="background-color: yellow">   3          } else if (style.isFootnote()) {</span><br>     1343-&gt;U:  <span style="background-color: yellow">   3              cause = "Footnote pseudo element (" + peName + ") may not have float: footnote set itself";</span><br>     1344-&gt;U:  <span style="background-color: yellow">              }</span><br>     1345-&gt;U:  <span style="background-color: yellow">      </span><br>     1346-&gt;U:  <span style="background-color: yellow">   6          XRLog.log(Level.WARNING, LogMessageId.LogMessageId1Param.GENERAL_FOOTNOTE_PSEUDO_INVALID, cause);</span><br>     1347-&gt;U:  <span style="background-color: yellow">          }</span><br>     1348-&gt;N:  <span style="background-color: white">      </span><br>     1349-&gt;N:  <span style="background-color: white">          /**</span><br>     1350-&gt;N:  <span style="background-color: white">           * Don't output elements that have been artificially created to support</span><br>     1351-&gt;N:  <span style="background-color: white">           * footnotes and content property images.</span><br>     1352-&gt;N:  <span style="background-color: white">           */</span><br>     1353-&gt;U:  <span style="background-color: yellow"> 99+      private static boolean isGeneratedElement(Element element) {</span><br>     1354-&gt;U:  <span style="background-color: yellow"> 99+          String tag = element.getNodeName();</span><br>     1355-&gt;U:  <span style="background-color: yellow">      </span><br>     1356-&gt;U:  <span style="background-color: yellow"> 99+          return ("fs-footnote-marker".equals(tag)) ||</span><br>     1357-&gt;U:  <span style="background-color: yellow">                     ("a".equals(tag) &amp;&amp; element.getAttribute("href").startsWith("#fs-footnote")) ||</span><br>     1358-&gt;U:  <span style="background-color: yellow">                     ("img".equals(tag) &amp;&amp; element.getAttribute("fs-ignore").equals("true"));</span><br>     1359-&gt;U:  <span style="background-color: yellow">          }</span><br>     1360-&gt;N:  <span style="background-color: white">      </span><br>     1361-&gt;U:  <span style="background-color: yellow"> 99+      private static void createElementChild(</span><br>     1362-&gt;U:  <span style="background-color: yellow">                  LayoutContext c,</span><br>     1363-&gt;U:  <span style="background-color: yellow">                  Element parent,</span><br>     1364-&gt;U:  <span style="background-color: yellow">                  BlockBox blockParent,</span><br>     1365-&gt;U:  <span style="background-color: yellow">                  Node working,</span><br>     1366-&gt;U:  <span style="background-color: yellow">                  List
       <styleable>
         children,
       </styleable></span><br>     1367-&gt;U:  <span style="background-color: yellow">                  ChildBoxInfo info,</span><br>     1368-&gt;U:  <span style="background-color: yellow">                  CreateChildrenContext context) {</span><br>     1369-&gt;U:  <span style="background-color: yellow">      </span><br>     1370-&gt;U:  <span style="background-color: yellow"> 99+          Styleable child = null;</span><br>     1371-&gt;U:  <span style="background-color: yellow"> 99+          SharedContext sharedContext = c.getSharedContext();</span><br>     1372-&gt;U:  <span style="background-color: yellow"> 99+          Element element = (Element) working;</span><br>     1373-&gt;U:  <span style="background-color: yellow"> 99+          CalculatedStyle style = sharedContext.getStyle(element);</span><br>     1374-&gt;U:  <span style="background-color: yellow">      </span><br>     1375-&gt;U:  <span style="background-color: yellow"> 99+          if (style.isDisplayNone() || isGeneratedElement(element)) {</span><br>     1376-&gt;U:  <span style="background-color: yellow"> 99+              return;</span><br>     1377-&gt;U:  <span style="background-color: yellow">              }</span><br>     1378-&gt;U:  <span style="background-color: yellow">      </span><br>     1379-&gt;U:  <span style="background-color: yellow"> 99+          resolveElementCounters(c, working, element, style);</span><br>     1380-&gt;U:  <span style="background-color: yellow">      </span><br>     1381-&gt;U:  <span style="background-color: yellow"> 99+          if (style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN) ||</span><br>     1382-&gt;U:  <span style="background-color: yellow">                  style.isIdent(CSSName.DISPLAY, IdentValue.TABLE_COLUMN_GROUP)) {</span><br>     1383-&gt;U:  <span style="background-color: yellow">      </span><br>     1384-&gt;U:  <span style="background-color: yellow">  42              if ((blockParent != null) &amp;&amp;</span><br>     1385-&gt;U:  <span style="background-color: yellow">                      (blockParent.getStyle().isTable() || blockParent.getStyle().isInlineTable())) {</span><br>     1386-&gt;U:  <span style="background-color: yellow">  22                  TableBox table = (TableBox) blockParent;</span><br>     1387-&gt;U:  <span style="background-color: yellow">  22                  addColumnOrColumnGroup(c, table, element, style);</span><br>     1388-&gt;U:  <span style="background-color: yellow">                  }</span><br>     1389-&gt;U:  <span style="background-color: yellow">      </span><br>     1390-&gt;U:  <span style="background-color: yellow">  42              return;</span><br>     1391-&gt;U:  <span style="background-color: yellow">              }</span><br>     1392-&gt;U:  <span style="background-color: yellow">      </span><br>     1393-&gt;U:  <span style="background-color: yellow"> 99+          if (style.isFootnote() &amp;&amp; !c.isInFloatBottom() &amp;&amp; c.isFootnoteAllowed()) {</span><br>     1394-&gt;U:  <span style="background-color: yellow"> 99+              if (isValidFootnote(c, element, style)) {</span><br>     1395-&gt;U:  <span style="background-color: yellow"> 99+                  c.setFootnoteIndex(c.getFootnoteIndex() + 1);</span><br>     1396-&gt;U:  <span style="background-color: yellow">      </span><br>     1397-&gt;U:  <span style="background-color: yellow">                      // This is the official footnote call content that can generate zero or more boxes</span><br>     1398-&gt;U:  <span style="background-color: yellow">                      // depending on user for ::footnote-call pseudo element.</span><br>     1399-&gt;U:  <span style="background-color: yellow"> 99+                  insertGeneratedContent(c, element, style, "footnote-call", children, info);</span><br>     1400-&gt;U:  <span style="background-color: yellow">      </span><br>     1401-&gt;U:  <span style="background-color: yellow"> 99+                  BlockBox footnoteBody = createFootnoteBody(c, element, style);</span><br>     1402-&gt;U:  <span style="background-color: yellow">      </span><br>     1403-&gt;U:  <span style="background-color: yellow">                      // This is purely a marker box for the footnote so we</span><br>     1404-&gt;U:  <span style="background-color: yellow">                      // can figure out in layout when to add the footnote body.</span><br>     1405-&gt;U:  <span style="background-color: yellow"> 99+                  InlineBox iB = createInlineBox("", parent, context.parentStyle, null);</span><br>     1406-&gt;U:  <span style="background-color: yellow"> 99+                  iB.setStartsHere(true);</span><br>     1407-&gt;U:  <span style="background-color: yellow"> 99+                  iB.setEndsHere(true);</span><br>     1408-&gt;U:  <span style="background-color: yellow"> 99+                  iB.setFootnote(footnoteBody);</span><br>     1409-&gt;U:  <span style="background-color: yellow">      </span><br>     1410-&gt;U:  <span style="background-color: yellow"> 99+                  children.add(iB);</span><br>     1411-&gt;U:  <span style="background-color: yellow">      </span><br>     1412-&gt;U:  <span style="background-color: yellow"> 99+                  return;</span><br>     1413-&gt;U:  <span style="background-color: yellow">                  } else {</span><br>     1414-&gt;U:  <span style="background-color: yellow">   5                  logInvalidFootnoteStyle(c, element, style);</span><br>     1415-&gt;U:  <span style="background-color: yellow">                  }</span><br>     1416-&gt;U:  <span style="background-color: yellow">              }</span><br>     1417-&gt;U:  <span style="background-color: yellow">      </span><br>     1418-&gt;U:  <span style="background-color: yellow"> 99+          if (style.isInline()) {</span><br>     1419-&gt;U:  <span style="background-color: yellow"> 99+              createInlineChildren(c, parent, children, info, context, element);</span><br>     1420-&gt;U:  <span style="background-color: yellow">              } else {</span><br>     1421-&gt;U:  <span style="background-color: yellow"> 99+              child = createChildBlockBox(c, info, element, style);</span><br>     1422-&gt;U:  <span style="background-color: yellow">              }</span><br>     1423-&gt;U:  <span style="background-color: yellow">      </span><br>     1424-&gt;U:  <span style="background-color: yellow"> 99+          if (child != null) {</span><br>     1425-&gt;U:  <span style="background-color: yellow"> 99+              children.add(child);</span><br>     1426-&gt;U:  <span style="background-color: yellow">              }</span><br>     1427-&gt;U:  <span style="background-color: yellow">          }</span><br>     1428-&gt;N:  <span style="background-color: white">      </span><br>     1429-&gt;U:  <span style="background-color: yellow"> 99+      private static void createInlineChildren(</span><br>     1430-&gt;U:  <span style="background-color: yellow">                  LayoutContext c,</span><br>     1431-&gt;U:  <span style="background-color: yellow">                  Element parent,</span><br>     1432-&gt;U:  <span style="background-color: yellow">                  List
       <styleable>
         children,
       </styleable></span><br>     1433-&gt;U:  <span style="background-color: yellow">                  ChildBoxInfo info,</span><br>     1434-&gt;U:  <span style="background-color: yellow">                  CreateChildrenContext context,</span><br>     1435-&gt;U:  <span style="background-color: yellow">                  Element element) {</span><br>     1436-&gt;U:  <span style="background-color: yellow">      </span><br>     1437-&gt;U:  <span style="background-color: yellow"> 99+          if (context.needStartText) {</span><br>     1438-&gt;U:  <span style="background-color: yellow">  51              context.needStartText = false;</span><br>     1439-&gt;U:  <span style="background-color: yellow">  51              InlineBox iB = createInlineBox("", parent, context.parentStyle, null);</span><br>     1440-&gt;U:  <span style="background-color: yellow">  51              iB.setStartsHere(true);</span><br>     1441-&gt;U:  <span style="background-color: yellow">  51              iB.setEndsHere(false);</span><br>     1442-&gt;U:  <span style="background-color: yellow">  51              children.add(iB);</span><br>     1443-&gt;U:  <span style="background-color: yellow">  51              context.previousIB = iB;</span><br>     1444-&gt;U:  <span style="background-color: yellow">              }</span><br>     1445-&gt;U:  <span style="background-color: yellow">      </span><br>     1446-&gt;U:  <span style="background-color: yellow"> 99+          createChildren(c, null, element, children, info, true);</span><br>     1447-&gt;U:  <span style="background-color: yellow">      </span><br>     1448-&gt;U:  <span style="background-color: yellow"> 99+          if (context.inline) {</span><br>     1449-&gt;U:  <span style="background-color: yellow">  80              if (context.previousIB != null) {</span><br>     1450-&gt;U:  <span style="background-color: yellow">  80                  context.previousIB.setEndsHere(false);</span><br>     1451-&gt;U:  <span style="background-color: yellow">                  }</span><br>     1452-&gt;U:  <span style="background-color: yellow">  80              context.needEndText = true;</span><br>     1453-&gt;U:  <span style="background-color: yellow">              }</span><br>     1454-&gt;U:  <span style="background-color: yellow">          }</span><br>     1455-&gt;N:  <span style="background-color: white">      </span><br>     1456-&gt;U:  <span style="background-color: yellow"> 99+      private static Styleable createChildBlockBox(</span><br>     1457-&gt;U:  <span style="background-color: yellow">                  LayoutContext c, ChildBoxInfo info, Element element, CalculatedStyle style) {</span><br>     1458-&gt;U:  <span style="background-color: yellow">      </span><br>     1459-&gt;U:  <span style="background-color: yellow"> 99+          Styleable child;</span><br>     1460-&gt;U:  <span style="background-color: yellow">      </span><br>     1461-&gt;U:  <span style="background-color: yellow"> 99+          if (style.hasColumns() &amp;&amp; c.isPrint()) {</span><br>     1462-&gt;U:  <span style="background-color: yellow">   8              child = new FlowingColumnContainerBox();</span><br>     1463-&gt;U:  <span style="background-color: yellow">              } else {</span><br>     1464-&gt;U:  <span style="background-color: yellow"> 99+              child = createBlockBox(style, info, false);</span><br>     1465-&gt;U:  <span style="background-color: yellow">              }</span><br>     1466-&gt;U:  <span style="background-color: yellow">      </span><br>     1467-&gt;U:  <span style="background-color: yellow"> 99+          child.setStyle(style);</span><br>     1468-&gt;U:  <span style="background-color: yellow"> 99+          child.setElement(element);</span><br>     1469-&gt;U:  <span style="background-color: yellow">      </span><br>     1470-&gt;U:  <span style="background-color: yellow"> 99+          if (style.hasColumns() &amp;&amp; c.isPrint()) {</span><br>     1471-&gt;U:  <span style="background-color: yellow">   8              createColumnContainer(c, child, element, style);</span><br>     1472-&gt;U:  <span style="background-color: yellow">              }</span><br>     1473-&gt;U:  <span style="background-color: yellow">      </span><br>     1474-&gt;U:  <span style="background-color: yellow"> 99+          if (style.isListItem()) {</span><br>     1475-&gt;U:  <span style="background-color: yellow"> 99+              BlockBox block = (BlockBox) child;</span><br>     1476-&gt;U:  <span style="background-color: yellow"> 99+              block.setListCounter(c.getCounterContext(style).getCurrentCounterValue("list-item"));</span><br>     1477-&gt;U:  <span style="background-color: yellow">              }</span><br>     1478-&gt;U:  <span style="background-color: yellow">      </span><br>     1479-&gt;U:  <span style="background-color: yellow"> 99+          if (style.isTable() || style.isInlineTable()) {</span><br>     1480-&gt;U:  <span style="background-color: yellow"> 99+              TableBox table = (TableBox) child;</span><br>     1481-&gt;U:  <span style="background-color: yellow"> 99+              table.ensureChildren(c);</span><br>     1482-&gt;U:  <span style="background-color: yellow">      </span><br>     1483-&gt;U:  <span style="background-color: yellow"> 99+              child = reorderTableContent(c, table);</span><br>     1484-&gt;U:  <span style="background-color: yellow">              }</span><br>     1485-&gt;U:  <span style="background-color: yellow">      </span><br>     1486-&gt;U:  <span style="background-color: yellow"> 99+          if (!info.isContainsBlockLevelContent()</span><br>     1487-&gt;U:  <span style="background-color: yellow">                      &amp;&amp; !style.isLayedOutInInlineContext()) {</span><br>     1488-&gt;U:  <span style="background-color: yellow"> 99+              info.setContainsBlockLevelContent(true);</span><br>     1489-&gt;U:  <span style="background-color: yellow">              }</span><br>     1490-&gt;U:  <span style="background-color: yellow">      </span><br>     1491-&gt;U:  <span style="background-color: yellow"> 99+          BlockBox block = (BlockBox) child;</span><br>     1492-&gt;U:  <span style="background-color: yellow">      </span><br>     1493-&gt;U:  <span style="background-color: yellow"> 99+          if (block.getStyle().mayHaveFirstLine()) {</span><br>     1494-&gt;U:  <span style="background-color: yellow"> 99+              block.setFirstLineStyle(c.getCss().getPseudoElementStyle(element,</span><br>     1495-&gt;U:  <span style="background-color: yellow">                          "first-line"));</span><br>     1496-&gt;U:  <span style="background-color: yellow">              }</span><br>     1497-&gt;U:  <span style="background-color: yellow"> 99+          if (block.getStyle().mayHaveFirstLetter()) {</span><br>     1498-&gt;U:  <span style="background-color: yellow"> 99+              block.setFirstLetterStyle(c.getCss().getPseudoElementStyle(element,</span><br>     1499-&gt;U:  <span style="background-color: yellow">                          "first-letter"));</span><br>     1500-&gt;U:  <span style="background-color: yellow">              }</span><br>     1501-&gt;U:  <span style="background-color: yellow">      </span><br>     1502-&gt;U:  <span style="background-color: yellow">              // I think we need to do this to evaluate counters correctly</span><br>     1503-&gt;U:  <span style="background-color: yellow"> 99+          block.ensureChildren(c);</span><br>     1504-&gt;U:  <span style="background-color: yellow"> 99+          return child;</span><br>     1505-&gt;U:  <span style="background-color: yellow">          }</span><br>     1506-&gt;N:  <span style="background-color: white">      </span><br>     1507-&gt;N:  <span style="background-color: white">          /**</span><br>     1508-&gt;N:  <span style="background-color: white">           * Creates the footnote body to put at the bottom of the page inside a</span><br>     1509-&gt;N:  <span style="background-color: white">           * page's footnote area.</span><br>     1510-&gt;N:  <span style="background-color: white">           */</span><br>     1511-&gt;U:  <span style="background-color: yellow"> 99+      private static BlockBox createFootnoteBody(</span><br>     1512-&gt;U:  <span style="background-color: yellow">                  LayoutContext c, Element element, CalculatedStyle style) {</span><br>     1513-&gt;U:  <span style="background-color: yellow">      </span><br>     1514-&gt;U:  <span style="background-color: yellow"> 99+          List
       <styleable>
         footnoteChildren = new ArrayList&lt;&gt;();
       </styleable></span><br>     1515-&gt;U:  <span style="background-color: yellow"> 99+          ChildBoxInfo footnoteChildInfo = new ChildBoxInfo();</span><br>     1516-&gt;U:  <span style="background-color: yellow">      </span><br>     1517-&gt;U:  <span style="background-color: yellow">              // Create the out-of-flow footnote-body box as a block box.</span><br>     1518-&gt;U:  <span style="background-color: yellow"> 99+          BlockBox footnoteBody = new BlockBox();</span><br>     1519-&gt;U:  <span style="background-color: yellow"> 99+          CalculatedStyle footnoteBodyStyle = style.createAnonymousStyle(IdentValue.BLOCK);</span><br>     1520-&gt;U:  <span style="background-color: yellow">      </span><br>     1521-&gt;U:  <span style="background-color: yellow">              // Create a dummy element for the footnote-body.</span><br>     1522-&gt;U:  <span style="background-color: yellow"> 99+          Element fnBodyElement = element.getOwnerDocument().createElement("fs-footnote-body");</span><br>     1523-&gt;U:  <span style="background-color: yellow"> 99+          c.getRootLayer().getMaster().getElement().appendChild(fnBodyElement);</span><br>     1524-&gt;U:  <span style="background-color: yellow">      </span><br>     1525-&gt;U:  <span style="background-color: yellow"> 99+          footnoteBody.setElement(fnBodyElement);</span><br>     1526-&gt;U:  <span style="background-color: yellow"> 99+          footnoteBody.setStyle(footnoteBodyStyle);</span><br>     1527-&gt;U:  <span style="background-color: yellow">      </span><br>     1528-&gt;U:  <span style="background-color: yellow">              // This will be set to the same as the footnote area when we add it to the page.</span><br>     1529-&gt;U:  <span style="background-color: yellow"> 99+          footnoteBody.setContainingBlock(null);</span><br>     1530-&gt;U:  <span style="background-color: yellow">      </span><br>     1531-&gt;U:  <span style="background-color: yellow">              // Create an isolated layer for now. This will be changed to the footnote area</span><br>     1532-&gt;U:  <span style="background-color: yellow">              // layer when we add this footnote body to a page.</span><br>     1533-&gt;U:  <span style="background-color: yellow"> 99+          Layer layer = new Layer(footnoteBody, c, true);</span><br>     1534-&gt;U:  <span style="background-color: yellow">      </span><br>     1535-&gt;U:  <span style="background-color: yellow"> 99+          footnoteBody.setLayer(layer);</span><br>     1536-&gt;U:  <span style="background-color: yellow"> 99+          footnoteBody.setContainingLayer(layer);</span><br>     1537-&gt;U:  <span style="background-color: yellow">      </span><br>     1538-&gt;U:  <span style="background-color: yellow"> 99+          c.pushLayer(layer);</span><br>     1539-&gt;U:  <span style="background-color: yellow"> 99+          c.setIsInFloatBottom(true);</span><br>     1540-&gt;U:  <span style="background-color: yellow">      </span><br>     1541-&gt;U:  <span style="background-color: yellow"> 99+          CreateChildrenContext context = new CreateChildrenContext(false, false, style.getParent(), false);</span><br>     1542-&gt;U:  <span style="background-color: yellow"> 99+          createElementChild(c, (Element) element.getParentNode(), footnoteBody, element, footnoteChildren, footnoteChildInfo, context);</span><br>     1543-&gt;U:  <span style="background-color: yellow"> 99+          resolveChildren(c, footnoteBody, footnoteChildren, footnoteChildInfo);</span><br>     1544-&gt;U:  <span style="background-color: yellow">      </span><br>     1545-&gt;U:  <span style="background-color: yellow"> 99+          c.setFootnoteAllowed(true);</span><br>     1546-&gt;U:  <span style="background-color: yellow"> 99+          c.setIsInFloatBottom(false);</span><br>     1547-&gt;U:  <span style="background-color: yellow"> 99+          c.popLayer();</span><br>     1548-&gt;U:  <span style="background-color: yellow">      </span><br>     1549-&gt;U:  <span style="background-color: yellow">      //        System.out.println();</span><br>     1550-&gt;U:  <span style="background-color: yellow">      //        System.out.println(com.openhtmltopdf.util.LambdaUtil.descendantDump(footnoteBody));</span><br>     1551-&gt;U:  <span style="background-color: yellow">      //        System.out.println();</span><br>     1552-&gt;U:  <span style="background-color: yellow">      </span><br>     1553-&gt;U:  <span style="background-color: yellow"> 99+          return footnoteBody;</span><br>     1554-&gt;U:  <span style="background-color: yellow">          }</span><br>     1555-&gt;N:  <span style="background-color: white">      </span><br>     1556-&gt;U:  <span style="background-color: yellow">   8      private static void createColumnContainer(</span><br>     1557-&gt;U:  <span style="background-color: yellow">               LayoutContext c, Styleable child, Element element, CalculatedStyle style) {</span><br>     1558-&gt;U:  <span style="background-color: yellow">      </span><br>     1559-&gt;U:  <span style="background-color: yellow">   8          FlowingColumnContainerBox cont = (FlowingColumnContainerBox) child;</span><br>     1560-&gt;U:  <span style="background-color: yellow">   8          cont.setOnlyChild(c, new FlowingColumnBox(cont));</span><br>     1561-&gt;U:  <span style="background-color: yellow">   8          cont.getChild().setStyle(style.createAnonymousStyle(IdentValue.BLOCK));</span><br>     1562-&gt;U:  <span style="background-color: yellow">   8          cont.getChild().setElement(element);</span><br>     1563-&gt;U:  <span style="background-color: yellow">   8          cont.getChild().ensureChildren(c);</span><br>     1564-&gt;U:  <span style="background-color: yellow">          }</span><br>     1565-&gt;N:  <span style="background-color: white">      </span><br>     1566-&gt;U:  <span style="background-color: yellow"> 99+      private static void resolveElementCounters(</span><br>     1567-&gt;U:  <span style="background-color: yellow">               LayoutContext c, Node working, Element element, CalculatedStyle style) {</span><br>     1568-&gt;U:  <span style="background-color: yellow">      </span><br>     1569-&gt;U:  <span style="background-color: yellow"> 99+          Integer attrValue = null;</span><br>     1570-&gt;U:  <span style="background-color: yellow">      </span><br>     1571-&gt;U:  <span style="background-color: yellow"> 99+          if ("ol".equals(working.getNodeName()) &amp;&amp; element.hasAttribute("start")) {</span><br>     1572-&gt;U:  <span style="background-color: yellow">   0              attrValue = OpenUtil.parseIntegerOrNull(element.getAttribute("start"));</span><br>     1573-&gt;U:  <span style="background-color: yellow"> 99+          } else if ("li".equals(working.getNodeName()) &amp;&amp; element.hasAttribute("value")) {</span><br>     1574-&gt;U:  <span style="background-color: yellow">   0              attrValue = OpenUtil.parseIntegerOrNull(element.getAttribute("value"));</span><br>     1575-&gt;U:  <span style="background-color: yellow">              }</span><br>     1576-&gt;U:  <span style="background-color: yellow">      </span><br>     1577-&gt;U:  <span style="background-color: yellow"> 99+          if (attrValue != null) {</span><br>     1578-&gt;U:  <span style="background-color: yellow">   0              c.resolveCounters(style, attrValue - 1);</span><br>     1579-&gt;U:  <span style="background-color: yellow">              } else {</span><br>     1580-&gt;U:  <span style="background-color: yellow"> 99+              c.resolveCounters(style, null);</span><br>     1581-&gt;U:  <span style="background-color: yellow">              }</span><br>     1582-&gt;U:  <span style="background-color: yellow">          }</span><br>     1583-&gt;N:  <span style="background-color: white">      </span><br>     1584-&gt;U:  <span style="background-color: yellow"> 99+      private static void createChildren(</span><br>     1585-&gt;U:  <span style="background-color: yellow">                  LayoutContext c, BlockBox blockParent, Element parent,</span><br>     1586-&gt;U:  <span style="background-color: yellow">                  List
       <styleable>
         children, ChildBoxInfo info, boolean inline) {
       </styleable></span><br>     1587-&gt;U:  <span style="background-color: yellow">      </span><br>     1588-&gt;U:  <span style="background-color: yellow"> 99+          if (isInsertedBoxIgnored(parent)) {</span><br>     1589-&gt;U:  <span style="background-color: yellow"> 99+              return;</span><br>     1590-&gt;U:  <span style="background-color: yellow">              }</span><br>     1591-&gt;U:  <span style="background-color: yellow">      </span><br>     1592-&gt;U:  <span style="background-color: yellow"> 99+          SharedContext sharedContext = c.getSharedContext();</span><br>     1593-&gt;U:  <span style="background-color: yellow"> 99+          CalculatedStyle parentStyle = sharedContext.getStyle(parent);</span><br>     1594-&gt;U:  <span style="background-color: yellow">      </span><br>     1595-&gt;U:  <span style="background-color: yellow"> 99+          insertGeneratedContent(c, parent, parentStyle, "before", children, info);</span><br>     1596-&gt;U:  <span style="background-color: yellow">      </span><br>     1597-&gt;U:  <span style="background-color: yellow"> 99+          if (parentStyle.isFootnote()) {</span><br>     1598-&gt;U:  <span style="background-color: yellow"> 99+              if (c.isFootnoteAllowed() &amp;&amp; isValidFootnote(c, parent, parentStyle)) {</span><br>     1599-&gt;U:  <span style="background-color: yellow"> 99+                  insertGeneratedContent(c, parent, parentStyle, "footnote-marker", children, info);</span><br>     1600-&gt;U:  <span style="background-color: yellow">                      // Ban further footnote content until we bubble back up to createFootnoteBody.</span><br>     1601-&gt;U:  <span style="background-color: yellow"> 99+                  c.setFootnoteAllowed(false);</span><br>     1602-&gt;U:  <span style="background-color: yellow">  13              } else if (!c.isFootnoteAllowed()) {</span><br>     1603-&gt;U:  <span style="background-color: yellow">  11                  XRLog.log(Level.WARNING, LogMessageId.LogMessageId0Param.GENERAL_NO_FOOTNOTES_INSIDE_FOOTNOTES);</span><br>     1604-&gt;U:  <span style="background-color: yellow">                  }</span><br>     1605-&gt;U:  <span style="background-color: yellow">              }</span><br>     1606-&gt;U:  <span style="background-color: yellow">      </span><br>     1607-&gt;U:  <span style="background-color: yellow"> 99+          Node working = parent.getFirstChild();</span><br>     1608-&gt;U:  <span style="background-color: yellow"> 99+          CreateChildrenContext context = null;</span><br>     1609-&gt;U:  <span style="background-color: yellow">      </span><br>     1610-&gt;U:  <span style="background-color: yellow"> 99+          if (working != null) {</span><br>     1611-&gt;U:  <span style="background-color: yellow"> 99+              context = new CreateChildrenContext(inline, inline, parentStyle, inline);</span><br>     1612-&gt;U:  <span style="background-color: yellow">      </span><br>     1613-&gt;U:  <span style="background-color: yellow"> 99+              do {</span><br>     1614-&gt;U:  <span style="background-color: yellow"> 99+                  short nodeType = working.getNodeType();</span><br>     1615-&gt;U:  <span style="background-color: yellow">      </span><br>     1616-&gt;U:  <span style="background-color: yellow"> 99+                  if (nodeType == Node.ELEMENT_NODE) {</span><br>     1617-&gt;U:  <span style="background-color: yellow"> 99+                      createElementChild(</span><br>     1618-&gt;U:  <span style="background-color: yellow">                                  c, parent, blockParent, working, children, info, context);</span><br>     1619-&gt;U:  <span style="background-color: yellow"> 99+                  } else if (nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE) {</span><br>     1620-&gt;U:  <span style="background-color: yellow"> 99+                      context.needStartText = false;</span><br>     1621-&gt;U:  <span style="background-color: yellow"> 99+                      context.needEndText = false;</span><br>     1622-&gt;U:  <span style="background-color: yellow">      </span><br>     1623-&gt;U:  <span style="background-color: yellow"> 99+                      Text textNode = (Text) working;</span><br>     1624-&gt;U:  <span style="background-color: yellow">      </span><br>     1625-&gt;U:  <span style="background-color: yellow">                          // Ignore the text belonging to a textarea.</span><br>     1626-&gt;U:  <span style="background-color: yellow"> 99+                      if (!textNode.getParentNode().getNodeName().equals("textarea")) {</span><br>     1627-&gt;U:  <span style="background-color: yellow"> 99+                          context.previousIB = doBidi(c, textNode, parent, parentStyle, context.previousIB, children);</span><br>     1628-&gt;U:  <span style="background-color: yellow">                          }</span><br>     1629-&gt;U:  <span style="background-color: yellow">                      }</span><br>     1630-&gt;U:  <span style="background-color: yellow">   0              } while ((working = working.getNextSibling()) != null);</span><br>     1631-&gt;U:  <span style="background-color: yellow">              }</span><br>     1632-&gt;U:  <span style="background-color: yellow">      </span><br>     1633-&gt;U:  <span style="background-color: yellow"> 99+          boolean needStartText = context != null ? context.needStartText : inline;</span><br>     1634-&gt;U:  <span style="background-color: yellow"> 99+          boolean needEndText = context != null ? context.needEndText : inline;</span><br>     1635-&gt;U:  <span style="background-color: yellow">      </span><br>     1636-&gt;U:  <span style="background-color: yellow"> 99+          if (needStartText || needEndText) {</span><br>     1637-&gt;U:  <span style="background-color: yellow"> 99+              InlineBox iB = createInlineBox("", parent, parentStyle, null);</span><br>     1638-&gt;U:  <span style="background-color: yellow"> 99+              iB.setStartsHere(needStartText);</span><br>     1639-&gt;U:  <span style="background-color: yellow"> 99+              iB.setEndsHere(needEndText);</span><br>     1640-&gt;U:  <span style="background-color: yellow"> 99+              children.add(iB);</span><br>     1641-&gt;U:  <span style="background-color: yellow">              }</span><br>     1642-&gt;U:  <span style="background-color: yellow">      </span><br>     1643-&gt;U:  <span style="background-color: yellow"> 99+          insertGeneratedContent(c, parent, parentStyle, "after", children, info);</span><br>     1644-&gt;U:  <span style="background-color: yellow">          }</span><br>     1645-&gt;N:  <span style="background-color: white">      </span><br>  1646-&gt;1272:  <span style="background-color: cyan"> 99+      private static InlineBox setupInlineChild(InlineBox child, InlineBox previousIB) {</span><br>  1647-&gt;1273:  <span style="background-color: cyan"> 99+          child.setEndsHere(true);</span><br>     1648-&gt;N:  <span style="background-color: white">              </span><br>  1649-&gt;1275:  <span style="background-color: cyan"> 99+          if (previousIB == null) {</span><br>  1650-&gt;1276:  <span style="background-color: cyan"> 99+              child.setStartsHere(true);</span><br>     1651-&gt;N:  <span style="background-color: white">              } else {</span><br>  1652-&gt;1278:  <span style="background-color: cyan"> 99+              previousIB.setEndsHere(false);</span><br>     1653-&gt;N:  <span style="background-color: white">              }</span><br>     1654-&gt;N:  <span style="background-color: white">              </span><br>  1655-&gt;1281:  <span style="background-color: cyan"> 99+          return child;</span><br>     1656-&gt;N:  <span style="background-color: white">          }</span><br>     1657-&gt;N:  <span style="background-color: white">          </span><br>  1658-&gt;1284:  <span style="background-color: cyan"> 99+      private static InlineBox doFakeBidi(LayoutContext c, Text textNode, Element parent, CalculatedStyle parentStyle, InlineBox previousIB, List
       <styleable>
         children) {
       </styleable></span><br>  1659-&gt;1285:  <span style="background-color: cyan"> 99+      	String runText = textNode.getData();</span><br>  1660-&gt;1286:  <span style="background-color: cyan"> 99+      	InlineBox child = createInlineBox(runText, parent, parentStyle, textNode);</span><br>  1661-&gt;1287:  <span style="background-color: cyan"> 99+      	child.setTextDirection(BidiSplitter.LTR);</span><br>  1662-&gt;1288:  <span style="background-color: cyan"> 99+      	previousIB = setupInlineChild(child, previousIB);</span><br>  1663-&gt;1289:  <span style="background-color: cyan"> 99+         	children.add(child);</span><br>  1664-&gt;1290:  <span style="background-color: cyan"> 99+         	return previousIB;</span><br>     1665-&gt;N:  <span style="background-color: white">          }</span><br>     1666-&gt;N:  <span style="background-color: white">          </span><br>     1667-&gt;N:  <span style="background-color: white">          </span><br>     1668-&gt;N:  <span style="background-color: white">          /**</span><br>     1669-&gt;N:  <span style="background-color: white">           * Attempts to divide a Text node further into directional text runs, either LTR or RTL. </span><br>     1670-&gt;N:  <span style="background-color: white">           * @param c</span><br>     1671-&gt;N:  <span style="background-color: white">           * @param textNode</span><br>     1672-&gt;N:  <span style="background-color: white">           * @param parent</span><br>     1673-&gt;N:  <span style="background-color: white">           * @param parentStyle</span><br>     1674-&gt;N:  <span style="background-color: white">           * @return the previousIB.</span><br>     1675-&gt;N:  <span style="background-color: white">           */</span><br>  1676-&gt;1302:  <span style="background-color: cyan"> 99+      private static InlineBox doBidi(LayoutContext c, Text textNode, Element parent, CalculatedStyle parentStyle, InlineBox previousIB, List
       <styleable>
         children) {
       </styleable></span><br>     1677-&gt;N:  <span style="background-color: white">          	</span><br>  1678-&gt;1304:  <span style="background-color: cyan"> 99+          Paragraph para = c.getParagraphSplitter().lookupParagraph(textNode);</span><br>  1679-&gt;1305:  <span style="background-color: cyan"> 99+          if (para == null) {</span><br>     1680-&gt;N:  <span style="background-color: white">              	// Must be no implementation of BIDI for this Text node.</span><br>  1681-&gt;1307:  <span style="background-color: white">   0          	return doFakeBidi(c, textNode, parent, parentStyle, previousIB, children);</span><br>     1682-&gt;N:  <span style="background-color: white">              }</span><br>     1683-&gt;N:  <span style="background-color: white">              </span><br>  1684-&gt;1310:  <span style="background-color: cyan"> 99+          int startIndex = para.getFirstCharIndexInParagraph(textNode); // Index into the paragraph.</span><br>     1685-&gt;N:  <span style="background-color: white">              </span><br>  1686-&gt;1312:  <span style="background-color: cyan"> 99+          if (startIndex &lt; 0) {</span><br>     1687-&gt;N:  <span style="background-color: white">              	// Must be a fake implementation of BIDI.</span><br>  1688-&gt;1314:  <span style="background-color: cyan"> 99+          	return doFakeBidi(c, textNode, parent, parentStyle, previousIB, children);</span><br>     1689-&gt;N:  <span style="background-color: white">              }</span><br>     1690-&gt;N:  <span style="background-color: white">              </span><br>  1691-&gt;1317:  <span style="background-color: white"> 99+          int nodeIndex = 0;                                            // Index into the text node.</span><br>  1692-&gt;1318:  <span style="background-color: white"> 99+          String runText;                                               // Calculated text for the directional run.</span><br>     1693-&gt;N:  <span style="background-color: white">              </span><br>  1694-&gt;1320:  <span style="background-color: white"> 99+          BidiTextRun prevSplit = para.prevSplit(startIndex); // Get directional run at or before startIndex.</span><br>     1695-&gt;N:  <span style="background-color: white">              	</span><br>  1696-&gt;1322:  <span style="background-color: white"> 99+          assert(prevSplit != null);                  // There should always be a split at zero (start of paragraph) to fall back on. </span><br>  1697-&gt;1323:  <span style="background-color: white"> 99+          assert(prevSplit.getStart() &lt;= startIndex); // Split should always be before or at the start of this text node.</span><br>     1698-&gt;N:  <span style="background-color: white">      </span><br>     1699-&gt;N:  <span style="background-color: white">              // When calculating length, remember that it may overlap the start and/or end of the text node.</span><br>  1700-&gt;1326:  <span style="background-color: white"> 99+          int maxRunLength = prevSplit.getLength() - (startIndex - prevSplit.getStart());</span><br>  1701-&gt;1327:  <span style="background-color: white"> 99+         	int splitLength = Math.min(maxRunLength, textNode.getLength());</span><br>     1702-&gt;N:  <span style="background-color: white">              </span><br>     1703-&gt;N:  <span style="background-color: white">             	// Advance char indexes.</span><br>  1704-&gt;1330:  <span style="background-color: white"> 99+         	nodeIndex += splitLength;</span><br>  1705-&gt;1331:  <span style="background-color: white"> 99+         	startIndex += splitLength;</span><br>     1706-&gt;N:  <span style="background-color: white">             	</span><br>  1707-&gt;1333:  <span style="background-color: white"> 99+         	assert(prevSplit.getDirection() == BidiSplitter.LTR || prevSplit.getDirection() == BidiSplitter.RTL);</span><br>     1708-&gt;N:  <span style="background-color: white">      </span><br>  1709-&gt;1335:  <span style="background-color: white"> 99+         	if (splitLength == textNode.getLength()) {</span><br>     1710-&gt;N:  <span style="background-color: white">             		// The simple case: the entire text node is part of a single direction run.</span><br>  1711-&gt;1337:  <span style="background-color: white"> 99+         		runText = textNode.getData();</span><br>     1712-&gt;N:  <span style="background-color: white">             	}</span><br>     1713-&gt;N:  <span style="background-color: white">             	else {</span><br>     1714-&gt;N:  <span style="background-color: white">             		// The complex case: the first directional run only encompasses part of the text node. </span><br>  1715-&gt;1341:  <span style="background-color: white">   6         		runText = textNode.getData().substring(0, nodeIndex);</span><br>     1716-&gt;N:  <span style="background-color: white">             	}</span><br>     1717-&gt;N:  <span style="background-color: white">             	</span><br>     1718-&gt;N:  <span style="background-color: white">      		// Shape here, so the layout will get the right visual length for the run.</span><br>  1719-&gt;1345:  <span style="background-color: white"> 99+  		if (prevSplit.getDirection() == BidiSplitter.RTL) {</span><br>  1720-&gt;1346:  <span style="background-color: white">  34  			runText = c.getBidiReorderer().shapeText(runText);</span><br>     1721-&gt;N:  <span style="background-color: white">      		}</span><br>     1722-&gt;N:  <span style="background-color: white">      </span><br>  1723-&gt;1349:  <span style="background-color: white"> 99+         	InlineBox child = createInlineBox(runText, parent, parentStyle, textNode);</span><br>  1724-&gt;1350:  <span style="background-color: white"> 99+         	child.setTextDirection(prevSplit.getDirection());</span><br>  1725-&gt;1351:  <span style="background-color: white"> 99+         	previousIB = setupInlineChild(child, previousIB);</span><br>  1726-&gt;1352:  <span style="background-color: white"> 99+         	children.add(child);</span><br>     1727-&gt;N:  <span style="background-color: white">             	</span><br>  1728-&gt;1354:  <span style="background-color: white"> 99+         	if (splitLength != textNode.getLength()) {</span><br>     1729-&gt;N:  <span style="background-color: white">             		// We have more directional runs to extract.</span><br>     1730-&gt;N:  <span style="background-color: white">             		</span><br>     1731-&gt;N:  <span style="background-color: white">   6         		do {</span><br>  1732-&gt;1358:  <span style="background-color: white">  30          		BidiTextRun newSplit = para.nextSplit(startIndex);</span><br>  1733-&gt;1359:  <span style="background-color: white">  30          		assert(newSplit != null); // There should always be enough splits to completely cover the text node.</span><br>     1734-&gt;N:  <span style="background-color: white">              		</span><br>  1735-&gt;1361:  <span style="background-color: white">  30          		int newLength;</span><br>     1736-&gt;N:  <span style="background-color: white">              		</span><br>  1737-&gt;1363:  <span style="background-color: white">  30          		if (newSplit != null) {</span><br>     1738-&gt;N:  <span style="background-color: white">              			// When calculating length, remember that it may overlap the start and/or end of the text node.</span><br>  1739-&gt;1365:  <span style="background-color: white">  30          			int newMaxRunLength = newSplit.getLength() - (startIndex - newSplit.getStart());</span><br>  1740-&gt;1366:  <span style="background-color: white">  30          			newLength = Math.min(newMaxRunLength, textNode.getLength() - nodeIndex);</span><br>     1741-&gt;N:  <span style="background-color: white">              			</span><br>  1742-&gt;1368:  <span style="background-color: white">  30          			runText = textNode.getData().substring(nodeIndex, nodeIndex + newLength);</span><br>     1743-&gt;N:  <span style="background-color: white">              			</span><br>     1744-&gt;N:  <span style="background-color: white">              			// Shape here, so the layout will get the right visual length for the run.</span><br>  1745-&gt;1371:  <span style="background-color: white">  30          			if (newSplit.getDirection() == BidiSplitter.RTL) {</span><br>  1746-&gt;1372:  <span style="background-color: white">  15          				runText = c.getBidiReorderer().shapeText(runText);</span><br>     1747-&gt;N:  <span style="background-color: white">              			}</span><br>     1748-&gt;N:  <span style="background-color: white">              			</span><br>  1749-&gt;1375:  <span style="background-color: white">  30          			startIndex += newLength;</span><br>  1750-&gt;1376:  <span style="background-color: white">  30          			nodeIndex += newLength;</span><br>     1751-&gt;N:  <span style="background-color: white">              			</span><br>  1752-&gt;1378:  <span style="background-color: white">  30          			child = createInlineBox(runText, parent, parentStyle, textNode);</span><br>  1753-&gt;1379:  <span style="background-color: white">  30          			child.setTextDirection(newSplit.getDirection());</span><br>  1754-&gt;1380:  <span style="background-color: white">  30          	       	previousIB = setupInlineChild(child, previousIB);</span><br>  1755-&gt;1381:  <span style="background-color: white">  30          	       	children.add(child);</span><br>     1756-&gt;N:  <span style="background-color: white">              		}</span><br>     1757-&gt;N:  <span style="background-color: white">              		else {</span><br>     1758-&gt;N:  <span style="background-color: white">              			// We should never get here, but handle it just in case.</span><br>     1759-&gt;N:  <span style="background-color: white">              			</span><br>  1760-&gt;1386:  <span style="background-color: white">   0          			newLength = textNode.getLength() - nodeIndex;</span><br>  1761-&gt;1387:  <span style="background-color: white">   0          			runText = textNode.getData().substring(nodeIndex, newLength);</span><br>     1762-&gt;N:  <span style="background-color: white">              			</span><br>  1763-&gt;1389:  <span style="background-color: white">   0          			child = createInlineBox(runText, parent, parentStyle, textNode);</span><br>  1764-&gt;1390:  <span style="background-color: white">   0          			child.setTextDirection(c.getDefaultTextDirection());</span><br>  1765-&gt;1391:  <span style="background-color: white">   0          	       	previousIB = setupInlineChild(child, previousIB);</span><br>  1766-&gt;1392:  <span style="background-color: white">   0          	       	children.add(child);</span><br>     1767-&gt;N:  <span style="background-color: white">      </span><br>  1768-&gt;1394:  <span style="background-color: white">   0          			startIndex += newLength;</span><br>  1769-&gt;1395:  <span style="background-color: white">   0          			nodeIndex += newLength;</span><br>     1770-&gt;N:  <span style="background-color: white">              		}</span><br>  1771-&gt;1397:  <span style="background-color: white">  30          	} while(nodeIndex &lt; textNode.getLength());</span><br>     1772-&gt;N:  <span style="background-color: white">              }</span><br>     1773-&gt;N:  <span style="background-color: white">             	</span><br>  1774-&gt;1400:  <span style="background-color: white"> 99+         	return previousIB;</span><br>     1775-&gt;N:  <span style="background-color: white">          }</span><br>     1776-&gt;N:  <span style="background-color: white">          </span><br>  1777-&gt;1403:  <span style="background-color: cyan"> 99+      private static void insertAnonymousBlocks(</span><br>  1778-&gt;1404:  <span style="background-color: white">                  SharedContext c, Box parent, List
       <styleable>
         children, boolean layoutRunningBlocks) {
       </styleable></span><br>     1779-&gt;N:  <span style="background-color: white">      </span><br>  1780-&gt;1406:  <span style="background-color: cyan"> 99+          List
       <styleable>
         inline = new ArrayList&lt;&gt;();
       </styleable></span><br>  1781-&gt;1407:  <span style="background-color: cyan"> 99+          Deque
       <inlinebox>
         parents = new ArrayDeque&lt;&gt;();
       </inlinebox></span><br>  1782-&gt;1408:  <span style="background-color: cyan"> 99+          List
       <inlinebox>
         savedParents = null;
       </inlinebox></span><br>     1783-&gt;N:  <span style="background-color: white">      </span><br>  1784-&gt;1410:  <span style="background-color: cyan"> 99+          for (Styleable child : children) {</span><br>  1785-&gt;1411:  <span style="background-color: cyan"> 99+              if (child.getStyle().isLayedOutInInlineContext() &amp;&amp;</span><br>  1786-&gt;1412:  <span style="background-color: white">                          ! (layoutRunningBlocks &amp;&amp; child.getStyle().isRunning()) &amp;&amp;</span><br>  1787-&gt;1413:  <span style="background-color: white">                          !child.getStyle().isTableCell() //see issue https://github.com/danfickle/openhtmltopdf/issues/309</span><br>     1788-&gt;N:  <span style="background-color: white">                  ) {</span><br>  1789-&gt;1415:  <span style="background-color: cyan"> 99+                  inline.add(child);</span><br>     1790-&gt;N:  <span style="background-color: white">      </span><br>  1791-&gt;1417:  <span style="background-color: cyan"> 99+                  if (child.getStyle().isInline()) {</span><br>  1792-&gt;1418:  <span style="background-color: cyan"> 99+                      InlineBox iB = (InlineBox) child;</span><br>  1793-&gt;1419:  <span style="background-color: cyan"> 99+                      if (iB.isStartsHere()) {</span><br>  1794-&gt;1420:  <span style="background-color: cyan"> 99+                          parents.add(iB);</span><br>     1795-&gt;N:  <span style="background-color: white">                          }</span><br>  1796-&gt;1422:  <span style="background-color: cyan"> 99+                      if (iB.isEndsHere()) {</span><br>  1797-&gt;1423:  <span style="background-color: cyan"> 99+                          parents.removeLast();</span><br>     1798-&gt;N:  <span style="background-color: white">                          }</span><br>     1799-&gt;N:  <span style="background-color: white">                      }</span><br>     1800-&gt;N:  <span style="background-color: white">                  } else {</span><br>  1801-&gt;1427:  <span style="background-color: cyan"> 99+                  if (inline.size() &gt; 0) {</span><br>  1802-&gt;1428:  <span style="background-color: cyan"> 99+                      createAnonymousBlock(c, parent, inline, savedParents);</span><br>  1803-&gt;1429:  <span style="background-color: cyan"> 99+                      inline = new ArrayList&lt;&gt;();</span><br>  1804-&gt;1430:  <span style="background-color: cyan"> 99+                      savedParents = new ArrayList&lt;&gt;(parents);</span><br>     1805-&gt;N:  <span style="background-color: white">                      }</span><br>  1806-&gt;1432:  <span style="background-color: cyan"> 99+                  parent.addChild((Box) child);</span><br>     1807-&gt;N:  <span style="background-color: white">                  }</span><br>     1808-&gt;N:  <span style="background-color: white">              }</span><br>     1809-&gt;N:  <span style="background-color: white">      </span><br>  1810-&gt;1436:  <span style="background-color: cyan"> 99+          createAnonymousBlock(c, parent, inline, savedParents);</span><br>     1811-&gt;N:  <span style="background-color: white">          }</span><br>     1812-&gt;N:  <span style="background-color: white">      </span><br>  1813-&gt;1443:  <span style="background-color: cyan"> 99+      private static void createAnonymousBlock(SharedContext c, Box parent, List
       <styleable>
         inline, List
        <inlinebox>
          savedParents) {
        </inlinebox>
       </styleable></span><br>  1814-&gt;1444:  <span style="background-color: cyan"> 99+          createAnonymousBlock(c, parent, inline, savedParents, IdentValue.BLOCK);</span><br>     1815-&gt;N:  <span style="background-color: white">          }</span><br>     1816-&gt;N:  <span style="background-color: white">      </span><br>  1817-&gt;1447:  <span style="background-color: cyan"> 99+      private static void createAnonymousBlock(SharedContext c, Box parent, List
       <styleable>
         inline, List
        <inlinebox>
          savedParents, IdentValue display) {
        </inlinebox>
       </styleable></span><br>  1818-&gt;1448:  <span style="background-color: cyan"> 99+          WhitespaceStripper.stripInlineContent(inline);</span><br>  1819-&gt;1449:  <span style="background-color: cyan"> 99+          if (inline.size() &gt; 0) {</span><br>  1820-&gt;1450:  <span style="background-color: cyan"> 99+              AnonymousBlockBox anon = new AnonymousBlockBox(parent.getElement());</span><br>  1821-&gt;1451:  <span style="background-color: cyan"> 99+              anon.setStyle(parent.getStyle().createAnonymousStyle(display));</span><br>  1822-&gt;1452:  <span style="background-color: cyan"> 99+              anon.setAnonymous(true);</span><br>  1823-&gt;1453:  <span style="background-color: cyan"> 99+              if (savedParents != null &amp;&amp; savedParents.size() &gt; 0) {</span><br>  1824-&gt;1454:  <span style="background-color: cyan"> 99+                  anon.setOpenInlineBoxes(savedParents);</span><br>     1825-&gt;N:  <span style="background-color: white">                  }</span><br>  1826-&gt;1456:  <span style="background-color: cyan"> 99+              parent.addChild(anon);</span><br>     1827-&gt;U:  <span style="background-color: yellow"> 99+              anon.setChildrenContentType(BlockBox.ContentType.INLINE);</span><br>  1828-&gt;1458:  <span style="background-color: cyan"> 99+              anon.setInlineContent(inline);</span><br>     1829-&gt;N:  <span style="background-color: white">              }</span><br>     1830-&gt;N:  <span style="background-color: white">          }</span><br>     1831-&gt;N:  <span style="background-color: white">      </span><br>     1832-&gt;N:  <span style="background-color: white">          private static class ChildBoxInfo {</span><br>  1833-&gt;1463:  <span style="background-color: white">              private boolean _containsBlockLevelContent;</span><br>  1834-&gt;1464:  <span style="background-color: white">              private boolean _containsTableContent;</span><br>  1835-&gt;1465:  <span style="background-color: white">              private boolean _layoutRunningBlocks;</span><br>     1836-&gt;N:  <span style="background-color: white">      </span><br>     1837-&gt;N:  <span style="background-color: white"> 99+          public ChildBoxInfo() {</span><br>     1838-&gt;N:  <span style="background-color: white">              }</span><br>     1839-&gt;N:  <span style="background-color: white">      </span><br>  1840-&gt;1470:  <span style="background-color: cyan"> 99+          public boolean isContainsBlockLevelContent() {</span><br>     1841-&gt;N:  <span style="background-color: white"> 99+              return _containsBlockLevelContent;</span><br>     1842-&gt;N:  <span style="background-color: white">              }</span><br>     1843-&gt;N:  <span style="background-color: white">      </span><br>  1844-&gt;1474:  <span style="background-color: cyan"> 99+          public void setContainsBlockLevelContent(boolean containsBlockLevelContent) {</span><br>  1845-&gt;1475:  <span style="background-color: cyan"> 99+              _containsBlockLevelContent = containsBlockLevelContent;</span><br>     1846-&gt;N:  <span style="background-color: white">              }</span><br>     1847-&gt;N:  <span style="background-color: white">      </span><br>  1848-&gt;1478:  <span style="background-color: cyan"> 99+          public boolean isContainsTableContent() {</span><br>     1849-&gt;N:  <span style="background-color: white"> 99+              return _containsTableContent;</span><br>     1850-&gt;N:  <span style="background-color: white">              }</span><br>     1851-&gt;N:  <span style="background-color: white">      </span><br>  1852-&gt;1482:  <span style="background-color: cyan"> 99+          public void setContainsTableContent(boolean containsTableContent) {</span><br>  1853-&gt;1483:  <span style="background-color: cyan"> 99+              _containsTableContent = containsTableContent;</span><br>     1854-&gt;N:  <span style="background-color: white">              }</span><br>     1855-&gt;N:  <span style="background-color: white">      </span><br>  1856-&gt;1486:  <span style="background-color: cyan"> 99+          public boolean isLayoutRunningBlocks() {</span><br>     1857-&gt;N:  <span style="background-color: white"> 99+              return _layoutRunningBlocks;</span><br>     1858-&gt;N:  <span style="background-color: white">              }</span><br>     1859-&gt;N:  <span style="background-color: white">      </span><br>  1860-&gt;1490:  <span style="background-color: cyan"> 99+          public void setLayoutRunningBlocks(boolean layoutRunningBlocks) {</span><br>  1861-&gt;1491:  <span style="background-color: cyan"> 99+              _layoutRunningBlocks = layoutRunningBlocks;</span><br>     1862-&gt;N:  <span style="background-color: white">              }</span><br>     1863-&gt;N:  <span style="background-color: white">      </span><br>     1864-&gt;N:  <span style="background-color: white">   0          @Override</span><br>     1865-&gt;U:  <span style="background-color: yellow">              public String toString() {</span><br>     1866-&gt;U:  <span style="background-color: yellow">   0              return String.format(</span><br>     1867-&gt;U:  <span style="background-color: yellow">                          "ChildBoxInfo [_containsBlockLevelContent=%s, _containsTableContent=%s, _layoutRunningBlocks=%s]",</span><br>     1868-&gt;U:  <span style="background-color: yellow">                          _containsBlockLevelContent, _containsTableContent, _layoutRunningBlocks);</span><br>     1869-&gt;U:  <span style="background-color: yellow">              }</span><br>     1870-&gt;N:  <span style="background-color: white">          }</span><br>     1871-&gt;N:  <span style="background-color: white">      }</span><br></pre> </code> 
   </div> 
  </div>  
 </body>
</html>